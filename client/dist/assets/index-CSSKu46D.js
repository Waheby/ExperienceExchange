var bz=Object.defineProperty;var Oz=(d,h,E)=>h in d?bz(d,h,{enumerable:!0,configurable:!0,writable:!0,value:E}):d[h]=E;var T0=(d,h,E)=>(Oz(d,typeof h!="symbol"?h+"":h,E),E);function Nz(d,h){for(var E=0;E<h.length;E++){const T=h[E];if(typeof T!="string"&&!Array.isArray(T)){for(const A in T)if(A!=="default"&&!(A in d)){const O=Object.getOwnPropertyDescriptor(T,A);O&&Object.defineProperty(d,A,O.get?O:{enumerable:!0,get:()=>T[A]})}}}return Object.freeze(Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}))}(function(){const h=document.createElement("link").relList;if(h&&h.supports&&h.supports("modulepreload"))return;for(const A of document.querySelectorAll('link[rel="modulepreload"]'))T(A);new MutationObserver(A=>{for(const O of A)if(O.type==="childList")for(const V of O.addedNodes)V.tagName==="LINK"&&V.rel==="modulepreload"&&T(V)}).observe(document,{childList:!0,subtree:!0});function E(A){const O={};return A.integrity&&(O.integrity=A.integrity),A.referrerPolicy&&(O.referrerPolicy=A.referrerPolicy),A.crossOrigin==="use-credentials"?O.credentials="include":A.crossOrigin==="anonymous"?O.credentials="omit":O.credentials="same-origin",O}function T(A){if(A.ep)return;A.ep=!0;const O=E(A);fetch(A.href,O)}})();var lL=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function WW(d){return d&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d}var U6={exports:{}},v1={},x6={exports:{}},Di={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var fO=Symbol.for("react.element"),Dz=Symbol.for("react.portal"),Pz=Symbol.for("react.fragment"),kz=Symbol.for("react.strict_mode"),Lz=Symbol.for("react.profiler"),Mz=Symbol.for("react.provider"),Uz=Symbol.for("react.context"),xz=Symbol.for("react.forward_ref"),Vz=Symbol.for("react.suspense"),Fz=Symbol.for("react.memo"),jz=Symbol.for("react.lazy"),rH=Symbol.iterator;function Bz(d){return d===null||typeof d!="object"?null:(d=rH&&d[rH]||d["@@iterator"],typeof d=="function"?d:null)}var V6={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},F6=Object.assign,j6={};function Kv(d,h,E){this.props=d,this.context=h,this.refs=j6,this.updater=E||V6}Kv.prototype.isReactComponent={};Kv.prototype.setState=function(d,h){if(typeof d!="object"&&typeof d!="function"&&d!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,d,h,"setState")};Kv.prototype.forceUpdate=function(d){this.updater.enqueueForceUpdate(this,d,"forceUpdate")};function B6(){}B6.prototype=Kv.prototype;function HW(d,h,E){this.props=d,this.context=h,this.refs=j6,this.updater=E||V6}var KW=HW.prototype=new B6;KW.constructor=HW;F6(KW,Kv.prototype);KW.isPureReactComponent=!0;var sH=Array.isArray,G6=Object.prototype.hasOwnProperty,YW={current:null},W6={key:!0,ref:!0,__self:!0,__source:!0};function H6(d,h,E){var T,A={},O=null,V=null;if(h!=null)for(T in h.ref!==void 0&&(V=h.ref),h.key!==void 0&&(O=""+h.key),h)G6.call(h,T)&&!W6.hasOwnProperty(T)&&(A[T]=h[T]);var X=arguments.length-2;if(X===1)A.children=E;else if(1<X){for(var $=Array(X),ne=0;ne<X;ne++)$[ne]=arguments[ne+2];A.children=$}if(d&&d.defaultProps)for(T in X=d.defaultProps,X)A[T]===void 0&&(A[T]=X[T]);return{$$typeof:fO,type:d,key:O,ref:V,props:A,_owner:YW.current}}function Gz(d,h){return{$$typeof:fO,type:d.type,key:h,ref:d.ref,props:d.props,_owner:d._owner}}function zW(d){return typeof d=="object"&&d!==null&&d.$$typeof===fO}function Wz(d){var h={"=":"=0",":":"=2"};return"$"+d.replace(/[=:]/g,function(E){return h[E]})}var oH=/\/+/g;function oG(d,h){return typeof d=="object"&&d!==null&&d.key!=null?Wz(""+d.key):h.toString(36)}function kL(d,h,E,T,A){var O=typeof d;(O==="undefined"||O==="boolean")&&(d=null);var V=!1;if(d===null)V=!0;else switch(O){case"string":case"number":V=!0;break;case"object":switch(d.$$typeof){case fO:case Dz:V=!0}}if(V)return V=d,A=A(V),d=T===""?"."+oG(V,0):T,sH(A)?(E="",d!=null&&(E=d.replace(oH,"$&/")+"/"),kL(A,h,E,"",function(ne){return ne})):A!=null&&(zW(A)&&(A=Gz(A,E+(!A.key||V&&V.key===A.key?"":(""+A.key).replace(oH,"$&/")+"/")+d)),h.push(A)),1;if(V=0,T=T===""?".":T+":",sH(d))for(var X=0;X<d.length;X++){O=d[X];var $=T+oG(O,X);V+=kL(O,h,E,$,A)}else if($=Bz(d),typeof $=="function")for(d=$.call(d),X=0;!(O=d.next()).done;)O=O.value,$=T+oG(O,X++),V+=kL(O,h,E,$,A);else if(O==="object")throw h=String(d),Error("Objects are not valid as a React child (found: "+(h==="[object Object]"?"object with keys {"+Object.keys(d).join(", ")+"}":h)+"). If you meant to render a collection of children, use an array instead.");return V}function uL(d,h,E){if(d==null)return d;var T=[],A=0;return kL(d,T,"","",function(O){return h.call(E,O,A++)}),T}function Hz(d){if(d._status===-1){var h=d._result;h=h(),h.then(function(E){(d._status===0||d._status===-1)&&(d._status=1,d._result=E)},function(E){(d._status===0||d._status===-1)&&(d._status=2,d._result=E)}),d._status===-1&&(d._status=0,d._result=h)}if(d._status===1)return d._result.default;throw d._result}var Lc={current:null},LL={transition:null},Kz={ReactCurrentDispatcher:Lc,ReactCurrentBatchConfig:LL,ReactCurrentOwner:YW};function K6(){throw Error("act(...) is not supported in production builds of React.")}Di.Children={map:uL,forEach:function(d,h,E){uL(d,function(){h.apply(this,arguments)},E)},count:function(d){var h=0;return uL(d,function(){h++}),h},toArray:function(d){return uL(d,function(h){return h})||[]},only:function(d){if(!zW(d))throw Error("React.Children.only expected to receive a single React element child.");return d}};Di.Component=Kv;Di.Fragment=Pz;Di.Profiler=Lz;Di.PureComponent=HW;Di.StrictMode=kz;Di.Suspense=Vz;Di.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Kz;Di.act=K6;Di.cloneElement=function(d,h,E){if(d==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+d+".");var T=F6({},d.props),A=d.key,O=d.ref,V=d._owner;if(h!=null){if(h.ref!==void 0&&(O=h.ref,V=YW.current),h.key!==void 0&&(A=""+h.key),d.type&&d.type.defaultProps)var X=d.type.defaultProps;for($ in h)G6.call(h,$)&&!W6.hasOwnProperty($)&&(T[$]=h[$]===void 0&&X!==void 0?X[$]:h[$])}var $=arguments.length-2;if($===1)T.children=E;else if(1<$){X=Array($);for(var ne=0;ne<$;ne++)X[ne]=arguments[ne+2];T.children=X}return{$$typeof:fO,type:d.type,key:A,ref:O,props:T,_owner:V}};Di.createContext=function(d){return d={$$typeof:Uz,_currentValue:d,_currentValue2:d,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},d.Provider={$$typeof:Mz,_context:d},d.Consumer=d};Di.createElement=H6;Di.createFactory=function(d){var h=H6.bind(null,d);return h.type=d,h};Di.createRef=function(){return{current:null}};Di.forwardRef=function(d){return{$$typeof:xz,render:d}};Di.isValidElement=zW;Di.lazy=function(d){return{$$typeof:jz,_payload:{_status:-1,_result:d},_init:Hz}};Di.memo=function(d,h){return{$$typeof:Fz,type:d,compare:h===void 0?null:h}};Di.startTransition=function(d){var h=LL.transition;LL.transition={};try{d()}finally{LL.transition=h}};Di.unstable_act=K6;Di.useCallback=function(d,h){return Lc.current.useCallback(d,h)};Di.useContext=function(d){return Lc.current.useContext(d)};Di.useDebugValue=function(){};Di.useDeferredValue=function(d){return Lc.current.useDeferredValue(d)};Di.useEffect=function(d,h){return Lc.current.useEffect(d,h)};Di.useId=function(){return Lc.current.useId()};Di.useImperativeHandle=function(d,h,E){return Lc.current.useImperativeHandle(d,h,E)};Di.useInsertionEffect=function(d,h){return Lc.current.useInsertionEffect(d,h)};Di.useLayoutEffect=function(d,h){return Lc.current.useLayoutEffect(d,h)};Di.useMemo=function(d,h){return Lc.current.useMemo(d,h)};Di.useReducer=function(d,h,E){return Lc.current.useReducer(d,h,E)};Di.useRef=function(d){return Lc.current.useRef(d)};Di.useState=function(d){return Lc.current.useState(d)};Di.useSyncExternalStore=function(d,h,E){return Lc.current.useSyncExternalStore(d,h,E)};Di.useTransition=function(){return Lc.current.useTransition()};Di.version="18.3.1";x6.exports=Di;var Oe=x6.exports;const xi=WW(Oe),Yz=Nz({__proto__:null,default:xi},[Oe]);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var zz=Oe,qz=Symbol.for("react.element"),Jz=Symbol.for("react.fragment"),Xz=Object.prototype.hasOwnProperty,Qz=zz.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Zz={key:!0,ref:!0,__self:!0,__source:!0};function Y6(d,h,E){var T,A={},O=null,V=null;E!==void 0&&(O=""+E),h.key!==void 0&&(O=""+h.key),h.ref!==void 0&&(V=h.ref);for(T in h)Xz.call(h,T)&&!Zz.hasOwnProperty(T)&&(A[T]=h[T]);if(d&&d.defaultProps)for(T in h=d.defaultProps,h)A[T]===void 0&&(A[T]=h[T]);return{$$typeof:qz,type:d,key:O,ref:V,props:A,_owner:Qz.current}}v1.Fragment=Jz;v1.jsx=Y6;v1.jsxs=Y6;U6.exports=v1;var F=U6.exports,UG={},z6={exports:{}},Qd={},q6={exports:{}},J6={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(d){function h(Ot,Nt){var cn=Ot.length;Ot.push(Nt);e:for(;0<cn;){var Vi=cn-1>>>1,Fi=Ot[Vi];if(0<A(Fi,Nt))Ot[Vi]=Nt,Ot[cn]=Fi,cn=Vi;else break e}}function E(Ot){return Ot.length===0?null:Ot[0]}function T(Ot){if(Ot.length===0)return null;var Nt=Ot[0],cn=Ot.pop();if(cn!==Nt){Ot[0]=cn;e:for(var Vi=0,Fi=Ot.length,$s=Fi>>>1;Vi<$s;){var yi=2*(Vi+1)-1,gs=Ot[yi],sr=yi+1,Uc=Ot[sr];if(0>A(gs,cn))sr<Fi&&0>A(Uc,gs)?(Ot[Vi]=Uc,Ot[sr]=cn,Vi=sr):(Ot[Vi]=gs,Ot[yi]=cn,Vi=yi);else if(sr<Fi&&0>A(Uc,cn))Ot[Vi]=Uc,Ot[sr]=cn,Vi=sr;else break e}}return Nt}function A(Ot,Nt){var cn=Ot.sortIndex-Nt.sortIndex;return cn!==0?cn:Ot.id-Nt.id}if(typeof performance=="object"&&typeof performance.now=="function"){var O=performance;d.unstable_now=function(){return O.now()}}else{var V=Date,X=V.now();d.unstable_now=function(){return V.now()-X}}var $=[],ne=[],le=1,ae=null,ge=3,je=!1,Fe=!1,we=!1,Ye=typeof setTimeout=="function"?setTimeout:null,Se=typeof clearTimeout=="function"?clearTimeout:null,ue=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function ve(Ot){for(var Nt=E(ne);Nt!==null;){if(Nt.callback===null)T(ne);else if(Nt.startTime<=Ot)T(ne),Nt.sortIndex=Nt.expirationTime,h($,Nt);else break;Nt=E(ne)}}function tt(Ot){if(we=!1,ve(Ot),!Fe)if(E($)!==null)Fe=!0,ii(Rt);else{var Nt=E(ne);Nt!==null&&Os(tt,Nt.startTime-Ot)}}function Rt(Ot,Nt){Fe=!1,we&&(we=!1,Se(Et),Et=-1),je=!0;var cn=ge;try{for(ve(Nt),ae=E($);ae!==null&&(!(ae.expirationTime>Nt)||Ot&&!rr());){var Vi=ae.callback;if(typeof Vi=="function"){ae.callback=null,ge=ae.priorityLevel;var Fi=Vi(ae.expirationTime<=Nt);Nt=d.unstable_now(),typeof Fi=="function"?ae.callback=Fi:ae===E($)&&T($),ve(Nt)}else T($);ae=E($)}if(ae!==null)var $s=!0;else{var yi=E(ne);yi!==null&&Os(tt,yi.startTime-Nt),$s=!1}return $s}finally{ae=null,ge=cn,je=!1}}var lt=!1,dt=null,Et=-1,Bt=5,Ht=-1;function rr(){return!(d.unstable_now()-Ht<Bt)}function Fr(){if(dt!==null){var Ot=d.unstable_now();Ht=Ot;var Nt=!0;try{Nt=dt(!0,Ot)}finally{Nt?vn():(lt=!1,dt=null)}}else lt=!1}var vn;if(typeof ue=="function")vn=function(){ue(Fr)};else if(typeof MessageChannel<"u"){var Ft=new MessageChannel,as=Ft.port2;Ft.port1.onmessage=Fr,vn=function(){as.postMessage(null)}}else vn=function(){Ye(Fr,0)};function ii(Ot){dt=Ot,lt||(lt=!0,vn())}function Os(Ot,Nt){Et=Ye(function(){Ot(d.unstable_now())},Nt)}d.unstable_IdlePriority=5,d.unstable_ImmediatePriority=1,d.unstable_LowPriority=4,d.unstable_NormalPriority=3,d.unstable_Profiling=null,d.unstable_UserBlockingPriority=2,d.unstable_cancelCallback=function(Ot){Ot.callback=null},d.unstable_continueExecution=function(){Fe||je||(Fe=!0,ii(Rt))},d.unstable_forceFrameRate=function(Ot){0>Ot||125<Ot?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):Bt=0<Ot?Math.floor(1e3/Ot):5},d.unstable_getCurrentPriorityLevel=function(){return ge},d.unstable_getFirstCallbackNode=function(){return E($)},d.unstable_next=function(Ot){switch(ge){case 1:case 2:case 3:var Nt=3;break;default:Nt=ge}var cn=ge;ge=Nt;try{return Ot()}finally{ge=cn}},d.unstable_pauseExecution=function(){},d.unstable_requestPaint=function(){},d.unstable_runWithPriority=function(Ot,Nt){switch(Ot){case 1:case 2:case 3:case 4:case 5:break;default:Ot=3}var cn=ge;ge=Ot;try{return Nt()}finally{ge=cn}},d.unstable_scheduleCallback=function(Ot,Nt,cn){var Vi=d.unstable_now();switch(typeof cn=="object"&&cn!==null?(cn=cn.delay,cn=typeof cn=="number"&&0<cn?Vi+cn:Vi):cn=Vi,Ot){case 1:var Fi=-1;break;case 2:Fi=250;break;case 5:Fi=1073741823;break;case 4:Fi=1e4;break;default:Fi=5e3}return Fi=cn+Fi,Ot={id:le++,callback:Nt,priorityLevel:Ot,startTime:cn,expirationTime:Fi,sortIndex:-1},cn>Vi?(Ot.sortIndex=cn,h(ne,Ot),E($)===null&&Ot===E(ne)&&(we?(Se(Et),Et=-1):we=!0,Os(tt,cn-Vi))):(Ot.sortIndex=Fi,h($,Ot),Fe||je||(Fe=!0,ii(Rt))),Ot},d.unstable_shouldYield=rr,d.unstable_wrapCallback=function(Ot){var Nt=ge;return function(){var cn=ge;ge=Nt;try{return Ot.apply(this,arguments)}finally{ge=cn}}}})(J6);q6.exports=J6;var $z=q6.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var eq=Oe,Xd=$z;function Pt(d){for(var h="https://reactjs.org/docs/error-decoder.html?invariant="+d,E=1;E<arguments.length;E++)h+="&args[]="+encodeURIComponent(arguments[E]);return"Minified React error #"+d+"; visit "+h+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var X6=new Set,Y0={};function xS(d,h){Vv(d,h),Vv(d+"Capture",h)}function Vv(d,h){for(Y0[d]=h,d=0;d<h.length;d++)X6.add(h[d])}var Am=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),xG=Object.prototype.hasOwnProperty,tq=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,aH={},cH={};function nq(d){return xG.call(cH,d)?!0:xG.call(aH,d)?!1:tq.test(d)?cH[d]=!0:(aH[d]=!0,!1)}function iq(d,h,E,T){if(E!==null&&E.type===0)return!1;switch(typeof h){case"function":case"symbol":return!0;case"boolean":return T?!1:E!==null?!E.acceptsBooleans:(d=d.toLowerCase().slice(0,5),d!=="data-"&&d!=="aria-");default:return!1}}function rq(d,h,E,T){if(h===null||typeof h>"u"||iq(d,h,E,T))return!0;if(T)return!1;if(E!==null)switch(E.type){case 3:return!h;case 4:return h===!1;case 5:return isNaN(h);case 6:return isNaN(h)||1>h}return!1}function Mc(d,h,E,T,A,O,V){this.acceptsBooleans=h===2||h===3||h===4,this.attributeName=T,this.attributeNamespace=A,this.mustUseProperty=E,this.propertyName=d,this.type=h,this.sanitizeURL=O,this.removeEmptyString=V}var Na={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(d){Na[d]=new Mc(d,0,!1,d,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(d){var h=d[0];Na[h]=new Mc(h,1,!1,d[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(d){Na[d]=new Mc(d,2,!1,d.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(d){Na[d]=new Mc(d,2,!1,d,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(d){Na[d]=new Mc(d,3,!1,d.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(d){Na[d]=new Mc(d,3,!0,d,null,!1,!1)});["capture","download"].forEach(function(d){Na[d]=new Mc(d,4,!1,d,null,!1,!1)});["cols","rows","size","span"].forEach(function(d){Na[d]=new Mc(d,6,!1,d,null,!1,!1)});["rowSpan","start"].forEach(function(d){Na[d]=new Mc(d,5,!1,d.toLowerCase(),null,!1,!1)});var qW=/[\-:]([a-z])/g;function JW(d){return d[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(d){var h=d.replace(qW,JW);Na[h]=new Mc(h,1,!1,d,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(d){var h=d.replace(qW,JW);Na[h]=new Mc(h,1,!1,d,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(d){var h=d.replace(qW,JW);Na[h]=new Mc(h,1,!1,d,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(d){Na[d]=new Mc(d,1,!1,d.toLowerCase(),null,!1,!1)});Na.xlinkHref=new Mc("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(d){Na[d]=new Mc(d,1,!1,d.toLowerCase(),null,!0,!0)});function XW(d,h,E,T){var A=Na.hasOwnProperty(h)?Na[h]:null;(A!==null?A.type!==0:T||!(2<h.length)||h[0]!=="o"&&h[0]!=="O"||h[1]!=="n"&&h[1]!=="N")&&(rq(h,E,A,T)&&(E=null),T||A===null?nq(h)&&(E===null?d.removeAttribute(h):d.setAttribute(h,""+E)):A.mustUseProperty?d[A.propertyName]=E===null?A.type===3?!1:"":E:(h=A.attributeName,T=A.attributeNamespace,E===null?d.removeAttribute(h):(A=A.type,E=A===3||A===4&&E===!0?"":""+E,T?d.setAttributeNS(T,h,E):d.setAttribute(h,E))))}var Nm=eq.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,hL=Symbol.for("react.element"),Tv=Symbol.for("react.portal"),Cv=Symbol.for("react.fragment"),QW=Symbol.for("react.strict_mode"),VG=Symbol.for("react.profiler"),Q6=Symbol.for("react.provider"),Z6=Symbol.for("react.context"),ZW=Symbol.for("react.forward_ref"),FG=Symbol.for("react.suspense"),jG=Symbol.for("react.suspense_list"),$W=Symbol.for("react.memo"),n_=Symbol.for("react.lazy"),$6=Symbol.for("react.offscreen"),dH=Symbol.iterator;function C0(d){return d===null||typeof d!="object"?null:(d=dH&&d[dH]||d["@@iterator"],typeof d=="function"?d:null)}var js=Object.assign,aG;function N0(d){if(aG===void 0)try{throw Error()}catch(E){var h=E.stack.trim().match(/\n( *(at )?)/);aG=h&&h[1]||""}return`
`+aG+d}var cG=!1;function dG(d,h){if(!d||cG)return"";cG=!0;var E=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(h)if(h=function(){throw Error()},Object.defineProperty(h.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(h,[])}catch(ne){var T=ne}Reflect.construct(d,[],h)}else{try{h.call()}catch(ne){T=ne}d.call(h.prototype)}else{try{throw Error()}catch(ne){T=ne}d()}}catch(ne){if(ne&&T&&typeof ne.stack=="string"){for(var A=ne.stack.split(`
`),O=T.stack.split(`
`),V=A.length-1,X=O.length-1;1<=V&&0<=X&&A[V]!==O[X];)X--;for(;1<=V&&0<=X;V--,X--)if(A[V]!==O[X]){if(V!==1||X!==1)do if(V--,X--,0>X||A[V]!==O[X]){var $=`
`+A[V].replace(" at new "," at ");return d.displayName&&$.includes("<anonymous>")&&($=$.replace("<anonymous>",d.displayName)),$}while(1<=V&&0<=X);break}}}finally{cG=!1,Error.prepareStackTrace=E}return(d=d?d.displayName||d.name:"")?N0(d):""}function sq(d){switch(d.tag){case 5:return N0(d.type);case 16:return N0("Lazy");case 13:return N0("Suspense");case 19:return N0("SuspenseList");case 0:case 2:case 15:return d=dG(d.type,!1),d;case 11:return d=dG(d.type.render,!1),d;case 1:return d=dG(d.type,!0),d;default:return""}}function BG(d){if(d==null)return null;if(typeof d=="function")return d.displayName||d.name||null;if(typeof d=="string")return d;switch(d){case Cv:return"Fragment";case Tv:return"Portal";case VG:return"Profiler";case QW:return"StrictMode";case FG:return"Suspense";case jG:return"SuspenseList"}if(typeof d=="object")switch(d.$$typeof){case Z6:return(d.displayName||"Context")+".Consumer";case Q6:return(d._context.displayName||"Context")+".Provider";case ZW:var h=d.render;return d=d.displayName,d||(d=h.displayName||h.name||"",d=d!==""?"ForwardRef("+d+")":"ForwardRef"),d;case $W:return h=d.displayName||null,h!==null?h:BG(d.type)||"Memo";case n_:h=d._payload,d=d._init;try{return BG(d(h))}catch{}}return null}function oq(d){var h=d.type;switch(d.tag){case 24:return"Cache";case 9:return(h.displayName||"Context")+".Consumer";case 10:return(h._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return d=h.render,d=d.displayName||d.name||"",h.displayName||(d!==""?"ForwardRef("+d+")":"ForwardRef");case 7:return"Fragment";case 5:return h;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return BG(h);case 8:return h===QW?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof h=="function")return h.displayName||h.name||null;if(typeof h=="string")return h}return null}function S_(d){switch(typeof d){case"boolean":case"number":case"string":case"undefined":return d;case"object":return d;default:return""}}function eK(d){var h=d.type;return(d=d.nodeName)&&d.toLowerCase()==="input"&&(h==="checkbox"||h==="radio")}function aq(d){var h=eK(d)?"checked":"value",E=Object.getOwnPropertyDescriptor(d.constructor.prototype,h),T=""+d[h];if(!d.hasOwnProperty(h)&&typeof E<"u"&&typeof E.get=="function"&&typeof E.set=="function"){var A=E.get,O=E.set;return Object.defineProperty(d,h,{configurable:!0,get:function(){return A.call(this)},set:function(V){T=""+V,O.call(this,V)}}),Object.defineProperty(d,h,{enumerable:E.enumerable}),{getValue:function(){return T},setValue:function(V){T=""+V},stopTracking:function(){d._valueTracker=null,delete d[h]}}}}function pL(d){d._valueTracker||(d._valueTracker=aq(d))}function tK(d){if(!d)return!1;var h=d._valueTracker;if(!h)return!0;var E=h.getValue(),T="";return d&&(T=eK(d)?d.checked?"true":"false":d.value),d=T,d!==E?(h.setValue(d),!0):!1}function qL(d){if(d=d||(typeof document<"u"?document:void 0),typeof d>"u")return null;try{return d.activeElement||d.body}catch{return d.body}}function GG(d,h){var E=h.checked;return js({},h,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:E??d._wrapperState.initialChecked})}function lH(d,h){var E=h.defaultValue==null?"":h.defaultValue,T=h.checked!=null?h.checked:h.defaultChecked;E=S_(h.value!=null?h.value:E),d._wrapperState={initialChecked:T,initialValue:E,controlled:h.type==="checkbox"||h.type==="radio"?h.checked!=null:h.value!=null}}function nK(d,h){h=h.checked,h!=null&&XW(d,"checked",h,!1)}function WG(d,h){nK(d,h);var E=S_(h.value),T=h.type;if(E!=null)T==="number"?(E===0&&d.value===""||d.value!=E)&&(d.value=""+E):d.value!==""+E&&(d.value=""+E);else if(T==="submit"||T==="reset"){d.removeAttribute("value");return}h.hasOwnProperty("value")?HG(d,h.type,E):h.hasOwnProperty("defaultValue")&&HG(d,h.type,S_(h.defaultValue)),h.checked==null&&h.defaultChecked!=null&&(d.defaultChecked=!!h.defaultChecked)}function uH(d,h,E){if(h.hasOwnProperty("value")||h.hasOwnProperty("defaultValue")){var T=h.type;if(!(T!=="submit"&&T!=="reset"||h.value!==void 0&&h.value!==null))return;h=""+d._wrapperState.initialValue,E||h===d.value||(d.value=h),d.defaultValue=h}E=d.name,E!==""&&(d.name=""),d.defaultChecked=!!d._wrapperState.initialChecked,E!==""&&(d.name=E)}function HG(d,h,E){(h!=="number"||qL(d.ownerDocument)!==d)&&(E==null?d.defaultValue=""+d._wrapperState.initialValue:d.defaultValue!==""+E&&(d.defaultValue=""+E))}var D0=Array.isArray;function Pv(d,h,E,T){if(d=d.options,h){h={};for(var A=0;A<E.length;A++)h["$"+E[A]]=!0;for(E=0;E<d.length;E++)A=h.hasOwnProperty("$"+d[E].value),d[E].selected!==A&&(d[E].selected=A),A&&T&&(d[E].defaultSelected=!0)}else{for(E=""+S_(E),h=null,A=0;A<d.length;A++){if(d[A].value===E){d[A].selected=!0,T&&(d[A].defaultSelected=!0);return}h!==null||d[A].disabled||(h=d[A])}h!==null&&(h.selected=!0)}}function KG(d,h){if(h.dangerouslySetInnerHTML!=null)throw Error(Pt(91));return js({},h,{value:void 0,defaultValue:void 0,children:""+d._wrapperState.initialValue})}function hH(d,h){var E=h.value;if(E==null){if(E=h.children,h=h.defaultValue,E!=null){if(h!=null)throw Error(Pt(92));if(D0(E)){if(1<E.length)throw Error(Pt(93));E=E[0]}h=E}h==null&&(h=""),E=h}d._wrapperState={initialValue:S_(E)}}function iK(d,h){var E=S_(h.value),T=S_(h.defaultValue);E!=null&&(E=""+E,E!==d.value&&(d.value=E),h.defaultValue==null&&d.defaultValue!==E&&(d.defaultValue=E)),T!=null&&(d.defaultValue=""+T)}function pH(d){var h=d.textContent;h===d._wrapperState.initialValue&&h!==""&&h!==null&&(d.value=h)}function rK(d){switch(d){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function YG(d,h){return d==null||d==="http://www.w3.org/1999/xhtml"?rK(h):d==="http://www.w3.org/2000/svg"&&h==="foreignObject"?"http://www.w3.org/1999/xhtml":d}var mL,sK=function(d){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(h,E,T,A){MSApp.execUnsafeLocalFunction(function(){return d(h,E,T,A)})}:d}(function(d,h){if(d.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in d)d.innerHTML=h;else{for(mL=mL||document.createElement("div"),mL.innerHTML="<svg>"+h.valueOf().toString()+"</svg>",h=mL.firstChild;d.firstChild;)d.removeChild(d.firstChild);for(;h.firstChild;)d.appendChild(h.firstChild)}});function z0(d,h){if(h){var E=d.firstChild;if(E&&E===d.lastChild&&E.nodeType===3){E.nodeValue=h;return}}d.textContent=h}var L0={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},cq=["Webkit","ms","Moz","O"];Object.keys(L0).forEach(function(d){cq.forEach(function(h){h=h+d.charAt(0).toUpperCase()+d.substring(1),L0[h]=L0[d]})});function oK(d,h,E){return h==null||typeof h=="boolean"||h===""?"":E||typeof h!="number"||h===0||L0.hasOwnProperty(d)&&L0[d]?(""+h).trim():h+"px"}function aK(d,h){d=d.style;for(var E in h)if(h.hasOwnProperty(E)){var T=E.indexOf("--")===0,A=oK(E,h[E],T);E==="float"&&(E="cssFloat"),T?d.setProperty(E,A):d[E]=A}}var dq=js({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function zG(d,h){if(h){if(dq[d]&&(h.children!=null||h.dangerouslySetInnerHTML!=null))throw Error(Pt(137,d));if(h.dangerouslySetInnerHTML!=null){if(h.children!=null)throw Error(Pt(60));if(typeof h.dangerouslySetInnerHTML!="object"||!("__html"in h.dangerouslySetInnerHTML))throw Error(Pt(61))}if(h.style!=null&&typeof h.style!="object")throw Error(Pt(62))}}function qG(d,h){if(d.indexOf("-")===-1)return typeof h.is=="string";switch(d){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var JG=null;function e4(d){return d=d.target||d.srcElement||window,d.correspondingUseElement&&(d=d.correspondingUseElement),d.nodeType===3?d.parentNode:d}var XG=null,kv=null,Lv=null;function mH(d){if(d=gO(d)){if(typeof XG!="function")throw Error(Pt(280));var h=d.stateNode;h&&(h=w1(h),XG(d.stateNode,d.type,h))}}function cK(d){kv?Lv?Lv.push(d):Lv=[d]:kv=d}function dK(){if(kv){var d=kv,h=Lv;if(Lv=kv=null,mH(d),h)for(d=0;d<h.length;d++)mH(h[d])}}function lK(d,h){return d(h)}function uK(){}var lG=!1;function hK(d,h,E){if(lG)return d(h,E);lG=!0;try{return lK(d,h,E)}finally{lG=!1,(kv!==null||Lv!==null)&&(uK(),dK())}}function q0(d,h){var E=d.stateNode;if(E===null)return null;var T=w1(E);if(T===null)return null;E=T[h];e:switch(h){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(T=!T.disabled)||(d=d.type,T=!(d==="button"||d==="input"||d==="select"||d==="textarea")),d=!T;break e;default:d=!1}if(d)return null;if(E&&typeof E!="function")throw Error(Pt(231,h,typeof E));return E}var QG=!1;if(Am)try{var v0={};Object.defineProperty(v0,"passive",{get:function(){QG=!0}}),window.addEventListener("test",v0,v0),window.removeEventListener("test",v0,v0)}catch{QG=!1}function lq(d,h,E,T,A,O,V,X,$){var ne=Array.prototype.slice.call(arguments,3);try{h.apply(E,ne)}catch(le){this.onError(le)}}var M0=!1,JL=null,XL=!1,ZG=null,uq={onError:function(d){M0=!0,JL=d}};function hq(d,h,E,T,A,O,V,X,$){M0=!1,JL=null,lq.apply(uq,arguments)}function pq(d,h,E,T,A,O,V,X,$){if(hq.apply(this,arguments),M0){if(M0){var ne=JL;M0=!1,JL=null}else throw Error(Pt(198));XL||(XL=!0,ZG=ne)}}function VS(d){var h=d,E=d;if(d.alternate)for(;h.return;)h=h.return;else{d=h;do h=d,h.flags&4098&&(E=h.return),d=h.return;while(d)}return h.tag===3?E:null}function pK(d){if(d.tag===13){var h=d.memoizedState;if(h===null&&(d=d.alternate,d!==null&&(h=d.memoizedState)),h!==null)return h.dehydrated}return null}function fH(d){if(VS(d)!==d)throw Error(Pt(188))}function mq(d){var h=d.alternate;if(!h){if(h=VS(d),h===null)throw Error(Pt(188));return h!==d?null:d}for(var E=d,T=h;;){var A=E.return;if(A===null)break;var O=A.alternate;if(O===null){if(T=A.return,T!==null){E=T;continue}break}if(A.child===O.child){for(O=A.child;O;){if(O===E)return fH(A),d;if(O===T)return fH(A),h;O=O.sibling}throw Error(Pt(188))}if(E.return!==T.return)E=A,T=O;else{for(var V=!1,X=A.child;X;){if(X===E){V=!0,E=A,T=O;break}if(X===T){V=!0,T=A,E=O;break}X=X.sibling}if(!V){for(X=O.child;X;){if(X===E){V=!0,E=O,T=A;break}if(X===T){V=!0,T=O,E=A;break}X=X.sibling}if(!V)throw Error(Pt(189))}}if(E.alternate!==T)throw Error(Pt(190))}if(E.tag!==3)throw Error(Pt(188));return E.stateNode.current===E?d:h}function mK(d){return d=mq(d),d!==null?fK(d):null}function fK(d){if(d.tag===5||d.tag===6)return d;for(d=d.child;d!==null;){var h=fK(d);if(h!==null)return h;d=d.sibling}return null}var _K=Xd.unstable_scheduleCallback,_H=Xd.unstable_cancelCallback,fq=Xd.unstable_shouldYield,_q=Xd.unstable_requestPaint,ho=Xd.unstable_now,Eq=Xd.unstable_getCurrentPriorityLevel,t4=Xd.unstable_ImmediatePriority,EK=Xd.unstable_UserBlockingPriority,QL=Xd.unstable_NormalPriority,gq=Xd.unstable_LowPriority,gK=Xd.unstable_IdlePriority,R1=null,Kh=null;function Sq(d){if(Kh&&typeof Kh.onCommitFiberRoot=="function")try{Kh.onCommitFiberRoot(R1,d,void 0,(d.current.flags&128)===128)}catch{}}var Wu=Math.clz32?Math.clz32:vq,Tq=Math.log,Cq=Math.LN2;function vq(d){return d>>>=0,d===0?32:31-(Tq(d)/Cq|0)|0}var fL=64,_L=4194304;function P0(d){switch(d&-d){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return d&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return d&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return d}}function ZL(d,h){var E=d.pendingLanes;if(E===0)return 0;var T=0,A=d.suspendedLanes,O=d.pingedLanes,V=E&268435455;if(V!==0){var X=V&~A;X!==0?T=P0(X):(O&=V,O!==0&&(T=P0(O)))}else V=E&~A,V!==0?T=P0(V):O!==0&&(T=P0(O));if(T===0)return 0;if(h!==0&&h!==T&&!(h&A)&&(A=T&-T,O=h&-h,A>=O||A===16&&(O&4194240)!==0))return h;if(T&4&&(T|=E&16),h=d.entangledLanes,h!==0)for(d=d.entanglements,h&=T;0<h;)E=31-Wu(h),A=1<<E,T|=d[E],h&=~A;return T}function Rq(d,h){switch(d){case 1:case 2:case 4:return h+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return h+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function yq(d,h){for(var E=d.suspendedLanes,T=d.pingedLanes,A=d.expirationTimes,O=d.pendingLanes;0<O;){var V=31-Wu(O),X=1<<V,$=A[V];$===-1?(!(X&E)||X&T)&&(A[V]=Rq(X,h)):$<=h&&(d.expiredLanes|=X),O&=~X}}function $G(d){return d=d.pendingLanes&-1073741825,d!==0?d:d&1073741824?1073741824:0}function SK(){var d=fL;return fL<<=1,!(fL&4194240)&&(fL=64),d}function uG(d){for(var h=[],E=0;31>E;E++)h.push(d);return h}function _O(d,h,E){d.pendingLanes|=h,h!==536870912&&(d.suspendedLanes=0,d.pingedLanes=0),d=d.eventTimes,h=31-Wu(h),d[h]=E}function Iq(d,h){var E=d.pendingLanes&~h;d.pendingLanes=h,d.suspendedLanes=0,d.pingedLanes=0,d.expiredLanes&=h,d.mutableReadLanes&=h,d.entangledLanes&=h,h=d.entanglements;var T=d.eventTimes;for(d=d.expirationTimes;0<E;){var A=31-Wu(E),O=1<<A;h[A]=0,T[A]=-1,d[A]=-1,E&=~O}}function n4(d,h){var E=d.entangledLanes|=h;for(d=d.entanglements;E;){var T=31-Wu(E),A=1<<T;A&h|d[T]&h&&(d[T]|=h),E&=~A}}var wr=0;function TK(d){return d&=-d,1<d?4<d?d&268435455?16:536870912:4:1}var CK,i4,vK,RK,yK,eW=!1,EL=[],l_=null,u_=null,h_=null,J0=new Map,X0=new Map,r_=[],Aq="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function EH(d,h){switch(d){case"focusin":case"focusout":l_=null;break;case"dragenter":case"dragleave":u_=null;break;case"mouseover":case"mouseout":h_=null;break;case"pointerover":case"pointerout":J0.delete(h.pointerId);break;case"gotpointercapture":case"lostpointercapture":X0.delete(h.pointerId)}}function R0(d,h,E,T,A,O){return d===null||d.nativeEvent!==O?(d={blockedOn:h,domEventName:E,eventSystemFlags:T,nativeEvent:O,targetContainers:[A]},h!==null&&(h=gO(h),h!==null&&i4(h)),d):(d.eventSystemFlags|=T,h=d.targetContainers,A!==null&&h.indexOf(A)===-1&&h.push(A),d)}function wq(d,h,E,T,A){switch(h){case"focusin":return l_=R0(l_,d,h,E,T,A),!0;case"dragenter":return u_=R0(u_,d,h,E,T,A),!0;case"mouseover":return h_=R0(h_,d,h,E,T,A),!0;case"pointerover":var O=A.pointerId;return J0.set(O,R0(J0.get(O)||null,d,h,E,T,A)),!0;case"gotpointercapture":return O=A.pointerId,X0.set(O,R0(X0.get(O)||null,d,h,E,T,A)),!0}return!1}function IK(d){var h=IS(d.target);if(h!==null){var E=VS(h);if(E!==null){if(h=E.tag,h===13){if(h=pK(E),h!==null){d.blockedOn=h,yK(d.priority,function(){vK(E)});return}}else if(h===3&&E.stateNode.current.memoizedState.isDehydrated){d.blockedOn=E.tag===3?E.stateNode.containerInfo:null;return}}}d.blockedOn=null}function ML(d){if(d.blockedOn!==null)return!1;for(var h=d.targetContainers;0<h.length;){var E=tW(d.domEventName,d.eventSystemFlags,h[0],d.nativeEvent);if(E===null){E=d.nativeEvent;var T=new E.constructor(E.type,E);JG=T,E.target.dispatchEvent(T),JG=null}else return h=gO(E),h!==null&&i4(h),d.blockedOn=E,!1;h.shift()}return!0}function gH(d,h,E){ML(d)&&E.delete(h)}function bq(){eW=!1,l_!==null&&ML(l_)&&(l_=null),u_!==null&&ML(u_)&&(u_=null),h_!==null&&ML(h_)&&(h_=null),J0.forEach(gH),X0.forEach(gH)}function y0(d,h){d.blockedOn===h&&(d.blockedOn=null,eW||(eW=!0,Xd.unstable_scheduleCallback(Xd.unstable_NormalPriority,bq)))}function Q0(d){function h(A){return y0(A,d)}if(0<EL.length){y0(EL[0],d);for(var E=1;E<EL.length;E++){var T=EL[E];T.blockedOn===d&&(T.blockedOn=null)}}for(l_!==null&&y0(l_,d),u_!==null&&y0(u_,d),h_!==null&&y0(h_,d),J0.forEach(h),X0.forEach(h),E=0;E<r_.length;E++)T=r_[E],T.blockedOn===d&&(T.blockedOn=null);for(;0<r_.length&&(E=r_[0],E.blockedOn===null);)IK(E),E.blockedOn===null&&r_.shift()}var Mv=Nm.ReactCurrentBatchConfig,$L=!0;function Oq(d,h,E,T){var A=wr,O=Mv.transition;Mv.transition=null;try{wr=1,r4(d,h,E,T)}finally{wr=A,Mv.transition=O}}function Nq(d,h,E,T){var A=wr,O=Mv.transition;Mv.transition=null;try{wr=4,r4(d,h,E,T)}finally{wr=A,Mv.transition=O}}function r4(d,h,E,T){if($L){var A=tW(d,h,E,T);if(A===null)CG(d,h,T,e1,E),EH(d,T);else if(wq(A,d,h,E,T))T.stopPropagation();else if(EH(d,T),h&4&&-1<Aq.indexOf(d)){for(;A!==null;){var O=gO(A);if(O!==null&&CK(O),O=tW(d,h,E,T),O===null&&CG(d,h,T,e1,E),O===A)break;A=O}A!==null&&T.stopPropagation()}else CG(d,h,T,null,E)}}var e1=null;function tW(d,h,E,T){if(e1=null,d=e4(T),d=IS(d),d!==null)if(h=VS(d),h===null)d=null;else if(E=h.tag,E===13){if(d=pK(h),d!==null)return d;d=null}else if(E===3){if(h.stateNode.current.memoizedState.isDehydrated)return h.tag===3?h.stateNode.containerInfo:null;d=null}else h!==d&&(d=null);return e1=d,null}function AK(d){switch(d){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Eq()){case t4:return 1;case EK:return 4;case QL:case gq:return 16;case gK:return 536870912;default:return 16}default:return 16}}var o_=null,s4=null,UL=null;function wK(){if(UL)return UL;var d,h=s4,E=h.length,T,A="value"in o_?o_.value:o_.textContent,O=A.length;for(d=0;d<E&&h[d]===A[d];d++);var V=E-d;for(T=1;T<=V&&h[E-T]===A[O-T];T++);return UL=A.slice(d,1<T?1-T:void 0)}function xL(d){var h=d.keyCode;return"charCode"in d?(d=d.charCode,d===0&&h===13&&(d=13)):d=h,d===10&&(d=13),32<=d||d===13?d:0}function gL(){return!0}function SH(){return!1}function Zd(d){function h(E,T,A,O,V){this._reactName=E,this._targetInst=A,this.type=T,this.nativeEvent=O,this.target=V,this.currentTarget=null;for(var X in d)d.hasOwnProperty(X)&&(E=d[X],this[X]=E?E(O):O[X]);return this.isDefaultPrevented=(O.defaultPrevented!=null?O.defaultPrevented:O.returnValue===!1)?gL:SH,this.isPropagationStopped=SH,this}return js(h.prototype,{preventDefault:function(){this.defaultPrevented=!0;var E=this.nativeEvent;E&&(E.preventDefault?E.preventDefault():typeof E.returnValue!="unknown"&&(E.returnValue=!1),this.isDefaultPrevented=gL)},stopPropagation:function(){var E=this.nativeEvent;E&&(E.stopPropagation?E.stopPropagation():typeof E.cancelBubble!="unknown"&&(E.cancelBubble=!0),this.isPropagationStopped=gL)},persist:function(){},isPersistent:gL}),h}var Yv={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(d){return d.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},o4=Zd(Yv),EO=js({},Yv,{view:0,detail:0}),Dq=Zd(EO),hG,pG,I0,y1=js({},EO,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:a4,button:0,buttons:0,relatedTarget:function(d){return d.relatedTarget===void 0?d.fromElement===d.srcElement?d.toElement:d.fromElement:d.relatedTarget},movementX:function(d){return"movementX"in d?d.movementX:(d!==I0&&(I0&&d.type==="mousemove"?(hG=d.screenX-I0.screenX,pG=d.screenY-I0.screenY):pG=hG=0,I0=d),hG)},movementY:function(d){return"movementY"in d?d.movementY:pG}}),TH=Zd(y1),Pq=js({},y1,{dataTransfer:0}),kq=Zd(Pq),Lq=js({},EO,{relatedTarget:0}),mG=Zd(Lq),Mq=js({},Yv,{animationName:0,elapsedTime:0,pseudoElement:0}),Uq=Zd(Mq),xq=js({},Yv,{clipboardData:function(d){return"clipboardData"in d?d.clipboardData:window.clipboardData}}),Vq=Zd(xq),Fq=js({},Yv,{data:0}),CH=Zd(Fq),jq={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Bq={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Gq={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Wq(d){var h=this.nativeEvent;return h.getModifierState?h.getModifierState(d):(d=Gq[d])?!!h[d]:!1}function a4(){return Wq}var Hq=js({},EO,{key:function(d){if(d.key){var h=jq[d.key]||d.key;if(h!=="Unidentified")return h}return d.type==="keypress"?(d=xL(d),d===13?"Enter":String.fromCharCode(d)):d.type==="keydown"||d.type==="keyup"?Bq[d.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:a4,charCode:function(d){return d.type==="keypress"?xL(d):0},keyCode:function(d){return d.type==="keydown"||d.type==="keyup"?d.keyCode:0},which:function(d){return d.type==="keypress"?xL(d):d.type==="keydown"||d.type==="keyup"?d.keyCode:0}}),Kq=Zd(Hq),Yq=js({},y1,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),vH=Zd(Yq),zq=js({},EO,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:a4}),qq=Zd(zq),Jq=js({},Yv,{propertyName:0,elapsedTime:0,pseudoElement:0}),Xq=Zd(Jq),Qq=js({},y1,{deltaX:function(d){return"deltaX"in d?d.deltaX:"wheelDeltaX"in d?-d.wheelDeltaX:0},deltaY:function(d){return"deltaY"in d?d.deltaY:"wheelDeltaY"in d?-d.wheelDeltaY:"wheelDelta"in d?-d.wheelDelta:0},deltaZ:0,deltaMode:0}),Zq=Zd(Qq),$q=[9,13,27,32],c4=Am&&"CompositionEvent"in window,U0=null;Am&&"documentMode"in document&&(U0=document.documentMode);var eJ=Am&&"TextEvent"in window&&!U0,bK=Am&&(!c4||U0&&8<U0&&11>=U0),RH=" ",yH=!1;function OK(d,h){switch(d){case"keyup":return $q.indexOf(h.keyCode)!==-1;case"keydown":return h.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function NK(d){return d=d.detail,typeof d=="object"&&"data"in d?d.data:null}var vv=!1;function tJ(d,h){switch(d){case"compositionend":return NK(h);case"keypress":return h.which!==32?null:(yH=!0,RH);case"textInput":return d=h.data,d===RH&&yH?null:d;default:return null}}function nJ(d,h){if(vv)return d==="compositionend"||!c4&&OK(d,h)?(d=wK(),UL=s4=o_=null,vv=!1,d):null;switch(d){case"paste":return null;case"keypress":if(!(h.ctrlKey||h.altKey||h.metaKey)||h.ctrlKey&&h.altKey){if(h.char&&1<h.char.length)return h.char;if(h.which)return String.fromCharCode(h.which)}return null;case"compositionend":return bK&&h.locale!=="ko"?null:h.data;default:return null}}var iJ={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function IH(d){var h=d&&d.nodeName&&d.nodeName.toLowerCase();return h==="input"?!!iJ[d.type]:h==="textarea"}function DK(d,h,E,T){cK(T),h=t1(h,"onChange"),0<h.length&&(E=new o4("onChange","change",null,E,T),d.push({event:E,listeners:h}))}var x0=null,Z0=null;function rJ(d){GK(d,0)}function I1(d){var h=Iv(d);if(tK(h))return d}function sJ(d,h){if(d==="change")return h}var PK=!1;if(Am){var fG;if(Am){var _G="oninput"in document;if(!_G){var AH=document.createElement("div");AH.setAttribute("oninput","return;"),_G=typeof AH.oninput=="function"}fG=_G}else fG=!1;PK=fG&&(!document.documentMode||9<document.documentMode)}function wH(){x0&&(x0.detachEvent("onpropertychange",kK),Z0=x0=null)}function kK(d){if(d.propertyName==="value"&&I1(Z0)){var h=[];DK(h,Z0,d,e4(d)),hK(rJ,h)}}function oJ(d,h,E){d==="focusin"?(wH(),x0=h,Z0=E,x0.attachEvent("onpropertychange",kK)):d==="focusout"&&wH()}function aJ(d){if(d==="selectionchange"||d==="keyup"||d==="keydown")return I1(Z0)}function cJ(d,h){if(d==="click")return I1(h)}function dJ(d,h){if(d==="input"||d==="change")return I1(h)}function lJ(d,h){return d===h&&(d!==0||1/d===1/h)||d!==d&&h!==h}var Ku=typeof Object.is=="function"?Object.is:lJ;function $0(d,h){if(Ku(d,h))return!0;if(typeof d!="object"||d===null||typeof h!="object"||h===null)return!1;var E=Object.keys(d),T=Object.keys(h);if(E.length!==T.length)return!1;for(T=0;T<E.length;T++){var A=E[T];if(!xG.call(h,A)||!Ku(d[A],h[A]))return!1}return!0}function bH(d){for(;d&&d.firstChild;)d=d.firstChild;return d}function OH(d,h){var E=bH(d);d=0;for(var T;E;){if(E.nodeType===3){if(T=d+E.textContent.length,d<=h&&T>=h)return{node:E,offset:h-d};d=T}e:{for(;E;){if(E.nextSibling){E=E.nextSibling;break e}E=E.parentNode}E=void 0}E=bH(E)}}function LK(d,h){return d&&h?d===h?!0:d&&d.nodeType===3?!1:h&&h.nodeType===3?LK(d,h.parentNode):"contains"in d?d.contains(h):d.compareDocumentPosition?!!(d.compareDocumentPosition(h)&16):!1:!1}function MK(){for(var d=window,h=qL();h instanceof d.HTMLIFrameElement;){try{var E=typeof h.contentWindow.location.href=="string"}catch{E=!1}if(E)d=h.contentWindow;else break;h=qL(d.document)}return h}function d4(d){var h=d&&d.nodeName&&d.nodeName.toLowerCase();return h&&(h==="input"&&(d.type==="text"||d.type==="search"||d.type==="tel"||d.type==="url"||d.type==="password")||h==="textarea"||d.contentEditable==="true")}function uJ(d){var h=MK(),E=d.focusedElem,T=d.selectionRange;if(h!==E&&E&&E.ownerDocument&&LK(E.ownerDocument.documentElement,E)){if(T!==null&&d4(E)){if(h=T.start,d=T.end,d===void 0&&(d=h),"selectionStart"in E)E.selectionStart=h,E.selectionEnd=Math.min(d,E.value.length);else if(d=(h=E.ownerDocument||document)&&h.defaultView||window,d.getSelection){d=d.getSelection();var A=E.textContent.length,O=Math.min(T.start,A);T=T.end===void 0?O:Math.min(T.end,A),!d.extend&&O>T&&(A=T,T=O,O=A),A=OH(E,O);var V=OH(E,T);A&&V&&(d.rangeCount!==1||d.anchorNode!==A.node||d.anchorOffset!==A.offset||d.focusNode!==V.node||d.focusOffset!==V.offset)&&(h=h.createRange(),h.setStart(A.node,A.offset),d.removeAllRanges(),O>T?(d.addRange(h),d.extend(V.node,V.offset)):(h.setEnd(V.node,V.offset),d.addRange(h)))}}for(h=[],d=E;d=d.parentNode;)d.nodeType===1&&h.push({element:d,left:d.scrollLeft,top:d.scrollTop});for(typeof E.focus=="function"&&E.focus(),E=0;E<h.length;E++)d=h[E],d.element.scrollLeft=d.left,d.element.scrollTop=d.top}}var hJ=Am&&"documentMode"in document&&11>=document.documentMode,Rv=null,nW=null,V0=null,iW=!1;function NH(d,h,E){var T=E.window===E?E.document:E.nodeType===9?E:E.ownerDocument;iW||Rv==null||Rv!==qL(T)||(T=Rv,"selectionStart"in T&&d4(T)?T={start:T.selectionStart,end:T.selectionEnd}:(T=(T.ownerDocument&&T.ownerDocument.defaultView||window).getSelection(),T={anchorNode:T.anchorNode,anchorOffset:T.anchorOffset,focusNode:T.focusNode,focusOffset:T.focusOffset}),V0&&$0(V0,T)||(V0=T,T=t1(nW,"onSelect"),0<T.length&&(h=new o4("onSelect","select",null,h,E),d.push({event:h,listeners:T}),h.target=Rv)))}function SL(d,h){var E={};return E[d.toLowerCase()]=h.toLowerCase(),E["Webkit"+d]="webkit"+h,E["Moz"+d]="moz"+h,E}var yv={animationend:SL("Animation","AnimationEnd"),animationiteration:SL("Animation","AnimationIteration"),animationstart:SL("Animation","AnimationStart"),transitionend:SL("Transition","TransitionEnd")},EG={},UK={};Am&&(UK=document.createElement("div").style,"AnimationEvent"in window||(delete yv.animationend.animation,delete yv.animationiteration.animation,delete yv.animationstart.animation),"TransitionEvent"in window||delete yv.transitionend.transition);function A1(d){if(EG[d])return EG[d];if(!yv[d])return d;var h=yv[d],E;for(E in h)if(h.hasOwnProperty(E)&&E in UK)return EG[d]=h[E];return d}var xK=A1("animationend"),VK=A1("animationiteration"),FK=A1("animationstart"),jK=A1("transitionend"),BK=new Map,DH="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function C_(d,h){BK.set(d,h),xS(h,[d])}for(var gG=0;gG<DH.length;gG++){var SG=DH[gG],pJ=SG.toLowerCase(),mJ=SG[0].toUpperCase()+SG.slice(1);C_(pJ,"on"+mJ)}C_(xK,"onAnimationEnd");C_(VK,"onAnimationIteration");C_(FK,"onAnimationStart");C_("dblclick","onDoubleClick");C_("focusin","onFocus");C_("focusout","onBlur");C_(jK,"onTransitionEnd");Vv("onMouseEnter",["mouseout","mouseover"]);Vv("onMouseLeave",["mouseout","mouseover"]);Vv("onPointerEnter",["pointerout","pointerover"]);Vv("onPointerLeave",["pointerout","pointerover"]);xS("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));xS("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));xS("onBeforeInput",["compositionend","keypress","textInput","paste"]);xS("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));xS("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));xS("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var k0="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),fJ=new Set("cancel close invalid load scroll toggle".split(" ").concat(k0));function PH(d,h,E){var T=d.type||"unknown-event";d.currentTarget=E,pq(T,h,void 0,d),d.currentTarget=null}function GK(d,h){h=(h&4)!==0;for(var E=0;E<d.length;E++){var T=d[E],A=T.event;T=T.listeners;e:{var O=void 0;if(h)for(var V=T.length-1;0<=V;V--){var X=T[V],$=X.instance,ne=X.currentTarget;if(X=X.listener,$!==O&&A.isPropagationStopped())break e;PH(A,X,ne),O=$}else for(V=0;V<T.length;V++){if(X=T[V],$=X.instance,ne=X.currentTarget,X=X.listener,$!==O&&A.isPropagationStopped())break e;PH(A,X,ne),O=$}}}if(XL)throw d=ZG,XL=!1,ZG=null,d}function fs(d,h){var E=h[cW];E===void 0&&(E=h[cW]=new Set);var T=d+"__bubble";E.has(T)||(WK(h,d,2,!1),E.add(T))}function TG(d,h,E){var T=0;h&&(T|=4),WK(E,d,T,h)}var TL="_reactListening"+Math.random().toString(36).slice(2);function eO(d){if(!d[TL]){d[TL]=!0,X6.forEach(function(E){E!=="selectionchange"&&(fJ.has(E)||TG(E,!1,d),TG(E,!0,d))});var h=d.nodeType===9?d:d.ownerDocument;h===null||h[TL]||(h[TL]=!0,TG("selectionchange",!1,h))}}function WK(d,h,E,T){switch(AK(h)){case 1:var A=Oq;break;case 4:A=Nq;break;default:A=r4}E=A.bind(null,h,E,d),A=void 0,!QG||h!=="touchstart"&&h!=="touchmove"&&h!=="wheel"||(A=!0),T?A!==void 0?d.addEventListener(h,E,{capture:!0,passive:A}):d.addEventListener(h,E,!0):A!==void 0?d.addEventListener(h,E,{passive:A}):d.addEventListener(h,E,!1)}function CG(d,h,E,T,A){var O=T;if(!(h&1)&&!(h&2)&&T!==null)e:for(;;){if(T===null)return;var V=T.tag;if(V===3||V===4){var X=T.stateNode.containerInfo;if(X===A||X.nodeType===8&&X.parentNode===A)break;if(V===4)for(V=T.return;V!==null;){var $=V.tag;if(($===3||$===4)&&($=V.stateNode.containerInfo,$===A||$.nodeType===8&&$.parentNode===A))return;V=V.return}for(;X!==null;){if(V=IS(X),V===null)return;if($=V.tag,$===5||$===6){T=O=V;continue e}X=X.parentNode}}T=T.return}hK(function(){var ne=O,le=e4(E),ae=[];e:{var ge=BK.get(d);if(ge!==void 0){var je=o4,Fe=d;switch(d){case"keypress":if(xL(E)===0)break e;case"keydown":case"keyup":je=Kq;break;case"focusin":Fe="focus",je=mG;break;case"focusout":Fe="blur",je=mG;break;case"beforeblur":case"afterblur":je=mG;break;case"click":if(E.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":je=TH;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":je=kq;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":je=qq;break;case xK:case VK:case FK:je=Uq;break;case jK:je=Xq;break;case"scroll":je=Dq;break;case"wheel":je=Zq;break;case"copy":case"cut":case"paste":je=Vq;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":je=vH}var we=(h&4)!==0,Ye=!we&&d==="scroll",Se=we?ge!==null?ge+"Capture":null:ge;we=[];for(var ue=ne,ve;ue!==null;){ve=ue;var tt=ve.stateNode;if(ve.tag===5&&tt!==null&&(ve=tt,Se!==null&&(tt=q0(ue,Se),tt!=null&&we.push(tO(ue,tt,ve)))),Ye)break;ue=ue.return}0<we.length&&(ge=new je(ge,Fe,null,E,le),ae.push({event:ge,listeners:we}))}}if(!(h&7)){e:{if(ge=d==="mouseover"||d==="pointerover",je=d==="mouseout"||d==="pointerout",ge&&E!==JG&&(Fe=E.relatedTarget||E.fromElement)&&(IS(Fe)||Fe[wm]))break e;if((je||ge)&&(ge=le.window===le?le:(ge=le.ownerDocument)?ge.defaultView||ge.parentWindow:window,je?(Fe=E.relatedTarget||E.toElement,je=ne,Fe=Fe?IS(Fe):null,Fe!==null&&(Ye=VS(Fe),Fe!==Ye||Fe.tag!==5&&Fe.tag!==6)&&(Fe=null)):(je=null,Fe=ne),je!==Fe)){if(we=TH,tt="onMouseLeave",Se="onMouseEnter",ue="mouse",(d==="pointerout"||d==="pointerover")&&(we=vH,tt="onPointerLeave",Se="onPointerEnter",ue="pointer"),Ye=je==null?ge:Iv(je),ve=Fe==null?ge:Iv(Fe),ge=new we(tt,ue+"leave",je,E,le),ge.target=Ye,ge.relatedTarget=ve,tt=null,IS(le)===ne&&(we=new we(Se,ue+"enter",Fe,E,le),we.target=ve,we.relatedTarget=Ye,tt=we),Ye=tt,je&&Fe)t:{for(we=je,Se=Fe,ue=0,ve=we;ve;ve=Ev(ve))ue++;for(ve=0,tt=Se;tt;tt=Ev(tt))ve++;for(;0<ue-ve;)we=Ev(we),ue--;for(;0<ve-ue;)Se=Ev(Se),ve--;for(;ue--;){if(we===Se||Se!==null&&we===Se.alternate)break t;we=Ev(we),Se=Ev(Se)}we=null}else we=null;je!==null&&kH(ae,ge,je,we,!1),Fe!==null&&Ye!==null&&kH(ae,Ye,Fe,we,!0)}}e:{if(ge=ne?Iv(ne):window,je=ge.nodeName&&ge.nodeName.toLowerCase(),je==="select"||je==="input"&&ge.type==="file")var Rt=sJ;else if(IH(ge))if(PK)Rt=dJ;else{Rt=aJ;var lt=oJ}else(je=ge.nodeName)&&je.toLowerCase()==="input"&&(ge.type==="checkbox"||ge.type==="radio")&&(Rt=cJ);if(Rt&&(Rt=Rt(d,ne))){DK(ae,Rt,E,le);break e}lt&&lt(d,ge,ne),d==="focusout"&&(lt=ge._wrapperState)&&lt.controlled&&ge.type==="number"&&HG(ge,"number",ge.value)}switch(lt=ne?Iv(ne):window,d){case"focusin":(IH(lt)||lt.contentEditable==="true")&&(Rv=lt,nW=ne,V0=null);break;case"focusout":V0=nW=Rv=null;break;case"mousedown":iW=!0;break;case"contextmenu":case"mouseup":case"dragend":iW=!1,NH(ae,E,le);break;case"selectionchange":if(hJ)break;case"keydown":case"keyup":NH(ae,E,le)}var dt;if(c4)e:{switch(d){case"compositionstart":var Et="onCompositionStart";break e;case"compositionend":Et="onCompositionEnd";break e;case"compositionupdate":Et="onCompositionUpdate";break e}Et=void 0}else vv?OK(d,E)&&(Et="onCompositionEnd"):d==="keydown"&&E.keyCode===229&&(Et="onCompositionStart");Et&&(bK&&E.locale!=="ko"&&(vv||Et!=="onCompositionStart"?Et==="onCompositionEnd"&&vv&&(dt=wK()):(o_=le,s4="value"in o_?o_.value:o_.textContent,vv=!0)),lt=t1(ne,Et),0<lt.length&&(Et=new CH(Et,d,null,E,le),ae.push({event:Et,listeners:lt}),dt?Et.data=dt:(dt=NK(E),dt!==null&&(Et.data=dt)))),(dt=eJ?tJ(d,E):nJ(d,E))&&(ne=t1(ne,"onBeforeInput"),0<ne.length&&(le=new CH("onBeforeInput","beforeinput",null,E,le),ae.push({event:le,listeners:ne}),le.data=dt))}GK(ae,h)})}function tO(d,h,E){return{instance:d,listener:h,currentTarget:E}}function t1(d,h){for(var E=h+"Capture",T=[];d!==null;){var A=d,O=A.stateNode;A.tag===5&&O!==null&&(A=O,O=q0(d,E),O!=null&&T.unshift(tO(d,O,A)),O=q0(d,h),O!=null&&T.push(tO(d,O,A))),d=d.return}return T}function Ev(d){if(d===null)return null;do d=d.return;while(d&&d.tag!==5);return d||null}function kH(d,h,E,T,A){for(var O=h._reactName,V=[];E!==null&&E!==T;){var X=E,$=X.alternate,ne=X.stateNode;if($!==null&&$===T)break;X.tag===5&&ne!==null&&(X=ne,A?($=q0(E,O),$!=null&&V.unshift(tO(E,$,X))):A||($=q0(E,O),$!=null&&V.push(tO(E,$,X)))),E=E.return}V.length!==0&&d.push({event:h,listeners:V})}var _J=/\r\n?/g,EJ=/\u0000|\uFFFD/g;function LH(d){return(typeof d=="string"?d:""+d).replace(_J,`
`).replace(EJ,"")}function CL(d,h,E){if(h=LH(h),LH(d)!==h&&E)throw Error(Pt(425))}function n1(){}var rW=null,sW=null;function oW(d,h){return d==="textarea"||d==="noscript"||typeof h.children=="string"||typeof h.children=="number"||typeof h.dangerouslySetInnerHTML=="object"&&h.dangerouslySetInnerHTML!==null&&h.dangerouslySetInnerHTML.__html!=null}var aW=typeof setTimeout=="function"?setTimeout:void 0,gJ=typeof clearTimeout=="function"?clearTimeout:void 0,MH=typeof Promise=="function"?Promise:void 0,SJ=typeof queueMicrotask=="function"?queueMicrotask:typeof MH<"u"?function(d){return MH.resolve(null).then(d).catch(TJ)}:aW;function TJ(d){setTimeout(function(){throw d})}function vG(d,h){var E=h,T=0;do{var A=E.nextSibling;if(d.removeChild(E),A&&A.nodeType===8)if(E=A.data,E==="/$"){if(T===0){d.removeChild(A),Q0(h);return}T--}else E!=="$"&&E!=="$?"&&E!=="$!"||T++;E=A}while(E);Q0(h)}function p_(d){for(;d!=null;d=d.nextSibling){var h=d.nodeType;if(h===1||h===3)break;if(h===8){if(h=d.data,h==="$"||h==="$!"||h==="$?")break;if(h==="/$")return null}}return d}function UH(d){d=d.previousSibling;for(var h=0;d;){if(d.nodeType===8){var E=d.data;if(E==="$"||E==="$!"||E==="$?"){if(h===0)return d;h--}else E==="/$"&&h++}d=d.previousSibling}return null}var zv=Math.random().toString(36).slice(2),Hh="__reactFiber$"+zv,nO="__reactProps$"+zv,wm="__reactContainer$"+zv,cW="__reactEvents$"+zv,CJ="__reactListeners$"+zv,vJ="__reactHandles$"+zv;function IS(d){var h=d[Hh];if(h)return h;for(var E=d.parentNode;E;){if(h=E[wm]||E[Hh]){if(E=h.alternate,h.child!==null||E!==null&&E.child!==null)for(d=UH(d);d!==null;){if(E=d[Hh])return E;d=UH(d)}return h}d=E,E=d.parentNode}return null}function gO(d){return d=d[Hh]||d[wm],!d||d.tag!==5&&d.tag!==6&&d.tag!==13&&d.tag!==3?null:d}function Iv(d){if(d.tag===5||d.tag===6)return d.stateNode;throw Error(Pt(33))}function w1(d){return d[nO]||null}var dW=[],Av=-1;function v_(d){return{current:d}}function Es(d){0>Av||(d.current=dW[Av],dW[Av]=null,Av--)}function os(d,h){Av++,dW[Av]=d.current,d.current=h}var T_={},Xa=v_(T_),ld=v_(!1),DS=T_;function Fv(d,h){var E=d.type.contextTypes;if(!E)return T_;var T=d.stateNode;if(T&&T.__reactInternalMemoizedUnmaskedChildContext===h)return T.__reactInternalMemoizedMaskedChildContext;var A={},O;for(O in E)A[O]=h[O];return T&&(d=d.stateNode,d.__reactInternalMemoizedUnmaskedChildContext=h,d.__reactInternalMemoizedMaskedChildContext=A),A}function ud(d){return d=d.childContextTypes,d!=null}function i1(){Es(ld),Es(Xa)}function xH(d,h,E){if(Xa.current!==T_)throw Error(Pt(168));os(Xa,h),os(ld,E)}function HK(d,h,E){var T=d.stateNode;if(h=h.childContextTypes,typeof T.getChildContext!="function")return E;T=T.getChildContext();for(var A in T)if(!(A in h))throw Error(Pt(108,oq(d)||"Unknown",A));return js({},E,T)}function r1(d){return d=(d=d.stateNode)&&d.__reactInternalMemoizedMergedChildContext||T_,DS=Xa.current,os(Xa,d),os(ld,ld.current),!0}function VH(d,h,E){var T=d.stateNode;if(!T)throw Error(Pt(169));E?(d=HK(d,h,DS),T.__reactInternalMemoizedMergedChildContext=d,Es(ld),Es(Xa),os(Xa,d)):Es(ld),os(ld,E)}var vm=null,b1=!1,RG=!1;function KK(d){vm===null?vm=[d]:vm.push(d)}function RJ(d){b1=!0,KK(d)}function R_(){if(!RG&&vm!==null){RG=!0;var d=0,h=wr;try{var E=vm;for(wr=1;d<E.length;d++){var T=E[d];do T=T(!0);while(T!==null)}vm=null,b1=!1}catch(A){throw vm!==null&&(vm=vm.slice(d+1)),_K(t4,R_),A}finally{wr=h,RG=!1}}return null}var wv=[],bv=0,s1=null,o1=0,Ol=[],Nl=0,PS=null,Rm=1,ym="";function RS(d,h){wv[bv++]=o1,wv[bv++]=s1,s1=d,o1=h}function YK(d,h,E){Ol[Nl++]=Rm,Ol[Nl++]=ym,Ol[Nl++]=PS,PS=d;var T=Rm;d=ym;var A=32-Wu(T)-1;T&=~(1<<A),E+=1;var O=32-Wu(h)+A;if(30<O){var V=A-A%5;O=(T&(1<<V)-1).toString(32),T>>=V,A-=V,Rm=1<<32-Wu(h)+A|E<<A|T,ym=O+d}else Rm=1<<O|E<<A|T,ym=d}function l4(d){d.return!==null&&(RS(d,1),YK(d,1,0))}function u4(d){for(;d===s1;)s1=wv[--bv],wv[bv]=null,o1=wv[--bv],wv[bv]=null;for(;d===PS;)PS=Ol[--Nl],Ol[Nl]=null,ym=Ol[--Nl],Ol[Nl]=null,Rm=Ol[--Nl],Ol[Nl]=null}var Jd=null,zd=null,bs=!1,Gu=null;function zK(d,h){var E=Dl(5,null,null,0);E.elementType="DELETED",E.stateNode=h,E.return=d,h=d.deletions,h===null?(d.deletions=[E],d.flags|=16):h.push(E)}function FH(d,h){switch(d.tag){case 5:var E=d.type;return h=h.nodeType!==1||E.toLowerCase()!==h.nodeName.toLowerCase()?null:h,h!==null?(d.stateNode=h,Jd=d,zd=p_(h.firstChild),!0):!1;case 6:return h=d.pendingProps===""||h.nodeType!==3?null:h,h!==null?(d.stateNode=h,Jd=d,zd=null,!0):!1;case 13:return h=h.nodeType!==8?null:h,h!==null?(E=PS!==null?{id:Rm,overflow:ym}:null,d.memoizedState={dehydrated:h,treeContext:E,retryLane:1073741824},E=Dl(18,null,null,0),E.stateNode=h,E.return=d,d.child=E,Jd=d,zd=null,!0):!1;default:return!1}}function lW(d){return(d.mode&1)!==0&&(d.flags&128)===0}function uW(d){if(bs){var h=zd;if(h){var E=h;if(!FH(d,h)){if(lW(d))throw Error(Pt(418));h=p_(E.nextSibling);var T=Jd;h&&FH(d,h)?zK(T,E):(d.flags=d.flags&-4097|2,bs=!1,Jd=d)}}else{if(lW(d))throw Error(Pt(418));d.flags=d.flags&-4097|2,bs=!1,Jd=d}}}function jH(d){for(d=d.return;d!==null&&d.tag!==5&&d.tag!==3&&d.tag!==13;)d=d.return;Jd=d}function vL(d){if(d!==Jd)return!1;if(!bs)return jH(d),bs=!0,!1;var h;if((h=d.tag!==3)&&!(h=d.tag!==5)&&(h=d.type,h=h!=="head"&&h!=="body"&&!oW(d.type,d.memoizedProps)),h&&(h=zd)){if(lW(d))throw qK(),Error(Pt(418));for(;h;)zK(d,h),h=p_(h.nextSibling)}if(jH(d),d.tag===13){if(d=d.memoizedState,d=d!==null?d.dehydrated:null,!d)throw Error(Pt(317));e:{for(d=d.nextSibling,h=0;d;){if(d.nodeType===8){var E=d.data;if(E==="/$"){if(h===0){zd=p_(d.nextSibling);break e}h--}else E!=="$"&&E!=="$!"&&E!=="$?"||h++}d=d.nextSibling}zd=null}}else zd=Jd?p_(d.stateNode.nextSibling):null;return!0}function qK(){for(var d=zd;d;)d=p_(d.nextSibling)}function jv(){zd=Jd=null,bs=!1}function h4(d){Gu===null?Gu=[d]:Gu.push(d)}var yJ=Nm.ReactCurrentBatchConfig;function A0(d,h,E){if(d=E.ref,d!==null&&typeof d!="function"&&typeof d!="object"){if(E._owner){if(E=E._owner,E){if(E.tag!==1)throw Error(Pt(309));var T=E.stateNode}if(!T)throw Error(Pt(147,d));var A=T,O=""+d;return h!==null&&h.ref!==null&&typeof h.ref=="function"&&h.ref._stringRef===O?h.ref:(h=function(V){var X=A.refs;V===null?delete X[O]:X[O]=V},h._stringRef=O,h)}if(typeof d!="string")throw Error(Pt(284));if(!E._owner)throw Error(Pt(290,d))}return d}function RL(d,h){throw d=Object.prototype.toString.call(h),Error(Pt(31,d==="[object Object]"?"object with keys {"+Object.keys(h).join(", ")+"}":d))}function BH(d){var h=d._init;return h(d._payload)}function JK(d){function h(Se,ue){if(d){var ve=Se.deletions;ve===null?(Se.deletions=[ue],Se.flags|=16):ve.push(ue)}}function E(Se,ue){if(!d)return null;for(;ue!==null;)h(Se,ue),ue=ue.sibling;return null}function T(Se,ue){for(Se=new Map;ue!==null;)ue.key!==null?Se.set(ue.key,ue):Se.set(ue.index,ue),ue=ue.sibling;return Se}function A(Se,ue){return Se=E_(Se,ue),Se.index=0,Se.sibling=null,Se}function O(Se,ue,ve){return Se.index=ve,d?(ve=Se.alternate,ve!==null?(ve=ve.index,ve<ue?(Se.flags|=2,ue):ve):(Se.flags|=2,ue)):(Se.flags|=1048576,ue)}function V(Se){return d&&Se.alternate===null&&(Se.flags|=2),Se}function X(Se,ue,ve,tt){return ue===null||ue.tag!==6?(ue=NG(ve,Se.mode,tt),ue.return=Se,ue):(ue=A(ue,ve),ue.return=Se,ue)}function $(Se,ue,ve,tt){var Rt=ve.type;return Rt===Cv?le(Se,ue,ve.props.children,tt,ve.key):ue!==null&&(ue.elementType===Rt||typeof Rt=="object"&&Rt!==null&&Rt.$$typeof===n_&&BH(Rt)===ue.type)?(tt=A(ue,ve.props),tt.ref=A0(Se,ue,ve),tt.return=Se,tt):(tt=HL(ve.type,ve.key,ve.props,null,Se.mode,tt),tt.ref=A0(Se,ue,ve),tt.return=Se,tt)}function ne(Se,ue,ve,tt){return ue===null||ue.tag!==4||ue.stateNode.containerInfo!==ve.containerInfo||ue.stateNode.implementation!==ve.implementation?(ue=DG(ve,Se.mode,tt),ue.return=Se,ue):(ue=A(ue,ve.children||[]),ue.return=Se,ue)}function le(Se,ue,ve,tt,Rt){return ue===null||ue.tag!==7?(ue=OS(ve,Se.mode,tt,Rt),ue.return=Se,ue):(ue=A(ue,ve),ue.return=Se,ue)}function ae(Se,ue,ve){if(typeof ue=="string"&&ue!==""||typeof ue=="number")return ue=NG(""+ue,Se.mode,ve),ue.return=Se,ue;if(typeof ue=="object"&&ue!==null){switch(ue.$$typeof){case hL:return ve=HL(ue.type,ue.key,ue.props,null,Se.mode,ve),ve.ref=A0(Se,null,ue),ve.return=Se,ve;case Tv:return ue=DG(ue,Se.mode,ve),ue.return=Se,ue;case n_:var tt=ue._init;return ae(Se,tt(ue._payload),ve)}if(D0(ue)||C0(ue))return ue=OS(ue,Se.mode,ve,null),ue.return=Se,ue;RL(Se,ue)}return null}function ge(Se,ue,ve,tt){var Rt=ue!==null?ue.key:null;if(typeof ve=="string"&&ve!==""||typeof ve=="number")return Rt!==null?null:X(Se,ue,""+ve,tt);if(typeof ve=="object"&&ve!==null){switch(ve.$$typeof){case hL:return ve.key===Rt?$(Se,ue,ve,tt):null;case Tv:return ve.key===Rt?ne(Se,ue,ve,tt):null;case n_:return Rt=ve._init,ge(Se,ue,Rt(ve._payload),tt)}if(D0(ve)||C0(ve))return Rt!==null?null:le(Se,ue,ve,tt,null);RL(Se,ve)}return null}function je(Se,ue,ve,tt,Rt){if(typeof tt=="string"&&tt!==""||typeof tt=="number")return Se=Se.get(ve)||null,X(ue,Se,""+tt,Rt);if(typeof tt=="object"&&tt!==null){switch(tt.$$typeof){case hL:return Se=Se.get(tt.key===null?ve:tt.key)||null,$(ue,Se,tt,Rt);case Tv:return Se=Se.get(tt.key===null?ve:tt.key)||null,ne(ue,Se,tt,Rt);case n_:var lt=tt._init;return je(Se,ue,ve,lt(tt._payload),Rt)}if(D0(tt)||C0(tt))return Se=Se.get(ve)||null,le(ue,Se,tt,Rt,null);RL(ue,tt)}return null}function Fe(Se,ue,ve,tt){for(var Rt=null,lt=null,dt=ue,Et=ue=0,Bt=null;dt!==null&&Et<ve.length;Et++){dt.index>Et?(Bt=dt,dt=null):Bt=dt.sibling;var Ht=ge(Se,dt,ve[Et],tt);if(Ht===null){dt===null&&(dt=Bt);break}d&&dt&&Ht.alternate===null&&h(Se,dt),ue=O(Ht,ue,Et),lt===null?Rt=Ht:lt.sibling=Ht,lt=Ht,dt=Bt}if(Et===ve.length)return E(Se,dt),bs&&RS(Se,Et),Rt;if(dt===null){for(;Et<ve.length;Et++)dt=ae(Se,ve[Et],tt),dt!==null&&(ue=O(dt,ue,Et),lt===null?Rt=dt:lt.sibling=dt,lt=dt);return bs&&RS(Se,Et),Rt}for(dt=T(Se,dt);Et<ve.length;Et++)Bt=je(dt,Se,Et,ve[Et],tt),Bt!==null&&(d&&Bt.alternate!==null&&dt.delete(Bt.key===null?Et:Bt.key),ue=O(Bt,ue,Et),lt===null?Rt=Bt:lt.sibling=Bt,lt=Bt);return d&&dt.forEach(function(rr){return h(Se,rr)}),bs&&RS(Se,Et),Rt}function we(Se,ue,ve,tt){var Rt=C0(ve);if(typeof Rt!="function")throw Error(Pt(150));if(ve=Rt.call(ve),ve==null)throw Error(Pt(151));for(var lt=Rt=null,dt=ue,Et=ue=0,Bt=null,Ht=ve.next();dt!==null&&!Ht.done;Et++,Ht=ve.next()){dt.index>Et?(Bt=dt,dt=null):Bt=dt.sibling;var rr=ge(Se,dt,Ht.value,tt);if(rr===null){dt===null&&(dt=Bt);break}d&&dt&&rr.alternate===null&&h(Se,dt),ue=O(rr,ue,Et),lt===null?Rt=rr:lt.sibling=rr,lt=rr,dt=Bt}if(Ht.done)return E(Se,dt),bs&&RS(Se,Et),Rt;if(dt===null){for(;!Ht.done;Et++,Ht=ve.next())Ht=ae(Se,Ht.value,tt),Ht!==null&&(ue=O(Ht,ue,Et),lt===null?Rt=Ht:lt.sibling=Ht,lt=Ht);return bs&&RS(Se,Et),Rt}for(dt=T(Se,dt);!Ht.done;Et++,Ht=ve.next())Ht=je(dt,Se,Et,Ht.value,tt),Ht!==null&&(d&&Ht.alternate!==null&&dt.delete(Ht.key===null?Et:Ht.key),ue=O(Ht,ue,Et),lt===null?Rt=Ht:lt.sibling=Ht,lt=Ht);return d&&dt.forEach(function(Fr){return h(Se,Fr)}),bs&&RS(Se,Et),Rt}function Ye(Se,ue,ve,tt){if(typeof ve=="object"&&ve!==null&&ve.type===Cv&&ve.key===null&&(ve=ve.props.children),typeof ve=="object"&&ve!==null){switch(ve.$$typeof){case hL:e:{for(var Rt=ve.key,lt=ue;lt!==null;){if(lt.key===Rt){if(Rt=ve.type,Rt===Cv){if(lt.tag===7){E(Se,lt.sibling),ue=A(lt,ve.props.children),ue.return=Se,Se=ue;break e}}else if(lt.elementType===Rt||typeof Rt=="object"&&Rt!==null&&Rt.$$typeof===n_&&BH(Rt)===lt.type){E(Se,lt.sibling),ue=A(lt,ve.props),ue.ref=A0(Se,lt,ve),ue.return=Se,Se=ue;break e}E(Se,lt);break}else h(Se,lt);lt=lt.sibling}ve.type===Cv?(ue=OS(ve.props.children,Se.mode,tt,ve.key),ue.return=Se,Se=ue):(tt=HL(ve.type,ve.key,ve.props,null,Se.mode,tt),tt.ref=A0(Se,ue,ve),tt.return=Se,Se=tt)}return V(Se);case Tv:e:{for(lt=ve.key;ue!==null;){if(ue.key===lt)if(ue.tag===4&&ue.stateNode.containerInfo===ve.containerInfo&&ue.stateNode.implementation===ve.implementation){E(Se,ue.sibling),ue=A(ue,ve.children||[]),ue.return=Se,Se=ue;break e}else{E(Se,ue);break}else h(Se,ue);ue=ue.sibling}ue=DG(ve,Se.mode,tt),ue.return=Se,Se=ue}return V(Se);case n_:return lt=ve._init,Ye(Se,ue,lt(ve._payload),tt)}if(D0(ve))return Fe(Se,ue,ve,tt);if(C0(ve))return we(Se,ue,ve,tt);RL(Se,ve)}return typeof ve=="string"&&ve!==""||typeof ve=="number"?(ve=""+ve,ue!==null&&ue.tag===6?(E(Se,ue.sibling),ue=A(ue,ve),ue.return=Se,Se=ue):(E(Se,ue),ue=NG(ve,Se.mode,tt),ue.return=Se,Se=ue),V(Se)):E(Se,ue)}return Ye}var Bv=JK(!0),XK=JK(!1),a1=v_(null),c1=null,Ov=null,p4=null;function m4(){p4=Ov=c1=null}function f4(d){var h=a1.current;Es(a1),d._currentValue=h}function hW(d,h,E){for(;d!==null;){var T=d.alternate;if((d.childLanes&h)!==h?(d.childLanes|=h,T!==null&&(T.childLanes|=h)):T!==null&&(T.childLanes&h)!==h&&(T.childLanes|=h),d===E)break;d=d.return}}function Uv(d,h){c1=d,p4=Ov=null,d=d.dependencies,d!==null&&d.firstContext!==null&&(d.lanes&h&&(dd=!0),d.firstContext=null)}function kl(d){var h=d._currentValue;if(p4!==d)if(d={context:d,memoizedValue:h,next:null},Ov===null){if(c1===null)throw Error(Pt(308));Ov=d,c1.dependencies={lanes:0,firstContext:d}}else Ov=Ov.next=d;return h}var AS=null;function _4(d){AS===null?AS=[d]:AS.push(d)}function QK(d,h,E,T){var A=h.interleaved;return A===null?(E.next=E,_4(h)):(E.next=A.next,A.next=E),h.interleaved=E,bm(d,T)}function bm(d,h){d.lanes|=h;var E=d.alternate;for(E!==null&&(E.lanes|=h),E=d,d=d.return;d!==null;)d.childLanes|=h,E=d.alternate,E!==null&&(E.childLanes|=h),E=d,d=d.return;return E.tag===3?E.stateNode:null}var i_=!1;function E4(d){d.updateQueue={baseState:d.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function ZK(d,h){d=d.updateQueue,h.updateQueue===d&&(h.updateQueue={baseState:d.baseState,firstBaseUpdate:d.firstBaseUpdate,lastBaseUpdate:d.lastBaseUpdate,shared:d.shared,effects:d.effects})}function Im(d,h){return{eventTime:d,lane:h,tag:0,payload:null,callback:null,next:null}}function m_(d,h,E){var T=d.updateQueue;if(T===null)return null;if(T=T.shared,ir&2){var A=T.pending;return A===null?h.next=h:(h.next=A.next,A.next=h),T.pending=h,bm(d,E)}return A=T.interleaved,A===null?(h.next=h,_4(T)):(h.next=A.next,A.next=h),T.interleaved=h,bm(d,E)}function VL(d,h,E){if(h=h.updateQueue,h!==null&&(h=h.shared,(E&4194240)!==0)){var T=h.lanes;T&=d.pendingLanes,E|=T,h.lanes=E,n4(d,E)}}function GH(d,h){var E=d.updateQueue,T=d.alternate;if(T!==null&&(T=T.updateQueue,E===T)){var A=null,O=null;if(E=E.firstBaseUpdate,E!==null){do{var V={eventTime:E.eventTime,lane:E.lane,tag:E.tag,payload:E.payload,callback:E.callback,next:null};O===null?A=O=V:O=O.next=V,E=E.next}while(E!==null);O===null?A=O=h:O=O.next=h}else A=O=h;E={baseState:T.baseState,firstBaseUpdate:A,lastBaseUpdate:O,shared:T.shared,effects:T.effects},d.updateQueue=E;return}d=E.lastBaseUpdate,d===null?E.firstBaseUpdate=h:d.next=h,E.lastBaseUpdate=h}function d1(d,h,E,T){var A=d.updateQueue;i_=!1;var O=A.firstBaseUpdate,V=A.lastBaseUpdate,X=A.shared.pending;if(X!==null){A.shared.pending=null;var $=X,ne=$.next;$.next=null,V===null?O=ne:V.next=ne,V=$;var le=d.alternate;le!==null&&(le=le.updateQueue,X=le.lastBaseUpdate,X!==V&&(X===null?le.firstBaseUpdate=ne:X.next=ne,le.lastBaseUpdate=$))}if(O!==null){var ae=A.baseState;V=0,le=ne=$=null,X=O;do{var ge=X.lane,je=X.eventTime;if((T&ge)===ge){le!==null&&(le=le.next={eventTime:je,lane:0,tag:X.tag,payload:X.payload,callback:X.callback,next:null});e:{var Fe=d,we=X;switch(ge=h,je=E,we.tag){case 1:if(Fe=we.payload,typeof Fe=="function"){ae=Fe.call(je,ae,ge);break e}ae=Fe;break e;case 3:Fe.flags=Fe.flags&-65537|128;case 0:if(Fe=we.payload,ge=typeof Fe=="function"?Fe.call(je,ae,ge):Fe,ge==null)break e;ae=js({},ae,ge);break e;case 2:i_=!0}}X.callback!==null&&X.lane!==0&&(d.flags|=64,ge=A.effects,ge===null?A.effects=[X]:ge.push(X))}else je={eventTime:je,lane:ge,tag:X.tag,payload:X.payload,callback:X.callback,next:null},le===null?(ne=le=je,$=ae):le=le.next=je,V|=ge;if(X=X.next,X===null){if(X=A.shared.pending,X===null)break;ge=X,X=ge.next,ge.next=null,A.lastBaseUpdate=ge,A.shared.pending=null}}while(!0);if(le===null&&($=ae),A.baseState=$,A.firstBaseUpdate=ne,A.lastBaseUpdate=le,h=A.shared.interleaved,h!==null){A=h;do V|=A.lane,A=A.next;while(A!==h)}else O===null&&(A.shared.lanes=0);LS|=V,d.lanes=V,d.memoizedState=ae}}function WH(d,h,E){if(d=h.effects,h.effects=null,d!==null)for(h=0;h<d.length;h++){var T=d[h],A=T.callback;if(A!==null){if(T.callback=null,T=E,typeof A!="function")throw Error(Pt(191,A));A.call(T)}}}var SO={},Yh=v_(SO),iO=v_(SO),rO=v_(SO);function wS(d){if(d===SO)throw Error(Pt(174));return d}function g4(d,h){switch(os(rO,h),os(iO,d),os(Yh,SO),d=h.nodeType,d){case 9:case 11:h=(h=h.documentElement)?h.namespaceURI:YG(null,"");break;default:d=d===8?h.parentNode:h,h=d.namespaceURI||null,d=d.tagName,h=YG(h,d)}Es(Yh),os(Yh,h)}function Gv(){Es(Yh),Es(iO),Es(rO)}function $K(d){wS(rO.current);var h=wS(Yh.current),E=YG(h,d.type);h!==E&&(os(iO,d),os(Yh,E))}function S4(d){iO.current===d&&(Es(Yh),Es(iO))}var Vs=v_(0);function l1(d){for(var h=d;h!==null;){if(h.tag===13){var E=h.memoizedState;if(E!==null&&(E=E.dehydrated,E===null||E.data==="$?"||E.data==="$!"))return h}else if(h.tag===19&&h.memoizedProps.revealOrder!==void 0){if(h.flags&128)return h}else if(h.child!==null){h.child.return=h,h=h.child;continue}if(h===d)break;for(;h.sibling===null;){if(h.return===null||h.return===d)return null;h=h.return}h.sibling.return=h.return,h=h.sibling}return null}var yG=[];function T4(){for(var d=0;d<yG.length;d++)yG[d]._workInProgressVersionPrimary=null;yG.length=0}var FL=Nm.ReactCurrentDispatcher,IG=Nm.ReactCurrentBatchConfig,kS=0,Fs=null,Go=null,na=null,u1=!1,F0=!1,sO=0,IJ=0;function Ya(){throw Error(Pt(321))}function C4(d,h){if(h===null)return!1;for(var E=0;E<h.length&&E<d.length;E++)if(!Ku(d[E],h[E]))return!1;return!0}function v4(d,h,E,T,A,O){if(kS=O,Fs=h,h.memoizedState=null,h.updateQueue=null,h.lanes=0,FL.current=d===null||d.memoizedState===null?OJ:NJ,d=E(T,A),F0){O=0;do{if(F0=!1,sO=0,25<=O)throw Error(Pt(301));O+=1,na=Go=null,h.updateQueue=null,FL.current=DJ,d=E(T,A)}while(F0)}if(FL.current=h1,h=Go!==null&&Go.next!==null,kS=0,na=Go=Fs=null,u1=!1,h)throw Error(Pt(300));return d}function R4(){var d=sO!==0;return sO=0,d}function Wh(){var d={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return na===null?Fs.memoizedState=na=d:na=na.next=d,na}function Ll(){if(Go===null){var d=Fs.alternate;d=d!==null?d.memoizedState:null}else d=Go.next;var h=na===null?Fs.memoizedState:na.next;if(h!==null)na=h,Go=d;else{if(d===null)throw Error(Pt(310));Go=d,d={memoizedState:Go.memoizedState,baseState:Go.baseState,baseQueue:Go.baseQueue,queue:Go.queue,next:null},na===null?Fs.memoizedState=na=d:na=na.next=d}return na}function oO(d,h){return typeof h=="function"?h(d):h}function AG(d){var h=Ll(),E=h.queue;if(E===null)throw Error(Pt(311));E.lastRenderedReducer=d;var T=Go,A=T.baseQueue,O=E.pending;if(O!==null){if(A!==null){var V=A.next;A.next=O.next,O.next=V}T.baseQueue=A=O,E.pending=null}if(A!==null){O=A.next,T=T.baseState;var X=V=null,$=null,ne=O;do{var le=ne.lane;if((kS&le)===le)$!==null&&($=$.next={lane:0,action:ne.action,hasEagerState:ne.hasEagerState,eagerState:ne.eagerState,next:null}),T=ne.hasEagerState?ne.eagerState:d(T,ne.action);else{var ae={lane:le,action:ne.action,hasEagerState:ne.hasEagerState,eagerState:ne.eagerState,next:null};$===null?(X=$=ae,V=T):$=$.next=ae,Fs.lanes|=le,LS|=le}ne=ne.next}while(ne!==null&&ne!==O);$===null?V=T:$.next=X,Ku(T,h.memoizedState)||(dd=!0),h.memoizedState=T,h.baseState=V,h.baseQueue=$,E.lastRenderedState=T}if(d=E.interleaved,d!==null){A=d;do O=A.lane,Fs.lanes|=O,LS|=O,A=A.next;while(A!==d)}else A===null&&(E.lanes=0);return[h.memoizedState,E.dispatch]}function wG(d){var h=Ll(),E=h.queue;if(E===null)throw Error(Pt(311));E.lastRenderedReducer=d;var T=E.dispatch,A=E.pending,O=h.memoizedState;if(A!==null){E.pending=null;var V=A=A.next;do O=d(O,V.action),V=V.next;while(V!==A);Ku(O,h.memoizedState)||(dd=!0),h.memoizedState=O,h.baseQueue===null&&(h.baseState=O),E.lastRenderedState=O}return[O,T]}function e8(){}function t8(d,h){var E=Fs,T=Ll(),A=h(),O=!Ku(T.memoizedState,A);if(O&&(T.memoizedState=A,dd=!0),T=T.queue,y4(r8.bind(null,E,T,d),[d]),T.getSnapshot!==h||O||na!==null&&na.memoizedState.tag&1){if(E.flags|=2048,aO(9,i8.bind(null,E,T,A,h),void 0,null),ia===null)throw Error(Pt(349));kS&30||n8(E,h,A)}return A}function n8(d,h,E){d.flags|=16384,d={getSnapshot:h,value:E},h=Fs.updateQueue,h===null?(h={lastEffect:null,stores:null},Fs.updateQueue=h,h.stores=[d]):(E=h.stores,E===null?h.stores=[d]:E.push(d))}function i8(d,h,E,T){h.value=E,h.getSnapshot=T,s8(h)&&o8(d)}function r8(d,h,E){return E(function(){s8(h)&&o8(d)})}function s8(d){var h=d.getSnapshot;d=d.value;try{var E=h();return!Ku(d,E)}catch{return!0}}function o8(d){var h=bm(d,1);h!==null&&Hu(h,d,1,-1)}function HH(d){var h=Wh();return typeof d=="function"&&(d=d()),h.memoizedState=h.baseState=d,d={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:oO,lastRenderedState:d},h.queue=d,d=d.dispatch=bJ.bind(null,Fs,d),[h.memoizedState,d]}function aO(d,h,E,T){return d={tag:d,create:h,destroy:E,deps:T,next:null},h=Fs.updateQueue,h===null?(h={lastEffect:null,stores:null},Fs.updateQueue=h,h.lastEffect=d.next=d):(E=h.lastEffect,E===null?h.lastEffect=d.next=d:(T=E.next,E.next=d,d.next=T,h.lastEffect=d)),d}function a8(){return Ll().memoizedState}function jL(d,h,E,T){var A=Wh();Fs.flags|=d,A.memoizedState=aO(1|h,E,void 0,T===void 0?null:T)}function O1(d,h,E,T){var A=Ll();T=T===void 0?null:T;var O=void 0;if(Go!==null){var V=Go.memoizedState;if(O=V.destroy,T!==null&&C4(T,V.deps)){A.memoizedState=aO(h,E,O,T);return}}Fs.flags|=d,A.memoizedState=aO(1|h,E,O,T)}function KH(d,h){return jL(8390656,8,d,h)}function y4(d,h){return O1(2048,8,d,h)}function c8(d,h){return O1(4,2,d,h)}function d8(d,h){return O1(4,4,d,h)}function l8(d,h){if(typeof h=="function")return d=d(),h(d),function(){h(null)};if(h!=null)return d=d(),h.current=d,function(){h.current=null}}function u8(d,h,E){return E=E!=null?E.concat([d]):null,O1(4,4,l8.bind(null,h,d),E)}function I4(){}function h8(d,h){var E=Ll();h=h===void 0?null:h;var T=E.memoizedState;return T!==null&&h!==null&&C4(h,T[1])?T[0]:(E.memoizedState=[d,h],d)}function p8(d,h){var E=Ll();h=h===void 0?null:h;var T=E.memoizedState;return T!==null&&h!==null&&C4(h,T[1])?T[0]:(d=d(),E.memoizedState=[d,h],d)}function m8(d,h,E){return kS&21?(Ku(E,h)||(E=SK(),Fs.lanes|=E,LS|=E,d.baseState=!0),h):(d.baseState&&(d.baseState=!1,dd=!0),d.memoizedState=E)}function AJ(d,h){var E=wr;wr=E!==0&&4>E?E:4,d(!0);var T=IG.transition;IG.transition={};try{d(!1),h()}finally{wr=E,IG.transition=T}}function f8(){return Ll().memoizedState}function wJ(d,h,E){var T=__(d);if(E={lane:T,action:E,hasEagerState:!1,eagerState:null,next:null},_8(d))E8(h,E);else if(E=QK(d,h,E,T),E!==null){var A=Pc();Hu(E,d,T,A),g8(E,h,T)}}function bJ(d,h,E){var T=__(d),A={lane:T,action:E,hasEagerState:!1,eagerState:null,next:null};if(_8(d))E8(h,A);else{var O=d.alternate;if(d.lanes===0&&(O===null||O.lanes===0)&&(O=h.lastRenderedReducer,O!==null))try{var V=h.lastRenderedState,X=O(V,E);if(A.hasEagerState=!0,A.eagerState=X,Ku(X,V)){var $=h.interleaved;$===null?(A.next=A,_4(h)):(A.next=$.next,$.next=A),h.interleaved=A;return}}catch{}finally{}E=QK(d,h,A,T),E!==null&&(A=Pc(),Hu(E,d,T,A),g8(E,h,T))}}function _8(d){var h=d.alternate;return d===Fs||h!==null&&h===Fs}function E8(d,h){F0=u1=!0;var E=d.pending;E===null?h.next=h:(h.next=E.next,E.next=h),d.pending=h}function g8(d,h,E){if(E&4194240){var T=h.lanes;T&=d.pendingLanes,E|=T,h.lanes=E,n4(d,E)}}var h1={readContext:kl,useCallback:Ya,useContext:Ya,useEffect:Ya,useImperativeHandle:Ya,useInsertionEffect:Ya,useLayoutEffect:Ya,useMemo:Ya,useReducer:Ya,useRef:Ya,useState:Ya,useDebugValue:Ya,useDeferredValue:Ya,useTransition:Ya,useMutableSource:Ya,useSyncExternalStore:Ya,useId:Ya,unstable_isNewReconciler:!1},OJ={readContext:kl,useCallback:function(d,h){return Wh().memoizedState=[d,h===void 0?null:h],d},useContext:kl,useEffect:KH,useImperativeHandle:function(d,h,E){return E=E!=null?E.concat([d]):null,jL(4194308,4,l8.bind(null,h,d),E)},useLayoutEffect:function(d,h){return jL(4194308,4,d,h)},useInsertionEffect:function(d,h){return jL(4,2,d,h)},useMemo:function(d,h){var E=Wh();return h=h===void 0?null:h,d=d(),E.memoizedState=[d,h],d},useReducer:function(d,h,E){var T=Wh();return h=E!==void 0?E(h):h,T.memoizedState=T.baseState=h,d={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:d,lastRenderedState:h},T.queue=d,d=d.dispatch=wJ.bind(null,Fs,d),[T.memoizedState,d]},useRef:function(d){var h=Wh();return d={current:d},h.memoizedState=d},useState:HH,useDebugValue:I4,useDeferredValue:function(d){return Wh().memoizedState=d},useTransition:function(){var d=HH(!1),h=d[0];return d=AJ.bind(null,d[1]),Wh().memoizedState=d,[h,d]},useMutableSource:function(){},useSyncExternalStore:function(d,h,E){var T=Fs,A=Wh();if(bs){if(E===void 0)throw Error(Pt(407));E=E()}else{if(E=h(),ia===null)throw Error(Pt(349));kS&30||n8(T,h,E)}A.memoizedState=E;var O={value:E,getSnapshot:h};return A.queue=O,KH(r8.bind(null,T,O,d),[d]),T.flags|=2048,aO(9,i8.bind(null,T,O,E,h),void 0,null),E},useId:function(){var d=Wh(),h=ia.identifierPrefix;if(bs){var E=ym,T=Rm;E=(T&~(1<<32-Wu(T)-1)).toString(32)+E,h=":"+h+"R"+E,E=sO++,0<E&&(h+="H"+E.toString(32)),h+=":"}else E=IJ++,h=":"+h+"r"+E.toString(32)+":";return d.memoizedState=h},unstable_isNewReconciler:!1},NJ={readContext:kl,useCallback:h8,useContext:kl,useEffect:y4,useImperativeHandle:u8,useInsertionEffect:c8,useLayoutEffect:d8,useMemo:p8,useReducer:AG,useRef:a8,useState:function(){return AG(oO)},useDebugValue:I4,useDeferredValue:function(d){var h=Ll();return m8(h,Go.memoizedState,d)},useTransition:function(){var d=AG(oO)[0],h=Ll().memoizedState;return[d,h]},useMutableSource:e8,useSyncExternalStore:t8,useId:f8,unstable_isNewReconciler:!1},DJ={readContext:kl,useCallback:h8,useContext:kl,useEffect:y4,useImperativeHandle:u8,useInsertionEffect:c8,useLayoutEffect:d8,useMemo:p8,useReducer:wG,useRef:a8,useState:function(){return wG(oO)},useDebugValue:I4,useDeferredValue:function(d){var h=Ll();return Go===null?h.memoizedState=d:m8(h,Go.memoizedState,d)},useTransition:function(){var d=wG(oO)[0],h=Ll().memoizedState;return[d,h]},useMutableSource:e8,useSyncExternalStore:t8,useId:f8,unstable_isNewReconciler:!1};function ju(d,h){if(d&&d.defaultProps){h=js({},h),d=d.defaultProps;for(var E in d)h[E]===void 0&&(h[E]=d[E]);return h}return h}function pW(d,h,E,T){h=d.memoizedState,E=E(T,h),E=E==null?h:js({},h,E),d.memoizedState=E,d.lanes===0&&(d.updateQueue.baseState=E)}var N1={isMounted:function(d){return(d=d._reactInternals)?VS(d)===d:!1},enqueueSetState:function(d,h,E){d=d._reactInternals;var T=Pc(),A=__(d),O=Im(T,A);O.payload=h,E!=null&&(O.callback=E),h=m_(d,O,A),h!==null&&(Hu(h,d,A,T),VL(h,d,A))},enqueueReplaceState:function(d,h,E){d=d._reactInternals;var T=Pc(),A=__(d),O=Im(T,A);O.tag=1,O.payload=h,E!=null&&(O.callback=E),h=m_(d,O,A),h!==null&&(Hu(h,d,A,T),VL(h,d,A))},enqueueForceUpdate:function(d,h){d=d._reactInternals;var E=Pc(),T=__(d),A=Im(E,T);A.tag=2,h!=null&&(A.callback=h),h=m_(d,A,T),h!==null&&(Hu(h,d,T,E),VL(h,d,T))}};function YH(d,h,E,T,A,O,V){return d=d.stateNode,typeof d.shouldComponentUpdate=="function"?d.shouldComponentUpdate(T,O,V):h.prototype&&h.prototype.isPureReactComponent?!$0(E,T)||!$0(A,O):!0}function S8(d,h,E){var T=!1,A=T_,O=h.contextType;return typeof O=="object"&&O!==null?O=kl(O):(A=ud(h)?DS:Xa.current,T=h.contextTypes,O=(T=T!=null)?Fv(d,A):T_),h=new h(E,O),d.memoizedState=h.state!==null&&h.state!==void 0?h.state:null,h.updater=N1,d.stateNode=h,h._reactInternals=d,T&&(d=d.stateNode,d.__reactInternalMemoizedUnmaskedChildContext=A,d.__reactInternalMemoizedMaskedChildContext=O),h}function zH(d,h,E,T){d=h.state,typeof h.componentWillReceiveProps=="function"&&h.componentWillReceiveProps(E,T),typeof h.UNSAFE_componentWillReceiveProps=="function"&&h.UNSAFE_componentWillReceiveProps(E,T),h.state!==d&&N1.enqueueReplaceState(h,h.state,null)}function mW(d,h,E,T){var A=d.stateNode;A.props=E,A.state=d.memoizedState,A.refs={},E4(d);var O=h.contextType;typeof O=="object"&&O!==null?A.context=kl(O):(O=ud(h)?DS:Xa.current,A.context=Fv(d,O)),A.state=d.memoizedState,O=h.getDerivedStateFromProps,typeof O=="function"&&(pW(d,h,O,E),A.state=d.memoizedState),typeof h.getDerivedStateFromProps=="function"||typeof A.getSnapshotBeforeUpdate=="function"||typeof A.UNSAFE_componentWillMount!="function"&&typeof A.componentWillMount!="function"||(h=A.state,typeof A.componentWillMount=="function"&&A.componentWillMount(),typeof A.UNSAFE_componentWillMount=="function"&&A.UNSAFE_componentWillMount(),h!==A.state&&N1.enqueueReplaceState(A,A.state,null),d1(d,E,A,T),A.state=d.memoizedState),typeof A.componentDidMount=="function"&&(d.flags|=4194308)}function Wv(d,h){try{var E="",T=h;do E+=sq(T),T=T.return;while(T);var A=E}catch(O){A=`
Error generating stack: `+O.message+`
`+O.stack}return{value:d,source:h,stack:A,digest:null}}function bG(d,h,E){return{value:d,source:null,stack:E??null,digest:h??null}}function fW(d,h){try{console.error(h.value)}catch(E){setTimeout(function(){throw E})}}var PJ=typeof WeakMap=="function"?WeakMap:Map;function T8(d,h,E){E=Im(-1,E),E.tag=3,E.payload={element:null};var T=h.value;return E.callback=function(){m1||(m1=!0,IW=T),fW(d,h)},E}function C8(d,h,E){E=Im(-1,E),E.tag=3;var T=d.type.getDerivedStateFromError;if(typeof T=="function"){var A=h.value;E.payload=function(){return T(A)},E.callback=function(){fW(d,h)}}var O=d.stateNode;return O!==null&&typeof O.componentDidCatch=="function"&&(E.callback=function(){fW(d,h),typeof T!="function"&&(f_===null?f_=new Set([this]):f_.add(this));var V=h.stack;this.componentDidCatch(h.value,{componentStack:V!==null?V:""})}),E}function qH(d,h,E){var T=d.pingCache;if(T===null){T=d.pingCache=new PJ;var A=new Set;T.set(h,A)}else A=T.get(h),A===void 0&&(A=new Set,T.set(h,A));A.has(E)||(A.add(E),d=YJ.bind(null,d,h,E),h.then(d,d))}function JH(d){do{var h;if((h=d.tag===13)&&(h=d.memoizedState,h=h!==null?h.dehydrated!==null:!0),h)return d;d=d.return}while(d!==null);return null}function XH(d,h,E,T,A){return d.mode&1?(d.flags|=65536,d.lanes=A,d):(d===h?d.flags|=65536:(d.flags|=128,E.flags|=131072,E.flags&=-52805,E.tag===1&&(E.alternate===null?E.tag=17:(h=Im(-1,1),h.tag=2,m_(E,h,1))),E.lanes|=1),d)}var kJ=Nm.ReactCurrentOwner,dd=!1;function Nc(d,h,E,T){h.child=d===null?XK(h,null,E,T):Bv(h,d.child,E,T)}function QH(d,h,E,T,A){E=E.render;var O=h.ref;return Uv(h,A),T=v4(d,h,E,T,O,A),E=R4(),d!==null&&!dd?(h.updateQueue=d.updateQueue,h.flags&=-2053,d.lanes&=~A,Om(d,h,A)):(bs&&E&&l4(h),h.flags|=1,Nc(d,h,T,A),h.child)}function ZH(d,h,E,T,A){if(d===null){var O=E.type;return typeof O=="function"&&!k4(O)&&O.defaultProps===void 0&&E.compare===null&&E.defaultProps===void 0?(h.tag=15,h.type=O,v8(d,h,O,T,A)):(d=HL(E.type,null,T,h,h.mode,A),d.ref=h.ref,d.return=h,h.child=d)}if(O=d.child,!(d.lanes&A)){var V=O.memoizedProps;if(E=E.compare,E=E!==null?E:$0,E(V,T)&&d.ref===h.ref)return Om(d,h,A)}return h.flags|=1,d=E_(O,T),d.ref=h.ref,d.return=h,h.child=d}function v8(d,h,E,T,A){if(d!==null){var O=d.memoizedProps;if($0(O,T)&&d.ref===h.ref)if(dd=!1,h.pendingProps=T=O,(d.lanes&A)!==0)d.flags&131072&&(dd=!0);else return h.lanes=d.lanes,Om(d,h,A)}return _W(d,h,E,T,A)}function R8(d,h,E){var T=h.pendingProps,A=T.children,O=d!==null?d.memoizedState:null;if(T.mode==="hidden")if(!(h.mode&1))h.memoizedState={baseLanes:0,cachePool:null,transitions:null},os(Dv,Yd),Yd|=E;else{if(!(E&1073741824))return d=O!==null?O.baseLanes|E:E,h.lanes=h.childLanes=1073741824,h.memoizedState={baseLanes:d,cachePool:null,transitions:null},h.updateQueue=null,os(Dv,Yd),Yd|=d,null;h.memoizedState={baseLanes:0,cachePool:null,transitions:null},T=O!==null?O.baseLanes:E,os(Dv,Yd),Yd|=T}else O!==null?(T=O.baseLanes|E,h.memoizedState=null):T=E,os(Dv,Yd),Yd|=T;return Nc(d,h,A,E),h.child}function y8(d,h){var E=h.ref;(d===null&&E!==null||d!==null&&d.ref!==E)&&(h.flags|=512,h.flags|=2097152)}function _W(d,h,E,T,A){var O=ud(E)?DS:Xa.current;return O=Fv(h,O),Uv(h,A),E=v4(d,h,E,T,O,A),T=R4(),d!==null&&!dd?(h.updateQueue=d.updateQueue,h.flags&=-2053,d.lanes&=~A,Om(d,h,A)):(bs&&T&&l4(h),h.flags|=1,Nc(d,h,E,A),h.child)}function $H(d,h,E,T,A){if(ud(E)){var O=!0;r1(h)}else O=!1;if(Uv(h,A),h.stateNode===null)BL(d,h),S8(h,E,T),mW(h,E,T,A),T=!0;else if(d===null){var V=h.stateNode,X=h.memoizedProps;V.props=X;var $=V.context,ne=E.contextType;typeof ne=="object"&&ne!==null?ne=kl(ne):(ne=ud(E)?DS:Xa.current,ne=Fv(h,ne));var le=E.getDerivedStateFromProps,ae=typeof le=="function"||typeof V.getSnapshotBeforeUpdate=="function";ae||typeof V.UNSAFE_componentWillReceiveProps!="function"&&typeof V.componentWillReceiveProps!="function"||(X!==T||$!==ne)&&zH(h,V,T,ne),i_=!1;var ge=h.memoizedState;V.state=ge,d1(h,T,V,A),$=h.memoizedState,X!==T||ge!==$||ld.current||i_?(typeof le=="function"&&(pW(h,E,le,T),$=h.memoizedState),(X=i_||YH(h,E,X,T,ge,$,ne))?(ae||typeof V.UNSAFE_componentWillMount!="function"&&typeof V.componentWillMount!="function"||(typeof V.componentWillMount=="function"&&V.componentWillMount(),typeof V.UNSAFE_componentWillMount=="function"&&V.UNSAFE_componentWillMount()),typeof V.componentDidMount=="function"&&(h.flags|=4194308)):(typeof V.componentDidMount=="function"&&(h.flags|=4194308),h.memoizedProps=T,h.memoizedState=$),V.props=T,V.state=$,V.context=ne,T=X):(typeof V.componentDidMount=="function"&&(h.flags|=4194308),T=!1)}else{V=h.stateNode,ZK(d,h),X=h.memoizedProps,ne=h.type===h.elementType?X:ju(h.type,X),V.props=ne,ae=h.pendingProps,ge=V.context,$=E.contextType,typeof $=="object"&&$!==null?$=kl($):($=ud(E)?DS:Xa.current,$=Fv(h,$));var je=E.getDerivedStateFromProps;(le=typeof je=="function"||typeof V.getSnapshotBeforeUpdate=="function")||typeof V.UNSAFE_componentWillReceiveProps!="function"&&typeof V.componentWillReceiveProps!="function"||(X!==ae||ge!==$)&&zH(h,V,T,$),i_=!1,ge=h.memoizedState,V.state=ge,d1(h,T,V,A);var Fe=h.memoizedState;X!==ae||ge!==Fe||ld.current||i_?(typeof je=="function"&&(pW(h,E,je,T),Fe=h.memoizedState),(ne=i_||YH(h,E,ne,T,ge,Fe,$)||!1)?(le||typeof V.UNSAFE_componentWillUpdate!="function"&&typeof V.componentWillUpdate!="function"||(typeof V.componentWillUpdate=="function"&&V.componentWillUpdate(T,Fe,$),typeof V.UNSAFE_componentWillUpdate=="function"&&V.UNSAFE_componentWillUpdate(T,Fe,$)),typeof V.componentDidUpdate=="function"&&(h.flags|=4),typeof V.getSnapshotBeforeUpdate=="function"&&(h.flags|=1024)):(typeof V.componentDidUpdate!="function"||X===d.memoizedProps&&ge===d.memoizedState||(h.flags|=4),typeof V.getSnapshotBeforeUpdate!="function"||X===d.memoizedProps&&ge===d.memoizedState||(h.flags|=1024),h.memoizedProps=T,h.memoizedState=Fe),V.props=T,V.state=Fe,V.context=$,T=ne):(typeof V.componentDidUpdate!="function"||X===d.memoizedProps&&ge===d.memoizedState||(h.flags|=4),typeof V.getSnapshotBeforeUpdate!="function"||X===d.memoizedProps&&ge===d.memoizedState||(h.flags|=1024),T=!1)}return EW(d,h,E,T,O,A)}function EW(d,h,E,T,A,O){y8(d,h);var V=(h.flags&128)!==0;if(!T&&!V)return A&&VH(h,E,!1),Om(d,h,O);T=h.stateNode,kJ.current=h;var X=V&&typeof E.getDerivedStateFromError!="function"?null:T.render();return h.flags|=1,d!==null&&V?(h.child=Bv(h,d.child,null,O),h.child=Bv(h,null,X,O)):Nc(d,h,X,O),h.memoizedState=T.state,A&&VH(h,E,!0),h.child}function I8(d){var h=d.stateNode;h.pendingContext?xH(d,h.pendingContext,h.pendingContext!==h.context):h.context&&xH(d,h.context,!1),g4(d,h.containerInfo)}function e6(d,h,E,T,A){return jv(),h4(A),h.flags|=256,Nc(d,h,E,T),h.child}var gW={dehydrated:null,treeContext:null,retryLane:0};function SW(d){return{baseLanes:d,cachePool:null,transitions:null}}function A8(d,h,E){var T=h.pendingProps,A=Vs.current,O=!1,V=(h.flags&128)!==0,X;if((X=V)||(X=d!==null&&d.memoizedState===null?!1:(A&2)!==0),X?(O=!0,h.flags&=-129):(d===null||d.memoizedState!==null)&&(A|=1),os(Vs,A&1),d===null)return uW(h),d=h.memoizedState,d!==null&&(d=d.dehydrated,d!==null)?(h.mode&1?d.data==="$!"?h.lanes=8:h.lanes=1073741824:h.lanes=1,null):(V=T.children,d=T.fallback,O?(T=h.mode,O=h.child,V={mode:"hidden",children:V},!(T&1)&&O!==null?(O.childLanes=0,O.pendingProps=V):O=k1(V,T,0,null),d=OS(d,T,E,null),O.return=h,d.return=h,O.sibling=d,h.child=O,h.child.memoizedState=SW(E),h.memoizedState=gW,d):A4(h,V));if(A=d.memoizedState,A!==null&&(X=A.dehydrated,X!==null))return LJ(d,h,V,T,X,A,E);if(O){O=T.fallback,V=h.mode,A=d.child,X=A.sibling;var $={mode:"hidden",children:T.children};return!(V&1)&&h.child!==A?(T=h.child,T.childLanes=0,T.pendingProps=$,h.deletions=null):(T=E_(A,$),T.subtreeFlags=A.subtreeFlags&14680064),X!==null?O=E_(X,O):(O=OS(O,V,E,null),O.flags|=2),O.return=h,T.return=h,T.sibling=O,h.child=T,T=O,O=h.child,V=d.child.memoizedState,V=V===null?SW(E):{baseLanes:V.baseLanes|E,cachePool:null,transitions:V.transitions},O.memoizedState=V,O.childLanes=d.childLanes&~E,h.memoizedState=gW,T}return O=d.child,d=O.sibling,T=E_(O,{mode:"visible",children:T.children}),!(h.mode&1)&&(T.lanes=E),T.return=h,T.sibling=null,d!==null&&(E=h.deletions,E===null?(h.deletions=[d],h.flags|=16):E.push(d)),h.child=T,h.memoizedState=null,T}function A4(d,h){return h=k1({mode:"visible",children:h},d.mode,0,null),h.return=d,d.child=h}function yL(d,h,E,T){return T!==null&&h4(T),Bv(h,d.child,null,E),d=A4(h,h.pendingProps.children),d.flags|=2,h.memoizedState=null,d}function LJ(d,h,E,T,A,O,V){if(E)return h.flags&256?(h.flags&=-257,T=bG(Error(Pt(422))),yL(d,h,V,T)):h.memoizedState!==null?(h.child=d.child,h.flags|=128,null):(O=T.fallback,A=h.mode,T=k1({mode:"visible",children:T.children},A,0,null),O=OS(O,A,V,null),O.flags|=2,T.return=h,O.return=h,T.sibling=O,h.child=T,h.mode&1&&Bv(h,d.child,null,V),h.child.memoizedState=SW(V),h.memoizedState=gW,O);if(!(h.mode&1))return yL(d,h,V,null);if(A.data==="$!"){if(T=A.nextSibling&&A.nextSibling.dataset,T)var X=T.dgst;return T=X,O=Error(Pt(419)),T=bG(O,T,void 0),yL(d,h,V,T)}if(X=(V&d.childLanes)!==0,dd||X){if(T=ia,T!==null){switch(V&-V){case 4:A=2;break;case 16:A=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:A=32;break;case 536870912:A=268435456;break;default:A=0}A=A&(T.suspendedLanes|V)?0:A,A!==0&&A!==O.retryLane&&(O.retryLane=A,bm(d,A),Hu(T,d,A,-1))}return P4(),T=bG(Error(Pt(421))),yL(d,h,V,T)}return A.data==="$?"?(h.flags|=128,h.child=d.child,h=zJ.bind(null,d),A._reactRetry=h,null):(d=O.treeContext,zd=p_(A.nextSibling),Jd=h,bs=!0,Gu=null,d!==null&&(Ol[Nl++]=Rm,Ol[Nl++]=ym,Ol[Nl++]=PS,Rm=d.id,ym=d.overflow,PS=h),h=A4(h,T.children),h.flags|=4096,h)}function t6(d,h,E){d.lanes|=h;var T=d.alternate;T!==null&&(T.lanes|=h),hW(d.return,h,E)}function OG(d,h,E,T,A){var O=d.memoizedState;O===null?d.memoizedState={isBackwards:h,rendering:null,renderingStartTime:0,last:T,tail:E,tailMode:A}:(O.isBackwards=h,O.rendering=null,O.renderingStartTime=0,O.last=T,O.tail=E,O.tailMode=A)}function w8(d,h,E){var T=h.pendingProps,A=T.revealOrder,O=T.tail;if(Nc(d,h,T.children,E),T=Vs.current,T&2)T=T&1|2,h.flags|=128;else{if(d!==null&&d.flags&128)e:for(d=h.child;d!==null;){if(d.tag===13)d.memoizedState!==null&&t6(d,E,h);else if(d.tag===19)t6(d,E,h);else if(d.child!==null){d.child.return=d,d=d.child;continue}if(d===h)break e;for(;d.sibling===null;){if(d.return===null||d.return===h)break e;d=d.return}d.sibling.return=d.return,d=d.sibling}T&=1}if(os(Vs,T),!(h.mode&1))h.memoizedState=null;else switch(A){case"forwards":for(E=h.child,A=null;E!==null;)d=E.alternate,d!==null&&l1(d)===null&&(A=E),E=E.sibling;E=A,E===null?(A=h.child,h.child=null):(A=E.sibling,E.sibling=null),OG(h,!1,A,E,O);break;case"backwards":for(E=null,A=h.child,h.child=null;A!==null;){if(d=A.alternate,d!==null&&l1(d)===null){h.child=A;break}d=A.sibling,A.sibling=E,E=A,A=d}OG(h,!0,E,null,O);break;case"together":OG(h,!1,null,null,void 0);break;default:h.memoizedState=null}return h.child}function BL(d,h){!(h.mode&1)&&d!==null&&(d.alternate=null,h.alternate=null,h.flags|=2)}function Om(d,h,E){if(d!==null&&(h.dependencies=d.dependencies),LS|=h.lanes,!(E&h.childLanes))return null;if(d!==null&&h.child!==d.child)throw Error(Pt(153));if(h.child!==null){for(d=h.child,E=E_(d,d.pendingProps),h.child=E,E.return=h;d.sibling!==null;)d=d.sibling,E=E.sibling=E_(d,d.pendingProps),E.return=h;E.sibling=null}return h.child}function MJ(d,h,E){switch(h.tag){case 3:I8(h),jv();break;case 5:$K(h);break;case 1:ud(h.type)&&r1(h);break;case 4:g4(h,h.stateNode.containerInfo);break;case 10:var T=h.type._context,A=h.memoizedProps.value;os(a1,T._currentValue),T._currentValue=A;break;case 13:if(T=h.memoizedState,T!==null)return T.dehydrated!==null?(os(Vs,Vs.current&1),h.flags|=128,null):E&h.child.childLanes?A8(d,h,E):(os(Vs,Vs.current&1),d=Om(d,h,E),d!==null?d.sibling:null);os(Vs,Vs.current&1);break;case 19:if(T=(E&h.childLanes)!==0,d.flags&128){if(T)return w8(d,h,E);h.flags|=128}if(A=h.memoizedState,A!==null&&(A.rendering=null,A.tail=null,A.lastEffect=null),os(Vs,Vs.current),T)break;return null;case 22:case 23:return h.lanes=0,R8(d,h,E)}return Om(d,h,E)}var b8,TW,O8,N8;b8=function(d,h){for(var E=h.child;E!==null;){if(E.tag===5||E.tag===6)d.appendChild(E.stateNode);else if(E.tag!==4&&E.child!==null){E.child.return=E,E=E.child;continue}if(E===h)break;for(;E.sibling===null;){if(E.return===null||E.return===h)return;E=E.return}E.sibling.return=E.return,E=E.sibling}};TW=function(){};O8=function(d,h,E,T){var A=d.memoizedProps;if(A!==T){d=h.stateNode,wS(Yh.current);var O=null;switch(E){case"input":A=GG(d,A),T=GG(d,T),O=[];break;case"select":A=js({},A,{value:void 0}),T=js({},T,{value:void 0}),O=[];break;case"textarea":A=KG(d,A),T=KG(d,T),O=[];break;default:typeof A.onClick!="function"&&typeof T.onClick=="function"&&(d.onclick=n1)}zG(E,T);var V;E=null;for(ne in A)if(!T.hasOwnProperty(ne)&&A.hasOwnProperty(ne)&&A[ne]!=null)if(ne==="style"){var X=A[ne];for(V in X)X.hasOwnProperty(V)&&(E||(E={}),E[V]="")}else ne!=="dangerouslySetInnerHTML"&&ne!=="children"&&ne!=="suppressContentEditableWarning"&&ne!=="suppressHydrationWarning"&&ne!=="autoFocus"&&(Y0.hasOwnProperty(ne)?O||(O=[]):(O=O||[]).push(ne,null));for(ne in T){var $=T[ne];if(X=A!=null?A[ne]:void 0,T.hasOwnProperty(ne)&&$!==X&&($!=null||X!=null))if(ne==="style")if(X){for(V in X)!X.hasOwnProperty(V)||$&&$.hasOwnProperty(V)||(E||(E={}),E[V]="");for(V in $)$.hasOwnProperty(V)&&X[V]!==$[V]&&(E||(E={}),E[V]=$[V])}else E||(O||(O=[]),O.push(ne,E)),E=$;else ne==="dangerouslySetInnerHTML"?($=$?$.__html:void 0,X=X?X.__html:void 0,$!=null&&X!==$&&(O=O||[]).push(ne,$)):ne==="children"?typeof $!="string"&&typeof $!="number"||(O=O||[]).push(ne,""+$):ne!=="suppressContentEditableWarning"&&ne!=="suppressHydrationWarning"&&(Y0.hasOwnProperty(ne)?($!=null&&ne==="onScroll"&&fs("scroll",d),O||X===$||(O=[])):(O=O||[]).push(ne,$))}E&&(O=O||[]).push("style",E);var ne=O;(h.updateQueue=ne)&&(h.flags|=4)}};N8=function(d,h,E,T){E!==T&&(h.flags|=4)};function w0(d,h){if(!bs)switch(d.tailMode){case"hidden":h=d.tail;for(var E=null;h!==null;)h.alternate!==null&&(E=h),h=h.sibling;E===null?d.tail=null:E.sibling=null;break;case"collapsed":E=d.tail;for(var T=null;E!==null;)E.alternate!==null&&(T=E),E=E.sibling;T===null?h||d.tail===null?d.tail=null:d.tail.sibling=null:T.sibling=null}}function za(d){var h=d.alternate!==null&&d.alternate.child===d.child,E=0,T=0;if(h)for(var A=d.child;A!==null;)E|=A.lanes|A.childLanes,T|=A.subtreeFlags&14680064,T|=A.flags&14680064,A.return=d,A=A.sibling;else for(A=d.child;A!==null;)E|=A.lanes|A.childLanes,T|=A.subtreeFlags,T|=A.flags,A.return=d,A=A.sibling;return d.subtreeFlags|=T,d.childLanes=E,h}function UJ(d,h,E){var T=h.pendingProps;switch(u4(h),h.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return za(h),null;case 1:return ud(h.type)&&i1(),za(h),null;case 3:return T=h.stateNode,Gv(),Es(ld),Es(Xa),T4(),T.pendingContext&&(T.context=T.pendingContext,T.pendingContext=null),(d===null||d.child===null)&&(vL(h)?h.flags|=4:d===null||d.memoizedState.isDehydrated&&!(h.flags&256)||(h.flags|=1024,Gu!==null&&(bW(Gu),Gu=null))),TW(d,h),za(h),null;case 5:S4(h);var A=wS(rO.current);if(E=h.type,d!==null&&h.stateNode!=null)O8(d,h,E,T,A),d.ref!==h.ref&&(h.flags|=512,h.flags|=2097152);else{if(!T){if(h.stateNode===null)throw Error(Pt(166));return za(h),null}if(d=wS(Yh.current),vL(h)){T=h.stateNode,E=h.type;var O=h.memoizedProps;switch(T[Hh]=h,T[nO]=O,d=(h.mode&1)!==0,E){case"dialog":fs("cancel",T),fs("close",T);break;case"iframe":case"object":case"embed":fs("load",T);break;case"video":case"audio":for(A=0;A<k0.length;A++)fs(k0[A],T);break;case"source":fs("error",T);break;case"img":case"image":case"link":fs("error",T),fs("load",T);break;case"details":fs("toggle",T);break;case"input":lH(T,O),fs("invalid",T);break;case"select":T._wrapperState={wasMultiple:!!O.multiple},fs("invalid",T);break;case"textarea":hH(T,O),fs("invalid",T)}zG(E,O),A=null;for(var V in O)if(O.hasOwnProperty(V)){var X=O[V];V==="children"?typeof X=="string"?T.textContent!==X&&(O.suppressHydrationWarning!==!0&&CL(T.textContent,X,d),A=["children",X]):typeof X=="number"&&T.textContent!==""+X&&(O.suppressHydrationWarning!==!0&&CL(T.textContent,X,d),A=["children",""+X]):Y0.hasOwnProperty(V)&&X!=null&&V==="onScroll"&&fs("scroll",T)}switch(E){case"input":pL(T),uH(T,O,!0);break;case"textarea":pL(T),pH(T);break;case"select":case"option":break;default:typeof O.onClick=="function"&&(T.onclick=n1)}T=A,h.updateQueue=T,T!==null&&(h.flags|=4)}else{V=A.nodeType===9?A:A.ownerDocument,d==="http://www.w3.org/1999/xhtml"&&(d=rK(E)),d==="http://www.w3.org/1999/xhtml"?E==="script"?(d=V.createElement("div"),d.innerHTML="<script><\/script>",d=d.removeChild(d.firstChild)):typeof T.is=="string"?d=V.createElement(E,{is:T.is}):(d=V.createElement(E),E==="select"&&(V=d,T.multiple?V.multiple=!0:T.size&&(V.size=T.size))):d=V.createElementNS(d,E),d[Hh]=h,d[nO]=T,b8(d,h,!1,!1),h.stateNode=d;e:{switch(V=qG(E,T),E){case"dialog":fs("cancel",d),fs("close",d),A=T;break;case"iframe":case"object":case"embed":fs("load",d),A=T;break;case"video":case"audio":for(A=0;A<k0.length;A++)fs(k0[A],d);A=T;break;case"source":fs("error",d),A=T;break;case"img":case"image":case"link":fs("error",d),fs("load",d),A=T;break;case"details":fs("toggle",d),A=T;break;case"input":lH(d,T),A=GG(d,T),fs("invalid",d);break;case"option":A=T;break;case"select":d._wrapperState={wasMultiple:!!T.multiple},A=js({},T,{value:void 0}),fs("invalid",d);break;case"textarea":hH(d,T),A=KG(d,T),fs("invalid",d);break;default:A=T}zG(E,A),X=A;for(O in X)if(X.hasOwnProperty(O)){var $=X[O];O==="style"?aK(d,$):O==="dangerouslySetInnerHTML"?($=$?$.__html:void 0,$!=null&&sK(d,$)):O==="children"?typeof $=="string"?(E!=="textarea"||$!=="")&&z0(d,$):typeof $=="number"&&z0(d,""+$):O!=="suppressContentEditableWarning"&&O!=="suppressHydrationWarning"&&O!=="autoFocus"&&(Y0.hasOwnProperty(O)?$!=null&&O==="onScroll"&&fs("scroll",d):$!=null&&XW(d,O,$,V))}switch(E){case"input":pL(d),uH(d,T,!1);break;case"textarea":pL(d),pH(d);break;case"option":T.value!=null&&d.setAttribute("value",""+S_(T.value));break;case"select":d.multiple=!!T.multiple,O=T.value,O!=null?Pv(d,!!T.multiple,O,!1):T.defaultValue!=null&&Pv(d,!!T.multiple,T.defaultValue,!0);break;default:typeof A.onClick=="function"&&(d.onclick=n1)}switch(E){case"button":case"input":case"select":case"textarea":T=!!T.autoFocus;break e;case"img":T=!0;break e;default:T=!1}}T&&(h.flags|=4)}h.ref!==null&&(h.flags|=512,h.flags|=2097152)}return za(h),null;case 6:if(d&&h.stateNode!=null)N8(d,h,d.memoizedProps,T);else{if(typeof T!="string"&&h.stateNode===null)throw Error(Pt(166));if(E=wS(rO.current),wS(Yh.current),vL(h)){if(T=h.stateNode,E=h.memoizedProps,T[Hh]=h,(O=T.nodeValue!==E)&&(d=Jd,d!==null))switch(d.tag){case 3:CL(T.nodeValue,E,(d.mode&1)!==0);break;case 5:d.memoizedProps.suppressHydrationWarning!==!0&&CL(T.nodeValue,E,(d.mode&1)!==0)}O&&(h.flags|=4)}else T=(E.nodeType===9?E:E.ownerDocument).createTextNode(T),T[Hh]=h,h.stateNode=T}return za(h),null;case 13:if(Es(Vs),T=h.memoizedState,d===null||d.memoizedState!==null&&d.memoizedState.dehydrated!==null){if(bs&&zd!==null&&h.mode&1&&!(h.flags&128))qK(),jv(),h.flags|=98560,O=!1;else if(O=vL(h),T!==null&&T.dehydrated!==null){if(d===null){if(!O)throw Error(Pt(318));if(O=h.memoizedState,O=O!==null?O.dehydrated:null,!O)throw Error(Pt(317));O[Hh]=h}else jv(),!(h.flags&128)&&(h.memoizedState=null),h.flags|=4;za(h),O=!1}else Gu!==null&&(bW(Gu),Gu=null),O=!0;if(!O)return h.flags&65536?h:null}return h.flags&128?(h.lanes=E,h):(T=T!==null,T!==(d!==null&&d.memoizedState!==null)&&T&&(h.child.flags|=8192,h.mode&1&&(d===null||Vs.current&1?Wo===0&&(Wo=3):P4())),h.updateQueue!==null&&(h.flags|=4),za(h),null);case 4:return Gv(),TW(d,h),d===null&&eO(h.stateNode.containerInfo),za(h),null;case 10:return f4(h.type._context),za(h),null;case 17:return ud(h.type)&&i1(),za(h),null;case 19:if(Es(Vs),O=h.memoizedState,O===null)return za(h),null;if(T=(h.flags&128)!==0,V=O.rendering,V===null)if(T)w0(O,!1);else{if(Wo!==0||d!==null&&d.flags&128)for(d=h.child;d!==null;){if(V=l1(d),V!==null){for(h.flags|=128,w0(O,!1),T=V.updateQueue,T!==null&&(h.updateQueue=T,h.flags|=4),h.subtreeFlags=0,T=E,E=h.child;E!==null;)O=E,d=T,O.flags&=14680066,V=O.alternate,V===null?(O.childLanes=0,O.lanes=d,O.child=null,O.subtreeFlags=0,O.memoizedProps=null,O.memoizedState=null,O.updateQueue=null,O.dependencies=null,O.stateNode=null):(O.childLanes=V.childLanes,O.lanes=V.lanes,O.child=V.child,O.subtreeFlags=0,O.deletions=null,O.memoizedProps=V.memoizedProps,O.memoizedState=V.memoizedState,O.updateQueue=V.updateQueue,O.type=V.type,d=V.dependencies,O.dependencies=d===null?null:{lanes:d.lanes,firstContext:d.firstContext}),E=E.sibling;return os(Vs,Vs.current&1|2),h.child}d=d.sibling}O.tail!==null&&ho()>Hv&&(h.flags|=128,T=!0,w0(O,!1),h.lanes=4194304)}else{if(!T)if(d=l1(V),d!==null){if(h.flags|=128,T=!0,E=d.updateQueue,E!==null&&(h.updateQueue=E,h.flags|=4),w0(O,!0),O.tail===null&&O.tailMode==="hidden"&&!V.alternate&&!bs)return za(h),null}else 2*ho()-O.renderingStartTime>Hv&&E!==1073741824&&(h.flags|=128,T=!0,w0(O,!1),h.lanes=4194304);O.isBackwards?(V.sibling=h.child,h.child=V):(E=O.last,E!==null?E.sibling=V:h.child=V,O.last=V)}return O.tail!==null?(h=O.tail,O.rendering=h,O.tail=h.sibling,O.renderingStartTime=ho(),h.sibling=null,E=Vs.current,os(Vs,T?E&1|2:E&1),h):(za(h),null);case 22:case 23:return D4(),T=h.memoizedState!==null,d!==null&&d.memoizedState!==null!==T&&(h.flags|=8192),T&&h.mode&1?Yd&1073741824&&(za(h),h.subtreeFlags&6&&(h.flags|=8192)):za(h),null;case 24:return null;case 25:return null}throw Error(Pt(156,h.tag))}function xJ(d,h){switch(u4(h),h.tag){case 1:return ud(h.type)&&i1(),d=h.flags,d&65536?(h.flags=d&-65537|128,h):null;case 3:return Gv(),Es(ld),Es(Xa),T4(),d=h.flags,d&65536&&!(d&128)?(h.flags=d&-65537|128,h):null;case 5:return S4(h),null;case 13:if(Es(Vs),d=h.memoizedState,d!==null&&d.dehydrated!==null){if(h.alternate===null)throw Error(Pt(340));jv()}return d=h.flags,d&65536?(h.flags=d&-65537|128,h):null;case 19:return Es(Vs),null;case 4:return Gv(),null;case 10:return f4(h.type._context),null;case 22:case 23:return D4(),null;case 24:return null;default:return null}}var IL=!1,qa=!1,VJ=typeof WeakSet=="function"?WeakSet:Set,en=null;function Nv(d,h){var E=d.ref;if(E!==null)if(typeof E=="function")try{E(null)}catch(T){Qs(d,h,T)}else E.current=null}function CW(d,h,E){try{E()}catch(T){Qs(d,h,T)}}var n6=!1;function FJ(d,h){if(rW=$L,d=MK(),d4(d)){if("selectionStart"in d)var E={start:d.selectionStart,end:d.selectionEnd};else e:{E=(E=d.ownerDocument)&&E.defaultView||window;var T=E.getSelection&&E.getSelection();if(T&&T.rangeCount!==0){E=T.anchorNode;var A=T.anchorOffset,O=T.focusNode;T=T.focusOffset;try{E.nodeType,O.nodeType}catch{E=null;break e}var V=0,X=-1,$=-1,ne=0,le=0,ae=d,ge=null;t:for(;;){for(var je;ae!==E||A!==0&&ae.nodeType!==3||(X=V+A),ae!==O||T!==0&&ae.nodeType!==3||($=V+T),ae.nodeType===3&&(V+=ae.nodeValue.length),(je=ae.firstChild)!==null;)ge=ae,ae=je;for(;;){if(ae===d)break t;if(ge===E&&++ne===A&&(X=V),ge===O&&++le===T&&($=V),(je=ae.nextSibling)!==null)break;ae=ge,ge=ae.parentNode}ae=je}E=X===-1||$===-1?null:{start:X,end:$}}else E=null}E=E||{start:0,end:0}}else E=null;for(sW={focusedElem:d,selectionRange:E},$L=!1,en=h;en!==null;)if(h=en,d=h.child,(h.subtreeFlags&1028)!==0&&d!==null)d.return=h,en=d;else for(;en!==null;){h=en;try{var Fe=h.alternate;if(h.flags&1024)switch(h.tag){case 0:case 11:case 15:break;case 1:if(Fe!==null){var we=Fe.memoizedProps,Ye=Fe.memoizedState,Se=h.stateNode,ue=Se.getSnapshotBeforeUpdate(h.elementType===h.type?we:ju(h.type,we),Ye);Se.__reactInternalSnapshotBeforeUpdate=ue}break;case 3:var ve=h.stateNode.containerInfo;ve.nodeType===1?ve.textContent="":ve.nodeType===9&&ve.documentElement&&ve.removeChild(ve.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(Pt(163))}}catch(tt){Qs(h,h.return,tt)}if(d=h.sibling,d!==null){d.return=h.return,en=d;break}en=h.return}return Fe=n6,n6=!1,Fe}function j0(d,h,E){var T=h.updateQueue;if(T=T!==null?T.lastEffect:null,T!==null){var A=T=T.next;do{if((A.tag&d)===d){var O=A.destroy;A.destroy=void 0,O!==void 0&&CW(h,E,O)}A=A.next}while(A!==T)}}function D1(d,h){if(h=h.updateQueue,h=h!==null?h.lastEffect:null,h!==null){var E=h=h.next;do{if((E.tag&d)===d){var T=E.create;E.destroy=T()}E=E.next}while(E!==h)}}function vW(d){var h=d.ref;if(h!==null){var E=d.stateNode;switch(d.tag){case 5:d=E;break;default:d=E}typeof h=="function"?h(d):h.current=d}}function D8(d){var h=d.alternate;h!==null&&(d.alternate=null,D8(h)),d.child=null,d.deletions=null,d.sibling=null,d.tag===5&&(h=d.stateNode,h!==null&&(delete h[Hh],delete h[nO],delete h[cW],delete h[CJ],delete h[vJ])),d.stateNode=null,d.return=null,d.dependencies=null,d.memoizedProps=null,d.memoizedState=null,d.pendingProps=null,d.stateNode=null,d.updateQueue=null}function P8(d){return d.tag===5||d.tag===3||d.tag===4}function i6(d){e:for(;;){for(;d.sibling===null;){if(d.return===null||P8(d.return))return null;d=d.return}for(d.sibling.return=d.return,d=d.sibling;d.tag!==5&&d.tag!==6&&d.tag!==18;){if(d.flags&2||d.child===null||d.tag===4)continue e;d.child.return=d,d=d.child}if(!(d.flags&2))return d.stateNode}}function RW(d,h,E){var T=d.tag;if(T===5||T===6)d=d.stateNode,h?E.nodeType===8?E.parentNode.insertBefore(d,h):E.insertBefore(d,h):(E.nodeType===8?(h=E.parentNode,h.insertBefore(d,E)):(h=E,h.appendChild(d)),E=E._reactRootContainer,E!=null||h.onclick!==null||(h.onclick=n1));else if(T!==4&&(d=d.child,d!==null))for(RW(d,h,E),d=d.sibling;d!==null;)RW(d,h,E),d=d.sibling}function yW(d,h,E){var T=d.tag;if(T===5||T===6)d=d.stateNode,h?E.insertBefore(d,h):E.appendChild(d);else if(T!==4&&(d=d.child,d!==null))for(yW(d,h,E),d=d.sibling;d!==null;)yW(d,h,E),d=d.sibling}var ba=null,Bu=!1;function t_(d,h,E){for(E=E.child;E!==null;)k8(d,h,E),E=E.sibling}function k8(d,h,E){if(Kh&&typeof Kh.onCommitFiberUnmount=="function")try{Kh.onCommitFiberUnmount(R1,E)}catch{}switch(E.tag){case 5:qa||Nv(E,h);case 6:var T=ba,A=Bu;ba=null,t_(d,h,E),ba=T,Bu=A,ba!==null&&(Bu?(d=ba,E=E.stateNode,d.nodeType===8?d.parentNode.removeChild(E):d.removeChild(E)):ba.removeChild(E.stateNode));break;case 18:ba!==null&&(Bu?(d=ba,E=E.stateNode,d.nodeType===8?vG(d.parentNode,E):d.nodeType===1&&vG(d,E),Q0(d)):vG(ba,E.stateNode));break;case 4:T=ba,A=Bu,ba=E.stateNode.containerInfo,Bu=!0,t_(d,h,E),ba=T,Bu=A;break;case 0:case 11:case 14:case 15:if(!qa&&(T=E.updateQueue,T!==null&&(T=T.lastEffect,T!==null))){A=T=T.next;do{var O=A,V=O.destroy;O=O.tag,V!==void 0&&(O&2||O&4)&&CW(E,h,V),A=A.next}while(A!==T)}t_(d,h,E);break;case 1:if(!qa&&(Nv(E,h),T=E.stateNode,typeof T.componentWillUnmount=="function"))try{T.props=E.memoizedProps,T.state=E.memoizedState,T.componentWillUnmount()}catch(X){Qs(E,h,X)}t_(d,h,E);break;case 21:t_(d,h,E);break;case 22:E.mode&1?(qa=(T=qa)||E.memoizedState!==null,t_(d,h,E),qa=T):t_(d,h,E);break;default:t_(d,h,E)}}function r6(d){var h=d.updateQueue;if(h!==null){d.updateQueue=null;var E=d.stateNode;E===null&&(E=d.stateNode=new VJ),h.forEach(function(T){var A=qJ.bind(null,d,T);E.has(T)||(E.add(T),T.then(A,A))})}}function Fu(d,h){var E=h.deletions;if(E!==null)for(var T=0;T<E.length;T++){var A=E[T];try{var O=d,V=h,X=V;e:for(;X!==null;){switch(X.tag){case 5:ba=X.stateNode,Bu=!1;break e;case 3:ba=X.stateNode.containerInfo,Bu=!0;break e;case 4:ba=X.stateNode.containerInfo,Bu=!0;break e}X=X.return}if(ba===null)throw Error(Pt(160));k8(O,V,A),ba=null,Bu=!1;var $=A.alternate;$!==null&&($.return=null),A.return=null}catch(ne){Qs(A,h,ne)}}if(h.subtreeFlags&12854)for(h=h.child;h!==null;)L8(h,d),h=h.sibling}function L8(d,h){var E=d.alternate,T=d.flags;switch(d.tag){case 0:case 11:case 14:case 15:if(Fu(h,d),Gh(d),T&4){try{j0(3,d,d.return),D1(3,d)}catch(we){Qs(d,d.return,we)}try{j0(5,d,d.return)}catch(we){Qs(d,d.return,we)}}break;case 1:Fu(h,d),Gh(d),T&512&&E!==null&&Nv(E,E.return);break;case 5:if(Fu(h,d),Gh(d),T&512&&E!==null&&Nv(E,E.return),d.flags&32){var A=d.stateNode;try{z0(A,"")}catch(we){Qs(d,d.return,we)}}if(T&4&&(A=d.stateNode,A!=null)){var O=d.memoizedProps,V=E!==null?E.memoizedProps:O,X=d.type,$=d.updateQueue;if(d.updateQueue=null,$!==null)try{X==="input"&&O.type==="radio"&&O.name!=null&&nK(A,O),qG(X,V);var ne=qG(X,O);for(V=0;V<$.length;V+=2){var le=$[V],ae=$[V+1];le==="style"?aK(A,ae):le==="dangerouslySetInnerHTML"?sK(A,ae):le==="children"?z0(A,ae):XW(A,le,ae,ne)}switch(X){case"input":WG(A,O);break;case"textarea":iK(A,O);break;case"select":var ge=A._wrapperState.wasMultiple;A._wrapperState.wasMultiple=!!O.multiple;var je=O.value;je!=null?Pv(A,!!O.multiple,je,!1):ge!==!!O.multiple&&(O.defaultValue!=null?Pv(A,!!O.multiple,O.defaultValue,!0):Pv(A,!!O.multiple,O.multiple?[]:"",!1))}A[nO]=O}catch(we){Qs(d,d.return,we)}}break;case 6:if(Fu(h,d),Gh(d),T&4){if(d.stateNode===null)throw Error(Pt(162));A=d.stateNode,O=d.memoizedProps;try{A.nodeValue=O}catch(we){Qs(d,d.return,we)}}break;case 3:if(Fu(h,d),Gh(d),T&4&&E!==null&&E.memoizedState.isDehydrated)try{Q0(h.containerInfo)}catch(we){Qs(d,d.return,we)}break;case 4:Fu(h,d),Gh(d);break;case 13:Fu(h,d),Gh(d),A=d.child,A.flags&8192&&(O=A.memoizedState!==null,A.stateNode.isHidden=O,!O||A.alternate!==null&&A.alternate.memoizedState!==null||(O4=ho())),T&4&&r6(d);break;case 22:if(le=E!==null&&E.memoizedState!==null,d.mode&1?(qa=(ne=qa)||le,Fu(h,d),qa=ne):Fu(h,d),Gh(d),T&8192){if(ne=d.memoizedState!==null,(d.stateNode.isHidden=ne)&&!le&&d.mode&1)for(en=d,le=d.child;le!==null;){for(ae=en=le;en!==null;){switch(ge=en,je=ge.child,ge.tag){case 0:case 11:case 14:case 15:j0(4,ge,ge.return);break;case 1:Nv(ge,ge.return);var Fe=ge.stateNode;if(typeof Fe.componentWillUnmount=="function"){T=ge,E=ge.return;try{h=T,Fe.props=h.memoizedProps,Fe.state=h.memoizedState,Fe.componentWillUnmount()}catch(we){Qs(T,E,we)}}break;case 5:Nv(ge,ge.return);break;case 22:if(ge.memoizedState!==null){o6(ae);continue}}je!==null?(je.return=ge,en=je):o6(ae)}le=le.sibling}e:for(le=null,ae=d;;){if(ae.tag===5){if(le===null){le=ae;try{A=ae.stateNode,ne?(O=A.style,typeof O.setProperty=="function"?O.setProperty("display","none","important"):O.display="none"):(X=ae.stateNode,$=ae.memoizedProps.style,V=$!=null&&$.hasOwnProperty("display")?$.display:null,X.style.display=oK("display",V))}catch(we){Qs(d,d.return,we)}}}else if(ae.tag===6){if(le===null)try{ae.stateNode.nodeValue=ne?"":ae.memoizedProps}catch(we){Qs(d,d.return,we)}}else if((ae.tag!==22&&ae.tag!==23||ae.memoizedState===null||ae===d)&&ae.child!==null){ae.child.return=ae,ae=ae.child;continue}if(ae===d)break e;for(;ae.sibling===null;){if(ae.return===null||ae.return===d)break e;le===ae&&(le=null),ae=ae.return}le===ae&&(le=null),ae.sibling.return=ae.return,ae=ae.sibling}}break;case 19:Fu(h,d),Gh(d),T&4&&r6(d);break;case 21:break;default:Fu(h,d),Gh(d)}}function Gh(d){var h=d.flags;if(h&2){try{e:{for(var E=d.return;E!==null;){if(P8(E)){var T=E;break e}E=E.return}throw Error(Pt(160))}switch(T.tag){case 5:var A=T.stateNode;T.flags&32&&(z0(A,""),T.flags&=-33);var O=i6(d);yW(d,O,A);break;case 3:case 4:var V=T.stateNode.containerInfo,X=i6(d);RW(d,X,V);break;default:throw Error(Pt(161))}}catch($){Qs(d,d.return,$)}d.flags&=-3}h&4096&&(d.flags&=-4097)}function jJ(d,h,E){en=d,M8(d)}function M8(d,h,E){for(var T=(d.mode&1)!==0;en!==null;){var A=en,O=A.child;if(A.tag===22&&T){var V=A.memoizedState!==null||IL;if(!V){var X=A.alternate,$=X!==null&&X.memoizedState!==null||qa;X=IL;var ne=qa;if(IL=V,(qa=$)&&!ne)for(en=A;en!==null;)V=en,$=V.child,V.tag===22&&V.memoizedState!==null?a6(A):$!==null?($.return=V,en=$):a6(A);for(;O!==null;)en=O,M8(O),O=O.sibling;en=A,IL=X,qa=ne}s6(d)}else A.subtreeFlags&8772&&O!==null?(O.return=A,en=O):s6(d)}}function s6(d){for(;en!==null;){var h=en;if(h.flags&8772){var E=h.alternate;try{if(h.flags&8772)switch(h.tag){case 0:case 11:case 15:qa||D1(5,h);break;case 1:var T=h.stateNode;if(h.flags&4&&!qa)if(E===null)T.componentDidMount();else{var A=h.elementType===h.type?E.memoizedProps:ju(h.type,E.memoizedProps);T.componentDidUpdate(A,E.memoizedState,T.__reactInternalSnapshotBeforeUpdate)}var O=h.updateQueue;O!==null&&WH(h,O,T);break;case 3:var V=h.updateQueue;if(V!==null){if(E=null,h.child!==null)switch(h.child.tag){case 5:E=h.child.stateNode;break;case 1:E=h.child.stateNode}WH(h,V,E)}break;case 5:var X=h.stateNode;if(E===null&&h.flags&4){E=X;var $=h.memoizedProps;switch(h.type){case"button":case"input":case"select":case"textarea":$.autoFocus&&E.focus();break;case"img":$.src&&(E.src=$.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(h.memoizedState===null){var ne=h.alternate;if(ne!==null){var le=ne.memoizedState;if(le!==null){var ae=le.dehydrated;ae!==null&&Q0(ae)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(Pt(163))}qa||h.flags&512&&vW(h)}catch(ge){Qs(h,h.return,ge)}}if(h===d){en=null;break}if(E=h.sibling,E!==null){E.return=h.return,en=E;break}en=h.return}}function o6(d){for(;en!==null;){var h=en;if(h===d){en=null;break}var E=h.sibling;if(E!==null){E.return=h.return,en=E;break}en=h.return}}function a6(d){for(;en!==null;){var h=en;try{switch(h.tag){case 0:case 11:case 15:var E=h.return;try{D1(4,h)}catch($){Qs(h,E,$)}break;case 1:var T=h.stateNode;if(typeof T.componentDidMount=="function"){var A=h.return;try{T.componentDidMount()}catch($){Qs(h,A,$)}}var O=h.return;try{vW(h)}catch($){Qs(h,O,$)}break;case 5:var V=h.return;try{vW(h)}catch($){Qs(h,V,$)}}}catch($){Qs(h,h.return,$)}if(h===d){en=null;break}var X=h.sibling;if(X!==null){X.return=h.return,en=X;break}en=h.return}}var BJ=Math.ceil,p1=Nm.ReactCurrentDispatcher,w4=Nm.ReactCurrentOwner,Pl=Nm.ReactCurrentBatchConfig,ir=0,ia=null,wo=null,Oa=0,Yd=0,Dv=v_(0),Wo=0,cO=null,LS=0,P1=0,b4=0,B0=null,cd=null,O4=0,Hv=1/0,Cm=null,m1=!1,IW=null,f_=null,AL=!1,a_=null,f1=0,G0=0,AW=null,GL=-1,WL=0;function Pc(){return ir&6?ho():GL!==-1?GL:GL=ho()}function __(d){return d.mode&1?ir&2&&Oa!==0?Oa&-Oa:yJ.transition!==null?(WL===0&&(WL=SK()),WL):(d=wr,d!==0||(d=window.event,d=d===void 0?16:AK(d.type)),d):1}function Hu(d,h,E,T){if(50<G0)throw G0=0,AW=null,Error(Pt(185));_O(d,E,T),(!(ir&2)||d!==ia)&&(d===ia&&(!(ir&2)&&(P1|=E),Wo===4&&s_(d,Oa)),hd(d,T),E===1&&ir===0&&!(h.mode&1)&&(Hv=ho()+500,b1&&R_()))}function hd(d,h){var E=d.callbackNode;yq(d,h);var T=ZL(d,d===ia?Oa:0);if(T===0)E!==null&&_H(E),d.callbackNode=null,d.callbackPriority=0;else if(h=T&-T,d.callbackPriority!==h){if(E!=null&&_H(E),h===1)d.tag===0?RJ(c6.bind(null,d)):KK(c6.bind(null,d)),SJ(function(){!(ir&6)&&R_()}),E=null;else{switch(TK(T)){case 1:E=t4;break;case 4:E=EK;break;case 16:E=QL;break;case 536870912:E=gK;break;default:E=QL}E=W8(E,U8.bind(null,d))}d.callbackPriority=h,d.callbackNode=E}}function U8(d,h){if(GL=-1,WL=0,ir&6)throw Error(Pt(327));var E=d.callbackNode;if(xv()&&d.callbackNode!==E)return null;var T=ZL(d,d===ia?Oa:0);if(T===0)return null;if(T&30||T&d.expiredLanes||h)h=_1(d,T);else{h=T;var A=ir;ir|=2;var O=V8();(ia!==d||Oa!==h)&&(Cm=null,Hv=ho()+500,bS(d,h));do try{HJ();break}catch(X){x8(d,X)}while(!0);m4(),p1.current=O,ir=A,wo!==null?h=0:(ia=null,Oa=0,h=Wo)}if(h!==0){if(h===2&&(A=$G(d),A!==0&&(T=A,h=wW(d,A))),h===1)throw E=cO,bS(d,0),s_(d,T),hd(d,ho()),E;if(h===6)s_(d,T);else{if(A=d.current.alternate,!(T&30)&&!GJ(A)&&(h=_1(d,T),h===2&&(O=$G(d),O!==0&&(T=O,h=wW(d,O))),h===1))throw E=cO,bS(d,0),s_(d,T),hd(d,ho()),E;switch(d.finishedWork=A,d.finishedLanes=T,h){case 0:case 1:throw Error(Pt(345));case 2:yS(d,cd,Cm);break;case 3:if(s_(d,T),(T&130023424)===T&&(h=O4+500-ho(),10<h)){if(ZL(d,0)!==0)break;if(A=d.suspendedLanes,(A&T)!==T){Pc(),d.pingedLanes|=d.suspendedLanes&A;break}d.timeoutHandle=aW(yS.bind(null,d,cd,Cm),h);break}yS(d,cd,Cm);break;case 4:if(s_(d,T),(T&4194240)===T)break;for(h=d.eventTimes,A=-1;0<T;){var V=31-Wu(T);O=1<<V,V=h[V],V>A&&(A=V),T&=~O}if(T=A,T=ho()-T,T=(120>T?120:480>T?480:1080>T?1080:1920>T?1920:3e3>T?3e3:4320>T?4320:1960*BJ(T/1960))-T,10<T){d.timeoutHandle=aW(yS.bind(null,d,cd,Cm),T);break}yS(d,cd,Cm);break;case 5:yS(d,cd,Cm);break;default:throw Error(Pt(329))}}}return hd(d,ho()),d.callbackNode===E?U8.bind(null,d):null}function wW(d,h){var E=B0;return d.current.memoizedState.isDehydrated&&(bS(d,h).flags|=256),d=_1(d,h),d!==2&&(h=cd,cd=E,h!==null&&bW(h)),d}function bW(d){cd===null?cd=d:cd.push.apply(cd,d)}function GJ(d){for(var h=d;;){if(h.flags&16384){var E=h.updateQueue;if(E!==null&&(E=E.stores,E!==null))for(var T=0;T<E.length;T++){var A=E[T],O=A.getSnapshot;A=A.value;try{if(!Ku(O(),A))return!1}catch{return!1}}}if(E=h.child,h.subtreeFlags&16384&&E!==null)E.return=h,h=E;else{if(h===d)break;for(;h.sibling===null;){if(h.return===null||h.return===d)return!0;h=h.return}h.sibling.return=h.return,h=h.sibling}}return!0}function s_(d,h){for(h&=~b4,h&=~P1,d.suspendedLanes|=h,d.pingedLanes&=~h,d=d.expirationTimes;0<h;){var E=31-Wu(h),T=1<<E;d[E]=-1,h&=~T}}function c6(d){if(ir&6)throw Error(Pt(327));xv();var h=ZL(d,0);if(!(h&1))return hd(d,ho()),null;var E=_1(d,h);if(d.tag!==0&&E===2){var T=$G(d);T!==0&&(h=T,E=wW(d,T))}if(E===1)throw E=cO,bS(d,0),s_(d,h),hd(d,ho()),E;if(E===6)throw Error(Pt(345));return d.finishedWork=d.current.alternate,d.finishedLanes=h,yS(d,cd,Cm),hd(d,ho()),null}function N4(d,h){var E=ir;ir|=1;try{return d(h)}finally{ir=E,ir===0&&(Hv=ho()+500,b1&&R_())}}function MS(d){a_!==null&&a_.tag===0&&!(ir&6)&&xv();var h=ir;ir|=1;var E=Pl.transition,T=wr;try{if(Pl.transition=null,wr=1,d)return d()}finally{wr=T,Pl.transition=E,ir=h,!(ir&6)&&R_()}}function D4(){Yd=Dv.current,Es(Dv)}function bS(d,h){d.finishedWork=null,d.finishedLanes=0;var E=d.timeoutHandle;if(E!==-1&&(d.timeoutHandle=-1,gJ(E)),wo!==null)for(E=wo.return;E!==null;){var T=E;switch(u4(T),T.tag){case 1:T=T.type.childContextTypes,T!=null&&i1();break;case 3:Gv(),Es(ld),Es(Xa),T4();break;case 5:S4(T);break;case 4:Gv();break;case 13:Es(Vs);break;case 19:Es(Vs);break;case 10:f4(T.type._context);break;case 22:case 23:D4()}E=E.return}if(ia=d,wo=d=E_(d.current,null),Oa=Yd=h,Wo=0,cO=null,b4=P1=LS=0,cd=B0=null,AS!==null){for(h=0;h<AS.length;h++)if(E=AS[h],T=E.interleaved,T!==null){E.interleaved=null;var A=T.next,O=E.pending;if(O!==null){var V=O.next;O.next=A,T.next=V}E.pending=T}AS=null}return d}function x8(d,h){do{var E=wo;try{if(m4(),FL.current=h1,u1){for(var T=Fs.memoizedState;T!==null;){var A=T.queue;A!==null&&(A.pending=null),T=T.next}u1=!1}if(kS=0,na=Go=Fs=null,F0=!1,sO=0,w4.current=null,E===null||E.return===null){Wo=1,cO=h,wo=null;break}e:{var O=d,V=E.return,X=E,$=h;if(h=Oa,X.flags|=32768,$!==null&&typeof $=="object"&&typeof $.then=="function"){var ne=$,le=X,ae=le.tag;if(!(le.mode&1)&&(ae===0||ae===11||ae===15)){var ge=le.alternate;ge?(le.updateQueue=ge.updateQueue,le.memoizedState=ge.memoizedState,le.lanes=ge.lanes):(le.updateQueue=null,le.memoizedState=null)}var je=JH(V);if(je!==null){je.flags&=-257,XH(je,V,X,O,h),je.mode&1&&qH(O,ne,h),h=je,$=ne;var Fe=h.updateQueue;if(Fe===null){var we=new Set;we.add($),h.updateQueue=we}else Fe.add($);break e}else{if(!(h&1)){qH(O,ne,h),P4();break e}$=Error(Pt(426))}}else if(bs&&X.mode&1){var Ye=JH(V);if(Ye!==null){!(Ye.flags&65536)&&(Ye.flags|=256),XH(Ye,V,X,O,h),h4(Wv($,X));break e}}O=$=Wv($,X),Wo!==4&&(Wo=2),B0===null?B0=[O]:B0.push(O),O=V;do{switch(O.tag){case 3:O.flags|=65536,h&=-h,O.lanes|=h;var Se=T8(O,$,h);GH(O,Se);break e;case 1:X=$;var ue=O.type,ve=O.stateNode;if(!(O.flags&128)&&(typeof ue.getDerivedStateFromError=="function"||ve!==null&&typeof ve.componentDidCatch=="function"&&(f_===null||!f_.has(ve)))){O.flags|=65536,h&=-h,O.lanes|=h;var tt=C8(O,X,h);GH(O,tt);break e}}O=O.return}while(O!==null)}j8(E)}catch(Rt){h=Rt,wo===E&&E!==null&&(wo=E=E.return);continue}break}while(!0)}function V8(){var d=p1.current;return p1.current=h1,d===null?h1:d}function P4(){(Wo===0||Wo===3||Wo===2)&&(Wo=4),ia===null||!(LS&268435455)&&!(P1&268435455)||s_(ia,Oa)}function _1(d,h){var E=ir;ir|=2;var T=V8();(ia!==d||Oa!==h)&&(Cm=null,bS(d,h));do try{WJ();break}catch(A){x8(d,A)}while(!0);if(m4(),ir=E,p1.current=T,wo!==null)throw Error(Pt(261));return ia=null,Oa=0,Wo}function WJ(){for(;wo!==null;)F8(wo)}function HJ(){for(;wo!==null&&!fq();)F8(wo)}function F8(d){var h=G8(d.alternate,d,Yd);d.memoizedProps=d.pendingProps,h===null?j8(d):wo=h,w4.current=null}function j8(d){var h=d;do{var E=h.alternate;if(d=h.return,h.flags&32768){if(E=xJ(E,h),E!==null){E.flags&=32767,wo=E;return}if(d!==null)d.flags|=32768,d.subtreeFlags=0,d.deletions=null;else{Wo=6,wo=null;return}}else if(E=UJ(E,h,Yd),E!==null){wo=E;return}if(h=h.sibling,h!==null){wo=h;return}wo=h=d}while(h!==null);Wo===0&&(Wo=5)}function yS(d,h,E){var T=wr,A=Pl.transition;try{Pl.transition=null,wr=1,KJ(d,h,E,T)}finally{Pl.transition=A,wr=T}return null}function KJ(d,h,E,T){do xv();while(a_!==null);if(ir&6)throw Error(Pt(327));E=d.finishedWork;var A=d.finishedLanes;if(E===null)return null;if(d.finishedWork=null,d.finishedLanes=0,E===d.current)throw Error(Pt(177));d.callbackNode=null,d.callbackPriority=0;var O=E.lanes|E.childLanes;if(Iq(d,O),d===ia&&(wo=ia=null,Oa=0),!(E.subtreeFlags&2064)&&!(E.flags&2064)||AL||(AL=!0,W8(QL,function(){return xv(),null})),O=(E.flags&15990)!==0,E.subtreeFlags&15990||O){O=Pl.transition,Pl.transition=null;var V=wr;wr=1;var X=ir;ir|=4,w4.current=null,FJ(d,E),L8(E,d),uJ(sW),$L=!!rW,sW=rW=null,d.current=E,jJ(E),_q(),ir=X,wr=V,Pl.transition=O}else d.current=E;if(AL&&(AL=!1,a_=d,f1=A),O=d.pendingLanes,O===0&&(f_=null),Sq(E.stateNode),hd(d,ho()),h!==null)for(T=d.onRecoverableError,E=0;E<h.length;E++)A=h[E],T(A.value,{componentStack:A.stack,digest:A.digest});if(m1)throw m1=!1,d=IW,IW=null,d;return f1&1&&d.tag!==0&&xv(),O=d.pendingLanes,O&1?d===AW?G0++:(G0=0,AW=d):G0=0,R_(),null}function xv(){if(a_!==null){var d=TK(f1),h=Pl.transition,E=wr;try{if(Pl.transition=null,wr=16>d?16:d,a_===null)var T=!1;else{if(d=a_,a_=null,f1=0,ir&6)throw Error(Pt(331));var A=ir;for(ir|=4,en=d.current;en!==null;){var O=en,V=O.child;if(en.flags&16){var X=O.deletions;if(X!==null){for(var $=0;$<X.length;$++){var ne=X[$];for(en=ne;en!==null;){var le=en;switch(le.tag){case 0:case 11:case 15:j0(8,le,O)}var ae=le.child;if(ae!==null)ae.return=le,en=ae;else for(;en!==null;){le=en;var ge=le.sibling,je=le.return;if(D8(le),le===ne){en=null;break}if(ge!==null){ge.return=je,en=ge;break}en=je}}}var Fe=O.alternate;if(Fe!==null){var we=Fe.child;if(we!==null){Fe.child=null;do{var Ye=we.sibling;we.sibling=null,we=Ye}while(we!==null)}}en=O}}if(O.subtreeFlags&2064&&V!==null)V.return=O,en=V;else e:for(;en!==null;){if(O=en,O.flags&2048)switch(O.tag){case 0:case 11:case 15:j0(9,O,O.return)}var Se=O.sibling;if(Se!==null){Se.return=O.return,en=Se;break e}en=O.return}}var ue=d.current;for(en=ue;en!==null;){V=en;var ve=V.child;if(V.subtreeFlags&2064&&ve!==null)ve.return=V,en=ve;else e:for(V=ue;en!==null;){if(X=en,X.flags&2048)try{switch(X.tag){case 0:case 11:case 15:D1(9,X)}}catch(Rt){Qs(X,X.return,Rt)}if(X===V){en=null;break e}var tt=X.sibling;if(tt!==null){tt.return=X.return,en=tt;break e}en=X.return}}if(ir=A,R_(),Kh&&typeof Kh.onPostCommitFiberRoot=="function")try{Kh.onPostCommitFiberRoot(R1,d)}catch{}T=!0}return T}finally{wr=E,Pl.transition=h}}return!1}function d6(d,h,E){h=Wv(E,h),h=T8(d,h,1),d=m_(d,h,1),h=Pc(),d!==null&&(_O(d,1,h),hd(d,h))}function Qs(d,h,E){if(d.tag===3)d6(d,d,E);else for(;h!==null;){if(h.tag===3){d6(h,d,E);break}else if(h.tag===1){var T=h.stateNode;if(typeof h.type.getDerivedStateFromError=="function"||typeof T.componentDidCatch=="function"&&(f_===null||!f_.has(T))){d=Wv(E,d),d=C8(h,d,1),h=m_(h,d,1),d=Pc(),h!==null&&(_O(h,1,d),hd(h,d));break}}h=h.return}}function YJ(d,h,E){var T=d.pingCache;T!==null&&T.delete(h),h=Pc(),d.pingedLanes|=d.suspendedLanes&E,ia===d&&(Oa&E)===E&&(Wo===4||Wo===3&&(Oa&130023424)===Oa&&500>ho()-O4?bS(d,0):b4|=E),hd(d,h)}function B8(d,h){h===0&&(d.mode&1?(h=_L,_L<<=1,!(_L&130023424)&&(_L=4194304)):h=1);var E=Pc();d=bm(d,h),d!==null&&(_O(d,h,E),hd(d,E))}function zJ(d){var h=d.memoizedState,E=0;h!==null&&(E=h.retryLane),B8(d,E)}function qJ(d,h){var E=0;switch(d.tag){case 13:var T=d.stateNode,A=d.memoizedState;A!==null&&(E=A.retryLane);break;case 19:T=d.stateNode;break;default:throw Error(Pt(314))}T!==null&&T.delete(h),B8(d,E)}var G8;G8=function(d,h,E){if(d!==null)if(d.memoizedProps!==h.pendingProps||ld.current)dd=!0;else{if(!(d.lanes&E)&&!(h.flags&128))return dd=!1,MJ(d,h,E);dd=!!(d.flags&131072)}else dd=!1,bs&&h.flags&1048576&&YK(h,o1,h.index);switch(h.lanes=0,h.tag){case 2:var T=h.type;BL(d,h),d=h.pendingProps;var A=Fv(h,Xa.current);Uv(h,E),A=v4(null,h,T,d,A,E);var O=R4();return h.flags|=1,typeof A=="object"&&A!==null&&typeof A.render=="function"&&A.$$typeof===void 0?(h.tag=1,h.memoizedState=null,h.updateQueue=null,ud(T)?(O=!0,r1(h)):O=!1,h.memoizedState=A.state!==null&&A.state!==void 0?A.state:null,E4(h),A.updater=N1,h.stateNode=A,A._reactInternals=h,mW(h,T,d,E),h=EW(null,h,T,!0,O,E)):(h.tag=0,bs&&O&&l4(h),Nc(null,h,A,E),h=h.child),h;case 16:T=h.elementType;e:{switch(BL(d,h),d=h.pendingProps,A=T._init,T=A(T._payload),h.type=T,A=h.tag=XJ(T),d=ju(T,d),A){case 0:h=_W(null,h,T,d,E);break e;case 1:h=$H(null,h,T,d,E);break e;case 11:h=QH(null,h,T,d,E);break e;case 14:h=ZH(null,h,T,ju(T.type,d),E);break e}throw Error(Pt(306,T,""))}return h;case 0:return T=h.type,A=h.pendingProps,A=h.elementType===T?A:ju(T,A),_W(d,h,T,A,E);case 1:return T=h.type,A=h.pendingProps,A=h.elementType===T?A:ju(T,A),$H(d,h,T,A,E);case 3:e:{if(I8(h),d===null)throw Error(Pt(387));T=h.pendingProps,O=h.memoizedState,A=O.element,ZK(d,h),d1(h,T,null,E);var V=h.memoizedState;if(T=V.element,O.isDehydrated)if(O={element:T,isDehydrated:!1,cache:V.cache,pendingSuspenseBoundaries:V.pendingSuspenseBoundaries,transitions:V.transitions},h.updateQueue.baseState=O,h.memoizedState=O,h.flags&256){A=Wv(Error(Pt(423)),h),h=e6(d,h,T,E,A);break e}else if(T!==A){A=Wv(Error(Pt(424)),h),h=e6(d,h,T,E,A);break e}else for(zd=p_(h.stateNode.containerInfo.firstChild),Jd=h,bs=!0,Gu=null,E=XK(h,null,T,E),h.child=E;E;)E.flags=E.flags&-3|4096,E=E.sibling;else{if(jv(),T===A){h=Om(d,h,E);break e}Nc(d,h,T,E)}h=h.child}return h;case 5:return $K(h),d===null&&uW(h),T=h.type,A=h.pendingProps,O=d!==null?d.memoizedProps:null,V=A.children,oW(T,A)?V=null:O!==null&&oW(T,O)&&(h.flags|=32),y8(d,h),Nc(d,h,V,E),h.child;case 6:return d===null&&uW(h),null;case 13:return A8(d,h,E);case 4:return g4(h,h.stateNode.containerInfo),T=h.pendingProps,d===null?h.child=Bv(h,null,T,E):Nc(d,h,T,E),h.child;case 11:return T=h.type,A=h.pendingProps,A=h.elementType===T?A:ju(T,A),QH(d,h,T,A,E);case 7:return Nc(d,h,h.pendingProps,E),h.child;case 8:return Nc(d,h,h.pendingProps.children,E),h.child;case 12:return Nc(d,h,h.pendingProps.children,E),h.child;case 10:e:{if(T=h.type._context,A=h.pendingProps,O=h.memoizedProps,V=A.value,os(a1,T._currentValue),T._currentValue=V,O!==null)if(Ku(O.value,V)){if(O.children===A.children&&!ld.current){h=Om(d,h,E);break e}}else for(O=h.child,O!==null&&(O.return=h);O!==null;){var X=O.dependencies;if(X!==null){V=O.child;for(var $=X.firstContext;$!==null;){if($.context===T){if(O.tag===1){$=Im(-1,E&-E),$.tag=2;var ne=O.updateQueue;if(ne!==null){ne=ne.shared;var le=ne.pending;le===null?$.next=$:($.next=le.next,le.next=$),ne.pending=$}}O.lanes|=E,$=O.alternate,$!==null&&($.lanes|=E),hW(O.return,E,h),X.lanes|=E;break}$=$.next}}else if(O.tag===10)V=O.type===h.type?null:O.child;else if(O.tag===18){if(V=O.return,V===null)throw Error(Pt(341));V.lanes|=E,X=V.alternate,X!==null&&(X.lanes|=E),hW(V,E,h),V=O.sibling}else V=O.child;if(V!==null)V.return=O;else for(V=O;V!==null;){if(V===h){V=null;break}if(O=V.sibling,O!==null){O.return=V.return,V=O;break}V=V.return}O=V}Nc(d,h,A.children,E),h=h.child}return h;case 9:return A=h.type,T=h.pendingProps.children,Uv(h,E),A=kl(A),T=T(A),h.flags|=1,Nc(d,h,T,E),h.child;case 14:return T=h.type,A=ju(T,h.pendingProps),A=ju(T.type,A),ZH(d,h,T,A,E);case 15:return v8(d,h,h.type,h.pendingProps,E);case 17:return T=h.type,A=h.pendingProps,A=h.elementType===T?A:ju(T,A),BL(d,h),h.tag=1,ud(T)?(d=!0,r1(h)):d=!1,Uv(h,E),S8(h,T,A),mW(h,T,A,E),EW(null,h,T,!0,d,E);case 19:return w8(d,h,E);case 22:return R8(d,h,E)}throw Error(Pt(156,h.tag))};function W8(d,h){return _K(d,h)}function JJ(d,h,E,T){this.tag=d,this.key=E,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=h,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=T,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Dl(d,h,E,T){return new JJ(d,h,E,T)}function k4(d){return d=d.prototype,!(!d||!d.isReactComponent)}function XJ(d){if(typeof d=="function")return k4(d)?1:0;if(d!=null){if(d=d.$$typeof,d===ZW)return 11;if(d===$W)return 14}return 2}function E_(d,h){var E=d.alternate;return E===null?(E=Dl(d.tag,h,d.key,d.mode),E.elementType=d.elementType,E.type=d.type,E.stateNode=d.stateNode,E.alternate=d,d.alternate=E):(E.pendingProps=h,E.type=d.type,E.flags=0,E.subtreeFlags=0,E.deletions=null),E.flags=d.flags&14680064,E.childLanes=d.childLanes,E.lanes=d.lanes,E.child=d.child,E.memoizedProps=d.memoizedProps,E.memoizedState=d.memoizedState,E.updateQueue=d.updateQueue,h=d.dependencies,E.dependencies=h===null?null:{lanes:h.lanes,firstContext:h.firstContext},E.sibling=d.sibling,E.index=d.index,E.ref=d.ref,E}function HL(d,h,E,T,A,O){var V=2;if(T=d,typeof d=="function")k4(d)&&(V=1);else if(typeof d=="string")V=5;else e:switch(d){case Cv:return OS(E.children,A,O,h);case QW:V=8,A|=8;break;case VG:return d=Dl(12,E,h,A|2),d.elementType=VG,d.lanes=O,d;case FG:return d=Dl(13,E,h,A),d.elementType=FG,d.lanes=O,d;case jG:return d=Dl(19,E,h,A),d.elementType=jG,d.lanes=O,d;case $6:return k1(E,A,O,h);default:if(typeof d=="object"&&d!==null)switch(d.$$typeof){case Q6:V=10;break e;case Z6:V=9;break e;case ZW:V=11;break e;case $W:V=14;break e;case n_:V=16,T=null;break e}throw Error(Pt(130,d==null?d:typeof d,""))}return h=Dl(V,E,h,A),h.elementType=d,h.type=T,h.lanes=O,h}function OS(d,h,E,T){return d=Dl(7,d,T,h),d.lanes=E,d}function k1(d,h,E,T){return d=Dl(22,d,T,h),d.elementType=$6,d.lanes=E,d.stateNode={isHidden:!1},d}function NG(d,h,E){return d=Dl(6,d,null,h),d.lanes=E,d}function DG(d,h,E){return h=Dl(4,d.children!==null?d.children:[],d.key,h),h.lanes=E,h.stateNode={containerInfo:d.containerInfo,pendingChildren:null,implementation:d.implementation},h}function QJ(d,h,E,T,A){this.tag=h,this.containerInfo=d,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=uG(0),this.expirationTimes=uG(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=uG(0),this.identifierPrefix=T,this.onRecoverableError=A,this.mutableSourceEagerHydrationData=null}function L4(d,h,E,T,A,O,V,X,$){return d=new QJ(d,h,E,X,$),h===1?(h=1,O===!0&&(h|=8)):h=0,O=Dl(3,null,null,h),d.current=O,O.stateNode=d,O.memoizedState={element:T,isDehydrated:E,cache:null,transitions:null,pendingSuspenseBoundaries:null},E4(O),d}function ZJ(d,h,E){var T=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Tv,key:T==null?null:""+T,children:d,containerInfo:h,implementation:E}}function H8(d){if(!d)return T_;d=d._reactInternals;e:{if(VS(d)!==d||d.tag!==1)throw Error(Pt(170));var h=d;do{switch(h.tag){case 3:h=h.stateNode.context;break e;case 1:if(ud(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break e}}h=h.return}while(h!==null);throw Error(Pt(171))}if(d.tag===1){var E=d.type;if(ud(E))return HK(d,E,h)}return h}function K8(d,h,E,T,A,O,V,X,$){return d=L4(E,T,!0,d,A,O,V,X,$),d.context=H8(null),E=d.current,T=Pc(),A=__(E),O=Im(T,A),O.callback=h??null,m_(E,O,A),d.current.lanes=A,_O(d,A,T),hd(d,T),d}function L1(d,h,E,T){var A=h.current,O=Pc(),V=__(A);return E=H8(E),h.context===null?h.context=E:h.pendingContext=E,h=Im(O,V),h.payload={element:d},T=T===void 0?null:T,T!==null&&(h.callback=T),d=m_(A,h,V),d!==null&&(Hu(d,A,V,O),VL(d,A,V)),V}function E1(d){if(d=d.current,!d.child)return null;switch(d.child.tag){case 5:return d.child.stateNode;default:return d.child.stateNode}}function l6(d,h){if(d=d.memoizedState,d!==null&&d.dehydrated!==null){var E=d.retryLane;d.retryLane=E!==0&&E<h?E:h}}function M4(d,h){l6(d,h),(d=d.alternate)&&l6(d,h)}function $J(){return null}var Y8=typeof reportError=="function"?reportError:function(d){console.error(d)};function U4(d){this._internalRoot=d}M1.prototype.render=U4.prototype.render=function(d){var h=this._internalRoot;if(h===null)throw Error(Pt(409));L1(d,h,null,null)};M1.prototype.unmount=U4.prototype.unmount=function(){var d=this._internalRoot;if(d!==null){this._internalRoot=null;var h=d.containerInfo;MS(function(){L1(null,d,null,null)}),h[wm]=null}};function M1(d){this._internalRoot=d}M1.prototype.unstable_scheduleHydration=function(d){if(d){var h=RK();d={blockedOn:null,target:d,priority:h};for(var E=0;E<r_.length&&h!==0&&h<r_[E].priority;E++);r_.splice(E,0,d),E===0&&IK(d)}};function x4(d){return!(!d||d.nodeType!==1&&d.nodeType!==9&&d.nodeType!==11)}function U1(d){return!(!d||d.nodeType!==1&&d.nodeType!==9&&d.nodeType!==11&&(d.nodeType!==8||d.nodeValue!==" react-mount-point-unstable "))}function u6(){}function e7(d,h,E,T,A){if(A){if(typeof T=="function"){var O=T;T=function(){var ne=E1(V);O.call(ne)}}var V=K8(h,T,d,0,null,!1,!1,"",u6);return d._reactRootContainer=V,d[wm]=V.current,eO(d.nodeType===8?d.parentNode:d),MS(),V}for(;A=d.lastChild;)d.removeChild(A);if(typeof T=="function"){var X=T;T=function(){var ne=E1($);X.call(ne)}}var $=L4(d,0,!1,null,null,!1,!1,"",u6);return d._reactRootContainer=$,d[wm]=$.current,eO(d.nodeType===8?d.parentNode:d),MS(function(){L1(h,$,E,T)}),$}function x1(d,h,E,T,A){var O=E._reactRootContainer;if(O){var V=O;if(typeof A=="function"){var X=A;A=function(){var $=E1(V);X.call($)}}L1(h,V,d,A)}else V=e7(E,h,d,A,T);return E1(V)}CK=function(d){switch(d.tag){case 3:var h=d.stateNode;if(h.current.memoizedState.isDehydrated){var E=P0(h.pendingLanes);E!==0&&(n4(h,E|1),hd(h,ho()),!(ir&6)&&(Hv=ho()+500,R_()))}break;case 13:MS(function(){var T=bm(d,1);if(T!==null){var A=Pc();Hu(T,d,1,A)}}),M4(d,1)}};i4=function(d){if(d.tag===13){var h=bm(d,134217728);if(h!==null){var E=Pc();Hu(h,d,134217728,E)}M4(d,134217728)}};vK=function(d){if(d.tag===13){var h=__(d),E=bm(d,h);if(E!==null){var T=Pc();Hu(E,d,h,T)}M4(d,h)}};RK=function(){return wr};yK=function(d,h){var E=wr;try{return wr=d,h()}finally{wr=E}};XG=function(d,h,E){switch(h){case"input":if(WG(d,E),h=E.name,E.type==="radio"&&h!=null){for(E=d;E.parentNode;)E=E.parentNode;for(E=E.querySelectorAll("input[name="+JSON.stringify(""+h)+'][type="radio"]'),h=0;h<E.length;h++){var T=E[h];if(T!==d&&T.form===d.form){var A=w1(T);if(!A)throw Error(Pt(90));tK(T),WG(T,A)}}}break;case"textarea":iK(d,E);break;case"select":h=E.value,h!=null&&Pv(d,!!E.multiple,h,!1)}};lK=N4;uK=MS;var t7={usingClientEntryPoint:!1,Events:[gO,Iv,w1,cK,dK,N4]},b0={findFiberByHostInstance:IS,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},n7={bundleType:b0.bundleType,version:b0.version,rendererPackageName:b0.rendererPackageName,rendererConfig:b0.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Nm.ReactCurrentDispatcher,findHostInstanceByFiber:function(d){return d=mK(d),d===null?null:d.stateNode},findFiberByHostInstance:b0.findFiberByHostInstance||$J,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var wL=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!wL.isDisabled&&wL.supportsFiber)try{R1=wL.inject(n7),Kh=wL}catch{}}Qd.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=t7;Qd.createPortal=function(d,h){var E=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!x4(h))throw Error(Pt(200));return ZJ(d,h,null,E)};Qd.createRoot=function(d,h){if(!x4(d))throw Error(Pt(299));var E=!1,T="",A=Y8;return h!=null&&(h.unstable_strictMode===!0&&(E=!0),h.identifierPrefix!==void 0&&(T=h.identifierPrefix),h.onRecoverableError!==void 0&&(A=h.onRecoverableError)),h=L4(d,1,!1,null,null,E,!1,T,A),d[wm]=h.current,eO(d.nodeType===8?d.parentNode:d),new U4(h)};Qd.findDOMNode=function(d){if(d==null)return null;if(d.nodeType===1)return d;var h=d._reactInternals;if(h===void 0)throw typeof d.render=="function"?Error(Pt(188)):(d=Object.keys(d).join(","),Error(Pt(268,d)));return d=mK(h),d=d===null?null:d.stateNode,d};Qd.flushSync=function(d){return MS(d)};Qd.hydrate=function(d,h,E){if(!U1(h))throw Error(Pt(200));return x1(null,d,h,!0,E)};Qd.hydrateRoot=function(d,h,E){if(!x4(d))throw Error(Pt(405));var T=E!=null&&E.hydratedSources||null,A=!1,O="",V=Y8;if(E!=null&&(E.unstable_strictMode===!0&&(A=!0),E.identifierPrefix!==void 0&&(O=E.identifierPrefix),E.onRecoverableError!==void 0&&(V=E.onRecoverableError)),h=K8(h,null,d,1,E??null,A,!1,O,V),d[wm]=h.current,eO(d),T)for(d=0;d<T.length;d++)E=T[d],A=E._getVersion,A=A(E._source),h.mutableSourceEagerHydrationData==null?h.mutableSourceEagerHydrationData=[E,A]:h.mutableSourceEagerHydrationData.push(E,A);return new M1(h)};Qd.render=function(d,h,E){if(!U1(h))throw Error(Pt(200));return x1(null,d,h,!1,E)};Qd.unmountComponentAtNode=function(d){if(!U1(d))throw Error(Pt(40));return d._reactRootContainer?(MS(function(){x1(null,null,d,!1,function(){d._reactRootContainer=null,d[wm]=null})}),!0):!1};Qd.unstable_batchedUpdates=N4;Qd.unstable_renderSubtreeIntoContainer=function(d,h,E,T){if(!U1(E))throw Error(Pt(200));if(d==null||d._reactInternals===void 0)throw Error(Pt(38));return x1(d,h,E,!1,T)};Qd.version="18.3.1-next-f1338f8080-20240426";function z8(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(z8)}catch(d){console.error(d)}}z8(),z6.exports=Qd;var i7=z6.exports,h6=i7;UG.createRoot=h6.createRoot,UG.hydrateRoot=h6.hydrateRoot;/**
 * @remix-run/router v1.16.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function dO(){return dO=Object.assign?Object.assign.bind():function(d){for(var h=1;h<arguments.length;h++){var E=arguments[h];for(var T in E)Object.prototype.hasOwnProperty.call(E,T)&&(d[T]=E[T])}return d},dO.apply(this,arguments)}var c_;(function(d){d.Pop="POP",d.Push="PUSH",d.Replace="REPLACE"})(c_||(c_={}));const p6="popstate";function r7(d){d===void 0&&(d={});function h(T,A){let{pathname:O,search:V,hash:X}=T.location;return OW("",{pathname:O,search:V,hash:X},A.state&&A.state.usr||null,A.state&&A.state.key||"default")}function E(T,A){return typeof A=="string"?A:g1(A)}return o7(h,E,null,d)}function bo(d,h){if(d===!1||d===null||typeof d>"u")throw new Error(h)}function q8(d,h){if(!d){typeof console<"u"&&console.warn(h);try{throw new Error(h)}catch{}}}function s7(){return Math.random().toString(36).substr(2,8)}function m6(d,h){return{usr:d.state,key:d.key,idx:h}}function OW(d,h,E,T){return E===void 0&&(E=null),dO({pathname:typeof d=="string"?d:d.pathname,search:"",hash:""},typeof h=="string"?qv(h):h,{state:E,key:h&&h.key||T||s7()})}function g1(d){let{pathname:h="/",search:E="",hash:T=""}=d;return E&&E!=="?"&&(h+=E.charAt(0)==="?"?E:"?"+E),T&&T!=="#"&&(h+=T.charAt(0)==="#"?T:"#"+T),h}function qv(d){let h={};if(d){let E=d.indexOf("#");E>=0&&(h.hash=d.substr(E),d=d.substr(0,E));let T=d.indexOf("?");T>=0&&(h.search=d.substr(T),d=d.substr(0,T)),d&&(h.pathname=d)}return h}function o7(d,h,E,T){T===void 0&&(T={});let{window:A=document.defaultView,v5Compat:O=!1}=T,V=A.history,X=c_.Pop,$=null,ne=le();ne==null&&(ne=0,V.replaceState(dO({},V.state,{idx:ne}),""));function le(){return(V.state||{idx:null}).idx}function ae(){X=c_.Pop;let Ye=le(),Se=Ye==null?null:Ye-ne;ne=Ye,$&&$({action:X,location:we.location,delta:Se})}function ge(Ye,Se){X=c_.Push;let ue=OW(we.location,Ye,Se);ne=le()+1;let ve=m6(ue,ne),tt=we.createHref(ue);try{V.pushState(ve,"",tt)}catch(Rt){if(Rt instanceof DOMException&&Rt.name==="DataCloneError")throw Rt;A.location.assign(tt)}O&&$&&$({action:X,location:we.location,delta:1})}function je(Ye,Se){X=c_.Replace;let ue=OW(we.location,Ye,Se);ne=le();let ve=m6(ue,ne),tt=we.createHref(ue);V.replaceState(ve,"",tt),O&&$&&$({action:X,location:we.location,delta:0})}function Fe(Ye){let Se=A.location.origin!=="null"?A.location.origin:A.location.href,ue=typeof Ye=="string"?Ye:g1(Ye);return ue=ue.replace(/ $/,"%20"),bo(Se,"No window.location.(origin|href) available to create URL for href: "+ue),new URL(ue,Se)}let we={get action(){return X},get location(){return d(A,V)},listen(Ye){if($)throw new Error("A history only accepts one active listener");return A.addEventListener(p6,ae),$=Ye,()=>{A.removeEventListener(p6,ae),$=null}},createHref(Ye){return h(A,Ye)},createURL:Fe,encodeLocation(Ye){let Se=Fe(Ye);return{pathname:Se.pathname,search:Se.search,hash:Se.hash}},push:ge,replace:je,go(Ye){return V.go(Ye)}};return we}var f6;(function(d){d.data="data",d.deferred="deferred",d.redirect="redirect",d.error="error"})(f6||(f6={}));function a7(d,h,E){E===void 0&&(E="/");let T=typeof h=="string"?qv(h):h,A=V4(T.pathname||"/",E);if(A==null)return null;let O=J8(d);c7(O);let V=null;for(let X=0;V==null&&X<O.length;++X){let $=T7(A);V=E7(O[X],$)}return V}function J8(d,h,E,T){h===void 0&&(h=[]),E===void 0&&(E=[]),T===void 0&&(T="");let A=(O,V,X)=>{let $={relativePath:X===void 0?O.path||"":X,caseSensitive:O.caseSensitive===!0,childrenIndex:V,route:O};$.relativePath.startsWith("/")&&(bo($.relativePath.startsWith(T),'Absolute route path "'+$.relativePath+'" nested under path '+('"'+T+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),$.relativePath=$.relativePath.slice(T.length));let ne=g_([T,$.relativePath]),le=E.concat($);O.children&&O.children.length>0&&(bo(O.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+ne+'".')),J8(O.children,h,le,ne)),!(O.path==null&&!O.index)&&h.push({path:ne,score:f7(ne,O.index),routesMeta:le})};return d.forEach((O,V)=>{var X;if(O.path===""||!((X=O.path)!=null&&X.includes("?")))A(O,V);else for(let $ of X8(O.path))A(O,V,$)}),h}function X8(d){let h=d.split("/");if(h.length===0)return[];let[E,...T]=h,A=E.endsWith("?"),O=E.replace(/\?$/,"");if(T.length===0)return A?[O,""]:[O];let V=X8(T.join("/")),X=[];return X.push(...V.map($=>$===""?O:[O,$].join("/"))),A&&X.push(...V),X.map($=>d.startsWith("/")&&$===""?"/":$)}function c7(d){d.sort((h,E)=>h.score!==E.score?E.score-h.score:_7(h.routesMeta.map(T=>T.childrenIndex),E.routesMeta.map(T=>T.childrenIndex)))}const d7=/^:[\w-]+$/,l7=3,u7=2,h7=1,p7=10,m7=-2,_6=d=>d==="*";function f7(d,h){let E=d.split("/"),T=E.length;return E.some(_6)&&(T+=m7),h&&(T+=u7),E.filter(A=>!_6(A)).reduce((A,O)=>A+(d7.test(O)?l7:O===""?h7:p7),T)}function _7(d,h){return d.length===h.length&&d.slice(0,-1).every((T,A)=>T===h[A])?d[d.length-1]-h[h.length-1]:0}function E7(d,h){let{routesMeta:E}=d,T={},A="/",O=[];for(let V=0;V<E.length;++V){let X=E[V],$=V===E.length-1,ne=A==="/"?h:h.slice(A.length)||"/",le=g7({path:X.relativePath,caseSensitive:X.caseSensitive,end:$},ne);if(!le)return null;Object.assign(T,le.params);let ae=X.route;O.push({params:T,pathname:g_([A,le.pathname]),pathnameBase:y7(g_([A,le.pathnameBase])),route:ae}),le.pathnameBase!=="/"&&(A=g_([A,le.pathnameBase]))}return O}function g7(d,h){typeof d=="string"&&(d={path:d,caseSensitive:!1,end:!0});let[E,T]=S7(d.path,d.caseSensitive,d.end),A=h.match(E);if(!A)return null;let O=A[0],V=O.replace(/(.)\/+$/,"$1"),X=A.slice(1);return{params:T.reduce((ne,le,ae)=>{let{paramName:ge,isOptional:je}=le;if(ge==="*"){let we=X[ae]||"";V=O.slice(0,O.length-we.length).replace(/(.)\/+$/,"$1")}const Fe=X[ae];return je&&!Fe?ne[ge]=void 0:ne[ge]=(Fe||"").replace(/%2F/g,"/"),ne},{}),pathname:O,pathnameBase:V,pattern:d}}function S7(d,h,E){h===void 0&&(h=!1),E===void 0&&(E=!0),q8(d==="*"||!d.endsWith("*")||d.endsWith("/*"),'Route path "'+d+'" will be treated as if it were '+('"'+d.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+d.replace(/\*$/,"/*")+'".'));let T=[],A="^"+d.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(V,X,$)=>(T.push({paramName:X,isOptional:$!=null}),$?"/?([^\\/]+)?":"/([^\\/]+)"));return d.endsWith("*")?(T.push({paramName:"*"}),A+=d==="*"||d==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):E?A+="\\/*$":d!==""&&d!=="/"&&(A+="(?:(?=\\/|$))"),[new RegExp(A,h?void 0:"i"),T]}function T7(d){try{return d.split("/").map(h=>decodeURIComponent(h).replace(/\//g,"%2F")).join("/")}catch(h){return q8(!1,'The URL path "'+d+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+h+").")),d}}function V4(d,h){if(h==="/")return d;if(!d.toLowerCase().startsWith(h.toLowerCase()))return null;let E=h.endsWith("/")?h.length-1:h.length,T=d.charAt(E);return T&&T!=="/"?null:d.slice(E)||"/"}function C7(d,h){h===void 0&&(h="/");let{pathname:E,search:T="",hash:A=""}=typeof d=="string"?qv(d):d;return{pathname:E?E.startsWith("/")?E:v7(E,h):h,search:I7(T),hash:A7(A)}}function v7(d,h){let E=h.replace(/\/+$/,"").split("/");return d.split("/").forEach(A=>{A===".."?E.length>1&&E.pop():A!=="."&&E.push(A)}),E.length>1?E.join("/"):"/"}function PG(d,h,E,T){return"Cannot include a '"+d+"' character in a manually specified "+("`to."+h+"` field ["+JSON.stringify(T)+"].  Please separate it out to the ")+("`to."+E+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function R7(d){return d.filter((h,E)=>E===0||h.route.path&&h.route.path.length>0)}function Q8(d,h){let E=R7(d);return h?E.map((T,A)=>A===d.length-1?T.pathname:T.pathnameBase):E.map(T=>T.pathnameBase)}function Z8(d,h,E,T){T===void 0&&(T=!1);let A;typeof d=="string"?A=qv(d):(A=dO({},d),bo(!A.pathname||!A.pathname.includes("?"),PG("?","pathname","search",A)),bo(!A.pathname||!A.pathname.includes("#"),PG("#","pathname","hash",A)),bo(!A.search||!A.search.includes("#"),PG("#","search","hash",A)));let O=d===""||A.pathname==="",V=O?"/":A.pathname,X;if(V==null)X=E;else{let ae=h.length-1;if(!T&&V.startsWith("..")){let ge=V.split("/");for(;ge[0]==="..";)ge.shift(),ae-=1;A.pathname=ge.join("/")}X=ae>=0?h[ae]:"/"}let $=C7(A,X),ne=V&&V!=="/"&&V.endsWith("/"),le=(O||V===".")&&E.endsWith("/");return!$.pathname.endsWith("/")&&(ne||le)&&($.pathname+="/"),$}const g_=d=>d.join("/").replace(/\/\/+/g,"/"),y7=d=>d.replace(/\/+$/,"").replace(/^\/*/,"/"),I7=d=>!d||d==="?"?"":d.startsWith("?")?d:"?"+d,A7=d=>!d||d==="#"?"":d.startsWith("#")?d:"#"+d;function w7(d){return d!=null&&typeof d.status=="number"&&typeof d.statusText=="string"&&typeof d.internal=="boolean"&&"data"in d}const $8=["post","put","patch","delete"];new Set($8);const b7=["get",...$8];new Set(b7);/**
 * React Router v6.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function lO(){return lO=Object.assign?Object.assign.bind():function(d){for(var h=1;h<arguments.length;h++){var E=arguments[h];for(var T in E)Object.prototype.hasOwnProperty.call(E,T)&&(d[T]=E[T])}return d},lO.apply(this,arguments)}const F4=Oe.createContext(null),O7=Oe.createContext(null),FS=Oe.createContext(null),V1=Oe.createContext(null),y_=Oe.createContext({outlet:null,matches:[],isDataRoute:!1}),eY=Oe.createContext(null);function N7(d,h){let{relative:E}=h===void 0?{}:h;TO()||bo(!1);let{basename:T,navigator:A}=Oe.useContext(FS),{hash:O,pathname:V,search:X}=nY(d,{relative:E}),$=V;return T!=="/"&&($=V==="/"?T:g_([T,V])),A.createHref({pathname:$,search:X,hash:O})}function TO(){return Oe.useContext(V1)!=null}function CO(){return TO()||bo(!1),Oe.useContext(V1).location}function tY(d){Oe.useContext(FS).static||Oe.useLayoutEffect(d)}function Zs(){let{isDataRoute:d}=Oe.useContext(y_);return d?W7():D7()}function D7(){TO()||bo(!1);let d=Oe.useContext(F4),{basename:h,future:E,navigator:T}=Oe.useContext(FS),{matches:A}=Oe.useContext(y_),{pathname:O}=CO(),V=JSON.stringify(Q8(A,E.v7_relativeSplatPath)),X=Oe.useRef(!1);return tY(()=>{X.current=!0}),Oe.useCallback(function(ne,le){if(le===void 0&&(le={}),!X.current)return;if(typeof ne=="number"){T.go(ne);return}let ae=Z8(ne,JSON.parse(V),O,le.relative==="path");d==null&&h!=="/"&&(ae.pathname=ae.pathname==="/"?h:g_([h,ae.pathname])),(le.replace?T.replace:T.push)(ae,le.state,le)},[h,T,V,O,d])}function j4(){let{matches:d}=Oe.useContext(y_),h=d[d.length-1];return h?h.params:{}}function nY(d,h){let{relative:E}=h===void 0?{}:h,{future:T}=Oe.useContext(FS),{matches:A}=Oe.useContext(y_),{pathname:O}=CO(),V=JSON.stringify(Q8(A,T.v7_relativeSplatPath));return Oe.useMemo(()=>Z8(d,JSON.parse(V),O,E==="path"),[d,V,O,E])}function P7(d,h){return k7(d,h)}function k7(d,h,E,T){TO()||bo(!1);let{navigator:A}=Oe.useContext(FS),{matches:O}=Oe.useContext(y_),V=O[O.length-1],X=V?V.params:{};V&&V.pathname;let $=V?V.pathnameBase:"/";V&&V.route;let ne=CO(),le;if(h){var ae;let Ye=typeof h=="string"?qv(h):h;$==="/"||(ae=Ye.pathname)!=null&&ae.startsWith($)||bo(!1),le=Ye}else le=ne;let ge=le.pathname||"/",je=ge;if($!=="/"){let Ye=$.replace(/^\//,"").split("/");je="/"+ge.replace(/^\//,"").split("/").slice(Ye.length).join("/")}let Fe=a7(d,{pathname:je}),we=V7(Fe&&Fe.map(Ye=>Object.assign({},Ye,{params:Object.assign({},X,Ye.params),pathname:g_([$,A.encodeLocation?A.encodeLocation(Ye.pathname).pathname:Ye.pathname]),pathnameBase:Ye.pathnameBase==="/"?$:g_([$,A.encodeLocation?A.encodeLocation(Ye.pathnameBase).pathname:Ye.pathnameBase])})),O,E,T);return h&&we?Oe.createElement(V1.Provider,{value:{location:lO({pathname:"/",search:"",hash:"",state:null,key:"default"},le),navigationType:c_.Pop}},we):we}function L7(){let d=G7(),h=w7(d)?d.status+" "+d.statusText:d instanceof Error?d.message:JSON.stringify(d),E=d instanceof Error?d.stack:null,A={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return Oe.createElement(Oe.Fragment,null,Oe.createElement("h2",null,"Unexpected Application Error!"),Oe.createElement("h3",{style:{fontStyle:"italic"}},h),E?Oe.createElement("pre",{style:A},E):null,null)}const M7=Oe.createElement(L7,null);class U7 extends Oe.Component{constructor(h){super(h),this.state={location:h.location,revalidation:h.revalidation,error:h.error}}static getDerivedStateFromError(h){return{error:h}}static getDerivedStateFromProps(h,E){return E.location!==h.location||E.revalidation!=="idle"&&h.revalidation==="idle"?{error:h.error,location:h.location,revalidation:h.revalidation}:{error:h.error!==void 0?h.error:E.error,location:E.location,revalidation:h.revalidation||E.revalidation}}componentDidCatch(h,E){console.error("React Router caught the following error during render",h,E)}render(){return this.state.error!==void 0?Oe.createElement(y_.Provider,{value:this.props.routeContext},Oe.createElement(eY.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function x7(d){let{routeContext:h,match:E,children:T}=d,A=Oe.useContext(F4);return A&&A.static&&A.staticContext&&(E.route.errorElement||E.route.ErrorBoundary)&&(A.staticContext._deepestRenderedBoundaryId=E.route.id),Oe.createElement(y_.Provider,{value:h},T)}function V7(d,h,E,T){var A;if(h===void 0&&(h=[]),E===void 0&&(E=null),T===void 0&&(T=null),d==null){var O;if((O=E)!=null&&O.errors)d=E.matches;else return null}let V=d,X=(A=E)==null?void 0:A.errors;if(X!=null){let le=V.findIndex(ae=>ae.route.id&&(X==null?void 0:X[ae.route.id])!==void 0);le>=0||bo(!1),V=V.slice(0,Math.min(V.length,le+1))}let $=!1,ne=-1;if(E&&T&&T.v7_partialHydration)for(let le=0;le<V.length;le++){let ae=V[le];if((ae.route.HydrateFallback||ae.route.hydrateFallbackElement)&&(ne=le),ae.route.id){let{loaderData:ge,errors:je}=E,Fe=ae.route.loader&&ge[ae.route.id]===void 0&&(!je||je[ae.route.id]===void 0);if(ae.route.lazy||Fe){$=!0,ne>=0?V=V.slice(0,ne+1):V=[V[0]];break}}}return V.reduceRight((le,ae,ge)=>{let je,Fe=!1,we=null,Ye=null;E&&(je=X&&ae.route.id?X[ae.route.id]:void 0,we=ae.route.errorElement||M7,$&&(ne<0&&ge===0?(Fe=!0,Ye=null):ne===ge&&(Fe=!0,Ye=ae.route.hydrateFallbackElement||null)));let Se=h.concat(V.slice(0,ge+1)),ue=()=>{let ve;return je?ve=we:Fe?ve=Ye:ae.route.Component?ve=Oe.createElement(ae.route.Component,null):ae.route.element?ve=ae.route.element:ve=le,Oe.createElement(x7,{match:ae,routeContext:{outlet:le,matches:Se,isDataRoute:E!=null},children:ve})};return E&&(ae.route.ErrorBoundary||ae.route.errorElement||ge===0)?Oe.createElement(U7,{location:E.location,revalidation:E.revalidation,component:we,error:je,children:ue(),routeContext:{outlet:null,matches:Se,isDataRoute:!0}}):ue()},null)}var iY=function(d){return d.UseBlocker="useBlocker",d.UseRevalidator="useRevalidator",d.UseNavigateStable="useNavigate",d}(iY||{}),S1=function(d){return d.UseBlocker="useBlocker",d.UseLoaderData="useLoaderData",d.UseActionData="useActionData",d.UseRouteError="useRouteError",d.UseNavigation="useNavigation",d.UseRouteLoaderData="useRouteLoaderData",d.UseMatches="useMatches",d.UseRevalidator="useRevalidator",d.UseNavigateStable="useNavigate",d.UseRouteId="useRouteId",d}(S1||{});function F7(d){let h=Oe.useContext(F4);return h||bo(!1),h}function j7(d){let h=Oe.useContext(O7);return h||bo(!1),h}function B7(d){let h=Oe.useContext(y_);return h||bo(!1),h}function rY(d){let h=B7(),E=h.matches[h.matches.length-1];return E.route.id||bo(!1),E.route.id}function G7(){var d;let h=Oe.useContext(eY),E=j7(S1.UseRouteError),T=rY(S1.UseRouteError);return h!==void 0?h:(d=E.errors)==null?void 0:d[T]}function W7(){let{router:d}=F7(iY.UseNavigateStable),h=rY(S1.UseNavigateStable),E=Oe.useRef(!1);return tY(()=>{E.current=!0}),Oe.useCallback(function(A,O){O===void 0&&(O={}),E.current&&(typeof A=="number"?d.navigate(A):d.navigate(A,lO({fromRouteId:h},O)))},[d,h])}function _s(d){bo(!1)}function H7(d){let{basename:h="/",children:E=null,location:T,navigationType:A=c_.Pop,navigator:O,static:V=!1,future:X}=d;TO()&&bo(!1);let $=h.replace(/^\/*/,"/"),ne=Oe.useMemo(()=>({basename:$,navigator:O,static:V,future:lO({v7_relativeSplatPath:!1},X)}),[$,X,O,V]);typeof T=="string"&&(T=qv(T));let{pathname:le="/",search:ae="",hash:ge="",state:je=null,key:Fe="default"}=T,we=Oe.useMemo(()=>{let Ye=V4(le,$);return Ye==null?null:{location:{pathname:Ye,search:ae,hash:ge,state:je,key:Fe},navigationType:A}},[$,le,ae,ge,je,Fe,A]);return we==null?null:Oe.createElement(FS.Provider,{value:ne},Oe.createElement(V1.Provider,{children:E,value:we}))}function K7(d){let{children:h,location:E}=d;return P7(NW(h),E)}new Promise(()=>{});function NW(d,h){h===void 0&&(h=[]);let E=[];return Oe.Children.forEach(d,(T,A)=>{if(!Oe.isValidElement(T))return;let O=[...h,A];if(T.type===Oe.Fragment){E.push.apply(E,NW(T.props.children,O));return}T.type!==_s&&bo(!1),!T.props.index||!T.props.children||bo(!1);let V={id:T.props.id||O.join("-"),caseSensitive:T.props.caseSensitive,element:T.props.element,Component:T.props.Component,index:T.props.index,path:T.props.path,loader:T.props.loader,action:T.props.action,errorElement:T.props.errorElement,ErrorBoundary:T.props.ErrorBoundary,hasErrorBoundary:T.props.ErrorBoundary!=null||T.props.errorElement!=null,shouldRevalidate:T.props.shouldRevalidate,handle:T.props.handle,lazy:T.props.lazy};T.props.children&&(V.children=NW(T.props.children,O)),E.push(V)}),E}/**
 * React Router DOM v6.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function DW(){return DW=Object.assign?Object.assign.bind():function(d){for(var h=1;h<arguments.length;h++){var E=arguments[h];for(var T in E)Object.prototype.hasOwnProperty.call(E,T)&&(d[T]=E[T])}return d},DW.apply(this,arguments)}function Y7(d,h){if(d==null)return{};var E={},T=Object.keys(d),A,O;for(O=0;O<T.length;O++)A=T[O],!(h.indexOf(A)>=0)&&(E[A]=d[A]);return E}function z7(d){return!!(d.metaKey||d.altKey||d.ctrlKey||d.shiftKey)}function q7(d,h){return d.button===0&&(!h||h==="_self")&&!z7(d)}function PW(d){return d===void 0&&(d=""),new URLSearchParams(typeof d=="string"||Array.isArray(d)||d instanceof URLSearchParams?d:Object.keys(d).reduce((h,E)=>{let T=d[E];return h.concat(Array.isArray(T)?T.map(A=>[E,A]):[[E,T]])},[]))}function J7(d,h){let E=PW(d);return h&&h.forEach((T,A)=>{E.has(A)||h.getAll(A).forEach(O=>{E.append(A,O)})}),E}const X7=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","unstable_viewTransition"],Q7="6";try{window.__reactRouterVersion=Q7}catch{}const Z7="startTransition",E6=Yz[Z7];function $7(d){let{basename:h,children:E,future:T,window:A}=d,O=Oe.useRef();O.current==null&&(O.current=r7({window:A,v5Compat:!0}));let V=O.current,[X,$]=Oe.useState({action:V.action,location:V.location}),{v7_startTransition:ne}=T||{},le=Oe.useCallback(ae=>{ne&&E6?E6(()=>$(ae)):$(ae)},[$,ne]);return Oe.useLayoutEffect(()=>V.listen(le),[V,le]),Oe.createElement(H7,{basename:h,children:E,location:X.location,navigationType:X.action,navigator:V,future:T})}const e9=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",t9=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Vr=Oe.forwardRef(function(h,E){let{onClick:T,relative:A,reloadDocument:O,replace:V,state:X,target:$,to:ne,preventScrollReset:le,unstable_viewTransition:ae}=h,ge=Y7(h,X7),{basename:je}=Oe.useContext(FS),Fe,we=!1;if(typeof ne=="string"&&t9.test(ne)&&(Fe=ne,e9))try{let ve=new URL(window.location.href),tt=ne.startsWith("//")?new URL(ve.protocol+ne):new URL(ne),Rt=V4(tt.pathname,je);tt.origin===ve.origin&&Rt!=null?ne=Rt+tt.search+tt.hash:we=!0}catch{}let Ye=N7(ne,{relative:A}),Se=n9(ne,{replace:V,state:X,target:$,preventScrollReset:le,relative:A,unstable_viewTransition:ae});function ue(ve){T&&T(ve),ve.defaultPrevented||Se(ve)}return Oe.createElement("a",DW({},ge,{href:Fe||Ye,onClick:we||O?T:ue,ref:E,target:$}))});var g6;(function(d){d.UseScrollRestoration="useScrollRestoration",d.UseSubmit="useSubmit",d.UseSubmitFetcher="useSubmitFetcher",d.UseFetcher="useFetcher",d.useViewTransitionState="useViewTransitionState"})(g6||(g6={}));var S6;(function(d){d.UseFetcher="useFetcher",d.UseFetchers="useFetchers",d.UseScrollRestoration="useScrollRestoration"})(S6||(S6={}));function n9(d,h){let{target:E,replace:T,state:A,preventScrollReset:O,relative:V,unstable_viewTransition:X}=h===void 0?{}:h,$=Zs(),ne=CO(),le=nY(d,{relative:V});return Oe.useCallback(ae=>{if(q7(ae,E)){ae.preventDefault();let ge=T!==void 0?T:g1(ne)===g1(le);$(d,{replace:ge,state:A,preventScrollReset:O,relative:V,unstable_viewTransition:X})}},[ne,$,le,T,A,E,d,O,V,X])}function sY(d){let h=Oe.useRef(PW(d)),E=Oe.useRef(!1),T=CO(),A=Oe.useMemo(()=>J7(T.search,E.current?null:h.current),[T.search]),O=Zs(),V=Oe.useCallback((X,$)=>{const ne=PW(typeof X=="function"?X(A):X);E.current=!0,O("?"+ne,$)},[O,A]);return[A,V]}const i9="_navContainer_1qp1y_1",r9="_logoContainer_1qp1y_19",s9="_logoImg_1qp1y_33",o9="_buttonContainer_1qp1y_43",a9="_othersContainer_1qp1y_59",c9="_btnHome_1qp1y_73",d9="_btnAbout_1qp1y_113",l9="_btnLogin_1qp1y_145",u9="_btnRegister_1qp1y_185",h9="_othersdiv1_1qp1y_225",p9="_othersdiv2_1qp1y_237",rs={navContainer:i9,logoContainer:r9,logoImg:s9,buttonContainer:o9,othersContainer:a9,btnHome:c9,btnAbout:d9,btnLogin:l9,btnRegister:u9,othersdiv1:h9,othersdiv2:p9};new TextEncoder;const oY=new TextDecoder,m9=d=>{const h=atob(d),E=new Uint8Array(h.length);for(let T=0;T<h.length;T++)E[T]=h.charCodeAt(T);return E},f9=d=>{let h=d;h instanceof Uint8Array&&(h=oY.decode(h)),h=h.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return m9(h)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class _9 extends Error{static get code(){return"ERR_JOSE_GENERIC"}constructor(h){var E;super(h),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,(E=Error.captureStackTrace)==null||E.call(Error,this,this.constructor)}}class vS extends _9{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}function E9(d){return typeof d=="object"&&d!==null}function g9(d){if(!E9(d)||Object.prototype.toString.call(d)!=="[object Object]")return!1;if(Object.getPrototypeOf(d)===null)return!0;let h=d;for(;Object.getPrototypeOf(h)!==null;)h=Object.getPrototypeOf(h);return Object.getPrototypeOf(d)===h}const S9=f9;function Qa(d){if(typeof d!="string")throw new vS("JWTs must use Compact JWS serialization, JWT must be a string");const{1:h,length:E}=d.split(".");if(E===5)throw new vS("Only JWTs using Compact JWS serialization can be decoded");if(E!==3)throw new vS("Invalid JWT");if(!h)throw new vS("JWTs must contain a payload");let T;try{T=S9(h)}catch{throw new vS("Failed to base64url decode the payload")}let A;try{A=JSON.parse(oY.decode(T))}catch{throw new vS("Failed to parse the decoded payload as JSON")}if(!g9(A))throw new vS("Invalid JWT Claims Set");return A}function aY(d){var h,E,T="";if(typeof d=="string"||typeof d=="number")T+=d;else if(typeof d=="object")if(Array.isArray(d)){var A=d.length;for(h=0;h<A;h++)d[h]&&(E=aY(d[h]))&&(T&&(T+=" "),T+=E)}else for(E in d)d[E]&&(T&&(T+=" "),T+=E);return T}function d_(){for(var d,h,E=0,T="",A=arguments.length;E<A;E++)(d=arguments[E])&&(h=aY(d))&&(T&&(T+=" "),T+=h);return T}const uO=d=>typeof d=="number"&&!isNaN(d),NS=d=>typeof d=="string",qd=d=>typeof d=="function",KL=d=>NS(d)||qd(d)?d:null,kW=d=>Oe.isValidElement(d)||NS(d)||qd(d)||uO(d);function T9(d,h,E){E===void 0&&(E=300);const{scrollHeight:T,style:A}=d;requestAnimationFrame(()=>{A.minHeight="initial",A.height=T+"px",A.transition=`all ${E}ms`,requestAnimationFrame(()=>{A.height="0",A.padding="0",A.margin="0",setTimeout(h,E)})})}function F1(d){let{enter:h,exit:E,appendPosition:T=!1,collapse:A=!0,collapseDuration:O=300}=d;return function(V){let{children:X,position:$,preventExitTransition:ne,done:le,nodeRef:ae,isIn:ge,playToast:je}=V;const Fe=T?`${h}--${$}`:h,we=T?`${E}--${$}`:E,Ye=Oe.useRef(0);return Oe.useLayoutEffect(()=>{const Se=ae.current,ue=Fe.split(" "),ve=tt=>{tt.target===ae.current&&(je(),Se.removeEventListener("animationend",ve),Se.removeEventListener("animationcancel",ve),Ye.current===0&&tt.type!=="animationcancel"&&Se.classList.remove(...ue))};Se.classList.add(...ue),Se.addEventListener("animationend",ve),Se.addEventListener("animationcancel",ve)},[]),Oe.useEffect(()=>{const Se=ae.current,ue=()=>{Se.removeEventListener("animationend",ue),A?T9(Se,le,O):le()};ge||(ne?ue():(Ye.current=1,Se.className+=` ${we}`,Se.addEventListener("animationend",ue)))},[ge]),xi.createElement(xi.Fragment,null,X)}}function T6(d,h){return d!=null?{content:d.content,containerId:d.props.containerId,id:d.props.toastId,theme:d.props.theme,type:d.props.type,data:d.props.data||{},isLoading:d.props.isLoading,icon:d.props.icon,status:h}:{}}const Dc=new Map;let hO=[];const LW=new Set,C9=d=>LW.forEach(h=>h(d)),cY=()=>Dc.size>0;function dY(d,h){var E;if(h)return!((E=Dc.get(h))==null||!E.isToastActive(d));let T=!1;return Dc.forEach(A=>{A.isToastActive(d)&&(T=!0)}),T}function lY(d,h){kW(d)&&(cY()||hO.push({content:d,options:h}),Dc.forEach(E=>{E.buildToast(d,h)}))}function C6(d,h){Dc.forEach(E=>{h!=null&&h!=null&&h.containerId?(h==null?void 0:h.containerId)===E.id&&E.toggle(d,h==null?void 0:h.id):E.toggle(d,h==null?void 0:h.id)})}function v9(d){const{subscribe:h,getSnapshot:E,setProps:T}=Oe.useRef(function(O){const V=O.containerId||1;return{subscribe(X){const $=function(le,ae,ge){let je=1,Fe=0,we=[],Ye=[],Se=[],ue=ae;const ve=new Map,tt=new Set,Rt=()=>{Se=Array.from(ve.values()),tt.forEach(Et=>Et())},lt=Et=>{Ye=Et==null?[]:Ye.filter(Bt=>Bt!==Et),Rt()},dt=Et=>{const{toastId:Bt,onOpen:Ht,updateId:rr,children:Fr}=Et.props,vn=rr==null;Et.staleId&&ve.delete(Et.staleId),ve.set(Bt,Et),Ye=[...Ye,Et.props.toastId].filter(Ft=>Ft!==Et.staleId),Rt(),ge(T6(Et,vn?"added":"updated")),vn&&qd(Ht)&&Ht(Oe.isValidElement(Fr)&&Fr.props)};return{id:le,props:ue,observe:Et=>(tt.add(Et),()=>tt.delete(Et)),toggle:(Et,Bt)=>{ve.forEach(Ht=>{Bt!=null&&Bt!==Ht.props.toastId||qd(Ht.toggle)&&Ht.toggle(Et)})},removeToast:lt,toasts:ve,clearQueue:()=>{Fe-=we.length,we=[]},buildToast:(Et,Bt)=>{if((Fi=>{let{containerId:$s,toastId:yi,updateId:gs}=Fi;const sr=$s?$s!==le:le!==1,Uc=ve.has(yi)&&gs==null;return sr||Uc})(Bt))return;const{toastId:Ht,updateId:rr,data:Fr,staleId:vn,delay:Ft}=Bt,as=()=>{lt(Ht)},ii=rr==null;ii&&Fe++;const Os={...ue,style:ue.toastStyle,key:je++,...Object.fromEntries(Object.entries(Bt).filter(Fi=>{let[$s,yi]=Fi;return yi!=null})),toastId:Ht,updateId:rr,data:Fr,closeToast:as,isIn:!1,className:KL(Bt.className||ue.toastClassName),bodyClassName:KL(Bt.bodyClassName||ue.bodyClassName),progressClassName:KL(Bt.progressClassName||ue.progressClassName),autoClose:!Bt.isLoading&&(Ot=Bt.autoClose,Nt=ue.autoClose,Ot===!1||uO(Ot)&&Ot>0?Ot:Nt),deleteToast(){const Fi=ve.get(Ht),{onClose:$s,children:yi}=Fi.props;qd($s)&&$s(Oe.isValidElement(yi)&&yi.props),ge(T6(Fi,"removed")),ve.delete(Ht),Fe--,Fe<0&&(Fe=0),we.length>0?dt(we.shift()):Rt()}};var Ot,Nt;Os.closeButton=ue.closeButton,Bt.closeButton===!1||kW(Bt.closeButton)?Os.closeButton=Bt.closeButton:Bt.closeButton===!0&&(Os.closeButton=!kW(ue.closeButton)||ue.closeButton);let cn=Et;Oe.isValidElement(Et)&&!NS(Et.type)?cn=Oe.cloneElement(Et,{closeToast:as,toastProps:Os,data:Fr}):qd(Et)&&(cn=Et({closeToast:as,toastProps:Os,data:Fr}));const Vi={content:cn,props:Os,staleId:vn};ue.limit&&ue.limit>0&&Fe>ue.limit&&ii?we.push(Vi):uO(Ft)?setTimeout(()=>{dt(Vi)},Ft):dt(Vi)},setProps(Et){ue=Et},setToggle:(Et,Bt)=>{ve.get(Et).toggle=Bt},isToastActive:Et=>Ye.some(Bt=>Bt===Et),getSnapshot:()=>ue.newestOnTop?Se.reverse():Se}}(V,O,C9);Dc.set(V,$);const ne=$.observe(X);return hO.forEach(le=>lY(le.content,le.options)),hO=[],()=>{ne(),Dc.delete(V)}},setProps(X){var $;($=Dc.get(V))==null||$.setProps(X)},getSnapshot(){var X;return(X=Dc.get(V))==null?void 0:X.getSnapshot()}}}(d)).current;T(d);const A=Oe.useSyncExternalStore(h,E,E);return{getToastToRender:function(O){if(!A)return[];const V=new Map;return A.forEach(X=>{const{position:$}=X.props;V.has($)||V.set($,[]),V.get($).push(X)}),Array.from(V,X=>O(X[0],X[1]))},isToastActive:dY,count:A==null?void 0:A.length}}function R9(d){const[h,E]=Oe.useState(!1),[T,A]=Oe.useState(!1),O=Oe.useRef(null),V=Oe.useRef({start:0,delta:0,removalDistance:0,canCloseOnClick:!0,canDrag:!1,didMove:!1}).current,{autoClose:X,pauseOnHover:$,closeToast:ne,onClick:le,closeOnClick:ae}=d;var ge,je;function Fe(){E(!0)}function we(){E(!1)}function Ye(ve){const tt=O.current;V.canDrag&&tt&&(V.didMove=!0,h&&we(),V.delta=d.draggableDirection==="x"?ve.clientX-V.start:ve.clientY-V.start,V.start!==ve.clientX&&(V.canCloseOnClick=!1),tt.style.transform=`translate3d(${d.draggableDirection==="x"?`${V.delta}px, var(--y)`:`0, calc(${V.delta}px + var(--y))`},0)`,tt.style.opacity=""+(1-Math.abs(V.delta/V.removalDistance)))}function Se(){document.removeEventListener("pointermove",Ye),document.removeEventListener("pointerup",Se);const ve=O.current;if(V.canDrag&&V.didMove&&ve){if(V.canDrag=!1,Math.abs(V.delta)>V.removalDistance)return A(!0),d.closeToast(),void d.collapseAll();ve.style.transition="transform 0.2s, opacity 0.2s",ve.style.removeProperty("transform"),ve.style.removeProperty("opacity")}}(je=Dc.get((ge={id:d.toastId,containerId:d.containerId,fn:E}).containerId||1))==null||je.setToggle(ge.id,ge.fn),Oe.useEffect(()=>{if(d.pauseOnFocusLoss)return document.hasFocus()||we(),window.addEventListener("focus",Fe),window.addEventListener("blur",we),()=>{window.removeEventListener("focus",Fe),window.removeEventListener("blur",we)}},[d.pauseOnFocusLoss]);const ue={onPointerDown:function(ve){if(d.draggable===!0||d.draggable===ve.pointerType){V.didMove=!1,document.addEventListener("pointermove",Ye),document.addEventListener("pointerup",Se);const tt=O.current;V.canCloseOnClick=!0,V.canDrag=!0,tt.style.transition="none",d.draggableDirection==="x"?(V.start=ve.clientX,V.removalDistance=tt.offsetWidth*(d.draggablePercent/100)):(V.start=ve.clientY,V.removalDistance=tt.offsetHeight*(d.draggablePercent===80?1.5*d.draggablePercent:d.draggablePercent)/100)}},onPointerUp:function(ve){const{top:tt,bottom:Rt,left:lt,right:dt}=O.current.getBoundingClientRect();ve.nativeEvent.type!=="touchend"&&d.pauseOnHover&&ve.clientX>=lt&&ve.clientX<=dt&&ve.clientY>=tt&&ve.clientY<=Rt?we():Fe()}};return X&&$&&(ue.onMouseEnter=we,d.stacked||(ue.onMouseLeave=Fe)),ae&&(ue.onClick=ve=>{le&&le(ve),V.canCloseOnClick&&ne()}),{playToast:Fe,pauseToast:we,isRunning:h,preventExitTransition:T,toastRef:O,eventHandlers:ue}}function y9(d){let{delay:h,isRunning:E,closeToast:T,type:A="default",hide:O,className:V,style:X,controlledProgress:$,progress:ne,rtl:le,isIn:ae,theme:ge}=d;const je=O||$&&ne===0,Fe={...X,animationDuration:`${h}ms`,animationPlayState:E?"running":"paused"};$&&(Fe.transform=`scaleX(${ne})`);const we=d_("Toastify__progress-bar",$?"Toastify__progress-bar--controlled":"Toastify__progress-bar--animated",`Toastify__progress-bar-theme--${ge}`,`Toastify__progress-bar--${A}`,{"Toastify__progress-bar--rtl":le}),Ye=qd(V)?V({rtl:le,type:A,defaultClassName:we}):d_(we,V),Se={[$&&ne>=1?"onTransitionEnd":"onAnimationEnd"]:$&&ne<1?null:()=>{ae&&T()}};return xi.createElement("div",{className:"Toastify__progress-bar--wrp","data-hidden":je},xi.createElement("div",{className:`Toastify__progress-bar--bg Toastify__progress-bar-theme--${ge} Toastify__progress-bar--${A}`}),xi.createElement("div",{role:"progressbar","aria-hidden":je?"true":"false","aria-label":"notification timer",className:Ye,style:Fe,...Se}))}let I9=1;const uY=()=>""+I9++;function A9(d){return d&&(NS(d.toastId)||uO(d.toastId))?d.toastId:uY()}function W0(d,h){return lY(d,h),h.toastId}function T1(d,h){return{...h,type:h&&h.type||d,toastId:A9(h)}}function bL(d){return(h,E)=>W0(h,T1(d,E))}function Tn(d,h){return W0(d,T1("default",h))}Tn.loading=(d,h)=>W0(d,T1("default",{isLoading:!0,autoClose:!1,closeOnClick:!1,closeButton:!1,draggable:!1,...h})),Tn.promise=function(d,h,E){let T,{pending:A,error:O,success:V}=h;A&&(T=NS(A)?Tn.loading(A,E):Tn.loading(A.render,{...E,...A}));const X={isLoading:null,autoClose:null,closeOnClick:null,closeButton:null,draggable:null},$=(le,ae,ge)=>{if(ae==null)return void Tn.dismiss(T);const je={type:le,...X,...E,data:ge},Fe=NS(ae)?{render:ae}:ae;return T?Tn.update(T,{...je,...Fe}):Tn(Fe.render,{...je,...Fe}),ge},ne=qd(d)?d():d;return ne.then(le=>$("success",V,le)).catch(le=>$("error",O,le)),ne},Tn.success=bL("success"),Tn.info=bL("info"),Tn.error=bL("error"),Tn.warning=bL("warning"),Tn.warn=Tn.warning,Tn.dark=(d,h)=>W0(d,T1("default",{theme:"dark",...h})),Tn.dismiss=function(d){(function(h){var E;if(cY()){if(h==null||NS(E=h)||uO(E))Dc.forEach(T=>{T.removeToast(h)});else if(h&&("containerId"in h||"id"in h)){const T=Dc.get(h.containerId);T?T.removeToast(h.id):Dc.forEach(A=>{A.removeToast(h.id)})}}else hO=hO.filter(T=>h!=null&&T.options.toastId!==h)})(d)},Tn.clearWaitingQueue=function(d){d===void 0&&(d={}),Dc.forEach(h=>{!h.props.limit||d.containerId&&h.id!==d.containerId||h.clearQueue()})},Tn.isActive=dY,Tn.update=function(d,h){h===void 0&&(h={});const E=((T,A)=>{var O;let{containerId:V}=A;return(O=Dc.get(V||1))==null?void 0:O.toasts.get(T)})(d,h);if(E){const{props:T,content:A}=E,O={delay:100,...T,...h,toastId:h.toastId||d,updateId:uY()};O.toastId!==d&&(O.staleId=d);const V=O.render||A;delete O.render,W0(V,O)}},Tn.done=d=>{Tn.update(d,{progress:1})},Tn.onChange=function(d){return LW.add(d),()=>{LW.delete(d)}},Tn.play=d=>C6(!0,d),Tn.pause=d=>C6(!1,d);const w9=typeof window<"u"?Oe.useLayoutEffect:Oe.useEffect,OL=d=>{let{theme:h,type:E,isLoading:T,...A}=d;return xi.createElement("svg",{viewBox:"0 0 24 24",width:"100%",height:"100%",fill:h==="colored"?"currentColor":`var(--toastify-icon-color-${E})`,...A})},kG={info:function(d){return xi.createElement(OL,{...d},xi.createElement("path",{d:"M12 0a12 12 0 1012 12A12.013 12.013 0 0012 0zm.25 5a1.5 1.5 0 11-1.5 1.5 1.5 1.5 0 011.5-1.5zm2.25 13.5h-4a1 1 0 010-2h.75a.25.25 0 00.25-.25v-4.5a.25.25 0 00-.25-.25h-.75a1 1 0 010-2h1a2 2 0 012 2v4.75a.25.25 0 00.25.25h.75a1 1 0 110 2z"}))},warning:function(d){return xi.createElement(OL,{...d},xi.createElement("path",{d:"M23.32 17.191L15.438 2.184C14.728.833 13.416 0 11.996 0c-1.42 0-2.733.833-3.443 2.184L.533 17.448a4.744 4.744 0 000 4.368C1.243 23.167 2.555 24 3.975 24h16.05C22.22 24 24 22.044 24 19.632c0-.904-.251-1.746-.68-2.44zm-9.622 1.46c0 1.033-.724 1.823-1.698 1.823s-1.698-.79-1.698-1.822v-.043c0-1.028.724-1.822 1.698-1.822s1.698.79 1.698 1.822v.043zm.039-12.285l-.84 8.06c-.057.581-.408.943-.897.943-.49 0-.84-.367-.896-.942l-.84-8.065c-.057-.624.25-1.095.779-1.095h1.91c.528.005.84.476.784 1.1z"}))},success:function(d){return xi.createElement(OL,{...d},xi.createElement("path",{d:"M12 0a12 12 0 1012 12A12.014 12.014 0 0012 0zm6.927 8.2l-6.845 9.289a1.011 1.011 0 01-1.43.188l-4.888-3.908a1 1 0 111.25-1.562l4.076 3.261 6.227-8.451a1 1 0 111.61 1.183z"}))},error:function(d){return xi.createElement(OL,{...d},xi.createElement("path",{d:"M11.983 0a12.206 12.206 0 00-8.51 3.653A11.8 11.8 0 000 12.207 11.779 11.779 0 0011.8 24h.214A12.111 12.111 0 0024 11.791 11.766 11.766 0 0011.983 0zM10.5 16.542a1.476 1.476 0 011.449-1.53h.027a1.527 1.527 0 011.523 1.47 1.475 1.475 0 01-1.449 1.53h-.027a1.529 1.529 0 01-1.523-1.47zM11 12.5v-6a1 1 0 012 0v6a1 1 0 11-2 0z"}))},spinner:function(){return xi.createElement("div",{className:"Toastify__spinner"})}},b9=d=>{const{isRunning:h,preventExitTransition:E,toastRef:T,eventHandlers:A,playToast:O}=R9(d),{closeButton:V,children:X,autoClose:$,onClick:ne,type:le,hideProgressBar:ae,closeToast:ge,transition:je,position:Fe,className:we,style:Ye,bodyClassName:Se,bodyStyle:ue,progressClassName:ve,progressStyle:tt,updateId:Rt,role:lt,progress:dt,rtl:Et,toastId:Bt,deleteToast:Ht,isIn:rr,isLoading:Fr,closeOnClick:vn,theme:Ft}=d,as=d_("Toastify__toast",`Toastify__toast-theme--${Ft}`,`Toastify__toast--${le}`,{"Toastify__toast--rtl":Et},{"Toastify__toast--close-on-click":vn}),ii=qd(we)?we({rtl:Et,position:Fe,type:le,defaultClassName:as}):d_(as,we),Os=function(Vi){let{theme:Fi,type:$s,isLoading:yi,icon:gs}=Vi,sr=null;const Uc={theme:Fi,type:$s};return gs===!1||(qd(gs)?sr=gs({...Uc,isLoading:yi}):Oe.isValidElement(gs)?sr=Oe.cloneElement(gs,Uc):yi?sr=kG.spinner():(Jv=>Jv in kG)($s)&&(sr=kG[$s](Uc))),sr}(d),Ot=!!dt||!$,Nt={closeToast:ge,type:le,theme:Ft};let cn=null;return V===!1||(cn=qd(V)?V(Nt):Oe.isValidElement(V)?Oe.cloneElement(V,Nt):function(Vi){let{closeToast:Fi,theme:$s,ariaLabel:yi="close"}=Vi;return xi.createElement("button",{className:`Toastify__close-button Toastify__close-button--${$s}`,type:"button",onClick:gs=>{gs.stopPropagation(),Fi(gs)},"aria-label":yi},xi.createElement("svg",{"aria-hidden":"true",viewBox:"0 0 14 16"},xi.createElement("path",{fillRule:"evenodd",d:"M7.71 8.23l3.75 3.75-1.48 1.48-3.75-3.75-3.75 3.75L1 11.98l3.75-3.75L1 4.48 2.48 3l3.75 3.75L9.98 3l1.48 1.48-3.75 3.75z"})))}(Nt)),xi.createElement(je,{isIn:rr,done:Ht,position:Fe,preventExitTransition:E,nodeRef:T,playToast:O},xi.createElement("div",{id:Bt,onClick:ne,"data-in":rr,className:ii,...A,style:Ye,ref:T},xi.createElement("div",{...rr&&{role:lt},className:qd(Se)?Se({type:le}):d_("Toastify__toast-body",Se),style:ue},Os!=null&&xi.createElement("div",{className:d_("Toastify__toast-icon",{"Toastify--animate-icon Toastify__zoom-enter":!Fr})},Os),xi.createElement("div",null,X)),cn,xi.createElement(y9,{...Rt&&!Ot?{key:`pb-${Rt}`}:{},rtl:Et,theme:Ft,delay:$,isRunning:h,isIn:rr,closeToast:ge,hide:ae,type:le,style:tt,className:ve,controlledProgress:Ot,progress:dt||0})))},j1=function(d,h){return h===void 0&&(h=!1),{enter:`Toastify--animate Toastify__${d}-enter`,exit:`Toastify--animate Toastify__${d}-exit`,appendPosition:h}},O9=F1(j1("bounce",!0));F1(j1("slide",!0));F1(j1("zoom"));F1(j1("flip"));const N9={position:"top-right",transition:O9,autoClose:5e3,closeButton:!0,pauseOnHover:!0,pauseOnFocusLoss:!0,draggable:"touch",draggablePercent:80,draggableDirection:"x",role:"alert",theme:"light"};function D9(d){let h={...N9,...d};const E=d.stacked,[T,A]=Oe.useState(!0),O=Oe.useRef(null),{getToastToRender:V,isToastActive:X,count:$}=v9(h),{className:ne,style:le,rtl:ae,containerId:ge}=h;function je(we){const Ye=d_("Toastify__toast-container",`Toastify__toast-container--${we}`,{"Toastify__toast-container--rtl":ae});return qd(ne)?ne({position:we,rtl:ae,defaultClassName:Ye}):d_(Ye,KL(ne))}function Fe(){E&&(A(!0),Tn.play())}return w9(()=>{if(E){var we;const Ye=O.current.querySelectorAll('[data-in="true"]'),Se=12,ue=(we=h.position)==null?void 0:we.includes("top");let ve=0,tt=0;Array.from(Ye).reverse().forEach((Rt,lt)=>{const dt=Rt;dt.classList.add("Toastify__toast--stacked"),lt>0&&(dt.dataset.collapsed=`${T}`),dt.dataset.pos||(dt.dataset.pos=ue?"top":"bot");const Et=ve*(T?.2:1)+(T?0:Se*lt);dt.style.setProperty("--y",`${ue?Et:-1*Et}px`),dt.style.setProperty("--g",`${Se}`),dt.style.setProperty("--s",""+(1-(T?tt:0))),ve+=dt.offsetHeight,tt+=.025})}},[T,$,E]),xi.createElement("div",{ref:O,className:"Toastify",id:ge,onMouseEnter:()=>{E&&(A(!1),Tn.pause())},onMouseLeave:Fe},V((we,Ye)=>{const Se=Ye.length?{...le}:{...le,pointerEvents:"none"};return xi.createElement("div",{className:je(we),style:Se,key:`container-${we}`},Ye.map(ue=>{let{content:ve,props:tt}=ue;return xi.createElement(b9,{...tt,stacked:E,collapseAll:Fe,isIn:X(tt.toastId,tt.containerId),style:tt.style,key:`toast-${tt.key}`},ve)}))}))}function P9(){Oe.useState(!1),Zs();const d=localStorage.getItem("token");if(Oe.useRef(""),d){const h=Qa(d);return F.jsx(F.Fragment,{children:F.jsxs("div",{className:rs.navContainer,children:[F.jsx("div",{className:rs.logoContainer,children:F.jsx("img",{className:rs.logoImg,src:"../public/LogoEX.png",alt:"Logo"})}),F.jsxs("div",{className:rs.buttonContainer,children:[F.jsx(Vr,{className:rs.btnHome,to:"/posts",children:"Feed"}),F.jsx(Vr,{className:rs.btnHome,to:"/search",children:"Search"}),F.jsx(Vr,{className:rs.btnHome,to:"/contact",children:"Contact"})]}),F.jsxs("div",{className:rs.othersContainer,children:[F.jsx("div",{className:rs.othersdiv1,children:F.jsx(Vr,{className:rs.btnLogin,to:`/user/${h.username}`,children:"My Profile"})}),F.jsx("div",{className:rs.othersdiv1,children:F.jsx(Vr,{className:rs.btnLogin,to:"/userdashboard",children:"Dashboard"})}),F.jsx("div",{className:rs.othersdiv1,children:F.jsx(Vr,{className:rs.btnLogin,style:{backgroundColor:"red",color:"white"},to:"/home",onClick:()=>{localStorage.removeItem("token"),Tn.success("Logged out Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},children:"Logout"})})]})]})})}else return F.jsx(F.Fragment,{children:F.jsxs("div",{className:rs.navContainer,children:[F.jsx("div",{className:rs.logoContainer,children:F.jsx("img",{className:rs.logoImg,src:"../public/LogoEX.png",alt:"Logo"})}),F.jsxs("div",{className:rs.buttonContainer,children:[F.jsx(Vr,{className:rs.btnHome,to:"/home",children:"Home"}),F.jsx(Vr,{className:rs.btnHome,to:"/search",children:"Search"}),F.jsx(Vr,{className:rs.btnHome,to:"/contact",children:"Contact"})]}),F.jsxs("div",{className:rs.othersContainer,children:[F.jsx("div",{id:"loginContainer",className:rs.othersdiv1,children:F.jsx(Vr,{className:rs.btnLogin,to:"/login",children:"Login"})}),F.jsx("div",{id:"regContainer",className:rs.othersdiv2,children:F.jsx(Vr,{className:rs.btnRegister,to:"/register",children:"Create Account"})})]})]})})}function k9(){Zs();const d="http://localhost:5000";localStorage.getItem("token");const[h,E]=Oe.useState([""]);return Oe.useEffect(()=>{(async()=>{const O=await(await fetch(`${d}/admin/get-announcement`,{method:"GET"}).catch(V=>{console.log(V)})).json();E(O)})()},[]),F.jsx(F.Fragment,{children:F.jsx("div",{style:{display:"flex",width:"100%",flexWrap:"wrap",justifyContent:"center",margin:"10px"},children:F.jsxs("div",{style:{borderStyle:"solid",borderWidth:"2px",borderColor:"#273e6e",margin:"10px",padding:"5px",borderRadius:"5px"},children:[F.jsx("strong",{children:"Announcement: "})," ",h[0].content]})})})}const L9="_mainContainer_cxic2_1",M9="_searchContainer_cxic2_15",U9="_searchBar_cxic2_31",x9="_voiceSearchIcon_cxic2_47",V9="_searchIcon_cxic2_83",F9="_infocardContainer_cxic2_99",j9="_leftContainer_cxic2_121",B9="_infoIcon_cxic2_143",G9="_postsPageMainContainer_cxic2_153",W9="_postContainer_cxic2_171",H9="_postTop_cxic2_201",K9="_postImg_cxic2_221",Y9="_postUsername_cxic2_245",z9="_postFooter_cxic2_261",q9="_postFooterShowComments_cxic2_275",J9="_postFooterTag_cxic2_287",X9="_loginContainer_cxic2_299",Q9="_loginFormContainer_cxic2_309",Z9="_loginInput_cxic2_337",$9="_loginButton_cxic2_357",eX="_loginForgot_cxic2_375",tX="_registerContainer_cxic2_391",nX="_registerFormContainer_cxic2_409",iX="_registerForgot_cxic2_437",rX="_contactMessage_cxic2_453",sX="_contactFormContainer_cxic2_469",oX="_dashboardMainContainer_cxic2_497",aX="_dashboardContainer_cxic2_513",cX="_dashboardItemTop_cxic2_547",dX="_dashboardIcon_cxic2_555",lX="_dashboardText_cxic2_565",uX="_tagsContainer_cxic2_583",hX="_tagButton_cxic2_601",pX="_checkBoxContainer_cxic2_639",mX="_detailedPostContainer_cxic2_669",fX="_detailedPostTop_cxic2_695",_X="_detailedPostUsername_cxic2_717",EX="_detailedPostMid_cxic2_731",gX="_detailedPostFooter_cxic2_749",SX="_detailedPostImg_cxic2_765",TX="_commentContainer_cxic2_791",CX="_commentTop_cxic2_815",vX="_commentUsername_cxic2_841",RX="_commentMid_cxic2_855",yX="_commentFooter_cxic2_871",IX="_adminControlIcon_cxic2_887",AX="_generalContainer_cxic2_895",Ae={mainContainer:L9,searchContainer:M9,searchBar:U9,voiceSearchIcon:x9,searchIcon:V9,infocardContainer:F9,leftContainer:j9,infoIcon:B9,postsPageMainContainer:G9,postContainer:W9,postTop:H9,postImg:K9,postUsername:Y9,postFooter:z9,postFooterShowComments:q9,postFooterTag:J9,loginContainer:X9,loginFormContainer:Q9,loginInput:Z9,loginButton:$9,loginForgot:eX,registerContainer:tX,registerFormContainer:nX,registerForgot:iX,contactMessage:rX,contactFormContainer:sX,dashboardMainContainer:oX,dashboardContainer:aX,dashboardItemTop:cX,dashboardIcon:dX,dashboardText:lX,tagsContainer:uX,tagButton:hX,checkBoxContainer:pX,detailedPostContainer:mX,detailedPostTop:fX,detailedPostUsername:_X,detailedPostMid:EX,detailedPostFooter:gX,detailedPostImg:SX,commentContainer:TX,commentTop:CX,commentUsername:vX,commentMid:RX,commentFooter:yX,adminControlIcon:IX,generalContainer:AX},H0=/^[a-z0-9]+(-[a-z0-9]+)*$/,B1=(d,h,E,T="")=>{const A=d.split(":");if(d.slice(0,1)==="@"){if(A.length<2||A.length>3)return null;T=A.shift().slice(1)}if(A.length>3||!A.length)return null;if(A.length>1){const X=A.pop(),$=A.pop(),ne={provider:A.length>0?A[0]:T,prefix:$,name:X};return h&&!YL(ne)?null:ne}const O=A[0],V=O.split("-");if(V.length>1){const X={provider:T,prefix:V.shift(),name:V.join("-")};return h&&!YL(X)?null:X}if(E&&T===""){const X={provider:T,prefix:"",name:O};return h&&!YL(X,E)?null:X}return null},YL=(d,h)=>d?!!((d.provider===""||d.provider.match(H0))&&(h&&d.prefix===""||d.prefix.match(H0))&&d.name.match(H0)):!1,hY=Object.freeze({left:0,top:0,width:16,height:16}),C1=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),B4=Object.freeze({...hY,...C1}),MW=Object.freeze({...B4,body:"",hidden:!1});function wX(d,h){const E={};!d.hFlip!=!h.hFlip&&(E.hFlip=!0),!d.vFlip!=!h.vFlip&&(E.vFlip=!0);const T=((d.rotate||0)+(h.rotate||0))%4;return T&&(E.rotate=T),E}function v6(d,h){const E=wX(d,h);for(const T in MW)T in C1?T in d&&!(T in E)&&(E[T]=C1[T]):T in h?E[T]=h[T]:T in d&&(E[T]=d[T]);return E}function bX(d,h){const E=d.icons,T=d.aliases||Object.create(null),A=Object.create(null);function O(V){if(E[V])return A[V]=[];if(!(V in A)){A[V]=null;const X=T[V]&&T[V].parent,$=X&&O(X);$&&(A[V]=[X].concat($))}return A[V]}return Object.keys(E).concat(Object.keys(T)).forEach(O),A}function OX(d,h,E){const T=d.icons,A=d.aliases||Object.create(null);let O={};function V(X){O=v6(T[X]||A[X],O)}return V(h),E.forEach(V),v6(d,O)}function pY(d,h){const E=[];if(typeof d!="object"||typeof d.icons!="object")return E;d.not_found instanceof Array&&d.not_found.forEach(A=>{h(A,null),E.push(A)});const T=bX(d);for(const A in T){const O=T[A];O&&(h(A,OX(d,A,O)),E.push(A))}return E}const NX={provider:"",aliases:{},not_found:{},...hY};function LG(d,h){for(const E in h)if(E in d&&typeof d[E]!=typeof h[E])return!1;return!0}function mY(d){if(typeof d!="object"||d===null)return null;const h=d;if(typeof h.prefix!="string"||!d.icons||typeof d.icons!="object"||!LG(d,NX))return null;const E=h.icons;for(const A in E){const O=E[A];if(!A.match(H0)||typeof O.body!="string"||!LG(O,MW))return null}const T=h.aliases||Object.create(null);for(const A in T){const O=T[A],V=O.parent;if(!A.match(H0)||typeof V!="string"||!E[V]&&!T[V]||!LG(O,MW))return null}return h}const R6=Object.create(null);function DX(d,h){return{provider:d,prefix:h,icons:Object.create(null),missing:new Set}}function US(d,h){const E=R6[d]||(R6[d]=Object.create(null));return E[h]||(E[h]=DX(d,h))}function G4(d,h){return mY(h)?pY(h,(E,T)=>{T?d.icons[E]=T:d.missing.add(E)}):[]}function PX(d,h,E){try{if(typeof E.body=="string")return d.icons[h]={...E},!0}catch{}return!1}let pO=!1;function fY(d){return typeof d=="boolean"&&(pO=d),pO}function kX(d){const h=typeof d=="string"?B1(d,!0,pO):d;if(h){const E=US(h.provider,h.prefix),T=h.name;return E.icons[T]||(E.missing.has(T)?null:void 0)}}function LX(d,h){const E=B1(d,!0,pO);if(!E)return!1;const T=US(E.provider,E.prefix);return PX(T,E.name,h)}function MX(d,h){if(typeof d!="object")return!1;if(typeof h!="string"&&(h=d.provider||""),pO&&!h&&!d.prefix){let A=!1;return mY(d)&&(d.prefix="",pY(d,(O,V)=>{V&&LX(O,V)&&(A=!0)})),A}const E=d.prefix;if(!YL({provider:h,prefix:E,name:"a"}))return!1;const T=US(h,E);return!!G4(T,d)}const _Y=Object.freeze({width:null,height:null}),EY=Object.freeze({..._Y,...C1}),UX=/(-?[0-9.]*[0-9]+[0-9.]*)/g,xX=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function y6(d,h,E){if(h===1)return d;if(E=E||100,typeof d=="number")return Math.ceil(d*h*E)/E;if(typeof d!="string")return d;const T=d.split(UX);if(T===null||!T.length)return d;const A=[];let O=T.shift(),V=xX.test(O);for(;;){if(V){const X=parseFloat(O);isNaN(X)?A.push(O):A.push(Math.ceil(X*h*E)/E)}else A.push(O);if(O=T.shift(),O===void 0)return A.join("");V=!V}}const VX=d=>d==="unset"||d==="undefined"||d==="none";function FX(d,h){const E={...B4,...d},T={...EY,...h},A={left:E.left,top:E.top,width:E.width,height:E.height};let O=E.body;[E,T].forEach(Fe=>{const we=[],Ye=Fe.hFlip,Se=Fe.vFlip;let ue=Fe.rotate;Ye?Se?ue+=2:(we.push("translate("+(A.width+A.left).toString()+" "+(0-A.top).toString()+")"),we.push("scale(-1 1)"),A.top=A.left=0):Se&&(we.push("translate("+(0-A.left).toString()+" "+(A.height+A.top).toString()+")"),we.push("scale(1 -1)"),A.top=A.left=0);let ve;switch(ue<0&&(ue-=Math.floor(ue/4)*4),ue=ue%4,ue){case 1:ve=A.height/2+A.top,we.unshift("rotate(90 "+ve.toString()+" "+ve.toString()+")");break;case 2:we.unshift("rotate(180 "+(A.width/2+A.left).toString()+" "+(A.height/2+A.top).toString()+")");break;case 3:ve=A.width/2+A.left,we.unshift("rotate(-90 "+ve.toString()+" "+ve.toString()+")");break}ue%2===1&&(A.left!==A.top&&(ve=A.left,A.left=A.top,A.top=ve),A.width!==A.height&&(ve=A.width,A.width=A.height,A.height=ve)),we.length&&(O='<g transform="'+we.join(" ")+'">'+O+"</g>")});const V=T.width,X=T.height,$=A.width,ne=A.height;let le,ae;V===null?(ae=X===null?"1em":X==="auto"?ne:X,le=y6(ae,$/ne)):(le=V==="auto"?$:V,ae=X===null?y6(le,ne/$):X==="auto"?ne:X);const ge={},je=(Fe,we)=>{VX(we)||(ge[Fe]=we.toString())};return je("width",le),je("height",ae),ge.viewBox=A.left.toString()+" "+A.top.toString()+" "+$.toString()+" "+ne.toString(),{attributes:ge,body:O}}const jX=/\sid="(\S+)"/g,BX="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let GX=0;function WX(d,h=BX){const E=[];let T;for(;T=jX.exec(d);)E.push(T[1]);if(!E.length)return d;const A="suffix"+(Math.random()*16777216|Date.now()).toString(16);return E.forEach(O=>{const V=typeof h=="function"?h(O):h+(GX++).toString(),X=O.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");d=d.replace(new RegExp('([#;"])('+X+')([")]|\\.[a-z])',"g"),"$1"+V+A+"$3")}),d=d.replace(new RegExp(A,"g"),""),d}const UW=Object.create(null);function HX(d,h){UW[d]=h}function xW(d){return UW[d]||UW[""]}function W4(d){let h;if(typeof d.resources=="string")h=[d.resources];else if(h=d.resources,!(h instanceof Array)||!h.length)return null;return{resources:h,path:d.path||"/",maxURL:d.maxURL||500,rotate:d.rotate||750,timeout:d.timeout||5e3,random:d.random===!0,index:d.index||0,dataAfterTimeout:d.dataAfterTimeout!==!1}}const H4=Object.create(null),O0=["https://api.simplesvg.com","https://api.unisvg.com"],zL=[];for(;O0.length>0;)O0.length===1||Math.random()>.5?zL.push(O0.shift()):zL.push(O0.pop());H4[""]=W4({resources:["https://api.iconify.design"].concat(zL)});function KX(d,h){const E=W4(h);return E===null?!1:(H4[d]=E,!0)}function K4(d){return H4[d]}const YX=()=>{let d;try{if(d=fetch,typeof d=="function")return d}catch{}};let I6=YX();function zX(d,h){const E=K4(d);if(!E)return 0;let T;if(!E.maxURL)T=0;else{let A=0;E.resources.forEach(V=>{A=Math.max(A,V.length)});const O=h+".json?icons=";T=E.maxURL-A-E.path.length-O.length}return T}function qX(d){return d===404}const JX=(d,h,E)=>{const T=[],A=zX(d,h),O="icons";let V={type:O,provider:d,prefix:h,icons:[]},X=0;return E.forEach(($,ne)=>{X+=$.length+1,X>=A&&ne>0&&(T.push(V),V={type:O,provider:d,prefix:h,icons:[]},X=$.length),V.icons.push($)}),T.push(V),T};function XX(d){if(typeof d=="string"){const h=K4(d);if(h)return h.path}return"/"}const QX=(d,h,E)=>{if(!I6){E("abort",424);return}let T=XX(h.provider);switch(h.type){case"icons":{const O=h.prefix,X=h.icons.join(","),$=new URLSearchParams({icons:X});T+=O+".json?"+$.toString();break}case"custom":{const O=h.uri;T+=O.slice(0,1)==="/"?O.slice(1):O;break}default:E("abort",400);return}let A=503;I6(d+T).then(O=>{const V=O.status;if(V!==200){setTimeout(()=>{E(qX(V)?"abort":"next",V)});return}return A=501,O.json()}).then(O=>{if(typeof O!="object"||O===null){setTimeout(()=>{O===404?E("abort",O):E("next",A)});return}setTimeout(()=>{E("success",O)})}).catch(()=>{E("next",A)})},ZX={prepare:JX,send:QX};function $X(d){const h={loaded:[],missing:[],pending:[]},E=Object.create(null);d.sort((A,O)=>A.provider!==O.provider?A.provider.localeCompare(O.provider):A.prefix!==O.prefix?A.prefix.localeCompare(O.prefix):A.name.localeCompare(O.name));let T={provider:"",prefix:"",name:""};return d.forEach(A=>{if(T.name===A.name&&T.prefix===A.prefix&&T.provider===A.provider)return;T=A;const O=A.provider,V=A.prefix,X=A.name,$=E[O]||(E[O]=Object.create(null)),ne=$[V]||($[V]=US(O,V));let le;X in ne.icons?le=h.loaded:V===""||ne.missing.has(X)?le=h.missing:le=h.pending;const ae={provider:O,prefix:V,name:X};le.push(ae)}),h}function gY(d,h){d.forEach(E=>{const T=E.loaderCallbacks;T&&(E.loaderCallbacks=T.filter(A=>A.id!==h))})}function eQ(d){d.pendingCallbacksFlag||(d.pendingCallbacksFlag=!0,setTimeout(()=>{d.pendingCallbacksFlag=!1;const h=d.loaderCallbacks?d.loaderCallbacks.slice(0):[];if(!h.length)return;let E=!1;const T=d.provider,A=d.prefix;h.forEach(O=>{const V=O.icons,X=V.pending.length;V.pending=V.pending.filter($=>{if($.prefix!==A)return!0;const ne=$.name;if(d.icons[ne])V.loaded.push({provider:T,prefix:A,name:ne});else if(d.missing.has(ne))V.missing.push({provider:T,prefix:A,name:ne});else return E=!0,!0;return!1}),V.pending.length!==X&&(E||gY([d],O.id),O.callback(V.loaded.slice(0),V.missing.slice(0),V.pending.slice(0),O.abort))})}))}let tQ=0;function nQ(d,h,E){const T=tQ++,A=gY.bind(null,E,T);if(!h.pending.length)return A;const O={id:T,icons:h,callback:d,abort:A};return E.forEach(V=>{(V.loaderCallbacks||(V.loaderCallbacks=[])).push(O)}),A}function iQ(d,h=!0,E=!1){const T=[];return d.forEach(A=>{const O=typeof A=="string"?B1(A,h,E):A;O&&T.push(O)}),T}var rQ={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function sQ(d,h,E,T){const A=d.resources.length,O=d.random?Math.floor(Math.random()*A):d.index;let V;if(d.random){let lt=d.resources.slice(0);for(V=[];lt.length>1;){const dt=Math.floor(Math.random()*lt.length);V.push(lt[dt]),lt=lt.slice(0,dt).concat(lt.slice(dt+1))}V=V.concat(lt)}else V=d.resources.slice(O).concat(d.resources.slice(0,O));const X=Date.now();let $="pending",ne=0,le,ae=null,ge=[],je=[];typeof T=="function"&&je.push(T);function Fe(){ae&&(clearTimeout(ae),ae=null)}function we(){$==="pending"&&($="aborted"),Fe(),ge.forEach(lt=>{lt.status==="pending"&&(lt.status="aborted")}),ge=[]}function Ye(lt,dt){dt&&(je=[]),typeof lt=="function"&&je.push(lt)}function Se(){return{startTime:X,payload:h,status:$,queriesSent:ne,queriesPending:ge.length,subscribe:Ye,abort:we}}function ue(){$="failed",je.forEach(lt=>{lt(void 0,le)})}function ve(){ge.forEach(lt=>{lt.status==="pending"&&(lt.status="aborted")}),ge=[]}function tt(lt,dt,Et){const Bt=dt!=="success";switch(ge=ge.filter(Ht=>Ht!==lt),$){case"pending":break;case"failed":if(Bt||!d.dataAfterTimeout)return;break;default:return}if(dt==="abort"){le=Et,ue();return}if(Bt){le=Et,ge.length||(V.length?Rt():ue());return}if(Fe(),ve(),!d.random){const Ht=d.resources.indexOf(lt.resource);Ht!==-1&&Ht!==d.index&&(d.index=Ht)}$="completed",je.forEach(Ht=>{Ht(Et)})}function Rt(){if($!=="pending")return;Fe();const lt=V.shift();if(lt===void 0){if(ge.length){ae=setTimeout(()=>{Fe(),$==="pending"&&(ve(),ue())},d.timeout);return}ue();return}const dt={status:"pending",resource:lt,callback:(Et,Bt)=>{tt(dt,Et,Bt)}};ge.push(dt),ne++,ae=setTimeout(Rt,d.rotate),E(lt,h,dt.callback)}return setTimeout(Rt),Se}function SY(d){const h={...rQ,...d};let E=[];function T(){E=E.filter(X=>X().status==="pending")}function A(X,$,ne){const le=sQ(h,X,$,(ae,ge)=>{T(),ne&&ne(ae,ge)});return E.push(le),le}function O(X){return E.find($=>X($))||null}return{query:A,find:O,setIndex:X=>{h.index=X},getIndex:()=>h.index,cleanup:T}}function A6(){}const MG=Object.create(null);function oQ(d){if(!MG[d]){const h=K4(d);if(!h)return;const E=SY(h),T={config:h,redundancy:E};MG[d]=T}return MG[d]}function aQ(d,h,E){let T,A;if(typeof d=="string"){const O=xW(d);if(!O)return E(void 0,424),A6;A=O.send;const V=oQ(d);V&&(T=V.redundancy)}else{const O=W4(d);if(O){T=SY(O);const V=d.resources?d.resources[0]:"",X=xW(V);X&&(A=X.send)}}return!T||!A?(E(void 0,424),A6):T.query(h,A,E)().abort}const w6="iconify2",mO="iconify",TY=mO+"-count",b6=mO+"-version",CY=36e5,cQ=168;function VW(d,h){try{return d.getItem(h)}catch{}}function Y4(d,h,E){try{return d.setItem(h,E),!0}catch{}}function O6(d,h){try{d.removeItem(h)}catch{}}function FW(d,h){return Y4(d,TY,h.toString())}function jW(d){return parseInt(VW(d,TY))||0}const G1={local:!0,session:!0},vY={local:new Set,session:new Set};let z4=!1;function dQ(d){z4=d}let NL=typeof window>"u"?{}:window;function RY(d){const h=d+"Storage";try{if(NL&&NL[h]&&typeof NL[h].length=="number")return NL[h]}catch{}G1[d]=!1}function yY(d,h){const E=RY(d);if(!E)return;const T=VW(E,b6);if(T!==w6){if(T){const X=jW(E);for(let $=0;$<X;$++)O6(E,mO+$.toString())}Y4(E,b6,w6),FW(E,0);return}const A=Math.floor(Date.now()/CY)-cQ,O=X=>{const $=mO+X.toString(),ne=VW(E,$);if(typeof ne=="string"){try{const le=JSON.parse(ne);if(typeof le=="object"&&typeof le.cached=="number"&&le.cached>A&&typeof le.provider=="string"&&typeof le.data=="object"&&typeof le.data.prefix=="string"&&h(le,X))return!0}catch{}O6(E,$)}};let V=jW(E);for(let X=V-1;X>=0;X--)O(X)||(X===V-1?(V--,FW(E,V)):vY[d].add(X))}function IY(){if(!z4){dQ(!0);for(const d in G1)yY(d,h=>{const E=h.data,T=h.provider,A=E.prefix,O=US(T,A);if(!G4(O,E).length)return!1;const V=E.lastModified||-1;return O.lastModifiedCached=O.lastModifiedCached?Math.min(O.lastModifiedCached,V):V,!0})}}function lQ(d,h){const E=d.lastModifiedCached;if(E&&E>=h)return E===h;if(d.lastModifiedCached=h,E)for(const T in G1)yY(T,A=>{const O=A.data;return A.provider!==d.provider||O.prefix!==d.prefix||O.lastModified===h});return!0}function uQ(d,h){z4||IY();function E(T){let A;if(!G1[T]||!(A=RY(T)))return;const O=vY[T];let V;if(O.size)O.delete(V=Array.from(O).shift());else if(V=jW(A),!FW(A,V+1))return;const X={cached:Math.floor(Date.now()/CY),provider:d.provider,data:h};return Y4(A,mO+V.toString(),JSON.stringify(X))}h.lastModified&&!lQ(d,h.lastModified)||Object.keys(h.icons).length&&(h.not_found&&(h=Object.assign({},h),delete h.not_found),E("local")||E("session"))}function N6(){}function hQ(d){d.iconsLoaderFlag||(d.iconsLoaderFlag=!0,setTimeout(()=>{d.iconsLoaderFlag=!1,eQ(d)}))}function pQ(d,h){d.iconsToLoad?d.iconsToLoad=d.iconsToLoad.concat(h).sort():d.iconsToLoad=h,d.iconsQueueFlag||(d.iconsQueueFlag=!0,setTimeout(()=>{d.iconsQueueFlag=!1;const{provider:E,prefix:T}=d,A=d.iconsToLoad;delete d.iconsToLoad;let O;if(!A||!(O=xW(E)))return;O.prepare(E,T,A).forEach(X=>{aQ(E,X,$=>{if(typeof $!="object")X.icons.forEach(ne=>{d.missing.add(ne)});else try{const ne=G4(d,$);if(!ne.length)return;const le=d.pendingIcons;le&&ne.forEach(ae=>{le.delete(ae)}),uQ(d,$)}catch(ne){console.error(ne)}hQ(d)})})}))}const mQ=(d,h)=>{const E=iQ(d,!0,fY()),T=$X(E);if(!T.pending.length){let $=!0;return h&&setTimeout(()=>{$&&h(T.loaded,T.missing,T.pending,N6)}),()=>{$=!1}}const A=Object.create(null),O=[];let V,X;return T.pending.forEach($=>{const{provider:ne,prefix:le}=$;if(le===X&&ne===V)return;V=ne,X=le,O.push(US(ne,le));const ae=A[ne]||(A[ne]=Object.create(null));ae[le]||(ae[le]=[])}),T.pending.forEach($=>{const{provider:ne,prefix:le,name:ae}=$,ge=US(ne,le),je=ge.pendingIcons||(ge.pendingIcons=new Set);je.has(ae)||(je.add(ae),A[ne][le].push(ae))}),O.forEach($=>{const{provider:ne,prefix:le}=$;A[ne][le].length&&pQ($,A[ne][le])}),h?nQ(h,T,O):N6};function fQ(d,h){const E={...d};for(const T in h){const A=h[T],O=typeof A;T in _Y?(A===null||A&&(O==="string"||O==="number"))&&(E[T]=A):O===typeof E[T]&&(E[T]=T==="rotate"?A%4:A)}return E}const _Q=/[\s,]+/;function EQ(d,h){h.split(_Q).forEach(E=>{switch(E.trim()){case"horizontal":d.hFlip=!0;break;case"vertical":d.vFlip=!0;break}})}function gQ(d,h=0){const E=d.replace(/^-?[0-9.]*/,"");function T(A){for(;A<0;)A+=4;return A%4}if(E===""){const A=parseInt(d);return isNaN(A)?0:T(A)}else if(E!==d){let A=0;switch(E){case"%":A=25;break;case"deg":A=90}if(A){let O=parseFloat(d.slice(0,d.length-E.length));return isNaN(O)?0:(O=O/A,O%1===0?T(O):0)}}return h}function SQ(d,h){let E=d.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const T in h)E+=" "+T+'="'+h[T]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+E+">"+d+"</svg>"}function TQ(d){return d.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function CQ(d){return"data:image/svg+xml,"+TQ(d)}function vQ(d){return'url("'+CQ(d)+'")'}let K0;function RQ(){try{K0=window.trustedTypes.createPolicy("iconify",{createHTML:d=>d})}catch{K0=null}}function yQ(d){return K0===void 0&&RQ(),K0?K0.createHTML(d):d}const AY={...EY,inline:!1},IQ={xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},AQ={display:"inline-block"},BW={backgroundColor:"currentColor"},wY={backgroundColor:"transparent"},D6={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},P6={WebkitMask:BW,mask:BW,background:wY};for(const d in P6){const h=P6[d];for(const E in D6)h[d+E]=D6[E]}const wQ={...AY,inline:!0};function k6(d){return d+(d.match(/^[-0-9.]+$/)?"px":"")}const bQ=(d,h,E,T)=>{const A=E?wQ:AY,O=fQ(A,h),V=h.mode||"svg",X={},$=h.style||{},ne={...V==="svg"?IQ:{},ref:T};for(let Se in h){const ue=h[Se];if(ue!==void 0)switch(Se){case"icon":case"style":case"children":case"onLoad":case"mode":case"_ref":case"_inline":break;case"inline":case"hFlip":case"vFlip":O[Se]=ue===!0||ue==="true"||ue===1;break;case"flip":typeof ue=="string"&&EQ(O,ue);break;case"color":X.color=ue;break;case"rotate":typeof ue=="string"?O[Se]=gQ(ue):typeof ue=="number"&&(O[Se]=ue);break;case"ariaHidden":case"aria-hidden":ue!==!0&&ue!=="true"&&delete ne["aria-hidden"];break;default:A[Se]===void 0&&(ne[Se]=ue)}}const le=FX(d,O),ae=le.attributes;if(O.inline&&(X.verticalAlign="-0.125em"),V==="svg"){ne.style={...X,...$},Object.assign(ne,ae);let Se=0,ue=h.id;return typeof ue=="string"&&(ue=ue.replace(/-/g,"_")),ne.dangerouslySetInnerHTML={__html:yQ(WX(le.body,ue?()=>ue+"ID"+Se++:"iconifyReact"))},xi.createElement("svg",ne)}const{body:ge,width:je,height:Fe}=d,we=V==="mask"||(V==="bg"?!1:ge.indexOf("currentColor")!==-1),Ye=SQ(ge,{...ae,width:je+"",height:Fe+""});return ne.style={...X,"--svg":vQ(Ye),width:k6(ae.width),height:k6(ae.height),...AQ,...we?BW:wY,...$},xi.createElement("span",ne)};fY(!0);HX("",ZX);if(typeof document<"u"&&typeof window<"u"){IY();const d=window;if(d.IconifyPreload!==void 0){const h=d.IconifyPreload,E="Invalid IconifyPreload syntax.";typeof h=="object"&&h!==null&&(h instanceof Array?h:[h]).forEach(T=>{try{(typeof T!="object"||T===null||T instanceof Array||typeof T.icons!="object"||typeof T.prefix!="string"||!MX(T))&&console.error(E)}catch{console.error(E)}})}if(d.IconifyProviders!==void 0){const h=d.IconifyProviders;if(typeof h=="object"&&h!==null)for(let E in h){const T="IconifyProviders["+E+"] is invalid.";try{const A=h[E];if(typeof A!="object"||!A||A.resources===void 0)continue;KX(E,A)||console.error(T)}catch{console.error(T)}}}}class bY extends xi.Component{constructor(h){super(h),this.state={icon:null}}_abortLoading(){this._loading&&(this._loading.abort(),this._loading=null)}_setData(h){this.state.icon!==h&&this.setState({icon:h})}_checkIcon(h){const E=this.state,T=this.props.icon;if(typeof T=="object"&&T!==null&&typeof T.body=="string"){this._icon="",this._abortLoading(),(h||E.icon===null)&&this._setData({data:T});return}let A;if(typeof T!="string"||(A=B1(T,!1,!0))===null){this._abortLoading(),this._setData(null);return}const O=kX(A);if(!O){(!this._loading||this._loading.name!==T)&&(this._abortLoading(),this._icon="",this._setData(null),O!==null&&(this._loading={name:T,abort:mQ([A],this._checkIcon.bind(this,!1))}));return}if(this._icon!==T||E.icon===null){this._abortLoading(),this._icon=T;const V=["iconify"];A.prefix!==""&&V.push("iconify--"+A.prefix),A.provider!==""&&V.push("iconify--"+A.provider),this._setData({data:O,classes:V}),this.props.onLoad&&this.props.onLoad(T)}}componentDidMount(){this._checkIcon(!1)}componentDidUpdate(h){h.icon!==this.props.icon&&this._checkIcon(!0)}componentWillUnmount(){this._abortLoading()}render(){const h=this.props,E=this.state.icon;if(E===null)return h.children?h.children:xi.createElement("span",{});let T=h;return E.classes&&(T={...h,className:(typeof h.className=="string"?h.className+" ":"")+E.classes.join(" ")}),bQ({...B4,...E.data},T,h._inline,h._ref)}}const ss=xi.forwardRef(function(h,E){const T={...h,_ref:E,_inline:!1};return xi.createElement(bY,T)});xi.forwardRef(function(h,E){const T={...h,_ref:E,_inline:!0};return xi.createElement(bY,T)});function OQ(){const[d,h]=Oe.useState("");let E=Zs();const T=()=>{E(`/search?skill=${d}`)};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.searchContainer,children:[F.jsx("input",{className:Ae.searchBar,type:"text",placeholder:"Search for a skill to start learning...",value:d,onChange:A=>h(A.target.value)}),F.jsx(ss,{className:Ae.searchIcon,icon:"material-symbols:search",onClick:T})]})})}function NQ(){return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.infocardContainer,children:[F.jsxs("div",{className:Ae.leftContainer,children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.infoIcon,icon:"healthicons:ui-user-profile-outline"})}),F.jsx("h1",{style:{fontSize:"25px"},children:"Create Your Profile"}),F.jsx("div",{children:F.jsx("p",{children:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis culpa dolor sit atque nostrum incidunt dolorum, possimus sed harum a expedita, fugiat laudantium quas labore iusto. Ut sint nobis odio?"})})]}),F.jsxs("div",{className:Ae.leftContainer,children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.infoIcon,icon:"ant-design:profile-outlined"})}),F.jsx("h1",{style:{fontSize:"25px"},children:"Browse and Connect"}),F.jsx("div",{children:F.jsx("p",{children:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis culpa dolor sit atque nostrum incidunt dolorum, possimus sed harum a expedita, fugiat laudantium quas labore iusto. Ut sint nobis odio?"})})]}),F.jsxs("div",{className:Ae.leftContainer,children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.infoIcon,icon:"material-symbols:partner-exchange-outline-rounded"})}),F.jsx("h1",{style:{fontSize:"25px"},children:"Engage and Exchange"}),F.jsx("div",{children:F.jsx("p",{children:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis culpa dolor sit atque nostrum incidunt dolorum, possimus sed harum a expedita, fugiat laudantium quas labore iusto. Ut sint nobis odio?"})})]})]})})}function L6(){const[d,h]=Oe.useState([]);let E=Zs();return Oe.useEffect(()=>{(async()=>{const O=await(await fetch("https://experienceexchange.onrender.com/post/all",{method:"GET"}).catch(V=>{console.log(V)})).json();console.log(O),h(O)})()},[]),F.jsxs(F.Fragment,{children:[F.jsx("div",{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Unlock Your Potential in Experience Exchange Where Talent Meets Opportunity"}),F.jsx(OQ,{}),F.jsx(NQ,{}),F.jsx("h1",{children:"Check the Latest Posts "})]})}),F.jsx("div",{className:Ae.postsPageMainContainer,children:d.map((T,A)=>F.jsx("div",{children:F.jsx(F.Fragment,{children:F.jsxs("div",{onClick:()=>E(`/posts/${T._id}`),className:Ae.postContainer,children:[F.jsx("div",{style:{display:"flex",margin:"auto",justifyItems:"center"},className:Ae.postTop,children:F.jsxs("div",{style:{textAlign:"center"},className:Ae.postUsername,children:["@",T.creator]})}),F.jsx("div",{children:F.jsx("p",{style:{textAlign:"center",height:"130px",overflow:"auto"},children:T.content})}),F.jsx("hr",{style:{width:"370px"}}),F.jsxs("div",{className:Ae.postFooter,children:[F.jsx("span",{className:Ae.postFooterShowComments,children:"Comments(2)"}),F.jsx("div",{className:Ae.postFooterTag,children:T.tags?T.tags.join(", "):null})]})]})})},A))})]})}function DQ(){let d=Zs();const[h,E]=Oe.useState([]);return Oe.useEffect(()=>{const T=localStorage.getItem("token");T?Qa(T)?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login")):d("/login"),(async()=>{const V=await(await fetch("https://experienceexchange.onrender.com/post/all",{method:"GET"}).catch(X=>{console.log(X)})).json();console.log(V),E(V)})()},[]),F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Recommended Users for you"}),F.jsx("div",{className:Ae.postsPageMainContainer,children:h.map((T,A)=>F.jsx("div",{children:F.jsx(F.Fragment,{children:F.jsxs("div",{onClick:()=>d(`/posts/${T._id}`),style:{cursor:"pointer"},className:Ae.postContainer,children:[F.jsx("div",{className:Ae.postTop,children:F.jsxs("div",{className:Ae.postUsername,style:{textAlign:"center"},children:["@",T.creator]})}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("div",{children:F.jsx("p",{style:{margin:"10px",textAlign:"center",overflowY:"hidden"},children:T.content})}),F.jsxs("div",{style:{flexDirection:"column"},className:Ae.postFooter,children:[F.jsx("hr",{style:{width:"350px"}}),F.jsx("div",{style:{textAlign:"center"},className:Ae.postFooterTag,children:T.tags.join(", ")})]})]})})},A))})]})}function PQ(){return F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Contact Page"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Username: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0}),F.jsx("label",{htmlFor:"text",children:"Email: "}),F.jsx("input",{className:Ae.loginInput,type:"email",required:!0}),F.jsx("label",{htmlFor:"text",children:"Message: "}),F.jsx("textarea",{className:Ae.contactMessage,name:"message",id:"message",cols:"40",rows:"10",required:!0}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,children:"Send Message"})]})})]})}function kQ(){return F.jsx(F.Fragment,{children:F.jsx("h1",{style:{textAlign:"center"},children:"Hello World"})})}function LQ(){let d=Zs();const[h,E]=Oe.useState(""),[T,A]=Oe.useState(""),[O,V]=Oe.useState(""),[X,$]=Oe.useState(""),[ne,le]=Oe.useState(!1),ae=async ge=>{if(ge.preventDefault(),le(!0),O==X){const Fe=await(await fetch("https://experienceexchange.onrender.com/user/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:h,email:T,password:O,confpass:X})}).catch(we=>{console.log(we)})).json();console.log(Fe),Fe.status===200?(console.log("Register Successful"),Tn.success("Register Success!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{d("/login")},2e3)):(console.log("Failed to Register"),Tn.error(Fe.data,{position:"top-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}))}else Tn.error("Passwords doesn't match!",{position:"top-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),le(!1)};return F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Register Page"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{onSubmit:ae,className:Ae.registerFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Username: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,value:h,onChange:ge=>{E(ge.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Email: "}),F.jsx("input",{className:Ae.loginInput,type:"email",required:!0,value:T,onChange:ge=>{A(ge.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Password: "}),F.jsx("input",{className:Ae.loginInput,type:"password",pattern:"(?=.*\\d)(?=.*[a-z])(?=.*[A-Z]).{8,}",title:"Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters",required:!0,value:O,onChange:ge=>{V(ge.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Confirm Password: "}),F.jsx("input",{className:Ae.loginInput,type:"password",required:!0,value:X,onChange:ge=>{$(ge.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,disabled:ne,children:"Register"}),F.jsx("a",{className:Ae.registerForgot,href:"/login",children:"Already have an account?"})]})})]})}function MQ(){const[d,h]=Oe.useState(""),[E,T]=Oe.useState(""),[A,O]=Oe.useState(!1),V=async $=>{$.preventDefault(),O(!0);const le=await(await fetch("https://experienceexchange.onrender.com/user/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:d,password:E})}).catch(ae=>{console.log(ae)})).json();console.log(le),le.token?(localStorage.setItem("token",le.token),console.log("Login Successful"),Tn.success("Login Success!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{window.location.href="/userdashboard"},2e3)):(console.log(),Tn.error(le.data,{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),O(!1))},X=async $=>{$.preventDefault()};return F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Login Page"}),F.jsx("div",{className:Ae.loginContainer,children:F.jsxs("form",{onSubmit:V,className:Ae.loginFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Username: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,value:d,onChange:$=>{h($.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Password: "}),F.jsx("input",{className:Ae.loginInput,type:"password",required:!0,value:E,onChange:$=>{T($.target.value)}}),F.jsx("a",{className:Ae.loginForgot,href:"/reset",children:"Forgot password?"}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,disabled:A,children:"Login"}),F.jsx("a",{className:Ae.loginForgot,href:"/register",children:"Don't have an account?"}),F.jsxs("div",{style:{display:"flex",height:"30px",fontSize:"small",backgroundColor:"rgb(39, 62, 110)",color:"white",justifyContent:"center",alignItems:"center"},className:Ae.loginButton,onClick:$=>X($),children:[F.jsx("span",{style:{textAlign:"center"},children:"Face Recognition Login"}),F.jsx(ss,{icon:"tabler:face-id",style:{width:"40px",height:"40px",color:"white"}})]})]})})]})}/**
 * @license agora-rtc-react
 * @version 2.1.0
 *
 * Copyright (c) Agora, Inc.
 *
 * This source code is licensed under the MIT license.
 */var UQ=Object.create,q4=Object.defineProperty,xQ=Object.getOwnPropertyDescriptor,VQ=Object.getOwnPropertyNames,FQ=Object.getPrototypeOf,jQ=Object.prototype.hasOwnProperty,BQ=(d,h)=>()=>(h||d((h={exports:{}}).exports,h),h.exports),GQ=(d,h)=>{for(var E in h)q4(d,E,{get:h[E],enumerable:!0})},OY=(d,h,E,T)=>{if(h&&typeof h=="object"||typeof h=="function")for(let A of VQ(h))!jQ.call(d,A)&&A!==E&&q4(d,A,{get:()=>h[A],enumerable:!(T=xQ(h,A))||T.enumerable});return d},WQ=(d,h,E)=>(OY(d,h,"default"),E),jS=(d,h,E)=>(E=d!=null?UQ(FQ(d)):{},OY(!d||!d.__esModule?q4(E,"default",{value:d,enumerable:!0}):E,d)),BS=BQ((d,h)=>{(function(E,T){typeof d=="object"&&typeof h<"u"?h.exports=T():typeof define=="function"&&define.amd?define(T):(E=typeof globalThis<"u"?globalThis:E||self).AgoraRTC=T()})(d,function(){function E(s,t){return t.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(a){if(a!=="default"&&!(a in s)){var l=Object.getOwnPropertyDescriptor(i,a);Object.defineProperty(s,a,l.get?l:{enumerable:!0,get:function(){return i[a]}})}})}),Object.freeze(s)}var T=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function A(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var O=function(s){try{return!!s()}catch{return!0}},V=!O(function(){var s=(function(){}).bind();return typeof s!="function"||s.hasOwnProperty("prototype")}),X=V,$=Function.prototype,ne=$.call,le=X&&$.bind.bind(ne,ne),ae=X?le:function(s){return function(){return ne.apply(s,arguments)}},ge=ae({}.isPrototypeOf),je=function(s){return s&&s.Math==Math&&s},Fe=je(typeof globalThis=="object"&&globalThis)||je(typeof window=="object"&&window)||je(typeof self=="object"&&self)||je(typeof T=="object"&&T)||function(){return this}()||T||Function("return this")(),we=V,Ye=Function.prototype,Se=Ye.apply,ue=Ye.call,ve=typeof Reflect=="object"&&Reflect.apply||(we?ue.bind(Se):function(){return ue.apply(Se,arguments)}),tt=ae,Rt=tt({}.toString),lt=tt("".slice),dt=function(s){return lt(Rt(s),8,-1)},Et=dt,Bt=ae,Ht=function(s){if(Et(s)==="Function")return Bt(s)},rr=typeof document=="object"&&document.all,Fr={all:rr,IS_HTMLDDA:rr===void 0&&rr!==void 0},vn=Fr.all,Ft=Fr.IS_HTMLDDA?function(s){return typeof s=="function"||s===vn}:function(s){return typeof s=="function"},as={},ii=!O(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),Os=V,Ot=Function.prototype.call,Nt=Os?Ot.bind(Ot):function(){return Ot.apply(Ot,arguments)},cn={},Vi={}.propertyIsEnumerable,Fi=Object.getOwnPropertyDescriptor,$s=Fi&&!Vi.call({1:2},1);cn.f=$s?function(s){var t=Fi(this,s);return!!t&&t.enumerable}:Vi;var yi,gs,sr=function(s,t){return{enumerable:!(1&s),configurable:!(2&s),writable:!(4&s),value:t}},Uc=O,Jv=dt,A_=Object,Y1=ae("".split),Pm=Uc(function(){return!A_("z").propertyIsEnumerable(0)})?function(s){return Jv(s)=="String"?Y1(s,""):A_(s)}:A_,zh=function(s){return s==null},z1=zh,q1=TypeError,Ul=function(s){if(z1(s))throw q1("Can't call method on "+s);return s},J1=Pm,X1=Ul,Za=function(s){return J1(X1(s))},Xv=Ft,Q1=Fr.all,qr=Fr.IS_HTMLDDA?function(s){return typeof s=="object"?s!==null:Xv(s)||s===Q1}:function(s){return typeof s=="object"?s!==null:Xv(s)},po={},w_=po,b_=Fe,Z1=Ft,Qv=function(s){return Z1(s)?s:void 0},hr=function(s,t){return arguments.length<2?Qv(w_[s])||Qv(b_[s]):w_[s]&&w_[s][t]||b_[s]&&b_[s][t]},$a=typeof navigator<"u"&&String(navigator.userAgent)||"",Zv=Fe,O_=$a,$v=Zv.process,eR=Zv.Deno,tR=$v&&$v.versions||eR&&eR.version,nR=tR&&tR.v8;nR&&(gs=(yi=nR.split("."))[0]>0&&yi[0]<4?1:+(yi[0]+yi[1])),!gs&&O_&&(!(yi=O_.match(/Edge\/(\d+)/))||yi[1]>=74)&&(yi=O_.match(/Chrome\/(\d+)/))&&(gs=+yi[1]);var ec=gs,iR=ec,$1=O,eM=Fe.String,pd=!!Object.getOwnPropertySymbols&&!$1(function(){var s=Symbol();return!eM(s)||!(Object(s)instanceof Symbol)||!Symbol.sham&&iR&&iR<41}),rR=pd&&!Symbol.sham&&typeof Symbol.iterator=="symbol",tM=hr,nM=Ft,iM=ge,rM=Object,xl=rR?function(s){return typeof s=="symbol"}:function(s){var t=tM("Symbol");return nM(t)&&iM(t.prototype,rM(s))},sM=String,md=function(s){try{return sM(s)}catch{return"Object"}},oM=Ft,aM=md,cM=TypeError,cs=function(s){if(oM(s))return s;throw cM(aM(s)+" is not a function")},dM=cs,lM=zh,N_=function(s,t){var i=s[t];return lM(i)?void 0:dM(i)},sR=Nt,oR=Ft,aR=qr,uM=TypeError,cR={exports:{}},dR=Fe,hM=Object.defineProperty,pM=function(s,t){try{hM(dR,s,{value:t,configurable:!0,writable:!0})}catch{dR[s]=t}return t},lR="__core-js_shared__",D_=Fe[lR]||pM(lR,{}),uR=D_;(cR.exports=function(s,t){return uR[s]||(uR[s]=t!==void 0?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var fd=cR.exports,mM=Ul,fM=Object,Oo=function(s){return fM(mM(s))},_M=Oo,EM=ae({}.hasOwnProperty),ji=Object.hasOwn||function(s,t){return EM(_M(s),t)},gM=ae,SM=0,TM=Math.random(),CM=gM(1 .toString),P_=function(s){return"Symbol("+(s===void 0?"":s)+")_"+CM(++SM+TM,36)},vM=fd,hR=ji,RM=P_,yM=pd,IM=rR,_d=Fe.Symbol,k_=vM("wks"),AM=IM?_d.for||_d:_d&&_d.withoutSetter||RM,wn=function(s){return hR(k_,s)||(k_[s]=yM&&hR(_d,s)?_d[s]:AM("Symbol."+s)),k_[s]},wM=Nt,pR=qr,mR=xl,bM=N_,OM=function(s,t){var i,a;if(oR(i=s.toString)&&!aR(a=sR(i,s))||oR(i=s.valueOf)&&!aR(a=sR(i,s))||t!=="string")return a;throw uM("Can't convert object to primitive value")},NM=TypeError,DM=wn("toPrimitive"),PM=function(s,t){if(!pR(s)||mR(s))return s;var i,a=bM(s,DM);if(a){if(i=wM(a,s,t),!pR(i)||mR(i))return i;throw NM("Can't convert object to primitive value")}return OM(s,t)},kM=xl,qh=function(s){var t=PM(s,"string");return kM(t)?t:t+""},fR=qr,L_=Fe.document,LM=fR(L_)&&fR(L_.createElement),M_=function(s){return LM?L_.createElement(s):{}},MM=M_,_R=!ii&&!O(function(){return Object.defineProperty(MM("div"),"a",{get:function(){return 7}}).a!=7}),UM=ii,xM=Nt,VM=cn,FM=sr,jM=Za,BM=qh,GM=ji,WM=_R,ER=Object.getOwnPropertyDescriptor;as.f=UM?ER:function(s,t){if(s=jM(s),t=BM(t),WM)try{return ER(s,t)}catch{}if(GM(s,t))return FM(!xM(VM.f,s,t),s[t])};var HM=O,KM=Ft,YM=/#|\.prototype\./,Vl=function(s,t){var i=qM[zM(s)];return i==XM||i!=JM&&(KM(t)?HM(t):!!t)},zM=Vl.normalize=function(s){return String(s).replace(YM,".").toLowerCase()},qM=Vl.data={},JM=Vl.NATIVE="N",XM=Vl.POLYFILL="P",gR=Vl,QM=cs,ZM=V,$M=Ht(Ht.bind),xc=function(s,t){return QM(s),t===void 0?s:ZM?$M(s,t):function(){return s.apply(t,arguments)}},ds={},SR=ii&&O(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),eU=qr,tU=String,nU=TypeError,ls=function(s){if(eU(s))return s;throw nU(tU(s)+" is not an object")},iU=ii,rU=_R,sU=SR,Jh=ls,TR=qh,oU=TypeError,U_=Object.defineProperty,aU=Object.getOwnPropertyDescriptor,x_="enumerable",V_="configurable",F_="writable";ds.f=iU?sU?function(s,t,i){if(Jh(s),t=TR(t),Jh(i),typeof s=="function"&&t==="prototype"&&"value"in i&&F_ in i&&!i[F_]){var a=aU(s,t);a&&a[F_]&&(s[t]=i.value,i={configurable:V_ in i?i[V_]:a[V_],enumerable:x_ in i?i[x_]:a[x_],writable:!1})}return U_(s,t,i)}:U_:function(s,t,i){if(Jh(s),t=TR(t),Jh(i),rU)try{return U_(s,t,i)}catch{}if("get"in i||"set"in i)throw oU("Accessors not supported");return"value"in i&&(s[t]=i.value),s};var cU=ds,dU=sr,ra=ii?function(s,t,i){return cU.f(s,t,dU(1,i))}:function(s,t,i){return s[t]=i,s},Xh=Fe,lU=ve,uU=Ht,hU=Ft,pU=as.f,mU=gR,Ed=po,fU=xc,gd=ra,CR=ji,_U=function(s){var t=function(i,a,l){if(this instanceof t){switch(arguments.length){case 0:return new s;case 1:return new s(i);case 2:return new s(i,a)}return new s(i,a,l)}return lU(s,this,arguments)};return t.prototype=s.prototype,t},Xt=function(s,t){var i,a,l,p,f,g,v,y,I,b=s.target,k=s.global,U=s.stat,J=s.proto,K=k?Xh:U?Xh[b]:(Xh[b]||{}).prototype,q=k?Ed:Ed[b]||gd(Ed,b,{})[b],te=q.prototype;for(p in t)a=!(i=mU(k?p:b+(U?".":"#")+p,s.forced))&&K&&CR(K,p),g=q[p],a&&(v=s.dontCallGetSet?(I=pU(K,p))&&I.value:K[p]),f=a&&v?v:t[p],a&&typeof g==typeof f||(y=s.bind&&a?fU(f,Xh):s.wrap&&a?_U(f):J&&hU(f)?uU(f):f,(s.sham||f&&f.sham||g&&g.sham)&&gd(y,"sham",!0),gd(q,p,y),J&&(CR(Ed,l=b+"Prototype")||gd(Ed,l,{}),gd(Ed[l],p,f),s.real&&te&&(i||!te[p])&&gd(te,p,f)))},EU=Math.ceil,gU=Math.floor,SU=Math.trunc||function(s){var t=+s;return(t>0?gU:EU)(t)},j_=function(s){var t=+s;return t!=t||t===0?0:SU(t)},TU=j_,CU=Math.max,vU=Math.min,vR=function(s,t){var i=TU(s);return i<0?CU(i+t,0):vU(i,t)},RU=j_,yU=Math.min,IU=function(s){return s>0?yU(RU(s),9007199254740991):0},Da=function(s){return IU(s.length)},AU=Za,wU=vR,bU=Da,RR=function(s){return function(t,i,a){var l,p=AU(t),f=bU(p),g=wU(a,f);if(s&&i!=i){for(;f>g;)if((l=p[g++])!=l)return!0}else for(;f>g;g++)if((s||g in p)&&p[g]===i)return s||g||0;return!s&&-1}},B_={includes:RR(!0),indexOf:RR(!1)},OU=B_.includes;Xt({target:"Array",proto:!0,forced:O(function(){return!Array(1).includes()})},{includes:function(s){return OU(this,s,arguments.length>1?arguments[1]:void 0)}});var NU=po,sa=function(s){return NU[s+"Prototype"]},DU=sa("Array").includes,PU=qr,kU=dt,LU=wn("match"),MU=function(s){var t;return PU(s)&&((t=s[LU])!==void 0?!!t:kU(s)=="RegExp")},UU=TypeError,yR={};yR[wn("toStringTag")]="z";var G_=String(yR)==="[object z]",xU=G_,VU=Ft,Qh=dt,FU=wn("toStringTag"),jU=Object,BU=Qh(function(){return arguments}())=="Arguments",Pa=xU?Qh:function(s){var t,i,a;return s===void 0?"Undefined":s===null?"Null":typeof(i=function(l,p){try{return l[p]}catch{}}(t=jU(s),FU))=="string"?i:BU?Qh(t):(a=Qh(t))=="Object"&&VU(t.callee)?"Arguments":a},GU=Pa,WU=String,Bs=function(s){if(GU(s)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return WU(s)},HU=wn("match"),KU=Xt,YU=function(s){if(MU(s))throw UU("The method doesn't accept regular expressions");return s},zU=Ul,IR=Bs,qU=function(s){var t=/./;try{"/./"[s](t)}catch{try{return t[HU]=!1,"/./"[s](t)}catch{}}return!1},JU=ae("".indexOf);KU({target:"String",proto:!0,forced:!qU("includes")},{includes:function(s){return!!~JU(IR(zU(this)),IR(YU(s)),arguments.length>1?arguments[1]:void 0)}});var XU=sa("String").includes,AR=ge,QU=DU,ZU=XU,W_=Array.prototype,H_=String.prototype,xe=A(function(s){var t=s.includes;return s===W_||AR(W_,s)&&t===W_.includes?QU:typeof s=="string"||s===H_||AR(H_,s)&&t===H_.includes?ZU:t});let wR=!0,bR=!0;function Zh(s,t,i){let a=s.match(t);return a&&a.length>=i&&parseInt(a[i],10)}function tc(s,t,i){if(!s.RTCPeerConnection)return;let a=s.RTCPeerConnection.prototype,l=a.addEventListener;a.addEventListener=function(f,g){if(f!==t)return l.apply(this,arguments);let v=y=>{let I=i(y);I&&(g.handleEvent?g.handleEvent(I):g(I))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(g,v),l.apply(this,[f,v])};let p=a.removeEventListener;a.removeEventListener=function(f,g){if(f!==t||!this._eventMap||!this._eventMap[t])return p.apply(this,arguments);if(!this._eventMap[t].has(g))return p.apply(this,arguments);let v=this._eventMap[t].get(g);return this._eventMap[t].delete(g),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,p.apply(this,[f,v])},Object.defineProperty(a,"on"+t,{get(){return this["_on"+t]},set(f){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),f&&this.addEventListener(t,this["_on"+t]=f)},enumerable:!0,configurable:!0})}function $U(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(wR=s,s?"adapter.js logging disabled":"adapter.js logging enabled")}function ex(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(bR=!s,"adapter.js deprecation warnings "+(s?"disabled":"enabled"))}function OR(){if(typeof window=="object"){if(wR)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function K_(s,t){bR&&console.warn(s+" is deprecated, please use "+t+" instead.")}function NR(s){return Object.prototype.toString.call(s)==="[object Object]"}function DR(s){return NR(s)?Object.keys(s).reduce(function(t,i){let a=NR(s[i]),l=a?DR(s[i]):s[i],p=a&&!Object.keys(l).length;return l===void 0||p?t:Object.assign(t,{[i]:l})},{}):s}function Y_(s,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach(a=>{a.endsWith("Id")?Y_(s,s.get(t[a]),i):a.endsWith("Ids")&&t[a].forEach(l=>{Y_(s,s.get(l),i)})}))}function PR(s,t,i){let a=i?"outbound-rtp":"inbound-rtp",l=new Map;if(t===null)return l;let p=[];return s.forEach(f=>{f.type==="track"&&f.trackIdentifier===t.id&&p.push(f)}),p.forEach(f=>{s.forEach(g=>{g.type===a&&g.trackId===f.id&&Y_(s,g,l)})}),l}let kR=OR;function LR(s,t){let i=s&&s.navigator;if(!i.mediaDevices)return;let a=function(f){if(typeof f!="object"||f.mandatory||f.optional)return f;let g={};return Object.keys(f).forEach(v=>{if(v==="require"||v==="advanced"||v==="mediaSource")return;let y=typeof f[v]=="object"?f[v]:{ideal:f[v]};y.exact!==void 0&&typeof y.exact=="number"&&(y.min=y.max=y.exact);let I=function(b,k){return b?b+k.charAt(0).toUpperCase()+k.slice(1):k==="deviceId"?"sourceId":k};if(y.ideal!==void 0){g.optional=g.optional||[];let b={};typeof y.ideal=="number"?(b[I("min",v)]=y.ideal,g.optional.push(b),b={},b[I("max",v)]=y.ideal,g.optional.push(b)):(b[I("",v)]=y.ideal,g.optional.push(b))}y.exact!==void 0&&typeof y.exact!="number"?(g.mandatory=g.mandatory||{},g.mandatory[I("",v)]=y.exact):["min","max"].forEach(b=>{y[b]!==void 0&&(g.mandatory=g.mandatory||{},g.mandatory[I(b,v)]=y[b])})}),f.advanced&&(g.optional=(g.optional||[]).concat(f.advanced)),g},l=function(f,g){if(t.version>=61)return g(f);if((f=JSON.parse(JSON.stringify(f)))&&typeof f.audio=="object"){let v=function(y,I,b){I in y&&!(b in y)&&(y[b]=y[I],delete y[I])};v((f=JSON.parse(JSON.stringify(f))).audio,"autoGainControl","googAutoGainControl"),v(f.audio,"noiseSuppression","googNoiseSuppression"),f.audio=a(f.audio)}if(f&&typeof f.video=="object"){let v=f.video.facingMode;v=v&&(typeof v=="object"?v:{ideal:v});let y=t.version<66;if(v&&(v.exact==="user"||v.exact==="environment"||v.ideal==="user"||v.ideal==="environment")&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||y)){let I;if(delete f.video.facingMode,v.exact==="environment"||v.ideal==="environment"?I=["back","rear"]:v.exact!=="user"&&v.ideal!=="user"||(I=["front"]),I)return i.mediaDevices.enumerateDevices().then(b=>{let k=(b=b.filter(U=>U.kind==="videoinput")).find(U=>I.some(J=>U.label.toLowerCase().includes(J)));return!k&&b.length&&I.includes("back")&&(k=b[b.length-1]),k&&(f.video.deviceId=v.exact?{exact:k.deviceId}:{ideal:k.deviceId}),f.video=a(f.video),kR("chrome: "+JSON.stringify(f)),g(f)})}f.video=a(f.video)}return kR("chrome: "+JSON.stringify(f)),g(f)},p=function(f){return t.version>=64?f:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[f.name]||f.name,message:f.message,constraint:f.constraint||f.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=(function(f,g,v){l(f,y=>{i.webkitGetUserMedia(y,g,I=>{v&&v(p(I))})})}).bind(i),i.mediaDevices.getUserMedia){let f=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(g){return l(g,v=>f(v).then(y=>{if(v.audio&&!y.getAudioTracks().length||v.video&&!y.getVideoTracks().length)throw y.getTracks().forEach(I=>{I.stop()}),new DOMException("","NotFoundError");return y},y=>Promise.reject(p(y))))}}}function MR(s){s.MediaStream=s.MediaStream||s.webkitMediaStream}function UR(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("ontrack"in s.RTCPeerConnection.prototype)){Object.defineProperty(s.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});let t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",a=>{let l;l=s.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(f=>f.track&&f.track.id===a.track.id):{track:a.track};let p=new Event("track");p.track=a.track,p.receiver=l,p.transceiver={receiver:l},p.streams=[i.stream],this.dispatchEvent(p)}),i.stream.getTracks().forEach(a=>{let l;l=s.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(f=>f.track&&f.track.id===a.id):{track:a};let p=new Event("track");p.track=a,p.receiver=l,p.transceiver={receiver:l},p.streams=[i.stream],this.dispatchEvent(p)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else tc(s,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function xR(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("getSenders"in s.RTCPeerConnection.prototype)&&"createDTMFSender"in s.RTCPeerConnection.prototype){let t=function(l,p){return{track:p,get dtmf(){return this._dtmf===void 0&&(p.kind==="audio"?this._dtmf=l.createDTMFSender(p):this._dtmf=null),this._dtmf},_pc:l}};if(!s.RTCPeerConnection.prototype.getSenders){s.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let l=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(f,g){let v=l.apply(this,arguments);return v||(v=t(this,f),this._senders.push(v)),v};let p=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(f){p.apply(this,arguments);let g=this._senders.indexOf(f);g!==-1&&this._senders.splice(g,1)}}let i=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(l){this._senders=this._senders||[],i.apply(this,[l]),l.getTracks().forEach(p=>{this._senders.push(t(this,p))})};let a=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(l){this._senders=this._senders||[],a.apply(this,[l]),l.getTracks().forEach(p=>{let f=this._senders.find(g=>g.track===p);f&&this._senders.splice(this._senders.indexOf(f),1)})}}else if(typeof s=="object"&&s.RTCPeerConnection&&"getSenders"in s.RTCPeerConnection.prototype&&"createDTMFSender"in s.RTCPeerConnection.prototype&&s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)){let t=s.RTCPeerConnection.prototype.getSenders;s.RTCPeerConnection.prototype.getSenders=function(){let i=t.apply(this,[]);return i.forEach(a=>a._pc=this),i},Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function VR(s){if(!s.RTCPeerConnection)return;let t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){let[i,a,l]=arguments;if(arguments.length>0&&typeof i=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof i!="function"))return t.apply(this,[]);let p=function(g){let v={};return g.result().forEach(y=>{let I={id:y.id,timestamp:y.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[y.type]||y.type};y.names().forEach(b=>{I[b]=y.stat(b)}),v[I.id]=I}),v},f=function(g){return new Map(Object.keys(g).map(v=>[v,g[v]]))};if(arguments.length>=2){let g=function(v){a(f(p(v)))};return t.apply(this,[g,i])}return new Promise((g,v)=>{t.apply(this,[function(y){g(f(p(y)))},v])}).then(a,l)}}function FR(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender&&s.RTCRtpReceiver))return;if(!("getStats"in s.RTCRtpSender.prototype)){let i=s.RTCPeerConnection.prototype.getSenders;i&&(s.RTCPeerConnection.prototype.getSenders=function(){let l=i.apply(this,[]);return l.forEach(p=>p._pc=this),l});let a=s.RTCPeerConnection.prototype.addTrack;a&&(s.RTCPeerConnection.prototype.addTrack=function(){let l=a.apply(this,arguments);return l._pc=this,l}),s.RTCRtpSender.prototype.getStats=function(){let l=this;return this._pc.getStats().then(p=>PR(p,l.track,!0))}}if(!("getStats"in s.RTCRtpReceiver.prototype)){let i=s.RTCPeerConnection.prototype.getReceivers;i&&(s.RTCPeerConnection.prototype.getReceivers=function(){let a=i.apply(this,[]);return a.forEach(l=>l._pc=this),a}),tc(s,"track",a=>(a.receiver._pc=a.srcElement,a)),s.RTCRtpReceiver.prototype.getStats=function(){let a=this;return this._pc.getStats().then(l=>PR(l,a.track,!1))}}if(!("getStats"in s.RTCRtpSender.prototype)||!("getStats"in s.RTCRtpReceiver.prototype))return;let t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof s.MediaStreamTrack){let i=arguments[0],a,l,p;return this.getSenders().forEach(f=>{f.track===i&&(a?p=!0:a=f)}),this.getReceivers().forEach(f=>(f.track===i&&(l?p=!0:l=f),f.track===i)),p||a&&l?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):a?a.getStats():l?l.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function jR(s){s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(p=>this._shimmedLocalStreams[p][0])};let t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(p,f){if(!f)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let g=t.apply(this,arguments);return this._shimmedLocalStreams[f.id]?this._shimmedLocalStreams[f.id].indexOf(g)===-1&&this._shimmedLocalStreams[f.id].push(g):this._shimmedLocalStreams[f.id]=[f,g],g};let i=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(p){this._shimmedLocalStreams=this._shimmedLocalStreams||{},p.getTracks().forEach(v=>{if(this.getSenders().find(y=>y.track===v))throw new DOMException("Track already exists.","InvalidAccessError")});let f=this.getSenders();i.apply(this,arguments);let g=this.getSenders().filter(v=>f.indexOf(v)===-1);this._shimmedLocalStreams[p.id]=[p].concat(g)};let a=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(p){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[p.id],a.apply(this,arguments)};let l=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(p){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},p&&Object.keys(this._shimmedLocalStreams).forEach(f=>{let g=this._shimmedLocalStreams[f].indexOf(p);g!==-1&&this._shimmedLocalStreams[f].splice(g,1),this._shimmedLocalStreams[f].length===1&&delete this._shimmedLocalStreams[f]}),l.apply(this,arguments)}}function BR(s,t){if(!s.RTCPeerConnection)return;if(s.RTCPeerConnection.prototype.addTrack&&t.version>=65)return jR(s);let i=s.RTCPeerConnection.prototype.getLocalStreams;s.RTCPeerConnection.prototype.getLocalStreams=function(){let v=i.apply(this);return this._reverseStreams=this._reverseStreams||{},v.map(y=>this._reverseStreams[y.id])};let a=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(v){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},v.getTracks().forEach(y=>{if(this.getSenders().find(I=>I.track===y))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[v.id]){let y=new s.MediaStream(v.getTracks());this._streams[v.id]=y,this._reverseStreams[y.id]=v,v=y}a.apply(this,[v])};let l=s.RTCPeerConnection.prototype.removeStream;function p(v,y){let I=y.sdp;return Object.keys(v._reverseStreams||[]).forEach(b=>{let k=v._reverseStreams[b],U=v._streams[k.id];I=I.replace(new RegExp(U.id,"g"),k.id)}),new RTCSessionDescription({type:y.type,sdp:I})}s.RTCPeerConnection.prototype.removeStream=function(v){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},l.apply(this,[this._streams[v.id]||v]),delete this._reverseStreams[this._streams[v.id]?this._streams[v.id].id:v.id],delete this._streams[v.id]},s.RTCPeerConnection.prototype.addTrack=function(v,y){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let I=[].slice.call(arguments,1);if(I.length!==1||!I[0].getTracks().find(k=>k===v))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(k=>k.track===v))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let b=this._streams[y.id];if(b)b.addTrack(v),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let k=new s.MediaStream([v]);this._streams[y.id]=k,this._reverseStreams[k.id]=y,this.addStream(k)}return this.getSenders().find(k=>k.track===v)},["createOffer","createAnswer"].forEach(function(v){let y=s.RTCPeerConnection.prototype[v],I={[v](){let b=arguments;return arguments.length&&typeof arguments[0]=="function"?y.apply(this,[k=>{let U=p(this,k);b[0].apply(null,[U])},k=>{b[1]&&b[1].apply(null,k)},arguments[2]]):y.apply(this,arguments).then(k=>p(this,k))}};s.RTCPeerConnection.prototype[v]=I[v]});let f=s.RTCPeerConnection.prototype.setLocalDescription;s.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(v,y){let I=y.sdp;return Object.keys(v._reverseStreams||[]).forEach(b=>{let k=v._reverseStreams[b],U=v._streams[k.id];I=I.replace(new RegExp(k.id,"g"),U.id)}),new RTCSessionDescription({type:y.type,sdp:I})}(this,arguments[0]),f.apply(this,arguments)):f.apply(this,arguments)};let g=Object.getOwnPropertyDescriptor(s.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(s.RTCPeerConnection.prototype,"localDescription",{get(){let v=g.get.apply(this);return v.type===""?v:p(this,v)}}),s.RTCPeerConnection.prototype.removeTrack=function(v){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!v._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(v._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let y;this._streams=this._streams||{},Object.keys(this._streams).forEach(I=>{this._streams[I].getTracks().find(b=>v.track===b)&&(y=this._streams[I])}),y&&(y.getTracks().length===1?this.removeStream(this._reverseStreams[y.id]):y.removeTrack(v.track),this.dispatchEvent(new Event("negotiationneeded")))}}function z_(s,t){!s.RTCPeerConnection&&s.webkitRTCPeerConnection&&(s.RTCPeerConnection=s.webkitRTCPeerConnection),s.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){let a=s.RTCPeerConnection.prototype[i],l={[i](){return arguments[0]=new(i==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}};s.RTCPeerConnection.prototype[i]=l[i]})}function GR(s,t){tc(s,"negotiationneeded",i=>{let a=i.target;if(!(t.version<72||a.getConfiguration&&a.getConfiguration().sdpSemantics==="plan-b")||a.signalingState==="stable")return i})}var WR=Object.freeze({__proto__:null,fixNegotiationNeeded:GR,shimAddTrackRemoveTrack:BR,shimAddTrackRemoveTrackWithNative:jR,shimGetDisplayMedia:function(s,t){s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||s.navigator.mediaDevices&&(typeof t=="function"?s.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(a=>{let l=i.video&&i.video.width,p=i.video&&i.video.height,f=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a,maxFrameRate:f||3}},l&&(i.video.mandatory.maxWidth=l),p&&(i.video.mandatory.maxHeight=p),s.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:xR,shimGetStats:VR,shimGetUserMedia:LR,shimMediaStream:MR,shimOnTrack:UR,shimPeerConnection:z_,shimSenderReceiverGetStats:FR});function HR(s,t){let i=s&&s.navigator,a=s&&s.MediaStreamTrack;if(i.getUserMedia=function(l,p,f){K_("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(l).then(p,f)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){let l=function(f,g,v){g in f&&!(v in f)&&(f[v]=f[g],delete f[g])},p=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(f){return typeof f=="object"&&typeof f.audio=="object"&&(f=JSON.parse(JSON.stringify(f)),l(f.audio,"autoGainControl","mozAutoGainControl"),l(f.audio,"noiseSuppression","mozNoiseSuppression")),p(f)},a&&a.prototype.getSettings){let f=a.prototype.getSettings;a.prototype.getSettings=function(){let g=f.apply(this,arguments);return l(g,"mozAutoGainControl","autoGainControl"),l(g,"mozNoiseSuppression","noiseSuppression"),g}}if(a&&a.prototype.applyConstraints){let f=a.prototype.applyConstraints;a.prototype.applyConstraints=function(g){return this.kind==="audio"&&typeof g=="object"&&(g=JSON.parse(JSON.stringify(g)),l(g,"autoGainControl","mozAutoGainControl"),l(g,"noiseSuppression","mozNoiseSuppression")),f.apply(this,[g])}}}}function KR(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function q_(s,t){if(typeof s!="object"||!s.RTCPeerConnection&&!s.mozRTCPeerConnection)return;!s.RTCPeerConnection&&s.mozRTCPeerConnection&&(s.RTCPeerConnection=s.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(l){let p=s.RTCPeerConnection.prototype[l],f={[l](){return arguments[0]=new(l==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),p.apply(this,arguments)}};s.RTCPeerConnection.prototype[l]=f[l]});let i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},a=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){let[l,p,f]=arguments;return a.apply(this,[l||null]).then(g=>{if(t.version<53&&!p)try{g.forEach(v=>{v.type=i[v.type]||v.type})}catch(v){if(v.name!=="TypeError")throw v;g.forEach((y,I)=>{g.set(I,Object.assign({},y,{type:i[y.type]||y.type}))})}return g}).then(p,f)}}function YR(s){if(typeof s!="object"||!s.RTCPeerConnection||!s.RTCRtpSender||s.RTCRtpSender&&"getStats"in s.RTCRtpSender.prototype)return;let t=s.RTCPeerConnection.prototype.getSenders;t&&(s.RTCPeerConnection.prototype.getSenders=function(){let a=t.apply(this,[]);return a.forEach(l=>l._pc=this),a});let i=s.RTCPeerConnection.prototype.addTrack;i&&(s.RTCPeerConnection.prototype.addTrack=function(){let a=i.apply(this,arguments);return a._pc=this,a}),s.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function zR(s){if(typeof s!="object"||!s.RTCPeerConnection||!s.RTCRtpSender||s.RTCRtpSender&&"getStats"in s.RTCRtpReceiver.prototype)return;let t=s.RTCPeerConnection.prototype.getReceivers;t&&(s.RTCPeerConnection.prototype.getReceivers=function(){let i=t.apply(this,[]);return i.forEach(a=>a._pc=this),i}),tc(s,"track",i=>(i.receiver._pc=i.srcElement,i)),s.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function qR(s){s.RTCPeerConnection&&!("removeStream"in s.RTCPeerConnection.prototype)&&(s.RTCPeerConnection.prototype.removeStream=function(t){K_("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&t.getTracks().includes(i.track)&&this.removeTrack(i)})})}function JR(s){s.DataChannel&&!s.RTCDataChannel&&(s.RTCDataChannel=s.DataChannel)}function XR(s){if(typeof s!="object"||!s.RTCPeerConnection)return;let t=s.RTCPeerConnection.prototype.addTransceiver;t&&(s.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];let a=i.length>0;a&&i.forEach(p=>{if("rid"in p&&!/^[a-z0-9]{0,16}$/i.test(p.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in p&&!(parseFloat(p.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in p&&!(parseFloat(p.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let l=t.apply(this,arguments);if(a){let{sender:p}=l,f=p.getParameters();(!("encodings"in f)||f.encodings.length===1&&Object.keys(f.encodings[0]).length===0)&&(f.encodings=i,p.sendEncodings=i,this.setParametersPromises.push(p.setParameters(f).then(()=>{delete p.sendEncodings}).catch(()=>{delete p.sendEncodings})))}return l})}function QR(s){if(typeof s!="object"||!s.RTCRtpSender)return;let t=s.RTCRtpSender.prototype.getParameters;t&&(s.RTCRtpSender.prototype.getParameters=function(){let i=t.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function ZR(s){if(typeof s!="object"||!s.RTCPeerConnection)return;let t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function $R(s){if(typeof s!="object"||!s.RTCPeerConnection)return;let t=s.RTCPeerConnection.prototype.createAnswer;s.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var ey=Object.freeze({__proto__:null,shimAddTransceiver:XR,shimCreateAnswer:$R,shimCreateOffer:ZR,shimGetDisplayMedia:function(s,t){s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||s.navigator.mediaDevices&&(s.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){let a=new DOMException("getDisplayMedia without video constraints is undefined");return a.name="NotFoundError",a.code=8,Promise.reject(a)}return i.video===!0?i.video={mediaSource:t}:i.video.mediaSource=t,s.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:QR,shimGetUserMedia:HR,shimOnTrack:KR,shimPeerConnection:q_,shimRTCDataChannel:JR,shimReceiverGetStats:zR,shimRemoveStream:qR,shimSenderGetStats:YR});function ty(s){if(typeof s=="object"&&s.RTCPeerConnection){if("getLocalStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in s.RTCPeerConnection.prototype)){let t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(a=>t.call(this,a,i)),i.getVideoTracks().forEach(a=>t.call(this,a,i))},s.RTCPeerConnection.prototype.addTrack=function(i,...a){return a&&a.forEach(l=>{this._localStreams?this._localStreams.includes(l)||this._localStreams.push(l):this._localStreams=[l]}),t.apply(this,arguments)}}"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);let i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);let a=t.getTracks();this.getSenders().forEach(l=>{a.includes(l.track)&&this.removeTrack(l)})})}}function ny(s){if(typeof s=="object"&&s.RTCPeerConnection&&("getRemoteStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in s.RTCPeerConnection.prototype))){Object.defineProperty(s.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=a=>{a.streams.forEach(l=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(l))return;this._remoteStreams.push(l);let p=new Event("addstream");p.stream=l,this.dispatchEvent(p)})})}});let t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){let i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(a){a.streams.forEach(l=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(l)>=0)return;i._remoteStreams.push(l);let p=new Event("addstream");p.stream=l,i.dispatchEvent(p)})}),t.apply(i,arguments)}}}function iy(s){if(typeof s!="object"||!s.RTCPeerConnection)return;let t=s.RTCPeerConnection.prototype,i=t.createOffer,a=t.createAnswer,l=t.setLocalDescription,p=t.setRemoteDescription,f=t.addIceCandidate;t.createOffer=function(v,y){let I=arguments.length>=2?arguments[2]:arguments[0],b=i.apply(this,[I]);return y?(b.then(v,y),Promise.resolve()):b},t.createAnswer=function(v,y){let I=arguments.length>=2?arguments[2]:arguments[0],b=a.apply(this,[I]);return y?(b.then(v,y),Promise.resolve()):b};let g=function(v,y,I){let b=l.apply(this,[v]);return I?(b.then(y,I),Promise.resolve()):b};t.setLocalDescription=g,g=function(v,y,I){let b=p.apply(this,[v]);return I?(b.then(y,I),Promise.resolve()):b},t.setRemoteDescription=g,g=function(v,y,I){let b=f.apply(this,[v]);return I?(b.then(y,I),Promise.resolve()):b},t.addIceCandidate=g}function ry(s){let t=s&&s.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){let i=t.mediaDevices,a=i.getUserMedia.bind(i);t.mediaDevices.getUserMedia=l=>a(sy(l))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(i,a,l){t.mediaDevices.getUserMedia(i).then(a,l)}).bind(t))}function sy(s){return s&&s.video!==void 0?Object.assign({},s,{video:DR(s.video)}):s}function oy(s){if(!s.RTCPeerConnection)return;let t=s.RTCPeerConnection;s.RTCPeerConnection=function(i,a){if(i&&i.iceServers){let l=[];for(let p=0;p<i.iceServers.length;p++){let f=i.iceServers[p];!f.hasOwnProperty("urls")&&f.hasOwnProperty("url")?(K_("RTCIceServer.url","RTCIceServer.urls"),f=JSON.parse(JSON.stringify(f)),f.urls=f.url,delete f.url,l.push(f)):l.push(i.iceServers[p])}i.iceServers=l}return new t(i,a)},s.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(s.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function ay(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function cy(s){let t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(i){if(i){i.offerToReceiveAudio!==void 0&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);let a=this.getTransceivers().find(p=>p.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&a?a.direction==="sendrecv"?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":a.direction==="recvonly"&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):i.offerToReceiveAudio!==!0||a||this.addTransceiver("audio",{direction:"recvonly"}),i.offerToReceiveVideo!==void 0&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);let l=this.getTransceivers().find(p=>p.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&l?l.direction==="sendrecv"?l.setDirection?l.setDirection("sendonly"):l.direction="sendonly":l.direction==="recvonly"&&(l.setDirection?l.setDirection("inactive"):l.direction="inactive"):i.offerToReceiveVideo!==!0||l||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function dy(s){typeof s!="object"||s.AudioContext||(s.AudioContext=s.webkitAudioContext)}var ly=Object.freeze({__proto__:null,shimAudioContext:dy,shimCallbacksAPI:iy,shimConstraints:sy,shimCreateOfferLegacy:cy,shimGetUserMedia:ry,shimLocalStreamsAPI:ty,shimRTCIceServerUrls:oy,shimRemoteStreamsAPI:ny,shimTrackEventTransceiver:ay}),uy={exports:{}};(function(s){let t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(i){return i.trim().split(`
`).map(a=>a.trim())},t.splitSections=function(i){return i.split(`
m=`).map((a,l)=>(l>0?"m="+a:a).trim()+`\r
`)},t.getDescription=function(i){let a=t.splitSections(i);return a&&a[0]},t.getMediaSections=function(i){let a=t.splitSections(i);return a.shift(),a},t.matchPrefix=function(i,a){return t.splitLines(i).filter(l=>l.indexOf(a)===0)},t.parseCandidate=function(i){let a;a=i.indexOf("a=candidate:")===0?i.substring(12).split(" "):i.substring(10).split(" ");let l={foundation:a[0],component:{1:"rtp",2:"rtcp"}[a[1]]||a[1],protocol:a[2].toLowerCase(),priority:parseInt(a[3],10),ip:a[4],address:a[4],port:parseInt(a[5],10),type:a[7]};for(let p=8;p<a.length;p+=2)switch(a[p]){case"raddr":l.relatedAddress=a[p+1];break;case"rport":l.relatedPort=parseInt(a[p+1],10);break;case"tcptype":l.tcpType=a[p+1];break;case"ufrag":l.ufrag=a[p+1],l.usernameFragment=a[p+1];break;default:l[a[p]]===void 0&&(l[a[p]]=a[p+1])}return l},t.writeCandidate=function(i){let a=[];a.push(i.foundation);let l=i.component;l==="rtp"?a.push(1):l==="rtcp"?a.push(2):a.push(l),a.push(i.protocol.toUpperCase()),a.push(i.priority),a.push(i.address||i.ip),a.push(i.port);let p=i.type;return a.push("typ"),a.push(p),p!=="host"&&i.relatedAddress&&i.relatedPort&&(a.push("raddr"),a.push(i.relatedAddress),a.push("rport"),a.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(a.push("tcptype"),a.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(a.push("ufrag"),a.push(i.usernameFragment||i.ufrag)),"candidate:"+a.join(" ")},t.parseIceOptions=function(i){return i.substring(14).split(" ")},t.parseRtpMap=function(i){let a=i.substring(9).split(" "),l={payloadType:parseInt(a.shift(),10)};return a=a[0].split("/"),l.name=a[0],l.clockRate=parseInt(a[1],10),l.channels=a.length===3?parseInt(a[2],10):1,l.numChannels=l.channels,l},t.writeRtpMap=function(i){let a=i.payloadType;i.preferredPayloadType!==void 0&&(a=i.preferredPayloadType);let l=i.channels||i.numChannels||1;return"a=rtpmap:"+a+" "+i.name+"/"+i.clockRate+(l!==1?"/"+l:"")+`\r
`},t.parseExtmap=function(i){let a=i.substring(9).split(" ");return{id:parseInt(a[0],10),direction:a[0].indexOf("/")>0?a[0].split("/")[1]:"sendrecv",uri:a[1],attributes:a.slice(2).join(" ")}},t.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+(i.attributes?" "+i.attributes:"")+`\r
`},t.parseFmtp=function(i){let a={},l,p=i.substring(i.indexOf(" ")+1).split(";");for(let f=0;f<p.length;f++)l=p[f].trim().split("="),a[l[0].trim()]=l[1];return a},t.writeFmtp=function(i){let a="",l=i.payloadType;if(i.preferredPayloadType!==void 0&&(l=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){let p=[];Object.keys(i.parameters).forEach(f=>{i.parameters[f]!==void 0?p.push(f+"="+i.parameters[f]):p.push(f)}),a+="a=fmtp:"+l+" "+p.join(";")+`\r
`}return a},t.parseRtcpFb=function(i){let a=i.substring(i.indexOf(" ")+1).split(" ");return{type:a.shift(),parameter:a.join(" ")}},t.writeRtcpFb=function(i){let a="",l=i.payloadType;return i.preferredPayloadType!==void 0&&(l=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(p=>{a+="a=rtcp-fb:"+l+" "+p.type+(p.parameter&&p.parameter.length?" "+p.parameter:"")+`\r
`}),a},t.parseSsrcMedia=function(i){let a=i.indexOf(" "),l={ssrc:parseInt(i.substring(7,a),10)},p=i.indexOf(":",a);return p>-1?(l.attribute=i.substring(a+1,p),l.value=i.substring(p+1)):l.attribute=i.substring(a+1),l},t.parseSsrcGroup=function(i){let a=i.substring(13).split(" ");return{semantics:a.shift(),ssrcs:a.map(l=>parseInt(l,10))}},t.getMid=function(i){let a=t.matchPrefix(i,"a=mid:")[0];if(a)return a.substring(6)},t.parseFingerprint=function(i){let a=i.substring(14).split(" ");return{algorithm:a[0].toLowerCase(),value:a[1].toUpperCase()}},t.getDtlsParameters=function(i,a){return{role:"auto",fingerprints:t.matchPrefix(i+a,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(i,a){let l="a=setup:"+a+`\r
`;return i.fingerprints.forEach(p=>{l+="a=fingerprint:"+p.algorithm+" "+p.value+`\r
`}),l},t.parseCryptoLine=function(i){let a=i.substring(9).split(" ");return{tag:parseInt(a[0],10),cryptoSuite:a[1],keyParams:a[2],sessionParams:a.slice(3)}},t.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?t.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;let a=i.substring(7).split("|");return{keyMethod:"inline",keySalt:a[0],lifeTime:a[1],mkiValue:a[2]?a[2].split(":")[0]:void 0,mkiLength:a[2]?a[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},t.getCryptoParameters=function(i,a){return t.matchPrefix(i+a,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(i,a){let l=t.matchPrefix(i+a,"a=ice-ufrag:")[0],p=t.matchPrefix(i+a,"a=ice-pwd:")[0];return l&&p?{usernameFragment:l.substring(12),password:p.substring(10)}:null},t.writeIceParameters=function(i){let a="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(a+=`a=ice-lite\r
`),a},t.parseRtpParameters=function(i){let a={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},l=t.splitLines(i)[0].split(" ");a.profile=l[2];for(let f=3;f<l.length;f++){let g=l[f],v=t.matchPrefix(i,"a=rtpmap:"+g+" ")[0];if(v){let y=t.parseRtpMap(v),I=t.matchPrefix(i,"a=fmtp:"+g+" ");switch(y.parameters=I.length?t.parseFmtp(I[0]):{},y.rtcpFeedback=t.matchPrefix(i,"a=rtcp-fb:"+g+" ").map(t.parseRtcpFb),a.codecs.push(y),y.name.toUpperCase()){case"RED":case"ULPFEC":a.fecMechanisms.push(y.name.toUpperCase())}}}t.matchPrefix(i,"a=extmap:").forEach(f=>{a.headerExtensions.push(t.parseExtmap(f))});let p=t.matchPrefix(i,"a=rtcp-fb:* ").map(t.parseRtcpFb);return a.codecs.forEach(f=>{p.forEach(g=>{f.rtcpFeedback.find(v=>v.type===g.type&&v.parameter===g.parameter)||f.rtcpFeedback.push(g)})}),a},t.writeRtpDescription=function(i,a){let l="";l+="m="+i+" ",l+=a.codecs.length>0?"9":"0",l+=" "+(a.profile||"UDP/TLS/RTP/SAVPF")+" ",l+=a.codecs.map(f=>f.preferredPayloadType!==void 0?f.preferredPayloadType:f.payloadType).join(" ")+`\r
`,l+=`c=IN IP4 0.0.0.0\r
`,l+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,a.codecs.forEach(f=>{l+=t.writeRtpMap(f),l+=t.writeFmtp(f),l+=t.writeRtcpFb(f)});let p=0;return a.codecs.forEach(f=>{f.maxptime>p&&(p=f.maxptime)}),p>0&&(l+="a=maxptime:"+p+`\r
`),a.headerExtensions&&a.headerExtensions.forEach(f=>{l+=t.writeExtmap(f)}),l},t.parseRtpEncodingParameters=function(i){let a=[],l=t.parseRtpParameters(i),p=l.fecMechanisms.indexOf("RED")!==-1,f=l.fecMechanisms.indexOf("ULPFEC")!==-1,g=t.matchPrefix(i,"a=ssrc:").map(k=>t.parseSsrcMedia(k)).filter(k=>k.attribute==="cname"),v=g.length>0&&g[0].ssrc,y,I=t.matchPrefix(i,"a=ssrc-group:FID").map(k=>k.substring(17).split(" ").map(U=>parseInt(U,10)));I.length>0&&I[0].length>1&&I[0][0]===v&&(y=I[0][1]),l.codecs.forEach(k=>{if(k.name.toUpperCase()==="RTX"&&k.parameters.apt){let U={ssrc:v,codecPayloadType:parseInt(k.parameters.apt,10)};v&&y&&(U.rtx={ssrc:y}),a.push(U),p&&(U=JSON.parse(JSON.stringify(U)),U.fec={ssrc:v,mechanism:f?"red+ulpfec":"red"},a.push(U))}}),a.length===0&&v&&a.push({ssrc:v});let b=t.matchPrefix(i,"b=");return b.length&&(b=b[0].indexOf("b=TIAS:")===0?parseInt(b[0].substring(7),10):b[0].indexOf("b=AS:")===0?1e3*parseInt(b[0].substring(5),10)*.95-16e3:void 0,a.forEach(k=>{k.maxBitrate=b})),a},t.parseRtcpParameters=function(i){let a={},l=t.matchPrefix(i,"a=ssrc:").map(g=>t.parseSsrcMedia(g)).filter(g=>g.attribute==="cname")[0];l&&(a.cname=l.value,a.ssrc=l.ssrc);let p=t.matchPrefix(i,"a=rtcp-rsize");a.reducedSize=p.length>0,a.compound=p.length===0;let f=t.matchPrefix(i,"a=rtcp-mux");return a.mux=f.length>0,a},t.writeRtcpParameters=function(i){let a="";return i.reducedSize&&(a+=`a=rtcp-rsize\r
`),i.mux&&(a+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(a+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),a},t.parseMsid=function(i){let a,l=t.matchPrefix(i,"a=msid:");if(l.length===1)return a=l[0].substring(7).split(" "),{stream:a[0],track:a[1]};let p=t.matchPrefix(i,"a=ssrc:").map(f=>t.parseSsrcMedia(f)).filter(f=>f.attribute==="msid");return p.length>0?(a=p[0].value.split(" "),{stream:a[0],track:a[1]}):void 0},t.parseSctpDescription=function(i){let a=t.parseMLine(i),l=t.matchPrefix(i,"a=max-message-size:"),p;l.length>0&&(p=parseInt(l[0].substring(19),10)),isNaN(p)&&(p=65536);let f=t.matchPrefix(i,"a=sctp-port:");if(f.length>0)return{port:parseInt(f[0].substring(12),10),protocol:a.fmt,maxMessageSize:p};let g=t.matchPrefix(i,"a=sctpmap:");if(g.length>0){let v=g[0].substring(10).split(" ");return{port:parseInt(v[0],10),protocol:v[1],maxMessageSize:p}}},t.writeSctpDescription=function(i,a){let l=[];return l=i.protocol!=="DTLS/SCTP"?["m="+i.kind+" 9 "+i.protocol+" "+a.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+a.port+`\r
`]:["m="+i.kind+" 9 "+i.protocol+" "+a.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+a.port+" "+a.protocol+` 65535\r
`],a.maxMessageSize!==void 0&&l.push("a=max-message-size:"+a.maxMessageSize+`\r
`),l.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(i,a,l){let p,f=a!==void 0?a:2;return p=i||t.generateSessionId(),`v=0\r
o=`+(l||"thisisadapterortc")+" "+p+" "+f+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(i,a){let l=t.splitLines(i);for(let p=0;p<l.length;p++)switch(l[p]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return l[p].substring(2)}return a?t.getDirection(a):"sendrecv"},t.getKind=function(i){return t.splitLines(i)[0].split(" ")[0].substring(2)},t.isRejected=function(i){return i.split(" ",2)[1]==="0"},t.parseMLine=function(i){let a=t.splitLines(i)[0].substring(2).split(" ");return{kind:a[0],port:parseInt(a[1],10),protocol:a[2],fmt:a.slice(3).join(" ")}},t.parseOLine=function(i){let a=t.matchPrefix(i,"o=")[0].substring(2).split(" ");return{username:a[0],sessionId:a[1],sessionVersion:parseInt(a[2],10),netType:a[3],addressType:a[4],address:a[5]}},t.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;let a=t.splitLines(i);for(let l=0;l<a.length;l++)if(a[l].length<2||a[l].charAt(1)!=="=")return!1;return!0},s.exports=t})(uy);var hy=uy.exports,Sd=A(hy),tx=E({__proto__:null,default:Sd},[hy]);function $h(s){if(!s.RTCIceCandidate||s.RTCIceCandidate&&"foundation"in s.RTCIceCandidate.prototype)return;let t=s.RTCIceCandidate;s.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&((i=JSON.parse(JSON.stringify(i))).candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){let a=new t(i),l=Sd.parseCandidate(i.candidate),p=Object.assign(a,l);return p.toJSON=function(){return{candidate:p.candidate,sdpMid:p.sdpMid,sdpMLineIndex:p.sdpMLineIndex,usernameFragment:p.usernameFragment}},p}return new t(i)},s.RTCIceCandidate.prototype=t.prototype,tc(s,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new s.RTCIceCandidate(i.candidate),writable:"false"}),i))}function J_(s){!s.RTCIceCandidate||s.RTCIceCandidate&&"relayProtocol"in s.RTCIceCandidate.prototype||tc(s,"icecandidate",t=>{if(t.candidate){let i=Sd.parseCandidate(t.candidate.candidate);i.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return t})}function ep(s,t){if(!s.RTCPeerConnection)return;"sctp"in s.RTCPeerConnection.prototype||Object.defineProperty(s.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});let i=function(g){if(!g||!g.sdp)return!1;let v=Sd.splitSections(g.sdp);return v.shift(),v.some(y=>{let I=Sd.parseMLine(y);return I&&I.kind==="application"&&I.protocol.indexOf("SCTP")!==-1})},a=function(g){let v=g.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(v===null||v.length<2)return-1;let y=parseInt(v[1],10);return y!=y?-1:y},l=function(g){let v=65536;return t.browser==="firefox"&&(v=t.version<57?g===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),v},p=function(g,v){let y=65536;t.browser==="firefox"&&t.version===57&&(y=65535);let I=Sd.matchPrefix(g.sdp,"a=max-message-size:");return I.length>0?y=parseInt(I[0].substr(19),10):t.browser==="firefox"&&v!==-1&&(y=2147483637),y},f=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){let{sdpSemantics:g}=this.getConfiguration();g==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){let g=a(arguments[0]),v=l(g),y=p(arguments[0],g),I;I=v===0&&y===0?Number.POSITIVE_INFINITY:v===0||y===0?Math.max(v,y):Math.min(v,y);let b={};Object.defineProperty(b,"maxMessageSize",{get:()=>I}),this._sctp=b}return f.apply(this,arguments)}}function tp(s){if(!s.RTCPeerConnection||!("createDataChannel"in s.RTCPeerConnection.prototype))return;function t(a,l){let p=a.send;a.send=function(){let f=arguments[0],g=f.length||f.size||f.byteLength;if(a.readyState==="open"&&l.sctp&&g>l.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+l.sctp.maxMessageSize+" bytes)");return p.apply(a,arguments)}}let i=s.RTCPeerConnection.prototype.createDataChannel;s.RTCPeerConnection.prototype.createDataChannel=function(){let a=i.apply(this,arguments);return t(a,this),a},tc(s,"datachannel",a=>(t(a.channel,a.target),a))}function X_(s){if(!s.RTCPeerConnection||"connectionState"in s.RTCPeerConnection.prototype)return;let t=s.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{let a=t[i];t[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=l=>{let p=l.target;if(p._lastConnectionState!==p.connectionState){p._lastConnectionState=p.connectionState;let f=new Event("connectionstatechange",l);p.dispatchEvent(f)}return l},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),a.apply(this,arguments)}})}function Q_(s,t){if(!s.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;let i=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(a){if(a&&a.sdp&&a.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let l=a.sdp.split(`
`).filter(p=>p.trim()!=="a=extmap-allow-mixed").join(`
`);s.RTCSessionDescription&&a instanceof s.RTCSessionDescription?arguments[0]=new s.RTCSessionDescription({type:a.type,sdp:l}):a.sdp=l}return i.apply(this,arguments)}}function np(s,t){if(!s.RTCPeerConnection||!s.RTCPeerConnection.prototype)return;let i=s.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(s.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function ip(s,t){if(!s.RTCPeerConnection||!s.RTCPeerConnection.prototype)return;let i=s.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(s.RTCPeerConnection.prototype.setLocalDescription=function(){let a=arguments[0]||{};if(typeof a!="object"||a.type&&a.sdp)return i.apply(this,arguments);if(a={type:a.type,sdp:a.sdp},!a.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":a.type="offer";break;default:a.type="answer"}return a.sdp||a.type!=="offer"&&a.type!=="answer"?i.apply(this,[a]):(a.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(l=>i.apply(this,[l]))})}var nx=Object.freeze({__proto__:null,removeExtmapAllowMixed:Q_,shimAddIceCandidateNullOrEmpty:np,shimConnectionState:X_,shimMaxMessageSize:ep,shimParameterlessSetLocalDescription:ip,shimRTCIceCandidate:$h,shimRTCIceCandidateRelayProtocol:J_,shimSendThrowTypeError:tp});(function({window:s}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let i=OR,a=function(p){let f={browser:null,version:null};if(p===void 0||!p.navigator)return f.browser="Not a browser.",f;let{navigator:g}=p;if(g.mozGetUserMedia)f.browser="firefox",f.version=Zh(g.userAgent,/Firefox\/(\d+)\./,1);else if(g.webkitGetUserMedia||p.isSecureContext===!1&&p.webkitRTCPeerConnection)f.browser="chrome",f.version=Zh(g.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!p.RTCPeerConnection||!g.userAgent.match(/AppleWebKit\/(\d+)\./))return f.browser="Not a supported browser.",f;f.browser="safari",f.version=Zh(g.userAgent,/AppleWebKit\/(\d+)\./,1),f.supportsUnifiedPlan=p.RTCRtpTransceiver&&"currentDirection"in p.RTCRtpTransceiver.prototype}return f}(s),l={browserDetails:a,commonShim:nx,extractVersion:Zh,disableLog:$U,disableWarnings:ex,sdp:tx};switch(a.browser){case"chrome":if(!WR||!z_||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),l;if(a.version===null)return i("Chrome shim can not determine version, not shimming."),l;i("adapter.js shimming chrome."),l.browserShim=WR,np(s,a),ip(s),LR(s,a),MR(s),z_(s,a),UR(s),BR(s,a),xR(s),VR(s),FR(s),GR(s,a),$h(s),J_(s),X_(s),ep(s,a),tp(s),Q_(s,a);break;case"firefox":if(!ey||!q_||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),l;i("adapter.js shimming firefox."),l.browserShim=ey,np(s,a),ip(s),HR(s,a),q_(s,a),KR(s),qR(s),YR(s),zR(s),JR(s),XR(s),QR(s),ZR(s),$R(s),$h(s),X_(s),ep(s,a),tp(s);break;case"safari":if(!ly||!t.shimSafari)return i("Safari shim is not included in this adapter release."),l;i("adapter.js shimming safari."),l.browserShim=ly,np(s,a),ip(s),oy(s),cy(s),iy(s),ty(s),ny(s),ay(s),ry(s),dy(s),$h(s),J_(s),ep(s,a),tp(s),Q_(s,a);break;default:i("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var py={exports:{}},ix=Xt,rx=ii,my=ds.f;ix({target:"Object",stat:!0,forced:Object.defineProperty!==my,sham:!rx},{defineProperty:my});var fy=po.Object,sx=py.exports=function(s,t,i){return fy.defineProperty(s,t,i)};fy.defineProperty.sham&&(sx.sham=!0);var ox=A(py.exports),ax=dt,Z_=Array.isArray||function(s){return ax(s)=="Array"},cx=TypeError,dx=qh,lx=ds,ux=sr,HS=function(s,t,i){var a=dx(t);a in s?lx.f(s,a,ux(0,i)):s[a]=i},hx=Ft,$_=D_,px=ae(Function.toString);hx($_.inspectSource)||($_.inspectSource=function(s){return px(s)});var _y=$_.inspectSource,mx=ae,fx=O,Ey=Ft,_x=Pa,Ex=_y,gy=function(){},gx=[],Sy=hr("Reflect","construct"),eE=/^\s*(?:class|function)\b/,Sx=mx(eE.exec),Tx=!eE.exec(gy),Fl=function(s){if(!Ey(s))return!1;try{return Sy(gy,gx,s),!0}catch{return!1}},Ty=function(s){if(!Ey(s))return!1;switch(_x(s)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Tx||!!Sx(eE,Ex(s))}catch{return!0}};Ty.sham=!0;var KS=!Sy||fx(function(){var s;return Fl(Fl.call)||!Fl(Object)||!Fl(function(){s=!0})||s})?Ty:Fl,Cy=Z_,Cx=KS,vx=qr,Rx=wn("species"),vy=Array,yx=function(s){var t;return Cy(s)&&(t=s.constructor,(Cx(t)&&(t===vy||Cy(t.prototype))||vx(t)&&(t=t[Rx])===null)&&(t=void 0)),t===void 0?vy:t},Ry=function(s,t){return new(yx(s))(t===0?0:t)},Ix=O,Ax=ec,wx=wn("species"),bx=Xt,Ox=O,Nx=Z_,Dx=qr,Px=Oo,kx=Da,yy=function(s){if(s>9007199254740991)throw cx("Maximum allowed index exceeded");return s},Iy=HS,Lx=Ry,Mx=function(s){return Ax>=51||!Ix(function(){var t=[];return(t.constructor={})[wx]=function(){return{foo:1}},t[s](Boolean).foo!==1})},Ux=ec,Ay=wn("isConcatSpreadable"),xx=Ux>=51||!Ox(function(){var s=[];return s[Ay]=!1,s.concat()[0]!==s}),Vx=function(s){if(!Dx(s))return!1;var t=s[Ay];return t!==void 0?!!t:Nx(s)};bx({target:"Array",proto:!0,arity:1,forced:!xx||!Mx("concat")},{concat:function(s){var t,i,a,l,p,f=Px(this),g=Lx(f,0),v=0;for(t=-1,a=arguments.length;t<a;t++)if(Vx(p=t===-1?f:arguments[t]))for(l=kx(p),yy(v+l),i=0;i<l;i++,v++)i in p&&Iy(g,v,p[i]);else yy(v+1),Iy(g,v++,p);return g.length=v,g}});var tE={},rp={},nE=ji,Fx=Za,jx=B_.indexOf,Bx=rp,wy=ae([].push),by=function(s,t){var i,a=Fx(s),l=0,p=[];for(i in a)!nE(Bx,i)&&nE(a,i)&&wy(p,i);for(;t.length>l;)nE(a,i=t[l++])&&(~jx(p,i)||wy(p,i));return p},iE=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Gx=by,Wx=iE,km=Object.keys||function(s){return Gx(s,Wx)},Hx=ii,Kx=SR,Yx=ds,zx=ls,qx=Za,Jx=km;tE.f=Hx&&!Kx?Object.defineProperties:function(s,t){zx(s);for(var i,a=qx(t),l=Jx(t),p=l.length,f=0;p>f;)Yx.f(s,i=l[f++],a[i]);return s};var sp,Oy=hr("document","documentElement"),Xx=P_,Ny=fd("keys"),op=function(s){return Ny[s]||(Ny[s]=Xx(s))},Qx=ls,Zx=tE,Dy=iE,$x=rp,e2=Oy,t2=M_,rE="prototype",sE="script",Py=op("IE_PROTO"),oE=function(){},ky=function(s){return"<"+sE+">"+s+"</"+sE+">"},Ly=function(s){s.write(ky("")),s.close();var t=s.parentWindow.Object;return s=null,t},ap=function(){try{sp=new ActiveXObject("htmlfile")}catch{}var s,t,i;ap=typeof document<"u"?document.domain&&sp?Ly(sp):(t=t2("iframe"),i="java"+sE+":",t.style.display="none",e2.appendChild(t),t.src=String(i),(s=t.contentWindow.document).open(),s.write(ky("document.F=Object")),s.close(),s.F):Ly(sp);for(var a=Dy.length;a--;)delete ap[rE][Dy[a]];return ap()};$x[Py]=!0;var Yu=Object.create||function(s,t){var i;return s!==null?(oE[rE]=Qx(s),i=new oE,oE[rE]=null,i[Py]=s):i=ap(),t===void 0?i:Zx.f(i,t)},cp={},n2=by,i2=iE.concat("length","prototype");cp.f=Object.getOwnPropertyNames||function(s){return n2(s,i2)};var My={},Uy=vR,r2=Da,s2=HS,o2=Array,a2=Math.max,YS=function(s,t,i){for(var a=r2(s),l=Uy(t,a),p=Uy(i===void 0?a:i,a),f=o2(a2(p-l,0)),g=0;l<p;l++,g++)s2(f,g,s[l]);return f.length=g,f},c2=dt,d2=Za,xy=cp.f,l2=YS,Vy=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];My.f=function(s){return Vy&&c2(s)=="Window"?function(t){try{return xy(t)}catch{return l2(Vy)}}(s):xy(d2(s))};var zu={};zu.f=Object.getOwnPropertySymbols;var u2=ra,Vc=function(s,t,i,a){return a&&a.enumerable?s[t]=i:u2(s,t,i),s},h2=ds,aE=function(s,t,i){return h2.f(s,t,i)},Td={},p2=wn;Td.f=p2;var dp,jl,lp,Fy=po,m2=ji,f2=Td,_2=ds.f,qn=function(s){var t=Fy.Symbol||(Fy.Symbol={});m2(t,s)||_2(t,s,{value:f2.f(s)})},E2=Nt,g2=hr,S2=wn,T2=Vc,jy=function(){var s=g2("Symbol"),t=s&&s.prototype,i=t&&t.valueOf,a=S2("toPrimitive");t&&!t[a]&&T2(t,a,function(l){return E2(i,this)},{arity:1})},C2=Pa,v2=G_?{}.toString:function(){return"[object "+C2(this)+"]"},R2=G_,y2=ds.f,I2=ra,A2=ji,w2=v2,By=wn("toStringTag"),nc=function(s,t,i,a){if(s){var l=i?s:s.prototype;A2(l,By)||y2(l,By,{configurable:!0,value:t}),a&&!R2&&I2(l,"toString",w2)}},b2=Ft,Gy=Fe.WeakMap,O2=b2(Gy)&&/native code/.test(String(Gy)),Wy=Fe,N2=qr,D2=ra,cE=ji,dE=D_,P2=op,k2=rp,Hy="Object already initialized",lE=Wy.TypeError,L2=Wy.WeakMap;if(O2||dE.state){var eo=dE.state||(dE.state=new L2);eo.get=eo.get,eo.has=eo.has,eo.set=eo.set,dp=function(s,t){if(eo.has(s))throw lE(Hy);return t.facade=s,eo.set(s,t),t},jl=function(s){return eo.get(s)||{}},lp=function(s){return eo.has(s)}}else{var Cd=P2("state");k2[Cd]=!0,dp=function(s,t){if(cE(s,Cd))throw lE(Hy);return t.facade=s,D2(s,Cd,t),t},jl=function(s){return cE(s,Cd)?s[Cd]:{}},lp=function(s){return cE(s,Cd)}}var Bl={set:dp,get:jl,has:lp,enforce:function(s){return lp(s)?jl(s):dp(s,{})},getterFor:function(s){return function(t){var i;if(!N2(t)||(i=jl(t)).type!==s)throw lE("Incompatible receiver, "+s+" required");return i}}},M2=xc,U2=Pm,x2=Oo,V2=Da,F2=Ry,Ky=ae([].push),oa=function(s){var t=s==1,i=s==2,a=s==3,l=s==4,p=s==6,f=s==7,g=s==5||p;return function(v,y,I,b){for(var k,U,J=x2(v),K=U2(J),q=M2(y,I),te=V2(K),de=0,he=b||F2,Ue=t?he(v,te):i||f?he(v,0):void 0;te>de;de++)if((g||de in K)&&(U=q(k=K[de],de,J),s))if(t)Ue[de]=U;else if(U)switch(s){case 3:return!0;case 5:return k;case 6:return de;case 2:Ky(Ue,k)}else switch(s){case 4:return!1;case 7:Ky(Ue,k)}return p?-1:a||l?l:Ue}},j2={forEach:oa(0),map:oa(1),filter:oa(2),some:oa(3),every:oa(4),find:oa(5),findIndex:oa(6),filterReject:oa(7)},up=Xt,uE=Fe,hE=Nt,B2=ae,vd=ii,Rd=pd,G2=O,Ii=ji,W2=ge,pE=ls,hp=Za,mE=qh,H2=Bs,fE=sr,Gl=Yu,Yy=km,K2=cp,zy=My,Y2=zu,qy=as,Jy=ds,z2=tE,Xy=cn,Qy=Vc,q2=aE,_E=fd,Zy=rp,$y=P_,J2=wn,X2=Td,Q2=qn,Z2=jy,$2=nc,eI=Bl,pp=j2.forEach,Tr=op("hidden"),mp="Symbol",Wl="prototype",eV=eI.set,tI=eI.getterFor(mp),Ns=Object[Wl],ic=uE.Symbol,fp=ic&&ic[Wl],tV=uE.TypeError,EE=uE.QObject,nI=qy.f,rc=Jy.f,iI=zy.f,nV=Xy.f,rI=B2([].push),No=_E("symbols"),Hl=_E("op-symbols"),iV=_E("wks"),gE=!EE||!EE[Wl]||!EE[Wl].findChild,SE=vd&&G2(function(){return Gl(rc({},"a",{get:function(){return rc(this,"a",{value:7}).a}})).a!=7})?function(s,t,i){var a=nI(Ns,t);a&&delete Ns[t],rc(s,t,i),a&&s!==Ns&&rc(Ns,t,a)}:rc,TE=function(s,t){var i=No[s]=Gl(fp);return eV(i,{type:mp,tag:s,description:t}),vd||(i.description=t),i},_p=function(s,t,i){s===Ns&&_p(Hl,t,i),pE(s);var a=mE(t);return pE(i),Ii(No,a)?(i.enumerable?(Ii(s,Tr)&&s[Tr][a]&&(s[Tr][a]=!1),i=Gl(i,{enumerable:fE(0,!1)})):(Ii(s,Tr)||rc(s,Tr,fE(1,{})),s[Tr][a]=!0),SE(s,a,i)):rc(s,a,i)},CE=function(s,t){pE(s);var i=hp(t),a=Yy(i).concat(cI(i));return pp(a,function(l){vd&&!hE(sI,i,l)||_p(s,l,i[l])}),s},sI=function(s){var t=mE(s),i=hE(nV,this,t);return!(this===Ns&&Ii(No,t)&&!Ii(Hl,t))&&(!(i||!Ii(this,t)||!Ii(No,t)||Ii(this,Tr)&&this[Tr][t])||i)},oI=function(s,t){var i=hp(s),a=mE(t);if(i!==Ns||!Ii(No,a)||Ii(Hl,a)){var l=nI(i,a);return!l||!Ii(No,a)||Ii(i,Tr)&&i[Tr][a]||(l.enumerable=!0),l}},aI=function(s){var t=iI(hp(s)),i=[];return pp(t,function(a){Ii(No,a)||Ii(Zy,a)||rI(i,a)}),i},cI=function(s){var t=s===Ns,i=iI(t?Hl:hp(s)),a=[];return pp(i,function(l){!Ii(No,l)||t&&!Ii(Ns,l)||rI(a,No[l])}),a};Rd||(ic=function(){if(W2(fp,this))throw tV("Symbol is not a constructor");var s=arguments.length&&arguments[0]!==void 0?H2(arguments[0]):void 0,t=$y(s),i=function(a){this===Ns&&hE(i,Hl,a),Ii(this,Tr)&&Ii(this[Tr],t)&&(this[Tr][t]=!1),SE(this,t,fE(1,a))};return vd&&gE&&SE(Ns,t,{configurable:!0,set:i}),TE(t,s)},Qy(fp=ic[Wl],"toString",function(){return tI(this).tag}),Qy(ic,"withoutSetter",function(s){return TE($y(s),s)}),Xy.f=sI,Jy.f=_p,z2.f=CE,qy.f=oI,K2.f=zy.f=aI,Y2.f=cI,X2.f=function(s){return TE(J2(s),s)},vd&&q2(fp,"description",{configurable:!0,get:function(){return tI(this).description}})),up({global:!0,constructor:!0,wrap:!0,forced:!Rd,sham:!Rd},{Symbol:ic}),pp(Yy(iV),function(s){Q2(s)}),up({target:mp,stat:!0,forced:!Rd},{useSetter:function(){gE=!0},useSimple:function(){gE=!1}}),up({target:"Object",stat:!0,forced:!Rd,sham:!vd},{create:function(s,t){return t===void 0?Gl(s):CE(Gl(s),t)},defineProperty:_p,defineProperties:CE,getOwnPropertyDescriptor:oI}),up({target:"Object",stat:!0,forced:!Rd},{getOwnPropertyNames:aI}),Z2(),$2(ic,mp),Zy[Tr]=!0;var dI=pd&&!!Symbol.for&&!!Symbol.keyFor,rV=Xt,sV=hr,oV=ji,aV=Bs,lI=fd,cV=dI,vE=lI("string-to-symbol-registry"),dV=lI("symbol-to-string-registry");rV({target:"Symbol",stat:!0,forced:!cV},{for:function(s){var t=aV(s);if(oV(vE,t))return vE[t];var i=sV("Symbol")(t);return vE[t]=i,dV[i]=t,i}});var lV=Xt,uV=ji,hV=xl,pV=md,mV=dI,uI=fd("symbol-to-string-registry");lV({target:"Symbol",stat:!0,forced:!mV},{keyFor:function(s){if(!hV(s))throw TypeError(pV(s)+" is not a symbol");if(uV(uI,s))return uI[s]}});var hI=ae([].slice),pI=Z_,fV=Ft,mI=dt,_V=Bs,fI=ae([].push),EV=Xt,_I=hr,EI=ve,gV=Nt,Kl=ae,gI=O,SI=Ft,TI=xl,CI=hI,SV=function(s){if(fV(s))return s;if(pI(s)){for(var t=s.length,i=[],a=0;a<t;a++){var l=s[a];typeof l=="string"?fI(i,l):typeof l!="number"&&mI(l)!="Number"&&mI(l)!="String"||fI(i,_V(l))}var p=i.length,f=!0;return function(g,v){if(f)return f=!1,v;if(pI(this))return v;for(var y=0;y<p;y++)if(i[y]===g)return v}}},TV=pd,CV=String,aa=_I("JSON","stringify"),Ep=Kl(/./.exec),vI=Kl("".charAt),vV=Kl("".charCodeAt),RV=Kl("".replace),yV=Kl(1 .toString),IV=/[\uD800-\uDFFF]/g,RI=/^[\uD800-\uDBFF]$/,yI=/^[\uDC00-\uDFFF]$/,II=!TV||gI(function(){var s=_I("Symbol")();return aa([s])!="[null]"||aa({a:s})!="{}"||aa(Object(s))!="{}"}),AI=gI(function(){return aa("\uDF06\uD834")!=='"\\udf06\\ud834"'||aa("\uDEAD")!=='"\\udead"'}),AV=function(s,t){var i=CI(arguments),a=SV(t);if(SI(a)||s!==void 0&&!TI(s))return i[1]=function(l,p){if(SI(a)&&(p=gV(a,this,CV(l),p)),!TI(p))return p},EI(aa,null,i)},wV=function(s,t,i){var a=vI(i,t-1),l=vI(i,t+1);return Ep(RI,s)&&!Ep(yI,l)||Ep(yI,s)&&!Ep(RI,a)?"\\u"+yV(vV(s,0),16):s};aa&&EV({target:"JSON",stat:!0,arity:3,forced:II||AI},{stringify:function(s,t,i){var a=CI(arguments),l=EI(II?AV:aa,null,a);return AI&&typeof l=="string"?RV(l,IV,wV):l}});var wI=zu,bV=Oo;Xt({target:"Object",stat:!0,forced:!pd||O(function(){wI.f(1)})},{getOwnPropertySymbols:function(s){var t=wI.f;return t?t(bV(s)):[]}}),qn("asyncIterator"),qn("hasInstance"),qn("isConcatSpreadable"),qn("iterator"),qn("match"),qn("matchAll"),qn("replace"),qn("search"),qn("species"),qn("split");var OV=jy;qn("toPrimitive"),OV();var NV=hr,DV=nc;qn("toStringTag"),DV(NV("Symbol"),"Symbol"),qn("unscopables"),nc(Fe.JSON,"JSON",!0);var sc,bI,OI,PV=po.Symbol,yd={},RE=ii,kV=ji,NI=Function.prototype,LV=RE&&Object.getOwnPropertyDescriptor,yE=kV(NI,"name"),DI={EXISTS:yE,PROPER:yE&&(function(){}).name==="something",CONFIGURABLE:yE&&(!RE||RE&&LV(NI,"name").configurable)},MV=!O(function(){function s(){}return s.prototype.constructor=null,Object.getPrototypeOf(new s)!==s.prototype}),UV=ji,xV=Ft,VV=Oo,FV=MV,PI=op("IE_PROTO"),IE=Object,jV=IE.prototype,AE=FV?IE.getPrototypeOf:function(s){var t=VV(s);if(UV(t,PI))return t[PI];var i=t.constructor;return xV(i)&&t instanceof i?i.prototype:t instanceof IE?jV:null},BV=O,GV=Ft,WV=qr,HV=Yu,kI=AE,KV=Vc,wE=wn("iterator"),LI=!1;[].keys&&("next"in(OI=[].keys())?(bI=kI(kI(OI)))!==Object.prototype&&(sc=bI):LI=!0);var YV=!WV(sc)||BV(function(){var s={};return sc[wE].call(s)!==s});GV((sc=YV?{}:HV(sc))[wE])||KV(sc,wE,function(){return this});var MI={IteratorPrototype:sc,BUGGY_SAFARI_ITERATORS:LI},zV=MI.IteratorPrototype,qV=Yu,JV=sr,XV=nc,QV=yd,ZV=function(){return this},vO=ae,$V=cs,eF=Ft,tF=String,nF=TypeError,iF=function(s,t,i){try{return vO($V(Object.getOwnPropertyDescriptor(s,t)[i]))}catch{}},rF=ls,sF=function(s){if(typeof s=="object"||eF(s))return s;throw nF("Can't set "+tF(s)+" as a prototype")},oF=Object.setPrototypeOf||("__proto__"in{}?function(){var s,t=!1,i={};try{(s=iF(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch{}return function(a,l){return rF(a),sF(l),t?s(a,l):a.__proto__=l,a}}():void 0),aF=Xt,cF=Nt,dF=DI,lF=function(s,t,i,a){var l=t+" Iterator";return s.prototype=qV(zV,{next:JV(+!a,i)}),XV(s,l,!1,!0),QV[l]=ZV,s},uF=AE,hF=nc,RO=Vc,UI=yd,yO=MI,pF=dF.PROPER,zS=yO.BUGGY_SAFARI_ITERATORS,Lm=wn("iterator"),qS="keys",bE="values",OE="entries",IO=function(){return this},AO=function(s,t,i,a,l,p,f){lF(i,t,a);var g,v,y,I=function(te){if(te===l&&K)return K;if(!zS&&te in U)return U[te];switch(te){case qS:case bE:case OE:return function(){return new i(this,te)}}return function(){return new i(this)}},b=t+" Iterator",k=!1,U=s.prototype,J=U[Lm]||U["@@iterator"]||l&&U[l],K=!zS&&J||I(l),q=t=="Array"&&U.entries||J;if(q&&(g=uF(q.call(new s)))!==Object.prototype&&g.next&&(hF(g,b,!0,!0),UI[b]=IO),pF&&l==bE&&J&&J.name!==bE&&(k=!0,K=function(){return cF(J,this)}),l)if(v={values:I(bE),keys:p?K:I(qS),entries:I(OE)},f)for(y in v)(zS||k||!(y in U))&&RO(U,y,v[y]);else aF({target:t,proto:!0,forced:zS||k},v);return f&&U[Lm]!==K&&RO(U,Lm,K,{name:l}),UI[t]=K,v},xI=function(s,t){return{value:s,done:t}},wO=Za,bO=yd,VI=Bl;ds.f;var OO=AO,NO=xI,FI="Array Iterator",DO=VI.set,mF=VI.getterFor(FI);OO(Array,"Array",function(s,t){DO(this,{type:FI,target:wO(s),index:0,kind:t})},function(){var s=mF(this),t=s.target,i=s.kind,a=s.index++;return!t||a>=t.length?(s.target=void 0,NO(void 0,!0)):NO(i=="keys"?a:i=="values"?t[a]:[a,t[a]],!1)},"values"),bO.Arguments=bO.Array;var fF={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},_F=Fe,EF=Pa,gF=ra,PO=yd,jI=wn("toStringTag");for(var JS in fF){var XS=_F[JS],QS=XS&&XS.prototype;QS&&EF(QS)!==jI&&gF(QS,jI,JS),PO[JS]=PO.Array}var BI=PV,SF=wn,TF=ds.f,kO=SF("metadata"),GI=Function.prototype;GI[kO]===void 0&&TF(GI,kO,{value:null}),qn("dispose"),qn("metadata");var LO=BI;qn("asyncDispose");var CF=ae,WI=hr("Symbol"),HI=WI.keyFor,vF=CF(WI.prototype.valueOf),MO=WI.isRegisteredSymbol||function(s){try{return HI(vF(s))!==void 0}catch{return!1}};Xt({target:"Symbol",stat:!0},{isRegisteredSymbol:MO});for(var UO=fd,xO=hr,VO=ae,RF=xl,yF=wn,ZS=xO("Symbol"),NE=ZS.isWellKnownSymbol,KI=xO("Object","getOwnPropertyNames"),FO=VO(ZS.prototype.valueOf),jO=UO("wks"),$S=0,eT=KI(ZS),BO=eT.length;$S<BO;$S++)try{var GO=eT[$S];RF(ZS[GO])&&yF(GO)}catch{}var YI=function(s){if(NE&&NE(s))return!0;try{for(var t=FO(s),i=0,a=KI(jO),l=a.length;i<l;i++)if(jO[a[i]]==t)return!0}catch{}return!1};Xt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:YI}),qn("matcher"),qn("observable"),Xt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:MO}),Xt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:YI}),qn("metadataKey"),qn("patternMatch"),qn("replaceAll");var gp=A(LO),qu=ae,zI=j_,IF=Bs,AF=Ul,wF=qu("".charAt),WO=qu("".charCodeAt),HO=qu("".slice),KO=function(s){return function(t,i){var a,l,p=IF(AF(t)),f=zI(i),g=p.length;return f<0||f>=g?s?"":void 0:(a=WO(p,f))<55296||a>56319||f+1===g||(l=WO(p,f+1))<56320||l>57343?s?wF(p,f):a:s?HO(p,f,f+2):l-56320+(a-55296<<10)+65536}},YO={codeAt:KO(!1),charAt:KO(!0)}.charAt,zO=Bs,qO=Bl,bF=AO,qI=xI,JO="String Iterator",XO=qO.set,QO=qO.getterFor(JO);bF(String,"String",function(s){XO(this,{type:JO,string:zO(s),index:0})},function(){var s,t=QO(this),i=t.string,a=t.index;return a>=i.length?qI(void 0,!0):(s=YO(i,a),t.index+=s.length,qI(s,!1))});var ZO=A(Td.f("iterator"));function DE(s){return DE=typeof gp=="function"&&typeof ZO=="symbol"?function(t){return typeof t}:function(t){return t&&typeof gp=="function"&&t.constructor===gp&&t!==gp.prototype?"symbol":typeof t},DE(s)}var $O=A(Td.f("toPrimitive"));function PE(s){var t=function(i,a){if(DE(i)!=="object"||i===null)return i;var l=i[$O];if(l!==void 0){var p=l.call(i,a||"default");if(DE(p)!=="object")return p;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(i)}(s,"string");return DE(t)==="symbol"?t:String(t)}function P(s,t,i){return(t=PE(t))in s?ox(s,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):s[t]=i,s}var OF=sa("Array").keys,D=Pa,NF=ji,DF=ge,PF=OF,JI=Array.prototype,kF={DOMTokenList:!0,NodeList:!0},Ho=A(function(s){var t=s.keys;return s===JI||DF(JI,s)&&t===JI.keys||NF(kF,D(s))?PF:t}),eN=md,ka=TypeError,XI=YS,LF=Math.floor,tT=function(s,t){var i=s.length,a=LF(i/2);return i<8?MF(s,t):QI(s,tT(XI(s,0,a),t),tT(XI(s,a),t),t)},MF=function(s,t){for(var i,a,l=s.length,p=1;p<l;){for(a=p,i=s[p];a&&t(s[a-1],i)>0;)s[a]=s[--a];a!==p++&&(s[a]=i)}return s},QI=function(s,t,i,a){for(var l=t.length,p=i.length,f=0,g=0;f<l||g<p;)s[f+g]=f<l&&g<p?a(t[f],i[g])<=0?t[f++]:i[g++]:f<l?t[f++]:i[g++];return s},UF=tT,xF=O,nT=function(s,t){var i=[][s];return!!i&&xF(function(){i.call(null,t||function(){return 1},1)})},tN=$a.match(/firefox\/(\d+)/i),ZI=!!tN&&+tN[1],nN=/MSIE|Trident/.test($a),iN=$a.match(/AppleWebKit\/(\d+)\./),VF=!!iN&&+iN[1],rN=Xt,sN=ae,FF=cs,oN=Oo,aN=Da,jF=function(s,t){if(!delete s[t])throw ka("Cannot delete property "+eN(t)+" of "+eN(s))},$I=Bs,eA=O,cN=UF,tA=nT,dN=ZI,BF=nN,nA=ec,lN=VF,Yl=[],iA=sN(Yl.sort),Ju=sN(Yl.push),uN=eA(function(){Yl.sort(void 0)}),GF=eA(function(){Yl.sort(null)}),WF=tA("sort"),hN=!eA(function(){if(nA)return nA<70;if(!(dN&&dN>3)){if(BF)return!0;if(lN)return lN<603;var s,t,i,a,l="";for(s=65;s<76;s++){switch(t=String.fromCharCode(s),s){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(a=0;a<47;a++)Yl.push({k:t+a,v:i})}for(Yl.sort(function(p,f){return f.v-p.v}),a=0;a<Yl.length;a++)t=Yl[a].k.charAt(0),l.charAt(l.length-1)!==t&&(l+=t);return l!=="DGBEFHACIJK"}});rN({target:"Array",proto:!0,forced:uN||!GF||!WF||!hN},{sort:function(s){s!==void 0&&FF(s);var t=oN(this);if(hN)return s===void 0?iA(t):iA(t,s);var i,a,l=[],p=aN(t);for(a=0;a<p;a++)a in t&&Ju(l,t[a]);for(cN(l,function(f){return function(g,v){return v===void 0?-1:g===void 0?1:f!==void 0?+f(g,v)||0:$I(g)>$I(v)?1:-1}}(s)),i=aN(l),a=0;a<i;)t[a]=l[a++];for(;a<p;)jF(t,a++);return t}});var HF=sa("Array").sort,pN=ge,KF=HF,rA=Array.prototype,kE=A(function(s){var t=s.sort;return s===rA||pN(rA,s)&&t===rA.sort?KF:t}),sA=hr,LE=cp,YF=zu,zF=ls,qF=ae([].concat),JF=sA("Reflect","ownKeys")||function(s){var t=LE.f(zF(s)),i=YF.f;return i?qF(t,i(s)):t},mN=ji,XF=JF,fN=as,QF=ds,ZF=qr,$F=ra,_N=Error,ej=ae("".replace),EN=String(_N("zxcasd").stack),gN=/\n\s*at [^:]*:[^\n]*/,tj=gN.test(EN),SN=sr,nj=!O(function(){var s=Error("a");return!("stack"in s)||(Object.defineProperty(s,"stack",SN(1,7)),s.stack!==7)}),ij=ra,rj=function(s,t){if(tj&&typeof s=="string"&&!_N.prepareStackTrace)for(;t--;)s=ej(s,gN,"");return s},sj=nj,TN=Error.captureStackTrace,oj=yd,CN=wn("iterator"),aj=Array.prototype,cj=Pa,vN=N_,RN=zh,dj=yd,yN=wn("iterator"),IN=function(s){if(!RN(s))return vN(s,yN)||vN(s,"@@iterator")||dj[cj(s)]},lj=Nt,uj=cs,iT=ls,hj=md,pj=IN,mj=TypeError,fj=Nt,AN=ls,_j=N_,oA=xc,Ej=Nt,wN=ls,gj=md,bN=function(s){return s!==void 0&&(oj.Array===s||aj[CN]===s)},Sj=Da,ON=ge,Tj=function(s,t){var i=arguments.length<2?pj(s):t;if(uj(i))return iT(lj(i,s));throw mj(hj(s)+" is not iterable")},Cj=IN,NN=function(s,t,i){var a,l;AN(s);try{if(!(a=_j(s,"return"))){if(t==="throw")throw i;return i}a=fj(a,s)}catch(p){l=!0,a=p}if(t==="throw")throw i;if(l)throw a;return AN(a),i},vj=TypeError,ME=function(s,t){this.stopped=s,this.result=t},DN=ME.prototype,UE=function(s,t,i){var a,l,p,f,g,v,y,I=i&&i.that,b=!(!i||!i.AS_ENTRIES),k=!(!i||!i.IS_RECORD),U=!(!i||!i.IS_ITERATOR),J=!(!i||!i.INTERRUPTED),K=oA(t,I),q=function(de){return a&&NN(a,"normal",de),new ME(!0,de)},te=function(de){return b?(wN(de),J?K(de[0],de[1],q):K(de[0],de[1])):J?K(de,q):K(de)};if(k)a=s.iterator;else if(U)a=s;else{if(!(l=Cj(s)))throw vj(gj(s)+" is not iterable");if(bN(l)){for(p=0,f=Sj(s);f>p;p++)if((g=te(s[p]))&&ON(DN,g))return g;return new ME(!1)}a=Tj(s,l)}for(v=k?s.next:a.next;!(y=Ej(v,a)).done;){try{g=te(y.value)}catch(de){NN(a,"throw",de)}if(typeof g=="object"&&g&&ON(DN,g))return g}return new ME(!1)},PN=Bs,Rj=Xt,rT=ge,kN=AE,Xu=oF,yj=function(s,t,i){for(var a=XF(t),l=QF.f,p=fN.f,f=0;f<a.length;f++){var g=a[f];mN(s,g)||i&&mN(i,g)||l(s,g,p(t,g))}},LN=Yu,aA=ra,cA=sr,sT=function(s,t){ZF(t)&&"cause"in t&&$F(s,"cause",t.cause)},Ij=function(s,t,i,a){sj&&(TN?TN(s,t):ij(s,"stack",rj(i,a)))},MN=UE,dA=function(s,t){return s===void 0?arguments.length<2?"":t:PN(s)},lA=wn("toStringTag"),oT=Error,Aj=[].push,Mm=function(s,t){var i,a=rT(uA,this);Xu?i=Xu(oT(),a?kN(this):uA):(i=a?this:LN(uA),aA(i,lA,"Error")),t!==void 0&&aA(i,"message",dA(t)),Ij(i,Mm,i.stack,1),arguments.length>2&&sT(i,arguments[2]);var l=[];return MN(s,Aj,{that:l}),aA(i,"errors",l),i};Xu?Xu(Mm,oT):yj(Mm,oT,{name:!0});var uA=Mm.prototype=LN(oT.prototype,{constructor:cA(1,Mm),message:cA(1,""),name:cA(1,"AggregateError")});Rj({global:!0,constructor:!0,arity:2},{AggregateError:Mm});var xE,zl,UN,Qu,Sp=typeof process<"u"&&dt(process)=="process",VE=hr,Um=aE,xN=ii,aT=wn("species"),FE=ge,wj=TypeError,bj=KS,Oj=md,VN=TypeError,FN=ls,Nj=function(s){if(bj(s))return s;throw VN(Oj(s)+" is not a constructor")},hA=zh,Dj=wn("species"),jN=function(s,t){var i,a=FN(s).constructor;return a===void 0||hA(i=FN(a)[Dj])?t:Nj(i)},Pj=TypeError,pA=/(?:ipad|iphone|ipod).*applewebkit/i.test($a),oc=Fe,kj=ve,Lj=xc,mA=Ft,Mj=ji,jE=O,fA=Oy,ac=hI,BN=M_,Uj=function(s,t){if(s<t)throw Pj("Not enough arguments");return s},GN=pA,xj=Sp,cT=oc.setImmediate,dT=oc.clearImmediate,Vj=oc.process,lT=oc.Dispatch,Fj=oc.Function,WN=oc.MessageChannel,jj=oc.String,BE=0,Tp={},HN="onreadystatechange";jE(function(){xE=oc.location});var GE=function(s){if(Mj(Tp,s)){var t=Tp[s];delete Tp[s],t()}},_A=function(s){return function(){GE(s)}},EA=function(s){GE(s.data)},KN=function(s){oc.postMessage(jj(s),xE.protocol+"//"+xE.host)};cT&&dT||(cT=function(s){Uj(arguments.length,1);var t=mA(s)?s:Fj(s),i=ac(arguments,1);return Tp[++BE]=function(){kj(t,void 0,i)},zl(BE),BE},dT=function(s){delete Tp[s]},xj?zl=function(s){Vj.nextTick(_A(s))}:lT&&lT.now?zl=function(s){lT.now(_A(s))}:WN&&!GN?(Qu=(UN=new WN).port2,UN.port1.onmessage=EA,zl=Lj(Qu.postMessage,Qu)):oc.addEventListener&&mA(oc.postMessage)&&!oc.importScripts&&xE&&xE.protocol!=="file:"&&!jE(KN)?(zl=KN,oc.addEventListener("message",EA,!1)):zl=HN in BN("script")?function(s){fA.appendChild(BN("script"))[HN]=function(){fA.removeChild(this),GE(s)}}:function(s){setTimeout(_A(s),0)});var uT={set:cT,clear:dT},xm=function(){this.head=null,this.tail=null};xm.prototype={add:function(s){var t={item:s,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var s=this.head;if(s)return(this.head=s.next)===null&&(this.tail=null),s.item}};var Cp,WE,HE,hT,gA,SA=xm,YN=/ipad|iphone|ipod/i.test($a)&&typeof Pebble<"u",Vm=/web0s(?!.*chrome)/i.test($a),ql=Fe,pT=xc,TA=as.f,mT=uT.set,zN=SA,Bj=pA,Gj=YN,vp=Vm,fT=Sp,qN=ql.MutationObserver||ql.WebKitMutationObserver,_T=ql.document,JN=ql.process,ET=ql.Promise,XN=TA(ql,"queueMicrotask"),CA=XN&&XN.value;if(!CA){var Fm=new zN,KE=function(){var s,t;for(fT&&(s=JN.domain)&&s.exit();t=Fm.get();)try{t()}catch(i){throw Fm.head&&Cp(),i}s&&s.enter()};Bj||fT||vp||!qN||!_T?!Gj&&ET&&ET.resolve?((hT=ET.resolve(void 0)).constructor=ET,gA=pT(hT.then,hT),Cp=function(){gA(KE)}):fT?Cp=function(){JN.nextTick(KE)}:(mT=pT(mT,ql),Cp=function(){mT(KE)}):(WE=!0,HE=_T.createTextNode(""),new qN(KE).observe(HE,{characterData:!0}),Cp=function(){HE.data=WE=!WE}),CA=function(s){Fm.head||Cp(),Fm.add(s)}}var QN=CA,Rp=function(s){try{return{error:!1,value:s()}}catch(t){return{error:!0,value:t}}},$d=Fe.Promise,vA=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",RA=!vA&&!Sp&&typeof window=="object"&&typeof document=="object",gT=Fe,Zu=$d,Wj=Ft,jm=gR,yp=_y,ZN=wn,Hj=RA,Kj=vA,Ip=ec,$N=Zu&&Zu.prototype,Yj=ZN("species"),eD=!1,tD=Wj(gT.PromiseRejectionEvent),zj=jm("Promise",function(){var s=yp(Zu),t=s!==String(Zu);if(!t&&Ip===66||!$N.catch||!$N.finally)return!0;if(!Ip||Ip<51||!/native code/.test(s)){var i=new Zu(function(l){l(1)}),a=function(l){l(function(){},function(){})};if((i.constructor={})[Yj]=a,!(eD=i.then(function(){})instanceof a))return!0}return!t&&(Hj||Kj)&&!tD}),YE={CONSTRUCTOR:zj,REJECTION_EVENT:tD,SUBCLASSING:eD},Fc={},yA=cs,qj=TypeError,nD=function(s){var t,i;this.promise=new s(function(a,l){if(t!==void 0||i!==void 0)throw qj("Bad Promise constructor");t=a,i=l}),this.resolve=yA(t),this.reject=yA(i)};Fc.f=function(s){return new nD(s)};var ST,iD,zE=Xt,cc=Sp,Jl=Fe,qE=Nt,Jj=Vc,IA=nc,rD=function(s){var t=VE(s);xN&&t&&!t[aT]&&Um(t,aT,{configurable:!0,get:function(){return this}})},Xj=cs,Bm=Ft,$u=qr,JE=function(s,t){if(FE(t,s))return s;throw wj("Incorrect invocation")},Qj=jN,sD=uT.set,AA=QN,Zj=function(s,t){try{arguments.length==1?console.error(s):console.error(s,t)}catch{}},wA=Rp,$j=SA,oD=Bl,bA=$d,OA=YE,TT=Fc,CT="Promise",aD=OA.CONSTRUCTOR,eB=OA.REJECTION_EVENT,vT=oD.getterFor(CT),NA=oD.set,cD=bA&&bA.prototype,Gm=bA,Wm=cD,DA=Jl.TypeError,PA=Jl.document,XE=Jl.process,kA=TT.f,tB=kA,QE=!!(PA&&PA.createEvent&&Jl.dispatchEvent),RT="unhandledrejection",LA=function(s){var t;return!(!$u(s)||!Bm(t=s.then))&&t},yT=function(s,t){var i,a,l,p=t.value,f=t.state==1,g=f?s.ok:s.fail,v=s.resolve,y=s.reject,I=s.domain;try{g?(f||(t.rejection===2&&lD(t),t.rejection=1),g===!0?i=p:(I&&I.enter(),i=g(p),I&&(I.exit(),l=!0)),i===s.promise?y(DA("Promise-chain cycle")):(a=LA(i))?qE(a,i,v,y):v(i)):y(p)}catch(b){I&&!l&&I.exit(),y(b)}},IT=function(s,t){s.notified||(s.notified=!0,AA(function(){for(var i,a=s.reactions;i=a.get();)yT(i,s);s.notified=!1,t&&!s.rejection&&nB(s)}))},AT=function(s,t,i){var a,l;QE?((a=PA.createEvent("Event")).promise=t,a.reason=i,a.initEvent(s,!1,!0),Jl.dispatchEvent(a)):a={promise:t,reason:i},!eB&&(l=Jl["on"+s])?l(a):s===RT&&Zj("Unhandled promise rejection",i)},nB=function(s){qE(sD,Jl,function(){var t,i=s.facade,a=s.value;if(dD(s)&&(t=wA(function(){cc?XE.emit("unhandledRejection",a,i):AT(RT,i,a)}),s.rejection=cc||dD(s)?2:1,t.error))throw t.value})},dD=function(s){return s.rejection!==1&&!s.parent},lD=function(s){qE(sD,Jl,function(){var t=s.facade;cc?XE.emit("rejectionHandled",t):AT("rejectionhandled",t,s.value)})},Ap=function(s,t,i){return function(a){s(t,a,i)}},wp=function(s,t,i){s.done||(s.done=!0,i&&(s=i),s.value=t,s.state=2,IT(s,!0))},wT=function(s,t,i){if(!s.done){s.done=!0,i&&(s=i);try{if(s.facade===t)throw DA("Promise can't be resolved itself");var a=LA(t);a?AA(function(){var l={done:!1};try{qE(a,t,Ap(wT,l,s),Ap(wp,l,s))}catch(p){wp(l,p,s)}}):(s.value=t,s.state=1,IT(s,!1))}catch(l){wp({done:!1},l,s)}}};aD&&(Wm=(Gm=function(s){JE(this,Wm),Xj(s),qE(ST,this);var t=vT(this);try{s(Ap(wT,t),Ap(wp,t))}catch(i){wp(t,i)}}).prototype,(ST=function(s){NA(this,{type:CT,done:!1,notified:!1,parent:!1,reactions:new $j,rejection:!1,state:0,value:void 0})}).prototype=Jj(Wm,"then",function(s,t){var i=vT(this),a=kA(Qj(this,Gm));return i.parent=!0,a.ok=!Bm(s)||s,a.fail=Bm(t)&&t,a.domain=cc?XE.domain:void 0,i.state==0?i.reactions.add(a):AA(function(){yT(a,i)}),a.promise}),iD=function(){var s=new ST,t=vT(s);this.promise=s,this.resolve=Ap(wT,t),this.reject=Ap(wp,t)},TT.f=kA=function(s){return s===Gm||s===void 0?new iD(s):tB(s)}),zE({global:!0,constructor:!0,wrap:!0,forced:aD},{Promise:Gm}),IA(Gm,CT,!1,!0),rD(CT);var MA=wn("iterator"),uD=!1;try{var hD=0,pD={next:function(){return{done:!!hD++}},return:function(){uD=!0}};pD[MA]=function(){return this},Array.from(pD,function(){throw 2})}catch{}var Hm=$d,Km=function(s,t){if(!uD)return!1;var i=!1;try{var a={};a[MA]=function(){return{next:function(){return{done:i=!0}}}},s(a)}catch{}return i},Ym=YE.CONSTRUCTOR||!Km(function(s){Hm.all(s).then(void 0,function(){})}),mD=Nt,fD=cs,iB=Fc,_D=Rp,rB=UE;Xt({target:"Promise",stat:!0,forced:Ym},{all:function(s){var t=this,i=iB.f(t),a=i.resolve,l=i.reject,p=_D(function(){var f=fD(t.resolve),g=[],v=0,y=1;rB(s,function(I){var b=v++,k=!1;y++,mD(f,t,I).then(function(U){k||(k=!0,g[b]=U,--y||a(g))},l)}),--y||a(g)});return p.error&&l(p.value),i.promise}});var sB=Xt,bT=YE.CONSTRUCTOR;$d&&$d.prototype,sB({target:"Promise",proto:!0,forced:bT,real:!0},{catch:function(s){return this.then(void 0,s)}});var oB=Nt,aB=cs,cB=Fc,dB=Rp,lB=UE;Xt({target:"Promise",stat:!0,forced:Ym},{race:function(s){var t=this,i=cB.f(t),a=i.reject,l=dB(function(){var p=aB(t.resolve);lB(s,function(f){oB(p,t,f).then(i.resolve,a)})});return l.error&&a(l.value),i.promise}});var uB=Nt,hB=Fc;Xt({target:"Promise",stat:!0,forced:YE.CONSTRUCTOR},{reject:function(s){var t=hB.f(this);return uB(t.reject,void 0,s),t.promise}});var pB=ls,mB=qr,fB=Fc,ED=function(s,t){if(pB(s),mB(t)&&t.constructor===s)return t;var i=fB.f(s);return(0,i.resolve)(t),i.promise},_B=Xt,EB=$d,gB=YE.CONSTRUCTOR,SB=ED,TB=hr("Promise"),CB=!gB;_B({target:"Promise",stat:!0,forced:!0},{resolve:function(s){return SB(CB&&this===TB?EB:this,s)}});var gD=Nt,vB=cs,RB=Fc,yB=Rp,IB=UE;Xt({target:"Promise",stat:!0,forced:Ym},{allSettled:function(s){var t=this,i=RB.f(t),a=i.resolve,l=i.reject,p=yB(function(){var f=vB(t.resolve),g=[],v=0,y=1;IB(s,function(I){var b=v++,k=!1;y++,gD(f,t,I).then(function(U){k||(k=!0,g[b]={status:"fulfilled",value:U},--y||a(g))},function(U){k||(k=!0,g[b]={status:"rejected",reason:U},--y||a(g))})}),--y||a(g)});return p.error&&l(p.value),i.promise}});var AB=Nt,wB=cs,bB=hr,OB=Fc,NB=Rp,DB=UE,SD="No one promise resolved";Xt({target:"Promise",stat:!0,forced:Ym},{any:function(s){var t=this,i=bB("AggregateError"),a=OB.f(t),l=a.resolve,p=a.reject,f=NB(function(){var g=wB(t.resolve),v=[],y=0,I=1,b=!1;DB(s,function(k){var U=y++,J=!1;I++,AB(g,t,k).then(function(K){J||b||(b=!0,l(K))},function(K){J||b||(J=!0,v[U]=K,--I||p(new i(v,SD)))})}),--I||p(new i(v,SD))});return f.error&&p(f.value),a.promise}});var PB=Xt,UA=$d,kB=O,LB=hr,MB=Ft,UB=jN,xA=ED,xB=UA&&UA.prototype;PB({target:"Promise",proto:!0,real:!0,forced:!!UA&&kB(function(){xB.finally.call({then:function(){}},function(){})})},{finally:function(s){var t=UB(this,LB("Promise")),i=MB(s);return this.then(i?function(a){return xA(t,s()).then(function(){return a})}:s,i?function(a){return xA(t,s()).then(function(){throw a})}:s)}});var OT=po.Promise,Pe=A(OT);let VB=()=>{};function ZE(){let s={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:VB};return s.promise=new Pe((t,i)=>{s.resolve=a=>{s.isFinished||(s.isResolved=!0,s.isFinished=!0,t(a),s.value=a)},s.reject=a=>{s.isFinished||(s.isRejected=!0,s.isFinished=!0,i(a))}}),s}let NT=new Map,$E=new Map,el=new Map;var Cr,Ee;(function(s){s.WIN_10="Windows 10",s.WIN_81="Windows 8.1",s.WIN_8="Windows 8",s.WIN_7="Windows 7",s.WIN_VISTA="Windows Vista",s.WIN_SERVER_2003="Windows Server 2003",s.WIN_XP="Windows XP",s.WIN_2000="Windows 2000",s.ANDROID="Android",s.HARMONY_OS="HarmonyOS",s.OPEN_BSD="Open BSD",s.SUN_OS="Sun OS",s.LINUX="Linux",s.IOS="iOS",s.MAC_OS="Mac OS",s.CHROMIUM_OS="Chromium OS",s.QNX="QNX",s.UNIX="UNIX",s.BEOS="BeOS",s.OS_2="OS/2",s.SEARCH_BOT="Search Bot"})(Cr||(Cr={})),function(s){s.CHROME="Chrome",s.SAFARI="Safari",s.EDGE="Edge",s.FIREFOX="Firefox",s.OPERA="OPR",s.QQ="QQBrowser",s.WECHAT="MicroMessenger"}(Ee||(Ee={}));var VA={exports:{}};(function(s,t){(function(i,a){var l="function",p="undefined",f="object",g="string",v="major",y="model",I="name",b="type",k="vendor",U="version",J="architecture",K="console",q="mobile",te="tablet",de="smarttv",he="wearable",Ue="embedded",Re="Amazon",Ie="Apple",De="ASUS",Ne="BlackBerry",Xe="Browser",nt="Chrome",Vt="Firefox",rn="Google",ui="Huawei",Ki="LG",_i="Microsoft",Ia="Motorola",He="Opera",rt="Samsung",mt="Sharp",Wt="Sony",_n="Xiaomi",ot="Zebra",B="Facebook",ie="Chromium OS",pe="Mac OS",Ze=function(vi){for(var Er={},Ri=0;Ri<vi.length;Ri++)Er[vi[Ri].toUpperCase()]=vi[Ri];return Er},zt=function(vi,Er){return typeof vi===g&&Ei(Er).indexOf(Ei(vi))!==-1},Ei=function(vi){return vi.toLowerCase()},Mr=function(vi,Er){if(typeof vi===g)return vi=vi.replace(/^\s\s*/,""),typeof Er===p?vi:vi.substring(0,350)},jo=function(vi,Er){for(var Ri,ta,Bo,$n,mn,Io,rd=0;rd<Er.length&&!mn;){var sd=Er[rd],Ur=Er[rd+1];for(Ri=ta=0;Ri<sd.length&&!mn&&sd[Ri];)if(mn=sd[Ri++].exec(vi))for(Bo=0;Bo<Ur.length;Bo++)Io=mn[++ta],typeof($n=Ur[Bo])===f&&$n.length>0?$n.length===2?typeof $n[1]==l?this[$n[0]]=$n[1].call(this,Io):this[$n[0]]=$n[1]:$n.length===3?typeof $n[1]!==l||$n[1].exec&&$n[1].test?this[$n[0]]=Io?Io.replace($n[1],$n[2]):a:this[$n[0]]=Io?$n[1].call(this,Io,$n[2]):a:$n.length===4&&(this[$n[0]]=Io?$n[3].call(this,Io.replace($n[1],$n[2])):a):this[$n]=Io||a;rd+=2}},Bd=function(vi,Er){for(var Ri in Er)if(typeof Er[Ri]===f&&Er[Ri].length>0){for(var ta=0;ta<Er[Ri].length;ta++)if(zt(Er[Ri][ta],vi))return Ri==="?"?a:Ri}else if(zt(Er[Ri],vi))return Ri==="?"?a:Ri;return vi},SS={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Aa={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[U,[I,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[U,[I,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[I,U],[/opios[\/ ]+([\w\.]+)/i],[U,[I,He+" Mini"]],[/\bopr\/([\w\.]+)/i],[U,[I,He]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[I,U],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[U,[I,"UC"+Xe]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[U,[I,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[U,[I,"WeChat"]],[/konqueror\/([\w\.]+)/i],[U,[I,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[U,[I,"IE"]],[/yabrowser\/([\w\.]+)/i],[U,[I,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[I,/(.+)/,"$1 Secure "+Xe],U],[/\bfocus\/([\w\.]+)/i],[U,[I,Vt+" Focus"]],[/\bopt\/([\w\.]+)/i],[U,[I,He+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[U,[I,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[U,[I,"Dolphin"]],[/coast\/([\w\.]+)/i],[U,[I,He+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[U,[I,"MIUI "+Xe]],[/fxios\/([-\w\.]+)/i],[U,[I,Vt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[I,"360 "+Xe]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[I,/(.+)/,"$1 "+Xe],U],[/(comodo_dragon)\/([\w\.]+)/i],[[I,/_/g," "],U],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[I,U],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[I],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[I,B],U],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[I,U],[/\bgsa\/([\w\.]+) .*safari\//i],[U,[I,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[U,[I,nt+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[I,nt+" WebView"],U],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[U,[I,"Android "+Xe]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[I,U],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[U,[I,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[U,I],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[I,[U,Bd,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[I,U],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[I,"Netscape"],U],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[U,[I,Vt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[I,U],[/(cobalt)\/([\w\.]+)/i],[I,[U,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[J,"amd64"]],[/(ia32(?=;))/i],[[J,Ei]],[/((?:i[346]|x)86)[;\)]/i],[[J,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[J,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[J,"armhf"]],[/windows (ce|mobile); ppc;/i],[[J,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[J,/ower/,"",Ei]],[/(sun4\w)[;\)]/i],[[J,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[J,Ei]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[y,[k,rt],[b,te]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[y,[k,rt],[b,q]],[/\((ip(?:hone|od)[\w ]*);/i],[y,[k,Ie],[b,q]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[y,[k,Ie],[b,te]],[/(macintosh);/i],[y,[k,Ie]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[y,[k,mt],[b,q]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[y,[k,ui],[b,te]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[y,[k,ui],[b,q]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[y,/_/g," "],[k,_n],[b,q]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[y,/_/g," "],[k,_n],[b,te]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[y,[k,"OPPO"],[b,q]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[y,[k,"Vivo"],[b,q]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[y,[k,"Realme"],[b,q]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[y,[k,Ia],[b,q]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[y,[k,Ia],[b,te]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[y,[k,Ki],[b,te]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[y,[k,Ki],[b,q]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[y,[k,"Lenovo"],[b,te]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[y,/_/g," "],[k,"Nokia"],[b,q]],[/(pixel c)\b/i],[y,[k,rn],[b,te]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[y,[k,rn],[b,q]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[y,[k,Wt],[b,q]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[y,"Xperia Tablet"],[k,Wt],[b,te]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[y,[k,"OnePlus"],[b,q]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[y,[k,Re],[b,te]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[y,/(.+)/g,"Fire Phone $1"],[k,Re],[b,q]],[/(playbook);[-\w\),; ]+(rim)/i],[y,k,[b,te]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[y,[k,Ne],[b,q]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[y,[k,De],[b,te]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[y,[k,De],[b,q]],[/(nexus 9)/i],[y,[k,"HTC"],[b,te]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[k,[y,/_/g," "],[b,q]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[y,[k,"Acer"],[b,te]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[y,[k,"Meizu"],[b,q]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[k,y,[b,q]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[k,y,[b,te]],[/(surface duo)/i],[y,[k,_i],[b,te]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[y,[k,"Fairphone"],[b,q]],[/(u304aa)/i],[y,[k,"AT&T"],[b,q]],[/\bsie-(\w*)/i],[y,[k,"Siemens"],[b,q]],[/\b(rct\w+) b/i],[y,[k,"RCA"],[b,te]],[/\b(venue[\d ]{2,7}) b/i],[y,[k,"Dell"],[b,te]],[/\b(q(?:mv|ta)\w+) b/i],[y,[k,"Verizon"],[b,te]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[y,[k,"Barnes & Noble"],[b,te]],[/\b(tm\d{3}\w+) b/i],[y,[k,"NuVision"],[b,te]],[/\b(k88) b/i],[y,[k,"ZTE"],[b,te]],[/\b(nx\d{3}j) b/i],[y,[k,"ZTE"],[b,q]],[/\b(gen\d{3}) b.+49h/i],[y,[k,"Swiss"],[b,q]],[/\b(zur\d{3}) b/i],[y,[k,"Swiss"],[b,te]],[/\b((zeki)?tb.*\b) b/i],[y,[k,"Zeki"],[b,te]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[k,"Dragon Touch"],y,[b,te]],[/\b(ns-?\w{0,9}) b/i],[y,[k,"Insignia"],[b,te]],[/\b((nxa|next)-?\w{0,9}) b/i],[y,[k,"NextBook"],[b,te]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[k,"Voice"],y,[b,q]],[/\b(lvtel\-)?(v1[12]) b/i],[[k,"LvTel"],y,[b,q]],[/\b(ph-1) /i],[y,[k,"Essential"],[b,q]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[y,[k,"Envizen"],[b,te]],[/\b(trio[-\w\. ]+) b/i],[y,[k,"MachSpeed"],[b,te]],[/\btu_(1491) b/i],[y,[k,"Rotor"],[b,te]],[/(shield[\w ]+) b/i],[y,[k,"Nvidia"],[b,te]],[/(sprint) (\w+)/i],[k,y,[b,q]],[/(kin\.[onetw]{3})/i],[[y,/\./g," "],[k,_i],[b,q]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[y,[k,ot],[b,te]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[y,[k,ot],[b,q]],[/smart-tv.+(samsung)/i],[k,[b,de]],[/hbbtv.+maple;(\d+)/i],[[y,/^/,"SmartTV"],[k,rt],[b,de]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[k,Ki],[b,de]],[/(apple) ?tv/i],[k,[y,Ie+" TV"],[b,de]],[/crkey/i],[[y,nt+"cast"],[k,rn],[b,de]],[/droid.+aft(\w)( bui|\))/i],[y,[k,Re],[b,de]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[y,[k,mt],[b,de]],[/(bravia[\w ]+)( bui|\))/i],[y,[k,Wt],[b,de]],[/(mitv-\w{5}) bui/i],[y,[k,_n],[b,de]],[/Hbbtv.*(technisat) (.*);/i],[k,y,[b,de]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[k,Mr],[y,Mr],[b,de]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[b,de]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[k,y,[b,K]],[/droid.+; (shield) bui/i],[y,[k,"Nvidia"],[b,K]],[/(playstation [345portablevi]+)/i],[y,[k,Wt],[b,K]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[y,[k,_i],[b,K]],[/((pebble))app/i],[k,y,[b,he]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[y,[k,Ie],[b,he]],[/droid.+; (glass) \d/i],[y,[k,rn],[b,he]],[/droid.+; (wt63?0{2,3})\)/i],[y,[k,ot],[b,he]],[/(quest( 2| pro)?)/i],[y,[k,B],[b,he]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[k,[b,Ue]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[y,[b,q]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[y,[b,te]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[b,te]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[b,q]],[/(android[-\w\. ]{0,9});.+buil/i],[y,[k,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[U,[I,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[U,[I,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[I,U],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[U,I]],os:[[/microsoft (windows) (vista|xp)/i],[I,U],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[I,[U,Bd,SS]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[I,"Windows"],[U,Bd,SS]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[U,/_/g,"."],[I,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[I,pe],[U,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[U,I],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[I,U],[/\(bb(10);/i],[U,[I,Ne]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[U,[I,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[U,[I,Vt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[U,[I,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[U,[I,"watchOS"]],[/crkey\/([\d\.]+)/i],[U,[I,nt+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[I,ie],U],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[I,U],[/(sunos) ?([\w\.\d]*)/i],[[I,"Solaris"],U],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[I,U]]},Ro=function(vi,Er){if(typeof vi===f&&(Er=vi,vi=a),!(this instanceof Ro))return new Ro(vi,Er).getResult();var Ri=typeof i!==p&&i.navigator?i.navigator:a,ta=vi||(Ri&&Ri.userAgent?Ri.userAgent:""),Bo=Ri&&Ri.userAgentData?Ri.userAgentData:a,$n=Er?function(mn,Io){var rd={};for(var sd in mn)Io[sd]&&Io[sd].length%2==0?rd[sd]=Io[sd].concat(mn[sd]):rd[sd]=mn[sd];return rd}(Aa,Er):Aa;return this.getBrowser=function(){var mn={};return mn[I]=a,mn[U]=a,jo.call(mn,ta,$n.browser),mn[v]=function(Io){return typeof Io===g?Io.replace(/[^\d\.]/g,"").split(".")[0]:a}(mn[U]),Ri&&Ri.brave&&typeof Ri.brave.isBrave==l&&(mn[I]="Brave"),mn},this.getCPU=function(){var mn={};return mn[J]=a,jo.call(mn,ta,$n.cpu),mn},this.getDevice=function(){var mn={};return mn[k]=a,mn[y]=a,mn[b]=a,jo.call(mn,ta,$n.device),!mn[b]&&Bo&&Bo.mobile&&(mn[b]=q),mn[y]=="Macintosh"&&Ri&&typeof Ri.standalone!==p&&Ri.maxTouchPoints&&Ri.maxTouchPoints>2&&(mn[y]="iPad",mn[b]=te),mn},this.getEngine=function(){var mn={};return mn[I]=a,mn[U]=a,jo.call(mn,ta,$n.engine),mn},this.getOS=function(){var mn={};return mn[I]=a,mn[U]=a,jo.call(mn,ta,$n.os),!mn[I]&&Bo&&Bo.platform!="Unknown"&&(mn[I]=Bo.platform.replace(/chrome os/i,ie).replace(/macos/i,pe)),mn},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return ta},this.setUA=function(mn){return ta=typeof mn===g&&mn.length>350?Mr(mn,350):mn,this},this.setUA(ta),this};Ro.VERSION="0.7.34",Ro.BROWSER=Ze([I,U,v]),Ro.CPU=Ze([J]),Ro.DEVICE=Ze([y,k,b,K,q,de,te,he,Ue]),Ro.ENGINE=Ro.OS=Ze([I,U]),s.exports&&(t=s.exports=Ro),t.UAParser=Ro;var yo=typeof i!==p&&(i.jQuery||i.Zepto);if(yo&&!yo.ua){var wl=new Ro;yo.ua=wl.getResult(),yo.ua.get=function(){return wl.getUA()},yo.ua.set=function(vi){wl.setUA(vi);var Er=wl.getResult();for(var Ri in Er)yo.ua[Ri]=Er[Ri]}}})(typeof window=="object"?window:T)})(VA,VA.exports);let zm=new(A(VA.exports)),jc=zm.getResult(),qm=null;function En(s){if(!qm){jc=zm.getResult();let t=function(p){if(p.engine.name==="Blink"&&p.browser.name!=="WeChat")return Ee.CHROME;switch(p.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Ee.CHROME;case"Safari":case"Mobile Safari":return Ee.SAFARI;case"Edge":return Ee.EDGE;case"Firefox":return Ee.FIREFOX;case"QQBrowser":return Ee.QQ;case"Opera":return Ee.OPERA;case"WeChat":return Ee.WECHAT;default:return p.browser.name||""}}(jc),i=function(p){let f;return f=p.engine.name==="Blink"?p.engine.version||"":p.browser.version||"",f.split(".")[0]}(jc),a=function(p){return p.os.name==="Windows"?p.os.version?p.os.name+" "+p.os.version:p.os.name:p.os.name||""}(jc),l=jc.os.version;if(!(t&&i&&a&&l))return{name:t,version:i,os:a,osVersion:l};qm={name:t,version:i,os:a,osVersion:l}}return qm}function ar(){return En().os}function Pn(){let s=En();return"".concat(s.os," ").concat(s.osVersion)}function Jm(){let s=En();return!!(jc.engine.name==="WebKit"&&s.os===Cr.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&s.name!==Ee.SAFARI||Gs()&&s.name!==Ee.SAFARI)}function TD(){let s=En();if(Jm()){if(s.os===Cr.MAC_OS)return!0;if(s.os===Cr.IOS){let t=jc.os.version&&jc.os.version.split(".");if(t&&Number(t[0])===14&&t[1]&&Number(t[1])>=3||t&&Number(t[0])>14)return!0}}return!1}function Xl(){return jc.engine.name==="WebKit"}function bp(){return En().name===Ee.CHROME}function qt(){return En().name===Ee.SAFARI}function Hn(){return En().name===Ee.FIREFOX}function Gs(){return En().os===Cr.IOS}function Xm(s){let t=En();return!(t.name!==Ee.CHROME||!t.osVersion)&&Number(t.version)>=s}function CD(s){let t=En();return!(t.name!==Ee.EDGE||!t.osVersion)&&Number(t.version)>=s}function vD(s){let t=En();return!(t.name!==Ee.OPERA||!t.osVersion)&&Number(t.version)>=s}function tl(){let s=En();return!(s.name!==Ee.CHROME||!s.osVersion)&&Number(s.version)<=90}function Jr(){let s=En();if(s.os!==Cr.IOS||!s.osVersion)return!1;let t=s.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function Ln(){let s=En();if(s.os!==Cr.IOS||!s.osVersion)return!1;let t=s.osVersion.split(".");return Number(t[0])===15}function Ds(){let s=En();if(s.os!==Cr.IOS||!s.osVersion)return!1;let t=s.osVersion.split(".");return Number(t[0])===16}function DT(){let s=En();if(s.os!==Cr.IOS||!s.osVersion)return!1;let t=s.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function Id(){return qt()&&navigator.maxTouchPoints>0}function FA(){return En().name===Ee.WECHAT}function jA(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Ql(){let s=En();return s.name===Ee.EDGE||s.name===Ee.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Zl(){return ar()===Cr.ANDROID}function Op(){let s=En();return Zl()&&(s.name===Ee.CHROME||s.name===Ee.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var Z;(function(s){s.UNEXPECTED_ERROR="UNEXPECTED_ERROR",s.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",s.TIMEOUT="TIMEOUT",s.INVALID_PARAMS="INVALID_PARAMS",s.NOT_READABLE="NOT_READABLE",s.NOT_SUPPORTED="NOT_SUPPORTED",s.INVALID_OPERATION="INVALID_OPERATION",s.OPERATION_ABORTED="OPERATION_ABORTED",s.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",s.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",s.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",s.DATACHANNEL_FAILED="DATACHANNEL_FAILED",s.NETWORK_ERROR="NETWORK_ERROR",s.NETWORK_TIMEOUT="NETWORK_TIMEOUT",s.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",s.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",s.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",s.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",s.ELECTRON_IS_NULL="ELECTRON_IS_NULL",s.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",s.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",s.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",s.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",s.PERMISSION_DENIED="PERMISSION_DENIED",s.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",s.TRACK_IS_DISABLED="TRACK_IS_DISABLED",s.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",s.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",s.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",s.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",s.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",s.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",s.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",s.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",s.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",s.UID_CONFLICT="UID_CONFLICT",s.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",s.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",s.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",s.INVALID_TRACK="INVALID_TRACK",s.SENDER_NOT_FOUND="SENDER_NOT_FOUND",s.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",s.SET_ANSWER_FAILED="SET_ANSWER_FAILED",s.ICE_FAILED="ICE_FAILED",s.PC_CLOSED="PC_CLOSED",s.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",s.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",s.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",s.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",s.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",s.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",s.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",s.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",s.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",s.INVALID_REMOTE_USER="INVALID_REMOTE_USER",s.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",s.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",s.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",s.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",s.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",s.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",s.WS_ABORT="WS_ABORT",s.WS_DISCONNECT="WS_DISCONNECT",s.WS_ERR="WS_ERR",s.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",s.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",s.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",s.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",s.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",s.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",s.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",s.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",s.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",s.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",s.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",s.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",s.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",s.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",s.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",s.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",s.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",s.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",s.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",s.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",s.INVALID_PLUGIN="INVALID_PLUGIN",s.DISCONNECT_P2P="DISCONNECT_P2P",s.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",s.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",s.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",s.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",s.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",s.PROHIBITED_OPERATION="PROHIBITED_OPERATION",s.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",s.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED"})(Z||(Z={}));let Ve=class extends Error{constructor(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(t),P(this,"code",void 0),P(this,"message",void 0),P(this,"data",void 0),P(this,"name","AgoraRTCException"),this.code=s,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return s==="error"&&(t||console).error(this.toString()),s==="warning"&&(t||console).warn(this.toString()),this}throw(s){throw this.print("error",s),this}};function $l(s,t){if(typeof s!="boolean")throw new Ve(Z.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function vr(s,t,i){if(!xe(i).call(i,s))throw new Ve(Z.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(i)))}function bn(s,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(s<i||s>a||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(l){return typeof l=="number"&&l%1==0}(s))throw new Ve(Z.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(i,", ").concat(a,"]. integer only"))}function Qm(s,t){if(typeof s!="number"){if(!(s.min||s.max||s.ideal||s.exact))throw new Ve(Z.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));s.min!==void 0&&bn(s.min,"".concat(t,".min"),0,1/0),s.max!==void 0&&bn(s.max,"".concat(t,".max"),1,1/0),s.exact!==void 0&&bn(s.exact,"".concat(t,".exact"),1,1/0),s.ideal!==void 0&&bn(s.ideal,"".concat(t,".ideal"),1,1/0)}else bn(s,t,1,1/0)}function jr(s,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,l=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(s==null)throw new Ve(Z.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!nl(s,i,a,l))throw new Ve(Z.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(i,",").concat(a,"].").concat(l?" ASCII characters only.":""))}function Q(s,t){if(!Array.isArray(s))throw new Ve(Z.INVALID_PARAMS,"".concat(t," should be an array"))}function ke(s){return s==null}function nl(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,a=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof s=="string"&&s.length<=i&&s.length>=t&&(!a||function(l){if(typeof l!="string")return!1;for(let p=0;p<l.length;p+=1){let f=l.charCodeAt(p);if(f<0||f>255)return!1}return!0}(s))}function Rr(s,t,i){if("getBigUint64"in DataView.prototype)return s.getBigUint64(t,i);let a=s.getUint32(t,i),l=s.getUint32(t+4,i),p=+!!i,f=+!i;return BigInt(a*f+l*p)<<BigInt(32)|BigInt(a*p+l*f)}function Jn(s,t,i,a){if("setBigUint64"in DataView.prototype)return s.setBigUint64(t,i,a);let l=Number(i>>BigInt(32)),p=Number(i&BigInt(4294967295));s.setUint32(t,l,a),s.setUint32(t+4,p,a)}var eh,Xr;(function(s){s.COVERED="COVERED",s.POSITION="POSITION",s.SIZE="SIZE",s.STYLE="STYLE"})(eh||(eh={})),function(s){s.UNMOUNTED="UNMOUNTED",s.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(Xr||(Xr={}));let il=new class{constructor(){P(this,"_clientSize",null),P(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),P(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),P(this,"getStyle",s=>window.getComputedStyle(s,null)),P(this,"checkCssVisibleProperty",s=>{var t;let i=!0,a=this.getStyle(s),{display:l,visibility:p,opacity:f,filter:g}=a;return(l==="none"||xe(t=["hidden","collapse"]).call(t,p)||Number(f)<.1)&&(i=!1),i?(g&&g.split(" ").filter(v=>{var y;let I=v.split("(")[0];return xe(y=["brightness","blur","opacity"]).call(y,I)}).map(v=>{let[y,I]=v.split(/\(|\)/);return[y,Number(I.match(/^[0-9\.]+/))]}).forEach(v=>{let[y,I]=v;switch(y){case"brightness":(I<.1||I>3)&&(i=!1);break;case"blur":I>3&&(i=!1);break;case"opacity":I<.1&&(i=!1)}}),i):!1}),P(this,"checkPropertyUpToAllParentNodes",(s,t)=>{let i=!0,a=!0,l=f=>t(f),p=s;for(;p&&a;)l(p)||(i=!1,a=!1),p=p.parentElement,p||(a=!1);return i}),P(this,"checkActualCssVisibleIncludeInherit",s=>this.checkPropertyUpToAllParentNodes(s,this.checkCssVisibleProperty)),P(this,"getSizeAboutClient",s=>{let{width:t,height:i,left:a,right:l,top:p,bottom:f}=s.getBoundingClientRect(),g=this.getClientWidth(),v=this.getClientHeight();return{width:t,height:i,left:a,right:l,top:p,bottom:f,clientWidth:g,clientHeight:v,clientMin:Math.min(g,v)}}),P(this,"checkActualSize",()=>{let{width:s,height:t,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(s,t,i)}),P(this,"elementFromPoint",(s,t)=>document.elementFromPoint?document.elementFromPoint(s,t):null),P(this,"checkCoverForAPoint",(s,t,i)=>{let a=this.elementFromPoint(s,t);return a!==null&&a!==i}),P(this,"getPointPositionList",()=>{let{width:s,height:t,left:i,top:a}=this._clientSize,l=s/6,p=t/6,f=[],g=10**6;for(let v=0;v<5;v++)for(let y=0;y<5;y++){let I=(i*g+(v===0?.1:v===4?(l*v*g-1e5)/g:l*v)*g)/g,b=(a*g+(y===0?.1:y===4?(p*y*g-1e5)/g:p*y)*g)/g;f.push({x:I,y:b})}return[...f]}),P(this,"checkElementCover",s=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,s)).filter(t=>!!t).length>6),P(this,"checkSizeIsVisible",(s,t,i)=>(s>50||i/s<=10)&&(t>50||i/t<=10)),P(this,"checkSizeOfPartInClient",()=>{let{left:s,right:t,top:i,bottom:a,clientHeight:l,clientWidth:p,clientMin:f}=this._clientSize,g,v,y,I;if(s<0)g=0;else{if(!(s<p))return!1;g=s}if(t<0)return!1;if(v=t<p?t:p,i<0)y=0;else{if(!(i<l))return!1;y=i}if(a<0)return!1;I=a<l?a:l;let b=v-g,k=I-y;return this.checkSizeIsVisible(b,k,f)}),P(this,"returnHiddenResult",s=>(this._clientSize=null,{visible:!1,reason:s})),P(this,"checkOneElementVisible",s=>{if(s instanceof HTMLElement){if(this.checkElementIsMountedOnDom(s)){if(this.checkActualCssVisibleIncludeInherit(s)){if(this._clientSize=this.getSizeAboutClient(s),this.checkElementCover(s))return this.returnHiddenResult(eh.COVERED);{let t=this.checkActualSize(),i=this.checkSizeOfPartInClient();return t&&!i?this.returnHiddenResult(eh.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(eh.SIZE)}}return this.returnHiddenResult(eh.STYLE)}return this.returnHiddenResult(Xr.UNMOUNTED)}return this.returnHiddenResult(Xr.INVALID_HTML_ELEMENT)}),P(this,"checkElementIsMountedOnDom",s=>this.checkPropertyUpToAllParentNodes(s,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function Ai(s){return new TextEncoder().encode(s)}let BA=function(s,t){let i=new Uint8Array(s.byteLength+t.byteLength);return i.set(new Uint8Array(s),0),i.set(new Uint8Array(t),s.byteLength),i},RD=async s=>{let t=function(p){let f=window.atob(p),g=new Uint8Array(new ArrayBuffer(f.length));for(let v=0;v<f.length;v+=1)g[v]=f.charCodeAt(v);return g}(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),i=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),a=Ai(s),l=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},i,a);return function(p){let f="";for(let g=0;g<p.length;g+=1)f+=String.fromCharCode(p[g]);return window.btoa(f)}(new Uint8Array(l))},PT=async s=>function(t,i){let a="";return new Uint8Array(t).forEach(l=>{a+=l.toString(i).padStart(2,"0")}),a}(await crypto.subtle.digest("SHA-256",Ai(s)),16);class ri{constructor(){P(this,"_events",{}),P(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(i=>i.listener):[]}on(t,i){this._events[t]||(this._events[t]=[]);let a=this._events[t];this._indexOfListener(a,i)===-1&&a.push({listener:i,once:!1})}once(t,i){this._events[t]||(this._events[t]=[]);let a=this._events[t];this._indexOfListener(a,i)===-1&&a.push({listener:i,once:!0})}off(t,i){if(!this._events[t])return;let a=this._events[t],l=this._indexOfListener(a,i);l!==-1&&a.splice(l,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);let i=this._events[t].map(f=>f);for(var a=arguments.length,l=new Array(a>1?a-1:0),p=1;p<a;p++)l[p-1]=arguments[p];for(let f=0;f<i.length;f+=1){let g=i[f];g.once&&this.off(t,g.listener),g.listener.apply(this,l||[])}}safeEmit(t){for(var i=arguments.length,a=new Array(i>1?i-1:0),l=1;l<i;l++)a[l-1]=arguments[l];[...this._events[t]||[]].forEach(p=>{p.once&&this.off(t,p.listener);try{p.listener.apply(this,a)}catch(f){console.error("safeEmit event:".concat(t," error ").concat(f==null?void 0:f.toString()))}})}_indexOfListener(t,i){let a=t.length;for(;a--;)if(t[a].listener===i)return a;return-1}}let th=null;function GA(){if(th)return th;if(window.electron)return th=window.electron;if(!window.require)return null;try{return th=window.require("electron"),th}catch{return null}}var cr,Pi,WA,dn,Dt,pr,Ws,Si;function wi(s){return bn(s.timeout,"config.timeout",0,1e5),bn(s.timeoutFactor,"config.timeoutFactor",0,100,!1),bn(s.maxRetryCount,"config.maxRetryConfig",0,1/0),bn(s.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function nh(s){if(!Array.isArray(s)||s.length<1)return!1;try{s.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function un(s){return jr(s.turnServerURL,"turnServerURL"),jr(s.username,"username"),jr(s.password,"password"),s.udpport&&bn(s.udpport,"udpport",1,99999,!0),s.forceturn&&$l(s.forceturn,"forceturn"),s.security&&$l(s.security,"security"),s.tcpport&&bn(s.tcpport,"tcpport",1,99999,!0),!0}function hn(s){return s.level!==void 0&&vr(s.level,"level",[1,2,3]),s.delay!==void 0&&bn(s.delay,"delay",0,3e3,!0),!0}function In(s,t){for(var i=arguments.length,a=new Array(i>2?i-2:0),l=2;l<i;l++)a[l-2]=arguments[l];return s.getListeners(t).length===0?Pe.reject(new Ve(Z.UNEXPECTED_ERROR,"can not emit promise")):new Pe((p,f)=>{s.emit(t,...a,p,f)})}function fn(s,t){if(s.getListeners(t).length===0)return Pe.resolve();for(var i=arguments.length,a=new Array(i>2?i-2:0),l=2;l<i;l++)a[l-2]=arguments[l];return In(s,t,...a)}function us(s,t){if(s.getListeners(t).length===0)return null;for(var i=arguments.length,a=new Array(i>2?i-2:0),l=2;l<i;l++)a[l-2]=arguments[l];return ih(s,t,...a)}function ih(s,t){let i=null,a=null;for(var l=arguments.length,p=new Array(l>2?l-2:0),f=2;f<l;f++)p[f-2]=arguments[f];if(s.emit(t,...p,g=>{i=g},g=>{a=g}),a!==null)throw a;if(i===null)throw new Ve(Z.UNEXPECTED_ERROR,"handler is not sync");return i}(function(s){s.CREATE_CLIENT="createClient",s.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",s.SET_AREA="setArea",s.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",s.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",s.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",s.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",s.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",s.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",s.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",s.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",s.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",s.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",s.START_PROXY_SERVER="Client.startProxyServer",s.STOP_PROXY_SERVER="Client.stopProxyServer",s.SET_PROXY_SERVER="Client.setProxyServer",s.SET_TURN_SERVER="Client.setTurnServer",s.SET_CLIENT_ROLE="Client.setClientRole",s.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",s.ENABLE_DUAL_STREAM="Client.enableDualStream",s.DISABLE_DUAL_STREAM="Client.disableDualStream",s.JOIN="Client.join",s.LEAVE="Client.leave",s.PUBLISH="Client.publish",s.UNPUBLISH="Client.unpublish",s.SUBSCRIBE="Client.subscribe",s.MASS_SUBSCRIBE="Client.massSubscribe",s.MASS_UNSUBSCRIBE="Client.massUnsubscribe",s.UNSUBSCRIBE="Client.unsubscribe",s.RENEW_TOKEN="Client.renewToken",s.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",s.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",s.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",s.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",s.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",s.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",s.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",s.DATACHANNEL_FAILBACK="Client._datachannelFailback",s.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",s.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",s.START_LIVE_STREAMING="Client.startLiveStreaming",s.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",s.STOP_LIVE_STREAMING="Client.stopLiveStreaming",s.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",s.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",s.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",s.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",s.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",s.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",s.SET_CONFIG_DISTRIBUTE="_configDistribute",s.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",s.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",s.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",s.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",s.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",s.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",s.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",s.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",s.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",s.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",s.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",s.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",s.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",s.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",s.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",s.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",s.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",s.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",s.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",s.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",s.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",s.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",s.STREAM_TYPE_CHANGE="streamTypeChange",s.CONNECTION_STATE_CHANGE="connectionStateChange",s.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",s.IMAGE_MODERATION_UPLOAD="imageModerationUpload"})(cr||(cr={})),function(s){s.TRACER="tracer"}(Pi||(Pi={})),function(s){s[s.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",s[s.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",s[s.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(WA||(WA={})),function(s){s.LEAVE="LEAVE",s.NETWORK_ERROR="NETWORK_ERROR",s.SERVER_ERROR="SERVER_ERROR",s.UID_BANNED="UID_BANNED",s.IP_BANNED="IP_BANNED",s.CHANNEL_BANNED="CHANNEL_BANNED",s.FALLBACK="FALLBACK",s.LICENSE_MISSING="LICENSE_MISSING",s.LICENSE_EXPIRED="LICENSE_EXPIRED",s.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",s.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",s.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",s.LICENSE_ILLEGAL="LICENSE_ILLEGAL",s.TOKEN_EXPIRE="TOKEN_EXPIRE"}(dn||(dn={})),function(s){s.CONNECTION_STATE_CHANGE="connection-state-change",s.MEDIA_RECONNECT_START="media-reconnect-start",s.MEDIA_RECONNECT_END="media-reconnect-end",s.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",s.USER_JOINED="user-joined",s.USER_LEAVED="user-left",s.USER_PUBLISHED="user-published",s.USER_UNPUBLISHED="user-unpublished",s.USER_INFO_UPDATED="user-info-updated",s.CLIENT_BANNED="client-banned",s.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",s.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",s.VOLUME_INDICATOR="volume-indicator",s.CRYPT_ERROR="crypt-error",s.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",s.NETWORK_QUALITY="network-quality",s.STREAM_TYPE_CHANGED="stream-type-changed",s.STREAM_FALLBACK="stream-fallback",s.RECEIVE_METADATA="receive-metadata",s.STREAM_MESSAGE="stream-message",s.LIVE_STREAMING_ERROR="live-streaming-error",s.LIVE_STREAMING_WARNING="live-streaming-warning",s.INJECT_STREAM_STATUS="stream-inject-status",s.EXCEPTION="exception",s.ERROR="error",s.P2P_LOST="p2p_lost",s.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",s.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",s.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",s.PUBLISHED_USER_LIST="published-user-list",s.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",s.CONTENT_INSPECT_ERROR="content-inspect-error",s.CONTENT_INSPECT_RESULT="content-inspect-result",s.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(Dt||(Dt={})),function(s){s.NETWORK_ERROR="NETWORK_ERROR",s.SERVER_ERROR="SERVER_ERROR",s.MULTI_IP="MULTI_IP",s.TIMEOUT="TIMEOUT",s.OFFLINE="OFFLINE",s.LEAVE="LEAVE",s.P2P_FAILED="P2P_FAILED",s.FALLBACK="FALLBACK"}(pr||(pr={})),function(s){s.ONLINE="ONLINE",s.OFFLINE="OFFLINE"}(Ws||(Ws={})),function(s){s.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",s.ONLINE="ONLINE",s.OFFLINE="OFFLINE"}(Si||(Si={}));let Bi=new class extends ri{set networkState(s){this.emit(Si.NETWORK_STATE_CHANGE,s,this._networkState),s===Ws.ONLINE?this.emit(Si.ONLINE):s===Ws.OFFLINE&&(this.onlineWaiter=new Pe(t=>{this.once(Si.ONLINE,()=>{this.onlineWaiter=void 0,t(Ws.ONLINE)})}),this.emit(Si.OFFLINE)),this._networkState=s}get networkState(){return this._networkState}get isOnline(){return this._networkState===Ws.ONLINE}constructor(){super(),P(this,"_moduleName","network-indicator"),P(this,"_networkState",Ws.ONLINE),P(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Ws.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Ws.OFFLINE})}};function HA(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function rh(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?HA(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):HA(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function Ji(s,t){let i=s.indexOf(t);i!==-1&&s.splice(i,1)}function Mn(s){let t=[];return s.forEach(i=>{t.indexOf(i)===-1&&t.push(i)}),t}function mo(s){Pe!==void 0?Pe.resolve().then(s):setTimeout(s,0)}function Gn(s){return JSON.parse(JSON.stringify(s))}function ki(s){try{return Gn(s)}catch{return s}}let yD={};function eg(s,t){yD[t]||(yD[t]=!0,s())}function kT(s){let t=window.atob(s),i=new Uint8Array(new ArrayBuffer(t.length));for(let a=0;a<t.length;a+=1)i[a]=t.charCodeAt(a);return i}function Zm(s){let t="";for(let i=0;i<s.length;i+=1)t+=String.fromCharCode(s[i]);return window.btoa(t)}function rl(s){return window.TextEncoder?new TextEncoder().encode(s).length:s.length}function KA(s){let t=0;return/DingTalk/i.test(navigator.userAgent)&&s.realFormData&&(s=s.realFormData),s.forEach(i=>{t+=typeof i=="string"?rl(i):i.size}),t+138}function FB(s){let t=new Ve(Z.TIMEOUT,"timeout");return new Pe((i,a)=>{window.setTimeout(()=>a(t),s)})}function Qr(s){return new Pe(t=>{window.setTimeout(t,s)})}function si(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0,i=Math.random().toString(16).substr(2,s).toLowerCase();return i.length===s?"".concat(t).concat(i):"".concat(t).concat(i)+si(s-i.length,"")}function YA(){return si(32,"").toUpperCase()}let $m=()=>{},sl=new class{constructor(){P(this,"fnMap",new Map)}throttleByKey(s,t,i,a){for(var l=arguments.length,p=new Array(l>4?l-4:0),f=4;f<l;f++)p[f-4]=arguments[f];if(this.fnMap.has(t)){let g=this.fnMap.get(t);if(g.threshold!==i){g.fn(...g.args),clearTimeout(g.timer);let v=window.setTimeout(()=>{let y=this.fnMap.get(t);y&&y.fn(...y.args),this.fnMap.delete(t)},i);this.fnMap.set(t,{fn:s,threshold:i,timer:v,args:p,skipFn:a})}else g.skipFn&&g.skipFn(...g.args),this.fnMap.set(t,rh(rh({},g),{},{fn:s,args:p,skipFn:a}))}else{let g=window.setTimeout(()=>{let v=this.fnMap.get(t);v&&v.fn(...v.args),this.fnMap.delete(t)},i);this.fnMap.set(t,{fn:s,threshold:i,timer:g,args:p,skipFn:a})}}},zA=sl.throttleByKey.bind(sl);function sh(s){return typeof s=="object"&&s!==null&&!(s instanceof RegExp)}function ef(s,t){if(!sh(s)||!sh(t)||Array.isArray(s)&&!Array.isArray(t)||!Array.isArray(s)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(s)){let i=[...s];for(let a=0;a<t.length;a++)i[a]=ef(s[a],t[a]);return i}{let i=rh({},s);for(let a in t)Object.prototype.hasOwnProperty.call(t,a)&&(Object.prototype.hasOwnProperty.call(s,a)?i[a]=ef(s[a],t[a]):i[a]=t[a]);return i}}let tf=1,Np=console;class sn{static setLogger(t){Np=t}constructor(t){P(this,"lockingPromise",Pe.resolve()),P(this,"locks",0),P(this,"name",""),P(this,"lockId",void 0),this.lockId=tf++,t&&(this.name=t),Np.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(t){let i;this.locks+=1,Np.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:""));let a=new Pe(p=>{i=()=>{this.locks-=1,Np.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:"")),p()}}),l=this.lockingPromise.then(()=>i);return this.lockingPromise=this.lockingPromise.then(()=>a),l}}function Bc(s,t){return function(i,a,l){let p=l.value;if(typeof p!="function")throw new Error("Cannot use mutex on object property.");return l.value=async function(){let f=this[t];if(!f)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(s));let g=await f.lock("From ".concat(s,".").concat(a));try{for(var v=arguments.length,y=new Array(v),I=0;I<v;I++)y[I]=arguments[I];return await p.apply(this,y)}finally{g()}},l}}let dr={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function eu(s,t){let i=Math.floor(t.timeout*Math.pow(t.timeoutFactor,s));return Math.min(t.maxRetryTimeout,i)}function ca(s,t,i,a){let l=Object.assign({},dr,a),p=l.timeout,f=async()=>{await function(y){return new Pe(I=>{window.setTimeout(I,y)})}(p),p*=l.timeoutFactor,p=Math.min(l.maxRetryTimeout,p)},g=!1,v=new Pe(async(y,I)=>{t=t||(()=>!1),i=i||(()=>!0);for(let b=0;b<l.maxRetryCount;b+=1){if(g)return I(new Ve(Z.OPERATION_ABORTED));try{let k=await s();if(!t(k,b)||b+1===l.maxRetryCount)return y(k);await f()}catch(k){if(!i(k,b)||b+1===l.maxRetryCount)return I(k);await f()}}});return v.cancel=()=>g=!0,v}var nf=cs,ID=Oo,ol=Pm,AD=Da,jB=TypeError,Br=function(s){return function(t,i,a,l){nf(i);var p=ID(t),f=ol(p),g=AD(p),v=s?g-1:0,y=s?-1:1;if(a<2)for(;;){if(v in f){l=f[v],v+=y;break}if(v+=y,s?v<0:g<=v)throw jB("Reduce of empty array with no initial value")}for(;s?v>=0:g>v;v+=y)v in f&&(l=i(l,f[v],v,p));return l}},oi={left:Br(!1),right:Br(!0)}.left;Xt({target:"Array",proto:!0,forced:!Sp&&ec>79&&ec<83||!nT("reduce")},{reduce:function(s){var t=arguments.length;return oi(this,s,t,t>1?arguments[1]:void 0)}});var qA=sa("Array").reduce,LT=ge,wD=qA,MT=Array.prototype,oh=A(function(s){var t=s.reduce;return s===MT||LT(MT,s)&&t===MT.reduce?wD:t});let tg=class{constructor(s){P(this,"input",[]),P(this,"size",void 0),this.size=s}add(s){this.input.push(s),this.input.length>this.size&&this.input.splice(0,1)}mean(){var s;return this.input.length===0?0:oh(s=this.input).call(s,(t,i)=>t+i)/this.input.length}};var UT,JA={exports:{}},ng=function(s,t){return function(){for(var i=new Array(arguments.length),a=0;a<i.length;a++)i[a]=arguments[a];return s.apply(t,i)}},Zr=ng,ah=Object.prototype.toString,or=(UT=Object.create(null),function(s){var t=ah.call(s);return UT[t]||(UT[t]=t.slice(8,-1).toLowerCase())});function al(s){return s=s.toLowerCase(),function(t){return or(t)===s}}function dc(s){return Array.isArray(s)}function rf(s){return s===void 0}var XA=al("ArrayBuffer");function bD(s){return s!==null&&typeof s=="object"}function sf(s){if(or(s)!=="object")return!1;var t=Object.getPrototypeOf(s);return t===null||t===Object.prototype}var xT=al("Date"),QA=al("File"),cl=al("Blob"),VT=al("FileList");function ch(s){return ah.call(s)==="[object Function]"}var ig=al("URLSearchParams");function FT(s,t){if(s!=null)if(typeof s!="object"&&(s=[s]),dc(s))for(var i=0,a=s.length;i<a;i++)t.call(null,s[i],i,s);else for(var l in s)Object.prototype.hasOwnProperty.call(s,l)&&t.call(null,s[l],l,s)}var ZA,Gc=(ZA=typeof Uint8Array<"u"&&Object.getPrototypeOf(Uint8Array),function(s){return ZA&&s instanceof ZA}),fo={isArray:dc,isArrayBuffer:XA,isBuffer:function(s){return s!==null&&!rf(s)&&s.constructor!==null&&!rf(s.constructor)&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)},isFormData:function(s){var t="[object FormData]";return s&&(typeof FormData=="function"&&s instanceof FormData||ah.call(s)===t||ch(s.toString)&&s.toString()===t)},isArrayBufferView:function(s){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(s):s&&s.buffer&&XA(s.buffer)},isString:function(s){return typeof s=="string"},isNumber:function(s){return typeof s=="number"},isObject:bD,isPlainObject:sf,isUndefined:rf,isDate:xT,isFile:QA,isBlob:cl,isFunction:ch,isStream:function(s){return bD(s)&&ch(s.pipe)},isURLSearchParams:ig,isStandardBrowserEnv:function(){return(typeof navigator>"u"||navigator.product!=="ReactNative"&&navigator.product!=="NativeScript"&&navigator.product!=="NS")&&typeof window<"u"&&typeof document<"u"},forEach:FT,merge:function s(){var t={};function i(p,f){sf(t[f])&&sf(p)?t[f]=s(t[f],p):sf(p)?t[f]=s({},p):dc(p)?t[f]=p.slice():t[f]=p}for(var a=0,l=arguments.length;a<l;a++)FT(arguments[a],i);return t},extend:function(s,t,i){return FT(t,function(a,l){s[l]=i&&typeof a=="function"?Zr(a,i):a}),s},trim:function(s){return s.trim?s.trim():s.replace(/^\s+|\s+$/g,"")},stripBOM:function(s){return s.charCodeAt(0)===65279&&(s=s.slice(1)),s},inherits:function(s,t,i,a){s.prototype=Object.create(t.prototype,a),s.prototype.constructor=s,i&&Object.assign(s.prototype,i)},toFlatObject:function(s,t,i){var a,l,p,f={};t=t||{};do{for(l=(a=Object.getOwnPropertyNames(s)).length;l-- >0;)f[p=a[l]]||(t[p]=s[p],f[p]=!0);s=Object.getPrototypeOf(s)}while(s&&(!i||i(s,t))&&s!==Object.prototype);return t},kindOf:or,kindOfTest:al,endsWith:function(s,t,i){s=String(s),(i===void 0||i>s.length)&&(i=s.length),i-=t.length;var a=s.indexOf(t,i);return a!==-1&&a===i},toArray:function(s){if(!s)return null;var t=s.length;if(rf(t))return null;for(var i=new Array(t);t-- >0;)i[t]=s[t];return i},isTypedArray:Gc,isFileList:VT},tu=fo;function rg(s){return encodeURIComponent(s).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var OD=function(s,t,i){if(!t)return s;var a;if(i)a=i(t);else if(tu.isURLSearchParams(t))a=t.toString();else{var l=[];tu.forEach(t,function(f,g){f!=null&&(tu.isArray(f)?g+="[]":f=[f],tu.forEach(f,function(v){tu.isDate(v)?v=v.toISOString():tu.isObject(v)&&(v=JSON.stringify(v)),l.push(rg(g)+"="+rg(v))}))}),a=l.join("&")}if(a){var p=s.indexOf("#");p!==-1&&(s=s.slice(0,p)),s+=(s.indexOf("?")===-1?"?":"&")+a}return s},BB=fo;function jT(){this.handlers=[]}jT.prototype.use=function(s,t,i){return this.handlers.push({fulfilled:s,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},jT.prototype.eject=function(s){this.handlers[s]&&(this.handlers[s]=null)},jT.prototype.forEach=function(s){BB.forEach(this.handlers,function(t){t!==null&&s(t)})};var ND,DD,sg=jT,PD=fo;function Dp(){if(DD)return ND;DD=1;var s=fo;function t(l,p,f,g,v){Error.call(this),this.message=l,this.name="AxiosError",p&&(this.code=p),f&&(this.config=f),g&&(this.request=g),v&&(this.response=v)}s.inherits(t,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var i=t.prototype,a={};return["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach(function(l){a[l]={value:l}}),Object.defineProperties(t,a),Object.defineProperty(i,"isAxiosError",{value:!0}),t.from=function(l,p,f,g,v,y){var I=Object.create(i);return s.toFlatObject(l,I,function(b){return b!==Error.prototype}),t.call(I,l.message,p,f,g,v),I.name=l.name,y&&Object.assign(I,y),I},ND=t}var BT,kD,GT,LD,WT,MD,$A={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function HT(){if(kD)return BT;kD=1;var s=fo;return BT=function(t,i){i=i||new FormData;var a=[];function l(p){return p===null?"":s.isDate(p)?p.toISOString():s.isArrayBuffer(p)||s.isTypedArray(p)?typeof Blob=="function"?new Blob([p]):Buffer.from(p):p}return function p(f,g){if(s.isPlainObject(f)||s.isArray(f)){if(a.indexOf(f)!==-1)throw Error("Circular reference detected in "+g);a.push(f),s.forEach(f,function(v,y){if(!s.isUndefined(v)){var I,b=g?g+"."+y:y;if(v&&!g&&typeof v=="object"){if(s.endsWith(y,"{}"))v=JSON.stringify(v);else if(s.endsWith(y,"[]")&&(I=s.toArray(v)))return void I.forEach(function(k){!s.isUndefined(k)&&i.append(b,l(k))})}p(v,b)}}),a.pop()}else i.append(g,l(f))}(t),i},BT}function UD(){if(LD)return GT;LD=1;var s=Dp();return GT=function(t,i,a){var l=a.config.validateStatus;a.status&&l&&!l(a.status)?i(new s("Request failed with status code "+a.status,[s.ERR_BAD_REQUEST,s.ERR_BAD_RESPONSE][Math.floor(a.status/100)-4],a.config,a.request,a)):t(a)}}function xD(){if(MD)return WT;MD=1;var s=fo;return WT=s.isStandardBrowserEnv()?{write:function(t,i,a,l,p,f){var g=[];g.push(t+"="+encodeURIComponent(i)),s.isNumber(a)&&g.push("expires="+new Date(a).toGMTString()),s.isString(l)&&g.push("path="+l),s.isString(p)&&g.push("domain="+p),f===!0&&g.push("secure"),document.cookie=g.join("; ")},read:function(t){var i=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return i?decodeURIComponent(i[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},WT}var ew,_t,bi,tw,nw,KT,iw,rw,sw,og,ow,YT,VD=function(s){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(s)},GB=function(s,t){return t?s.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):s},aw=function(s,t){return s&&!VD(t)?GB(s,t):t};function FD(){if(_t)return ew;_t=1;var s=fo,t=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return ew=function(i){var a,l,p,f={};return i&&s.forEach(i.split(`
`),function(g){if(p=g.indexOf(":"),a=s.trim(g.substr(0,p)).toLowerCase(),l=s.trim(g.substr(p+1)),a){if(f[a]&&t.indexOf(a)>=0)return;f[a]=a==="set-cookie"?(f[a]?f[a]:[]).concat([l]):f[a]?f[a]+", "+l:l}}),f},ew}function jD(){if(tw)return bi;tw=1;var s=fo;return bi=s.isStandardBrowserEnv()?function(){var t,i=/(msie|trident)/i.test(navigator.userAgent),a=document.createElement("a");function l(p){var f=p;return i&&(a.setAttribute("href",f),f=a.href),a.setAttribute("href",f),{href:a.href,protocol:a.protocol?a.protocol.replace(/:$/,""):"",host:a.host,search:a.search?a.search.replace(/^\?/,""):"",hash:a.hash?a.hash.replace(/^#/,""):"",hostname:a.hostname,port:a.port,pathname:a.pathname.charAt(0)==="/"?a.pathname:"/"+a.pathname}}return t=l(window.location.href),function(p){var f=s.isString(p)?l(p):p;return f.protocol===t.protocol&&f.host===t.host}}():function(){return!0}}function zT(){if(KT)return nw;KT=1;var s=Dp();function t(i){s.call(this,i??"canceled",s.ERR_CANCELED),this.name="CanceledError"}return fo.inherits(t,s,{__CANCEL__:!0}),nw=t}function BD(){return rw||(rw=1,iw=function(s){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(s);return t&&t[1]||""}),iw}function WB(){if(og)return sw;og=1;var s=fo,t=UD(),i=xD(),a=OD,l=aw,p=FD(),f=jD(),g=$A,v=Dp(),y=zT(),I=BD();return sw=function(b){return new Promise(function(k,U){var J,K=b.data,q=b.headers,te=b.responseType;function de(){b.cancelToken&&b.cancelToken.unsubscribe(J),b.signal&&b.signal.removeEventListener("abort",J)}s.isFormData(K)&&s.isStandardBrowserEnv()&&delete q["Content-Type"];var he=new XMLHttpRequest;if(b.auth){var Ue=b.auth.username||"",Re=b.auth.password?unescape(encodeURIComponent(b.auth.password)):"";q.Authorization="Basic "+btoa(Ue+":"+Re)}var Ie=l(b.baseURL,b.url);function De(){if(he){var nt="getAllResponseHeaders"in he?p(he.getAllResponseHeaders()):null,Vt={data:te&&te!=="text"&&te!=="json"?he.response:he.responseText,status:he.status,statusText:he.statusText,headers:nt,config:b,request:he};t(function(rn){k(rn),de()},function(rn){U(rn),de()},Vt),he=null}}if(he.open(b.method.toUpperCase(),a(Ie,b.params,b.paramsSerializer),!0),he.timeout=b.timeout,"onloadend"in he?he.onloadend=De:he.onreadystatechange=function(){he&&he.readyState===4&&(he.status!==0||he.responseURL&&he.responseURL.indexOf("file:")===0)&&setTimeout(De)},he.onabort=function(){he&&(U(new v("Request aborted",v.ECONNABORTED,b,he)),he=null)},he.onerror=function(){U(new v("Network Error",v.ERR_NETWORK,b,he,he)),he=null},he.ontimeout=function(){var nt=b.timeout?"timeout of "+b.timeout+"ms exceeded":"timeout exceeded",Vt=b.transitional||g;b.timeoutErrorMessage&&(nt=b.timeoutErrorMessage),U(new v(nt,Vt.clarifyTimeoutError?v.ETIMEDOUT:v.ECONNABORTED,b,he)),he=null},s.isStandardBrowserEnv()){var Ne=(b.withCredentials||f(Ie))&&b.xsrfCookieName?i.read(b.xsrfCookieName):void 0;Ne&&(q[b.xsrfHeaderName]=Ne)}"setRequestHeader"in he&&s.forEach(q,function(nt,Vt){K===void 0&&Vt.toLowerCase()==="content-type"?delete q[Vt]:he.setRequestHeader(Vt,nt)}),s.isUndefined(b.withCredentials)||(he.withCredentials=!!b.withCredentials),te&&te!=="json"&&(he.responseType=b.responseType),typeof b.onDownloadProgress=="function"&&he.addEventListener("progress",b.onDownloadProgress),typeof b.onUploadProgress=="function"&&he.upload&&he.upload.addEventListener("progress",b.onUploadProgress),(b.cancelToken||b.signal)&&(J=function(nt){he&&(U(!nt||nt&&nt.type?new y:nt),he.abort(),he=null)},b.cancelToken&&b.cancelToken.subscribe(J),b.signal&&(b.signal.aborted?J():b.signal.addEventListener("abort",J))),K||(K=null);var Xe=I(Ie);Xe&&["http","https","file"].indexOf(Xe)===-1?U(new v("Unsupported protocol "+Xe+":",v.ERR_BAD_REQUEST,b)):he.send(K)})},sw}var to=fo,GD=function(s,t){PD.forEach(s,function(i,a){a!==t&&a.toUpperCase()===t.toUpperCase()&&(s[t]=i,delete s[a])})},Ad=Dp(),WD=$A,cw=HT(),dw={"Content-Type":"application/x-www-form-urlencoded"};function HD(s,t){!to.isUndefined(s)&&to.isUndefined(s["Content-Type"])&&(s["Content-Type"]=t)}var lw,dh={transitional:WD,adapter:((typeof XMLHttpRequest<"u"||typeof process<"u"&&Object.prototype.toString.call(process)==="[object process]")&&(lw=WB()),lw),transformRequest:[function(s,t){if(GD(t,"Accept"),GD(t,"Content-Type"),to.isFormData(s)||to.isArrayBuffer(s)||to.isBuffer(s)||to.isStream(s)||to.isFile(s)||to.isBlob(s))return s;if(to.isArrayBufferView(s))return s.buffer;if(to.isURLSearchParams(s))return HD(t,"application/x-www-form-urlencoded;charset=utf-8"),s.toString();var i,a=to.isObject(s),l=t&&t["Content-Type"];if((i=to.isFileList(s))||a&&l==="multipart/form-data"){var p=this.env&&this.env.FormData;return cw(i?{"files[]":s}:s,p&&new p)}return a||l==="application/json"?(HD(t,"application/json"),function(f,g,v){if(to.isString(f))try{return(g||JSON.parse)(f),to.trim(f)}catch(y){if(y.name!=="SyntaxError")throw y}return(0,JSON.stringify)(f)}(s)):s}],transformResponse:[function(s){var t=this.transitional||dh.transitional,i=t&&t.silentJSONParsing,a=t&&t.forcedJSONParsing,l=!i&&this.responseType==="json";if(l||a&&to.isString(s)&&s.length)try{return JSON.parse(s)}catch(p){if(l)throw p.name==="SyntaxError"?Ad.from(p,Ad.ERR_BAD_RESPONSE,this,null,this.response):p}return s}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:YT?ow:(YT=1,ow=null)},validateStatus:function(s){return s>=200&&s<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};to.forEach(["delete","get","head"],function(s){dh.headers[s]={}}),to.forEach(["post","put","patch"],function(s){dh.headers[s]=to.merge(dw)});var ag,qT,of=dh,nu=fo,uw=of;function hw(){return qT?ag:(qT=1,ag=function(s){return!(!s||!s.__CANCEL__)})}var af=fo,pw=function(s,t,i){var a=this||uw;return nu.forEach(i,function(l){s=l.call(a,s,t)}),s},KD=hw(),HB=of,YD=zT();function mw(s){if(s.cancelToken&&s.cancelToken.throwIfRequested(),s.signal&&s.signal.aborted)throw new YD}var JT,fw,lc=fo,_w=function(s,t){t=t||{};var i={};function a(y,I){return lc.isPlainObject(y)&&lc.isPlainObject(I)?lc.merge(y,I):lc.isPlainObject(I)?lc.merge({},I):lc.isArray(I)?I.slice():I}function l(y){return lc.isUndefined(t[y])?lc.isUndefined(s[y])?void 0:a(void 0,s[y]):a(s[y],t[y])}function p(y){if(!lc.isUndefined(t[y]))return a(void 0,t[y])}function f(y){return lc.isUndefined(t[y])?lc.isUndefined(s[y])?void 0:a(void 0,s[y]):a(void 0,t[y])}function g(y){return y in t?a(s[y],t[y]):y in s?a(void 0,s[y]):void 0}var v={url:p,method:p,data:p,baseURL:f,transformRequest:f,transformResponse:f,paramsSerializer:f,timeout:f,timeoutMessage:f,withCredentials:f,adapter:f,responseType:f,xsrfCookieName:f,xsrfHeaderName:f,onUploadProgress:f,onDownloadProgress:f,decompress:f,maxContentLength:f,maxBodyLength:f,beforeRedirect:f,transport:f,httpAgent:f,httpsAgent:f,cancelToken:f,socketPath:f,responseEncoding:f,validateStatus:g};return lc.forEach(Object.keys(s).concat(Object.keys(t)),function(y){var I=v[y]||l,b=I(y);lc.isUndefined(b)&&I!==g||(i[y]=b)}),i};function XT(){return fw?JT:(fw=1,JT={version:"0.27.2"})}var zD=XT().version,iu=Dp(),lh={};["object","boolean","number","function","string","symbol"].forEach(function(s,t){lh[s]=function(i){return typeof i===s||"a"+(t<1?"n ":" ")+s}});var Ew={};lh.transitional=function(s,t,i){function a(l,p){return"[Axios v"+zD+"] Transitional option '"+l+"'"+p+(i?". "+i:"")}return function(l,p,f){if(s===!1)throw new iu(a(p," has been removed"+(t?" in "+t:"")),iu.ERR_DEPRECATED);return t&&!Ew[p]&&(Ew[p]=!0,console.warn(a(p," has been deprecated since v"+t+" and will be removed in the near future"))),!s||s(l,p,f)}};var QT,gw,ZT,ru,cg,dg,Sw={assertOptions:function(s,t,i){if(typeof s!="object")throw new iu("options must be an object",iu.ERR_BAD_OPTION_VALUE);for(var a=Object.keys(s),l=a.length;l-- >0;){var p=a[l],f=t[p];if(f){var g=s[p],v=g===void 0||f(g,p,s);if(v!==!0)throw new iu("option "+p+" must be "+v,iu.ERR_BAD_OPTION_VALUE)}else if(i!==!0)throw new iu("Unknown option "+p,iu.ERR_BAD_OPTION)}},validators:lh},qD=fo,Tw=OD,JD=sg,Ps=function(s){return mw(s),s.headers=s.headers||{},s.data=pw.call(s,s.data,s.headers,s.transformRequest),s.headers=af.merge(s.headers.common||{},s.headers[s.method]||{},s.headers),af.forEach(["delete","get","head","post","put","patch","common"],function(t){delete s.headers[t]}),(s.adapter||HB.adapter)(s).then(function(t){return mw(s),t.data=pw.call(s,t.data,t.headers,s.transformResponse),t},function(t){return KD(t)||(mw(s),t&&t.response&&(t.response.data=pw.call(s,t.response.data,t.response.headers,s.transformResponse))),Promise.reject(t)})},no=_w,XD=aw,Cw=Sw,su=Cw.validators;function ou(s){this.defaults=s,this.interceptors={request:new JD,response:new JD}}ou.prototype.request=function(s,t){typeof s=="string"?(t=t||{}).url=s:t=s||{},(t=no(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var i=t.transitional;i!==void 0&&Cw.assertOptions(i,{silentJSONParsing:su.transitional(su.boolean),forcedJSONParsing:su.transitional(su.boolean),clarifyTimeoutError:su.transitional(su.boolean)},!1);var a=[],l=!0;this.interceptors.request.forEach(function(b){typeof b.runWhen=="function"&&b.runWhen(t)===!1||(l=l&&b.synchronous,a.unshift(b.fulfilled,b.rejected))});var p,f=[];if(this.interceptors.response.forEach(function(b){f.push(b.fulfilled,b.rejected)}),!l){var g=[Ps,void 0];for(Array.prototype.unshift.apply(g,a),g=g.concat(f),p=Promise.resolve(t);g.length;)p=p.then(g.shift(),g.shift());return p}for(var v=t;a.length;){var y=a.shift(),I=a.shift();try{v=y(v)}catch(b){I(b);break}}try{p=Ps(v)}catch(b){return Promise.reject(b)}for(;f.length;)p=p.then(f.shift(),f.shift());return p},ou.prototype.getUri=function(s){s=no(this.defaults,s);var t=XD(s.baseURL,s.url);return Tw(t,s.params,s.paramsSerializer)},qD.forEach(["delete","get","head","options"],function(s){ou.prototype[s]=function(t,i){return this.request(no(i||{},{method:s,url:t,data:(i||{}).data}))}}),qD.forEach(["post","put","patch"],function(s){function t(i){return function(a,l,p){return this.request(no(p||{},{method:s,headers:i?{"Content-Type":"multipart/form-data"}:{},url:a,data:l}))}}ou.prototype[s]=t(),ou.prototype[s+"Form"]=t(!0)});var $T=fo,vw=ng,eC=ou,KB=_w,da=function s(t){var i=new eC(t),a=vw(eC.prototype.request,i);return $T.extend(a,eC.prototype,i),$T.extend(a,i),a.create=function(l){return s(KB(t,l))},a}(of);da.Axios=eC,da.CanceledError=zT(),da.CancelToken=function(){if(gw)return QT;gw=1;var s=zT();function t(i){if(typeof i!="function")throw new TypeError("executor must be a function.");var a;this.promise=new Promise(function(p){a=p});var l=this;this.promise.then(function(p){if(l._listeners){var f,g=l._listeners.length;for(f=0;f<g;f++)l._listeners[f](p);l._listeners=null}}),this.promise.then=function(p){var f,g=new Promise(function(v){l.subscribe(v),f=v}).then(p);return g.cancel=function(){l.unsubscribe(f)},g},i(function(p){l.reason||(l.reason=new s(p),a(l.reason))})}return t.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},t.prototype.subscribe=function(i){this.reason?i(this.reason):this._listeners?this._listeners.push(i):this._listeners=[i]},t.prototype.unsubscribe=function(i){if(this._listeners){var a=this._listeners.indexOf(i);a!==-1&&this._listeners.splice(a,1)}},t.source=function(){var i;return{token:new t(function(a){i=a}),cancel:i}},QT=t}(),da.isCancel=hw(),da.VERSION=XT().version,da.toFormData=HT(),da.AxiosError=Dp(),da.Cancel=da.CanceledError,da.all=function(s){return Promise.all(s)},da.spread=ru?ZT:(ru=1,ZT=function(s){return function(t){return s.apply(null,t)}}),da.isAxiosError=function(){if(dg)return cg;dg=1;var s=fo;return cg=function(t){return s.isObject(t)&&t.isAxiosError===!0}}(),JA.exports=da,JA.exports.default=da;var mr=A(JA.exports);function tC(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function dl(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?tC(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):tC(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}let cf,Ss=0,Kn=0;function oe(s,t,i,a){return new Pe((l,p)=>{t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),Ss+=rl(t.data)):i&&(t.data.size?Ss+=t.data.size:t.data instanceof FormData?Ss+=KA(t.data):Ss+=rl(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=s,mr.request(t).then(f=>{typeof f.data=="string"?Kn+=rl(f.data):f.data instanceof ArrayBuffer||f.data instanceof Uint8Array?Kn+=f.data.byteLength:Kn+=rl(JSON.stringify(f.data)),l(f.data)}).catch(f=>{mr.isCancel(f)?p(new Ve(Z.OPERATION_ABORTED,"cancel token canceled")):f.code==="ECONNABORTED"?p(new Ve(Z.NETWORK_TIMEOUT,f.message)):f.response?p(new Ve(Z.NETWORK_RESPONSE_ERROR,f.response.status)):p(new Ve(Z.NETWORK_ERROR,f.message))})})}async function uh(s,t){let i=new Blob([t.data],{type:"buffer"});return await oe(s,dl(dl({},t),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}let QD=()=>(cf||cf||(cf=(window.location.protocol.split(":")[0]||"").toUpperCase(),cf))==="HTTPS",It=()=>window.isSecureContext!==void 0,Gt=function(s){if(s.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return s;let t=s.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){let a=t[1],l=t[2];return"".concat(a,".").concat(l)}let i=s.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){let a=i[1],l=i[2];return"".concat(a,".").concat(100*(Number(l)+1))}return"4.0.0.999"}("4.20.0"),Rw=function(){try{return JSON.parse("true")===!0}catch{return!0}}();var Ko;(function(s){s.Default="default",s.Auto="auto",s.Relay="relay",s.SdRtn="sd-rtn"})(Ko||(Ko={}));let nC="v4.20.0-0-g334e514b-dirty(12/8/2023, 3:48:29 PM)",io={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],PLUGIN_INFO:[]};function ei(s,t,i){var a,l;xe(a=Object.keys(io)).call(a,s)&&(!i&&xe(l=Object.keys(uc)).call(l,s)||(io[s]=t))}function ce(s){return io[s]}let uc={};function ZD(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function yt(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ZD(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):ZD(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}var pn;(function(s){s.SET_SESSION_ID="SET_SESSION_ID",s.SET_P2P_ID="SET_P2P_id",s.SET_DC_ID="SET_DC_id",s.SET_UID="SET_UID",s.SET_INT_UID="SET_INT_UID",s.SET_PUB_ID="SET_PUB_ID",s.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",s.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",s.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",s.AVOID_JOIN_START="AVOID_JOIN_START",s.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",s.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",s.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",s.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",s.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",s.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",s.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",s.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",s.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",s.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",s.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",s.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",s.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",s.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",s.RESET_KEY_METRICS="RESET_KEY_METRICS",s.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",s.SET_USE_P2P="SET_USE_P2P",s.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE"})(pn||(pn={}));class yw{constructor(t,i,a,l){P(this,"state",void 0),this.state={codec:t,audioCodec:i,mode:a,clientId:l,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:Ko.Default}}dispatch(t){this.state=function(i,a){switch(a.type){case pn.SET_SESSION_ID:return yt(yt({},i),{},{sessionId:a.sessionId});case pn.SET_P2P_ID:return yt(yt({},i),{},{p2pId:a.p2pId});case pn.SET_UID:return yt(yt({},i),{},{uid:a.uid});case pn.SET_INT_UID:return yt(yt({},i),{},{intUid:a.intUid});case pn.SET_PUB_ID:return yt(yt({},i),{},{pubId:a.pubId});case pn.KEY_METRIC_CLIENT_CREATED:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{clientCreated:a.metric})});case pn.KEY_METRIC_JOIN_START:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{joinStart:a.metric})});case pn.AVOID_JOIN_START:return yt(yt({},i),{},{avoidJoinStart:a.avoidJoinStart});case pn.KEY_METRIC_JOIN_END:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{joinEnd:a.metric})});case pn.KEY_METRIC_REQUEST_AP_START:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{requestAPStart:a.metric})});case pn.KEY_METRIC_REQUEST_AP_END:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{requestAPEnd:a.metric})});case pn.KEY_METRIC_JOIN_GATEWAY_START:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{joinGatewayStart:a.metric})});case pn.KEY_METRIC_JOIN_GATEWAY_END:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{joinGatewayEnd:a.metric})});case pn.KEY_METRIC_PEER_CONNECTION_START:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{peerConnectionStart:a.metric})});case pn.KEY_METRIC_PEER_CONNECTION_END:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{peerConnectionEnd:a.metric})});case pn.KEY_METRIC_DESCRIPTION_START:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{descriptionStart:a.metric})});case pn.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{signalChannelOpen:a.metric})});case pn.KEY_METRIC_ICE_CONNECTION_END:return yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{iceConnectionEnd:a.metric})});case pn.KEY_METRIC_PUBLISH:{let l=i.keyMetrics.publish,p=l.findIndex(f=>f.trackId===a.metric.trackId);return p!==-1?(l[p]=yt(yt({},l[p]),a.metric),yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{publish:[...l]})})):yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{publish:[...i.keyMetrics.publish,a.metric]})})}case pn.KEY_METRIC_SUBSCRIBE:{let l=i.keyMetrics.subscribe,p=l.findIndex(f=>f.userId===a.metric.userId&&f.type===a.metric.type);return p!==-1?(l[p]=yt(yt({},l[p]),a.metric),yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{subscribe:[...l]})})):yt(yt({},i),{},{keyMetrics:yt(yt({},i.keyMetrics),{},{subscribe:[...i.keyMetrics.subscribe,a.metric]})})}case pn.SET_CLOUD_PROXY_SERVER_MODE:return i.cloudProxyServerMode=a.mode,i;case pn.RECORD_JOIN_CHANNEL_SERVICE:return typeof a.index!="number"?i.joinChannelServiceRecords=[...i.joinChannelServiceRecords,a.record]:(i.joinChannelServiceRecords[a.index]=yt(yt({},i.joinChannelServiceRecords[a.index]),a.record),i.joinChannelServiceRecords=[...i.joinChannelServiceRecords]),i;case pn.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return i.joinChannelServiceRecords=[],i;case pn.RESET_KEY_METRICS:return i.keyMetrics={publish:[],subscribe:[]},i;case pn.SET_USE_DATACHANNEL:return yt(yt({},i),{},{useDataChannel:a.val});case pn.SET_USE_P2P:return yt(yt({},i),{},{useP2P:a.val});case pn.SET_TRANSPORT_TYPE:return yt(yt({},i),{},{p2pTransport:a.val});default:return i}}(this.state,t)}set sessionId(t){this.dispatch({type:pn.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}set codec(t){this.state.codec=t}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:pn.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:pn.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:pn.SET_UID,uid:t})}get uid(){return this.state.uid}set intUid(t){this.dispatch({type:pn.SET_INT_UID,intUid:t})}get intUid(){return this.state.intUid}set pubId(t){this.dispatch({type:pn.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:pn.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(t){this.dispatch({type:pn.SET_USE_DATACHANNEL,val:t})}get useDataChannel(){return this.state.useDataChannel}set useP2P(t){this.dispatch({type:pn.SET_USE_P2P,val:t})}get useP2P(){return this.state.useP2P}set p2pTransport(t){this.dispatch({type:pn.SET_TRANSPORT_TYPE,val:t})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:pn.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:pn.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:pn.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:pn.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:pn.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:pn.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:pn.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:pn.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:pn.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:pn.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:pn.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:pn.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,i,a,l){this.dispatch({type:pn.KEY_METRIC_PUBLISH,metric:yt(yt({trackId:t,type:i},a&&{publishStart:a}),l&&{publishEnd:l})})}subscribe(t,i,a,l,p,f,g){this.dispatch({type:pn.KEY_METRIC_SUBSCRIBE,metric:yt(yt(yt(yt(yt({userId:t,type:i},a&&{subscribeStart:a}),l&&{subscribeEnd:l}),p&&{firstFrame:p}),f&&{streamAdded:f}),g&&{firstDecoded:g})})}massSubscribe(t,i,a,l){t.forEach(p=>{this.dispatch({type:pn.KEY_METRIC_SUBSCRIBE,metric:yt(yt(yt({userId:p.userId,type:p.type},i&&{subscribeStart:i}),a&&{subscribeEnd:a}),l&&{firstFrame:l})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,i){t.service==="gateway"&&Array.isArray(t.urls)&&(t.urls=t.urls.map(a=>a.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof i!="number"?(this.dispatch({type:pn.RECORD_JOIN_CHANNEL_SERVICE,record:yt(yt({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(i<0||i>=this.state.joinChannelServiceRecords.length||this.dispatch({type:pn.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:i}),i)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:pn.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:pn.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:pn.AVOID_JOIN_START,avoidJoinStart:t})}}var au,La;(function(s){s.h264="h264",s.h265="h265",s.vp8="vp8",s.vp9="vp9",s.av1="av1"})(au||(au={})),function(s){s.opus="opus",s.pcma="pcma",s.pcmu="pcmu",s.g722="g722"}(La||(La={}));let Pp=new class extends ri{reportLogUploadError(s){this.emit("REPORT_LOG_UPLOAD",s)}};class lg{constructor(t){P(this,"logger",void 0),P(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];this.logger.debug(...this.prefixLists,...i)}info(){for(var t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];this.logger.info(...this.prefixLists,...i)}warning(){for(var t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];this.logger.warning(...this.prefixLists,...i)}error(){for(var t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];this.logger.error(...this.prefixLists,...i)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function M(){let s=new Date;return s.toTimeString().split(" ")[0]+":"+s.getMilliseconds()}function Iw(){let s=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+s.getUTCMilliseconds():s.toTimeString().split(" ")[0]+":"+s.getMilliseconds()}let Ma={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},iC=Date.now(),ug=s=>{for(let t in Ma)if(Object.prototype.hasOwnProperty.call(Ma,t)&&Ma[t]===s)return t;return"DEFAULT"},x=new class{constructor(){P(this,"proxyServerURL",void 0),P(this,"logLevel",Ma.DEBUG),P(this,"uploadState","collecting"),P(this,"uploadLogWaitingList",[]),P(this,"uploadLogUploadingList",[]),P(this,"uploadErrorCount",0),P(this,"currentLogID",0),P(this,"url",void 0),P(this,"extLog",(s,t)=>{this.appendLogToWaitingList(s,...t)})}debug(){for(var s=arguments.length,t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];let a=[Ma.DEBUG].concat(t);this.log.apply(this,a)}info(){for(var s=arguments.length,t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];let a=[Ma.INFO].concat(t);this.log.apply(this,a)}warning(){for(var s=arguments.length,t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];let a=[Ma.WARNING].concat(t);this.log.apply(this,a)}warn(){this.warning(...arguments)}error(){for(var s=arguments.length,t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];let a=[Ma.ERROR].concat(t);this.log.apply(this,a)}upload(){for(var s=arguments.length,t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];let a=[Ma.DEBUG].concat(t);this.uploadLog.apply(this,a)}setLogLevel(s){s=Math.min(Math.max(0,s),4),this.logLevel=s}enableLogUpload(){ei("UPLOAD_LOG",!0)}disableLogUpload(){ei("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(s){this.proxyServerURL=s}prefix(s){return new lg(this).prefix(s)}log(){for(var s=arguments.length,t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];if(Date.now()-iC<100)return void setTimeout(()=>{this.log(...t)},Date.now()-iC);let a=Math.max(0,Math.min(4,t[0]));if(t[0]=M()+" Agora-SDK [".concat(ug(a),"]:"),this.appendLogToWaitingList(a,...t),a<this.logLevel)return;let l=M()+" %cAgora-SDK [".concat(ug(a),"]:"),p=[];if(!ce("USE_NEW_LOG"))switch(a){case Ma.DEBUG:p=[l,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,p);break;case Ma.INFO:p=[l,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,p);break;case Ma.WARNING:p=[l,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,p);break;case Ma.ERROR:p=[l,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,p)}}uploadLog(){for(var s=arguments.length,t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];if(Date.now()-iC<100)return void setTimeout(()=>{this.uploadLog(...t)},Date.now()-iC);let a=Math.max(0,Math.min(4,t[0]));t[0]=M()+" Agora-SDK [".concat(ug(a),"]:"),this.appendLogToWaitingList(a,...t)}appendLogToWaitingList(s){if(!ce("UPLOAD_LOG"))return;for(var t=arguments.length,i=new Array(t>1?t-1:0),a=1;a<t;a++)i[a-1]=arguments[a];Array.isArray(i[0])?i[0][0]=Iw()+" Agora-SDK [".concat(ug(s),"]:"):i[0]=Iw()+" Agora-SDK [".concat(ug(s),"]:");let l="";i.forEach(p=>{typeof p=="object"&&(p=JSON.stringify(p)),l+="".concat(p," ")}),this.uploadLogWaitingList.push({payload_str:l,log_level:s,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){let s=this.uploadLogUploadingList,t={sdk_version:Gt,process_id:ce("PROCESS_ID"),payload:JSON.stringify(s)};return ca(async()=>{let i=await mr.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(ce("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(ce("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(i.data!=="OK"){let a=new Error("unexpected upload log response");throw a.response=i,a}},()=>(this.uploadLogUploadingList=[],!1),i=>(i.response?Pp.reportLogUploadError({status:i.response.status,data:i.response.data,headers:i.response.headers,message:i.message}):i.request?Pp.reportLogUploadError({status:i.request.status,message:i.message}):Pp.reportLogUploadError({status:-1,message:i.message}),!0),{timeout:ce("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:ce("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,ce("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),ce("UPLOAD_LOG_INTERVAL"))}).catch(s=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),ce("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),ce("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var pi,Aw;function $D(s){return jr(s.reportId,"params.reportId",0,100,!1),jr(s.category,"params.category",0,100,!1),jr(s.event,"params.event",0,100,!1),jr(s.label,"params.label",0,100,!1),bn(s.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(function(s){s.FREE="free",s.UPLOADING="uploading"})(pi||(pi={})),function(s){s[s.MISC=0]="MISC",s[s.INTERNAL_EVENT=1]="INTERNAL_EVENT",s[s.PUBLIC_EVENT=2]="PUBLIC_EVENT",s[s.WEB_EVENT=3]="WEB_EVENT",s[s.INTERNAL_API=4]="INTERNAL_API",s[s.WEB_API=5]="WEB_API",s[s.PUBLIC_API=6]="PUBLIC_API"}(Aw||(Aw={}));let eP={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var kt,ai,Lt,vt;function tP(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Mt(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?tP(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):tP(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}(function(s){s.PUBLISH="publish",s.SUBSCRIBE="subscribe",s.WS_COMPRESSOR_INIT="ws_compressor_init",s.SESSION_INIT="session_init",s.JOIN_CHOOSE_SERVER="join_choose_server",s.REQ_USER_ACCOUNT="req_user_account",s.JOIN_GATEWAY="join_gateway",s.REJOIN_GATEWAY="rejoin_gateway",s.STREAM_SWITCH="stream_switch",s.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",s.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",s.FIRST_VIDEO_RECEIVED="first_video_received",s.FIRST_AUDIO_RECEIVED="first_audio_received",s.FIRST_VIDEO_DECODE="first_video_decode",s.FIRST_AUDIO_DECODE="first_audio_decode",s.ON_ADD_AUDIO_STREAM="on_add_audio_stream",s.ON_ADD_VIDEO_STREAM="on_add_video_stream",s.ON_UPDATE_STREAM="on_update_stream",s.ON_REMOVE_STREAM="on_remove_stream",s.USER_ANALYTICS="req_user_analytics",s.PC_STATS="pc_stats",s.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities"})(kt||(kt={})),function(s){s.SESSION="io.agora.pb.Wrtc.Session",s.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",s.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",s.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",s.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",s.PUBLISH="io.agora.pb.Wrtc.Publish",s.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",s.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",s.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",s.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",s.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",s.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",s.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",s.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",s.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",s.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",s.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",s.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",s.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",s.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",s.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",s.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",s.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",s.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",s.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",s.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",s.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",s.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",s.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",s.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",s.PC_STATS="io.agora.pb.Wrtc.PCStats",s.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities"}(ai||(ai={})),function(s){s[s.WORKER_EVENT=156]="WORKER_EVENT",s[s.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(Lt||(Lt={})),function(s){s[s.SESSION=26]="SESSION",s[s.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",s[s.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",s[s.JOIN_GATEWAY=28]="JOIN_GATEWAY",s[s.PUBLISH=30]="PUBLISH",s[s.SUBSCRIBE=29]="SUBSCRIBE",s[s.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",s[s.STREAM_SWITCH=32]="STREAM_SWITCH",s[s.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",s[s.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",s[s.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",s[s.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",s[s.API_INVOKE=41]="API_INVOKE",s[s.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",s[s.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",s[s.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",s[s.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",s[s.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",s[s.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",s[s.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",s[s.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",s[s.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",s[s.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",s[s.WORKER_EVENT=156]="WORKER_EVENT",s[s.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",s[s.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",s[s.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",s[s.USER_ANALYTICS=1e4]="USER_ANALYTICS",s[s.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(vt||(vt={}));class df{constructor(){P(this,"baseInfoMap",new Map),P(this,"proxyServer",void 0),P(this,"eventUploadTimer",void 0),P(this,"setSessionIdTimer",void 0),P(this,"url",void 0),P(this,"backupUrl",void 0),P(this,"_appId",void 0),P(this,"keyEventUploadPendingItems",[]),P(this,"normalEventUploadPendingItems",[]),P(this,"apiInvokeUploadPendingItems",[]),P(this,"apiInvokeCount",0),P(this,"ltsList",[]),P(this,"lastSendNormalEventTime",Date.now()),P(this,"customReportCounterTimer",void 0),P(this,"customReportCount",0),P(this,"extApiInvoke",async t=>{for(let i of t){let a=Mt(Mt({},i),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Pi.TRACER});this.sendApiInvoke(a)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),ce("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),ce("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void x.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));let i=this.baseInfoMap.get(t),a=Date.now(),l=i.startTime;i.startTime=a,x.debug("rewrite session ".concat(t," startTime: ").concat(a," , ").concat(a-l,"ms")),this.baseInfoMap.set(t,i)}setAppId(t){this._appId=t}reportApiInvoke(t,i,a){i.timeout=i.timeout||6e4,i.reportResult=i.reportResult===void 0||i.reportResult;let l=Date.now();this.apiInvokeCount+=1;let p=this.apiInvokeCount,f=()=>({tag:i.tag,invokeId:p,sid:t,name:i.name,apiInvokeTime:l,options:i.options,states:i.states||null}),g=!!ce("SHOW_REPORT_INVOKER_LOG");g&&x.info("".concat(i.name," start"),i.options);let v=!1;Qr(i.timeout).then(()=>{v||(this.sendApiInvoke(Mt(Mt({},f()),{},{error:Z.API_INVOKE_TIMEOUT,success:!1})),x.debug("".concat(i.name," timeout")))});let y=new Ve(Z.UNEXPECTED_ERROR,"".concat(i.name,": this api invoke is end"));return{onSuccess:I=>{let b=()=>{if(v)throw y;return v=!0,this.sendApiInvoke(Mt(Mt({},f()),{},{success:!0},i.reportResult&&{result:I})),g&&x.info("".concat(i.name," onSuccess")),I};return a?zA(b,i.name+"Success",a,()=>v=!0):b()},onError:I=>{let b=()=>{if(v)throw I;v=!0,this.sendApiInvoke(Mt(Mt({},f()),{},{success:!1,error:I})),g&&x.info("".concat(i.name," onFailure"),I.toString())};return a?zA(b,i.name+"Error",a,()=>v=!0):b()}}}sessionInit(t,i){if(this.baseInfoMap.has(t))return;let a=Date.now(),l=this.createBaseInfo(t,a);l.cname=i.cname;let p=Object.assign({},{willUploadConsoleLog:ce("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Rw?"global":"oversea",areas:ce("AREAS")&&ce("AREAS").join(",")},i.extend),{stringUid:f,channelProfile:g,channelMode:v,isABTestSuccess:y,lsid:I,clientRole:b}=i,k=Date.now(),U=Mt(Mt({},l),{},{eventType:kt.SESSION_INIT,appid:i.appid,browser:navigator.userAgent,build:nC,lts:k,elapse:k-a,extend:JSON.stringify(p),mode:i.mode,process:ce("PROCESS_ID"),appType:ce("APP_TYPE"),success:!0,version:Gt,stringUid:f,channelProfile:g,channelMode:v,isABTestSuccess:y,lsid:I,clientType:20,clientRole:b,serviceId:ce("PROCESS_ID"),extensionID:ce("PLUGIN_INFO").join(",")||""});this.send({type:ai.SESSION,data:U},!0)}joinChooseServer(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt({},l),{},{eventType:kt.JOIN_CHOOSE_SERVER,lts:p,eventElapse:p-i.lts,chooseServerAddr:i.csAddr,errorCode:i.ec,elapse:p-a.startTime,success:i.succ,chooseServerAddrList:JSON.stringify(i.serverList),uid:i.uid?parseInt(i.uid):null,cid:i.cid?parseInt(i.cid):null,chooseServerIp:i.csIp||"",opid:i.opid,unilbsServerIds:i.unilbsServerIds,extend:i.extend||void 0,isHttp3:i.isHttp3});this.send({type:ai.JOIN_CHOOSE_SERVER,data:f},!0)}reqUserAccount(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt({},l),{},{eventType:kt.REQ_USER_ACCOUNT,lts:p,success:i.success,serverAddress:i.serverAddr,stringUid:i.stringUid,uid:i.uid,errorCode:i.errorCode,elapse:p-a.startTime,eventElapse:p-i.lts,extend:JSON.stringify(i.extend)});this.send({type:ai.REQ_USER_ACCOUNT,data:f},!0)}joinGateway(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info;i.vid&&(l.vid=i.vid),l.uid=i.uid,l.cid=i.cid;let p=Date.now(),{firstSuccess:f,avoidJoinStartTime:g,isProxy:v,addr:y}=i,I=p-(f&&g?g:a.startTime),b=Mt(Mt({},l),{},{eventType:kt.JOIN_GATEWAY,lts:p,gatewayAddr:i.addr,success:i.succ,errorCode:i.ec,elapse:I,eventElapse:p-i.lts,firstSuccess:f,signalChannel:i.signalChannel}),k=b.success?1:0;if(i.succ&&(a.lastJoinSuccessTime=p),f)this.send({type:ai.JOIN_GATEWAY,data:b},!0);else{let U;if(y)if(v){let K=y.match(/h=(\d{1,3}-){3}\d{1,3}/g),q=y.match(/p=[0-9]{1,6}/g);U={isSuccess:k,gatewayIp:K&&K.length?K[0].split("=")[1].replace(/-/g,"."):"",port:q&&q.length?q[0].split("=")[1]:"",isProxy:v?1:0}}else{let K=y.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),q=y.match(/(:|p=)[0-9]{1,6}/g);U={isSuccess:k,gatewayIp:K&&K.length?K[0].split("//")[1].replace(/-/g,"."):"",port:q&&q.length?q[0].split(/:|p=/g)[1]:"",isProxy:v?1:0}}else U={isSuccess:k,gatewayIp:"",port:"",isProxy:v?1:0};delete b.success,delete b.eventType,delete b.firstSuccess,b.vid=Number(b.vid);let J=Object.assign({},b,U,{eventType:kt.REJOIN_GATEWAY});this.send({type:ai.RE_JOIN_GATEWAY,data:J},!0)}}joinChannelTimeout(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=Date.now(),p=Mt(Mt({},a.info),{},{lts:l,timeout:i,elapse:l-a.startTime});this.send({type:ai.JOIN_CHANNEL_TIMEOUT,data:p},!0)}publish(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt({},l),{},{eventType:kt.PUBLISH,lts:p,eventElapse:i.eventElapse,elapse:p-a.startTime,success:i.succ,errorCode:i.ec,videoName:i.videoName,audioName:i.audioName,screenName:i.screenName,screenshare:i.screenshare,audio:i.audio,video:i.video,p2pid:i.p2pid,publishRequestid:i.publishRequestid});this.send({type:ai.PUBLISH,data:f},!0)}subscribe(t,i,a){let l=this.baseInfoMap.get(t);if(!l)return;let p=l.info,f=Date.now(),g=Mt(Mt({},p),{},{eventType:kt.SUBSCRIBE,lts:f,eventElapse:i.eventElapse,elapse:f-l.startTime,success:i.succ,errorCode:i.ec,video:i.video,audio:i.audio,subscribeRequestid:i.subscribeRequestid,p2pid:i.p2pid},a&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof i.peerid=="string"?g.peerSuid=i.peerid:g.peer=i.peerid,this.send({type:ai.SUBSCRIBE,data:g},!0)}wsCompressorInit(t){var i;let a=[...Ho(i=this.baseInfoMap).call(i)],l=a.length?a[0]:"UnableToGetSid",p=this.baseInfoMap.get(l);if(!p)return;let f=p.info,g=Date.now(),v=Mt(Mt({},f),{},{eventType:kt.WS_COMPRESSOR_INIT,lts:g,eventElapse:t.eventElapse,elapse:g-p.startTime,status:t.status?1:2});this.send({type:ai.WS_COMPRESSOR_INIT,data:v},!0)}firstRemoteVideoDecode(t,i,a,l){let p=this.baseInfoMap.get(t);if(!p)return;let f=p.info,g=Date.now(),v=Mt(Mt(Mt({},f),l),{},{elapse:g-p.startTime,eventType:i,lts:g,firstDecodeFrame:Math.max(g-p.startTime,0),apEnd:Math.max(l.apEnd-p.startTime,0),apStart:Math.max(l.apStart-p.startTime,0),joinGwEnd:Math.max(l.joinGwEnd-p.startTime,0),joinGwStart:Math.max(l.joinGwStart-p.startTime,0),pcEnd:Math.max(l.pcEnd-p.startTime,0),pcStart:Math.max(l.pcStart-p.startTime,0),subscriberEnd:Math.max(l.subscriberEnd-p.startTime,0),subscriberStart:Math.max(l.subscriberStart-p.startTime,0),videoAddNotify:Math.max(l.videoAddNotify-p.startTime,0)});this.send({type:a,data:v},!0)}firstRemoteFrame(t,i,a,l){let p=this.baseInfoMap.get(t);if(!p)return;let f=p.info,g=Date.now(),v=Mt(Mt(Mt({},f),l),{},{elapse:g-p.startTime,eventType:i,lts:g});this.send({type:a,data:v},!0)}pcStats(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt(Mt({},l),i),{},{vid:l.vid===void 0?0:Number(l.vid),elapse:p-a.startTime,eventType:kt.PC_STATS,lts:p});this.send({type:ai.PC_STATS,data:f},!0)}updateRemoteRTPCapabilities(t,i){if(t){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt(Mt({},l),i),{},{vid:l.vid===void 0?0:Number(l.vid),eventType:kt.UPDATE_REMOTE_RTPCAPABILITIES,lts:p});this.send({type:ai.UPDATE_REMOTE_RTPCAPABILITIES,data:f},!0)}}onGatewayStream(t,i,a,l){let p=this.baseInfoMap.get(t);if(!p)return;let f=p.info,g=Date.now(),v=Mt(Mt(Mt({},f),l),{},{eventType:i,lts:g});this.send({type:a,data:v},!0)}streamSwitch(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt({},l),{},{eventType:kt.STREAM_SWITCH,lts:p,isDual:i.isdual,elapse:p-a.startTime,success:i.succ});this.send({type:ai.STREAM_SWITCH,data:f},!0)}requestProxyAppCenter(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt({},l),{},{eventType:kt.REQUEST_PROXY_APPCENTER,lts:p,eventElapse:p-i.lts,elapse:p-a.startTime,APAddr:i.APAddr,workerManagerList:i.workerManagerList,response:i.response,errorCode:i.ec,success:i.succ});this.send({type:ai.REQUEST_PROXY_APPCENTER,data:f},!0)}requestProxyWorkerManager(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt({},l),{},{eventType:kt.REQUEST_PROXY_WORKER_MANAGER,lts:p,eventElapse:p-i.lts,elapse:p-a.startTime,workerManagerAddr:i.workerManagerAddr,response:i.response,errorCode:i.ec,success:i.succ});this.send({type:ai.REQUEST_PROXY_WORKER_MANAGER,data:f},!0)}setProxyServer(t){this.proxyServer=t,t?x.debug("reportProxyServerurl: ".concat(t)):x.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt({},l),{},{subscribeElapse:i.subscribeElapse,peer:i.peer,peerPublishDuration:Math.max(i.audioPublishDuration,i.videoPublishDuration),audiotag:i.audioPublishDuration>0?1:-1,videotag:i.videoPublishDuration>0?1:-1,lts:p,elapse:p-a.startTime,joinChannelSuccessElapse:p-(a.lastJoinSuccessTime||p),peerPublishDurationVideo:i.videoPublishDuration,peerPublishDurationAudio:i.audioPublishDuration});this.send({type:ai.PEER_PUBLISH_STATUS,data:f},!0)}workerEvent(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now();(function(f,g,v){let y=f[g];if(!y||typeof y!="string")return[f];f[g]="";let I=rl(JSON.stringify(f)),b=0,k=[],U=0;for(let J=0;J<y.length;J++)U+=y.charCodeAt(J)<=127?1:3,U<=v-I||(k[k.length]=rh(rh({},f),{},{[g]:y.substring(b,J)}),b=J,U=y.charCodeAt(J)<=127?1:3);return b!==y.length-1&&(k[k.length]=rh(rh({},f),{},{[g]:y.substring(b)})),k})(Mt(Mt(Mt({},l),i),{},{elapse:p-a.startTime,lts:p,productType:"WebRTC"}),"payload",1300).forEach(f=>this.send({type:ai.WORKER_EVENT,data:f},!0))}apworkerEvent(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt(Mt({},l),i),{},{elapse:p-a.startTime,lts:p});this.send({type:ai.AP_WORKER_EVENT,data:f},!0)}joinWebProxyAP(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt(Mt({},l),i),{},{elapse:p-a.startTime,lts:p,extend:i.extend||void 0});this.send({type:ai.JOIN_WEB_PROXY_AP,data:f},!0)}WebSocketQuit(t,i){let a=this.baseInfoMap.get(t);if(!a)return;let l=a.info,p=Date.now(),f=Mt(Mt(Mt({},l),i),{},{elapse:p-a.startTime,lts:p});this.send({type:ai.WEBSOCKET_QUIT,data:f},!0)}async sendCustomReportMessage(t,i){if(this.customReportCount+=i.length,this.customReportCount>ce("CUSTOM_REPORT_LIMIT"))throw new Ve(Z.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));let a=Date.now(),l=i.map(p=>({type:ai.USER_ANALYTICS,data:Mt(Mt({sid:t},p),{},{lts:a})}));try{ce("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(l):await this.postDataToStatsCollector(l)}catch(p){throw x.error("send custom report message failed",p.toString()),new Ve(Z.CUSTOM_REPORT_SEND_FAILED,p.message)}}sendApiInvoke(t){let i=ce("NOT_REPORT_EVENT");if(t.tag&&xe(i)&&xe(i).call(i,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;let a=this.baseInfoMap.get(t.sid);if(!a)return this.apiInvokeUploadPendingItems.push(t),!1;let{cname:l,uid:p,cid:f}=a.info,g;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof Ve){let{code:y,message:I}=t.error;g=y||I||t.error.toString()}else g=t.error.toString();let v={invokeId:t.invokeId,sid:t.sid,cname:l,cid:f,uid:p,lts:t.lts,success:t.success,elapse:t.lts-a.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?g:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:ai.API_INVOKE,data:v},!1),!0}appendSessionId(){df.__CLIENT_LIST__.forEach(t=>{if(t._sessionId){let i=this.apiInvokeUploadPendingItems.length;for(let a=0;a<i;a++){let l=this.apiInvokeUploadPendingItems.shift();l&&(l.sid=t._sessionId,this.sendApiInvoke(Object.assign({},l)))}}})}send(t,i){if(i)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>ce("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,i){let a=[],l=[];for(;t.length;){let f=t.shift();a.length<20?a.push(f):l.push(f)}t.push(...l);for(let f of[...a]){var p;this.ltsList.indexOf(f.data.lts)!==-1?(f.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(f.data.lts)):(this.ltsList.push(f.data.lts),kE(p=this.ltsList).call(p,(g,v)=>g-v))}return i||(this.lastSendNormalEventTime=Date.now()),ce("ENABLE_EVENT_REPORT")&&a.length&&(ce("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(a):this.postDataToStatsCollector(a)).catch((f=>g=>{ce("EVENT_REPORT_RETRY")&&(i?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(f):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(f),this.normalEventUploadPendingItems.length>ce("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-ce("NORMAL_EVENT_QUEUE_CAPACITY")),x.warning("report: drop normal events"))))})(a)),t}async postDataToStatsCollector2(t){Bi.networkState===Ws.OFFLINE&&await Pe.race([Bi.onlineWaiter,Qr(2*dr.maxRetryTimeout)]);let i=p=>{let f=new Uint8Array;return p.forEach(g=>{let v=Ai(JSON.stringify(g.data)),y=new ArrayBuffer(5),I=(k=>{let U=0;return Object.entries(ai).forEach(J=>{let[K,q]=J;q===k.type&&(U=EventNameToID[K])}),U})(g),b=new DataView(y);b.setUint16(0,v.byteLength,!0),b.setUint8(2,255&I),b.setUint8(3,I>>>8&255),b.setUint8(4,I>>>16&255),f=BA(f,new Uint8Array(y)),f=BA(f,v)}),f},a="event",l=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(ce("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(a):"https://".concat(ce("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(a);for(let p=0;p<2;p+=1){p===1&&(l=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(ce("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(a):"https://".concat(ce("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(a));try{await oe(l,{timeout:1e4,data:i(t),headers:Mt(Mt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(f){if(p===1)throw f;continue}return}}async postDataToStatsCollector(t){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1],a={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(f=>JSON.stringify(f)),vid:(f=>{let g=f&&f.data.sid&&this.baseInfoMap.get(f.data.sid);return g&&g.info.vid&&+g.info.vid||0})(t[0])};Bi.networkState===Ws.OFFLINE&&await Pe.race([Bi.onlineWaiter,Qr(2*dr.maxRetryTimeout)]);let l=i?"/events/proto-raws":"/events/messages",p=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(ce("EVENT_REPORT_DOMAIN"),"&p=").concat(ce("STATS_COLLECTOR_PORT"),"&d=").concat(l):"https://".concat(ce("EVENT_REPORT_DOMAIN"),":").concat(ce("STATS_COLLECTOR_PORT")).concat(l));for(let f=0;f<2;f+=1){f===1&&(p=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(ce("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(ce("STATS_COLLECTOR_PORT"),"&d=").concat(l):"https://".concat(ce("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(ce("STATS_COLLECTOR_PORT")).concat(l)));try{i?await uh(p,{timeout:1e4,data:a}):await oe(p,{timeout:1e4,data:a})}catch(g){if(f===1)throw g;continue}return}}createBaseInfo(t,i){let a=Object.assign({},eP);return a.sid=t,this.baseInfoMap.set(t,{info:a,startTime:i}),a}reportResourceTiming(t,i){let a=performance.getEntriesByName(t),l=a[a.length-1];l&&this.reportApiInvoke(i,{name:"Client.resourceTiming",options:l,tag:Pi.TRACER}).onSuccess()}}function bt(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,i,a){let l=a.value;if(typeof l=="function"){let p=s.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);a.value=function(){for(var f=arguments.length,g=new Array(f),v=0;v<f;v++)g[v]=arguments[v];let y=g;if(s.argsMap)try{y=s.argsMap(this,...g)}catch(b){x.warning(b),y=[]}try{JSON.stringify(y)}catch{x.warning("arguments for method ".concat(p,".").concat(String(i)," not serializable for apiInvoke.")),y=[]}let I=(s.report||Tt).reportApiInvoke(this._sessionId||null,{name:"".concat(p,".").concat(String(i)),options:y,tag:Pi.TRACER,reportResult:s.reportResult},s.throttleTime);try{let b=l.apply(this,g);return b instanceof Pe?b.then(k=>(I.onSuccess(s.reportResult&&k),k)).catch(k=>{throw I.onError(k),k}):(I.onSuccess(s.reportResult&&b),b)}catch(b){throw I.onError(b),b}}}return a}}P(df,"__CLIENT_LIST__",[]);let Tt=new df;Pp.on("REPORT_LOG_UPLOAD",s=>{s.networkState=Bi.networkState,Tt.reportApiInvoke(null,{name:"logUploadError",options:s,tag:Pi.TRACER})});let ww=["CHINA","GLOBAL"],Gi=function(){let s="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");let a=i.join(""),l=[];for(let g=0;g<6;g++)l.push("1");let p=l.join(""),f={};return f[s]=a,f[t]=p,Object.assign(f,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Gi,Rw||(io.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],io.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],io.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],io.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],io.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],io.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],io.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",io.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",io.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",io.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",io.AREAS=["NORTH_AMERICA","OVERSEA"]);let kp=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Wc=[];function Hs(s,t){return!!t&&Wc.some(i=>i.uid===s&&i.channelName===t)}df.__CLIENT_LIST__=Wc;var Ts,Ct,Jt,pt,ft,fr,Qe,an,st,qe,Li,Ut,nP,Ks,xt,br,hh,bw=sa("Array").values,YB=Pa,wd=ji,Ge=ge,z=bw,Te=Array.prototype,Ow={DOMTokenList:!0,NodeList:!0},hc=A(function(s){var t=s.values;return s===Te||Ge(Te,s)&&t===Te.values||wd(Ow,YB(s))?z:t});function Be(s,t,i,a){var l,p=arguments.length,f=p<3?t:a===null?a=Object.getOwnPropertyDescriptor(t,i):a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")f=Reflect.decorate(s,t,i,a);else for(var g=s.length-1;g>=0;g--)(l=s[g])&&(f=(p<3?l(f):p>3?l(t,i,f):l(t,i))||f);return p>3&&f&&Object.defineProperty(t,i,f),f}function Y(s,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(s,t)}(function(s){s.L1T1="L1T1",s.L1T2="L1T2",s.L1T3="L1T3",s.L2T1_KEY="L2T1_KEY",s.L2T2_KEY="L2T2_KEY",s.L2T3_KEY="L2T3_KEY",s.L3T1_KEY="L3T1_KEY",s.L3T2_KEY="L3T2_KEY",s.L3T3_KEY="L3T3_KEY"})(Ts||(Ts={})),function(s){s.CERTIFICATE="certificate",s.CODEC="codec",s.CANDIDATE_PAIR="candidate-pair",s.LOCAL_CANDIDATE="local-candidate",s.REMOTE_CANDIDATE="remote-candidate",s.INBOUND="inbound-rtp",s.TRACK="track",s.OUTBOUND="outbound-rtp",s.PC="peer-connection",s.REMOTE_INBOUND="remote-inbound-rtp",s.REMOTE_OUTBOUND="remote-outbound-rtp",s.TRANSPORT="transport",s.CSRC="csrc",s.DATA_CHANNEL="data-channel",s.STREAM="stream",s.SENDER="sender",s.RECEIVER="receiver"}(Ct||(Ct={})),function(s){s[s.ACCESS_POINT=101]="ACCESS_POINT",s[s.UNILBS=201]="UNILBS",s[s.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(Jt||(Jt={})),function(s){s[s.IIIEGAL_APPID=1]="IIIEGAL_APPID",s[s.IIIEGAL_UID=2]="IIIEGAL_UID",s[s.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(pt||(pt={})),function(s){s[s.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",s[s.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",s[s.INTERNAL_ERROR=8]="INTERNAL_ERROR",s[s.NO_AUTHORIZED=9]="NO_AUTHORIZED",s[s.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",s[s.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",s[s.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",s[s.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",s[s.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",s[s.USER_OVERLOAD=16]="USER_OVERLOAD",s[s.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",s[s.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(ft||(ft={})),function(s){s[s.NO_FLAG_SET=100]="NO_FLAG_SET",s[s.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",s[s.INVALID_FALG_SET=102]="INVALID_FALG_SET",s[s.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",s[s.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",s[s.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",s[s.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",s[s.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",s[s.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",s[s.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",s[s.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",s[s.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",s[s.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",s[s.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",s[s.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",s[s.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",s[s.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",s[s.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",s[s.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(fr||(fr={})),function(s){s[s.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",s[s.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",s[s.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",s[s.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",s[s.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",s[s.K_TICKET_INVALID=7]="K_TICKET_INVALID",s[s.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",s[s.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",s[s.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",s[s.K_UID_BANNED=14]="K_UID_BANNED",s[s.K_IP_BANNED=15]="K_IP_BANNED",s[s.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",s[s.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",s[s.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",s[s.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",s[s.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",s[s.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",s[s.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",s[s.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",s[s.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",s[s.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",s[s.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",s[s.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",s[s.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",s[s.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",s[s.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",s[s.ERR_INVALID_UID=117]="ERR_INVALID_UID",s[s.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",s[s.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",s[s.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",s[s.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",s[s.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",s[s.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",s[s.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",s[s.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",s[s.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",s[s.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",s[s.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",s[s.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",s[s.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",s[s.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",s[s.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",s[s.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",s[s.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",s[s.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",s[s.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",s[s.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",s[s.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",s[s.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",s[s.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",s[s.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",s[s.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",s[s.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",s[s.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",s[s.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",s[s.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",s[s.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",s[s.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",s[s.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",s[s.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",s[s.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",s[s.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",s[s.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",s[s.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(Qe||(Qe={})),function(s){s.CONNECTING="connecting",s.CONNECTED="connected",s.RECONNECTING="reconnecting",s.CLOSED="closed"}(an||(an={})),function(s){s.WS_CONNECTED="ws_connected",s.WS_RECONNECTING="ws_reconnecting",s.WS_CLOSED="ws_closed",s.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",s.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",s.ON_BINARY_DATA="on_binary_data",s.REQUEST_RECOVER="request_recover",s.REQUEST_JOIN_INFO="request_join_info",s.REQUEST_REJOIN_INFO="req_rejoin_info",s.IS_P2P_DISCONNECTED="is_p2p_dis",s.DISCONNECT_P2P="dis_p2p",s.ABORT_P2P_EXECUTION="abort_p2p_execution",s.NEED_RENEW_SESSION="need-sid",s.REPORT_JOIN_GATEWAY="report_join_gateway",s.REQUEST_TIMEOUT="request_timeout",s.REQUEST_SUCCESS="request_success",s.JOIN_RESPONSE="join_response",s.DATACHANNEL_PRECONNECT="datachannel_preconnect",s.DATACHANNEL_CONNECTING="datachannel_connecting",s.DATACHANNEL_FAILBACK="datachannel_failback",s.P2P_CONNECTION="p2p_connection",s.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",s.P2P_SUBSCRIBE="p2p_subscribe",s.P2P_UNSUBSCRIBE="p2p_unsubscribe",s.P2P_EXCHANGE_SDP="p2p_exchange_sdp",s.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",s.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(st||(st={})),function(s){s.PING="ping",s.PING_BACK="ping_back",s.JOIN="join_v3",s.REJOIN="rejoin_v3",s.LEAVE="leave",s.SET_CLIENT_ROLE="set_client_role",s.PUBLISH="publish",s.PUBLISH_DATASTREAM="publish_datastream",s.UNPUBLISH="unpublish",s.UNPUBLISH_DATASTREAM="unpublish_datastream",s.SUBSCRIBE="subscribe",s.PRE_SUBSCRIBE="pre_subscribe",s.SUBSCRIBE_DATASTREAM="subscribe_datastream",s.SUBSCRIBE_STREAMS="subscribe_streams",s.UNSUBSCRIBE="unsubscribe",s.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",s.UNSUBSCRIBE_STREAMS="unsubscribe_streams",s.SUBSCRIBE_CHANGE="subscribe_change",s.TRAFFIC_STATS="traffic_stats",s.RENEW_TOKEN="renew_token",s.SWITCH_VIDEO_STREAM="switch_video_stream",s.DEFAULT_VIDEO_STREAM="default_video_stream",s.SET_FALLBACK_OPTION="set_fallback_option",s.GATEWAY_INFO="gateway_info",s.CONTROL="control",s.SEND_METADATA="send_metadata",s.DATA_STREAM="data_stream",s.PICK_SVC_LAYER="pick_svc_layer",s.RESTART_ICE="restart_ice",s.CONNECT_PC="connect_pc",s.SET_VIDEO_PROFILE="set_video_profile",s.SET_PARAMETER="set_parameter",s.SET_RTM2_FLAG="set_rtm2_flag"}(qe||(qe={})),function(s){s.WRTC_STATS="wrtc_stats",s.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",s.DENOISER_STATS="denoiser_stats",s.EXTENSION_USAGE_STATS="extension_usage_stats"}(Li||(Li={})),function(s){s.ON_USER_ONLINE="on_user_online",s.ON_USER_OFFLINE="on_user_offline",s.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",s.ON_PUBLISH_STREAM="on_publish_stream",s.ON_UPLINK_STATS="on_uplink_stats",s.ON_P2P_LOST="on_p2p_lost",s.ON_REMOVE_STREAM="on_remove_stream",s.ON_ADD_AUDIO_STREAM="on_add_audio_stream",s.ON_ADD_VIDEO_STREAM="on_add_video_stream",s.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",s.ON_USER_BANNED="on_user_banned",s.ON_USER_LICENSE_BANNED="on_user_license_banned",s.ON_NOTIFICATION="on_notification",s.ON_CRYPT_ERROR="on_crypt_error",s.MUTE_AUDIO="mute_audio",s.MUTE_VIDEO="mute_video",s.UNMUTE_AUDIO="unmute_audio",s.UNMUTE_VIDEO="unmute_video",s.ON_P2P_OK="on_p2p_ok",s.RECEIVE_METADATA="receive_metadata",s.ON_DATA_STREAM="on_data_stream",s.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",s.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",s.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",s.ENABLE_LOCAL_VIDEO="enable_local_video",s.DISABLE_LOCAL_VIDEO="disable_local_video",s.ENABLE_LOCAL_AUDIO="enable_local_audio",s.DISABLE_LOCAL_AUDIO="disable_local_audio",s.ON_PUBLISHED_USER_LIST="on_published_user_list"}(Ut||(Ut={})),function(s){s.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",s.NEED_ANSWER="NEED_ANSWER",s.NEED_RENEGOTIATE="NEED_RENEGOTIATE",s.P2P_LOST="P2P_LOST",s.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",s.NEED_UNPUB="NEED_UNPUB",s.NEED_UNSUB="NEED_UNSUB",s.NEED_UPLOAD="NEED_UPLOAD",s.NEED_CONTROL="NEED_CONTROL",s.START_RECONNECT="START_RECONNECT",s.END_RECONNECT="END_RECONNECT",s.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(nP||(nP={})),function(s){s.SEND_ONLY="SEND_ONLY",s.RECEIVE_ONLY="RECEIVE_ONLY"}(Ks||(Ks={})),function(s){s.CONNECTED="websocket:connected",s.RECONNECTING="websocket:reconnecting",s.WILL_RECONNECT="websocket:will_reconnect",s.CLOSED="websocket:closed",s.FAILED="websocket:failed",s.ON_MESSAGE="websocket:on_message",s.REQUEST_NEW_URLS="websocket:request_new_urls",s.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",s.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(xt||(xt={}));class Ce extends Ve{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),P(this,"name","AgoraRTCException")}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(t,x)}throw(){super.throw(x)}}function Nw(s){if(typeof s!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(s))throw x.error("Invalid Channel Name ".concat(s)),new Ce(Z.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Dw(s){if(t=s,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||nl(s,1,255)))throw new Ce(Z.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof s=="string"&&x.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}(function(s){s.TRANSCODE="mix_streaming",s.RAW="raw_streaming",s.INJECT="inject_streaming"})(br||(br={})),function(s){s[s.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",s[s.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",s[s.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",s[s.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",s[s.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",s[s.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",s[s.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",s[s.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",s[s.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",s[s.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",s[s.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(hh||(hh={}));let Hc={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},ph={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Xi(s,t){jr(s.url,"".concat(t,".url"),1,1e3,!1),ke(s.x)||bn(s.x,"".concat(t,".x"),0,1e4),ke(s.y)||bn(s.y,"".concat(t,".y"),0,1e4),ke(s.width)||bn(s.width,"".concat(t,".width"),0,1e4),ke(s.height)||bn(s.height,"".concat(t,".height"),0,1e4),ke(s.zOrder)||bn(s.zOrder,"".concat(t,".zOrder"),0,255),ke(s.alpha)||bn(s.alpha,"".concat(t,".alpha"),0,1,!1)}let iP={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Ys={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var Cs,hs,Ti,Nn,An,Do,Yn,bd,At,Wi,mh,On,Lp,Cn;function Pw(s){if(!s.channelName)throw new Ce(Z.INVALID_PARAMS,"invalid channelName in info");if(typeof s.uid!="number")throw new Ce(Z.INVALID_PARAMS,"invalid uid in info, uid must be a number");return s.token&&jr(s.token,"info.token",1,2047),Dw(s.uid),Nw(s.channelName),!0}(function(s){s.WARNING="@live_uap-warning",s.ERROR="@line_uap-error",s.PUBLISH_STREAM_STATUS="@live_uap-publish-status",s.INJECT_STREAM_STATUS="@live_uap-inject-status",s.WORKER_STATUS="@live_uap-worker-status",s.REQUEST_NEW_ADDRESS="@live_uap-request-address"})(Cs||(Cs={})),function(s){s.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(hs||(hs={})),function(s){s[s.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",s[s.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",s[s.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",s[s.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",s[s.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",s[s.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",s[s.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",s[s.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",s[s.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",s[s.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",s[s.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",s[s.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",s[s.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",s[s.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",s[s.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",s[s.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",s[s.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",s[s.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",s[s.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",s[s.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",s[s.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(Ti||(Ti={})),function(s){s.CONNECT_FAILED="connect failed",s.CONNECT_TIMEOUT="connect timeout",s.WS_DISCONNECTED="websocket disconnected",s.REQUEST_TIMEOUT="request timeout",s.REQUEST_FAILED="request failed",s.WAIT_STATUS_TIMEOUT="wait status timeout",s.WAIT_STATUS_ERROR="wait status error",s.BAD_STATE="bad state",s.WS_ABORT="ws abort",s.AP_REQUEST_TIMEOUT="AP request timeout",s.AP_JSON_PARSE_ERROR="AP json parse error",s.AP_REQUEST_ERROR="AP request error",s.AP_REQUEST_ABORT="AP request abort"}(Nn||(Nn={})),function(s){s[s.SetSdkProfile=0]="SetSdkProfile",s[s.SetSourceChannel=1]="SetSourceChannel",s[s.SetSourceUserId=2]="SetSourceUserId",s[s.SetDestChannel=3]="SetDestChannel",s[s.StartPacketTransfer=4]="StartPacketTransfer",s[s.StopPacketTransfer=5]="StopPacketTransfer",s[s.UpdateDestChannel=6]="UpdateDestChannel",s[s.Reconnect=7]="Reconnect",s[s.SetVideoProfile=8]="SetVideoProfile"}(An||(An={})),function(s){s.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",s.NETWORK_CONNECTED="NETWORK_CONNECTED",s.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",s.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",s.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",s.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",s.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",s.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",s.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",s.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(Do||(Do={})),function(s){s.RELAY_STATE_IDLE="RELAY_STATE_IDLE",s.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",s.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",s.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(Yn||(Yn={})),function(s){s.RELAY_OK="RELAY_OK",s.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",s.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",s.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(bd||(bd={})),function(s){s.High="high",s.Low="low",s.Audio="audio",s.Screen="screen",s.ScreenLow="screen_low"}(At||(At={})),function(s){s.DISCONNECT="disconnect",s.CONNECTION_STATE_CHANGE="connection-state-change",s.NETWORK_QUALITY="network-quality",s.STREAM_TYPE_CHANGE="stream-type-change",s.IS_P2P_DISCONNECTED="is-p2p-dis",s.DISCONNECT_P2P="dis-p2p",s.REQUEST_NEW_GATEWAY_LIST="req-gate-url",s.NEED_RENEW_SESSION="need-sid",s.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",s.JOIN_RESPONSE="join-response",s.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",s.RESET_CONNECTION_EVENTS="reset-connection-events",s.DATACHANNEL_PRECONNECT="datachannel_preconnect",s.DATACHANNEL_FAILBACK="datachannel_failback",s.RESET_SIGNAL="reset-signal"}(Wi||(Wi={})),function(s){s.P2P_DISCONNECTED="P2P_DISCONNECTED",s.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",s.TIMEOUT="TIMEOUT",s.UNKNOWN_REASON="UNKNOWN_REASON"}(mh||(mh={})),function(s){s[s.Nothing=0]="Nothing",s[s.Audio=1]="Audio",s[s.LwoVideo=2]="LwoVideo",s[s.Video=4]="Video",s[s.Data=8]="Data",s[s.DataStream0=256]="DataStream0",s[s.DataStream1=512]="DataStream1",s[s.DataStream2=1024]="DataStream2",s[s.DataStream3=2048]="DataStream3",s[s.DataStream4=4096]="DataStream4",s[s.DataStream5=8192]="DataStream5",s[s.DataStream6=16384]="DataStream6",s[s.DataStream7=32768]="DataStream7"}(On||(On={})),function(s){s[s.websocket=0]="websocket",s[s.datachannel=1]="datachannel"}(Lp||(Lp={})),function(s){s.CHINA="CHINA",s.ASIA="ASIA",s.NORTH_AMERICA="NORTH_AMERICA",s.EUROPE="EUROPE",s.JAPAN="JAPAN",s.INDIA="INDIA",s.KOREA="KOREA",s.HKMC="HKMC",s.US="US",s.OCEANIA="OCEANIA",s.SOUTH_AMERICA="SOUTH_AMERICA",s.AFRICA="AFRICA",s.OVERSEA="OVERSEA",s.GLOBAL="GLOBAL",s.EXTENSIONS="EXTENSIONS"}(Cn||(Cn={}));let gt=[Cn.AFRICA,Cn.ASIA,Cn.CHINA,Cn.EUROPE,Cn.GLOBAL,Cn.INDIA,Cn.JAPAN,Cn.NORTH_AMERICA,Cn.OCEANIA,Cn.OVERSEA,Cn.SOUTH_AMERICA];var Xn;(function(s){s.CHINA="CN",s.ASIA="AS",s.NORTH_AMERICA="NA",s.EUROPE="EU",s.JAPAN="JP",s.INDIA="IN",s.KOREA="KR",s.HKMC="HK",s.US="US",s.OCEANIA="OC",s.SOUTH_AMERICA="SA",s.AFRICA="AF",s.OVERSEA="OVERSEA",s.GLOBAL="GLOBAL",s.EXTENSIONS="GLOBAL"})(Xn||(Xn={}));let Ua={CHINA:{},ASIA:{CODE:Xn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Xn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Xn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Xn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Xn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Xn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Xn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Xn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Xn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Xn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Xn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Xn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Xn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var Je,kn,We,vs,$r,Ke,Yt,wt,Qi,Gr,la,ci,Rs,mi,Qn,cu,es,xa,ll,Hi,Od,ul,hg,kw;Rw&&(Ua.CHINA={CODE:Xn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(s){s.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(Je||(Je={}));class fh extends ri{constructor(t,i){super(),P(this,"onICEConnectionStateChange",void 0),P(this,"onConnectionStateChange",void 0),P(this,"onDTLSTransportStateChange",void 0),P(this,"onDTLSTransportError",void 0),P(this,"onICETransportStateChange",void 0),P(this,"onFirstAudioReceived",void 0),P(this,"onFirstVideoReceived",void 0),P(this,"onFirstAudioDecoded",void 0),P(this,"onFirstVideoDecoded",void 0),P(this,"onFirstVideoDecodedTimeout",void 0),P(this,"onSelectedLocalCandidateChanged",void 0),P(this,"onSelectedRemoteCandidateChanged",void 0)}}class pg extends fh{constructor(t,i){super(t,i)}}(function(s){s.SEND="sendonly",s.RECV="recvonly",s.SENDRECV="sendrecv",s.INACTIVE="inactive"})(kn||(kn={})),function(s){s.VIDEO="video",s.AUDIO="audio"}(We||(We={})),function(s){s[s.UDP=0]="UDP",s[s.TCP=1]="TCP",s[s.RELAY=2]="RELAY"}(vs||(vs={})),function(s){s[s.FIRST_CONNECTION=0]="FIRST_CONNECTION",s[s.TCP_RESTART=1]="TCP_RESTART",s[s.RELAY_RESTART=2]="RELAY_RESTART",s[s.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",s[s.OLD_RESTART=11]="OLD_RESTART",s[s.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}($r||($r={})),function(s){s.LocalVideoTrack="videoTrack",s.LocalAudioTrack="audioTrack",s.LocalVideoLowTrack="videoLowTrack"}(Ke||(Ke={})),function(s){s.New="new",s.Connected="connected",s.Reconnecting="reconnecting",s.Disconnected="disconnected"}(Yt||(Yt={})),function(s){s.StateChange="stateChange",s.IceConnectionStateChange="iceConnectionStateChange",s.RequestMuteLocal="requestMuteLocal",s.RequestUnmuteLocal="requestUnmuteLocal",s.RequestRePublish="requestRePublish",s.RequestRePublishDataChannel="requestRePublishDataChannel",s.RequestReSubscribe="requestReSubscribe",s.RequestUploadStats="requestUploadStats",s.RequestUpload="requestUpload",s.MediaReconnectStart="MediaReconnectStart",s.MediaReconnectEnd="MediaReconnectEnd",s.NeedSignalRTT="NeedSignalRTT",s.RequestRestartICE="RequestRestartIce",s.PeerConnectionStateChange="PeerConnectionStateChange",s.RequestReconnect="RequestReconnect",s.RequestReconnectPC="RequestReconnectPC",s.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",s.P2PLost="P2PLost",s.UpdateVideoEncoder="UpdateVideoEncoder",s.ConnectionTypeChange="ConnectionTypeChange",s.RequestLowStreamParameter="RequestLowStreamParameter",s.QueryClientConnectionState="QueryClientConnectionState",s.LocalCandidate="LocalCandidate",s.RequestP2PMuteLocal="requestP2PMuteLocal",s.RequestP2PUnPublish="RequestP2PUnPublish",s.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",s.RequestP2PMuteRemote="RequestP2PMuteRemote",s.RequestP2PRestartICE="RequestP2PRestartICE"}(wt||(wt={})),function(s){s.MUTE_LOCAL_VIDEO="mute_local_video",s.MUTE_LOCAL_AUDIO="mute_local_audio",s.UNMUTE_LOCAL_VIDEO="unmute_local_video",s.UNMUTE_LOCAL_AUDIO="unmute_local_audio",s.MUTE_REMOTE_VIDEO="mute_remote_video",s.MUTE_REMOTE_AUDIO="mute_remote_audio",s.UNMUTE_REMOTE_VIDEO="unmute_remote_video",s.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(Qi||(Qi={})),function(s){s.CONNECTING="CONNECTING",s.RECONNECTING="RECONNECTING",s.CONNECTED="CONNECTED",s.CLOSED="CLOSED"}(Gr||(Gr={})),function(s){s[s.CONNECT_AP=0]="CONNECT_AP",s[s.AP_CONNECTED=1]="AP_CONNECTED",s[s.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",s[s.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",s[s.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",s[s.CONNECT_WORKER=5]="CONNECT_WORKER",s[s.WORKER_CONNECTED=6]="WORKER_CONNECTED",s[s.CLOSED=7]="CLOSED"}(la||(la={})),function(s){s.CONNECTION_STATE_CHANGE="connection-state-change",s.STATE_CHANGE="state-change",s.INSPECT_RESULT="inspect-result",s.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",s.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(ci||(ci={})),function(s){s.NETWORK_ERROR="NETWORK_ERROR",s.SERVER_ERROR="SERVER_ERROR",s.MULTI_IP="MULTI_IP",s.TIMEOUT="TIMEOUT",s.OFFLINE="OFFLINE",s.LEAVE="LEAVE",s.P2P_FAILED="P2P_FAILED",s.FALLBACK="FALLBACK"}(Rs||(Rs={})),function(s){s.CONNECTED="transmitter:connected",s.RECONNECTING="transmitter:reconnecting",s.WILL_RECONNECT="transmitter:will_reconnect",s.CLOSED="transmitter:closed",s.FAILED="transmitter:failed",s.ON_MESSAGE="transmitter:on_message",s.REQUEST_NEW_URLS="transmitter:request_new_urls",s.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",s.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",s.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",s.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",s.FAILBACK="transmitter:failback"}(mi||(mi={})),function(s){s.CAMERA_CHANGED="camera-changed",s.MICROPHONE_CHANGED="microphone-changed",s.PLAYBACK_DEVICE_CHANGED="playback-device-changed",s.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",s.AUTOPLAY_FAILED="autoplay-failed",s.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",s.SECURITY_POLICY_VIOLATION="security-policy-violation"}(Qn||(Qn={})),function(s){s[s.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",s[s.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",s[s.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",s[s.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",s[s.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",s[s.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",s[s.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",s[s.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",s[s.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",s[s.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",s[s.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",s[s.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",s[s.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",s[s.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",s[s.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",s[s.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",s[s.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",s[s.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",s[s.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",s[s.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(cu||(cu={})),function(s){s.CONNECTING="CONNECTING",s.RECONNECTING="RECONNECTING",s.CONNECTED="CONNECTED",s.CLOSED="CLOSED"}(es||(es={})),function(s){s.CONNECTION_STATE_CHANGE="connection-state-change",s.STATE_CHANGE="state-change",s.INSPECT_RESULT="inspect-result",s.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",s.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(xa||(xa={})),function(s){s[s.CONNECT_AP=0]="CONNECT_AP",s[s.AP_CONNECTED=1]="AP_CONNECTED",s[s.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",s[s.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",s[s.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",s[s.CONNECT_WORKER=5]="CONNECT_WORKER",s[s.WORKER_CONNECTED=6]="WORKER_CONNECTED",s[s.CLOSED=7]="CLOSED"}(ll||(ll={})),function(s){s.CALL="call",s.CANDIDATE="candidate",s.PUBLISH="publish",s.UNPUBLISH="unpublish",s.CONTROL="control",s.RESTART_ICE="restart_ice",s.ACK="ack",s.RESPONSE="response",s.JOIN="join",s.CHECK="check"}(Hi||(Hi={})),function(s){s.ABORT="abort"}(Od||(Od={})),function(s){s.MUTE_LOCAL_AUDIO="mute_local_audio",s.MUTE_LOCAL_VIDEO="mute_local_video",s.UNMUTE_LOCAL_AUDIO="unmute_local_audio",s.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(ul||(ul={})),function(s){s[s.SUCCESS=1]="SUCCESS",s[s.FAILED=0]="FAILED"}(hg||(hg={})),function(s){s.P2P_TOKEN_TIMEOUT="p2p_token_timeout",s.P2P_TOKEN_CHANGED="p2p_token_changed"}(kw||(kw={}));let Lw={[Jt.ACCESS_POINT]:{[fr.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[fr.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[fr.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[fr.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[fr.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[fr.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[fr.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Jt.UNILBS]:{[ft.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ft.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ft.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ft.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ft.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ft.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ft.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ft.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ft.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ft.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ft.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ft.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Jt.STRING_UID_ALLOCATOR]:{[pt.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[pt.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[pt.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function mg(s){let t=Lw[Math.floor(s/1e4)];if(!t)return{desc:"unkonw error",retry:!1};let i=t[s%1e4];if(!i){if(Math.floor(s/1e4)===Jt.ACCESS_POINT){let a=s%1e4;if(a.toString()[0]==="1")return{desc:s.toString(),retry:!1};if(a.toString()[0]==="2")return{desc:s.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}let rP={[Qe.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Qe.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Qe.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Qe.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Qe.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Qe.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Qe.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Qe.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Qe.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Qe.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Qe.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Qe.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Qe.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Qe.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Qe.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Qe.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Qe.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Qe.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Qe.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Qe.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Qe.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Qe.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Qe.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Qe.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Qe.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Qe.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Qe.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Qe.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Qe.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Qe.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Qe.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Qe.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Qe.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Qe.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Qe.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Qe.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Qe.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Qe.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Qe.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Qe.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Qe.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Qe.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Qe.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Qe.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Qe.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Qe.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Qe.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Qe.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Qe.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Qe.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Qe.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Qe.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Qe.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Qe.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Qe.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Qe.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Qe.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Qe.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Qe.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Qe.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Qe.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Qe.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Qe.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Mp(s){return rP[s]||{desc:"UNKNOW_ERROR_".concat(s),action:"failed"}}function sP(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Mw(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?sP(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):sP(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function oP(s){return s.every(t=>t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING)}function aP(s,t){if(typeof s=="string")return s;let{proxy:i,host:a,port:l}=s;if(t){let p=ce("JOIN_GATEWAY_FALLBACK_PORT")||443;return p===443?"wss://".concat(a,"/ws/?p=").concat(Number(l)+150):"wss://".concat(a,":").concat(p,"/ws/?p=").concat(Number(l)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(a,"&p=").concat(l):"wss://".concat(a,":").concat(l)}let zB=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,cP=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,dP=/wss:\/\/(.+):([0-9]+)\/?/,fg=/wss:\/\/(.[^\/]+)\/?/,_g=0;class lP{constructor(t,i){P(this,"id",0),P(this,"store",void 0),P(this,"recordIndex",void 0),P(this,"websockets",[]),P(this,"try443PortDuration",2e3),P(this,"forceCloseWSDuration",5e3),P(this,"try443PortTimeout",null),P(this,"forceCloseTimeout",null),P(this,"isTry443PortFailed",!1),P(this,"isNormalPortFailed",!1),P(this,"useDoubleDomain",!1),P(this,"useProxy",!1),P(this,"startTime",Date.now()),this.id=++_g,this.try443PortDuration=ce("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=i}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var t;let i=Date.now()-this.startTime;for(var a=arguments.length,l=new Array(a),p=0;p<a;p++)l[p]=arguments[p];x.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...l)}createWebSocket(t,i,a){this.logger("createWebSocket:",t,{isTry443Port:i,hasTimeoutDetection:a});let l=ce("GATEWAY_DOMAINS"),p=Date.now(),f=[],g=l.find(I=>{var b;return xe(b=t.host).call(b,I)});g||(this.useDoubleDomain=!1);let v=[];if(this.useDoubleDomain)l.forEach(I=>{v.push(aP(Mw(Mw({},t),{},{host:t.host.replace(g,I)}),i))});else{let I=Mw({},t);if(i&&g){let b=l.find(k=>k!==g);b&&(I.host=I.host.replace(g,b))}v.push(aP(I,i))}try{v.forEach(I=>{let b=new WebSocket(I);b.binaryType="arraybuffer",f.push(b),this.logger("ws is connecting:",b.url)})}catch(I){if(this.logger("ws create failed"),f.forEach(b=>b.close()),f.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,i,a);if(!i&&Number(t.port)!==443)return this.createWebSocket(t,!0,a);throw new Ce(Z.WS_ERR,"init websocket failed! Error: ".concat(I.toString()))}let y=ZE();return this.store&&this.store.recordJoinChannelService({urls:f.map(I=>I.url),service:"gateway"},this.recordIndex),f.forEach(I=>{I.onopen=()=>{this.logger("onopen: ws ".concat(I.url," open cost ").concat(Date.now()-p,"ms")),this.websockets.forEach(b=>{b!==I&&(b.onopen=null,b.onclose=null,b.onmessage=null,b.close(),this.logger("close backup websocket: ".concat(b.url)))}),this.websockets.length=0,y.resolve(I)},I.onclose=b=>{this.logger("onclose: ws ".concat(I.url," closed cost ").concat(Date.now()-p,"ms state: ").concat(I.readyState)),i?this.isTry443PortFailed=oP(f):this.isNormalPortFailed=oP(f),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(i&&this.isTry443PortFailed||!i&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(b.reason)),y.reject({code:b.code,reason:mh.A_ROUND_WS_FAILED}))},I.onmessage=b=>this.logger("".concat(I.url," onmessage: ").concat(b.data))}),this.websockets.push(...f),a||(()=>{let I=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",y.isResolved),this.websockets.forEach(b=>b.readyState!==WebSocket.OPEN&&b.close())};if(i||this.useProxy)return this.logger("add 5s timeout at ".concat(i?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(I,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",y.isResolved),y.isResolved)return I();En().os===Cr.MAC_OS&&Hn()&&I(),this.createWebSocket(t,!0,!0).then(b=>y.resolve(b)).catch(b=>{this.isNormalPortFailed&&y.reject(b),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(I,this.forceCloseWSDuration)},this.try443PortDuration)})(),y.promise}chooseBestWebsocket(t,i,a,l){return this.useDoubleDomain=!!i,typeof t=="string"&&(t=function(p){let f,g,v;return[,f,g,v]=p.match(zB)||[],f||([,g,v]=p.match(cP)||[]),g&&v||([,g,v]=p.match(dP)||[]),g&&v||([,g]=p.match(fg)||[]),g||x.warning("un-destructible url: ",p),{proxy:f,host:g,port:v||"443"}}(t)),this.recordIndex=l,this.useProxy=!!t.proxy,a&&this.useProxy&&(x.warn("cannot use 443 only when use proxy"),a=!1),this.createWebSocket(t,!!a,!1).finally(()=>this.clearTimeout())}}function Uw(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}class uP extends ri{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var i;xe(i=["tryNext","recover"]).call(i,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(xt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(xt.CONNECTED):this._state==="closed"?this.emit(xt.CLOSED):this._state==="failed"&&this.emit(xt.FAILED))}resetReconnectCount(t){x.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,i){let a=arguments.length>2&&arguments[2]!==void 0&&arguments[2],l=arguments.length>3&&arguments[3]!==void 0&&arguments[3],p=arguments.length>4&&arguments[4]!==void 0&&arguments[4],f=arguments.length>5?arguments[5]:void 0;super(),P(this,"connectionID",0),P(this,"currentURLIndex",0),P(this,"urls",[]),P(this,"_reconnectMode","tryNext"),P(this,"reconnectReason",void 0),P(this,"_initMutex",new sn("websocket")),P(this,"name",void 0),P(this,"_state","closed"),P(this,"reconnectInterrupter",void 0),P(this,"websocket",void 0),P(this,"retryConfig",void 0),P(this,"reconnectCount",0),P(this,"forceCloseTimeout",5e3),P(this,"onlineReconnectListener",void 0),P(this,"useCompress",void 0),P(this,"tryDoubleDomain",!1),P(this,"use443PortOnly",!1),P(this,"wsInflateLength",0),P(this,"wsDeflateLength",0),P(this,"closeEstablishingWs",()=>{}),P(this,"store",void 0),P(this,"joinGatewayRecordIndex",void 0),this.store=f,this.name=t,this.retryConfig=function(b){for(var k=1;k<arguments.length;k++){var U=arguments[k]!=null?arguments[k]:{};k%2?Uw(Object(U),!0).forEach(function(J){P(b,J,U[J])}):Object.getOwnPropertyDescriptors?Object.defineProperties(b,Object.getOwnPropertyDescriptors(U)):Uw(Object(U)).forEach(function(J){Object.defineProperty(b,J,Object.getOwnPropertyDescriptor(U,J))})}return b}({},i),this.useCompress=a,this.tryDoubleDomain=l,this.use443PortOnly=p;let{timeout:g,timeoutFactor:v}=i,y=Math.max(300,Math.floor(3*g/5)),I=Math.max(1.2,Math.floor(8*v)/10);Ws.ONLINE&&(this.retryConfig.timeout=y,this.retryConfig.timeoutFactor=I),Bi.on(Si.NETWORK_STATE_CHANGE,(b,k)=>{b!==k&&(this.resetReconnectCount("network state change: ".concat(k," -> ").concat(b)),b===Ws.ONLINE?(this.retryConfig.timeout=y,this.retryConfig.timeoutFactor=I):(this.retryConfig.timeout=g,this.retryConfig.timeoutFactor=v))})}getConnection(){return this.websocket||void 0}async init(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,a=await this._initMutex.lock();this.forceCloseTimeout=i,this.urls=t,this.state="connecting";try{let l=ZE(),p=this.urls[this.currentURLIndex];this.createWebSocketConnection(p).then(l.resolve).catch(l.reject),this.once(xt.CLOSED,()=>{l.reject(new Ve(Z.WS_DISCONNECT))}),this.once(xt.CONNECTED,l.resolve),await l.promise}catch{}finally{a()}}close(t,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let a=this.websocket;i?setTimeout(()=>a.close(),500):a.close(),this.websocket=void 0}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,i){if(!this.websocket)return void x.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),x.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);let a=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),a&&a.bind(this.websocket)({code:9999,reason:i})}sendMessage(t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new Ve(Z.WS_ABORT,"websocket is not ready");try{i||(t=JSON.stringify(t)),this.websocket.send(t)}catch(a){throw new Ve(Z.WS_ERR,"send websocket message error"+a.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){let t=this.wsInflateLength,i=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:i}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var i;let a=ZE();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let l=I=>{var b;(b=this.store)===null||b===void 0||b.signalChannelOpen(),x.debug("[".concat(this.name,"] websocket opened:"),I),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),a.resolve()},p=async I=>{var b;if(x.debug("[".concat(this.name,"] websocket close ").concat((b=this.websocket)===null||b===void 0?void 0:b.url,", code: ").concat(I.code,", reason: ").concat(I.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)a.reject(new Ve(Z.WS_DISCONNECT,"websocket close: ".concat(I.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=I.reason,this.state="reconnecting");let k=us(this,xt.WILL_RECONNECT,this.reconnectMode,I.reason)||this.reconnectMode,U=await this.reconnectWithAction(k);if(this.state==="closed")return void x.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!U)return a.reject(new Ve(Z.WS_DISCONNECT,"websocket reconnect failed: ".concat(I.code))),this.close(!0);a.resolve()}},f=I=>{this.emit(xt.ON_MESSAGE,I)},g=I=>{x.warn("[".concat(this.connectionID,"] ws open error ").concat(I))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),ce("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=ce("GATEWAY_WSS_ADDRESS")),x.debug("[".concat(this.name,"] start connect, url:"),t);let v=(i=this.store)===null||i===void 0?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var y;let I=await this.chooseBestWebsocketConnection(t);this.websocket=I,l&&l(this.websocket.url),this.websocket.onclose=p,this.websocket.onmessage=f,this.websocket.onerror=g,(y=this.store)===null||y===void 0||y.recordJoinChannelService({endTs:Date.now(),status:"success"},v),this.joinGatewayRecordIndex=v}catch(I){let b=this.state==="closed",k=I instanceof Ve,U=k&&I.code===Z.WS_ABORT,J=k&&I.code===Z.WS_ERR,K=k?I.message:I&&(I.reason||I.toString());x.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(K)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:U?"aborted":"error",errors:[I]},v),b||J?(a.reject(b?new Ve(Z.WS_DISCONNECT,"websocket is closed: ".concat(K)):new Ve(Z.WS_ERR,"init websocket failed: ".concat(K))),J&&x.error("[".concat(this.name,"] init websocket failed: ").concat(K))):p&&p(I)}return a.promise}async reconnectWithAction(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;x.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||Bi.isOnline||!Bi.onlineWaiter||(this.onlineReconnectListener=Bi.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let a=!0;if(this.reconnectInterrupter=()=>a=!1,i){let f=eu(this.reconnectCount,this.retryConfig);x.debug("[".concat(this.name,"] wait ").concat(f,"ms to reconnect websocket, mode: ").concat(t)),await Pe.race([Qr(f),this.onlineReconnectListener||new Pe(()=>{})])}if(this._state==="closed"||!a)return!1;this.reconnectCount+=1;let l=async(f,g)=>{this.emit(xt.RECONNECT_CREATE_CONNECTION,g),await this.createWebSocketConnection(f)};try{if(t==="retry")this.emit(xt.RECONNECT_WAITTING_FINISH,t),await l(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);x.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(xt.RECONNECT_WAITTING_FINISH,t),await l(this.urls[this.currentURLIndex],t)}else t==="recover"&&(x.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(xt.RECONNECT_WAITTING_FINISH,t),this.urls=await In(this,xt.REQUEST_NEW_URLS),this.currentURLIndex=0,await l(this.urls[this.currentURLIndex],t))}catch(f){var p;x.error("[".concat(this.name,"] reconnect failed ").concat(f&&f.toString()));let g=f==null||(p=f.data)===null||p===void 0?void 0:p.desc;return Array.isArray(g)&&xe(g).call(g,"dynamic key expired")?(this.emit(xt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(t,i)}return!0}}class Eg extends uP{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,i){let a=ZE(),l=function(f,g){return new lP(f,g)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{x.debug("[choose-best-ws] close establishing websockets"),l.closeAllWebsockets(),a.reject(new Ve(Z.WS_ABORT,"choose best websocket aborted"))};let p=ce("GATEWAY_DOMAINS");return x.debug("[choose-best-ws] currentDomain: ",t,", domains: ",p,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),l.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,i).then(a.resolve).catch(a.reject),a.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Up extends uP{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,i){return new Pe((a,l)=>{let p=!1,f=[];this.closeEstablishingWs=()=>{x.debug("[choose-best-ws] close establishing websockets"),f.forEach(J=>{J.onclose=null,J.onopen=null,J.onmessage=null,J.close()}),l(new Ve(Z.WS_ABORT,"choose best websocket aborted"))};let g=ce("GATEWAY_DOMAINS"),v,y=t.indexOf("?h="),I=g.find(J=>y!==-1?xe(t).call(t,J,y):xe(t).call(t,J));x.debug("[choose-best-ws] currentDomain: ",I,", domains: ",g);let b=!this.tryDoubleDomain||!I;if(!b&&I){var k;let J=Date.now();try{g.forEach(K=>{let q=y===-1?t.replace(I,K):t.substr(0,y)+t.substr(y).replace(I,K),te=new WebSocket(q);te.binaryType="arraybuffer",f.push(te),x.debug("[choose-best-ws] ws is connecting:",te.url)})}catch{for(x.debug("[choose-best-ws] ws create failed, fallback to single url"),f.forEach(K=>K.close());f.length;)f.pop();b=!0}(k=this.store)===null||k===void 0||k.recordJoinChannelService({urls:f.map(K=>K.url),service:"gateway"},i),f.forEach(K=>{K.onopen=()=>{if(p)return;let q=Date.now()-J;x.debug("[choose-best-ws] ws open cost ".concat(q,"ms")),f.filter(te=>te!==K).forEach(te=>{x.debug("[choose-best-ws]close backup websocket: ".concat(te.url)),te.close()}),p=!0,a(K)},K.onclose=q=>{v=q,!p&&(f.find(te=>!(te.readyState===WebSocket.CLOSED||te.readyState===WebSocket.CLOSING))||(x.debug("[choose-best-ws] all websocket is closed"),p=!0,l(v)))},K.onmessage=q=>{x.debug("[choose-best-ws]".concat(K.url," onmessage: ").concat(q.data))}}),Qr(this.forceCloseTimeout).then(()=>{f.forEach(K=>{K.readyState!==WebSocket.OPEN&&K.close()})})}if(b){var U;let J;x.debug("[choose-best-ws] use single url: ",t),(U=this.store)===null||U===void 0||U.recordJoinChannelService({urls:[t],service:"gateway"},i);try{J=new WebSocket(t),f.push(J),J.binaryType="arraybuffer"}catch(K){let q=new Ve(Z.WS_ERR,"init websocket failed! Error: ".concat(K.toString()));return x.error("[".concat(this.name,"]").concat(q)),void l(q)}J.onopen=()=>{a(J)},J.onclose=K=>{l(K)},J.onmessage=K=>{x.debug("[choose-best-ws]".concat(J.url," onmessage: ").concat(K.data))},Qr(this.forceCloseTimeout).then(()=>{J&&J.readyState!==WebSocket.OPEN&&J.close()})}}).then(a=>(this.closeEstablishingWs=void 0,a)).catch(a=>{throw this.closeEstablishingWs=void 0,a})}}class xw extends ri{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===an.CONNECTED?this.emit(st.WS_CONNECTED):t===an.RECONNECTING?this.emit(st.WS_RECONNECTING,this._websocketReconnectReason):t===an.CLOSED&&this.emit(st.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),P(this,"_disconnectedReason",void 0),P(this,"_websocketReconnectReason",void 0),P(this,"_connectionState",an.CLOSED),P(this,"reconnectToken",void 0),P(this,"websocket",void 0),P(this,"openConnectionTime",void 0),P(this,"clientId",void 0),P(this,"lastMsgTime",Date.now()),P(this,"uploadCache",[]),P(this,"uploadCacheInterval",void 0),P(this,"rttRolling",new tg(5)),P(this,"pingpongTimer",void 0),P(this,"wsInflateDataTimer",void 0),P(this,"pingpongTimeoutCount",0),P(this,"joinResponse",void 0),P(this,"multiIpOption",void 0),P(this,"initError",void 0),P(this,"spec",void 0),P(this,"store",void 0),P(this,"onWebsocketMessage",a=>{if(a.data instanceof ArrayBuffer)return void this.emit(st.ON_BINARY_DATA,a.data);let l=JSON.parse(a.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(l,"_id")){let p="res-@".concat(l._id);this.emit(p,l._result,l._message)}else if(Object.prototype.hasOwnProperty.call(l,"_type")){if(this.emit(l._type,l._message),l._type===Ut.ON_NOTIFICATION&&this.handleNotification(l._message),l._type===Ut.ON_USER_BANNED)switch(l._message.error_code){case 14:this.close(dn.UID_BANNED);break;case 15:this.close(dn.IP_BANNED);break;case 16:this.close(dn.CHANNEL_BANNED)}if(l._type===Ut.ON_USER_LICENSE_BANNED)switch(l._message.error_code){case Qe.ERR_LICENSE_MISSING:this.close(dn.LICENSE_MISSING);break;case Qe.ERR_LICENSE_EXPIRED:this.close(dn.LICENSE_EXPIRED);break;case Qe.ERR_LICENSE_MINUTES_EXCEEDED:this.close(dn.LICENSE_MINUTES_EXCEEDED);break;case Qe.ERR_LICENSE_PERIOD_INVALID:this.close(dn.LICENSE_PERIOD_INVALID);break;case Qe.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(dn.LICENSE_MULTIPLE_SDK_SERVICE);break;case Qe.ERR_LICENSE_ILLEGAL:this.close(dn.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new Eg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,ce("JOIN_GATEWAY_USE_DUAL_DOMAIN"),ce("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===an.CONNECTED&&this.reconnect("retry",pr.OFFLINE)})}async request(t,i,a,l){let p=si(6,""),f={_id:p,_type:t,_message:i},g=this.websocket.connectionID,v=()=>new Pe((J,K)=>{if(this.connectionState===an.CONNECTED)return J();let q=()=>{this.off(st.WS_CLOSED,te),J()},te=()=>{this.off(st.WS_CONNECTED,q),K(new Ce(Z.WS_ABORT))};this.once(st.WS_CONNECTED,q),this.once(st.WS_CLOSED,te),t!==qe.PUBLISH&&t!==qe.SUBSCRIBE&&t!==qe.UNSUBSCRIBE&&t!==qe.UNPUBLISH&&t!==qe.CONTROL&&t!==qe.RESTART_ICE||this.once(st.DISCONNECT_P2P,()=>{K(new Ce(Z.DISCONNECT_P2P))}),t!==qe.PUBLISH&&t!==qe.RESTART_ICE||this.once(st.ABORT_P2P_EXECUTION,()=>{K(new Ce(Z.DISCONNECT_P2P))})});if(this.connectionState!==an.CONNECTING&&this.connectionState!==an.RECONNECTING||t===qe.JOIN||t===qe.REJOIN||await v(),this.websocket.sendMessage(f,!0),l)return;let y=new Pe((J,K)=>{let q=!1,te=(he,Ue)=>{q=!0,J({isSuccess:he==="success",message:Ue||{}}),this.off(st.WS_CLOSED,de),this.off(st.WS_RECONNECTING,de),this.emit(st.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(p),te);let de=()=>{K(new Ce(Z.WS_ABORT,"type: ".concat(t))),this.off(st.WS_CLOSED,de),this.off(st.WS_RECONNECTING,de),this.off("res-@".concat(p),te)};this.once(st.WS_CLOSED,de),this.once(st.WS_RECONNECTING,de),Qr(ce("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==g||q||(x.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(st.REQUEST_TIMEOUT,t,i))})}),I=null;try{I=await y}catch(J){if(this.connectionState===an.CLOSED||t===qe.LEAVE)throw new Ce(Z.WS_ABORT);return!this.spec.forceWaitGatewayResponse||a?J.throw():t===qe.JOIN||t===qe.REJOIN?null:(await v(),await this.request(t,i))}if(I.isSuccess)return I.message;let b=Number(I.message.error_code||I.message.code),k=Mp(b),U=new Ce(Z.UNEXPECTED_RESPONSE,"".concat(k.desc,": ").concat(I.message.error_str),{code:b,data:I.message});return k.action==="success"?I.message:(x.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(b,", message: ").concat(k.desc,", action: ").concat(k.action)),b===Qe.ERR_TOO_MANY_BROADCASTERS?((t===qe.JOIN||t===qe.REJOIN)&&(this.initError=U,this.close()),U.throw()):k.action==="failed"?U.throw():k.action==="quit"?(this.initError=U,this.close(),U.throw()):(b===Qe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=I.message.option,x.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",pr.MULTI_IP)):this.reconnect(k.action,pr.SERVER_ERROR),t===qe.JOIN||t===qe.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new Pe(a=>{let l=p=>{(!i||i(p))&&(this.off(t,l),a(p))};this.on(t,l)})}uploadWRTCStats(t){if(!this.store.sessionId)return void x.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Li.WRTC_STATS,i)}upload(t,i){let a={_type:t,_message:i};try{this.websocket.sendMessage(a)}catch{let l=ce("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(a),this.uploadCache.length>l&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==an.CONNECTED)return;let p=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(p._type,p._message)},ce("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){let a={_type:t,_message:i};this.websocket.sendMessage(a)}init(t,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Pe((a,l)=>{this.once(st.WS_CONNECTED,()=>a(this.joinResponse)),this.once(st.WS_CLOSED,()=>l(this.initError||new Ce(Z.WS_ABORT))),this.connectionState=an.CONNECTING,this.websocket.init(t).catch(l),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||dn.LEAVE,this.connectionState=an.CLOSED,x.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===dn.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Eg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,ce("JOIN_GATEWAY_USE_DUAL_DOMAIN"),ce("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(st.ABORT_P2P_EXECUTION);let t=await In(this,st.REQUEST_JOIN_INFO),i=await this.request(qe.JOIN,t);if(!i)return this.emit(st.REPORT_JOIN_GATEWAY,mh.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(st.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=an.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Ce(Z.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let t=ih(this,st.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;let i=await this.request(qe.REJOIN,t);return!!i&&(this.connectionState=an.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(a=>{this.emit(Ut.ON_USER_ONLINE,{uid:a.uid}),a.audio&&this.emit(Ut.ON_ADD_AUDIO_STREAM,{uid:a.uid,uint_id:a.uint_id,audio:!0,ssrcId:a.audio_ssrc}),a.video&&this.emit(Ut.ON_ADD_VIDEO_STREAM,{uid:a.uid,uint_id:a.uint_id,video:!0,ssrcId:a.video_ssrc}),a.audio_mute?this.emit(Ut.MUTE_AUDIO,{uid:a.uid}):this.emit(Ut.UNMUTE_AUDIO,{uid:a.uid}),a.video_mute?this.emit(Ut.MUTE_VIDEO,{uid:a.uid}):this.emit(Ut.UNMUTE_VIDEO,{uid:a.uid}),a.audio_enable_local?this.emit(Ut.ENABLE_LOCAL_AUDIO,{uid:a.uid}):this.emit(Ut.DISABLE_LOCAL_AUDIO,{uid:a.uid}),a.video_enable_local?this.emit(Ut.ENABLE_LOCAL_VIDEO,{uid:a.uid}):this.emit(Ut.DISABLE_LOCAL_VIDEO,{uid:a.uid}),a.audio||a.video||this.emit(Ut.ON_REMOVE_STREAM,{uid:a.uid,uint_id:a.uint_id})}),!0)}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}handleNotification(t){x.debug("[".concat(this.clientId,"] receive notification: "),t);let i=Mp(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(dn.UID_BANNED),void this.close()):void this.reconnect(i.action,pr.SERVER_ERROR);x.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let t=ce("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(x.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>ce("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",pr.TIMEOUT):this.request(qe.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let a=Date.now()-i;this.rttRolling.add(a),ce("REPORT_STATS")&&this.send(qe.PING_BACK,{pingpongElapse:a})}).catch(a=>{})}handleWsInflateData(){let{wsInflateLength:t,wsDeflateLength:i}=this.websocket.getWsInflateData();t!==0&&i!==0&&this.upload(Li.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(xt.RECONNECT_WAITTING_FINISH,t=>{this.emit(st.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(xt.RECONNECT_CREATE_CONNECTION,t=>{this.emit(st.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(xt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(xt.CLOSED,()=>{this.connectionState=an.CLOSED}),this.websocket.on(xt.FAILED,()=>{this._disconnectedReason=dn.NETWORK_ERROR,this.connectionState=an.CLOSED}),this.websocket.on(xt.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===an.CONNECTED?this.connectionState=an.RECONNECTING:this.connectionState=an.CONNECTING}),this.websocket.on(xt.WILL_RECONNECT,(t,i,a)=>{let l=ih(this,st.IS_P2P_DISCONNECTED),p=l||t!=="retry";l&&t==="retry"&&(x.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",i=mh.P2P_DISCONNECTED),p&&(x.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(st.REPORT_JOIN_GATEWAY,i||mh.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(st.NEED_RENEW_SESSION),this.emit(st.DISCONNECT_P2P)),a(t)}),this.websocket.on(xt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{x.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",pr.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(st.REPORT_JOIN_GATEWAY,t.message||t.code||mh.UNKNOWN_REASON,this.url||""),t instanceof Ce&&t.code===Z.UNEXPECTED_RESPONSE&&t.data.code===Qe.ERR_NO_AUTHORIZED)return x.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",pr.SERVER_ERROR);x.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",pr.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(xt.REQUEST_NEW_URLS,(t,i)=>{In(this,st.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(xt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var hP=`	
\v\f\r                　\u2028\u2029\uFEFF`,qB=Ul,Vw=Bs,Fw=hP,pP=ae("".replace),JB=RegExp("^["+Fw+"]+"),mP=RegExp("(^|[^"+Fw+"])["+Fw+"]+$"),jw=function(s){return function(t){var i=Vw(qB(t));return 1&s&&(i=pP(i,JB,"")),2&s&&(i=pP(i,mP,"$1")),i}},ts={start:jw(1),end:jw(2),trim:jw(3)},pc=DI.PROPER,XB=O,fP=hP,QB=ts.trim;Xt({target:"String",proto:!0,forced:function(s){return XB(function(){return!!fP[s]()||"​᠎"[s]()!=="​᠎"||pc&&fP[s].name!==s})}("trim")},{trim:function(){return QB(this)}});var Or,ua,_P=sa("String").trim,rC=ge,_h=_P,sC=String.prototype,Yo=A(function(s){var t=s.trim;return typeof s=="string"||s===sC||rC(sC,s)&&t===sC.trim?_h:t});function Bw(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function gg(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Bw(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Bw(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function hl(s){return s.match(/^[\.\:\d]+$/)?"".concat(s.replace(/[^\d]/g,"-"),".").concat(ce("TURN_DOMAIN")):(x.info("Unidentified as ip: ".concat(s,", use as host")),s)}function EP(s,t){s.addresses||(s.addresses=[]);let i=function(p,f){if(ce("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return p.map(y=>{let{ip:I,port:b}=y;return{address:"".concat(I,":").concat(b)}});let g=ce("GATEWAY_DOMAINS"),v=g[1]&&xe(f).call(f,g[1])?1:0;return p.map(y=>{let{domain_prefix:I,port:b,ip:k}=y;if(I)return{address:"".concat(I,".").concat(g[v++%g.length],":").concat(b)};let U=/^[\.\:\d]+$/.test(k),J=U?"".concat(k.replace(/[^\d]/g,"-"),".").concat(g[v++%g.length],":").concat(b):"".concat(k,":").concat(b);return U||x.info("Unidentified as ip: ".concat(k,", use as host")),{ip:k,port:b,address:J}})}(s.addresses,t),a=Array.isArray(s.detail)&&s.detail[18];if(a&&typeof a=="string"){let p=a.split(";");for(let f=0;f<p.length;f++){var l;let g=Yo(l=p[f]).call(l);i[f]&&g&&(i[f].ip6=g)}}return{gatewayAddrs:i,uid:s.uid,cid:s.cid,cert:s.cert,vid:s.detail&&s.detail[8],uni_lbs_ip:s.detail&&s.detail[1],res:s,csIp:s.detail&&s.detail[502]}}function zo(s){return typeof s=="number"?s:s.exact||s.ideal||s.max||s.min||0}function du(s){let t=s._encoderConfig;if(!t)return{};let i={resolution:t.width&&t.height?"".concat(zo(t.width),"x").concat(zo(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function Gw(s){return s>=0&&s<.17?1:s>=.17&&s<.36?2:s>=.36&&s<.59?3:s>=.59&&s<=1?4:s>1?5:0}function Ww(s,t){let i,a,l;switch(t){case Or.CHOOSE_SERVER:a=4096,l="choose server";break;case Or.CLOUD_PROXY:a=1048576,l="proxy";break;case Or.CLOUD_PROXY_5:a=4194304,l="proxy5";break;case Or.CLOUD_PROXY_FALLBACK:a=4194310,l="proxy fallback";break;default:throw new Ce(Z.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:s.detail&&s.detail[502],retry:!1})}if(s.response_body.forEach(p=>{p.buffer&&p.buffer.flag===a&&(i={code:p.buffer.code,addresses:(p.buffer.edges_services||[]).map(f=>gg(gg({},f),{},{ticket:p.buffer.cert})),server_ts:s.enter_ts,uid:p.buffer.uid,cid:p.buffer.cid,cname:p.buffer.cname,detail:gg(gg({},p.buffer.detail),s.detail),flag:p.buffer.flag,opid:s.opid,cert:p.buffer.cert})}),!i)throw new Ce(Z.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(l," from multi unilbs response"),{csIp:s.detail&&s.detail[502]});return i}async function ZB(s,t){return await Pe.all(s.addresses.map(async i=>({address:hl(i.ip),tcpport:i.port,udpport:i.port,username:t&&ce("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():Gi.username,password:t&&ce("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await PT(t.toString()):Gi.password})))}function oC(s,t){let i=t._videoHeight||t.getMediaStreamTrack(!0).getSettings().height;return i?Math.max(i/zo(s.height),1):(x.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function qo(s){let{candidateType:t,relayProtocol:i,type:a,address:l,port:p,protocol:f}=s;return a==="local-candidate"?{candidateType:t,relayProtocol:i,protocol:f}:{candidateType:t,relayProtocol:i,address:l,port:p,protocol:f}}function Eh(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}(function(s){s[s.CHOOSE_SERVER=11]="CHOOSE_SERVER",s[s.CLOUD_PROXY=18]="CLOUD_PROXY",s[s.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",s[s.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"})(Or||(Or={}));class gP extends ri{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var i;xe(i=["tryNext","recover"]).call(i,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(mi.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(mi.CONNECTED):this._state==="closed"?this.emit(mi.CLOSED):this._state==="failed"&&this.emit(mi.FAILED))}constructor(t,i,a,l){super(),P(this,"connectionID",0),P(this,"currentURLIndex",0),P(this,"reconnectReason",void 0),P(this,"_reconnectMode","tryNext"),P(this,"_name",void 0),P(this,"_state","closed"),P(this,"_retryConfig",void 0),P(this,"_reconnectCount",0),P(this,"_forceCloseTimeout",5e3),P(this,"_onlineReconnectListener",void 0),P(this,"_closeEstablishingTransmitter",()=>{}),P(this,"_store",void 0),P(this,"_joinChannelServiceRecordIndex",void 0),P(this,"_useCompress",void 0),P(this,"_inflateLength",0),P(this,"_deflateLength",0),this._store=l,this._name=t,this._retryConfig=function(p){for(var f=1;f<arguments.length;f++){var g=arguments[f]!=null?arguments[f]:{};f%2?Eh(Object(g),!0).forEach(function(v){P(p,v,g[v])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(g)):Eh(Object(g)).forEach(function(v){Object.defineProperty(p,v,Object.getOwnPropertyDescriptor(g,v))})}return p}({},i),this._useCompress=a}resetReconnectCount(t){x.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;let a=this._transmitter;i?setTimeout(()=>a.close(),500):a.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,i){if(!this._transmitter)return void x.warning("[".concat(this._name,"] can not reconnect, no websocket"));var a;t!==void 0&&(this.reconnectMode=t),x.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((a=this._store)===null||a===void 0||a.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));let l=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),l&&l.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){let t=this._inflateLength,i=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:i}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}(function(s){s[s.Default=0]="Default",s[s.Ack=1]="Ack"})(ua||(ua={}));class SP{constructor(t,i,a){P(this,"version",1),P(this,"initialRTO",void 0),P(this,"maxBatchAckCount",void 0),P(this,"maxRTO",void 0),P(this,"initialRTT",void 0),P(this,"ID",void 0),P(this,"rtt",void 0),P(this,"packetNumber",1),P(this,"rtoRatioMap",new Map),P(this,"timeoutMap",new Map),P(this,"unorderedPacketQueue",[]),P(this,"batchAckPacketQueue",[]),P(this,"lastOrderedPacketNumber",0),P(this,"batchAckTimer",void 0),P(this,"sendImpl",void 0),P(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=i,this.ID=si(7,"transmitter-"),this.initialRTO=(a==null?void 0:a.initialRTO)!==void 0?a.initialRTO:ce("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(a==null?void 0:a.initialRTT)!==void 0?a.initialRTT:ce("TRANSMITTER_INITIAL_RTT"),this.rtt=(a==null?void 0:a.initialRTT)!==void 0?a.initialRTT:ce("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(a==null?void 0:a.maxBatchAckCount)!==void 0?a.maxBatchAckCount:ce("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(a==null?void 0:a.maxRTO)!==void 0?a.maxRTO:ce("TRANSMITTER_MAX_RTO")}packetize(t,i){return{type:ua.Default,version:this.version,packetNumber:i,payload:t}}serialize(t){switch(t.type){case ua.Default:{let i;typeof t.payload=="string"?i=new TextEncoder().encode(t.payload):i=t.payload;let a=new ArrayBuffer(i.length+15),l=new DataView(a);return l.setUint16(0,t.version),l.setUint8(2,t.type),l.setUint32(3,t.packetNumber),Jn(l,7,BigInt(t.sendTs)),new Uint8Array(l.buffer).set(i,15),a}case ua.Ack:{let i=new ArrayBuffer(16),a=new DataView(i);return a.setUint16(0,t.version),a.setUint8(2,t.type),a.setUint32(3,t.maxAckPacketNumber),a.setUint8(7,t.shift),Jn(a,8,BigInt(t.ackSendTs)),i}}}deserialize(t){let i=new DataView(t),a=i.getUint16(0),l=i.getUint8(2);switch(l){case ua.Default:{let p=i.getUint32(3),f=Rr(i,7),g=t.slice(15),v=new TextDecoder().decode(g);return{version:a,type:l,packetNumber:p,sendTs:Number(f),payload:v}}case ua.Ack:{let p=i.getUint32(3),f=i.getUint8(7),g=Rr(i,8);return{version:a,type:l,maxAckPacketNumber:p,shift:f,ackSendTs:Number(g)}}default:throw x.error("[".concat(this.ID,"] Unrecognized packet type ").concat(l)),new Error("Unrecognized packet type ".concat(l))}}sendMessage(t){let i=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;let a=this.calculateRTO(i),l=window.setTimeout(()=>{this.resendMessage(i)},a);this.timeoutMap.set(i.packetNumber,l),this.sendPacket(i)}onData(t){let i=this.deserialize(t);i.type===ua.Default?this.ack(i):i.type===ua.Ack&&(this.updateRTT(i,Math.round(performance.now())),this.clearRTO(i))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[i,a]=t;window.clearTimeout(a)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){let i=this.calculateRTO(t),a=window.setTimeout(()=>{this.resendMessage(t)},i);this.timeoutMap.set(t.packetNumber,a),this.sendPacket(t)}calculateRTO(t){let i=this.rtoRatioMap.get(t.packetNumber);if(i===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{let a=9*this.rtt/8*i;return this.rtoRatioMap.set(t.packetNumber,i+1),a>this.maxRTO?this.maxRTO:a}}updateRTT(t,i){let a=t.ackSendTs;this.rtt=this.rtt*(7/8)+(i-a-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){let i=this.unorderedPacketQueue[0];if(!i){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(i.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){let i={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:ua.Ack,version:this.version};this.sendPacket(i)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;let i={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:ua.Ack,version:this.version};this.sendPacket(i)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;let t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:ua.Ack,version:this.version};this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===ua.Default&&(t.sendTs=Math.round(performance.now()));let i=this.serialize(t);this.sendImpl(i)}clearRTO(t){for(let i=t.maxAckPacketNumber-t.shift;i<=t.maxAckPacketNumber;i++){let a=this.timeoutMap.get(i);a!==void 0&&window.clearTimeout(a),this.timeoutMap.delete(i),this.rtoRatioMap.delete(i)}}}class mc extends gP{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),P(this,"_initMutex",void 0),P(this,"_reconnectInterrupter",void 0),P(this,"_url",void 0),P(this,"_transmitter",void 0),P(this,"_addresses",void 0),P(this,"_reliableTransmission",void 0),this._initMutex=new sn("datachannel");let{timeout:a,timeoutFactor:l}=i,p=Math.max(300,Math.floor(3*a/5)),f=Math.max(1.2,Math.floor(8*l)/10);Ws.ONLINE&&(this._retryConfig.timeout=p,this._retryConfig.timeoutFactor=f),Bi.on(Si.NETWORK_STATE_CHANGE,(g,v)=>{g!==v&&(this.resetReconnectCount("network state change: ".concat(v," -> ").concat(g)),g===Ws.ONLINE?(this._retryConfig.timeout=p,this._retryConfig.timeoutFactor=f):(this._retryConfig.timeout=a,this._retryConfig.timeoutFactor=l))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=i;let a=(l,p)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(g=>g.fingerprint||ce("FINGERPRINT"));let f=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(f).then(l).catch(p),this.once(mi.CLOSED,()=>p(new Ce(Z.WS_DISCONNECT))),this.once(mi.CONNECTED,()=>l())};return this._initMutex.lock().then(l=>new Pe((p,f)=>{a(p,f)}).then(()=>{l()}).catch(()=>{l()}))}sendMessage(t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new Ce(Z.WS_ABORT,"datachannel is not ready");try{i||(t=JSON.stringify(t)),this._reliableTransmission.sendMessage(t)}catch(a){throw new Ce(Z.WS_ERR,"send datachannel signal message error"+a.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){let i=JSON.stringify(t);return{compressed:i,compressedLength:i.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new Pe((i,a)=>{var l;let p=()=>{x.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},f=async I=>{var b;if((b=this._closeEstablishingTransmitter)===null||b===void 0||b.call(this),x.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(I.code,", reason: ").concat(I.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=I.reason,this.state="reconnecting");let k=us(this,mi.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,U=await this.reconnectWithAction(k);if(this.state==="closed")return void x.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!U)return a(new Ce(Z.WS_DISCONNECT,"datachannel reconnect failed: ".concat(I.code))),void this.close(!0);i()}else a(new Ce(Z.WS_DISCONNECT,"datachannel close: ".concat(I.code))),this.close()},g=I=>{var b;(b=this._reliableTransmission)===null||b===void 0||b.onData(I.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),x.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));let v=(l=this._store)===null||l===void 0?void 0:l.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),y=Date.now();In(this,mi.TO_CONNECT_DATACHANNEL,t).then(I=>{var b,k;if(!I)throw new Error("transmissonInfo not exist yet");let{transmitter:U,close:J}=I;this._transmitter=U,(b=this._store)===null||b===void 0||b.signalChannelOpen();let K=Date.now()-y;x.debug("[choose dc] dc open cost ".concat(K,"ms")),this._reliableTransmission=new SP(q=>{var te;this._transmitter&&this._transmitter.readyState==="open"&&((te=this._transmitter)===null||te===void 0||te.send(q))},q=>{typeof q=="string"&&this.emit(mi.ON_MESSAGE,q)}),this._closeEstablishingTransmitter=()=>{var q;(q=this._reliableTransmission)===null||q===void 0||q.close(),this._reliableTransmission=void 0,J()},p&&p(),U.onclose=f,U.onmessage=g,(k=this._store)===null||k===void 0||k.recordJoinChannelService({endTs:Date.now(),status:"success"},v),this._joinChannelServiceRecordIndex=v}).catch(I=>{var b;if((b=this._store)===null||b===void 0||b.recordJoinChannelService({endTs:Date.now(),status:I instanceof Ce&&I.code===Z.WS_ABORT?"aborted":"error",errors:[I]},v),this.state!=="closed"){if(I instanceof Ce&&I.code===Z.WS_ERR){let k=new Ce(Z.WS_ERR,"init datachannel failed! Error: ".concat(I.toString()));return x.error("[".concat(this._name,"]").concat(k)),void a(k)}f&&f(I)}else a(new Ce(Z.WS_DISCONNECT,"datachannel is closed: ".concat(I.toString())))})})}async reconnectWithAction(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Bi.networkState!==Ws.OFFLINE||(this._onlineReconnectListener=Bi.onlineWaiter&&Bi.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let a=!0;if(this._reconnectInterrupter=()=>{a=!1},i){let g=eu(this._reconnectCount,this._retryConfig);x.debug("[".concat(this._name,"] wait ").concat(g,"ms to reconnect datachannel, mode: ").concat(t)),await Pe.race([Qr(g),this._onlineReconnectListener||new Pe(()=>{})])}if(this.state==="closed"||!a)return!1;this._reconnectCount+=1;let l=async(g,v)=>{this.emit(mi.RECONNECT_CREATE_CONNECTION,v),await this.createTransmitterConnection(g)};try{if(t==="retry"){let g=this._addresses[this.currentURLIndex];this.emit(mi.RECONNECT_WAITTING_FINISH,t),await l(g,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let v=this.currentURLIndex;v<this._addresses.length;v++){if(this._addresses[v].fingerprint||ce("FINGERPRINT")){this.currentURLIndex=v;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return x.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);x.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));let g=this._addresses[this.currentURLIndex];this.emit(mi.RECONNECT_WAITTING_FINISH,t),await l(g,t)}else t==="recover"&&(x.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(mi.RECONNECT_WAITTING_FINISH,t),this.emit(mi.FAILBACK));return!0}catch(g){var p,f;return x.error("[".concat(this._name,"] reconnect failed"),g.toString()),g!=null&&(p=g.data)!==null&&p!==void 0&&p.desc&&Array.isArray(g.data.desc)&&g.data.desc.length&&xe(f=g.data.desc).call(f,"dynamic key expired")?(this.emit(mi.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,i)}}}class Nd extends ri{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===an.CONNECTED?this.emit(st.WS_CONNECTED):t===an.RECONNECTING?this.emit(st.WS_RECONNECTING,this._websocketReconnectReason):t===an.CLOSED&&this.emit(st.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),P(this,"_disconnectedReason",void 0),P(this,"_websocketReconnectReason",void 0),P(this,"_connectionState",an.CLOSED),P(this,"reconnectToken",void 0),P(this,"websocket",void 0),P(this,"openConnectionTime",void 0),P(this,"clientId",void 0),P(this,"lastMsgTime",Date.now()),P(this,"uploadCache",[]),P(this,"uploadCacheInterval",void 0),P(this,"rttRolling",new tg(5)),P(this,"pingpongTimer",void 0),P(this,"inflateDataTimer",void 0),P(this,"pingpongTimeoutCount",0),P(this,"joinResponse",void 0),P(this,"multiIpOption",void 0),P(this,"initError",void 0),P(this,"spec",void 0),P(this,"store",void 0),P(this,"onWebsocketMessage",a=>{if(a instanceof ArrayBuffer)return void this.emit(st.ON_BINARY_DATA,a);let l=JSON.parse(a);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(l,"_id")){let p="res-@".concat(l._id);this.emit(p,l._result,l._message)}else if(Object.prototype.hasOwnProperty.call(l,"_type")&&(this.emit(l._type,l._message),l._type===Ut.ON_NOTIFICATION&&this.handleNotification(l._message),l._type===Ut.ON_USER_BANNED))switch(l._message.error_code){case 14:this.close(dn.UID_BANNED);break;case 15:this.close(dn.IP_BANNED);break;case 16:this.close(dn.CHANNEL_BANNED)}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new mc("gateway-".concat(this.clientId),this.spec.retryConfig,!0,i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===an.CONNECTED&&this.reconnect("retry",Rs.OFFLINE)})}async request(t,i,a,l){let p=si(6,""),f={_id:p,_type:t,_message:i},g=this.websocket.connectionID,v=()=>new Pe((J,K)=>{if(this.connectionState===an.CONNECTED)return J();let q=()=>{this.off(st.WS_CLOSED,te),J()},te=()=>{this.off(st.WS_CONNECTED,q),K(new Ce(Z.WS_ABORT))};this.once(st.WS_CONNECTED,q),this.once(st.WS_CLOSED,te),t!==qe.PUBLISH&&t!==qe.SUBSCRIBE&&t!==qe.UNSUBSCRIBE&&t!==qe.UNPUBLISH&&t!==qe.CONTROL&&t!==qe.RESTART_ICE||this.once(st.DISCONNECT_P2P,()=>{K(new Ce(Z.DISCONNECT_P2P))}),t!==qe.PUBLISH&&t!==qe.RESTART_ICE||this.once(st.ABORT_P2P_EXECUTION,()=>{K(new Ce(Z.DISCONNECT_P2P))})});if(this.connectionState!==an.CONNECTING&&this.connectionState!==an.RECONNECTING||t===qe.JOIN||t===qe.REJOIN||await v(),t===qe.LEAVE&&(this.websocket.unbindDcCloseEventListener(),l=!0),this.websocket.sendMessage(f,!0,!1),l)return;let y=new Pe((J,K)=>{let q=!1,te=(he,Ue)=>{q=!0,J({isSuccess:he==="success",message:Ue||{}}),this.off(st.WS_CLOSED,de),this.off(st.WS_RECONNECTING,de),this.emit(st.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(p),te);let de=()=>{K(new Ce(Z.WS_ABORT,"type: ".concat(t))),this.off(st.WS_CLOSED,de),this.off(st.WS_RECONNECTING,de),this.off("res-@".concat(p),te)};this.once(st.WS_CLOSED,de),this.once(st.WS_RECONNECTING,de),Qr(ce("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==g||q||(x.warning("dc request timeout, type: ".concat(t)),this.emit(st.REQUEST_TIMEOUT,t,i))})}),I=null;try{I=await y}catch(J){if(this.connectionState===an.CLOSED||t===qe.LEAVE)throw new Ce(Z.WS_ABORT);return!this.spec.forceWaitGatewayResponse||a?J.throw():t===qe.JOIN||t===qe.REJOIN?null:(await v(),await this.request(t,i))}if(I.isSuccess)return I.message;let b=Number(I.message.error_code||I.message.code),k=Mp(b),U=new Ce(Z.UNEXPECTED_RESPONSE,"".concat(k.desc,": ").concat(I.message.error_str),{code:b,data:I.message});return k.action==="success"?I.message:(x.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(b,", message: ").concat(k.desc,", action: ").concat(k.action)),b===Qe.ERR_TOO_MANY_BROADCASTERS?((t===qe.JOIN||t===qe.REJOIN)&&(this.initError=U,this.close()),U.throw()):k.action==="failed"?U.throw():k.action==="quit"?(this.initError=U,this.close(),U.throw()):(b===Qe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=I.message.option,x.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Rs.MULTI_IP)):this.reconnect(k.action,Rs.SERVER_ERROR),t===qe.JOIN||t===qe.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new Pe(a=>{let l=p=>{(!i||i(p))&&(this.off(t,l),a(p))};this.on(t,l)})}uploadWRTCStats(t){if(!this.store.sessionId)return void x.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Li.WRTC_STATS,i)}upload(t,i){let a={_type:t,_message:i};try{this.websocket.sendMessage(a)}catch{let l=ce("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(a),this.uploadCache.length>l&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==an.CONNECTED)return;let p=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(p._type,p._message)},ce("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){let a={_type:t,_message:i};this.websocket.sendMessage(a)}init(t,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Pe((a,l)=>{this.once(st.WS_CONNECTED,()=>a(this.joinResponse)),this.once(st.WS_CLOSED,()=>l(this.initError||new Ce(Z.WS_ABORT))),this.connectionState=an.CONNECTING,this.websocket.init(t).catch(l),this.websocket.once(mi.FAILBACK,()=>{this.openConnectionTime===void 0&&l(new Ce(Z.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{i&&this.openConnectionTime===void 0&&(x.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),l(new Ce(Z.INIT_DATACHANNEL_TIMEOUT)))},ce("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||dn.LEAVE,this.connectionState=an.CLOSED,x.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===dn.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new mc("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(st.ABORT_P2P_EXECUTION);let t=await In(this,st.DATACHANNEL_CONNECTING),i=await this.request(qe.JOIN,t);if(!i)return this.emit(st.REPORT_JOIN_GATEWAY,Z.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(st.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=an.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Ce(Z.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let t=ih(this,st.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;let i=await this.request(qe.REJOIN,t);return!!i&&(this.connectionState=an.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(a=>{this.emit(Ut.ON_USER_ONLINE,{uid:a.uid}),a.audio&&this.emit(Ut.ON_ADD_AUDIO_STREAM,{uid:a.uid,uint_id:a.uint_id,audio:!0,ssrcId:a.audio_ssrc}),a.video&&this.emit(Ut.ON_ADD_VIDEO_STREAM,{uid:a.uid,uint_id:a.uint_id,video:!0,ssrcId:a.video_ssrc}),a.audio_mute?this.emit(Ut.MUTE_AUDIO,{uid:a.uid}):this.emit(Ut.UNMUTE_AUDIO,{uid:a.uid}),a.video_mute?this.emit(Ut.MUTE_VIDEO,{uid:a.uid}):this.emit(Ut.UNMUTE_VIDEO,{uid:a.uid}),a.audio_enable_local?this.emit(Ut.ENABLE_LOCAL_AUDIO,{uid:a.uid}):this.emit(Ut.DISABLE_LOCAL_AUDIO,{uid:a.uid}),a.video_enable_local?this.emit(Ut.ENABLE_LOCAL_VIDEO,{uid:a.uid}):this.emit(Ut.DISABLE_LOCAL_VIDEO,{uid:a.uid}),a.audio||a.video||this.emit(Ut.ON_REMOVE_STREAM,{uid:a.uid,uint_id:a.uint_id})}),!0)}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}handleNotification(t){x.debug("[".concat(this.clientId,"] receive notification: "),t);let i=Mp(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(dn.UID_BANNED),void this.close()):void this.reconnect(i.action,Rs.SERVER_ERROR);x.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let t=ce("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(x.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>ce("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Rs.TIMEOUT):this.request(qe.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let a=Date.now()-i;this.rttRolling.add(a),ce("REPORT_STATS")&&this.send(qe.PING_BACK,{pingpongElapse:a})}).catch(a=>{})}handleInflateData(){let{inflateLength:t,deflateLength:i}=this.websocket.getInflateData();t!==0&&i!==0&&this.upload(Li.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(mi.RECONNECT_WAITTING_FINISH,t=>{this.emit(st.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(mi.RECONNECT_CREATE_CONNECTION,t=>{this.emit(st.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(mi.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(mi.CLOSED,()=>{this.connectionState=an.CLOSED}),this.websocket.on(mi.FAILED,()=>{this._disconnectedReason=dn.NETWORK_ERROR,this.connectionState=an.CLOSED}),this.websocket.on(mi.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===an.CONNECTED?this.connectionState=an.RECONNECTING:this.connectionState=an.CONNECTING}),this.websocket.on(mi.WILL_RECONNECT,(t,i)=>{if(ih(this,st.IS_P2P_DISCONNECTED)&&t==="retry")return x.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(st.NEED_RENEW_SESSION),this.emit(st.DISCONNECT_P2P),i("tryNext");t!=="retry"&&(x.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(st.NEED_RENEW_SESSION),this.emit(st.DISCONNECT_P2P)),i(t)}),this.websocket.on(mi.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{x.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Rs.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(st.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof Ce&&t.code===Z.UNEXPECTED_RESPONSE&&t.data.code===Qe.ERR_NO_AUTHORIZED)return x.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Rs.SERVER_ERROR);x.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Rs.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(mi.REQUEST_NEW_URLS,(t,i)=>{In(this,st.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(mi.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(mi.TO_CONNECT_DATACHANNEL,async(t,i,a)=>In(this,st.DATACHANNEL_PRECONNECT,t).then(i).catch(a)),this.websocket.on(mi.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(st.DATACHANNEL_FAILBACK)})}}class xp extends ri{constructor(t,i){super(),P(this,"signal",void 0),P(this,"token",void 0),P(this,"tokenTimeout",void 0),P(this,"tokenInterval",void 0),P(this,"_sequence",0),P(this,"userMap",new Map),P(this,"encoder",new TextEncoder),this.signal=t,this.token=i;let a=()=>{this.signal.connectionState===an.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(a,1e3):this.tokenInterval=window.setTimeout(a,3*ce("P2P_TOKEN_INTERVAL"))};a()}async send(t,i,a,l,p){var f,g,v;if(this.userMap.size===0)return;let y=Array.from(hc(f=this.userMap).call(f))[0].token;typeof i!="string"&&(i=JSON.stringify(i)),l=(g=l)!==null&&g!==void 0?g:si(6,""),p=(v=p)!==null&&v!==void 0?v:this._sequence++;let I={_id:l,_type:t,_seq:p,_message:i,token:"".concat(this.token,"_").concat(y)};ce("SHOW_P2P_LOG")&&x.debug("send message",I,"noNeedResponse : ".concat(a)),this.splitMessage(JSON.stringify(I)).forEach(k=>{this.signal.request(qe.DATA_STREAM,{payload:Zm(this.encoder.encode(k))})});let b=new Pe((k,U)=>{let J=window.setTimeout(()=>{this.off("res-@".concat(l,"_ack"),K),this.off("res-@".concat(l),te),this.off(Od.ABORT,q),x.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(l)),this.userMap.size===0?U(new Ve(Z.INVALID_REMOTE_USER)):U(new Ve(Z.TIMEOUT))},ce("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),K=()=>{J&&window.clearTimeout(J),this.off(Od.ABORT,q),a&&k()},q=()=>{J&&window.clearTimeout(J),this.off("res-@".concat(l,"_ack"),K),this.off("res-@".concat(l),te),U(new Ve(Z.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(l)))};this.once(Od.ABORT,q),this.once("res-@".concat(l,"_ack"),K);let te=(he,Ue)=>{de=!0,J&&window.clearTimeout(J),this.off("res-@".concat(l,"_ack"),K),this.off(Od.ABORT,q),he==="success"?k(Ue):U(new Ve(Z.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(l)))},de=!1;a||(this.once("res-@".concat(l),te),Qr(ce("SIGNAL_REQUEST_TIMEOUT")).then(()=>{de||x.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(l,", ").concat(I))}))});try{return await b}catch(k){if(k.code===Z.TIMEOUT)return await this.send(t,i,a,l,p);throw k}}onMessage(t){var i;let{_uid:a}=t,l,p=this.userMap.get(a);if(p)l=p.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==Hi.CHECK)return;let{token:y}=t;l=new Map,p={uid:a,isStart:!0,token:y,splitMessageMap:l,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(a,p),this.signal.emit(Ut.ON_USER_ONLINE,{uid:a}),this.handleUserOnline()}if("id"in t&&"total"in t){var f;let{id:y,total:I}=t,b=(f=l.get(y))!==null&&f!==void 0?f:[];if(b.push(t),l.has(y)||l.set(y,b),b.length!==I)return;{let k=kE(b).call(b,(U,J)=>U.index-J.index).map(U=>U.payload).join("");l.delete(y),(t=JSON.parse(k))._uid=a}}let{_type:g,token:v}=t;if(xe(i=[Hi.ACK,Hi.CHECK]).call(i,g))return g===Hi.CHECK&&this.handleCheckToken(p,v),void this.receiveMessage(t);v==="".concat(p.token,"_").concat(this.token)?this.handleReceivedMessage(t):x.debug('Receive unexpected message", '.concat(v,", cur_token: ").concat(p.token,"_").concat(this.token),t)}check(){let t={_id:si(6,""),token:this.token,_type:Hi.CHECK};ce("SHOW_P2P_LOG")&&x.debug("send message",t),this.signal.request(qe.DATA_STREAM,{payload:Zm(this.encoder.encode(JSON.stringify(t)))})}ack(t){let i={_id:t,_type:Hi.ACK,token:this.token};ce("SHOW_P2P_LOG")&&x.debug("send message",i),this.signal.request(qe.DATA_STREAM,{payload:Zm(this.encoder.encode(JSON.stringify(i)))})}response(t,i,a){this.send(Hi.RESPONSE,JSON.stringify({success:!a,message:i}),!0,t)}handleReceivedMessage(t){let i=()=>{this.userMap.forEach(y=>{let{receivedMessagesMap:I,nextExpectedSequenceNumber:b}=y;for(;I.has(b);){let k=I.get(b);I.delete(b),this.receiveMessage(k),y.nextExpectedSequenceNumber++}})};if(!t)return void i();let{_uid:a,_seq:l}=t,p=this.userMap.get(a),{receivedMessagesMap:f,isStart:g,nextExpectedSequenceNumber:v}=p;if(l<v)return this.ack(t._id),void x.debug("[external-signal] receive old message, seq: ".concat(l,", ").concat(t._message));f.set(l,t),g&&l===v&&(this.receiveMessage(t),f.delete(v),p.nextExpectedSequenceNumber++,i())}receiveMessage(t){let{_id:i,_type:a,_message:l,_uid:p}=t;if(ce("SHOW_P2P_LOG")&&x.debug("receive message",t),i){let f;switch(t._type!==Hi.ACK&&(l&&(f=JSON.parse(l)),this.ack(t._id)),t._type){case Hi.CANDIDATE:case Hi.CONTROL:this.signal.emit(a,f,p);break;case Hi.PUBLISH:case Hi.UNPUBLISH:case Hi.RESTART_ICE:case Hi.CALL:f.uid=p,In(this.signal,a,f).then(g=>{this.response(t._id,g)}).catch(()=>{this.response(t._id,void 0,!0)});break;case Hi.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case Hi.RESPONSE:{let{success:g,message:v}=f;this.emit("res-@".concat(i),g?"success":"failed",v);break}}}}splitMessage(t){if(t.length<xp.MAX_MESSAGE_SIZE)return[t];let i=[],{remoteToken:a}=JSON.parse(t),l=si(6,""),p=0,f=800,g=Math.ceil(t.length/f);for(;t.length>0;){p++;let v={id:l,index:p,total:g,payload:t.slice(0,f),token:"".concat(this.token,"_").concat(a)};JSON.stringify(v).length>xp.MAX_MESSAGE_SIZE?f-=50:(i.push(v),t=t.slice(f))}return i.map(v=>JSON.stringify(v))}handleCheckToken(t,i){return t.token!==i?(x.debug("token changed, from ".concat(t.token," to ").concat(i)),this.reset(t.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{x.debug("token timeout, ".concat(i)),this.reset(t.uid)},ce("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){let t=await In(this.signal,Hi.CALL,void 0),i=await this.send(Hi.CALL,t);this.signal.emit(st.P2P_CONNECTION,i,!0)}async reset(t,i){let a=this.userMap.get(t);a&&(this.emit(Od.ABORT),this.signal.emit(Ut.ON_USER_OFFLINE,{uid:a.uid,reason:kw.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(x.debug("change local token from ".concat(i," to ").concat(i)),this.token=si(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Od.ABORT)}}P(xp,"MAX_SIZE",1),P(xp,"MAX_MESSAGE_SIZE",1024);class Sg extends ri{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===an.CONNECTED?this.emit(st.WS_CONNECTED):t===an.RECONNECTING?this.emit(st.WS_RECONNECTING,this._websocketReconnectReason):t===an.CLOSED&&this.emit(st.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),P(this,"_disconnectedReason",void 0),P(this,"_websocketReconnectReason",void 0),P(this,"_connectionState",an.CLOSED),P(this,"reconnectToken",void 0),P(this,"p2pToken",void 0),P(this,"websocket",void 0),P(this,"openConnectionTime",void 0),P(this,"clientId",void 0),P(this,"lastMsgTime",Date.now()),P(this,"uploadCache",[]),P(this,"uploadCacheInterval",void 0),P(this,"rttRolling",new tg(5)),P(this,"pingpongTimer",void 0),P(this,"pingpongTimeoutCount",0),P(this,"joinResponse",void 0),P(this,"multiIpOption",void 0),P(this,"initError",void 0),P(this,"spec",void 0),P(this,"store",void 0),P(this,"_external_signal",void 0),P(this,"onWebsocketMessage",a=>{if(a.data instanceof ArrayBuffer)return void this.emit(st.ON_BINARY_DATA,a.data);let l=JSON.parse(a.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(l,"_id")){let p="res-@".concat(l._id);this.emit(p,l._result,l._message)}else if(Object.prototype.hasOwnProperty.call(l,"_type")){switch(l._type){case Ut.ON_DATA_STREAM:return void this.handleDataStream(l._message);case Ut.MUTE_AUDIO:case Ut.MUTE_VIDEO:case Ut.ON_P2P_LOST:case Ut.ON_USER_ONLINE:return;case Ut.ON_USER_OFFLINE:let{uid:p}=l._message;return x.debug("[".concat(this.clientId,"] user-offline uid: ").concat(p)),void this._external_signal.reset(p)}if(this.emit(l._type,l._message),l._type===Ut.ON_NOTIFICATION&&this.handleNotification(l._message),l._type===Ut.ON_USER_BANNED)switch(l._message.error_code){case 14:this.close(dn.UID_BANNED);break;case 15:this.close(dn.IP_BANNED);break;case 16:this.close(dn.CHANNEL_BANNED)}if(l._type===Ut.ON_USER_LICENSE_BANNED)switch(l._message.error_code){case Qe.ERR_LICENSE_MISSING:this.close(dn.LICENSE_MISSING);break;case Qe.ERR_LICENSE_EXPIRED:this.close(dn.LICENSE_EXPIRED);break;case Qe.ERR_LICENSE_MINUTES_EXCEEDED:this.close(dn.LICENSE_MINUTES_EXCEEDED);break;case Qe.ERR_LICENSE_PERIOD_INVALID:this.close(dn.LICENSE_PERIOD_INVALID);break;case Qe.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(dn.LICENSE_MULTIPLE_SDK_SERVICE);break;case Qe.ERR_LICENSE_ILLEGAL:this.close(dn.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new Eg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,ce("JOIN_GATEWAY_USE_DUAL_DOMAIN"),ce("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===an.CONNECTED&&this.reconnect("retry",pr.OFFLINE)}),this.p2pToken=si(6,""),this._external_signal=new xp(this,this.p2pToken)}async request(t,i,a,l){let p=si(6,""),f={_id:p,_type:t,_message:i},g=this.websocket.connectionID,v=()=>new Pe((J,K)=>{if(this.connectionState===an.CONNECTED)return J();let q=()=>{this.off(st.WS_CLOSED,te),J()},te=()=>{this.off(st.WS_CONNECTED,q),K(new Ve(Z.WS_ABORT))};this.once(st.WS_CONNECTED,q),this.once(st.WS_CLOSED,te)});if(this.connectionState!==an.CONNECTING&&this.connectionState!==an.RECONNECTING||t===qe.JOIN||t===qe.REJOIN||await v(),this.websocket.sendMessage(f,!0),l)return;let y=new Pe((J,K)=>{let q=!1,te=(he,Ue)=>{q=!0,J({isSuccess:he==="success",message:Ue||{}}),this.off(st.WS_CLOSED,de),this.off(st.WS_RECONNECTING,de),this.emit(st.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(p),te);let de=()=>{K(new Ve(Z.WS_ABORT,"type: ".concat(t))),this.off(st.WS_CLOSED,de),this.off(st.WS_RECONNECTING,de),this.off("res-@".concat(p),te)};this.once(st.WS_CLOSED,de),this.once(st.WS_RECONNECTING,de),Qr(ce("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==g||q||(x.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(st.REQUEST_TIMEOUT,t,i))})}),I=null;try{I=await y}catch(J){if(this.connectionState===an.CLOSED||t===qe.LEAVE)throw new Ve(Z.WS_ABORT);return!this.spec.forceWaitGatewayResponse||a?J.throw():t===qe.JOIN||t===qe.REJOIN?null:(await v(),await this.request(t,i))}if(I.isSuccess)return I.message;let b=Number(I.message.error_code||I.message.code),k=Mp(b),U=new Ve(Z.UNEXPECTED_RESPONSE,"".concat(k.desc,": ").concat(I.message.error_str),{code:b,data:I.message});return k.action==="success"?I.message:(x.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(b,", message: ").concat(k.desc,", action: ").concat(k.action)),b===Qe.ERR_TOO_MANY_BROADCASTERS?((t===qe.JOIN||t===qe.REJOIN)&&(this.initError=U,this.close()),U.throw()):k.action==="failed"?U.throw():k.action==="quit"?(this.initError=U,this.close(),U.throw()):(b===Qe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=I.message.option,x.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",pr.MULTI_IP)):this.reconnect(k.action,pr.SERVER_ERROR),t===qe.JOIN||t===qe.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new Pe(a=>{let l=p=>{(!i||i(p))&&(this.off(t,l),a(p))};this.on(t,l)})}uploadWRTCStats(t){if(!this.store.sessionId)return void x.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Li.WRTC_STATS,i)}upload(t,i){let a={_type:t,_message:i};try{this.websocket.sendMessage(a)}catch{let l=ce("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(a),this.uploadCache.length>l&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==an.CONNECTED)return;let p=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(p._type,p._message)},ce("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){let a={_type:t,_message:i};this.websocket.sendMessage(a)}async sendExtensionMessage(t,i,a){return await this._external_signal.send(t,i,a)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Pe((i,a)=>{this.once(st.WS_CONNECTED,()=>i(this.joinResponse)),this.once(st.WS_CLOSED,()=>a(this.initError||new Ve(Z.WS_ABORT))),this.connectionState=an.CONNECTING,this.websocket.init(t).catch(a)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||dn.LEAVE,this.connectionState=an.CLOSED,x.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===dn.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Eg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,ce("JOIN_GATEWAY_USE_DUAL_DOMAIN"),ce("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=si(6,""),this._external_signal.clear(),this._external_signal=new xp(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(st.ABORT_P2P_EXECUTION);let t=await In(this,st.REQUEST_JOIN_INFO),i=await this.request(qe.JOIN,t);if(!i)return this.emit(st.REPORT_JOIN_GATEWAY,Z.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(st.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=an.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}handleDataStream(t){try{var i;let a=kT(t.payload),l=new TextDecoder().decode(a),p=JSON.parse(l);"total"in p&&"id"in p||xe(i=Object.values(Hi)).call(i,p._type)?(p._uid=t.uid,this._external_signal.onMessage(p)):this.emit(Ut.ON_DATA_STREAM,t)}catch{this.emit(Ut.ON_DATA_STREAM,t)}}handleNotification(t){x.debug("[".concat(this.clientId,"] receive notification: "),t);let i=Mp(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(dn.UID_BANNED),void this.close()):void this.reconnect(i.action,pr.SERVER_ERROR);x.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let t=ce("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(x.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>ce("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",pr.TIMEOUT):this.request(qe.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let a=Date.now()-i;this.rttRolling.add(a),ce("REPORT_STATS")&&this.send(qe.PING_BACK,{pingpongElapse:a})}).catch(a=>{})}handleWebsocketEvents(){this.websocket.on(xt.RECONNECT_WAITTING_FINISH,t=>{this.emit(st.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(xt.RECONNECT_CREATE_CONNECTION,t=>{this.emit(st.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(xt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(xt.CLOSED,()=>{this.connectionState=an.CLOSED}),this.websocket.on(xt.FAILED,()=>{this._disconnectedReason=dn.NETWORK_ERROR,this.connectionState=an.CLOSED}),this.websocket.on(xt.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===an.CONNECTED?this.connectionState=an.RECONNECTING:this.connectionState=an.CONNECTING}),this.websocket.on(xt.WILL_RECONNECT,(t,i,a)=>{t!=="retry"?(x.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(st.NEED_RENEW_SESSION)):x.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),a(t)}),this.websocket.on(xt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit(st.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof Ve&&t.code===Z.UNEXPECTED_RESPONSE&&t.data.code===Qe.ERR_NO_AUTHORIZED)return x.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",pr.SERVER_ERROR);x.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",pr.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(xt.REQUEST_NEW_URLS,(t,i)=>{In(this,st.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(xt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function aC(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function zs(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?aC(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):aC(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}let lf=new Map;class TP extends ri{get state(){return this._state}set state(t){if(t===this._state)return;let i=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(Wi.CONNECTION_STATE_CHANGE,t,i,this._disconnectedReason):this.emit(Wi.CONNECTION_STATE_CHANGE,t,i)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){x.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,i){super(),P(this,"store",void 0),P(this,"joinInfo",void 0),P(this,"key",void 0),P(this,"ntpOffset",0),P(this,"signal",void 0),P(this,"role",void 0),P(this,"inChannelInfo",{joinAt:null,duration:0}),P(this,"spec",void 0),P(this,"_state","DISCONNECTED"),P(this,"_statsCollector",void 0),P(this,"_disconnectedReason",void 0),P(this,"isSignalRecover",!1),P(this,"hasChangeBGPAddress",!1),P(this,"trafficStatsInterval",void 0),P(this,"networkQualityInterval",void 0),P(this,"_joinGatewayStartTime",0),P(this,"_signalTimeout",!1),P(this,"_clientRoleOptions",void 0),P(this,"_isProactiveJoin",!1),this.store=t,this.spec=i,this.signal=this.store.useP2P?new Sg(zs(zs({},i),{},{retryConfig:i.websocketRetryConfig}),t):this.store.useDataChannel?new Nd(zs(zs({},i),{},{retryConfig:i.websocketRetryConfig}),t):new xw(zs(zs({},i),{},{retryConfig:i.websocketRetryConfig}),t),this._statsCollector=i.statsCollector,this.role=i.role||"audience",this._clientRoleOptions=i.clientRoleOptions,this.handleSignalEvents()}async join(t,i,a){if(this.signal instanceof Nd){let v=!1;t.cloudProxyServer!=="disabled"?(x.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),v=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(x.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),v=!0):t.apResponse.addresses.some(y=>y.fingerprint)||ce("FINGERPRINT")||(x.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),v=!0),v&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);let l=Date.now(),p=lf.get(t.cname);if(p||(p=new Map,lf.set(t.cname,p)),this._isProactiveJoin=!0,p.has(t.uid)){let v=new Ce(Z.UID_CONFLICT);throw Tt.joinGateway(t.sid,{lts:l,succ:!1,ec:v.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof Nd?"1":"0"}),this._isProactiveJoin=!1,v}p.set(t.uid,!0),this.joinInfo=t,this.key=i;let f=0;this.joinGatewayStartTime=l;let g=t.proxyServer;try{let v;if(x.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Nd?"datachannel":"websocket"," join uid ").concat(f)),this.signal instanceof Nd)v=await this.signal.init(t.apResponse.addresses,a);else{let y=t.gatewayAddrs.map(I=>{let{address:b}=I,[k,U]=b.split(":"),J={host:k,port:U};return t.proxyServer&&(J.proxy=t.proxyServer),J});v=await this.signal.init(y,a)}f=v.uid,x.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Nd?"datachannel":"websocket"," join uid ").concat(f," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(v){throw v&&v.code===Z.INIT_WEBSOCKET_TIMEOUT?(x.warning("[".concat(this.store.clientId,"] User join failed"),v.toString()),v):v&&v.code===Z.INIT_DATACHANNEL_TIMEOUT?(x.warning("[".concat(this.store.clientId,"] User join datachannel failed"),v.toString()),this.resetSignal(),v):(x.error("[".concat(this.store.clientId,"] User join failed"),v.toString()),Tt.joinGateway(t.sid,{lts:l,succ:!1,ec:v.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!g,signalChannel:this.signal instanceof Nd?"1":"0"}),this._isProactiveJoin=!1,p.delete(t.uid),this.signal.close(),v)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),x.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(v=>{x.warning("[".concat(this.store.clientId,"] get traffic stats error"),v.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Wi.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Wi.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Wi.NETWORK_QUALITY,{uplinkNetworkQuality:Gw(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Gw(this._statsCollector.trafficStats.B_dnq)}):this.emit(Wi.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),f}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){i!==dn.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==an.CONNECTED||await function(a,l){return l===1/0?a:Pe.race([a,FB(l)])}(this.signal.request(qe.LEAVE,void 0,!0),3e3)}catch(a){x.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),a)}this.signal.close(i),i!==dn.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,i,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let l={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:ce("PUB_EXTEND"),twcc:!!ce("PUBLISH_TWCC"),rtx:!!ce("USE_PUB_RTX")};try{return(await this.signal.request(qe.PUBLISH,l,!0))._message}catch(p){if(a&&p.data&&p.data.code===Qe.ERR_PUBLISH_REQUEST_INVALID)return x.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),p.toString()),await this.tryUnpubBeforeRepub(t,i),this.publish(t,i,!1);throw p}}async publishDataChannel(t,i,a){var l;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let p={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:(l=i.maxRetransmits)!==null&&l!==void 0?l:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(qe.PUBLISH_DATASTREAM,p,!0)}catch(f){if(a&&f.data&&f.data.code===Qe.ERR_PUBLISH_REQUEST_INVALID)return x.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),f.toString()),await this.tryUnpubDataChannelBeforeRepub(t,i),this.publishDataChannel(t,i,!1);throw f}}async unpublish(t,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(qe.UNPUBLISH,{stream_id:i,ortc:t},!0)}catch(a){x.warning("[".concat(this.store.clientId,"] unpublish warning: "),a)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Pe.all(t.map(i=>this.signal.request(qe.UNPUBLISH_DATASTREAM,{channel_id:i},!0)))}catch(i){x.warning("unpublish datachannels warning: ",i)}}async presubscribe(t,i,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));let l={stream_id:t,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!ce("SUBSCRIBE_TWCC"),rtx:!!ce("USE_SUB_RTX")||void 0,extend:ce("SUB_EXTEND"),svc:Array.isArray(ce("SVC"))&&ce("SVC").length!==0?ce("SVC"):void 0};try{return await this.signal.request(qe.PRE_SUBSCRIBE,l,!0)}catch(p){if(a&&p.data&&p.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return x.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),p.toString()),this.presubscribe(t,i,!1);throw p}}async subscribe(t,i,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let l={stream_id:t,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!ce("SUBSCRIBE_TWCC"),rtx:!!ce("USE_SUB_RTX"),extend:ce("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(ce("SVC"))&&ce("SVC").length!==0?ce("SVC"):void 0};try{return(await this.signal.request(qe.SUBSCRIBE,l,!0))._message}catch(p){if(a&&p.data&&p.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return x.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),p.toString()),await this.tryUnsubBeforeResub(t,i),await this.subscribe(t,i,!1);throw p}}async subscribeDataChannel(t,i,a){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let l={uid:t,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(qe.SUBSCRIBE_DATASTREAM,l,!0)}catch(p){if(a&&p.data&&p.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return x.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),p.toString()),await this.tryUnsubDataChannelBeforeResub(t,i),await this.subscribeDataChannel(t,i,!1);throw p}}async subscribeAll(t,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let a={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!ce("USE_SUB_RTX")};try{return await this.signal.request(qe.SUBSCRIBE_STREAMS,a,!0)}catch(l){if(i&&l.data&&l.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return x.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),l.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw l}}async setVideoProfile(t){let i=function(a){if(!(a.bitrateMax&&a.bitrateMin&&a.frameRate&&a.height&&a.width))return;let l=a.frameRate,p=a.width,f=a.height,g=!0;return typeof l!="number"&&(l=l.exact||l.ideal||l.max||l.min||0,l||(g=!1)),typeof p!="number"&&(p=p.exact||p.ideal||p.max||p.min||0,p||(g=!1)),typeof f!="number"&&(f=f.exact||f.ideal||f.max||f.min||0,l||(g=!1)),g?{stream_type:0,width:p,height:f,fps:l,start_bps:1e3*a.bitrateMax,min_bps:1e3*a.bitrateMin,target_bps:1e3*a.bitrateMax}:void 0}(t);if(i)return this.signal.request(qe.SET_VIDEO_PROFILE,i);x.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,i){try{await this.signal.request(qe.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:i},!0)}catch(a){x.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),a)}}async unsubscribeDataChannel(t,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Pe.all(t.map(a=>this.signal.request(qe.UNSUBSCRIBE_DATASTREAM,{stream_id:a,uid:i},!0)))}catch(a){x.warning("unsubscribeDataChannel warning: ",a)}}async massUnsubscribe(t){try{await this.signal.request(qe.UNSUBSCRIBE_STREAMS,t,!0)}catch(i){x.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),i)}}async reconnectPC(t){let{iceParameters:i,dtlsParameters:a,rtpCapabilities:l}=t;return{gatewayEstablishParams:await this.signal.request(qe.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:i,dtlsParameters:a,rtpCapabilities:l}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(qe.GATEWAY_INFO)}async renewToken(t){await this.signal.request(qe.RENEW_TOKEN,t),this.key=t.token}async setClientRole(t,i){if(i&&(this._clientRoleOptions=Object.assign({},i)),this.state!=="CONNECTED")return void(this.role=t);let a,l=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(a=this._clientRoleOptions.delay,l=1):l=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:l=0,await this.signal.request(qe.SET_CLIENT_ROLE,{role:t,level:l,delay:a,client_ts:Date.now()}),this.role=t}async setRemoteVideoStreamType(t,i){await this.signal.request(qe.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:i})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(qe.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,i){await this.signal.request(qe.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:i})}async pickSVCLayer(t,i){await this.signal.request(qe.PICK_SVC_LAYER,{stream_id:t,spatial_layer:i.spatialLayer,temporal_layer:i.temporalLayer})}async setRTM2Flag(t){await this.signal.request(qe.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,i,a){if(this.signal instanceof Sg)return this.signal.sendExtensionMessage(t,i,a)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),zs({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(qe.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let t=lf.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;let t=function(i){let a;return a=i.startsWith("dc")?i.match(/(dc\:\/\/)?([^:]+):(\d+)/):i.match(/(wss\:\/\/)?([^:]+):(\d+)/),a?{username:Gi.username,password:Gi.password,turnServerURL:a[2],tcpport:parseInt(a[3])+30,udpport:parseInt(a[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(zs(zs({},Gi),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;let t=await this.signal.request(qe.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(i=>{let a=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(l=>l.peer_uid===i.peer_uid);a&&a.B_st!==i.B_st&&mo(()=>{this.emit(Wi.STREAM_TYPE_CHANGE,i.peer_uid,i.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){if(!this.joinInfo||!this.key)throw new Ce(Z.UNEXPECTED_ERROR,"can not generate join message, no join info");let i=Object.assign({},this.joinInfo.apResponse),a=ce("REPORT_APP_SCENARIO");if(typeof a!="string")try{a=JSON.stringify(a)}catch{a=void 0}a&&a.length>128&&(a=void 0);let l=zs({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Gt,browser:navigator.userAgent,process_id:ce("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:i,extend:ce("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:a,attributes:{userAttributes:{enablePublishedUserList:ce("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:ce("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof ce("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?ce("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof ce("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?ce("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof ce("ENABLE_USER_LICENSE_CHECK")=="boolean"?ce("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:ce("USE_PUB_RTX")===!0||ce("USE_SUB_RTX")===!0||void 0,disableFEC:ce("DISABLE_FEC"),enableNTPReport:!!ce("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!ce("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof ce("ENABLE_DATASTREAM_2")=="boolean"?ce("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!ce("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof ce("USE_XR")=="boolean"?ce("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(l.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(l.aes_mode=this.joinInfo.aesmode,ce("ENCRYPT_AES")?(l.aes_secret=this.joinInfo.aespassword,l.aes_encrypt=!0):l.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(l.aes_salt=this.joinInfo.aessalt)),i.addresses[this.signal.websocket.currentURLIndex]&&(l.ap_response.ticket=i.addresses[this.signal.websocket.currentURLIndex].ticket,delete i.addresses),this.joinInfo.defaultVideoStream!==void 0&&(l.default_video_stream=this.joinInfo.defaultVideoStream),l}getRejoinMessage(){if(!this.joinInfo)throw new Ce(Z.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(st.WS_RECONNECT_WAITTING_FINISH,t=>{var i;xe(i=["tryNext","recover"]).call(i,t)&&this.joinInfo&&Tt.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(st.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(st.WS_RECONNECTING,t=>{this.joinInfo&&Tt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||pr.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Tt.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(st.WS_CLOSED,t=>{let i;switch(t){case dn.LEAVE:i=pr.LEAVE;break;case dn.UID_BANNED:case dn.IP_BANNED:case dn.CHANNEL_BANNED:case dn.SERVER_ERROR:i=pr.SERVER_ERROR;break;case dn.FALLBACK:i=pr.FALLBACK;break;case dn.LICENSE_MISSING:case dn.LICENSE_EXPIRED:case dn.LICENSE_MINUTES_EXCEEDED:case dn.LICENSE_PERIOD_INVALID:case dn.LICENSE_MULTIPLE_SDK_SERVICE:case dn.LICENSE_ILLEGAL:case dn.TOKEN_EXPIRE:i=t;break;default:i=pr.NETWORK_ERROR}x.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(i||"undefined -> "+pr.NETWORK_ERROR)),this.joinInfo&&Tt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===dn.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=t,t!==dn.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(st.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(x.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),Tt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Nd?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){let t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void x.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));ei("EVENT_REPORT_DOMAIN",t[1]),ei("EVENT_REPORT_BACKUP_DOMAIN",t[1]),ei("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}),this.signal.on(Ut.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on(st.REQUEST_RECOVER,(t,i,a)=>{if(!this.joinInfo)return a(new Ce(Z.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,In(this,Wi.REQUEST_NEW_GATEWAY_LIST).then(i).catch(a)}),this.signal.on(st.REQUEST_JOIN_INFO,async t=>{var i;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));let{iceParameters:a,dtlsParameters:l,rtpCapabilities:p}=await In(this,Wi.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(i=this.joinInfo)===null||i===void 0?void 0:i.turnServer});t(this.getJoinMessage({ortc:{iceParameters:a,dtlsParameters:l,rtpCapabilities:p,version:"2"}}))}),this.signal.on(st.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on(st.REPORT_JOIN_GATEWAY,(t,i)=>{this.joinInfo&&(Tt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:t,addr:i,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Nd?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(st.IS_P2P_DISCONNECTED,t=>{t(ih(this,Wi.IS_P2P_DISCONNECTED))}),this.signal.on(st.DISCONNECT_P2P,()=>{this.emit(Wi.DISCONNECT_P2P)}),this.signal.on(st.NEED_RENEW_SESSION,()=>{this.emit(Wi.NEED_RENEW_SESSION)}),this.signal.on(st.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(st.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(st.JOIN_RESPONSE,t=>{let i=this.getCurrentGatewayAddress();this.emit(Wi.JOIN_RESPONSE,t,i)}),this.signal.on(st.DATACHANNEL_PRECONNECT,async(t,i,a)=>{this.updateTurnConfigFromSignal();let l=this.getCurrentGatewayAddress();return In(this,Wi.DATACHANNEL_PRECONNECT,t,l).then(i).catch(a)}),this.signal.on(st.DATACHANNEL_CONNECTING,async t=>{let{iceParameters:i,dtlsParameters:a,rtpCapabilities:l}=await In(this,Wi.REQUEST_DC_CONNECTION_PARAMS);t(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:a,rtpCapabilities:l,version:"2"}}))}),this.signal.on(st.DATACHANNEL_FAILBACK,()=>{x.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Wi.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,i){try{await this.signal.request(qe.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[i]},!0)}catch(a){throw x.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),a),a}}async tryUnsubDataChannelBeforeResub(t,i){try{await this.signal.request(qe.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(a){throw x.warning("unsubscribe datachannel warning",a),a}}async tryUnpubBeforeRepub(t,i){try{await this.signal.request(qe.UNPUBLISH,{stream_id:t,ortc:i},!0)}catch(a){throw x.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),a),a}}async tryUnpubDataChannelBeforeRepub(t,i){try{await this.signal.request(qe.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(a){throw x.warning("unpublish datastream warning: ",a),a}}async tryMassUnsubBeforeResub(t){let i={users:t.map(a=>({stream_id:a.stream_id,stream_type:a.stream_type}))};try{await this.signal.request(qe.UNSUBSCRIBE_STREAMS,i,!0)}catch(a){throw x.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),a),a}}async muteLocal(t,i){let a={action:t.find(l=>l.stream_type===At.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(qe.CONTROL,a,!0,!0)}catch(l){throw x.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),l),l}}async unmuteLocal(t,i){let a={action:t.find(l=>l.stream_type===At.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(qe.CONTROL,a,!0,!0)}catch(l){throw x.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),l),l}}async muteRemote(t,i){let a={action:t===We.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(qe.CONTROL,a,!0,!0)}catch(l){throw x.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),l),l}}async unmuteRemote(t,i){let a={action:t===We.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(qe.CONTROL,a,!0,!0)}catch(l){throw x.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),l),l}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,i){this.signal.upload(t,i)}getSignalRTT(){return this.signal.rtt}async restartICE(t){let i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(qe.RESTART_ICE,i,!0)}catch(a){throw x.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),a),a}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,pr.P2P_FAILED)}getCurrentGatewayAddress(){var t;if(!ce("GATEWAY_WSS_ADDRESS"))return(t=this.joinInfo)!==null&&t!==void 0&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(qe.SET_PARAMETER,{enablePublishAudioFilter:t})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(dn.FALLBACK)),this.store.useDataChannel=!1,this.signal=new xw(zs(zs({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Wi.RESET_SIGNAL,Lp.websocket)}}let cC=0,uf=0;function Kc(s,t,i,a){return new Pe((l,p)=>{t.timeout=t.timeout||ce("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),cC+=rl(t.data)):i&&(t.data.size?cC+=t.data.size:t.data instanceof FormData?cC+=KA(t.data):cC+=rl(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=s,mr.request(t).then(f=>{typeof f.data=="string"?uf+=rl(f.data):f.data instanceof ArrayBuffer||f.data instanceof Uint8Array?uf+=f.data.byteLength:uf+=rl(JSON.stringify(f.data)),a&&l({data:f.data,headers:f.headers}),l(f.data)}).catch(f=>{mr.isCancel(f)?p(new Ce(Z.OPERATION_ABORTED,"cancel token canceled")):f.code==="ECONNABORTED"?p(new Ce(Z.NETWORK_TIMEOUT,f.message)):f.response?p(new Ce(Z.NETWORK_RESPONSE_ERROR,f.response.status)):p(new Ce(Z.NETWORK_ERROR,f.message))})})}(function(){var s;function t(He){var rt=0;return function(){return rt<He.length?{done:!1,value:He[rt++]}:{done:!0}}}var i=typeof Object.defineProperties=="function"?Object.defineProperty:function(He,rt,mt){return He==Array.prototype||He==Object.prototype||(He[rt]=mt.value),He},a,l=function(He){He=[typeof globalThis=="object"&&globalThis,He,typeof window=="object"&&window,typeof self=="object"&&self,typeof T=="object"&&T];for(var rt=0;rt<He.length;++rt){var mt=He[rt];if(mt&&mt.Math==Math)return mt}throw Error("Cannot find global object")}(this);function p(He,rt){if(rt)e:{var mt=l;He=He.split(".");for(var Wt=0;Wt<He.length-1;Wt++){var _n=He[Wt];if(!(_n in mt))break e;mt=mt[_n]}(rt=rt(Wt=mt[He=He[He.length-1]]))!=Wt&&rt!=null&&i(mt,He,{configurable:!0,writable:!0,value:rt})}}function f(He){return(He={next:He})[Symbol.iterator]=function(){return this},He}function g(He){var rt=typeof Symbol<"u"&&Symbol.iterator&&He[Symbol.iterator];return rt?rt.call(He):{next:t(He)}}if(p("Symbol",function(He){function rt(_n,ot){this.A=_n,i(this,"description",{configurable:!0,writable:!0,value:ot})}if(He)return He;rt.prototype.toString=function(){return this.A};var mt="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",Wt=0;return function _n(ot){if(this instanceof _n)throw new TypeError("Symbol is not a constructor");return new rt(mt+(ot||"")+"_"+Wt++,ot)}}),p("Symbol.iterator",function(He){if(He)return He;He=Symbol("Symbol.iterator");for(var rt="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),mt=0;mt<rt.length;mt++){var Wt=l[rt[mt]];typeof Wt=="function"&&typeof Wt.prototype[He]!="function"&&i(Wt.prototype,He,{configurable:!0,writable:!0,value:function(){return f(t(this))}})}return He}),typeof Object.setPrototypeOf=="function")a=Object.setPrototypeOf;else{var v;e:{var y={};try{y.__proto__={a:!0},v=y.a;break e}catch{}v=!1}a=v?function(He,rt){if(He.__proto__=rt,He.__proto__!==rt)throw new TypeError(He+" is not extensible");return He}:null}var I=a;function b(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function k(He){if(He.m)throw new TypeError("Generator is already running");He.m=!0}function U(He,rt){return He.h=3,{value:rt}}function J(He){this.g=new b,this.G=He}function K(He,rt,mt,Wt){try{var _n=rt.call(He.g.j,mt);if(!(_n instanceof Object))throw new TypeError("Iterator result "+_n+" is not an object");if(!_n.done)return He.g.m=!1,_n;var ot=_n.value}catch(B){return He.g.j=null,He.g.s(B),q(He)}return He.g.j=null,Wt.call(He.g,ot),q(He)}function q(He){for(;He.g.h;)try{var rt=He.G(He.g);if(rt)return He.g.m=!1,{value:rt.value,done:!1}}catch(mt){He.g.v=void 0,He.g.s(mt)}if(He.g.m=!1,He.g.l){if(rt=He.g.l,He.g.l=null,rt.F)throw rt.D;return{value:rt.return,done:!0}}return{value:void 0,done:!0}}function te(He){this.next=function(rt){return He.o(rt)},this.throw=function(rt){return He.s(rt)},this.return=function(rt){return function(mt,Wt){k(mt.g);var _n=mt.g.j;return _n?K(mt,"return"in _n?_n.return:function(ot){return{value:ot,done:!0}},Wt,mt.g.return):(mt.g.return(Wt),q(mt))}(He,rt)},this[Symbol.iterator]=function(){return this}}function de(He,rt){return rt=new te(new J(rt)),I&&He.prototype&&I(rt,He.prototype),rt}if(b.prototype.o=function(He){this.v=He},b.prototype.s=function(He){this.l={D:He,F:!0},this.h=this.C||this.u},b.prototype.return=function(He){this.l={return:He},this.h=this.u},J.prototype.o=function(He){return k(this.g),this.g.j?K(this,this.g.j.next,He,this.g.o):(this.g.o(He),q(this))},J.prototype.s=function(He){return k(this.g),this.g.j?K(this,this.g.j.throw,He,this.g.o):(this.g.s(He),q(this))},p("Array.prototype.entries",function(He){return He||function(){return function(rt,mt){rt instanceof String&&(rt+="");var Wt=0,_n=!1,ot={next:function(){if(!_n&&Wt<rt.length){var B=Wt++;return{value:mt(B,rt[B]),done:!1}}return _n=!0,{done:!0,value:void 0}}};return ot[Symbol.iterator]=function(){return ot},ot}(this,function(rt,mt){return[rt,mt]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var he=function(He,rt){for(var mt=0;mt<He.length;mt++)rt(He[mt])},Ue=function(He){return He.replace(/\r?\n|\r/g,`\r
`)},Re=function(He,rt,mt){return rt instanceof Blob?(mt=mt!==void 0?mt+"":typeof rt.name=="string"?rt.name:"blob",rt.name===mt&&Object.prototype.toString.call(rt)!=="[object Blob]"||(rt=new File([rt],mt)),[String(He),rt]):[String(He),String(rt)]},Ie=function(He,rt){if(He.length<rt)throw new TypeError(rt+" argument required, but only "+He.length+" present.")},De=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,Ne=De.FormData,Xe=De.XMLHttpRequest&&De.XMLHttpRequest.prototype.send,nt=De.Request&&De.fetch,Vt=De.navigator&&De.navigator.sendBeacon,rn=De.Element&&De.Element.prototype,ui=De.Symbol&&Symbol.toStringTag;ui&&(Blob.prototype[ui]||(Blob.prototype[ui]="Blob"),"File"in De&&!File.prototype[ui]&&(File.prototype[ui]="File"));try{new File([],"")}catch{De.File=function(He,rt,mt){return He=new Blob(He,mt||{}),Object.defineProperties(He,{name:{value:rt},lastModified:{value:+(mt&&mt.lastModified!==void 0?new Date(mt.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),ui&&Object.defineProperty(He,ui,{value:"File"}),He}}var Ki=function(He){return He.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},_i=function(He){this.i=[];var rt=this;He&&he(He.elements,function(mt){if(mt.name&&!mt.disabled&&mt.type!=="submit"&&mt.type!=="button"&&!mt.matches("form fieldset[disabled] *"))if(mt.type==="file"){var Wt=mt.files&&mt.files.length?mt.files:[new File([],"",{type:"application/octet-stream"})];he(Wt,function(_n){rt.append(mt.name,_n)})}else mt.type==="select-multiple"||mt.type==="select-one"?he(mt.options,function(_n){!_n.disabled&&_n.selected&&rt.append(mt.name,_n.value)}):mt.type==="checkbox"||mt.type==="radio"?mt.checked&&rt.append(mt.name,mt.value):(Wt=mt.type==="textarea"?Ue(mt.value):mt.value,rt.append(mt.name,Wt))})};if((s=_i.prototype).append=function(He,rt,mt){Ie(arguments,2),this.i.push(Re(He,rt,mt))},s.delete=function(He){Ie(arguments,1);var rt=[];He=String(He),he(this.i,function(mt){mt[0]!==He&&rt.push(mt)}),this.i=rt},s.entries=function He(){var rt,mt=this;return de(He,function(Wt){if(Wt.h==1&&(rt=0),Wt.h!=3)return rt<mt.i.length?Wt=U(Wt,mt.i[rt]):(Wt.h=0,Wt=void 0),Wt;rt++,Wt.h=2})},s.forEach=function(He,rt){Ie(arguments,1);for(var mt=g(this),Wt=mt.next();!Wt.done;Wt=mt.next()){var _n=g(Wt.value);Wt=_n.next().value,_n=_n.next().value,He.call(rt,_n,Wt,this)}},s.get=function(He){Ie(arguments,1);var rt=this.i;He=String(He);for(var mt=0;mt<rt.length;mt++)if(rt[mt][0]===He)return rt[mt][1];return null},s.getAll=function(He){Ie(arguments,1);var rt=[];return He=String(He),he(this.i,function(mt){mt[0]===He&&rt.push(mt[1])}),rt},s.has=function(He){Ie(arguments,1),He=String(He);for(var rt=0;rt<this.i.length;rt++)if(this.i[rt][0]===He)return!0;return!1},s.keys=function He(){var rt,mt,Wt,_n,ot=this;return de(He,function(B){if(B.h==1&&(rt=g(ot),mt=rt.next()),B.h!=3)return mt.done?void(B.h=0):(Wt=mt.value,_n=g(Wt),U(B,_n.next().value));mt=rt.next(),B.h=2})},s.set=function(He,rt,mt){Ie(arguments,2),He=String(He);var Wt=[],_n=Re(He,rt,mt),ot=!0;he(this.i,function(B){B[0]===He?ot&&(ot=!Wt.push(_n)):Wt.push(B)}),ot&&Wt.push(_n),this.i=Wt},s.values=function He(){var rt,mt,Wt,_n,ot=this;return de(He,function(B){if(B.h==1&&(rt=g(ot),mt=rt.next()),B.h!=3)return mt.done?void(B.h=0):(Wt=mt.value,(_n=g(Wt)).next(),U(B,_n.next().value));mt=rt.next(),B.h=2})},_i.prototype._asNative=function(){for(var He=new Ne,rt=g(this),mt=rt.next();!mt.done;mt=rt.next()){var Wt=g(mt.value);mt=Wt.next().value,Wt=Wt.next().value,He.append(mt,Wt)}return He},_i.prototype._blob=function(){var He="----formdata-polyfill-"+Math.random(),rt=[],mt="--"+He+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(Wt,_n){return typeof Wt=="string"?rt.push(mt+Ki(Ue(_n))+`"\r
\r
`+Ue(Wt)+`\r
`):rt.push(mt+Ki(Ue(_n))+'"; filename="'+Ki(Wt.name)+`"\r
Content-Type: `+(Wt.type||"application/octet-stream")+`\r
\r
`,Wt,`\r
`)}),rt.push("--"+He+"--"),new Blob(rt,{type:"multipart/form-data; boundary="+He})},_i.prototype[Symbol.iterator]=function(){return this.entries()},_i.prototype.toString=function(){return"[object FormData]"},rn&&!rn.matches&&(rn.matches=rn.matchesSelector||rn.mozMatchesSelector||rn.msMatchesSelector||rn.oMatchesSelector||rn.webkitMatchesSelector||function(He){for(var rt=(He=(this.document||this.ownerDocument).querySelectorAll(He)).length;0<=--rt&&He.item(rt)!==this;);return-1<rt}),ui&&(_i.prototype[ui]="FormData"),Xe){var Ia=De.XMLHttpRequest.prototype.setRequestHeader;De.XMLHttpRequest.prototype.setRequestHeader=function(He,rt){Ia.call(this,He,rt),He.toLowerCase()==="content-type"&&(this.B=!0)},De.XMLHttpRequest.prototype.send=function(He){He instanceof _i?(He=He._blob(),this.B||this.setRequestHeader("Content-Type",He.type),Xe.call(this,He)):Xe.call(this,He)}}nt&&(De.fetch=function(He,rt){return rt&&rt.body&&rt.body instanceof _i&&(rt.body=rt.body._blob()),nt.call(this,He,rt)}),Vt&&(De.navigator.sendBeacon=function(He,rt){return rt instanceof _i&&(rt=rt._asNative()),Vt.call(this,He,rt)}),De.FormData=_i}})();let hf=()=>{let s=ce("AREAS");return s.length===0&&s.push(Cn.GLOBAL),oh(s).call(s,(t,i,a)=>{let l=CP(i);return l?a===0?l:"".concat(t,",").concat(l):t},"")},CP=s=>s===Cn.OVERSEA?"".concat(Xn.ASIA,",").concat(Xn.EUROPE,",").concat(Xn.AFRICA,",").concat(Xn.NORTH_AMERICA,",").concat(Xn.SOUTH_AMERICA,",").concat(Xn.OCEANIA):Xn[s],vP=s=>{let t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return s.map(i=>{let a=Ua[i],l=Object.keys(a);l&&l.map(p=>{p!=="CODE"&&(t[p]=t[p].concat(a[p]))})}),t},pf={GLOBAL:{ASIA:[Cn.CHINA,Cn.JAPAN,Cn.INDIA,Cn.KOREA,Cn.HKMC],EUROPE:[],NORTH_AMERICA:[Cn.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Tg=Object.keys(pf[Cn.GLOBAL]),Cg=[Cn.CHINA,Cn.NORTH_AMERICA,Cn.EUROPE,Cn.ASIA,Cn.JAPAN,Cn.INDIA,Cn.OCEANIA,Cn.SOUTH_AMERICA,Cn.AFRICA,Cn.KOREA,Cn.HKMC,Cn.US],Hw=function(s,t){let i=[];if(xe(s).call(s,Cn.GLOBAL)){let p=[Cn.GLOBAL,Cn.OVERSEA],f=Object.keys(Ua);if(t===Cn.GLOBAL)throw new Ce(Z.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Cn.CHINA)i=[Cn.OVERSEA];else if(l=t,xe(Tg).call(Tg,l)){let g=(a=t,pf[Cn.GLOBAL][a]||[]),v=[...p,t,...g];i=f.filter(y=>!xe(v).call(v,y))}else if(function(g){let v=!1;return Tg.forEach(y=>{var I;xe(I=pf[Cn.GLOBAL][y]).call(I,g)&&(v=!0)}),v}(t)){let g=function(y){let I;return Tg.forEach(b=>{var k;xe(k=pf[Cn.GLOBAL][b]).call(k,y)&&(I=b)}),I}(t),v=[...p,g,t];i=f.filter(y=>!xe(v).call(v,y))}else i=s;i=function(g){let v=[];return Cg.forEach(y=>{xe(g).call(g,y)&&v.push(y)}),v.concat(g.filter(y=>!xe(Cg).call(Cg,y)))}(i)}else i=s;var a,l;return i};function RP(s){var t,i;if(!s&&xe(t=ce("AREAS")).call(t,Cn.EXTENSIONS))return x.debug("update area from ap : reset"),void vg(ww,!0);if(!xe(i=ce("AREAS")).call(i,Cn.GLOBAL)||!s)return;let a=Ua.EXTENSIONS;a&&(a={CODE:CP(Cn.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(s,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(s,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(s,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(s,".agora.io"),"cds-ap-web-2-".concat(s,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(s,".agora.io"),"sua-ap-web-2-".concat(s,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(s,".agora.io"),"uap-ap-web-2-".concat(s,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(s,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(s,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(s,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(s,".agora.io")]},x.debug("update area from ap success: ".concat(s,",config is "),a),ei("AREAS",[Cn.EXTENSIONS],!0),Object.keys(a).map(l=>{l==="LOG_UPLOAD_SERVER"||l==="EVENT_REPORT_DOMAIN"||l==="EVENT_REPORT_BACKUP_DOMAIN"||l==="PROXY_SERVER_TYPE3"?ei(l,a[l][0]):ei(l,a[l])}))}function vg(s){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],i=Tt.reportApiInvoke(null,{name:cr.SET_AREA,options:s,tag:Pi.TRACER});try{let a=[];if(typeof s=="string"&&(a=[s]),Array.isArray(s)&&(s.forEach(p=>{if(!xe(gt).call(gt,p))throw new Ce(Z.INVALID_PARAMS,"invalid area code")}),a=s),Object.prototype.toString.call(s)==="[object Object]"){let{areaCode:p,excludedArea:f}=s;if(!p)throw new Ce(Z.INVALID_PARAMS,"area code is needed");let g=p;typeof p=="string"&&(g=[p]),a=f?Hw(g,f):g}if(!t){if(uc.AREAS){let p=new Ce(Z.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(p),void x.warning("setArea is prohibited because of config-distribute")}if(xe(a).call(a,Cn.GLOBAL)&&ce("AREAS")===Cn.EXTENSIONS){let p=new Ce(Z.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(p),void x.warning("setArea is prohibited because of ap extensions")}}ei("AREAS",a,t);let l=vP(a);Object.keys(l).map(p=>{p==="LOG_UPLOAD_SERVER"||p==="EVENT_REPORT_DOMAIN"||p==="EVENT_REPORT_BACKUP_DOMAIN"||p==="PROXY_SERVER_TYPE3"?ei(p,l[p][0]):ei(p,l[p])}),x.debug("set area success:",a.join(","))}catch(a){throw i.onError(a),a}i.onSuccess()}function Kw(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function dC(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Kw(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Kw(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}let lC=1;function yP(s,t,i,a,l){lC+=1;let p={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:lC,requestId:lC,version:Gt,cname:i.cname},f={service_name:t,json_body:JSON.stringify(p)},g,v,y=s[0];return ca(async()=>{g=Date.now();let I=await Kc(y,{data:f,cancelToken:a,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(v=Date.now()-g,I.code!==0){let U=new Ce(Z.UNEXPECTED_RESPONSE,"live streaming ap error, code"+I.code,{retry:!0,responseTime:v});throw x.error(U.toString()),U}let b=JSON.parse(I.json_body);if(b.code!==200){let U=new Ce(Z.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(b.code,", reason: ").concat(b.reason),{code:b.code,responseTime:v});throw x.error(U.toString()),U}if(!b.servers||b.servers.length===0){let U=new Ce(Z.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:b.code,responseTime:v});throw x.error(U.toString()),U}let k=function(U,J){return{addressList:U.servers.map(K=>"wss://".concat(K.address.replace(/\./g,"-"),".").concat(ce("WORKER_DOMAIN"),":").concat(K.wss,"?serviceName=").concat(encodeURIComponent(J))),workerToken:U.workerToken,vid:U.vid}}(b,t);return ce("LIVE_STREAMING_ADDRESS")&&(k.addressList=ce("LIVE_STREAMING_ADDRESS")instanceof Array?ce("LIVE_STREAMING_ADDRESS"):[ce("LIVE_STREAMING_ADDRESS")]),dC(dC({},k),{},{responseTime:v})},(I,b)=>(Tt.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(I.addressList),firstSuccess:b===0,responseTime:v,serverIp:s[b%s.length]}),!1),(I,b)=>(Tt.apworkerEvent(i.sid,{success:!1,sc:I.data&&I.data.code||200,serviceName:t,responseTime:v,serverIp:s[b%s.length]}),!!(I.code!==Z.OPERATION_ABORTED&&I.code!==Z.UNEXPECTED_RESPONSE||I.data&&I.data.retry)&&(y=s[(b+1)%s.length],!0)),l)}let Yw=1;function zw(s,t,i,a){let{url:l,areaCode:p}=s,f=Date.now(),g,[v,y]=uC(t,p,[Or.CHOOSE_SERVER]),I=Bi.networkState;return ca(async()=>{I&&Bi.networkState===Ws.OFFLINE&&Bi.onlineWaiter&&await Pe.race([Bi.onlineWaiter,Qr(a&&a.maxRetryTimeout||dr.maxRetryTimeout)]),I=Bi.networkState;let{data:b,headers:k}=await Kc(l,{data:v,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);g=k.http3==="1"?1:-1,Tt.reportResourceTiming(l,t.sid),Vp(b,l,t,f,[Or.CHOOSE_SERVER],g);let U=Ww(b,Or.CHOOSE_SERVER);return Fp(U),EP(U,l)},b=>(b&&Tt.joinChooseServer(t.sid,{lts:f,succ:!0,csAddr:l,opid:y,serverList:b.gatewayAddrs.map(k=>k.address),ec:null,cid:b.cid.toString(),uid:b.uid.toString(),csIp:b.csIp,unilbsServerIds:[Or.CHOOSE_SERVER].toString(),isHttp3:g}),!1),b=>b.code!==Z.OPERATION_ABORTED&&(b.code===Z.CAN_NOT_GET_GATEWAY_SERVER?b.data.retry:(Tt.joinChooseServer(t.sid,{lts:f,succ:!1,csAddr:l,serverList:null,opid:y,ec:b.code,csIp:b.data&&b.data.csIp,unilbsServerIds:[Or.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:I}),isHttp3:g}),x.warning("[".concat(t.clientId,"] Choose server network error, retry"),b),!0)),a)}function IP(s,t,i,a){let l,{url:p,areaCode:f,serviceIds:g}=s,v=Date.now(),[y,I]=uC(t,f,g),b;return ca(async()=>{b&&Bi.networkState===Ws.OFFLINE&&Bi.onlineWaiter&&await Pe.race([Bi.onlineWaiter,Qr(a&&a.maxRetryTimeout||dr.maxRetryTimeout)]),b=Bi.networkState;let{data:k,headers:U}=await Kc(p,{data:y,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l=U.http3==="1"?1:-1,Tt.reportResourceTiming(p,t.sid),Vp(k,p,t,v,g,l);let J=Ww(k,Or.CHOOSE_SERVER),K=Ww(k,t.cloudProxyServer==="proxy5"?Or.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Or.CLOUD_PROXY:Or.CLOUD_PROXY_FALLBACK);return Fp(J),{gatewayInfo:EP(J,p),proxyInfo:K,url:p}},k=>(k.gatewayInfo&&Tt.joinChooseServer(t.sid,{lts:v,succ:!0,csAddr:p,serverList:k.gatewayInfo.gatewayAddrs.map(U=>U.address),ec:null,opid:I,cid:k.gatewayInfo.cid.toString(),uid:k.gatewayInfo.uid.toString(),csIp:k.gatewayInfo.csIp,unilbsServerIds:g.toString(),isHttp3:l}),k.proxyInfo&&Tt.joinWebProxyAP(t.sid,{lts:v,sucess:1,apServerAddr:p,turnServerAddrList:k.proxyInfo.addresses.map(U=>U.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:g.toString()}),!1),k=>k.code!==Z.OPERATION_ABORTED&&(k.code===Z.CAN_NOT_GET_GATEWAY_SERVER?k.data.retry:(Tt.joinWebProxyAP(t.sid,{lts:v,sucess:0,apServerAddr:p,turnServerAddrList:null,errorCode:k.code,eventType:t.cloudProxyServer,unilbsServerIds:g.toString(),extend:JSON.stringify({networkState:b})}),x.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),k),!0)),a)}let Vp=(s,t,i,a,l,p)=>{let f=[],g=v=>{v.flag===4096?Tt.joinChooseServer(i.sid,{lts:a,succ:!1,csAddr:t,opid:s.opid,serverList:null,ec:v.error.message,csIp:v.error.data&&v.error.data.csIp,unilbsServerIds:l.toString(),isHttp3:p}):v.flag!==1048576&&v.flag!==4194304&&v.flag!==4194310||Tt.joinWebProxyAP(i.sid,{lts:a,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:v.error.code,eventType:i.cloudProxyServer,unilbsServerIds:l.toString()})};if(s.response_body.forEach(v=>{let y=v.buffer.code;if(v.uri===23&&y===0&&!v.buffer.edges_services)if(v.buffer.flag===4194310)x.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),v.buffer.edges_services=[];else{let I={error:new Ce(Z.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:s.detail[502]}),flag:v.buffer.flag};f.push(I),g(I)}if(y!==0){let I=mg(y),b={error:new Ce(Z.CAN_NOT_GET_GATEWAY_SERVER,I.desc,{desc:I.desc,retry:I.retry,csIp:s.detail[502]}),flag:v.buffer.flag};v.buffer.flag===4194310?x.warning(b.error.toString()):f.push(b),g(b)}}),f.length)throw x.warning("[".concat(i.clientId,"] multi unilbs ").concat(t," failed, ").concat(f.map(v=>"flag: ".concat(v.flag,", message: ").concat(v.error.message,", retry: ").concat(v.error.data.retry)).join(" | "))),new Ce(Z.CAN_NOT_GET_GATEWAY_SERVER,f.map(v=>"flag: ".concat(v.flag,", message: ").concat(v.error.message)).join(" | "),{retry:!!f.find(v=>v.error.data.retry),csIp:s.detail[502],desc:[...new Set(f.map(v=>{var y;return v==null||(y=v.error)===null||y===void 0||(y=y.data)===null||y===void 0?void 0:y.desc}).filter(v=>!!v))]})},Fp=s=>{var t,i,a,l;if(s.addresses&&s.addresses.length===0&&s.code===0)throw new Ce(Z.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:s.detail&&s.detail[502]});if(ce("AP_AREA")&&((a=s.detail)!==null&&a!==void 0&&a[23]&&typeof((l=s.detail)===null||l===void 0?void 0:l[23])=="string"?RP(s.detail[23].toLowerCase()):RP()),(t=s.detail)!==null&&t!==void 0&&t[19]&&typeof((i=s.detail)===null||i===void 0?void 0:i[19])=="string"){let f=s.detail[19],g=f==null?void 0:f.split(";");for(let v=0;v<g.length;v++){var p;let y=Yo(p=g[v]).call(p);s.addresses[v]&&g&&(s.addresses[v].fingerprint=y)}}if(ce("GATEWAY_ADDRESS")&&ce("GATEWAY_ADDRESS").length>0){x.debug("assign gateway address to",ce("GATEWAY_ADDRESS"));let f=ce("GATEWAY_ADDRESS").map(g=>{var v,y;let I=(v=(y=s.addresses.find(b=>b.ip===g.ip&&b.port===g.port))===null||y===void 0?void 0:y.fingerprint)!==null&&v!==void 0?v:"";return{ip:g.ip,port:g.port,ticket:s.addresses[0]&&s.addresses[0].ticket,fingerprint:I}});s.addresses=f}},Rg=(s,t)=>{if(s.response_body&&s.response_body.length){let i=s.response_body[0];if(i.buffer.code!==0){let a=mg(i.buffer.code);throw new Ce(Z.UPDATE_TICKET_FAILED,"[".concat(i.buffer.code,"]: ").concat(a.desc),{retry:a.retry})}return i.buffer.ticket}throw x.debug("update ticket request received ap response without response body:",t),new Ce(Z.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},uC=(s,t,i)=>{let a=Math.floor(Math.random()*1e12),l={appid:s.appId,client_ts:Date.now(),opid:a,sid:s.sid,request_bodies:[{uri:22,buffer:{cname:s.cname,detail:dC({6:s.stringUid,11:t,12:ce("USE_NEW_TOKEN")?"1":void 0,22:t},s.apRTM?{26:"RTM2"}:{}),key:s.token,service_ids:i,uid:s.uid||0}}]};l.request_bodies.forEach(f=>{s.multiIP&&s.multiIP.gateway_ip&&(f.buffer.detail[5]=JSON.stringify({vocs_ip:[s.multiIP.uni_lbs_ip],vos_ip:[s.multiIP.gateway_ip]}))});let p=new FormData;return p.append("request",JSON.stringify(l)),[p,a]},AP=(s,t)=>{let i=Math.floor(Math.random()*1e12),a={appid:s.appId,client_ts:Date.now(),opid:i,sid:s.sid,request_bodies:[{uri:28,buffer:{cname:s.cname,detail:{1:"",6:s.stringUid,12:"1"},token:s.token,service_ids:t,uid:s.uid||0,edges_services:s.apResponse.addresses.map(p=>({ip:p.ip,port:p.port}))}}]},l=new FormData;return l.append("request",JSON.stringify(a)),[l,i]},jp=0;function mf(s){return Pe.all(s.map(t=>t.then(i=>{throw i},i=>i))).then(t=>{throw t},t=>t)}let ff=async s=>{let{fragementLength:t,referenceList:i,asyncMapHandler:a,allFailedhandler:l,promisesCollector:p}=s,f=0,g=t,v,y=0,I=async()=>{let b=(()=>{let k=f*g,U=k+g;return i.slice(k,U).map(a)})();p&&p.push(...b);try{v=await mf(b)}catch(k){if(y+=g,f++,!(y>=i.length))return void await I();l(k)}b.forEach(k=>k.cancel())};return await I(),v};async function hC(s,t,i,a){return{gatewayInfo:await async function(l,p,f,g){let v=null,y=[],I=async()=>{let k=ce("WEBCS_DOMAIN").slice(0,ce("AJAX_REQUEST_CONCURRENT")).map(K=>({url:l.proxyServer?"https://".concat(l.proxyServer,"/ap/?url=").concat(K+"/api/v2/transpond/webrtc?v=2"):"https://".concat(K,"/api/v2/transpond/webrtc?v=2"),areaCode:hf()})),U=g.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:k.map(K=>K.url)}),J=await ff({fragementLength:ce("FRAGEMENT_LENGTH"),referenceList:k,asyncMapHandler:K=>(x.debug("[".concat(l.clientId,"] Connect to choose_server:"),K.url),zw(K,l,p,f)),allFailedhandler:K=>{throw g.recordJoinChannelService({endTs:Date.now(),status:"error",errors:K},U),K[0]},promisesCollector:y});return g.recordJoinChannelService({endTs:Date.now(),status:"success"},U),J},b=async()=>{if(await Qr(1e3),v!==null)return v;let k=ce("WEBCS_DOMAIN_BACKUP_LIST").map(K=>({url:l.proxyServer?"https://".concat(l.proxyServer,"/ap/?url=").concat(K+"/api/v2/transpond/webrtc?v=2"):"https://".concat(K,"/api/v2/transpond/webrtc?v=2"),areaCode:hf()})),U=g.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:k.map(K=>K.url)}),J=await ff({fragementLength:ce("FRAGEMENT_LENGTH"),referenceList:k,asyncMapHandler:K=>(x.debug("[".concat(l.clientId,"] Connect to backup choose_server:"),K.url),zw(K,l,p,f)),allFailedhandler:K=>{throw g.recordJoinChannelService({endTs:Date.now(),status:"error",errors:K},U),K[0]},promisesCollector:y});return g.recordJoinChannelService({endTs:Date.now(),status:"success"},U),J};try{return v=await mf([I(),b()]),y.length&&y.forEach(k=>k.cancel&&typeof k.cancel=="function"&&k.cancel()),v}catch(k){throw k[0]}}(s,t,i,a)}}async function wP(s,t,i,a,l){let p=s.cloudProxyServer;if(p==="disabled"){if(s.useLocalAccessPoint)return await hC(s,t,i,l);if(ce("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:k,proxyInfo:U}=await qw(s,t,i,l);if(s.turnServer&&s.turnServer.mode!=="auto")return{gatewayInfo:k};let J=U.map(K=>({turnServerURL:K.address,tcpport:K.tcpport||Gi.tcpport,udpport:K.udpport||Gi.udpport,username:K.username||Gi.username,password:K.password||Gi.password,forceturn:!1,security:!0}));if(l.useP2P){var f;let K=(f=s.uid)!==null&&f!==void 0?f:k.uid,q="glb:".concat(K.toString()),te=await PT(q),de=U.map(he=>({turnServerURL:he.address,tcpport:he.tcpport||Gi.tcpport,udpport:he.udpport||Gi.udpport,username:q,password:te,forceturn:!1,security:!0}));J.push(...de)}return s.turnServer={mode:"manual",servers:J},{gatewayInfo:k}}return await hC(s,t,i,l)}let{proxyInfo:g,gatewayInfo:v}=await qw(s,t,i,l),y={gatewayInfo:v},I=g.map(k=>({turnServerURL:k.address,tcpport:p==="proxy3"?void 0:k.tcpport?k.tcpport:Gi.tcpport,udpport:p==="proxy4"?void 0:k.udpport?k.udpport:Gi.udpport,username:k.username||Gi.username,password:k.password||Gi.password,forceturn:p!=="proxy4",security:p==="proxy5"}));if(l.useP2P){var b;let k=(b=s.uid)!==null&&b!==void 0?b:v.uid,U="glb:".concat(k.toString()),J=await PT(U),K=g.map(q=>({turnServerURL:q.address,tcpport:p==="proxy3"?void 0:q.tcpport||Gi.tcpport,udpport:p==="proxy4"?void 0:q.udpport||Gi.udpport,username:U,password:J,forceturn:p!=="proxy4",security:p==="proxy5"}));I.push(...K)}return s.turnServer={mode:"manual",servers:I},x.debug("[".concat(s.clientId,"] set proxy server: ").concat(s.proxyServer,", mode: ").concat(p)),y}async function bP(s,t,i,a,l){let p=ce("ACCOUNT_REGISTER").slice(0,ce("AJAX_REQUEST_CONCURRENT")),f=[];f=t.proxyServer?p.map(v=>"https://".concat(t.proxyServer,"/ap/?url=").concat(v+"/api/v1")):p.map(v=>"https://".concat(v,"/api/v1"));let g=l==null?void 0:l.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:f});try{let v=await async function(y,I,b,k,U){let J=Date.now(),K={sid:b.sid,opid:10,appid:b.appId,string_uid:I},q=y[0],te=await ca(()=>Kc(q+"".concat(q.indexOf("?")===-1?"?":"&","action=stringuid"),{data:K,cancelToken:k,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(de,he)=>{if(de.code===0){if(de.uid<=0||de.uid>=Math.pow(2,32))throw x.error("Invalid Uint Uid ".concat(I," => ").concat(de.uid),de),Tt.reqUserAccount(K.sid,{lts:J,success:!1,serverAddr:q,stringUid:K.string_uid,uid:de.uid,errorCode:Z.INVALID_UINT_UID_FROM_STRING_UID,extend:K}),new Ce(Z.INVALID_UINT_UID_FROM_STRING_UID);return Tt.reqUserAccount(K.sid,{lts:J,success:!0,serverAddr:q,stringUid:K.string_uid,uid:de.uid,errorCode:null,extend:K}),!1}let Ue=mg(de.code);return Ue.retry&&(q=y[(he+1)%y.length]),Tt.reqUserAccount(K.sid,{lts:J,success:!1,serverAddr:q,stringUid:K.string_uid,uid:de.uid,errorCode:Ue.desc,extend:K}),Ue.retry},(de,he)=>de.code!==Z.OPERATION_ABORTED&&(Tt.reqUserAccount(K.sid,{lts:J,success:!1,serverAddr:q,stringUid:K.string_uid,uid:null,errorCode:de.code,extend:K}),q=y[(he+1)%y.length],!0),U);if(te.code!==0){let de=mg(te.code);throw new Ce(Z.UNEXPECTED_RESPONSE,de.desc)}return te}(f,s,t,i,a);return l==null||l.recordJoinChannelService({status:"success",endTs:Date.now()},g),v.uid}catch(v){throw l==null||l.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[v]},g),v}}async function OP(s,t,i){let a=ce("CDS_AP").slice(0,ce("AJAX_REQUEST_CONCURRENT")).map(g=>s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(g+"/api/v1"):"https://".concat(g,"/api/v1?action=config")).map(g=>function(v,y,I,b){let k=En(),U={flag:64,cipher_method:0,features:{device:k.name,system:k.os,system_general:navigator.userAgent,vendor:y.appId,version:Gt,cname:y.cname,sid:y.sid,session_id:y.sid,detail:"",proxyServer:y.proxyServer}};return ca(()=>Kc(v,{data:U,timeout:1e3,cancelToken:I,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,J=>J.code!==Z.OPERATION_ABORTED,b)}(g,s,t,i)),l=null,p=null,f={};try{l=await mf(a)}catch(g){if(g.code===Z.OPERATION_ABORTED)throw g;p=g}if(a.forEach(g=>g.cancel()),Tt.reportApiInvoke(s.sid,{name:cr.REQUEST_CONFIG_DISTRIBUTE,options:{error:p,res:l}}).onSuccess(),l&&l.test_tags)try{f=function(g){if(!g.test_tags)return{};let v=g.test_tags,y=Object.keys(v),I={};return y.forEach(b=>{var k;let U=Yo(k=b.slice(4)).call(k),J=JSON.parse(v[b])[1];I[U]=J}),I}(l)}catch{}return f}async function qw(s,t,i,a){let l=ce("PROXY_SERVER_TYPE3"),p=(U,J,K)=>{let q=K||l;return Array.isArray(q)&&(q=J%2==0?l[1]:l[0]),"https://".concat(q,"/ap/?url=").concat(U)},f=null,g=[],v=async()=>{let U=ce("WEBCS_DOMAIN").slice(0,ce("AJAX_REQUEST_CONCURRENT")).map((q,te)=>{let de;return de=s.cloudProxyServer==="disabled"&&s.proxyServer?p("".concat(q,"/api/v2/transpond/webrtc?v=2"),te,s.proxyServer):s.cloudProxyServer==="disabled"||s.cloudProxyServer==="fallback"?"https://".concat(q,"/api/v2/transpond/webrtc?v=2"):p("".concat(q,"/api/v2/transpond/webrtc?v=2"),te),{url:de,areaCode:hf(),serviceIds:[Or.CHOOSE_SERVER,s.cloudProxyServer==="proxy5"?Or.CLOUD_PROXY_5:s.cloudProxyServer==="proxy3"||s.cloudProxyServer==="proxy4"?Or.CLOUD_PROXY:Or.CLOUD_PROXY_FALLBACK]}}),J=a.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:U.map(q=>q.url)}),K=await ff({fragementLength:ce("FRAGEMENT_LENGTH"),referenceList:U,asyncMapHandler:q=>(x.debug("[".concat(s.clientId,"] Connect to choose_server:"),q.url),IP(q,s,t,i)),allFailedhandler:q=>{throw a.recordJoinChannelService({endTs:Date.now(),status:"error",errors:q},J),q[0]},promisesCollector:g});return a.recordJoinChannelService({endTs:Date.now(),status:"success"},J),K},y=async()=>{if(await Qr(1e3),f!==null)return f;let U=ce("WEBCS_DOMAIN_BACKUP_LIST").map((q,te)=>{let de;return de=s.cloudProxyServer==="disabled"&&s.proxyServer?p("".concat(q,"/api/v2/transpond/webrtc?v=2"),te,s.proxyServer):s.cloudProxyServer==="disabled"||s.cloudProxyServer==="fallback"?"https://".concat(q,"/api/v2/transpond/webrtc?v=2"):p("".concat(q,"/api/v2/transpond/webrtc?v=2"),te),{url:de,areaCode:hf(),serviceIds:[Or.CHOOSE_SERVER,s.cloudProxyServer==="proxy5"?Or.CLOUD_PROXY_5:s.cloudProxyServer==="proxy3"||s.cloudProxyServer==="proxy4"?Or.CLOUD_PROXY:Or.CLOUD_PROXY_FALLBACK]}}),J=a.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:U.map(q=>q.url)}),K=await ff({fragementLength:ce("FRAGEMENT_LENGTH"),referenceList:U,asyncMapHandler:q=>(x.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),q.url),IP(q,s,t,i)),allFailedhandler:q=>{throw a.recordJoinChannelService({endTs:Date.now(),status:"error",errors:q},J),q[0]},promisesCollector:g});return a.recordJoinChannelService({endTs:Date.now(),status:"success"},J),K},I,b,k;try{({gatewayInfo:I,proxyInfo:b,url:k}=await mf([v(),y()]))}catch(U){throw U[0]}if(g.length&&g.forEach(U=>U.cancel&&typeof U.cancel=="function"&&U.cancel()),!I||!b)throw new Ce(Z.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(s.apUrl=k,s.cloudProxyServer!=="disabled"&&Array.isArray(l)&&k){let U=/^https?:\/\/(.+?)(\/.*)?$/.exec(k)[1];xe(l).call(l,U)&&(s.proxyServer=U,x.setProxyServer(U),Tt.setProxyServer(U))}return f={gatewayInfo:I,proxyInfo:await ZB(b,I.uid)},f}async function NP(s,t,i,a){let l=ce("UAP_AP").slice(0,ce("AJAX_REQUEST_CONCURRENT")).map(p=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(p+"/api/v1?action=uap"):"https://".concat(p,"/api/v1?action=uap"));return await yP(l,s,t,i,a)}async function qs(s,t,i){let a=ce("UAP_AP").slice(0,ce("AJAX_REQUEST_CONCURRENT")).map(l=>s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(l+"/api/v1?action=uap"):"https://".concat(l,"/api/v1?action=uap")).map(l=>function(p,f,g,v){let y={command:"convergeAllocateEdge",sid:f.sid,appId:f.appId,token:f.token,ts:Date.now(),version:Gt,cname:f.cname,uid:f.uid.toString(),requestId:Yw,seq:Yw};Yw+=1;let I={service_name:"tele_channel",json_body:JSON.stringify(y)};return ca(async()=>{let b=await Kc(p,{data:I,cancelToken:g,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(b.code!==0){let U=new Ce(Z.UNEXPECTED_RESPONSE,"cross channel ap error, code"+b.code,{retry:!0});throw x.error(U.toString()),U}let k=JSON.parse(b.json_body);if(k.code!==200){let U=new Ce(Z.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(k.code,", reason: ").concat(k.reason));throw x.error(U.toString()),U}if(!k.servers||k.servers.length===0){let U=new Ce(Z.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw x.error(U.toString()),U}return{vid:k.vid,workerToken:k.workerToken,addressList:(ce("CHANNEL_MEDIA_RELAY_SERVERS")||k.servers).map(U=>"wss://".concat(U.address.replace(/\./g,"-"),".").concat(ce("WORKER_DOMAIN"),":").concat(U.wss))}},void 0,b=>!!(b.code!==Z.OPERATION_ABORTED&&b.code!==Z.UNEXPECTED_RESPONSE||b.data&&b.data.retry),v)}(l,s,t,i));try{let l=await mf(a);return a.forEach(p=>p.cancel()),l}catch(l){throw l[0]}}async function Dn(s,t,i){let a=null,l=[],p=async f=>{let g=ce(f?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(v=>s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(v+"/api/v2/transpond/webrtc?v=2"):"https://".concat(v,"/api/v2/transpond/webrtc?v=2"));return f&&(await Qr(1e3),a!==null)?a:await ff({fragementLength:ce("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:v=>(x.debug("[".concat(s.clientId,"] update ticket, Connect to ").concat(f?"backup":""," choose_server:"),v),function(y,I,b,k){let[U]=AP(I,[Or.CHOOSE_SERVER]),J=Bi.networkState;return ca(async()=>{J&&Bi.networkState===Ws.OFFLINE&&Bi.onlineWaiter&&await Pe.race([Bi.onlineWaiter,Qr(k&&k.maxRetryTimeout||dr.maxRetryTimeout)]),J=Bi.networkState;let K=await Kc(y,{data:U,cancelToken:b,headers:{"Content-Type":"multipart/form-data;"}},!0);return Rg(K,y)},()=>!1,K=>K.code!==Z.OPERATION_ABORTED&&(K.code===Z.UPDATE_TICKET_FAILED?K.data.retry:(x.warning("[".concat(I.clientId,"] update ticket network error, retry"),K),!0)),k)}(v,s,t,i)),allFailedhandler:v=>{throw v[0]},promisesCollector:l})};try{return a=await mf([p(!1),p(!0)]),l.length&&l.forEach(f=>f.cancel&&typeof f.cancel=="function"&&f.cancel()),a}catch(f){throw f[0]}}function Nr(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Bp(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Nr(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Nr(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class Rn extends ri{get isSuccess(){return!!this.configs}constructor(){super(),P(this,"configs",void 0),P(this,"joinInfo",void 0),P(this,"cancelToken",void 0),P(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),P(this,"interval",void 0),P(this,"mutex",new sn("config-distribute")),P(this,"mutableParamsRead",!1)}startGetConfigDistribute(t,i){this.joinInfo=t,this.cancelToken=i,this.interval&&this.stopGetConfigDistribute(),ce("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},ce("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,Tt.reportApiInvoke(null,{options:void 0,name:cr.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Pi.TRACER}).onSuccess(JSON.stringify(uc))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void x.debug("[config-distribute] get config distribute interrupted have no joininfo");let t,i=await this.mutex.lock();try{t=await OP(this.joinInfo,this.cancelToken,this.retryConfig),x.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(a){let l=new Ce(Z.NETWORK_RESPONSE_ERROR,a);x.warning("[config-distribute] ".concat(l.toString()))}finally{i()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(t){var i;(i=t)&&i.uplink&&i.id&&i.uplink.max_bitrate!==void 0&&i.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==t.id&&this.emit(Je.UPDATE_BITRATE_LIMIT,t):this.emit(Je.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Bp({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){var i;let a=kE(i=Object.keys(t).filter(p=>/^webrtc_ng_global_parameter/.test(p))).call(i);for(let p=0;p<a.length;p++)for(let f=a.length-1;f>p;f--){let g=a[f];if(typeof t[g].__priority=="number"){let v=t[g].__priority,y=a[f-1];if(typeof t[y].__priority=="number"){if(!(v>t[y].__priority))continue;{let I=g;a[f]=a[f-1],a[f-1]=I}}else{let I=g;a[f]=a[f-1],a[f-1]=I}}}let l={};a.forEach(p=>{let f=t[p],g=f.__expires;Object.keys(f).forEach(v=>{v==="__priority"||v==="__expires"||Object.prototype.hasOwnProperty.call(l,v)||(l[v]=Bp({value:f[v]},g&&{expires:g}))})});try{(function(g){try{let v=Date.now();Object.keys(g).forEach(y=>{switch(y){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(io,y)){let{value:I,expires:b}=g[y];if(b&&b<=v)return;uc[y]=I,io[y]=I,x.debug("Update global parameters from config distribute",y,I)}}})}catch(v){x.error("Error update config immediately: ".concat(g),v.message)}})(l);let p=JSON.stringify(l),f=window.btoa(p);window.localStorage.setItem("websdk_ng_global_parameter",f),x.debug("Caching global parameters ".concat(p))}catch(p){x.error("Error caching global parameters:",p.message)}}}let Zi={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function zn(){return Zi}var Wr;function lu(s,t,i){return{sampleRate:s,stereo:t,bitrate:i}}function yn(s,t,i,a,l){return{width:s,height:t,frameRate:i,bitrateMin:a,bitrateMax:l}}function Yc(s,t,i,a,l){return{width:{max:s},height:{max:t},frameRate:i,bitrateMin:a,bitrateMax:l}}function zc(s,t){return{numSpatialLayers:s,numTemporalLayers:t}}(function(s){s.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",s.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",s.IOS_INTERRUPTION_START="ios-interruption-start",s.IOS_INTERRUPTION_END="ios-interruption-end",s.STATE_CHANGE="state-change"})(Wr||(Wr={}));let Jw={"90p":yn(160,90),"90p_1":yn(160,90),"120p":yn(160,120,15,30,65),"120p_1":yn(160,120,15,30,65),"120p_3":yn(120,120,15,30,50),"120p_4":yn(212,120),"180p":yn(320,180,15,30,140),"180p_1":yn(320,180,15,30,140),"180p_3":yn(180,180,15,30,100),"180p_4":yn(240,180,15,30,120),"240p":yn(320,240,15,40,200),"240p_1":yn(320,240,15,40,200),"240p_3":yn(240,240,15,40,140),"240p_4":yn(424,240,15,40,220),"360p":yn(640,360,15,80,400),"360p_1":yn(640,360,15,80,400),"360p_3":yn(360,360,15,80,260),"360p_4":yn(640,360,30,80,600),"360p_6":yn(360,360,30,80,400),"360p_7":yn(480,360,15,80,320),"360p_8":yn(480,360,30,80,490),"360p_9":yn(640,360,15,80,800),"360p_10":yn(640,360,24,80,800),"360p_11":yn(640,360,24,80,1e3),"480p":yn(640,480,15,100,500),"480p_1":yn(640,480,15,100,500),"480p_2":yn(640,480,30,100,1e3),"480p_3":yn(480,480,15,100,400),"480p_4":yn(640,480,30,100,750),"480p_6":yn(480,480,30,100,600),"480p_8":yn(848,480,15,100,610),"480p_9":yn(848,480,30,100,930),"480p_10":yn(640,480,10,100,400),"720p":yn(1280,720,15,120,1130),"720p_auto":yn(1280,720,30,900,3e3),"720p_1":yn(1280,720,15,120,1130),"720p_2":yn(1280,720,30,120,2e3),"720p_3":yn(1280,720,30,120,1710),"720p_5":yn(960,720,15,120,910),"720p_6":yn(960,720,30,120,1380),"1080p":yn(1920,1080,15,120,2080),"1080p_1":yn(1920,1080,15,120,2080),"1080p_2":yn(1920,1080,30,120,3e3),"1080p_3":yn(1920,1080,30,120,3150),"1080p_5":yn(1920,1080,60,120,4780),"1440p":yn(2560,1440,30,120,4850),"1440p_1":yn(2560,1440,30,120,4850),"1440p_2":yn(2560,1440,60,120,7350),"4k":yn(3840,2160,30,120,8910),"4k_1":yn(3840,2160,30,120,8910),"4k_3":yn(3840,2160,60,120,13500)},Gp=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],$B={"480p":Yc(640,480,5),"480p_1":Yc(640,480,5),"480p_2":Yc(640,480,30),"480p_3":Yc(640,480,15),"720p":Yc(1280,720,5),"720p_auto":yn(1280,720,30,900,3e3),"720p_1":Yc(1280,720,5),"720p_2":Yc(1280,720,30),"720p_3":Yc(1280,720,15),"1080p":Yc(1920,1080,5),"1080p_1":Yc(1920,1080,5),"1080p_2":Yc(1920,1080,30),"1080p_3":Yc(1920,1080,15)},pC={"1SL1TL":zc(1,1),"3SL3TL":zc(3,3),"2SL3TL":zc(2,3)};function ha(s){return s||(s="480p_1"),typeof s=="string"?Object.assign({},Jw[s]):s}function mC(s){return typeof s=="string"?Object.assign({},$B[s]):s}function ht(s){return typeof s=="string"?Object.assign({},pC[s]):s}let hi={speech_low_quality:lu(16e3,!1),speech_standard:lu(32e3,!1,18),music_standard:lu(48e3,!1),standard_stereo:lu(48e3,!0,56),high_quality:lu(48e3,!1,128),high_quality_stereo:lu(48e3,!0,192)};function Dd(s){return typeof s=="string"?Object.assign({},hi[s]):s}let gh=[];function fC(s){return vr(s,"mediaSource",["screen","window","application"]),!0}var ut,Un,pa,_o,_C,Sh,pl,Th,Jo,yg;(function(s){s.NEED_RENEGOTIATE="@need_renegotiate",s.NEED_REPLACE_TRACK="@need_replace_track",s.NEED_CLOSE="@need_close",s.NEED_ENABLE_TRACK="@need_enable_track",s.NEED_DISABLE_TRACK="@need_disable_track",s.NEED_SESSION_ID="@need_sid",s.SET_OPTIMIZATION_MODE="@set_optimization_mode",s.GET_STATS="@get_stats",s.GET_RTC_STATS="@get_rtc_stats",s.GET_LOW_VIDEO_TRACK="@get_low_video_track",s.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",s.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",s.NEED_MUTE_TRACK="@need_mute_track",s.NEED_UNMUTE_TRACK="@need_unmute_track"})(ut||(ut={})),function(s){s.SCREEN_TRACK="screen_track",s.CUSTOM_TRACK="custome_track",s.LOW_STREAM="low_stream"}(Un||(Un={})),function(s){s[s.HIGH_STREAM=0]="HIGH_STREAM",s[s.LOW_STREAM=1]="LOW_STREAM"}(pa||(pa={})),function(s){s[s.HIGH_STREAM=0]="HIGH_STREAM",s[s.LOW_STREAM=1]="LOW_STREAM"}(_o||(_o={})),function(s){s[s.DISABLE=0]="DISABLE",s[s.LOW_STREAM=1]="LOW_STREAM",s[s.AUDIO_ONLY=2]="AUDIO_ONLY"}(_C||(_C={})),function(s){s.TRANSCEIVER_UPDATED="transceiver-updated"}(Sh||(Sh={})),function(s){s.SOURCE_STATE_CHANGE="source-state-change",s.TRACK_ENDED="track-ended",s.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",s.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",s.CLOSED="closed"}(pl||(pl={})),function(s){s.FIRST_FRAME_DECODED="first-frame-decoded",s.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(Th||(Th={})),function(s){s.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",s.RECEIVE_TRACK_BUFFER="receive_track_buffer",s.ON_AUDIO_BUFFER="on_audio_buffer",s.UPDATE_SOURCE="update_source"}(Jo||(Jo={})),function(s){s.UPDATE_TRACK_SOURCE="update-track-source"}(yg||(yg={}));let ys={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},Eo={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},Ch={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},uu={uplinkNetworkQuality:0,downlinkNetworkQuality:0},ks={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var $i,go,qc,ml,di;(function(s){s.ON_TRACK="on_track",s.ON_NODE="on_node"})($i||($i={})),function(s){s.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",s.REQUEST_CONSTRAINTS="request_constraints"}(go||(go={})),function(s){s.IDLE="IDLE",s.INITING="INITING",s.INITEND="INITEND"}(qc||(qc={})),function(s){s.STATE_CHANGE="state_change",s.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",s.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",s.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(ml||(ml={})),function(s){s.NONE="none",s.INIT="init",s.CANPLAY="canplay",s.PLAYING="playing",s.PAUSED="paused",s.SUSPEND="suspend",s.STALLED="stalled",s.WAITING="waiting",s.ERROR="error",s.DESTROYED="destroyed",s.ABORT="abort",s.ENDED="ended",s.EMPTIED="emptied",s.LOADEDDATA="loadeddata"}(di||(di={}));let EC={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var Wp;(function(s){s.OPEN="open",s.MESSAGE="message",s.CLOSE="close",s.CLOSING="closing",s.ERROR="error"})(Wp||(Wp={}));class ma extends ri{constructor(t,i){super(),P(this,"_ID",void 0),P(this,"_rtpTransceiver",void 0),P(this,"_lowRtpTransceiver",void 0),P(this,"_hints",[]),P(this,"_isClosed",!1),P(this,"_originMediaStreamTrack",void 0),P(this,"_mediaStreamTrack",void 0),P(this,"_external",{}),this._ID=i||si(8,"track-"),this._originMediaStreamTrack=t,this._mediaStreamTrack=t,function(a){xe(gh).call(gh,a)||gh.push(a)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){if(!t){let i=Tt.reportApiInvoke(null,{name:cr.GET_MEDIA_STREAM_TRACK,options:[],tag:Pi.TRACER});this._mediaStreamTrack&&typeof this._mediaStreamTrack.label=="string"?i.onSuccess(this._mediaStreamTrack.label):i.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===pa.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){let i=gh.indexOf(t);i!==-1&&gh.splice(i,1)}(this),this.emit(pl.CLOSED)}_updateRtpTransceiver(t,i){if(i===pa.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(Sh.TRANSCEIVER_UPDATED,t,i)}}class tn extends ma{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}constructor(t,i){super(t,i),P(this,"_enabled",!0),P(this,"_muted",!1),P(this,"_isExternalTrack",!1),P(this,"_isClosed",!1),P(this,"_enabledMutex",void 0),P(this,"processor",void 0),P(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new sn("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,i;return(t=(i=this._originMediaStreamTrack)===null||i===void 0?void 0:i.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,x.debug("[".concat(this.getTrackId(),"] close")),this.emit(ut.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,i){let a=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=a,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await fn(this,ut.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){x.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(pl.TRACK_ENDED)}stateCheck(t,i){if(x.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(i,"]")),$l(i,t),this._enabled&&this._muted&&t==="enabled"&&i===!1)throw new Ve(Z.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",x);if(!this._enabled&&!this._muted&&t==="muted"&&i===!0)throw new Ve(Z.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",x)}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function DP(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}let Hp=window.AudioContext||window.webkitAudioContext,Js=null,Wn=new class extends ri{constructor(){super(...arguments),P(this,"prevState",void 0),P(this,"curState",void 0),P(this,"currentTime",void 0),P(this,"currentTimeStuckAt",void 0),P(this,"interruptDetectorTrack",void 0),P(this,"onLocalAudioTrackMute",()=>{x.info("ios15-interruption-start"),this.emit(Wr.IOS_15_16_INTERRUPTION_START)}),P(this,"onLocalAudioTrackUnmute",async()=>{x.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?x.info("ios15-interruption-end-canceled"):(Js&&await Js.suspend(),this.emit(Wr.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(s){x.debug("webaudio bindInterruptDetectorTrack ".concat(s.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=s,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(s){x.debug("webaudio unbindInterruptDetectorTrack ".concat(s.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===s&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Xw(){if(!Hp)return void x.error("your browser is not support web audio");x.info("create audio context");let s=function(t){for(var i=1;i<arguments.length;i++){var a=arguments[i]!=null?arguments[i]:{};i%2?DP(Object(a),!0).forEach(function(l){P(t,l,a[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):DP(Object(a)).forEach(function(l){Object.defineProperty(t,l,Object.getOwnPropertyDescriptor(a,l))})}return t}({},ce("WEBAUDIO_INIT_OPTIONS"));x.debug("audio context init option:",JSON.stringify(s)),Js=new Hp(s),Wn.curState=Js.state,Js.onstatechange=()=>{Wn.prevState=Wn.curState,Wn.curState=Js?Js.state:void 0;let{prevState:t,curState:i}=Wn,a=i==="running",l=i==="interrupted",p=t==="running",f=t==="suspended",g=t==="interrupted",v=En().osVersion;(Gs()||Id())&&p&&l&&(x.info("ios".concat(v,"-interruption-start")),Wn.emit(Wr.IOS_INTERRUPTION_START)),(Gs()||Id())&&(f||g)&&a&&(x.info("ios".concat(v,"-interruption-end")),Wn.emit(Wr.IOS_INTERRUPTION_END)),t!==i&&Wn.emit(Wr.STATE_CHANGE,i,t)},setInterval(()=>{var t;let i=(t=Js)===null||t===void 0?void 0:t.currentTime;Wn.currentTime!==i?(Wn.currentTimeStuckAt&&(x.debug("AudioContext current time resume at ".concat(i)),Wn.currentTimeStuckAt=void 0),Wn.currentTime=i):(i!==Wn.currentTimeStuckAt&&(Tt.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:i},tag:Pi.TRACER}).onSuccess(),x.warning("AudioContext current time stuck at ".concat(i))),Wn.currentTimeStuckAt=i)},5e3),async function(t){let i=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],a,l=!1,p=!1,f=!1;function g(q){t.state==="running"?v(!1):Gs()||Id()?t.state==="suspended"&&(v(!0),q&&t.resume().then(I,I)):t.state!=="closed"&&(v(!0),q&&t.resume().then(I,I))}function v(q){if(l!==q){l=q;for(let te=0,de=i;te<de.length;te+=1){let he=de[te];q?window.addEventListener(he,b,{capture:!0,passive:!0}):window.removeEventListener(he,b,{capture:!0,passive:!0})}}}function y(){g(!0)}function I(){g(!1)}function b(){g(!0)}function k(q){if(!f)if(a.paused)if(q){let te;U(!1),f=!0;try{te=a.play(),te?te.then(J,J):(a.addEventListener("playing",J),a.addEventListener("abort",J),a.addEventListener("error",J))}catch{J()}}else U(!0);else U(!1)}function U(q){if(p!==q){p=q;for(let te=0,de=i;te<de.length;te++){let he=de[te];q?window.addEventListener(he,K,{capture:!0,passive:!0}):window.removeEventListener(he,K,{capture:!0,passive:!0})}}}function J(){a.removeEventListener("playing",J),a.removeEventListener("abort",J),a.removeEventListener("error",J),f=!1,k(!1)}function K(){k(!0)}if(Gs()){let q=t.createMediaStreamDestination(),te=document.createElement("div");te.innerHTML="<audio x-webkit-airplay='deny'></audio>",a=te.children.item(0),a.controls=!1,a.disableRemotePlayback=!0,a.preload="auto",a.srcObject=q.stream,k(!0)}Wn.on(Wr.STATE_CHANGE,y),g(!1)}(Js)}function Kp(){if(!Js){if(Xw(),!Js)throw new Ve(Z.NOT_SUPPORTED,"can not create audio context");return Js}return Js}function Qw(){return!!Js}function vh(s){if(function(){if(gC!==null)return gC;let a=Kp(),l=a.createBufferSource(),p=a.createGain(),f=a.createGain();l.connect(p),l.connect(f),l.disconnect(p);let g=!1;try{l.disconnect(p)}catch{g=!0}return l.disconnect(),gC=g,g}())return;let t=s.connect,i=s.disconnect;s.connect=(a,l,p)=>{var f;return s._inputNodes||(s._inputNodes=[]),xe(f=s._inputNodes).call(f,a)||(a instanceof AudioNode?(s._inputNodes.push(a),t.call(s,a,l,p)):t.call(s,a,l)),s},s.disconnect=(a,l,p)=>{i.call(s),a?Ji(s._inputNodes,a):s._inputNodes=[];for(let f of s._inputNodes)t.call(s,f)}}let gC=null;function Zw(s,t){let i=!1,a=1/t;if(ce("DISABLE_WEBAUDIO")){let l=window.setInterval(()=>{i?window.clearInterval(l):s(performance.now()/1e3)},1e3*a)}else{let l=Kp(),p=l.createGain();p.gain.value=0,p.connect(l.destination);let f=()=>{if(i)return void(p=null);let g=l.createOscillator();g.onended=f,g.connect(p),g.start(0),g.stop(l.currentTime+a),s(l.currentTime)};f()}return()=>{i=!0}}class $w{constructor(){P(this,"context",void 0),P(this,"analyserNode",void 0),P(this,"sourceNode",void 0),this.context=Kp(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Gs()||Id()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;let t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{let a=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(a);for(let l=0;l<t.length;++l)t[l]=a[l]/128-1}let i=oh(t).call(t,(a,l)=>a+l*l,0)/t.length;return Math.max(10*Math.log10(i)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,i;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(i=this.sourceNode)===null||i===void 0||i.connect(this.analyserNode)}catch{x.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class eb extends ri{get processSourceNode(){return this.sourceNode}set processedNode(t){var i;if(!this.isDestroyed&&this._processedNode!==t){try{var a;(a=this.sourceNode)===null||a===void 0||a.disconnect(this.outputNode)}catch{}(i=this._processedNode)===null||i===void 0||i.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),P(this,"outputNode",void 0),P(this,"outputTrack",void 0),P(this,"isPlayed",!1),P(this,"context",void 0),P(this,"audioBufferNode",void 0),P(this,"destNode",void 0),P(this,"audioOutputLevel",0),P(this,"volumeLevelAnalyser",void 0),P(this,"_processedNode",void 0),P(this,"playNode",void 0),P(this,"isDestroyed",!1),P(this,"onNoAudioInput",void 0),P(this,"isNoAudioInput",!1),P(this,"_noAudioInputCount",0),this.context=Kp(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),vh(this.outputNode),this.volumeLevelAnalyser=new $w}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=i=>{this.emit(Jo.ON_AUDIO_BUFFER,function(a){for(let l=0;l<a.outputBuffer.numberOfChannels;l+=1){let p=a.outputBuffer.getChannelData(l);for(let f=0;f<p.length;f+=1)p[f]=0}return a.inputBuffer}(i))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!zn().webAudioMediaStreamDest)throw new Ve(Z.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&mo(()=>{Wn.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Gs()||Id()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();let i=this.volumeLevelAnalyser.getAnalyserNode(),a;i.getFloatTimeDomainData?(a=new Float32Array(i.fftSize),i.getFloatTimeDomainData(a)):(a=new Uint8Array(i.fftSize),i.getByteTimeDomainData(a));let l=!1;for(let p=0;p<a.length;p++)a[p]!==0&&(l=!0);return l?(this.isNoAudioInput=!1,!0):(await Qr(200),await this.checkHasAudioInput(t?t+1:1)&&l)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,i;(t=this.processedNode)===null||t===void 0||t.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class Ig extends eb{get isFreeze(){return!1}constructor(t,i,a){var l;if(super(),P(this,"sourceNode",void 0),P(this,"track",void 0),P(this,"clonedTrack",void 0),P(this,"audioElement",void 0),P(this,"isCurrentTrackCloned",!1),P(this,"isRemoteTrack",!1),P(this,"originVolumeLevelAnalyser",void 0),P(this,"rebuildWebAudio",async()=>{if(x.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void x.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>x.info("resume success")),x.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let g=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?g.stop():this.isCurrentTrackCloned=!0;let v=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(v),vh(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let y=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(y,this.context.currentTime),vh(this.outputNode),this.emit(Jo.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=v,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new Ve(Z.UNEXPECTED_ERROR);this.track=t;let p=new MediaStream([this.track]);if(this.isRemoteTrack=!!i,this.sourceNode=this.context.createMediaStreamSource(p),vh(this.sourceNode),a){let g=a.clone();g.enabled=!0,this.clonedTrack=g,x.debug("create an unmuted track ".concat(g.id," from the original track ").concat(a.id," to get the volume"));let v=this.context.createMediaStreamSource(new MediaStream([g]));vh(v),this.originVolumeLevelAnalyser=new $w,this.originVolumeLevelAnalyser.updateSource(v)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=p;let f=En();i&&f.os===Cr.IOS&&Number((l=f.osVersion)===null||l===void 0?void 0:l.split(".")[0])<15&&(Wn.on(Wr.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(g=>{g||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;let i=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(i),vh(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Jo.UPDATE_SOURCE),this.audioElement.srcObject=i}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),Wn.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){let i=t.clone();i.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=i),x.debug("create an unmuted track ".concat(i.id," from the original track ").concat(t.id," to get the volume"));let a=this.context.createMediaStreamSource(new MediaStream([i]));vh(a),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(a)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function tb(s,t,i){let a=(p,f)=>p?typeof p!="number"?p.max||p.exact||p.ideal||p.min||f:p:f,l={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:s,maxHeight:a(t.height,1080),maxWidth:a(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(l.video.mandatory.maxFrameRate=t.frameRate.max,l.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(l.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(l)}async function PP(s,t){let i=await fa(s.mediaSource),{sourceId:a,audio:l}=await function(p){let f=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Pe((g,v)=>{let y=document.createElement("div");y.innerText="share screen",y.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let I=document.createElement("div");I.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let b=document.createElement("div");b.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",b.setAttribute("style","height: 12%;");let k=document.createElement("div");k.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let U=document.createElement("div");U.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let J=document.createElement("button");J.innerHTML="cancel",J.setAttribute("style","width: 85px;"),J.onclick=()=>{document.body.removeChild(te);let de=new Error("NotAllowedError");de.name="NotAllowedError",v(de)};let K=f,q=document.createElement("div");if(f){let de=document.createElement("input");de.setAttribute("type","checkbox");let he=document.createElement("span");de.setAttribute("style","margin-right: 6px;"),he.innerText="Share audio",de.checked=K,de.onchange=()=>{K=de.checked},q.appendChild(de),q.appendChild(he)}U.appendChild(q),U.appendChild(J),I.appendChild(b),I.appendChild(k),I.appendChild(U);let te=document.createElement("div");te.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),te.appendChild(y),te.appendChild(I),document.body.appendChild(te),p.map(de=>{if(de.id){let he=document.createElement("div");he.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let Ue=de.thumbnail;try{let{width:Re}=Ue.getSize();Re>1920&&(Ue=Ue.resize({width:1920}))}catch(Re){throw Re&&Re.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),Re}he.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+Ue.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+de.name.replace(/[\u00A0-\u9999<>\&]/g,function(Re){return"&#"+Re.charCodeAt(0)+";"})+"</span>",he.onclick=()=>{document.body.removeChild(te),g({sourceId:de.id,audio:K})},k.appendChild(he)}})})}(i,t);return await tb(a,s,l)}async function fa(s){let t=["window","screen"];s!=="application"&&s!=="window"||(t=["window"]),s==="screen"&&(t=["screen"]);let i=GA();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new Ve(Z.ELECTRON_IS_NULL);let a=null;try{var l;a=((l=i.desktopCapturer)===null||l===void 0?void 0:l.getSources({types:t}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{a=null}a&&a.then||(a=new Pe((p,f)=>{i.desktopCapturer.getSources({types:t},(g,v)=>{g?f(g):p(v)})}));try{return await a}catch(p){throw new Ve(Z.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,p.toString())}}function kP(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}let _f=new sn("safari"),Yp=!1,_a=!1;async function Xo(s,t){let i=0,a=null;for(;i<2;)try{a=await Va(s,t,i>0);break}catch(l){if(l instanceof Ve)throw x.error("[".concat(t,"] ").concat(l.toString())),l;let p=Ag(l.name||l.code||l,l.message);if(p.code===Z.MEDIA_OPTION_INVALID){x.debug("[".concat(t,"] detect media option invalid, retry")),i+=1,await Qr(500);continue}throw x.error("[".concat(t,"] ").concat(p.toString())),p}if(!a)throw new Ve(Z.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return a}async function Va(s,t,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Ve(Z.NOT_SUPPORTED,"can not find getUserMedia");i&&(s.video&&(delete s.video.width,delete s.video.height),s.screen&&(delete s.screen.width,delete s.screen.height));let a=zn(),l=new MediaStream;if(s.audioSource&&l.addTrack(s.audioSource),s.videoSource&&l.addTrack(s.videoSource),!s.audio&&!s.video&&!s.screen)return x.debug("Using Video Source/ Audio Source"),l;if(s.screen)if(GA())s.screen.sourceId?zp(l,await tb(s.screen.sourceId,s.screen,s.screenAudio)):zp(l,await PP(s.screen,s.screenAudio));else if(bp()&&s.screen.extensionId&&s.screen.mandatory){if(!a.getStreamFromExtension)throw new Ve(Z.NOT_SUPPORTED,"This browser does not support screen sharing");x.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));let k=await(f=s.screen.extensionId,g=t,new Pe((U,J)=>{try{chrome.runtime.sendMessage(f,{getStream:!0},K=>{if(!K||!K.streamId)return x.error("[".concat(g,"] No response from Chrome Plugin. Plugin not installed properly"),K),void J(new Ve(Z.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));U(K.streamId)})}catch(K){x.error("[".concat(g,"] AgoraRTC screensharing plugin is not accessible(").concat(f,")"),K.toString()),J(new Ve(Z.CHROME_PLUGIN_NOT_INSTALL))}}));s.screen.mandatory.chromeMediaSourceId=k,zp(l,await navigator.mediaDevices.getUserMedia({video:{mandatory:s.screen.mandatory}}))}else if(a.getDisplayMedia){var p;s.screen.mediaSource&&fC(s.screen.mediaSource);let k={width:s.screen.width,height:s.screen.height,frameRate:s.screen.frameRate,displaySurface:(p=s.screen.displaySurface)!==null&&p!==void 0?p:s.screen.mediaSource==="screen"?"monitor":s.screen.mediaSource},{selfBrowserSurface:U,surfaceSwitching:J,systemAudio:K}=s.screen,q={selfBrowserSurface:U,surfaceSwitching:J,systemAudio:K};!U&&delete q.selfBrowserSurface,!J&&delete q.surfaceSwitching,!K&&delete q.systemAudio,x.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:k,audio:!!s.screenAudio,controls:q}));let te=await navigator.mediaDevices.getDisplayMedia(function(de){for(var he=1;he<arguments.length;he++){var Ue=arguments[he]!=null?arguments[he]:{};he%2?kP(Object(Ue),!0).forEach(function(Re){P(de,Re,Ue[Re])}):Object.getOwnPropertyDescriptors?Object.defineProperties(de,Object.getOwnPropertyDescriptors(Ue)):kP(Object(Ue)).forEach(function(Re){Object.defineProperty(de,Re,Object.getOwnPropertyDescriptor(Ue,Re))})}return de}({video:k,audio:!!s.screenAudio},q));zp(l,te)}else{if(!Hn())throw x.error("[".concat(t,"] This browser does not support screenSharing")),new Ve(Z.NOT_SUPPORTED,"This browser does not support screen sharing");{s.screen.mediaSource&&fC(s.screen.mediaSource);let k={video:{mediaSource:s.screen.mediaSource,width:s.screen.width,height:s.screen.height,frameRate:s.screen.frameRate}};x.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(k))),zp(l,await navigator.mediaDevices.getUserMedia(k))}}var f,g;if(!s.video&&!s.audio)return l;let v={video:s.video,audio:s.audio},y=ce("MEDIA_DEVICE_CONSTRAINTS");if(y)try{typeof y=="string"&&(y=JSON.parse(y)),v=ef(v,y)}catch{}x.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(v)),En();let I,b=null;(qt()||Gs()||Jm())&&(b=await _f.lock());try{I=await navigator.mediaDevices.getUserMedia(v)}catch(k){throw b&&b(),k}return v.audio&&(Yp=!0),v.video&&(_a=!0),zp(l,I),b&&b(),l}function Ag(s,t){switch(s){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new Ve(Z.MEDIA_OPTION_INVALID,"".concat(s,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new Ve(Z.DEVICE_NOT_FOUND,"".concat(s,": ").concat(t));case"NotSupportedError":return new Ve(Z.NOT_SUPPORTED,"".concat(s,": ").concat(t));case"NotReadableError":return new Ve(Z.NOT_READABLE,"".concat(s,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new Ve(Z.PERMISSION_DENIED,"".concat(s,": ").concat(t));case"ConstraintNotSatisfiedError":return new Ve(Z.CONSTRAINT_NOT_SATISFIED,"".concat(s,": ").concat(t));default:return x.error("getUserMedia unexpected error",s),new Ve(Z.UNEXPECTED_ERROR,"".concat(s,": ").concat(t))}}function zp(s,t){let i=s.getVideoTracks()[0],a=s.getAudioTracks()[0],l=t.getVideoTracks()[0],p=t.getAudioTracks()[0];p&&(a&&s.removeTrack(a),s.addTrack(p)),l&&(i&&s.removeTrack(i),s.addTrack(l))}let Ea=new class extends ri{get state(){return this._state}set state(s){s!==this._state&&(this.emit(ml.STATE_CHANGE,s),this._state=s)}constructor(){super(),P(this,"_state",qc.IDLE),P(this,"isAccessMicrophonePermission",!1),P(this,"isAccessCameraPermission",!1),P(this,"lastAccessMicrophonePermission",!1),P(this,"lastAccessCameraPermission",!1),P(this,"checkdeviceMatched",!1),P(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(ce("ENUMERATE_DEVICES_INTERVAL")||(Zl()||ar()===Cr.HARMONY_OS)&&Ql())&&this.updateDevicesInfo()},ce("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(s=>x.error(s.toString()))}async enumerateDevices(s,t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new Ve(Z.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();let a=await navigator.mediaDevices.enumerateDevices(),l=this.checkMediaDeviceInfoIsOk(a),p=!this.isAccessMicrophonePermission&&s,f=!this.isAccessCameraPermission&&t;l.audio&&(p=!1),l.video&&(f=!1);let g=null,v=null,y=null;if(!i&&(p||f)){if(_f.isLocked&&(x.debug("[device manager] wait GUM lock"),(await _f.lock())(),x.debug("[device manager] GUM unlock")),Yp&&(p=!1,this.isAccessMicrophonePermission=!0),_a&&(f=!1,this.isAccessCameraPermission=!0),x.debug("[device manager] check media device permissions",s,t,p,f),p&&f){try{y=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(I){let b=Ag(I.name||I.code||I,I.message);if(b.code===Z.PERMISSION_DENIED)throw b;x.warning("getUserMedia failed in getDevices",b)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(p){try{g=await navigator.mediaDevices.getUserMedia({audio:s})}catch(I){let b=Ag(I.name||I.code||I,I.message);if(b.code===Z.PERMISSION_DENIED)throw b;x.warning("getUserMedia failed in getDevices",b)}this.isAccessMicrophonePermission=!0}else if(f){try{v=await navigator.mediaDevices.getUserMedia({video:t})}catch(I){let b=Ag(I.name||I.code||I,I.message);if(b.code===Z.PERMISSION_DENIED)throw b;x.warning("getUserMedia failed in getDevices",b)}this.isAccessCameraPermission=!0}x.debug("[device manager] mic permission",s,"cam permission",t)}try{let I=await navigator.mediaDevices.enumerateDevices();return g&&g.getTracks().forEach(b=>b.stop()),v&&v.getTracks().forEach(b=>b.stop()),y&&y.getTracks().forEach(b=>b.stop()),g=null,v=null,y=null,I}catch(I){return g&&g.getTracks().forEach(b=>b.stop()),v&&v.getTracks().forEach(b=>b.stop()),y&&y.getTracks().forEach(b=>b.stop()),g=null,v=null,y=null,new Ve(Z.ENUMERATE_DEVICES_FAILED,I.toString()).throw()}}async getRecordingDevices(){let s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,s)).filter(t=>t.kind==="audioinput")}async getCamerasDevices(){let s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,s)).filter(t=>t.kind==="videoinput")}async getSpeakers(){let s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,s)).filter(t=>t.kind==="audiooutput")}searchDeviceIdByName(s){let t=null;return this.deviceInfoMap.forEach(i=>{i.device.label===s&&(t=i.device.deviceId)}),t}async getDeviceById(s){let t=(await this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===s);if(!t)throw new Ve(Z.DEVICE_NOT_FOUND,"deviceId: ".concat(s));return t}async init(){this.state=qc.INITING;try{await this.updateDevicesInfo(),this.state=qc.INITEND}catch(s){throw x.warning("Device Detection functionality cannot start properly.",s.toString()),this.state=qc.IDLE,!(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")&&new Ve(Z.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),s}}async updateDevicesInfo(){let s=await this.enumerateDevices(!0,!0,!0),t=Date.now(),i=[];if(s[0]&&s[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;let l=s.find(f=>f.kind==="audioinput"&&f.deviceId==="default"),p=s.find(f=>f.kind==="audiooutput"&&f.deviceId==="default");l&&p?p.groupId===l.groupId?x.debug("[device-check] default input ".concat(l.label," and output ").concat(p.label," is the same group")):x.warning("[device-check] default input ".concat(l.label," and output ").concat(p.label," is not the same group")):x.debug("[device-check] default input or output not found")}let a=this.checkMediaDeviceInfoIsOk(s);if(s.forEach(l=>{if(!l.deviceId)return;let p=this.deviceInfoMap.get("".concat(l.kind,"_").concat(l.deviceId));if((p?p.state:"INACTIVE")!=="ACTIVE"){let f={initAt:t,updateAt:t,device:l,state:"ACTIVE"};this.deviceInfoMap.set("".concat(l.kind,"_").concat(l.deviceId),f),i.push(f)}p&&(p.updateAt=t)}),this.deviceInfoMap.forEach((l,p)=>{l.state==="ACTIVE"&&l.updateAt!==t&&(l.state="INACTIVE",i.push(l))}),this.state!==qc.INITEND)return a.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(a.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(l=>{switch(l.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(ml.RECORDING_DEVICE_CHANGED,l);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(ml.CAMERA_DEVICE_CHANGED,l);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(ml.PLAYOUT_DEVICE_CHANGED,l)}}),a.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),a.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(s){let t=s.filter(l=>l.kind==="audioinput"),i=s.filter(l=>l.kind==="videoinput"),a={audio:!1,video:!1};for(let l of t)if(l.label&&l.deviceId){a.audio=!0;break}for(let l of i)if(l.label&&l.deviceId){a.video=!0;break}return a}},SC=!1,Fa=new class extends ri{constructor(){super(...arguments),P(this,"onAutoplayFailed",void 0),P(this,"onAudioAutoplayFailed",void 0)}};function So(){if(En(),!SC){let s=t=>{t.preventDefault(),SC=!1,Op()?document.body.removeEventListener("click",s,!0):(document.body.removeEventListener("touchstart",s,!0),document.body.removeEventListener("mousedown",s,!0))};SC=!0,Op()?document.body.addEventListener("click",s,!0):(document.body.addEventListener("touchstart",s,!0),document.body.addEventListener("mousedown",s,!0)),x.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Fa.onAutoplayFailed?Fa.onAutoplayFailed():Fa.onAudioAutoplayFailed?x.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):x.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Fa.emit("autoplay-failed")}}function er(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function nb(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?er(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):er(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function wg(s,t,i,a){if(!s)return;let l=Tt.getBaseInfoBySessionId(s);if(!l)return;let p=l.info,f=Date.now(),g=nb(nb({},p),{},{vid:p.vid===void 0?0:Number(p.vid),lts:f,elapse:f-l.startTime,cbRegistered:Fa.onAutoplayFailed||Fa.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:t,trackId:a,extend:void 0});Tt.send({type:ai.AUTOPLAY_FAILED,data:g},!0)}let LP=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Po=new class{constructor(){P(this,"onAutoplayFailed",void 0),P(this,"elementMap",new Map),P(this,"elementStateMap",new Map),P(this,"elementsNeedToResume",[]),P(this,"sinkIdMap",new Map),P(this,"autoResumeAfterInterruption",s=>{Array.from(this.elementMap.entries()).forEach(t=>{let[i,a]=t,l=this.elementStateMap.get(i),p=a.srcObject.getAudioTracks()[0],f=p&&p.readyState;if(x.debug("resume after interrupted, ele: ".concat(l," audio: ").concat(f," ").concat(s)),f==="live"){if(s)return a.pause(),void a.play();if(Wn.curState==="running")return Ln()?(a.pause(),void a.play()):void(l&&l==="paused"&&a.play())}})}),P(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(s=>{let[t,i]=s,a=i.srcObject.getAudioTracks()[0];a&&a.readyState==="live"&&(x.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())})}),this.autoResumeAudioElement(),Wn.on(Wr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Wn.on(Wr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Wn.on(Wr.STATE_CHANGE,()=>{Gs()&&Wn.prevState==="suspended"&&Wn.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(s,t){let i=this.elementMap.get(s);if(this.sinkIdMap.set(s,t),i)try{await i.setSinkId(t)}catch(a){throw new Ve(Z.PERMISSION_DENIED,"can not set sink id: "+a.toString())}}play(s,t,i,a){if(this.elementMap.has(t))return;let l=document.createElement("audio");l.autoplay=!0,l.srcObject=new MediaStream([s]),this.bindAudioElementEvents(t,l),this.elementMap.set(t,l),this.elementStateMap.set(t,di.INIT),this.setVolume(t,i);let p=this.sinkIdMap.get(t);if(p)try{l.setSinkId(p).catch(g=>{x.warning("[".concat(t,"] set sink id failed"),g.toString())})}catch(g){x.warning("[".concat(t,"] set sink id failed"),g.toString())}let f=l.play();f&&f.then&&f.catch(g=>{a&&wg(a,"audio",g.message,t),x.warning("audio element play warning",g.toString()),this.elementMap.has(t)&&g.name==="NotAllowedError"&&(x.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(l),mo(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),So()}))})}updateTrack(s,t){let i=this.elementMap.get(s);i&&(i.srcObject=new MediaStream([t]))}isPlaying(s){return this.elementMap.has(s)&&this.elementStateMap.get(s)==="playing"}setVolume(s,t){let i=this.elementMap.get(s);i&&(t=Math.max(0,Math.min(100,t)),i.volume=t/100)}stop(s){let t=this.elementMap.get(s);if(this.sinkIdMap.delete(s),!t)return;let i=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(i,1),t.srcObject=null,t.remove(),this.elementMap.delete(s),this.elementStateMap.delete(s)}bindAudioElementEvents(s,t){LP.forEach(i=>{t.addEventListener(i,a=>{let l=this.elementStateMap.get(s),p=a.type==="pause"?"paused":a.type;if(x.debug("[".concat(s,"] audio-element-status change ").concat(l," => ").concat(p)),a.type==="error"){let f=t==null?void 0:t.error;f&&x.error("[".concat(s,"] media error, code: ").concat(f.code,", message: ").concat(f.message))}this.elementStateMap.set(s,p)})})}getPlayerState(s){return this.elementStateMap.get(s)||"uninit"}autoResumeAudioElement(){let s=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(i=>{x.debug("Auto resume audio element success")}).catch(i=>{x.warning("Auto resume audio element failed!",i)})}),this.elementsNeedToResume=[]};new Pe(t=>{document.body?t():window.addEventListener("load",()=>t())}).then(()=>{Op()?document.body.addEventListener("click",s,!0):(document.body.addEventListener("touchstart",s,!0),document.body.addEventListener("mousedown",s,!0))})}};function tr(){return function(s,t,i){let a=i.value;return typeof a=="function"&&(i.value=function(){this._isClosed&&new Ve(Z.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",x);for(var l=arguments.length,p=new Array(l),f=0;f<l;f++)p[f]=arguments[f];let g=a.apply(this,p);return g instanceof Pe?new Pe((v,y)=>{g.then(v).catch(y)}):g}),i}}function ib(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Ef(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ib(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):ib(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class MP extends ri{constructor(t){super(),P(this,"name","VideoProcessorDestination"),P(this,"ID","0"),P(this,"_source",void 0),P(this,"videoContext",void 0),P(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new Ve(Z.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new Ve(Z.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit($i.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit($i.ON_TRACK,void 0)}}class rb extends ri{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,i){super(),P(this,"constraintsMap",new Map),P(this,"statsRegistry",[]),P(this,"usageRegistry",[]),P(this,"trackId",void 0),P(this,"direction",void 0),P(this,"_chained",!1),this.trackId=t,this.direction=i}async getConstraints(){return await In(this,go.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,i){var a;return x.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(i,t),fn(this,go.REQUEST_UPDATE_CONSTRAINTS,Array.from(hc(a=this.constraintsMap).call(a)))}async requestRevertConstraints(t){var i;if(this.constraintsMap.has(t))return x.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),fn(this,go.REQUEST_UPDATE_CONSTRAINTS,Array.from(hc(i=this.constraintsMap).call(i)))}registerStats(t,i,a){this.statsRegistry.find(l=>l.processorID===t.ID&&l.processorName===t.name&&l.type===i)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:i,cb:a})}unregisterStats(t,i){let a=this.statsRegistry.findIndex(l=>l.processorID===t.ID&&l.processorName===t.name&&l.type===i);a!==-1&&this.statsRegistry.splice(a,1)}gatherStats(){let t=[];for(let{processorID:i,processorName:a,type:l,cb:p}of this.statsRegistry)try{let f=p();t.push({processorID:i,processorName:a,type:l,stats:f})}catch(f){x.error(new Ve(Z.UNEXPECTED_ERROR,f.message))}return t}registerUsage(t,i){this.usageRegistry.find(a=>a.processorID===t.ID&&a.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:i})}unregisterUsage(t){let i=this.usageRegistry.findIndex(a=>a.processorID===t.ID&&a.processorName===t.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){let t=[];if(!this.chained)return[];for(let{cb:i}of this.usageRegistry)try{let a=i();a instanceof Pe&&(a=await a),t.push(Ef(Ef({},a),{},{direction:this.direction}))}catch(a){x.error("gather extension usage error",a)}return t}getDirection(){return this.direction}}class gf extends ri{constructor(t){super(),P(this,"name","AudioProcessorDestination"),P(this,"ID","0"),P(this,"inputTrack",void 0),P(this,"inputNode",void 0),P(this,"audioProcessorContext",void 0),P(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new Ve(Z.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new Ve(Z.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit($i.ON_TRACK,void 0),this.emit($i.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit($i.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit($i.ON_NODE,this.inputNode))}}class xn extends ri{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,i,a){super(),P(this,"constraintsMap",new Map),P(this,"statsRegistry",[]),P(this,"audioContext",void 0),P(this,"trackId",void 0),P(this,"direction",void 0),P(this,"usageRegistry",[]),P(this,"_chained",!1),this.audioContext=t,this.trackId=i,this.direction=a}async getConstraints(){return In(this,go.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,i){var a;return x.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(i,t),fn(this,go.REQUEST_UPDATE_CONSTRAINTS,Array.from(hc(a=this.constraintsMap).call(a)))}async requestRevertConstraints(t){var i;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),fn(this,go.REQUEST_UPDATE_CONSTRAINTS,Array.from(hc(i=this.constraintsMap).call(i)))}registerStats(t,i,a){this.statsRegistry.find(l=>l.processorID===t.ID&&l.processorName===t.name&&l.type===i)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:i,cb:a})}unregisterStats(t,i){let a=this.statsRegistry.findIndex(l=>l.processorID===t.ID&&l.processorName===t.name&&l.type===i);a!==-1&&this.statsRegistry.splice(a,1)}gatherStats(){let t=[];for(let{processorID:i,processorName:a,type:l,cb:p}of this.statsRegistry)try{let f=p();t.push({processorID:i,processorName:a,type:l,stats:f})}catch(f){x.error(new Ve(Z.UNEXPECTED_ERROR,f.message))}return t}registerUsage(t,i){this.usageRegistry.find(a=>a.processorID===t.ID&&a.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:i})}unregisterUsage(t){let i=this.usageRegistry.findIndex(a=>a.processorID===t.ID&&a.processorName===t.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){let t=[];if(!this.chained)return[];for(let{cb:i}of this.usageRegistry)try{let a=i();a instanceof Pe&&(a=await a),t.push(Ef(Ef({},a),{},{direction:this.direction}))}catch(a){x.error("gather extension usage error",a)}return t}getDirection(){return this.direction}}class hu extends ri{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),P(this,"context",void 0),P(this,"processSourceNode",void 0),P(this,"outputTrack",void 0),P(this,"processedNode",void 0),P(this,"clonedTrack",void 0),P(this,"outputNode",void 0),this.outputNode=new Rh}setVolume(){}createOutputTrack(){throw new Ve(Z.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class Rh{disconnect(){}connect(){}}let Yi=null;class TC{constructor(){P(this,"state","open"),P(this,"trigger",void 0),P(this,"tasks",[]),x.debug("[macro-task-queue] is created."),this.trigger=window.setTimeout(()=>{this.state="closed",x.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map(t=>t.key),"]")),this.trigger=void 0,this.tasks.forEach(t=>{let{func:i}=t;return i()}),this.tasks.length=0,x.debug("[macro-task-queue] is closed.")})}enqueue(t,i){this.state!=="closed"&&(this.tasks.push({key:t,func:i}),x.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat(typeof t=="string"?t:"")))}runTask(t){if(this.state==="closed")return;let i=this.tasks.findIndex(a=>a.key===t);if(i!==-1){let a=this.tasks.splice(i,1);x.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat(typeof t=="string"?t:"")),a[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,x.debug("[macro-task-queue] is closed."))}}function CC(s){return function(t,i,a){var l;let p=(l=a.value)!==null&&l!==void 0?l:a.get,f=function(){Yi&&Yi.state==="open"&&Yi.runTask(s);for(var g=arguments.length,v=new Array(g),y=0;y<g;y++)v[y]=arguments[y];return p==null?void 0:p.apply(this,...v)};return a.value?a.value=f:a.get=f,a}}function UP(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function vC(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?UP(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):UP(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class Vn extends tn{get _source(){return this._trackSource}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get processorDestination(){return this._processorDestination}set processorDestination(t){this._processorDestination=t}get isPlaying(){return this._useAudioElement?Po.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,i,a,l,p){super(t,a),P(this,"trackMediaType","audio"),P(this,"_encoderConfig",void 0),P(this,"_trackSource",void 0),P(this,"_enabled",!0),P(this,"_volume",100),P(this,"_useAudioElement",!1),P(this,"_bypassWebAudio",!1),P(this,"processor",void 0),P(this,"_processorContext",void 0),P(this,"_processorDestination",void 0),P(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=i,this._getOriginVolumeLevel=!!l;let f=()=>{this.processorContext=new xn(this._source.context,this.getTrackId(),"local"),this.processorDestination=new gf(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Jo.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})},g=p&&qt()&&!Qw();ce("DISABLE_WEBAUDIO")?(this._source=new hu,this._useAudioElement=!0,this._bypassWebAudio=!0):g?this._source=new hu:(this._source=new Ig(t,!1,this._getOriginVolumeLevel?t:void 0),ce("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),f(),!ce("DISABLE_WEBAUDIO")&&g&&(Yi||(Yi=new TC),Yi).enqueue("INIT_WEBAUDIO",()=>{this._source=new Ig(t,!1,this._getOriginVolumeLevel?t:void 0),ce("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),f(),this.emit(yg.UPDATE_TRACK_SOURCE)})}setVolume(t){bn(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&Po.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void x.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let i=this._source.createOutputTrack();this._mediaStreamTrack!==i&&(this._mediaStreamTrack=i,fn(this,ut.NEED_REPLACE_TRACK,this).then(()=>{x.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(a=>{x.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),a)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!bp()&&ce("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new Ve(Z.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Po.setSinkID(this.getTrackId(),t)}async setEnabled(t,i,a){return this._setEnabled(t,i,a)}async _setEnabled(t,i,a){if(!a){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(x.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{a||(this._enabled=!0),await fn(this,ut.NEED_ENABLE_TRACK,this),x.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(l){throw a||(this._enabled=!1),x.error("[".concat(this.getTrackId(),"] setEnabled to true error"),l.toString()),l}}else{this._originMediaStreamTrack.enabled=!1,a||(this._enabled=!1);try{await fn(this,ut.NEED_DISABLE_TRACK,this)}catch(l){throw a||(this._enabled=!0),x.error("[".concat(this.getTrackId(),"] setEnabled to false error"),l.toString()),l}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,x.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await fn(this,ut.NEED_MUTE_TRACK,this):await fn(this,ut.NEED_UNMUTE_TRACK,this))}getStats(){return eg(()=>{x.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),us(this,ut.GET_STATS)||vC({},ys)}setAudioFrameCallback(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Jo.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(i),this._source.removeAllListeners(Jo.ON_AUDIO_BUFFER),this._source.on(Jo.ON_AUDIO_BUFFER,a=>t(a))}play(){x.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(x.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Po.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){x.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Po.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];x.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Po.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,i){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:t,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await fn(this,ut.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return Pe.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new Ve(Z.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new Ve(Z.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;let i=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,i.reset()}bindProcessorDestinationEvents(){this.processorDestination.on($i.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await fn(this,ut.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await fn(this,ut.NEED_REPLACE_TRACK,this))}),this.processorDestination.on($i.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners($i.ON_TRACK),this.processorDestination.removeAllListeners($i.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(go.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(go.REQUEST_CONSTRAINTS)}}Be([CC("INIT_WEBAUDIO"),Y("design:type",Object),Y("design:paramtypes",[Object])],Vn.prototype,"_source",null),Be([CC("INIT_WEBAUDIO"),Y("design:type",xn),Y("design:paramtypes",[xn])],Vn.prototype,"processorContext",null),Be([CC("INIT_WEBAUDIO"),Y("design:type",gf),Y("design:paramtypes",[gf])],Vn.prototype,"processorDestination",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t],throttleTime:300}),Y("design:type",Function),Y("design:paramtypes",[Number]),Y("design:returntype",void 0)],Vn.prototype,"setVolume",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Vn.prototype,"setPlaybackDevice",null),Be([Bc("LocalAudioTrack","_enabledMutex"),bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Boolean,Object,Boolean]),Y("design:returntype",Pe)],Vn.prototype,"setEnabled",null),Be([Bc("LocalAudioTrack","_enabledMutex"),bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Boolean]),Y("design:returntype",Pe)],Vn.prototype,"setMuted",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Object)],Vn.prototype,"getStats",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[Object,Number]),Y("design:returntype",void 0)],Vn.prototype,"setAudioFrameCallback",null),Be([bt({argsMap:s=>[s.getTrackId()]}),tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Vn.prototype,"play",null),Be([bt({argsMap:s=>[s.getTrackId()]}),tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Vn.prototype,"stop",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Vn.prototype,"close",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t.name]}),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Object)],Vn.prototype,"pipe",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Vn.prototype,"unpipe",null);class pu extends Vn{get __className__(){return"MicrophoneAudioTrack"}constructor(t,i,a,l){super(t,i.encoderConfig?Dd(i.encoderConfig):{},l,ce("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),P(this,"_config",void 0),P(this,"_deviceName","default"),P(this,"_constraints",void 0),P(this,"_originalConstraints",void 0),P(this,"_enabled",!0),this._config=i,this._constraints=a,this._originalConstraints=a,this._deviceName=t.label,typeof i.bypassWebAudio=="boolean"&&(this._bypassWebAudio=i.bypassWebAudio),(Ln()||Ds())&&Wn.bindInterruptDetectorTrack(this),this.on(yg.UPDATE_TRACK_SOURCE,()=>{this.bindProcessorContextEvents()}),Qw()&&this.bindProcessorContextEvents()}async setDevice(t){if(x.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{let i=await Ea.getDeviceById(t),a={};a.audio=vC({},this._constraints),a.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let l=null;try{l=await Xo(a,this.getTrackId())}catch(p){throw x.error("[".concat(this.getTrackId(),"] setDevice failed"),p.toString()),l=await Xo({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(l.getAudioTracks()[0],!1),p}await this._updateOriginMediaStreamTrack(l.getAudioTracks()[0],!1),this._deviceName=i.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(i){throw x.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{let i=await Ea.getDeviceById(t);this._deviceName=i.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(i){throw x.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}x.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,i,a){if(i)return x.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!a){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(x.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){var l;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(l=this._source.clonedTrack)===null||l===void 0||l.stop(),a||(this._enabled=!1);try{await fn(this,ut.NEED_DISABLE_TRACK,this)}catch(g){throw x.error("[".concat(this.getTrackId(),"] setEnabled false failed"),g.toString()),g}return}let p=vC({},this._constraints),f=Ea.searchDeviceIdByName(this._deviceName);f&&!p.deviceId&&(p.deviceId=f);try{a||(this._enabled=!0);let g=await Xo({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(g.getAudioTracks()[0],!1),await fn(this,ut.NEED_ENABLE_TRACK,this)}catch(g){throw a||(this._enabled=!1),x.error("[".concat(this.getTrackId(),"] setEnabled true failed"),g.toString()),g}x.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Ln()||Ds())&&Wn.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Gs()||Id())&&this._enabled&&!this._isClosed&&Wn.duringInterruption){let t=async()=>{Wn.off(Wr.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(x.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Wn.on(Wr.IOS_INTERRUPTION_END,t)}else x.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(pl.TRACK_ENDED)}async renewMediaStreamTrack(t){let i=t||this._constraints,a=Ea.searchDeviceIdByName(this._deviceName);if(a&&!i.deviceId&&(i.deviceId=a),this._constraints=i,this._enabled){this._originMediaStreamTrack.stop();let l=await Xo({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(l.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(go.REQUEST_UPDATE_CONSTRAINTS,async(t,i,a)=>{try{let l=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(l),i()}catch(l){a(l)}}),this.processorContext.on(go.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}Be([bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],pu.prototype,"setDevice",null),Be([Bc("MicrophoneAudioTrack","_enabledMutex"),bt({argsMap:(s,t,i)=>[s.getTrackId(),t,i]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Boolean,Boolean,Boolean]),Y("design:returntype",Pe)],pu.prototype,"setEnabled",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],pu.prototype,"close",null);class mu extends Vn{get __className__(){return"BufferSourceAudioTrack"}constructor(t,i,a,l){super(i.createOutputTrack(),a,l),P(this,"source",void 0),P(this,"_bufferSource",void 0),this.source=t,this._bufferSource=i,this._bufferSource.on(Jo.AUDIO_SOURCE_STATE_CHANGE,p=>{this.safeEmit(pl.SOURCE_STATE_CHANGE,p)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){bn(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}Be([bt({argsMap:(s,t)=>[s.getTrackId(),t,s.duration]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",void 0)],mu.prototype,"startProcessAudioBuffer",null),Be([bt({argsMap:s=>[s.getTrackId()]}),tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],mu.prototype,"pauseProcessAudioBuffer",null),Be([bt({argsMap:s=>[s.getTrackId()]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Number]),Y("design:returntype",void 0)],mu.prototype,"seekAudioBuffer",null),Be([bt({argsMap:s=>[s.getTrackId()]}),tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],mu.prototype,"resumeProcessAudioBuffer",null),Be([bt({argsMap:s=>[s.getTrackId()]}),tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],mu.prototype,"stopProcessAudioBuffer",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],mu.prototype,"close",null),Be([bt({argsMap:s=>[s.getTrackId()]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Number]),Y("design:returntype",void 0)],mu.prototype,"setAudioBufferPlaybackSpeed",null);class lr extends Vn{get __className__(){return"MixingAudioTrack"}get isActive(){for(let t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){let t=Kp().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,si(8,"track-mix-")),P(this,"trackList",void 0),P(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(x.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):x.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){x.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}Ji(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){let t={};this.trackList.forEach(i=>{i._encoderConfig&&((i._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=i._encoderConfig.bitrate),(i._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=i._encoderConfig.sampleRate),(i._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=i._encoderConfig.sampleSize),i._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(i=>{i instanceof lr?i.emit(Sh.TRANSCEIVER_UPDATED,t):i._updateRtpTransceiver(t)}))}}function bg(s){let t={};s.facingMode&&(t.facingMode=s.facingMode),s.cameraId&&(t.deviceId={exact:s.cameraId});let i=ha(s.encoderConfig);return i.width!=null&&(t.width=i.width),i.height!=null&&(t.height=i.height),!jA()&&i.frameRate&&(t.frameRate=i.frameRate),En().name===Ee.EDGE&&typeof t.frameRate=="object"&&(t.frameRate.max=60),Hn()&&(t.frameRate={ideal:30,max:30}),t}function RC(s){let t={};if(jA()||(s.AGC!==void 0&&(t.autoGainControl=s.AGC),s.AEC!==void 0&&(t.echoCancellation=s.AEC),s.ANS!==void 0&&(t.noiseSuppression=s.ANS,bp()&&s.ANS&&(t.googHighpassFilter=s.ANS))),s.encoderConfig){let i=Dd(s.encoderConfig);t.channelCount=i.stereo?2:1,t.sampleRate=i.sampleRate,t.sampleSize=i.sampleSize}return s.microphoneId&&(t.deviceId={exact:s.microphoneId}),Zl()&&(t.sampleRate=void 0),t}class xP extends eb{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(Jo.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),P(this,"audioBuffer",void 0),P(this,"sourceNode",void 0),P(this,"startPlayTime",0),P(this,"startPlayOffset",0),P(this,"pausePlayTime",0),P(this,"options",void 0),P(this,"currentLoopCount",0),P(this,"currentPlaybackSpeed",100),P(this,"_currentState","stopped"),this.audioBuffer=t,this.options=i,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):x.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){let t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}let sb=new Map;async function VP(s,t){let i=null;if(typeof s=="string"){let l=sb.get(s);if(l)return x.debug("use cached audio resource: ",s),l;try{i=(await ca(()=>mr.get(s,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(p){throw new Ve(Z.FETCH_AUDIO_FILE_FAILED,p.toString())}}else i=await new Pe((l,p)=>{let f=new FileReader;f.onload=g=>{g.target?l(g.target.result):p(new Ve(Z.READ_LOCAL_AUDIO_FILE_ERROR))},f.onerror=()=>{p(new Ve(Z.READ_LOCAL_AUDIO_FILE_ERROR))},f.readAsArrayBuffer(s)});let a=await function(l){let p=Kp();return new Pe((f,g)=>{p.decodeAudioData(l,v=>{f(v)},v=>{g(new Ve(Z.DECODE_AUDIO_FILE_FAILED,v.toString()))})})}(i);return typeof s=="string"&&t&&sb.set(s,a),a}let ob=s=>{let t=document.createElement("canvas");return t.width=2,t.height=2,new Pe((i,a)=>{t.toBlob(async l=>{if(t.remove(),l){let p=await ab(l);i({buffer:p,width:t.width,height:t.height})}else a(new Ve(Z.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},s,1)})},ab=async s=>{let t=await s.arrayBuffer();return new Uint8Array(t)},fl=new class extends ri{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),P(this,"_lastHiddenTime",0),P(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),x.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};function ga(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function on(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ga(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):ga(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class _l{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(t){t!==this._videoElementStatus&&(x.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}constructor(t){P(this,"trackId",void 0),P(this,"config",void 0),P(this,"onFirstVideoFrameDecoded",void 0),P(this,"freezeTimeCounterList",[]),P(this,"renderFreezeAccTime",0),P(this,"isKeepLastFrame",!1),P(this,"timeUpdatedCount",0),P(this,"freezeTime",0),P(this,"playbackTime",0),P(this,"lastTimeUpdatedTime",0),P(this,"autoplayFailed",!1),P(this,"videoTrack",void 0),P(this,"videoElement",void 0),P(this,"cacheVideoElement",void 0),P(this,"videoElementCheckInterval",void 0),P(this,"_videoElementStatus",di.NONE),P(this,"isGettingVideoDimensions",!1),P(this,"startGetVideoDimensions",()=>{let i=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return x.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(i,500)};!this.isGettingVideoDimensions&&i()}),P(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Wn.curState==="running"&&(x.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Pn())),DT()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),P(this,"handleVideoEvents",i=>{switch(i.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=di.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=di.CANPLAY;break;case"stalled":this.videoElementStatus=di.STALLED;break;case"suspend":this.videoElementStatus=di.SUSPEND;break;case"pause":this.videoElementStatus=di.PAUSED,Gs()||Id()||qt()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(x.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=di.WAITING;break;case"abort":this.videoElementStatus=di.ABORT;break;case"ended":this.videoElementStatus=di.ENDED;break;case"emptied":this.videoElementStatus=di.EMPTIED;break;case"error":{this.videoElementStatus=di.ERROR;let a=this.videoElement.error;a&&x.error("[".concat(this.trackId,"] media error, code: ").concat(a.code,", message: ").concat(a.message));break}case"timeupdate":{let a=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=a);let l=a-this.lastTimeUpdatedTime,p=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=a,fl.lastVisibleTime<fl.lastHiddenTime||p<fl.lastHiddenTime||p<fl.lastVisibleTime)return;for(l>ce("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=l),this.playbackTime+=l;this.playbackTime>=6e3;){this.playbackTime-=6e3;let f=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(f),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),P(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(x.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Pn())),DT()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),Wn.on(Wr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Wn.on(Wr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){let i=this.videoElement.play();i&&i.catch&&i.catch(l=>{t&&wg(t,"video",l.message,this.trackId),l.name==="NotAllowedError"?(x.warning("detected video element autoplay failed",l),this.autoplayFailed=!0,this.handleAutoPlayFailed()):x.warning("[".concat(this.trackId,"] play warning: "),l)});let a=En();if((a.name==="Safari"&&Number(a.version)===15||Ln())&&i&&i.then){let l=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};i.then(l).catch(l)}}getCurrentFrame(){let t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;let i=t.getContext("2d");if(!i)return x.error("create canvas context failed!"),new ImageData(2,2);i.drawImage(this.videoElement,0,0,t.width,t.height);let a=i.getImageData(0,0,t.width,t.height);return t.remove(),a}async getCurrentFrameToUint8Array(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,a=document.createElement("canvas");a.width=this.videoElement.videoWidth,a.height=this.videoElement.videoHeight;let l=a.getContext("2d");return l?(l.drawImage(this.videoElement,0,0,a.width,a.height),new Pe((p,f)=>{a.toBlob(async g=>{if(a.remove(),g){let v=await ab(g);p({buffer:v,width:a.width,height:a.height})}else f(new Ve(Z.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,i<0?.1:i>1?1:i)})):await ob(t)}destroy(){Wn.off(Wr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Wn.off(Wr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=di.INIT,!this.videoElementCheckInterval&&(cb.forEach(p=>{this.videoElement.addEventListener(p,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(p){return p!==document.body&&document.body.contains(p)})(this.videoElement)||(this.videoElementStatus=di.DESTROYED)},1e3),ce("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,i;let p,f=(g,v)=>{if(this.videoElementStatus===di.PLAYING){if(p){let b=v.presentationTime-p.presentationTime;b>ce("VIDEO_FREEZE_DURATION")&&fl.lastVisibleTime>=fl.lastHiddenTime&&p.timestamp>fl.lastVisibleTime&&p.timestamp>fl.lastHiddenTime&&(this.renderFreezeAccTime+=b)}p=on(on({},v),{},{timestamp:g})}var y,I;ce("ENABLE_VIDEO_FRAME_CALLBACK")&&((y=(I=this.videoElement).requestVideoFrameCallback)===null||y===void 0||y.call(I,f))};(t=(i=this.videoElement).requestVideoFrameCallback)===null||t===void 0||t.call(i,f)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Zl()&&(this.videoElement.poster="noposter");let a=En();a.name==="Safari"&&Number(a.version)===15||Ln()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Hn()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Hn()&&this.videoElement.load());let l=this.videoElement.play();l!==void 0&&l.catch(p=>{x.debug("[".concat(this.trackId,"] playback interrupted"),p.toString())})}resetVideoElement(){cb.forEach(t=>{this.videoElement&&this.videoElement.removeEventListener(t,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=di.NONE}handleAutoPlayFailed(){let t=i=>{i.preventDefault(),this.videoElement.play().then(()=>{x.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(a=>{x.error(a)}),this.autoplayFailed=!1,Op()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};Op()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),So()}}let cb=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class Og extends _l{constructor(t){super(t),P(this,"container",void 0),P(this,"slot",void 0),this.slot=t.element,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;let i=t.element;i!==this.slot&&(this.destroy(),this.slot=i),this.createElements()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var i;(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var i;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,a):await ob(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",ce("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function yC(s){return new Pe((t,i)=>{let a=!1,l=document.createElement("video");l.setAttribute("autoplay",""),l.setAttribute("muted",""),l.muted=!0,l.autoplay=!0,l.setAttribute("playsinline",""),l.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(l);let p=Gs()?"canplay":"playing";l.addEventListener(p,()=>{let f=l.videoWidth,g=l.videoHeight;!f&&Hn()||(a=!0,l.srcObject=null,l.remove(),t([f,g]))}),l.srcObject=new MediaStream([s]),l.play().catch($m),setTimeout(()=>{a||(l.srcObject=null,l.remove(),t([l.videoWidth,l.videoHeight]))},4e3)})}let FP=async(s,t,i)=>{let a=function(f){let g=[];for(let v=0;v<f.length;v+=2)g.push(parseInt(f.slice(v,v+2),16));return Uint8Array.from(g)}(function(f){let g="0123456789abcdef";function v(Xe){let nt,Vt="";for(nt=0;nt<=3;nt++)Vt+=g.charAt(Xe>>8*nt+4&15)+g.charAt(Xe>>8*nt&15);return Vt}function y(Xe,nt){let Vt=(65535&Xe)+(65535&nt);return(Xe>>16)+(nt>>16)+(Vt>>16)<<16|65535&Vt}function I(Xe,nt,Vt,rn,ui,Ki){return y(function(_i,Ia){return _i<<Ia|_i>>>32-Ia}(y(y(nt,Xe),y(rn,Ki)),ui),Vt)}function b(Xe,nt,Vt,rn,ui,Ki,_i){return I(nt&Vt|~nt&rn,Xe,nt,ui,Ki,_i)}function k(Xe,nt,Vt,rn,ui,Ki,_i){return I(nt&rn|Vt&~rn,Xe,nt,ui,Ki,_i)}function U(Xe,nt,Vt,rn,ui,Ki,_i){return I(nt^Vt^rn,Xe,nt,ui,Ki,_i)}function J(Xe,nt,Vt,rn,ui,Ki,_i){return I(Vt^(nt|~rn),Xe,nt,ui,Ki,_i)}let K=function(Xe){let nt,Vt=1+(Xe.length+8>>6),rn=new Array(16*Vt);for(nt=0;nt<16*Vt;nt++)rn[nt]=0;for(nt=0;nt<Xe.length;nt++)rn[nt>>2]|=Xe.charCodeAt(nt)<<nt%4*8;return rn[nt>>2]|=128<<nt%4*8,rn[16*Vt-2]=8*Xe.length,rn}(f),q,te,de,he,Ue,Re=1732584193,Ie=-271733879,De=-1732584194,Ne=271733878;for(q=0;q<K.length;q+=16)te=Re,de=Ie,he=De,Ue=Ne,Re=b(Re,Ie,De,Ne,K[q+0],7,-680876936),Ne=b(Ne,Re,Ie,De,K[q+1],12,-389564586),De=b(De,Ne,Re,Ie,K[q+2],17,606105819),Ie=b(Ie,De,Ne,Re,K[q+3],22,-1044525330),Re=b(Re,Ie,De,Ne,K[q+4],7,-176418897),Ne=b(Ne,Re,Ie,De,K[q+5],12,1200080426),De=b(De,Ne,Re,Ie,K[q+6],17,-1473231341),Ie=b(Ie,De,Ne,Re,K[q+7],22,-45705983),Re=b(Re,Ie,De,Ne,K[q+8],7,1770035416),Ne=b(Ne,Re,Ie,De,K[q+9],12,-1958414417),De=b(De,Ne,Re,Ie,K[q+10],17,-42063),Ie=b(Ie,De,Ne,Re,K[q+11],22,-1990404162),Re=b(Re,Ie,De,Ne,K[q+12],7,1804603682),Ne=b(Ne,Re,Ie,De,K[q+13],12,-40341101),De=b(De,Ne,Re,Ie,K[q+14],17,-1502002290),Ie=b(Ie,De,Ne,Re,K[q+15],22,1236535329),Re=k(Re,Ie,De,Ne,K[q+1],5,-165796510),Ne=k(Ne,Re,Ie,De,K[q+6],9,-1069501632),De=k(De,Ne,Re,Ie,K[q+11],14,643717713),Ie=k(Ie,De,Ne,Re,K[q+0],20,-373897302),Re=k(Re,Ie,De,Ne,K[q+5],5,-701558691),Ne=k(Ne,Re,Ie,De,K[q+10],9,38016083),De=k(De,Ne,Re,Ie,K[q+15],14,-660478335),Ie=k(Ie,De,Ne,Re,K[q+4],20,-405537848),Re=k(Re,Ie,De,Ne,K[q+9],5,568446438),Ne=k(Ne,Re,Ie,De,K[q+14],9,-1019803690),De=k(De,Ne,Re,Ie,K[q+3],14,-187363961),Ie=k(Ie,De,Ne,Re,K[q+8],20,1163531501),Re=k(Re,Ie,De,Ne,K[q+13],5,-1444681467),Ne=k(Ne,Re,Ie,De,K[q+2],9,-51403784),De=k(De,Ne,Re,Ie,K[q+7],14,1735328473),Ie=k(Ie,De,Ne,Re,K[q+12],20,-1926607734),Re=U(Re,Ie,De,Ne,K[q+5],4,-378558),Ne=U(Ne,Re,Ie,De,K[q+8],11,-2022574463),De=U(De,Ne,Re,Ie,K[q+11],16,1839030562),Ie=U(Ie,De,Ne,Re,K[q+14],23,-35309556),Re=U(Re,Ie,De,Ne,K[q+1],4,-1530992060),Ne=U(Ne,Re,Ie,De,K[q+4],11,1272893353),De=U(De,Ne,Re,Ie,K[q+7],16,-155497632),Ie=U(Ie,De,Ne,Re,K[q+10],23,-1094730640),Re=U(Re,Ie,De,Ne,K[q+13],4,681279174),Ne=U(Ne,Re,Ie,De,K[q+0],11,-358537222),De=U(De,Ne,Re,Ie,K[q+3],16,-722521979),Ie=U(Ie,De,Ne,Re,K[q+6],23,76029189),Re=U(Re,Ie,De,Ne,K[q+9],4,-640364487),Ne=U(Ne,Re,Ie,De,K[q+12],11,-421815835),De=U(De,Ne,Re,Ie,K[q+15],16,530742520),Ie=U(Ie,De,Ne,Re,K[q+2],23,-995338651),Re=J(Re,Ie,De,Ne,K[q+0],6,-198630844),Ne=J(Ne,Re,Ie,De,K[q+7],10,1126891415),De=J(De,Ne,Re,Ie,K[q+14],15,-1416354905),Ie=J(Ie,De,Ne,Re,K[q+5],21,-57434055),Re=J(Re,Ie,De,Ne,K[q+12],6,1700485571),Ne=J(Ne,Re,Ie,De,K[q+3],10,-1894986606),De=J(De,Ne,Re,Ie,K[q+10],15,-1051523),Ie=J(Ie,De,Ne,Re,K[q+1],21,-2054922799),Re=J(Re,Ie,De,Ne,K[q+8],6,1873313359),Ne=J(Ne,Re,Ie,De,K[q+15],10,-30611744),De=J(De,Ne,Re,Ie,K[q+6],15,-1560198380),Ie=J(Ie,De,Ne,Re,K[q+13],21,1309151649),Re=J(Re,Ie,De,Ne,K[q+4],6,-145523070),Ne=J(Ne,Re,Ie,De,K[q+11],10,-1120210379),De=J(De,Ne,Re,Ie,K[q+2],15,718787259),Ie=J(Ie,De,Ne,Re,K[q+9],21,-343485551),Re=y(Re,te),Ie=y(Ie,de),De=y(De,he),Ne=y(Ne,Ue);return v(Re)+v(Ie)+v(De)+v(Ne)}(""+t+i)).slice(0,16),l=a.slice(0,12),p=await window.crypto.subtle.importKey("raw",a,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:l},p,s))},Ng=async(s,t,i)=>await FP(s.buffer,t,i);function db(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function ps(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?db(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):db(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class jt extends tn{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==di.PLAYING)}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,i,a,l,p,f){if(super(t,p),P(this,"trackMediaType","video"),P(this,"_player",void 0),P(this,"isUseScaleResolutionDownBy",!1),P(this,"_videoVisibleTimer",null),P(this,"_statsTimer",null),P(this,"_previousVideoVisibleStatus",void 0),P(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),P(this,"_encoderConfig",void 0),P(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),P(this,"_optimizationMode",void 0),P(this,"_videoHeight",void 0),P(this,"_videoWidth",void 0),P(this,"_forceBitrateLimit",void 0),P(this,"_enabled",!0),P(this,"processorDestination",void 0),P(this,"_processorContext",void 0),qt()){let{width:g,height:v}=t.getSettings();this._videoWidth=g,this._videoHeight=v}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=i,this._scalabilityMode=a,this._optimizationMode=l,this._hints=f||[],this._hints.indexOf(Un.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(g,v,y){let I=En();return!(I.name!==g||!I.osVersion)&&Number(I.version)===v}(Ee.CHROME,115)&&ar().indexOf("Windows")!==-1){let g=function(v,y){if("VideoFrame"in window&&"TransformStream"in window&&zn().supportWebRTCInsertableStream){let I=new MediaStreamTrackProcessor(v),b=new MediaStreamTrackGenerator({kind:"video"}),k,U,J=Date.now(),K=()=>{q&&(clearInterval(q),q=void 0),k&&(k.close(),k=void 0),v.stop(),U=void 0,b.removeEventListener("ended",K)},q=window.setInterval(()=>{if(U&&k&&Date.now()-J>1e3)try{b.readyState==="live"?U.enqueue(k.clone()):K()}catch{K()}},1e3),te=new TransformStream({transform:(de,he)=>{b.readyState==="live"?(U=he,J=Date.now(),k===void 0?(k=de,he.enqueue(de.clone())):(he.enqueue(k),k=de)):de.close()}});return b.addEventListener("ended",K),I.readable.pipeThrough(te).pipeTo(b.writable),b}}(t);g&&(x.info("local screen video track begin to inject frame"),this._mediaStreamTrack=g)}i&&this._hints.indexOf(Un.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(i),this.processorContext=new rb(this.getTrackId(),"local"),this.processorDestination=new MP(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){let l=document.getElementById(t);l?t=l:(x.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}x.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));let a=ps(ps(ps({},this._getDefaultPlayerConfig()),i),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(a):(t instanceof HTMLVideoElement?this._player=new _l(a):this._player=new Og(a),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let l=this.getVideoElementVisibleStatus();this.safeEmit(pl.VIDEO_ELEMENT_VISIBLE_STATUS,l)}catch{}},ce("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,x.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(x.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await fn(this,ut.NEED_DISABLE_TRACK,this)}catch(a){throw x.error("[".concat(this.getTrackId(),"] setEnabled to false error"),a.toString()),a}return i||(this._enabled=!1),void x.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await fn(this,ut.NEED_ENABLE_TRACK,this)}catch(a){throw x.error("[".concat(this.getTrackId(),"] setEnabled to true error"),a.toString()),a}x.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,x.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await fn(this,ut.NEED_MUTE_TRACK,this):await fn(this,ut.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(t,i){if(!this._enabled)throw new Ve(Z.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=ha(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){let a=bg({encoderConfig:t});(qt()||Gs()||Id())&&(a.deviceId=void 0),x.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(a));try{await this._originMediaStreamTrack.applyConstraints(a),this.updateMediaStreamTrackResolution()}catch(l){let p=new Ve(Z.UNEXPECTED_ERROR,l.toString());throw x.error("[".concat(this.getTrackId(),"] applyConstraints error"),p.toString()),p}}this._encoderConfig=t,this._hints.indexOf(Un.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await fn(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(a){return a.throw(x)}}getStats(){return eg(()=>{x.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),us(this,ut.GET_STATS)||ps({},Eo)}async setBeautyEffect(t){x.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,i):await ob(t)}async setBitrateLimit(t){if(x.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t){this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate);try{await fn(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(x)}}}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void x.error(Z.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let i=this._optimizationMode;try{this._optimizationMode=t,await fn(this,ut.SET_OPTIMIZATION_MODE,this)}catch(a){throw this._optimizationMode=i,x.error("[".concat(this.getTrackId(),"] set optimization mode failed"),a.toString()),a}x.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return x.error(Z.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,x.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){yC(this._originMediaStreamTrack).then(t=>{let[i,a]=t;this._videoHeight=a,this._videoWidth=i}).catch($m)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new Ve(Z.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");x.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=ha(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(Un.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await fn(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(x)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:t,height:i,frameRate:a}=this.getMediaStreamTrackSettings();if(!t||!i||!a)return;let[l,p]=function(f,g,v,y){let I,b=200*Math.pow(v/15,.6)*Math.pow(f*g/640/360,.75),k=b;if(y==="STANDARD_BITRATE")I=4*b;else{if(y!=="COMPATIABLE_BITRATE")return;I=2*b}return[Math.floor(I),Math.floor(k)]}(t,i,a,ce("BITRATE_ADAPTER_TYPE"))||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=p,this._encoderConfig.bitrateMax=l,x.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(i,", fps: ").concat(a,"] => [brMax: ").concat(l,", brMin: ").concat(p,"]")))}getVideoElementVisibleStatus(){try{var t,i;let a=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),l={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:a==null?void 0:a.parentElement},{element:p,slot:f}=l;if(this.isPlaying&&p instanceof HTMLVideoElement&&f instanceof HTMLElement){let g=il.checkOneElementVisible(p),v=Object.assign({},g);if(v.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=v.visible;let y=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});v.visible?y.onSuccess("Video is visible"):y.onSuccess("Invisible because of ".concat(v.reason))}return v}return}catch(a){throw new Ve(Z.GET_VIDEO_ELEMENT_VISIBLE_ERROR,a.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new Ve(Z.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;let t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],a=this._encoderConfig;t&&(a=ps(ps({},a),ha(t))),a=ki(a);let l=si(8,"track-video-cloned-"),p=new jt(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,a,ki(this._scalabilityMode),this._optimizationMode,l,ki(this._hints));return t&&a&&p.setEncoderConfiguration(a),x.debug("clone video track from ".concat(this.getTrackId()," to ").concat(l,", clone ").concat(i)),p}async replaceTrack(t,i){if(!(t instanceof MediaStreamTrack))throw new Ve(Z.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new Ve(Z.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,i,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!qt()&&!Gs())return;this._statsTimer&&window.clearInterval(this._statsTimer);let t=2,i=Gp[t],a=-1,l=Date.now(),p=f=>{f>2||f<0||(l=Date.now(),i=Gp[f],this.setSenderConfiguration(i))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{let f=this.getStats(),g=us(this,ut.GET_RTC_STATS);if(f.sendPackets>0&&g){a===-1&&(a=Date.now());let v=Date.now();if(v-a<1e3||v-l<ce("PROFILE_SWITCH_INTERVAL"))return;let y=f.sendFrameRate,I=.6*i.frameRate,b=.9*i.frameRate;typeof y=="number"&&y>0&&y<I?t>0&&(t--,p(t),x.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(y,", switchProfile to ").concat(t))):g.OutgoingAvailableBandwidth<i.bitrateMin?t>0&&(t--,p(t),x.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(g.OutgoingAvailableBandwidth,", bitrateMin ").concat(i.bitrateMin,", switchProfile to ").concat(t))):typeof y=="number"&&y>b&&t<Gp.length-1&&g.OutgoingAvailableBandwidth>1.2*Gp[t+1].bitrateMin&&(t++,p(t),x.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(y,", OutgoingAvailableBandwidth ").concat(g.OutgoingAvailableBandwidth,", switchProfile to ").concat(t)))}},ce("CHECK_LOCAL_STATS_INTERVAL"))}bindProcessorDestinationEvents(){this.processorDestination.on($i.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await fn(this,ut.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await fn(this,ut.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners($i.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(go.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(go.REQUEST_CONSTRAINTS)}}Be([bt({argsMap:(s,t,i)=>[s.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Object,Object]),Y("design:returntype",void 0)],jt.prototype,"play",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],jt.prototype,"stop",null),Be([Bc("LocalVideoTrack","_enabledMutex"),bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Boolean,Boolean]),Y("design:returntype",Pe)],jt.prototype,"setEnabled",null),Be([Bc("LocalVideoTrack","_enabledMutex"),bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Boolean]),Y("design:returntype",Pe)],jt.prototype,"setMuted",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Object,Boolean]),Y("design:returntype",Pe)],jt.prototype,"setEncoderConfiguration",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Object)],jt.prototype,"getStats",null),Be([bt({argsMap:(s,t,i)=>[s.getTrackId(),t,i]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Boolean,Object]),Y("design:returntype",Pe)],jt.prototype,"setBeautyEffect",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",ImageData)],jt.prototype,"getCurrentFrameData",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[String,Number]),Y("design:returntype",Pe)],jt.prototype,"getCurrentFrameImage",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],jt.prototype,"setBitrateLimit",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],jt.prototype,"setOptimizationMode",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",void 0)],jt.prototype,"setScalabiltyMode",null),Be([tr(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],jt.prototype,"updateMediaStreamTrackResolution",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t.name]}),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Object)],jt.prototype,"pipe",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],jt.prototype,"unpipe",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],jt.prototype,"close",null),Be([bt({argsMap:(s,t,i)=>[s.getTrackId(),t.label,i]}),Y("design:type",Function),Y("design:paramtypes",[MediaStreamTrack,Boolean]),Y("design:returntype",Pe)],jt.prototype,"replaceTrack",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],jt.prototype,"startMonitorStats",null);class Qo extends jt{get __className__(){return"CameraVideoTrack"}constructor(t,i,a,l,p,f){super(t,ha(i.encoderConfig),l,p,f),P(this,"_config",void 0),P(this,"_originalConstraints",void 0),P(this,"_constraints",void 0),P(this,"_enabled",!0),P(this,"_deviceName","default"),P(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Ln()||Ds())&&!function(){let g=En();if(g.os!==Cr.IOS||!g.osVersion)return!1;let v=g.osVersion.split(".");return Number(v[0])===15&&Number(v[1])>=2}()&&FA()&&this._enabled&&!this._isClosed&&(x.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=i,this._originalConstraints=a,this._constraints=a,this._deviceName=t.label,this._encoderConfig=ha(this._config.encoderConfig),Wn.on(Wr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Wn.on(Wr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(x.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{let i=await Ea.getDeviceById(t),a={};a.video=ps({},this._constraints),a.video.deviceId={exact:t},a.video.facingMode=void 0,this._originMediaStreamTrack.stop();let l=null;try{l=await Xo(a,this.getTrackId())}catch(p){throw x.error("[".concat(this.getTrackId(),"] setDevice failed"),p.toString()),l=await Xo({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(l.getVideoTracks()[0],!1),p}await this._updateOriginMediaStreamTrack(l.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=i.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(i){throw x.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{let i=await Ea.getDeviceById(t);this._deviceName=i.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(i){throw x.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}x.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){x.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));let i={video:ps(ps({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let a=null;try{a=await Xo(i,this.getTrackId())}catch(l){throw x.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),l.toString()),a=await Xo({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(a.getVideoTracks()[0],!1),l}await this._updateOriginMediaStreamTrack(a.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=ps({},i.video),x.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(x.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{let a=await Xo({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getVideoTracks()[0],!1)}await fn(this,ut.NEED_ENABLE_TRACK,this)}catch(a){throw x.error("[".concat(this.getTrackId(),"] setEnabled true error"),a.toString()),a}this.updateMediaStreamTrackResolution(),x.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),i||(this._enabled=!1);try{await fn(this,ut.NEED_DISABLE_TRACK,this)}catch(a){throw x.error("[".concat(this.getTrackId(),"] setEnabled to false error"),a.toString()),a}x.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,i){if(!this._enabled)throw new Ve(Z.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=ha(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin);let a=Gn(this._config);a.encoderConfig=t;let l=bg(a);(qt()||Gs()||Id())&&(l.deviceId=void 0),x.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(l));try{await this._originMediaStreamTrack.applyConstraints(l),this.updateMediaStreamTrackResolution()}catch(p){let f=new Ve(Z.UNEXPECTED_ERROR,p.toString());throw x.error("[".concat(this.getTrackId(),"] applyConstraints error"),f.toString()),f}this._config=a,this._constraints=l,this._originalConstraints=l,this._encoderConfig=t,this._hints.indexOf(Un.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await fn(this,ut.NEED_UPDATE_VIDEO_ENCODER,this)}catch(p){return p.throw(x)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Gs()||Id())&&this._enabled&&!this._isClosed&&Wn.duringInterruption){let t=async()=>{Wn.off(Wr.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(x.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Wn.on(Wr.IOS_INTERRUPTION_END,t)}else x.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(pl.TRACK_ENDED)}async renewMediaStreamTrack(t){let i=t||this._constraints,a=Ea.searchDeviceIdByName(this._deviceName);if(a&&!i.deviceId&&(i.deviceId={exact:a}),this._enabled){let l=await Xo({video:i},this.getTrackId());this._constraints=i,await this._updateOriginMediaStreamTrack(l.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Wn.off(Wr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Wn.off(Wr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],a=this._encoderConfig;t&&(a=ps(ps({},a),ha(t))),a=ki(a);let l=si(8,"track-cam-cloned-"),p=new Qo(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,ki(ps(ps({},this._config),{},{encoderConfig:a})),ki(this._constraints),ki(this._scalabilityMode),this._optimizationMode,l);return t&&a&&p.setEncoderConfiguration(a),x.debug("clone track from ".concat(this.getTrackId()," to ").concat(l,", clone ").concat(i)),p}bindProcessorContextEvents(){this.processorContext.on(go.REQUEST_UPDATE_CONSTRAINTS,async(t,i,a)=>{try{let l=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(l),i()}catch(l){a(l)}}),this.processorContext.on(go.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}function qp(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Sf(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?qp(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):qp(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function IC(s,t,i,a){i.optimizationMode&&(a&&a.width&&a.height?(i.encoderConfig=Sf(Sf({},a),{},{bitrateMin:a.bitrateMin,bitrateMax:a.bitrateMax}),i.optimizationMode!=="motion"&&i.optimizationMode!=="detail"||(t.contentHint=i.optimizationMode,t.contentHint===i.optimizationMode?x.debug("[".concat(s,"] set content hint to"),i.optimizationMode):x.debug("[".concat(s,"] set content hint failed")))):x.warning("[".concat(s,"] can not apply optimization mode bitrate config, no encoderConfig")))}function Tf(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function yh(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Tf(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Tf(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}Be([bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Qo.prototype,"setDevice",null),Be([Bc("CameraVideoTrack","_enabledMutex"),bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Boolean,Boolean]),Y("design:returntype",Pe)],Qo.prototype,"setEnabled",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t]}),tr(),Y("design:type",Function),Y("design:paramtypes",[Object,Boolean]),Y("design:returntype",Pe)],Qo.prototype,"setEncoderConfiguration",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Qo.prototype,"close",null);class AC extends ma{getUserId(){return this._userId}constructor(t,i,a,l){super(t,"track-".concat(t.kind,"-").concat(i,"-").concat(l.clientId,"_").concat(si(5,""))),P(this,"_userId",void 0),P(this,"_uintId",void 0),P(this,"_isDestroyed",!1),P(this,"store",void 0),P(this,"processor",void 0),this._userId=i,this._uintId=a,this.store=l}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,x.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class fc extends AC{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==di.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,i,a,l){super(t,i,a,l),P(this,"_videoVisibleTimer",null),P(this,"_previousVideoVisibleStatus",void 0),P(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),P(this,"trackMediaType","video"),P(this,"_videoWidth",void 0),P(this,"_videoHeight",void 0),P(this,"_player",void 0),P(this,"processorDestination",void 0),P(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new rb(this.getTrackId(),"remote"),this.processorDestination=new MP(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return eg(()=>{x.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),us(this,ut.GET_STATS)||yh({},ks)}play(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){let l=document.getElementById(t);l?t=l:(x.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}x.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));let a=yh(yh({fit:"cover"},i),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(a):(t instanceof HTMLVideoElement?this._player=new _l(a):this._player=new Og(a),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Th.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let l=this.getVideoElementVisibleStatus();this.safeEmit(Th.VIDEO_ELEMENT_VISIBLE_STATUS,l)}catch{}},ce("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,x.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){yC(this._originMediaStreamTrack).then(t=>{let[i,a]=t;this._videoHeight=a,this._videoWidth=i}).catch($m)}_updatePlayerSource(){x.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,i;let a=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),l={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:a==null?void 0:a.parentElement},{element:p,slot:f}=l;if(this.isPlaying&&p instanceof HTMLVideoElement&&f instanceof HTMLElement){let g=il.checkOneElementVisible(p),v=Object.assign({},g);if(v.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=v.visible;let y=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});v.visible?y.onSuccess("Video is visible"):y.onSuccess("Invisible because of ".concat(v.reason))}return v}return}catch(a){throw new Ve(Z.GET_VIDEO_ELEMENT_VISIBLE_ERROR,a.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new Ve(Z.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;let t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on($i.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners($i.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}Be([bt({argsMap:(s,t,i)=>[s.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),Y("design:type",Function),Y("design:paramtypes",[Object,Object]),Y("design:returntype",void 0)],fc.prototype,"play",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],fc.prototype,"stop",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t.name]}),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Object)],fc.prototype,"pipe",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],fc.prototype,"unpipe",null);class Jc extends AC{get isPlaying(){return this._useAudioElement?Po.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,i,a,l){super(t,i,a,l),P(this,"trackMediaType","audio"),P(this,"_source",void 0),P(this,"_useAudioElement",!0),P(this,"_volume",100),P(this,"processorContext",void 0),P(this,"processorDestination",void 0),P(this,"_played",!1),P(this,"_bypassWebAudio",!1),ce("DISABLE_WEBAUDIO")?(this._source=new hu,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new Ig(t,!0),ce("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Jo.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Th.FIRST_FRAME_DECODED)}),this.processorContext=new xn(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new gf(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Jo.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Jo.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(i),this._source.removeAllListeners(Jo.ON_AUDIO_BUFFER),this._source.on(Jo.ON_AUDIO_BUFFER,a=>t(a))}setVolume(t){this._volume=t,this._useAudioElement?Po.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!bp()&&ce("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new Ve(Z.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Po.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return eg(()=>{x.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),us(this,ut.GET_STATS)||yh({},Ch)}play(){x.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(x.debug("[".concat(this.getTrackId(),"] use audio element to play")),Po.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){x.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Po.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];x.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Po.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new Ve(Z.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new Ve(Z.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new Ve(Z.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let i=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,i.reset()}bindProcessorDestinationEvents(){this.processorDestination.on($i.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on($i.ON_NODE,t=>{this._source.processedNode=t;let i=!t;this._useAudioElement!==i&&(this._played?(this.stop(),this._useAudioElement=i,this.play()):this._useAudioElement=i)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners($i.ON_TRACK),this.processorDestination.removeAllListeners($i.ON_NODE)}}Be([bt({argsMap:(s,t)=>[s.getTrackId(),t],throttleTime:300}),Y("design:type",Function),Y("design:paramtypes",[Number]),Y("design:returntype",void 0)],Jc.prototype,"setVolume",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t]}),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Jc.prototype,"setPlaybackDevice",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Jc.prototype,"play",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Jc.prototype,"stop",null),Be([bt({argsMap:(s,t)=>[s.getTrackId(),t.name]}),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Object)],Jc.prototype,"pipe",null),Be([bt({argsMap:s=>[s.getTrackId()]}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Jc.prototype,"unpipe",null);function Jp(s){let t=s.length;for(;--t>=0;)s[t]=0}let Pd=256,Cf=286,fu=30,_u=15,Dg=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Xp=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),lb=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),ub=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),El=new Array(576);Jp(El);let vf=new Array(60);Jp(vf);let Qp=new Array(512);Jp(Qp);let Rf=new Array(256);Jp(Rf);let Zp=new Array(29);Jp(Zp);let ko=new Array(fu);function Xc(s,t,i,a,l){this.static_tree=s,this.extra_bits=t,this.extra_base=i,this.elems=a,this.max_length=l,this.has_stree=s&&s.length}let hb,pb,mb;function wC(s,t){this.dyn_tree=s,this.max_code=0,this.stat_desc=t}Jp(ko);let fb=s=>s<256?Qp[s]:Qp[256+(s>>>7)],$p=(s,t)=>{s.pending_buf[s.pending++]=255&t,s.pending_buf[s.pending++]=t>>>8&255},Sa=(s,t,i)=>{s.bi_valid>16-i?(s.bi_buf|=t<<s.bi_valid&65535,$p(s,s.bi_buf),s.bi_buf=t>>16-s.bi_valid,s.bi_valid+=i-16):(s.bi_buf|=t<<s.bi_valid&65535,s.bi_valid+=i)},Qc=(s,t,i)=>{Sa(s,i[2*t],i[2*t+1])},_b=(s,t)=>{let i=0;do i|=1&s,s>>>=1,i<<=1;while(--t>0);return i>>>1},Eb=(s,t,i)=>{let a=new Array(16),l,p,f=0;for(l=1;l<=_u;l++)f=f+i[l-1]<<1,a[l]=f;for(p=0;p<=t;p++){let g=s[2*p+1];g!==0&&(s[2*p]=_b(a[g]++,g))}},gb=s=>{let t;for(t=0;t<Cf;t++)s.dyn_ltree[2*t]=0;for(t=0;t<fu;t++)s.dyn_dtree[2*t]=0;for(t=0;t<19;t++)s.bl_tree[2*t]=0;s.dyn_ltree[512]=1,s.opt_len=s.static_len=0,s.sym_next=s.matches=0},Sb=s=>{s.bi_valid>8?$p(s,s.bi_buf):s.bi_valid>0&&(s.pending_buf[s.pending++]=s.bi_buf),s.bi_buf=0,s.bi_valid=0},jP=(s,t,i,a)=>{let l=2*t,p=2*i;return s[l]<s[p]||s[l]===s[p]&&a[t]<=a[i]},Tb=(s,t,i)=>{let a=s.heap[i],l=i<<1;for(;l<=s.heap_len&&(l<s.heap_len&&jP(t,s.heap[l+1],s.heap[l],s.depth)&&l++,!jP(t,a,s.heap[l],s.depth));)s.heap[i]=s.heap[l],i=l,l<<=1;s.heap[i]=a},BP=(s,t,i)=>{let a,l,p,f,g=0;if(s.sym_next!==0)do a=255&s.pending_buf[s.sym_buf+g++],a+=(255&s.pending_buf[s.sym_buf+g++])<<8,l=s.pending_buf[s.sym_buf+g++],a===0?Qc(s,l,t):(p=Rf[l],Qc(s,p+Pd+1,t),f=Dg[p],f!==0&&(l-=Zp[p],Sa(s,l,f)),a--,p=fb(a),Qc(s,p,i),f=Xp[p],f!==0&&(a-=ko[p],Sa(s,a,f)));while(g<s.sym_next);Qc(s,256,t)},Cb=(s,t)=>{let i=t.dyn_tree,a=t.stat_desc.static_tree,l=t.stat_desc.has_stree,p=t.stat_desc.elems,f,g,v,y=-1;for(s.heap_len=0,s.heap_max=573,f=0;f<p;f++)i[2*f]!==0?(s.heap[++s.heap_len]=y=f,s.depth[f]=0):i[2*f+1]=0;for(;s.heap_len<2;)v=s.heap[++s.heap_len]=y<2?++y:0,i[2*v]=1,s.depth[v]=0,s.opt_len--,l&&(s.static_len-=a[2*v+1]);for(t.max_code=y,f=s.heap_len>>1;f>=1;f--)Tb(s,i,f);v=p;do f=s.heap[1],s.heap[1]=s.heap[s.heap_len--],Tb(s,i,1),g=s.heap[1],s.heap[--s.heap_max]=f,s.heap[--s.heap_max]=g,i[2*v]=i[2*f]+i[2*g],s.depth[v]=(s.depth[f]>=s.depth[g]?s.depth[f]:s.depth[g])+1,i[2*f+1]=i[2*g+1]=v,s.heap[1]=v++,Tb(s,i,1);while(s.heap_len>=2);s.heap[--s.heap_max]=s.heap[1],((I,b)=>{let k=b.dyn_tree,U=b.max_code,J=b.stat_desc.static_tree,K=b.stat_desc.has_stree,q=b.stat_desc.extra_bits,te=b.stat_desc.extra_base,de=b.stat_desc.max_length,he,Ue,Re,Ie,De,Ne,Xe=0;for(Ie=0;Ie<=_u;Ie++)I.bl_count[Ie]=0;for(k[2*I.heap[I.heap_max]+1]=0,he=I.heap_max+1;he<573;he++)Ue=I.heap[he],Ie=k[2*k[2*Ue+1]+1]+1,Ie>de&&(Ie=de,Xe++),k[2*Ue+1]=Ie,Ue>U||(I.bl_count[Ie]++,De=0,Ue>=te&&(De=q[Ue-te]),Ne=k[2*Ue],I.opt_len+=Ne*(Ie+De),K&&(I.static_len+=Ne*(J[2*Ue+1]+De)));if(Xe!==0){do{for(Ie=de-1;I.bl_count[Ie]===0;)Ie--;I.bl_count[Ie]--,I.bl_count[Ie+1]+=2,I.bl_count[de]--,Xe-=2}while(Xe>0);for(Ie=de;Ie!==0;Ie--)for(Ue=I.bl_count[Ie];Ue!==0;)Re=I.heap[--he],Re>U||(k[2*Re+1]!==Ie&&(I.opt_len+=(Ie-k[2*Re+1])*k[2*Re],k[2*Re+1]=Ie),Ue--)}})(s,t),Eb(i,y,s.bl_count)},yf=(s,t,i)=>{let a,l,p=-1,f=t[1],g=0,v=7,y=4;for(f===0&&(v=138,y=3),t[2*(i+1)+1]=65535,a=0;a<=i;a++)l=f,f=t[2*(a+1)+1],++g<v&&l===f||(g<y?s.bl_tree[2*l]+=g:l!==0?(l!==p&&s.bl_tree[2*l]++,s.bl_tree[32]++):g<=10?s.bl_tree[34]++:s.bl_tree[36]++,g=0,p=l,f===0?(v=138,y=3):l===f?(v=6,y=3):(v=7,y=4))},GP=(s,t,i)=>{let a,l,p=-1,f=t[1],g=0,v=7,y=4;for(f===0&&(v=138,y=3),a=0;a<=i;a++)if(l=f,f=t[2*(a+1)+1],!(++g<v&&l===f)){if(g<y)do Qc(s,l,s.bl_tree);while(--g!=0);else l!==0?(l!==p&&(Qc(s,l,s.bl_tree),g--),Qc(s,16,s.bl_tree),Sa(s,g-3,2)):g<=10?(Qc(s,17,s.bl_tree),Sa(s,g-3,3)):(Qc(s,18,s.bl_tree),Sa(s,g-11,7));g=0,p=l,f===0?(v=138,y=3):l===f?(v=6,y=3):(v=7,y=4)}},ro=!1,Ih=(s,t,i,a)=>{Sa(s,0+(a?1:0),3),Sb(s),$p(s,i),$p(s,~i),i&&s.pending_buf.set(s.window.subarray(t,t+i),s.pending),s.pending+=i};var If=s=>{ro||((()=>{let t,i,a,l,p,f=new Array(16);for(a=0,l=0;l<28;l++)for(Zp[l]=a,t=0;t<1<<Dg[l];t++)Rf[a++]=l;for(Rf[a-1]=l,p=0,l=0;l<16;l++)for(ko[l]=p,t=0;t<1<<Xp[l];t++)Qp[p++]=l;for(p>>=7;l<fu;l++)for(ko[l]=p<<7,t=0;t<1<<Xp[l]-7;t++)Qp[256+p++]=l;for(i=0;i<=_u;i++)f[i]=0;for(t=0;t<=143;)El[2*t+1]=8,t++,f[8]++;for(;t<=255;)El[2*t+1]=9,t++,f[9]++;for(;t<=279;)El[2*t+1]=7,t++,f[7]++;for(;t<=287;)El[2*t+1]=8,t++,f[8]++;for(Eb(El,287,f),t=0;t<fu;t++)vf[2*t+1]=5,vf[2*t]=_b(t,5);hb=new Xc(El,Dg,257,Cf,_u),pb=new Xc(vf,Xp,0,fu,_u),mb=new Xc(new Array(0),lb,0,19,7)})(),ro=!0),s.l_desc=new wC(s.dyn_ltree,hb),s.d_desc=new wC(s.dyn_dtree,pb),s.bl_desc=new wC(s.bl_tree,mb),s.bi_buf=0,s.bi_valid=0,gb(s)},e3=(s,t,i,a)=>{let l,p,f=0;s.level>0?(s.strm.data_type===2&&(s.strm.data_type=(g=>{let v,y=4093624447;for(v=0;v<=31;v++,y>>>=1)if(1&y&&g.dyn_ltree[2*v]!==0)return 0;if(g.dyn_ltree[18]!==0||g.dyn_ltree[20]!==0||g.dyn_ltree[26]!==0)return 1;for(v=32;v<Pd;v++)if(g.dyn_ltree[2*v]!==0)return 1;return 0})(s)),Cb(s,s.l_desc),Cb(s,s.d_desc),f=(g=>{let v;for(yf(g,g.dyn_ltree,g.l_desc.max_code),yf(g,g.dyn_dtree,g.d_desc.max_code),Cb(g,g.bl_desc),v=18;v>=3&&g.bl_tree[2*ub[v]+1]===0;v--);return g.opt_len+=3*(v+1)+5+5+4,v})(s),l=s.opt_len+3+7>>>3,p=s.static_len+3+7>>>3,p<=l&&(l=p)):l=p=i+5,i+4<=l&&t!==-1?Ih(s,t,i,a):s.strategy===4||p===l?(Sa(s,2+(a?1:0),3),BP(s,El,vf)):(Sa(s,4+(a?1:0),3),((g,v,y,I)=>{let b;for(Sa(g,v-257,5),Sa(g,y-1,5),Sa(g,I-4,4),b=0;b<I;b++)Sa(g,g.bl_tree[2*ub[b]+1],3);GP(g,g.dyn_ltree,v-1),GP(g,g.dyn_dtree,y-1)})(s,s.l_desc.max_code+1,s.d_desc.max_code+1,f+1),BP(s,s.dyn_ltree,s.dyn_dtree)),gb(s),a&&Sb(s)},vb=(s,t,i)=>(s.pending_buf[s.sym_buf+s.sym_next++]=t,s.pending_buf[s.sym_buf+s.sym_next++]=t>>8,s.pending_buf[s.sym_buf+s.sym_next++]=i,t===0?s.dyn_ltree[2*i]++:(s.matches++,t--,s.dyn_ltree[2*(Rf[i]+Pd+1)]++,s.dyn_dtree[2*fb(t)]++),s.sym_next===s.sym_end),t3={_tr_init:If,_tr_stored_block:Ih,_tr_flush_block:e3,_tr_tally:vb,_tr_align:s=>{Sa(s,2,3),Qc(s,256,El),(t=>{t.bi_valid===16?($p(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(s)}},Zc=(s,t,i,a)=>{let l=65535&s|0,p=s>>>16&65535|0,f=0;for(;i!==0;){f=i>2e3?2e3:i,i-=f;do l=l+t[a++]|0,p=p+l|0;while(--f);l%=65521,p%=65521}return l|p<<16|0};let n3=new Uint32Array((()=>{let s,t=[];for(var i=0;i<256;i++){s=i;for(var a=0;a<8;a++)s=1&s?3988292384^s>>>1:s>>>1;t[i]=s}return t})());var Hr=(s,t,i,a)=>{let l=n3,p=a+i;s^=-1;for(let f=a;f<p;f++)s=s>>>8^l[255&(s^t[f])];return-1^s},em={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Af={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:$c,_tr_stored_block:bC,_tr_flush_block:Lo,_tr_tally:Eu,_tr_align:gl}=t3,{Z_NO_FLUSH:Ah,Z_PARTIAL_FLUSH:Rb,Z_FULL_FLUSH:i3,Z_FINISH:ed,Z_BLOCK:Pg,Z_OK:Mo,Z_STREAM_END:WP,Z_STREAM_ERROR:Sl,Z_DATA_ERROR:r3,Z_BUF_ERROR:wf,Z_DEFAULT_COMPRESSION:yb,Z_FILTERED:s3,Z_HUFFMAN_ONLY:OC,Z_RLE:o3,Z_FIXED:a3,Z_DEFAULT_STRATEGY:tm,Z_UNKNOWN:Tl,Z_DEFLATED:gu}=Af,Su=286,kg=30,nm=19,HP=2*Su+1,wh=15,im=258,Uo=262,To=42,so=113,Oi=666,kd=(s,t)=>(s.msg=em[t],t),NC=s=>2*s-(s>4?9:0),Tu=s=>{let t=s.length;for(;--t>=0;)s[t]=0},bf=s=>{let t,i,a,l=s.w_size;t=s.hash_size,a=t;do i=s.head[--a],s.head[a]=i>=l?i-l:0;while(--t);t=l,a=t;do i=s.prev[--a],s.prev[a]=i>=l?i-l:0;while(--t)},Cu=(s,t,i)=>(t<<s.hash_shift^i)&s.hash_mask,Ta=s=>{let t=s.state,i=t.pending;i>s.avail_out&&(i=s.avail_out),i!==0&&(s.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),s.next_out),s.next_out+=i,t.pending_out+=i,s.total_out+=i,s.avail_out-=i,t.pending-=i,t.pending===0&&(t.pending_out=0))},Co=(s,t)=>{Lo(s,s.block_start>=0?s.block_start:-1,s.strstart-s.block_start,t),s.block_start=s.strstart,Ta(s.strm)},li=(s,t)=>{s.pending_buf[s.pending++]=t},vu=(s,t)=>{s.pending_buf[s.pending++]=t>>>8&255,s.pending_buf[s.pending++]=255&t},Ib=(s,t,i,a)=>{let l=s.avail_in;return l>a&&(l=a),l===0?0:(s.avail_in-=l,t.set(s.input.subarray(s.next_in,s.next_in+l),i),s.state.wrap===1?s.adler=Zc(s.adler,t,l,i):s.state.wrap===2&&(s.adler=Hr(s.adler,t,l,i)),s.next_in+=l,s.total_in+=l,l)},Of=(s,t)=>{let i,a,l=s.max_chain_length,p=s.strstart,f=s.prev_length,g=s.nice_match,v=s.strstart>s.w_size-Uo?s.strstart-(s.w_size-Uo):0,y=s.window,I=s.w_mask,b=s.prev,k=s.strstart+im,U=y[p+f-1],J=y[p+f];s.prev_length>=s.good_match&&(l>>=2),g>s.lookahead&&(g=s.lookahead);do if(i=t,y[i+f]===J&&y[i+f-1]===U&&y[i]===y[p]&&y[++i]===y[p+1]){p+=2,i++;do;while(y[++p]===y[++i]&&y[++p]===y[++i]&&y[++p]===y[++i]&&y[++p]===y[++i]&&y[++p]===y[++i]&&y[++p]===y[++i]&&y[++p]===y[++i]&&y[++p]===y[++i]&&p<k);if(a=im-(k-p),p=k-im,a>f){if(s.match_start=t,f=a,a>=g)break;U=y[p+f-1],J=y[p+f]}}while((t=b[t&I])>v&&--l!=0);return f<=s.lookahead?f:s.lookahead},rm=s=>{let t=s.w_size,i,a,l;do{if(a=s.window_size-s.lookahead-s.strstart,s.strstart>=t+(t-Uo)&&(s.window.set(s.window.subarray(t,t+t-a),0),s.match_start-=t,s.strstart-=t,s.block_start-=t,s.insert>s.strstart&&(s.insert=s.strstart),bf(s),a+=t),s.strm.avail_in===0)break;if(i=Ib(s.strm,s.window,s.strstart+s.lookahead,a),s.lookahead+=i,s.lookahead+s.insert>=3)for(l=s.strstart-s.insert,s.ins_h=s.window[l],s.ins_h=Cu(s,s.ins_h,s.window[l+1]);s.insert&&(s.ins_h=Cu(s,s.ins_h,s.window[l+3-1]),s.prev[l&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=l,l++,s.insert--,!(s.lookahead+s.insert<3)););}while(s.lookahead<Uo&&s.strm.avail_in!==0)},Ab=(s,t)=>{let i,a,l,p=s.pending_buf_size-5>s.w_size?s.w_size:s.pending_buf_size-5,f=0,g=s.strm.avail_in;do{if(i=65535,l=s.bi_valid+42>>3,s.strm.avail_out<l||(l=s.strm.avail_out-l,a=s.strstart-s.block_start,i>a+s.strm.avail_in&&(i=a+s.strm.avail_in),i>l&&(i=l),i<p&&(i===0&&t!==ed||t===Ah||i!==a+s.strm.avail_in)))break;f=t===ed&&i===a+s.strm.avail_in?1:0,bC(s,0,0,f),s.pending_buf[s.pending-4]=i,s.pending_buf[s.pending-3]=i>>8,s.pending_buf[s.pending-2]=~i,s.pending_buf[s.pending-1]=~i>>8,Ta(s.strm),a&&(a>i&&(a=i),s.strm.output.set(s.window.subarray(s.block_start,s.block_start+a),s.strm.next_out),s.strm.next_out+=a,s.strm.avail_out-=a,s.strm.total_out+=a,s.block_start+=a,i-=a),i&&(Ib(s.strm,s.strm.output,s.strm.next_out,i),s.strm.next_out+=i,s.strm.avail_out-=i,s.strm.total_out+=i)}while(f===0);return g-=s.strm.avail_in,g&&(g>=s.w_size?(s.matches=2,s.window.set(s.strm.input.subarray(s.strm.next_in-s.w_size,s.strm.next_in),0),s.strstart=s.w_size,s.insert=s.strstart):(s.window_size-s.strstart<=g&&(s.strstart-=s.w_size,s.window.set(s.window.subarray(s.w_size,s.w_size+s.strstart),0),s.matches<2&&s.matches++,s.insert>s.strstart&&(s.insert=s.strstart)),s.window.set(s.strm.input.subarray(s.strm.next_in-g,s.strm.next_in),s.strstart),s.strstart+=g,s.insert+=g>s.w_size-s.insert?s.w_size-s.insert:g),s.block_start=s.strstart),s.high_water<s.strstart&&(s.high_water=s.strstart),f?4:t!==Ah&&t!==ed&&s.strm.avail_in===0&&s.strstart===s.block_start?2:(l=s.window_size-s.strstart,s.strm.avail_in>l&&s.block_start>=s.w_size&&(s.block_start-=s.w_size,s.strstart-=s.w_size,s.window.set(s.window.subarray(s.w_size,s.w_size+s.strstart),0),s.matches<2&&s.matches++,l+=s.w_size,s.insert>s.strstart&&(s.insert=s.strstart)),l>s.strm.avail_in&&(l=s.strm.avail_in),l&&(Ib(s.strm,s.window,s.strstart,l),s.strstart+=l,s.insert+=l>s.w_size-s.insert?s.w_size-s.insert:l),s.high_water<s.strstart&&(s.high_water=s.strstart),l=s.bi_valid+42>>3,l=s.pending_buf_size-l>65535?65535:s.pending_buf_size-l,p=l>s.w_size?s.w_size:l,a=s.strstart-s.block_start,(a>=p||(a||t===ed)&&t!==Ah&&s.strm.avail_in===0&&a<=l)&&(i=a>l?l:a,f=t===ed&&s.strm.avail_in===0&&i===a?1:0,bC(s,s.block_start,i,f),s.block_start+=i,Ta(s.strm)),f?3:1)},DC=(s,t)=>{let i,a;for(;;){if(s.lookahead<Uo){if(rm(s),s.lookahead<Uo&&t===Ah)return 1;if(s.lookahead===0)break}if(i=0,s.lookahead>=3&&(s.ins_h=Cu(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),i!==0&&s.strstart-i<=s.w_size-Uo&&(s.match_length=Of(s,i)),s.match_length>=3)if(a=Eu(s,s.strstart-s.match_start,s.match_length-3),s.lookahead-=s.match_length,s.match_length<=s.max_lazy_match&&s.lookahead>=3){s.match_length--;do s.strstart++,s.ins_h=Cu(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart;while(--s.match_length!=0);s.strstart++}else s.strstart+=s.match_length,s.match_length=0,s.ins_h=s.window[s.strstart],s.ins_h=Cu(s,s.ins_h,s.window[s.strstart+1]);else a=Eu(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++;if(a&&(Co(s,!1),s.strm.avail_out===0))return 1}return s.insert=s.strstart<2?s.strstart:2,t===ed?(Co(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Co(s,!1),s.strm.avail_out===0)?1:2},Nf=(s,t)=>{let i,a,l;for(;;){if(s.lookahead<Uo){if(rm(s),s.lookahead<Uo&&t===Ah)return 1;if(s.lookahead===0)break}if(i=0,s.lookahead>=3&&(s.ins_h=Cu(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),s.prev_length=s.match_length,s.prev_match=s.match_start,s.match_length=2,i!==0&&s.prev_length<s.max_lazy_match&&s.strstart-i<=s.w_size-Uo&&(s.match_length=Of(s,i),s.match_length<=5&&(s.strategy===s3||s.match_length===3&&s.strstart-s.match_start>4096)&&(s.match_length=2)),s.prev_length>=3&&s.match_length<=s.prev_length){l=s.strstart+s.lookahead-3,a=Eu(s,s.strstart-1-s.prev_match,s.prev_length-3),s.lookahead-=s.prev_length-1,s.prev_length-=2;do++s.strstart<=l&&(s.ins_h=Cu(s,s.ins_h,s.window[s.strstart+3-1]),i=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart);while(--s.prev_length!=0);if(s.match_available=0,s.match_length=2,s.strstart++,a&&(Co(s,!1),s.strm.avail_out===0))return 1}else if(s.match_available){if(a=Eu(s,0,s.window[s.strstart-1]),a&&Co(s,!1),s.strstart++,s.lookahead--,s.strm.avail_out===0)return 1}else s.match_available=1,s.strstart++,s.lookahead--}return s.match_available&&(a=Eu(s,0,s.window[s.strstart-1]),s.match_available=0),s.insert=s.strstart<2?s.strstart:2,t===ed?(Co(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Co(s,!1),s.strm.avail_out===0)?1:2};function Cl(s,t,i,a,l){this.good_length=s,this.max_lazy=t,this.nice_length=i,this.max_chain=a,this.func=l}let Ru=[new Cl(0,0,0,0,Ab),new Cl(4,4,8,4,DC),new Cl(4,5,16,8,DC),new Cl(4,6,32,32,DC),new Cl(4,4,16,16,Nf),new Cl(8,16,32,32,Nf),new Cl(8,16,128,128,Nf),new Cl(8,32,128,256,Nf),new Cl(32,128,258,1024,Nf),new Cl(32,258,258,4096,Nf)];function c3(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=gu,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*HP),this.dyn_dtree=new Uint16Array(2*(2*kg+1)),this.bl_tree=new Uint16Array(2*(2*nm+1)),Tu(this.dyn_ltree),Tu(this.dyn_dtree),Tu(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(wh+1),this.heap=new Uint16Array(2*Su+1),Tu(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Su+1),Tu(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}let bh=s=>{if(!s)return 1;let t=s.state;return!t||t.strm!==s||t.status!==To&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==so&&t.status!==Oi?1:0},wb=s=>{if(bh(s))return kd(s,Sl);s.total_in=s.total_out=0,s.data_type=Tl;let t=s.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?To:so,s.adler=t.wrap===2?0:1,t.last_flush=-2,$c(t),Mo},Df=s=>{let t=wb(s);var i;return t===Mo&&((i=s.state).window_size=2*i.w_size,Tu(i.head),i.max_lazy_match=Ru[i.level].max_lazy,i.good_match=Ru[i.level].good_length,i.nice_match=Ru[i.level].nice_length,i.max_chain_length=Ru[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0),t},Pf=(s,t,i,a,l,p)=>{if(!s)return Sl;let f=1;if(t===yb&&(t=6),a<0?(f=0,a=-a):a>15&&(f=2,a-=16),l<1||l>9||i!==gu||a<8||a>15||t<0||t>9||p<0||p>a3||a===8&&f!==1)return kd(s,Sl);a===8&&(a=9);let g=new c3;return s.state=g,g.strm=s,g.status=To,g.wrap=f,g.gzhead=null,g.w_bits=a,g.w_size=1<<g.w_bits,g.w_mask=g.w_size-1,g.hash_bits=l+7,g.hash_size=1<<g.hash_bits,g.hash_mask=g.hash_size-1,g.hash_shift=~~((g.hash_bits+3-1)/3),g.window=new Uint8Array(2*g.w_size),g.head=new Uint16Array(g.hash_size),g.prev=new Uint16Array(g.w_size),g.lit_bufsize=1<<l+6,g.pending_buf_size=4*g.lit_bufsize,g.pending_buf=new Uint8Array(g.pending_buf_size),g.sym_buf=g.lit_bufsize,g.sym_end=3*(g.lit_bufsize-1),g.level=t,g.strategy=p,g.method=i,Df(s)};var KP=(s,t)=>{if(bh(s)||t>Pg||t<0)return s?kd(s,Sl):Sl;let i=s.state;if(!s.output||s.avail_in!==0&&!s.input||i.status===Oi&&t!==ed)return kd(s,s.avail_out===0?wf:Sl);let a=i.last_flush;if(i.last_flush=t,i.pending!==0){if(Ta(s),s.avail_out===0)return i.last_flush=-1,Mo}else if(s.avail_in===0&&NC(t)<=NC(a)&&t!==ed)return kd(s,wf);if(i.status===Oi&&s.avail_in!==0)return kd(s,wf);if(i.status===To&&i.wrap===0&&(i.status=so),i.status===To){let l=gu+(i.w_bits-8<<4)<<8,p=-1;if(p=i.strategy>=OC||i.level<2?0:i.level<6?1:i.level===6?2:3,l|=p<<6,i.strstart!==0&&(l|=32),l+=31-l%31,vu(i,l),i.strstart!==0&&(vu(i,s.adler>>>16),vu(i,65535&s.adler)),s.adler=1,i.status=so,Ta(s),i.pending!==0)return i.last_flush=-1,Mo}if(i.status===57){if(s.adler=0,li(i,31),li(i,139),li(i,8),i.gzhead)li(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),li(i,255&i.gzhead.time),li(i,i.gzhead.time>>8&255),li(i,i.gzhead.time>>16&255),li(i,i.gzhead.time>>24&255),li(i,i.level===9?2:i.strategy>=OC||i.level<2?4:0),li(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(li(i,255&i.gzhead.extra.length),li(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(s.adler=Hr(s.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(li(i,0),li(i,0),li(i,0),li(i,0),li(i,0),li(i,i.level===9?2:i.strategy>=OC||i.level<2?4:0),li(i,3),i.status=so,Ta(s),i.pending!==0)return i.last_flush=-1,Mo}if(i.status===69){if(i.gzhead.extra){let l=i.pending,p=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+p>i.pending_buf_size;){let g=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+g),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>l&&(s.adler=Hr(s.adler,i.pending_buf,i.pending-l,l)),i.gzindex+=g,Ta(s),i.pending!==0)return i.last_flush=-1,Mo;l=0,p-=g}let f=new Uint8Array(i.gzhead.extra);i.pending_buf.set(f.subarray(i.gzindex,i.gzindex+p),i.pending),i.pending+=p,i.gzhead.hcrc&&i.pending>l&&(s.adler=Hr(s.adler,i.pending_buf,i.pending-l,l)),i.gzindex=0}i.status=73}if(i.status===73){if(i.gzhead.name){let l,p=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>p&&(s.adler=Hr(s.adler,i.pending_buf,i.pending-p,p)),Ta(s),i.pending!==0)return i.last_flush=-1,Mo;p=0}l=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,li(i,l)}while(l!==0);i.gzhead.hcrc&&i.pending>p&&(s.adler=Hr(s.adler,i.pending_buf,i.pending-p,p)),i.gzindex=0}i.status=91}if(i.status===91){if(i.gzhead.comment){let l,p=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>p&&(s.adler=Hr(s.adler,i.pending_buf,i.pending-p,p)),Ta(s),i.pending!==0)return i.last_flush=-1,Mo;p=0}l=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,li(i,l)}while(l!==0);i.gzhead.hcrc&&i.pending>p&&(s.adler=Hr(s.adler,i.pending_buf,i.pending-p,p))}i.status=103}if(i.status===103){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(Ta(s),i.pending!==0))return i.last_flush=-1,Mo;li(i,255&s.adler),li(i,s.adler>>8&255),s.adler=0}if(i.status=so,Ta(s),i.pending!==0)return i.last_flush=-1,Mo}if(s.avail_in!==0||i.lookahead!==0||t!==Ah&&i.status!==Oi){let l=i.level===0?Ab(i,t):i.strategy===OC?((p,f)=>{let g;for(;;){if(p.lookahead===0&&(rm(p),p.lookahead===0)){if(f===Ah)return 1;break}if(p.match_length=0,g=Eu(p,0,p.window[p.strstart]),p.lookahead--,p.strstart++,g&&(Co(p,!1),p.strm.avail_out===0))return 1}return p.insert=0,f===ed?(Co(p,!0),p.strm.avail_out===0?3:4):p.sym_next&&(Co(p,!1),p.strm.avail_out===0)?1:2})(i,t):i.strategy===o3?((p,f)=>{let g,v,y,I,b=p.window;for(;;){if(p.lookahead<=im){if(rm(p),p.lookahead<=im&&f===Ah)return 1;if(p.lookahead===0)break}if(p.match_length=0,p.lookahead>=3&&p.strstart>0&&(y=p.strstart-1,v=b[y],v===b[++y]&&v===b[++y]&&v===b[++y])){I=p.strstart+im;do;while(v===b[++y]&&v===b[++y]&&v===b[++y]&&v===b[++y]&&v===b[++y]&&v===b[++y]&&v===b[++y]&&v===b[++y]&&y<I);p.match_length=im-(I-y),p.match_length>p.lookahead&&(p.match_length=p.lookahead)}if(p.match_length>=3?(g=Eu(p,1,p.match_length-3),p.lookahead-=p.match_length,p.strstart+=p.match_length,p.match_length=0):(g=Eu(p,0,p.window[p.strstart]),p.lookahead--,p.strstart++),g&&(Co(p,!1),p.strm.avail_out===0))return 1}return p.insert=0,f===ed?(Co(p,!0),p.strm.avail_out===0?3:4):p.sym_next&&(Co(p,!1),p.strm.avail_out===0)?1:2})(i,t):Ru[i.level].func(i,t);if(l!==3&&l!==4||(i.status=Oi),l===1||l===3)return s.avail_out===0&&(i.last_flush=-1),Mo;if(l===2&&(t===Rb?gl(i):t!==Pg&&(bC(i,0,0,!1),t===i3&&(Tu(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0))),Ta(s),s.avail_out===0))return i.last_flush=-1,Mo}return t!==ed?Mo:i.wrap<=0?WP:(i.wrap===2?(li(i,255&s.adler),li(i,s.adler>>8&255),li(i,s.adler>>16&255),li(i,s.adler>>24&255),li(i,255&s.total_in),li(i,s.total_in>>8&255),li(i,s.total_in>>16&255),li(i,s.total_in>>24&255)):(vu(i,s.adler>>>16),vu(i,65535&s.adler)),Ta(s),i.wrap>0&&(i.wrap=-i.wrap),i.pending!==0?Mo:WP)},YP=(s,t)=>{let i=t.length;if(bh(s))return Sl;let a=s.state,l=a.wrap;if(l===2||l===1&&a.status!==To||a.lookahead)return Sl;if(l===1&&(s.adler=Zc(s.adler,t,i,0)),a.wrap=0,i>=a.w_size){l===0&&(Tu(a.head),a.strstart=0,a.block_start=0,a.insert=0);let v=new Uint8Array(a.w_size);v.set(t.subarray(i-a.w_size,i),0),t=v,i=a.w_size}let p=s.avail_in,f=s.next_in,g=s.input;for(s.avail_in=i,s.next_in=0,s.input=t,rm(a);a.lookahead>=3;){let v=a.strstart,y=a.lookahead-2;do a.ins_h=Cu(a,a.ins_h,a.window[v+3-1]),a.prev[v&a.w_mask]=a.head[a.ins_h],a.head[a.ins_h]=v,v++;while(--y);a.strstart=v,a.lookahead=2,rm(a)}return a.strstart+=a.lookahead,a.block_start=a.strstart,a.insert=a.lookahead,a.lookahead=0,a.match_length=a.prev_length=2,a.match_available=0,s.next_in=f,s.input=g,s.avail_in=p,a.wrap=l,Mo},Lg={deflateInit:(s,t)=>Pf(s,t,gu,15,8,tm),deflateInit2:Pf,deflateReset:Df,deflateResetKeep:wb,deflateSetHeader:(s,t)=>bh(s)||s.state.wrap!==2?Sl:(s.state.gzhead=t,Mo),deflate:KP,deflateEnd:s=>{if(bh(s))return Sl;let t=s.state.status;return s.state=null,t===so?kd(s,r3):Mo},deflateSetDictionary:YP,deflateInfo:"pako deflate (from Nodeca project)"};let d3=(s,t)=>Object.prototype.hasOwnProperty.call(s,t);var PC={assign:function(s){let t=Array.prototype.slice.call(arguments,1);for(;t.length;){let i=t.shift();if(i){if(typeof i!="object")throw new TypeError(i+"must be non-object");for(let a in i)d3(i,a)&&(s[a]=i[a])}}return s},flattenChunks:s=>{let t=0;for(let a=0,l=s.length;a<l;a++)t+=s[a].length;let i=new Uint8Array(t);for(let a=0,l=0,p=s.length;a<p;a++){let f=s[a];i.set(f,l),l+=f.length}return i}};let zP=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{zP=!1}let Oh=new Uint8Array(256);for(let s=0;s<256;s++)Oh[s]=s>=252?6:s>=248?5:s>=240?4:s>=224?3:s>=192?2:1;Oh[254]=Oh[254]=1;var Mg={string2buf:s=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(s);let t,i,a,l,p,f=s.length,g=0;for(l=0;l<f;l++)i=s.charCodeAt(l),(64512&i)==55296&&l+1<f&&(a=s.charCodeAt(l+1),(64512&a)==56320&&(i=65536+(i-55296<<10)+(a-56320),l++)),g+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(g),p=0,l=0;p<g;l++)i=s.charCodeAt(l),(64512&i)==55296&&l+1<f&&(a=s.charCodeAt(l+1),(64512&a)==56320&&(i=65536+(i-55296<<10)+(a-56320),l++)),i<128?t[p++]=i:i<2048?(t[p++]=192|i>>>6,t[p++]=128|63&i):i<65536?(t[p++]=224|i>>>12,t[p++]=128|i>>>6&63,t[p++]=128|63&i):(t[p++]=240|i>>>18,t[p++]=128|i>>>12&63,t[p++]=128|i>>>6&63,t[p++]=128|63&i);return t},buf2string:(s,t)=>{let i=t||s.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(s.subarray(0,t));let a,l,p=new Array(2*i);for(l=0,a=0;a<i;){let f=s[a++];if(f<128){p[l++]=f;continue}let g=Oh[f];if(g>4)p[l++]=65533,a+=g-1;else{for(f&=g===2?31:g===3?15:7;g>1&&a<i;)f=f<<6|63&s[a++],g--;g>1?p[l++]=65533:f<65536?p[l++]=f:(f-=65536,p[l++]=55296|f>>10&1023,p[l++]=56320|1023&f)}}return((f,g)=>{if(g<65534&&f.subarray&&zP)return String.fromCharCode.apply(null,f.length===g?f:f.subarray(0,g));let v="";for(let y=0;y<g;y++)v+=String.fromCharCode(f[y]);return v})(p,l)},utf8border:(s,t)=>{(t=t||s.length)>s.length&&(t=s.length);let i=t-1;for(;i>=0&&(192&s[i])==128;)i--;return i<0||i===0?t:i+Oh[s[i]]>t?i:t}},qP=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};let JP=Object.prototype.toString,{Z_NO_FLUSH:l3,Z_SYNC_FLUSH:Ug,Z_FULL_FLUSH:bb,Z_FINISH:u3,Z_OK:sm,Z_STREAM_END:h3,Z_DEFAULT_COMPRESSION:kC,Z_DEFAULT_STRATEGY:p3,Z_DEFLATED:m3}=Af;function xg(s){this.options=PC.assign({level:kC,method:m3,chunkSize:16384,windowBits:15,memLevel:8,strategy:p3},s||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new qP,this.strm.avail_out=0;let i=Lg.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==sm)throw new Error(em[i]);if(t.header&&Lg.deflateSetHeader(this.strm,t.header),t.dictionary){let a;if(a=typeof t.dictionary=="string"?Mg.string2buf(t.dictionary):JP.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,i=Lg.deflateSetDictionary(this.strm,a),i!==sm)throw new Error(em[i]);this._dict_set=!0}}function Ob(s,t){let i=new xg(t);if(i.push(s,!0),i.err)throw i.msg||em[i.err];return i.result}xg.prototype.push=function(s,t){let i=this.strm,a=this.options.chunkSize,l,p;if(this.ended)return!1;for(p=t===~~t?t:t===!0?u3:l3,typeof s=="string"?i.input=Mg.string2buf(s):JP.call(s)==="[object ArrayBuffer]"?i.input=new Uint8Array(s):i.input=s,i.next_in=0,i.avail_in=i.input.length;;)if(i.avail_out===0&&(i.output=new Uint8Array(a),i.next_out=0,i.avail_out=a),(p===Ug||p===bb)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(l=Lg.deflate(i,p),l===h3)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),l=Lg.deflateEnd(this.strm),this.onEnd(l),this.ended=!0,l===sm;if(i.avail_out!==0){if(p>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(i.avail_in===0)break}else this.onData(i.output)}return!0},xg.prototype.onData=function(s){this.chunks.push(s)},xg.prototype.onEnd=function(s){s===sm&&(this.result=PC.flattenChunks(this.chunks)),this.chunks=[],this.err=s,this.msg=this.strm.msg};var Vg={Deflate:xg,deflate:Ob,deflateRaw:function(s,t){return(t=t||{}).raw=!0,Ob(s,t)},gzip:function(s,t){return(t=t||{}).gzip=!0,Ob(s,t)},constants:Af};let Fg=16209;var f3=function(s,t){let i,a,l,p,f,g,v,y,I,b,k,U,J,K,q,te,de,he,Ue,Re,Ie,De,Ne,Xe,nt=s.state;i=s.next_in,Ne=s.input,a=i+(s.avail_in-5),l=s.next_out,Xe=s.output,p=l-(t-s.avail_out),f=l+(s.avail_out-257),g=nt.dmax,v=nt.wsize,y=nt.whave,I=nt.wnext,b=nt.window,k=nt.hold,U=nt.bits,J=nt.lencode,K=nt.distcode,q=(1<<nt.lenbits)-1,te=(1<<nt.distbits)-1;e:do{U<15&&(k+=Ne[i++]<<U,U+=8,k+=Ne[i++]<<U,U+=8),de=J[k&q];t:for(;;){if(he=de>>>24,k>>>=he,U-=he,he=de>>>16&255,he===0)Xe[l++]=65535&de;else{if(!(16&he)){if(!(64&he)){de=J[(65535&de)+(k&(1<<he)-1)];continue t}if(32&he){nt.mode=16191;break e}s.msg="invalid literal/length code",nt.mode=Fg;break e}Ue=65535&de,he&=15,he&&(U<he&&(k+=Ne[i++]<<U,U+=8),Ue+=k&(1<<he)-1,k>>>=he,U-=he),U<15&&(k+=Ne[i++]<<U,U+=8,k+=Ne[i++]<<U,U+=8),de=K[k&te];n:for(;;){if(he=de>>>24,k>>>=he,U-=he,he=de>>>16&255,!(16&he)){if(!(64&he)){de=K[(65535&de)+(k&(1<<he)-1)];continue n}s.msg="invalid distance code",nt.mode=Fg;break e}if(Re=65535&de,he&=15,U<he&&(k+=Ne[i++]<<U,U+=8,U<he&&(k+=Ne[i++]<<U,U+=8)),Re+=k&(1<<he)-1,Re>g){s.msg="invalid distance too far back",nt.mode=Fg;break e}if(k>>>=he,U-=he,he=l-p,Re>he){if(he=Re-he,he>y&&nt.sane){s.msg="invalid distance too far back",nt.mode=Fg;break e}if(Ie=0,De=b,I===0){if(Ie+=v-he,he<Ue){Ue-=he;do Xe[l++]=b[Ie++];while(--he);Ie=l-Re,De=Xe}}else if(I<he){if(Ie+=v+I-he,he-=I,he<Ue){Ue-=he;do Xe[l++]=b[Ie++];while(--he);if(Ie=0,I<Ue){he=I,Ue-=he;do Xe[l++]=b[Ie++];while(--he);Ie=l-Re,De=Xe}}}else if(Ie+=I-he,he<Ue){Ue-=he;do Xe[l++]=b[Ie++];while(--he);Ie=l-Re,De=Xe}for(;Ue>2;)Xe[l++]=De[Ie++],Xe[l++]=De[Ie++],Xe[l++]=De[Ie++],Ue-=3;Ue&&(Xe[l++]=De[Ie++],Ue>1&&(Xe[l++]=De[Ie++]))}else{Ie=l-Re;do Xe[l++]=Xe[Ie++],Xe[l++]=Xe[Ie++],Xe[l++]=Xe[Ie++],Ue-=3;while(Ue>2);Ue&&(Xe[l++]=Xe[Ie++],Ue>1&&(Xe[l++]=Xe[Ie++]))}break}}break}}while(i<a&&l<f);Ue=U>>3,i-=Ue,U-=Ue<<3,k&=(1<<U)-1,s.next_in=i,s.next_out=l,s.avail_in=i<a?a-i+5:5-(i-a),s.avail_out=l<f?f-l+257:257-(l-f),nt.hold=k,nt.bits=U};let om=15,am=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),_3=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),E3=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),td=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var kf=(s,t,i,a,l,p,f,g)=>{let v=g.bits,y,I,b,k,U,J,K=0,q=0,te=0,de=0,he=0,Ue=0,Re=0,Ie=0,De=0,Ne=0,Xe=null,nt=new Uint16Array(16),Vt=new Uint16Array(16),rn,ui,Ki,_i=null;for(K=0;K<=om;K++)nt[K]=0;for(q=0;q<a;q++)nt[t[i+q]]++;for(he=v,de=om;de>=1&&nt[de]===0;de--);if(he>de&&(he=de),de===0)return l[p++]=20971520,l[p++]=20971520,g.bits=1,0;for(te=1;te<de&&nt[te]===0;te++);for(he<te&&(he=te),Ie=1,K=1;K<=om;K++)if(Ie<<=1,Ie-=nt[K],Ie<0)return-1;if(Ie>0&&(s===0||de!==1))return-1;for(Vt[1]=0,K=1;K<om;K++)Vt[K+1]=Vt[K]+nt[K];for(q=0;q<a;q++)t[i+q]!==0&&(f[Vt[t[i+q]]++]=q);if(s===0?(Xe=_i=f,J=20):s===1?(Xe=am,_i=_3,J=257):(Xe=E3,_i=td,J=0),Ne=0,q=0,K=te,U=p,Ue=he,Re=0,b=-1,De=1<<he,k=De-1,s===1&&De>852||s===2&&De>592)return 1;for(;;){rn=K-Re,f[q]+1<J?(ui=0,Ki=f[q]):f[q]>=J?(ui=_i[f[q]-J],Ki=Xe[f[q]-J]):(ui=96,Ki=0),y=1<<K-Re,I=1<<Ue,te=I;do I-=y,l[U+(Ne>>Re)+I]=rn<<24|ui<<16|Ki|0;while(I!==0);for(y=1<<K-1;Ne&y;)y>>=1;if(y!==0?(Ne&=y-1,Ne+=y):Ne=0,q++,--nt[K]==0){if(K===de)break;K=t[i+f[q]]}if(K>he&&(Ne&k)!==b){for(Re===0&&(Re=he),U+=te,Ue=K-Re,Ie=1<<Ue;Ue+Re<de&&(Ie-=nt[Ue+Re],!(Ie<=0));)Ue++,Ie<<=1;if(De+=1<<Ue,s===1&&De>852||s===2&&De>592)return 1;b=Ne&k,l[b]=he<<24|Ue<<16|U-p|0}}return Ne!==0&&(l[U+Ne]=K-Re<<24|64<<16|0),g.bits=he,0};let{Z_FINISH:Nb,Z_BLOCK:g3,Z_TREES:jg,Z_OK:vl,Z_STREAM_END:LC,Z_NEED_DICT:yu,Z_STREAM_ERROR:ja,Z_DATA_ERROR:MC,Z_MEM_ERROR:Bg,Z_BUF_ERROR:UC,Z_DEFLATED:xC}=Af,yr=16180,Gg=16190,Iu=16191,Au=16192,VC=16194,Wg=16199,Hg=16200,FC=16206,Dr=16209,jC=s=>(s>>>24&255)+(s>>>8&65280)+((65280&s)<<8)+((255&s)<<24);function XP(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}let cm=s=>{if(!s)return 1;let t=s.state;return!t||t.strm!==s||t.mode<yr||t.mode>16211?1:0},Db=s=>{if(cm(s))return ja;let t=s.state;return s.total_in=s.total_out=t.total=0,s.msg="",t.wrap&&(s.adler=1&t.wrap),t.mode=yr,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,vl},QP=s=>{if(cm(s))return ja;let t=s.state;return t.wsize=0,t.whave=0,t.wnext=0,Db(s)},Rl=(s,t)=>{let i;if(cm(s))return ja;let a=s.state;return t<0?(i=0,t=-t):(i=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?ja:(a.window!==null&&a.wbits!==t&&(a.window=null),a.wrap=i,a.wbits=t,QP(s))},ZP=(s,t)=>{if(!s)return ja;let i=new XP;s.state=i,i.strm=s,i.window=null,i.mode=yr;let a=Rl(s,t);return a!==vl&&(s.state=null),a},BC,Pb,$P=!0,Kg=s=>{if($P){BC=new Int32Array(512),Pb=new Int32Array(32);let t=0;for(;t<144;)s.lens[t++]=8;for(;t<256;)s.lens[t++]=9;for(;t<280;)s.lens[t++]=7;for(;t<288;)s.lens[t++]=8;for(kf(1,s.lens,0,288,BC,0,s.work,{bits:9}),t=0;t<32;)s.lens[t++]=5;kf(2,s.lens,0,32,Pb,0,s.work,{bits:5}),$P=!1}s.lencode=BC,s.lenbits=9,s.distcode=Pb,s.distbits=5},GC=(s,t,i,a)=>{let l,p=s.state;return p.window===null&&(p.wsize=1<<p.wbits,p.wnext=0,p.whave=0,p.window=new Uint8Array(p.wsize)),a>=p.wsize?(p.window.set(t.subarray(i-p.wsize,i),0),p.wnext=0,p.whave=p.wsize):(l=p.wsize-p.wnext,l>a&&(l=a),p.window.set(t.subarray(i-a,i-a+l),p.wnext),(a-=l)?(p.window.set(t.subarray(i-a,i),0),p.wnext=a,p.whave=p.wsize):(p.wnext+=l,p.wnext===p.wsize&&(p.wnext=0),p.whave<p.wsize&&(p.whave+=l))),0};var kb=(s,t)=>{let i,a,l,p,f,g,v,y,I,b,k,U,J,K,q,te,de,he,Ue,Re,Ie,De,Ne=0,Xe=new Uint8Array(4),nt,Vt,rn=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(cm(s)||!s.output||!s.input&&s.avail_in!==0)return ja;i=s.state,i.mode===Iu&&(i.mode=Au),f=s.next_out,l=s.output,v=s.avail_out,p=s.next_in,a=s.input,g=s.avail_in,y=i.hold,I=i.bits,b=g,k=v,De=vl;e:for(;;)switch(i.mode){case yr:if(i.wrap===0){i.mode=Au;break}for(;I<16;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(2&i.wrap&&y===35615){i.wbits===0&&(i.wbits=15),i.check=0,Xe[0]=255&y,Xe[1]=y>>>8&255,i.check=Hr(i.check,Xe,2,0),y=0,I=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&y)<<8)+(y>>8))%31){s.msg="incorrect header check",i.mode=Dr;break}if((15&y)!==xC){s.msg="unknown compression method",i.mode=Dr;break}if(y>>>=4,I-=4,Ie=8+(15&y),i.wbits===0&&(i.wbits=Ie),Ie>15||Ie>i.wbits){s.msg="invalid window size",i.mode=Dr;break}i.dmax=1<<i.wbits,i.flags=0,s.adler=i.check=1,i.mode=512&y?16189:Iu,y=0,I=0;break;case 16181:for(;I<16;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(i.flags=y,(255&i.flags)!==xC){s.msg="unknown compression method",i.mode=Dr;break}if(57344&i.flags){s.msg="unknown header flags set",i.mode=Dr;break}i.head&&(i.head.text=y>>8&1),512&i.flags&&4&i.wrap&&(Xe[0]=255&y,Xe[1]=y>>>8&255,i.check=Hr(i.check,Xe,2,0)),y=0,I=0,i.mode=16182;case 16182:for(;I<32;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}i.head&&(i.head.time=y),512&i.flags&&4&i.wrap&&(Xe[0]=255&y,Xe[1]=y>>>8&255,Xe[2]=y>>>16&255,Xe[3]=y>>>24&255,i.check=Hr(i.check,Xe,4,0)),y=0,I=0,i.mode=16183;case 16183:for(;I<16;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}i.head&&(i.head.xflags=255&y,i.head.os=y>>8),512&i.flags&&4&i.wrap&&(Xe[0]=255&y,Xe[1]=y>>>8&255,i.check=Hr(i.check,Xe,2,0)),y=0,I=0,i.mode=16184;case 16184:if(1024&i.flags){for(;I<16;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}i.length=y,i.head&&(i.head.extra_len=y),512&i.flags&&4&i.wrap&&(Xe[0]=255&y,Xe[1]=y>>>8&255,i.check=Hr(i.check,Xe,2,0)),y=0,I=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&i.flags&&(U=i.length,U>g&&(U=g),U&&(i.head&&(Ie=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(a.subarray(p,p+U),Ie)),512&i.flags&&4&i.wrap&&(i.check=Hr(i.check,a,U,p)),g-=U,p+=U,i.length-=U),i.length))break e;i.length=0,i.mode=16186;case 16186:if(2048&i.flags){if(g===0)break e;U=0;do Ie=a[p+U++],i.head&&Ie&&i.length<65536&&(i.head.name+=String.fromCharCode(Ie));while(Ie&&U<g);if(512&i.flags&&4&i.wrap&&(i.check=Hr(i.check,a,U,p)),g-=U,p+=U,Ie)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&i.flags){if(g===0)break e;U=0;do Ie=a[p+U++],i.head&&Ie&&i.length<65536&&(i.head.comment+=String.fromCharCode(Ie));while(Ie&&U<g);if(512&i.flags&&4&i.wrap&&(i.check=Hr(i.check,a,U,p)),g-=U,p+=U,Ie)break e}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&i.flags){for(;I<16;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(4&i.wrap&&y!==(65535&i.check)){s.msg="header crc mismatch",i.mode=Dr;break}y=0,I=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),s.adler=i.check=0,i.mode=Iu;break;case 16189:for(;I<32;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}s.adler=i.check=jC(y),y=0,I=0,i.mode=Gg;case Gg:if(i.havedict===0)return s.next_out=f,s.avail_out=v,s.next_in=p,s.avail_in=g,i.hold=y,i.bits=I,yu;s.adler=i.check=1,i.mode=Iu;case Iu:if(t===g3||t===jg)break e;case Au:if(i.last){y>>>=7&I,I-=7&I,i.mode=FC;break}for(;I<3;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}switch(i.last=1&y,y>>>=1,I-=1,3&y){case 0:i.mode=16193;break;case 1:if(Kg(i),i.mode=Wg,t===jg){y>>>=2,I-=2;break e}break;case 2:i.mode=16196;break;case 3:s.msg="invalid block type",i.mode=Dr}y>>>=2,I-=2;break;case 16193:for(y>>>=7&I,I-=7&I;I<32;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if((65535&y)!=(y>>>16^65535)){s.msg="invalid stored block lengths",i.mode=Dr;break}if(i.length=65535&y,y=0,I=0,i.mode=VC,t===jg)break e;case VC:i.mode=16195;case 16195:if(U=i.length,U){if(U>g&&(U=g),U>v&&(U=v),U===0)break e;l.set(a.subarray(p,p+U),f),g-=U,p+=U,v-=U,f+=U,i.length-=U;break}i.mode=Iu;break;case 16196:for(;I<14;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(i.nlen=257+(31&y),y>>>=5,I-=5,i.ndist=1+(31&y),y>>>=5,I-=5,i.ncode=4+(15&y),y>>>=4,I-=4,i.nlen>286||i.ndist>30){s.msg="too many length or distance symbols",i.mode=Dr;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;I<3;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}i.lens[rn[i.have++]]=7&y,y>>>=3,I-=3}for(;i.have<19;)i.lens[rn[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,nt={bits:i.lenbits},De=kf(0,i.lens,0,19,i.lencode,0,i.work,nt),i.lenbits=nt.bits,De){s.msg="invalid code lengths set",i.mode=Dr;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;Ne=i.lencode[y&(1<<i.lenbits)-1],q=Ne>>>24,te=Ne>>>16&255,de=65535&Ne,!(q<=I);){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(de<16)y>>>=q,I-=q,i.lens[i.have++]=de;else{if(de===16){for(Vt=q+2;I<Vt;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(y>>>=q,I-=q,i.have===0){s.msg="invalid bit length repeat",i.mode=Dr;break}Ie=i.lens[i.have-1],U=3+(3&y),y>>>=2,I-=2}else if(de===17){for(Vt=q+3;I<Vt;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}y>>>=q,I-=q,Ie=0,U=3+(7&y),y>>>=3,I-=3}else{for(Vt=q+7;I<Vt;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}y>>>=q,I-=q,Ie=0,U=11+(127&y),y>>>=7,I-=7}if(i.have+U>i.nlen+i.ndist){s.msg="invalid bit length repeat",i.mode=Dr;break}for(;U--;)i.lens[i.have++]=Ie}}if(i.mode===Dr)break;if(i.lens[256]===0){s.msg="invalid code -- missing end-of-block",i.mode=Dr;break}if(i.lenbits=9,nt={bits:i.lenbits},De=kf(1,i.lens,0,i.nlen,i.lencode,0,i.work,nt),i.lenbits=nt.bits,De){s.msg="invalid literal/lengths set",i.mode=Dr;break}if(i.distbits=6,i.distcode=i.distdyn,nt={bits:i.distbits},De=kf(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,nt),i.distbits=nt.bits,De){s.msg="invalid distances set",i.mode=Dr;break}if(i.mode=Wg,t===jg)break e;case Wg:i.mode=Hg;case Hg:if(g>=6&&v>=258){s.next_out=f,s.avail_out=v,s.next_in=p,s.avail_in=g,i.hold=y,i.bits=I,f3(s,k),f=s.next_out,l=s.output,v=s.avail_out,p=s.next_in,a=s.input,g=s.avail_in,y=i.hold,I=i.bits,i.mode===Iu&&(i.back=-1);break}for(i.back=0;Ne=i.lencode[y&(1<<i.lenbits)-1],q=Ne>>>24,te=Ne>>>16&255,de=65535&Ne,!(q<=I);){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(te&&!(240&te)){for(he=q,Ue=te,Re=de;Ne=i.lencode[Re+((y&(1<<he+Ue)-1)>>he)],q=Ne>>>24,te=Ne>>>16&255,de=65535&Ne,!(he+q<=I);){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}y>>>=he,I-=he,i.back+=he}if(y>>>=q,I-=q,i.back+=q,i.length=de,te===0){i.mode=16205;break}if(32&te){i.back=-1,i.mode=Iu;break}if(64&te){s.msg="invalid literal/length code",i.mode=Dr;break}i.extra=15&te,i.mode=16201;case 16201:if(i.extra){for(Vt=i.extra;I<Vt;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}i.length+=y&(1<<i.extra)-1,y>>>=i.extra,I-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;Ne=i.distcode[y&(1<<i.distbits)-1],q=Ne>>>24,te=Ne>>>16&255,de=65535&Ne,!(q<=I);){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(!(240&te)){for(he=q,Ue=te,Re=de;Ne=i.distcode[Re+((y&(1<<he+Ue)-1)>>he)],q=Ne>>>24,te=Ne>>>16&255,de=65535&Ne,!(he+q<=I);){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}y>>>=he,I-=he,i.back+=he}if(y>>>=q,I-=q,i.back+=q,64&te){s.msg="invalid distance code",i.mode=Dr;break}i.offset=de,i.extra=15&te,i.mode=16203;case 16203:if(i.extra){for(Vt=i.extra;I<Vt;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}i.offset+=y&(1<<i.extra)-1,y>>>=i.extra,I-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){s.msg="invalid distance too far back",i.mode=Dr;break}i.mode=16204;case 16204:if(v===0)break e;if(U=k-v,i.offset>U){if(U=i.offset-U,U>i.whave&&i.sane){s.msg="invalid distance too far back",i.mode=Dr;break}U>i.wnext?(U-=i.wnext,J=i.wsize-U):J=i.wnext-U,U>i.length&&(U=i.length),K=i.window}else K=l,J=f-i.offset,U=i.length;U>v&&(U=v),v-=U,i.length-=U;do l[f++]=K[J++];while(--U);i.length===0&&(i.mode=Hg);break;case 16205:if(v===0)break e;l[f++]=i.length,v--,i.mode=Hg;break;case FC:if(i.wrap){for(;I<32;){if(g===0)break e;g--,y|=a[p++]<<I,I+=8}if(k-=v,s.total_out+=k,i.total+=k,4&i.wrap&&k&&(s.adler=i.check=i.flags?Hr(i.check,l,k,f-k):Zc(i.check,l,k,f-k)),k=v,4&i.wrap&&(i.flags?y:jC(y))!==i.check){s.msg="incorrect data check",i.mode=Dr;break}y=0,I=0}i.mode=16207;case 16207:if(i.wrap&&i.flags){for(;I<32;){if(g===0)break e;g--,y+=a[p++]<<I,I+=8}if(4&i.wrap&&y!==(4294967295&i.total)){s.msg="incorrect length check",i.mode=Dr;break}y=0,I=0}i.mode=16208;case 16208:De=LC;break e;case Dr:De=MC;break e;case 16210:return Bg;default:return ja}return s.next_out=f,s.avail_out=v,s.next_in=p,s.avail_in=g,i.hold=y,i.bits=I,(i.wsize||k!==s.avail_out&&i.mode<Dr&&(i.mode<FC||t!==Nb))&&GC(s,s.output,s.next_out,k-s.avail_out),b-=s.avail_in,k-=s.avail_out,s.total_in+=b,s.total_out+=k,i.total+=k,4&i.wrap&&k&&(s.adler=i.check=i.flags?Hr(i.check,l,k,s.next_out-k):Zc(i.check,l,k,s.next_out-k)),s.data_type=i.bits+(i.last?64:0)+(i.mode===Iu?128:0)+(i.mode===Wg||i.mode===VC?256:0),(b===0&&k===0||t===Nb)&&De===vl&&(De=UC),De},wu={inflateReset:QP,inflateReset2:Rl,inflateResetKeep:Db,inflateInit:s=>ZP(s,15),inflateInit2:ZP,inflate:kb,inflateEnd:s=>{if(cm(s))return ja;let t=s.state;return t.window&&(t.window=null),s.state=null,vl},inflateGetHeader:(s,t)=>{if(cm(s))return ja;let i=s.state;return 2&i.wrap?(i.head=t,t.done=!1,vl):ja},inflateSetDictionary:(s,t)=>{let i=t.length,a,l,p;return cm(s)?ja:(a=s.state,a.wrap!==0&&a.mode!==Gg?ja:a.mode===Gg&&(l=1,l=Zc(l,t,i,0),l!==a.check)?MC:(p=GC(s,t,i,i),p?(a.mode=16210,Bg):(a.havedict=1,vl)))},inflateInfo:"pako inflate (from Nodeca project)"},ek=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};let tk=Object.prototype.toString,{Z_NO_FLUSH:Yg,Z_FINISH:Lb,Z_OK:zg,Z_STREAM_END:nk,Z_NEED_DICT:Mb,Z_STREAM_ERROR:t5,Z_DATA_ERROR:S3,Z_MEM_ERROR:n5}=Af;function qg(s){this.options=PC.assign({chunkSize:65536,windowBits:15,to:""},s||{});let t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||s&&s.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new qP,this.strm.avail_out=0;let i=wu.inflateInit2(this.strm,t.windowBits);if(i!==zg)throw new Error(em[i]);if(this.header=new ek,wu.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=Mg.string2buf(t.dictionary):tk.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=wu.inflateSetDictionary(this.strm,t.dictionary),i!==zg)))throw new Error(em[i])}function ik(s,t){let i=new qg(t);if(i.push(s),i.err)throw i.msg||em[i.err];return i.result}qg.prototype.push=function(s,t){let i=this.strm,a=this.options.chunkSize,l=this.options.dictionary,p,f,g;if(this.ended)return!1;for(f=t===~~t?t:t===!0?Lb:Yg,tk.call(s)==="[object ArrayBuffer]"?i.input=new Uint8Array(s):i.input=s,i.next_in=0,i.avail_in=i.input.length;;){for(i.avail_out===0&&(i.output=new Uint8Array(a),i.next_out=0,i.avail_out=a),p=wu.inflate(i,f),p===Mb&&l&&(p=wu.inflateSetDictionary(i,l),p===zg?p=wu.inflate(i,f):p===S3&&(p=Mb));i.avail_in>0&&p===nk&&i.state.wrap>0&&s[i.next_in]!==0;)wu.inflateReset(i),p=wu.inflate(i,f);switch(p){case t5:case S3:case Mb:case n5:return this.onEnd(p),this.ended=!0,!1}if(g=i.avail_out,i.next_out&&(i.avail_out===0||p===nk))if(this.options.to==="string"){let v=Mg.utf8border(i.output,i.next_out),y=i.next_out-v,I=Mg.buf2string(i.output,v);i.next_out=y,i.avail_out=a-y,y&&i.output.set(i.output.subarray(v,v+y),0),this.onData(I)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(p!==zg||g!==0){if(p===nk)return p=wu.inflateEnd(this.strm),this.onEnd(p),this.ended=!0,!0;if(i.avail_in===0)break}}return!0},qg.prototype.onData=function(s){this.chunks.push(s)},qg.prototype.onEnd=function(s){s===zg&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=PC.flattenChunks(this.chunks)),this.chunks=[],this.err=s,this.msg=this.strm.msg};var i5={Inflate:qg,inflate:ik,inflateRaw:function(s,t){return(t=t||{}).raw=!0,ik(s,t)},ungzip:ik,constants:Af};let{Deflate:rk,deflate:T3,deflateRaw:r5,gzip:s5}=Vg,{Inflate:C3,inflate:v3,inflateRaw:R3,ungzip:o5}=i5;var Ub,xb=T3,y3=v3;(function(s){s[s.ONE_BYTE=0]="ONE_BYTE",s[s.TWO_BYTE=1]="TWO_BYTE"})(Ub||(Ub={}));class Vb{constructor(){P(this,"_sequence",0),P(this,"_startTime",Date.now()),P(this,"isUseOneByte",!0)}get startTime(){let t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){let i={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){let g=new Uint8Array(4);g.set([1,0,0,0]);let v={id:0,length:4,data:g.buffer},y={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[v]};i.commonPacketHeader.extension=1,i.extension=y,i.payload=this.compress(t),i.commonPacketHeader.length=8+(i.extension.length+2)+i.payload.byteLength}else i.commonPacketHeader.length=8+i.payload.byteLength;ce("SHOW_DATASTREAM2_LOG")&&x.debug("send data header: ".concat(JSON.stringify(i.commonPacketHeader)));let a=new ArrayBuffer(i.commonPacketHeader.length),l=new Uint8Array(a),p=new DataView(a),f=0;if(p.setUint16(f,i.commonPacketHeader.extension<<15|i.commonPacketHeader.reserved<<14|i.commonPacketHeader.length,!0),f+=2,p.setUint32(f,i.commonPacketHeader.sequence,!0),f+=4,p.setUint16(f,i.commonStreamHeader,!0),f+=2,i.extension){let g=this.serializeExtension(i.extension);l.set(new Uint8Array(g),f),f+=g.byteLength}if(l.set(new Uint8Array(i.payload),f),f+=i.payload.byteLength,f!==i.commonPacketHeader.length)throw Error("serialize error!");return a}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);let i=new DataView(t),a=0,l=i.getUint16(a,!0);a+=2;let p={length:16383&l,reserved:(16384&l)>>14,extension:(32768&l)>>15,sequence:i.getUint16(a+2,!0)<<16|i.getUint16(a,!0)},f,g;if(a+=4,ce("SHOW_DATASTREAM2_LOG")&&x.debug("receive data header: ".concat(JSON.stringify(p))),i.getUint16(a,!0),a+=2,p.extension){g=this.deserializeExtension(t.slice(a)),a+=2+g.length,f=t.slice(a);let v=!1;if(g.datas.length>0){let y=g.datas.find(I=>I.id===0);y&&(v=(1&new DataView(y.data).getUint32(0,!0))==1)}f=v?this.decompress(f):f}else f=t.slice(8);return f}serializeExtension(t){let{profile:i,length:a,datas:l}=t,p=new ArrayBuffer(a+2),f=new Uint8Array(p),g=new DataView(p),v=0;if(g.setUint8(v++,i),g.setUint8(v++,a),l.forEach(y=>{i?(g.setUint8(v++,y.id),g.setUint8(v++,y.length),f.set(new Uint8Array(y.data),v),v+=y.data.byteLength):(g.setUint8(v++,y.id|y.length<<4),f.set(new Uint8Array(y.data),v),v+=y.data.byteLength)}),v!==a+2)throw Error("serialize extension error, is ".concat(v,"!==").concat(a+2));return p}deserializeExtension(t){let i=new DataView(t),a=0,l=i.getUint8(a);a++;let p=i.getUint8(a);a++;let f=l===Ub.TWO_BYTE,g=[],v=new DataView(t,2),y=0;for(;y<p;){let I=0,b=0,k=new ArrayBuffer(0);f?(I=v.getUint8(y),y++,b=v.getUint8(y),y++):(I=15&v.getUint8(y),b=v.getUint8(y)>>4,y++),b>0&&(k=v.buffer.slice(y+2,y+2+b),y+=k.byteLength),g.push({id:I,length:b,data:k})}if(y!==p)throw Error("parse error");return{profile:l,length:p,datas:g}}decompress(t){return y3(new Uint8Array(t))}compress(t){return xb(new Uint8Array(t))}}class dm extends ri{constructor(t,i){super(),P(this,"_version",1),P(this,"_type",3),P(this,"_config",void 0),P(this,"_originDataChannel",void 0),P(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),P(this,"_dataStreamPacketHandler",void 0),P(this,"_datachannelEventMap",new Map),this._config=t,i&&(this._originDataChannel=i,this._bandDataChannelEvents(i)),this._initPacketHeader(),this._dataStreamPacketHandler=new Vb}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return ce("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,i;return(t=(i=this._originDataChannel)===null||i===void 0?void 0:i.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,i;return(t=(i=this._originDataChannel)===null||i===void 0?void 0:i.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Pe((t,i)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();let a=setTimeout(()=>{var l;i(new Ve(Z.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((l=this._originDataChannel)===null||l===void 0?void 0:l.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(a),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(a),new Ve(Z.DATACHANNEL_CONNECTION_TIMEOUT)}}else i(new Ve(Z.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){let t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[Wp.OPEN,Wp.CLOSE,Wp.ERROR].forEach(i=>{let a=()=>{this.emit(i)};this._datachannelEventMap.set(i,a),t.addEventListener(i,a)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(i=>{let[a,l]=i;t.removeEventListener(a,l)}),this._datachannelEventMap.clear()}}class WC extends dm{constructor(t){super(t),P(this,"_messageListener",void 0),this._messageListener=i=>{if(i.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let a=i.data.slice(0,this._dataStreamPacketHeader.byteLength),l=new DataView(a).getUint8(3);if(l!==this.id)return void(ce("SHOW_DATASTREAM2_LOG")&&x.debug("invalid datachannel id: ".concat(l," !== ").concat(this.id)));let p=i.data.slice(this._dataStreamPacketHeader.byteLength);p=this._dataStreamPacketHandler.deserialize(p),this.emit(Wp.MESSAGE,p)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class Ld extends dm{send(t){if(this._originDataChannel){let i=t;i=this._dataStreamPacketHandler.serialize(t);let a=new Uint8Array(this._dataStreamPacketHeader.byteLength+i.byteLength);a.set(new Uint8Array(this._dataStreamPacketHeader),0),a.set(new Uint8Array(i),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(a.buffer)}}}(function(){let s=En();Zi.getDisplayMedia=function(t){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),Zi.getStreamFromExtension=s.name===Ee.CHROME&&Number(s.version)>34,Zi.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let t=new RTCPeerConnection,i=!1;try{t.addTransceiver("audio"),i=!0}catch{}return t.close(),i}(),Zi.supportMinBitrate=s.name===Ee.CHROME||s.name===Ee.EDGE,Zi.supportSetRtpSenderParameters=function(){let t=En();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!Ql()||!(!qt()&&!Jm())||t.name===Ee.FIREFOX&&Number(t.version)>=64}(),s.name===Ee.SAFARI&&(Number(s.version)>=14?Zi.supportDualStream=!0:Zi.supportDualStream=!1),Zi.webAudioMediaStreamDest=function(){let t=En();return!(t.name===Ee.SAFARI&&Number(t.version)<12)}(),Zi.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),Zi.supportWebGL=typeof WebGLRenderingContext<"u",Zi.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Ql()||(Zi.webAudioWithAEC=!0),Zi.supportShareAudio=function(){let t=En();return(t.os===Cr.WIN_10||t.os===Cr.WIN_81||t.os===Cr.WIN_7||t.os===Cr.LINUX||t.os===Cr.MAC_OS||t.os===Cr.CHROMIUM_OS)&&t.name===Ee.CHROME&&Number(t.version)>=74}(),Zi.supportDataChannel=function(){return!!(Xm(76)||function(t){let i=En();return!(i.name!==Ee.FIREFOX||!i.osVersion)&&Number(i.version)>=t}(68)||function(t){let i=En();return!(i.name!==Ee.SAFARI||!i.osVersion)&&Number(i.version)>=t}(14))}(),Zi.supportPCSetConfiguration=function(){let t=window.RTCPeerConnection;return!Hn()&&!!t&&t.prototype.setConfiguration instanceof Function}(),Zi.supportWebRTCEncodedTransform=function(){let t=En();return t.name==="Chrome"&&Number(t.version)>=86}(),Zi.supportWebRTCInsertableStream=function(){let t=En();return(t.name===Ee.CHROME||t.name===Ee.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),mo(()=>{Zi.supportDualStreamEncoding=function(){let t=En();return ce("DISABLE_WEBAUDIO")?!0:t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&ce("CHROME_DUAL_STREAM_USE_ENCODING"))}(),x.info("browser compatibility",JSON.stringify(Zi),JSON.stringify(s))})})();class Lf extends ri{constructor(){super(...arguments),P(this,"resultStorage",new Map)}setLocalAudioStats(t,i,a){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(a,i)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(a,i))}setLocalVideoStats(t,i,a){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(a,i)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(a,i)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(a))}setRemoteAudioStats(t,i){let a=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",a,this.checkAudioOutputLevel(i))}setRemoteVideoStats(t,i){let a=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",a,this.checkVideoDecode(i))}record(t,i,a){if(ce("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});let l=this.resultStorage.get(t);if(l&&(l.result.push(a),l.result.length>=5)){var p;let f=xe(p=l.result).call(p,!0);l.isPrevNormal&&!f&&this.emit("exception",Fb[t],t,i),!l.isPrevNormal&&f&&this.emit("exception",Fb[t]+2e3,t+"_RECOVER",i),l.isPrevNormal=f,l.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,i){return i instanceof lr&&!i.isActive||!!i.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,i){let a=null;i._encoderConfig&&i._encoderConfig.frameRate&&(a=zo(i._encoderConfig.frameRate));let l=t.captureFrameRate;return!a||!l||!(a>10&&l<5||a<10&&a>=5&&l<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checkSendVideoBitrate(t,i){return!!i.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,i){return i instanceof lr&&!i.isActive||!!i.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}let Fb={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Is=new class{markSubscribeStart(s,t){performance.mark("agora-web-sdk/".concat(s,"/subscribe-").concat(t))}markPublishStart(s,t){performance.mark("agora-web-sdk/".concat(s,"/publish-").concat(t))}measureFromSubscribeStart(s,t){let i=performance.getEntriesByName("agora-web-sdk/".concat(s,"/subscribe-").concat(t));if(i.length>0){let a=i[i.length-1];return Math.round(performance.now()-a.startTime)}return 0}measureFromPublishStart(s,t){let i=performance.getEntriesByName("agora-web-sdk/".concat(s,"/publish-").concat(t));if(i.length>0){let a=i[i.length-1];return Math.round(performance.now()-a.startTime)}return 0}};function jb(s,t){this.v=s,this.k=t}function nn(s){return new jb(s,0)}var I3=OT,A3=Fc;Xt({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var s=A3.f(this);return{promise:s.promise,resolve:s.resolve,reject:s.reject}}});var Bb=Fc,sk=Rp;Xt({target:"Promise",stat:!0,forced:!0},{try:function(s){var t=Bb.f(this),i=sk(s);return(i.error?t.reject:t.resolve)(i.value),t.promise}});var Jg=A(I3),ok=Td.f("asyncIterator"),w3=A(ok);function Xg(s){var t,i;function a(p,f){try{var g=s[p](f),v=g.value,y=v instanceof jb;Jg.resolve(y?v.v:v).then(function(I){if(y){var b=p==="return"?"return":"next";if(!v.k||I.done)return a(b,I);I=s[b](I).value}l(g.done?"return":"normal",I)},function(I){a("throw",I)})}catch(I){l("throw",I)}}function l(p,f){switch(p){case"return":t.resolve({value:f,done:!0});break;case"throw":t.reject(f);break;default:t.resolve({value:f,done:!1})}(t=t.next)?a(t.key,t.arg):i=null}this._invoke=function(p,f){return new Jg(function(g,v){var y={key:p,arg:f,resolve:g,reject:v,next:null};i?i=i.next=y:(t=i=y,a(p,f))})},typeof s.return!="function"&&(this.return=void 0)}function Ca(s){return function(){return new Xg(s.apply(this,arguments))}}Xg.prototype[typeof gp=="function"&&w3||"@@asyncIterator"]=function(){return this},Xg.prototype.next=function(s){return this._invoke("next",s)},Xg.prototype.throw=function(s){return this._invoke("throw",s)},Xg.prototype.return=function(s){return this._invoke("return",s)};var Gb=A(po.Object.getOwnPropertySymbols),va=Xt,b3=B_.indexOf,ak=nT,Qg=Ht([].indexOf),ck=!!Qg&&1/Qg([1],1,-0)<0;va({target:"Array",proto:!0,forced:ck||!ak("indexOf")},{indexOf:function(s){var t=arguments.length>1?arguments[1]:void 0;return ck?Qg(this,s,t)||0:b3(this,s,t)}});var Mf=sa("Array").indexOf,O3=ge,N3=Mf,lm=Array.prototype,Wb=A(function(s){var t=s.indexOf;return s===lm||O3(lm,s)&&t===lm.indexOf?N3:t}),dk=Oo,_c=km;Xt({target:"Object",stat:!0,forced:O(function(){_c(1)})},{keys:function(s){return _c(dk(s))}});var D3=A(po.Object.keys);function P3(s,t){if(s==null)return{};var i,a,l=function(f,g){if(f==null)return{};var v,y,I={},b=D3(f);for(y=0;y<b.length;y++)v=b[y],Wb(g).call(g,v)>=0||(I[v]=f[v]);return I}(s,t);if(Gb){var p=Gb(s);for(a=0;a<p.length;a++)i=p[a],Wb(t).call(t,i)>=0||Object.prototype.propertyIsEnumerable.call(s,i)&&(l[i]=s[i])}return l}var HC={exports:{}};(function(s,t){s.exports=(()=>{var i={8:(p,f,g)=>{g.r(f),g.d(f,{Parser:()=>Vt,Printer:()=>Ia,parse:()=>Wt,print:()=>_n});let v=`
`,y="".concat("\r").concat(v),I=" ",b;function k(ot){return ot>="0"&&ot<="9"}function U(ot){return ot>="!"&&ot<="~"}function J(ot){return U(ot)||ot>=""&&ot<="ÿ"}function K(ot){return ot==="!"||ot>="#"&&ot<="'"||ot>="*"&&ot<="+"||ot>="-"&&ot<="."||ot>="0"&&ot<="9"||ot>="A"&&ot<="Z"||ot>="^"&&ot<="~"}function q(ot){return ot>="1"&&ot<="9"}function te(ot){return ot>="A"&&ot<="Z"||ot>="a"&&ot<="z"}function de(ot){return ot==="d"||ot==="h"||ot==="m"||ot==="s"}function he(ot){return ot>""&&ot<"	"||ot>"\v"&&ot<"\f"||ot>""&&ot<"ÿ"}function Ue(ot){return te(ot)||k(ot)||ot==="+"||ot==="/"}function Re(ot){return k(ot)||te(ot)||ot==="+"||ot==="/"||ot==="-"||ot==="_"}function Ie(ot){return te(ot)||k(ot)||ot==="+"||ot==="/"}function De(ot,B){var ie=Object.keys(ot);if(Object.getOwnPropertySymbols){var pe=Object.getOwnPropertySymbols(ot);B&&(pe=pe.filter(function(Ze){return Object.getOwnPropertyDescriptor(ot,Ze).enumerable})),ie.push.apply(ie,pe)}return ie}function Ne(ot){for(var B=1;B<arguments.length;B++){var ie=arguments[B]!=null?arguments[B]:{};B%2?De(Object(ie),!0).forEach(function(pe){Xe(ot,pe,ie[pe])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ot,Object.getOwnPropertyDescriptors(ie)):De(Object(ie)).forEach(function(pe){Object.defineProperty(ot,pe,Object.getOwnPropertyDescriptor(ie,pe))})}return ot}function Xe(ot,B,ie){return B in ot?Object.defineProperty(ot,B,{value:ie,enumerable:!0,configurable:!0,writable:!0}):ot[B]=ie,ot}(function(ot){ot.VERSION="v",ot.ORIGIN="o",ot.SESSION_NAME="s",ot.INFORMATION="i",ot.URI="u",ot.EMAIL="e",ot.PHONE="p",ot.CONNECTION="c",ot.BANDWIDTH="b",ot.TIME="t",ot.REPEAT="r",ot.ZONE_ADJUSTMENTS="z",ot.KEY="k",ot.ATTRIBUTE="a",ot.MEDIA="m"})(b||(b={}));class nt{consumeText(B,ie){let pe=ie;for(;pe<B.length;){let Ze=B[pe];if(Ze==="\0"||Ze==="\r"||Ze===v)break;pe+=1}if(pe-ie==0)throw new Error("Invalid text, at ".concat(B));return pe}consumeUnicastAddress(B,ie,pe){return this.consumeTill(B,ie,I)}consumeOneOrMore(B,ie,pe){let Ze=ie;for(;pe(B[Ze]);)Ze++;if(Ze-ie==0)throw new Error("Invalid rule at ".concat(ie,"."));return Ze}consumeSpace(B,ie){if(B[ie]===I)return ie+1;throw new Error("Invalid space at ".concat(ie,"."))}consumeIP4Address(B,ie){let pe=ie;for(let Ze=0;Ze<4;Ze++)if(pe=this.consumeDecimalUChar(B,pe),Ze!==3){if(B[pe]!==".")throw new Error("Invalid IP4 address.");pe++}return pe}consumeDecimalUChar(B,ie){let pe=ie;for(let zt=0;zt<3&&k(B[pe]);zt++,pe++);if(pe-ie==0)throw new Error("Invalid decimal uchar.");let Ze=parseInt(B.slice(ie,pe));if(Ze>=0&&Ze<=255)return pe;throw new Error("Invalid decimal uchar")}consumeIP6Address(B,ie){let pe=this.consumeHexpart(B,ie);return B[pe]===":"&&(pe+=1,pe=this.consumeIP4Address(B,pe)),pe}consumeHexpart(B,ie){let pe=ie;if(B[pe]===":"&&B[pe+1]===":"){pe+=2;try{pe=this.consumeHexseq(B,pe)}catch{}return pe}if(pe=this.consumeHexseq(B,pe),B[pe]===":"&&B[pe+1]===":"){pe+=2;try{pe=this.consumeHexseq(B,pe)}catch{}return pe}return pe}consumeHexseq(B,ie){let pe=ie;for(;pe=this.consumeHex4(B,pe),B[pe]===":"&&B[pe+1]!==":";)pe+=1;return pe}consumeHex4(B,ie){let pe=0;for(;pe<4;pe++)if(!((Ze=B[ie+pe])>="0"&&Ze<="9"||Ze>="a"&&Ze<="f"||Ze>="A"&&Ze<="F")){if(pe===0)throw new Error("Invalid hex 4");break}var Ze;return ie+pe}consumeFQDN(B,ie){let pe=ie;for(;k(B[pe])||te(B[pe])||B[pe]==="-"||B[pe]===".";)pe+=1;if(pe-ie<4)throw new Error("Invalid FQDN");return pe}consumeExtnAddr(B,ie){return this.consumeOneOrMore(B,ie,J)}consumeMulticastAddress(B,ie,pe){switch(pe){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(B,ie);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(B,ie);default:try{return this.consumeFQDN(B,ie)}catch{return this.consumeExtnAddr(B,ie)}}}consumeIP6MulticastAddress(B,ie){let pe=this.consumeHexpart(B,ie);return B[pe]==="/"?this.consumeInteger(B,pe+1):pe}consumeIP4MulticastAddress(B,ie){let pe=ie+3,Ze=B.slice(ie,pe),zt=parseInt(Ze);if(zt<224||zt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Ei=0;Ei<3;Ei++){if(B[pe]!==".")throw new Error("Invalid IP4 multicast address.");pe+=1,pe=this.consumeDecimalUChar(B,pe)}return B[pe]==="/"&&(pe+=1),pe=this.consumeTTL(B,pe),B[pe]==="/"&&(pe=this.consumeInteger(B,pe)),pe}consumeInteger(B,ie){if(!q(B[ie]))throw new Error("Invalid integer.");for(ie+=1;k(B[ie]);)ie+=1;return ie}consumeTTL(B,ie){if(B[ie]==="0")return ie+1;if(!q(B[ie]))throw new Error("Invalid TTL.");ie+=1;for(let pe=0;pe<2&&k(B[ie]);pe++)ie+=1;return ie}consumeToken(B,ie){return this.consumeOneOrMore(B,ie,K)}consumeTime(B,ie){let pe=ie;if(B[pe]==="0")return pe+1;for(q(B[pe])&&(pe+=1);k(B[pe]);)pe++;if(pe-ie<10)throw new Error("Invalid time");return pe}consumeAddress(B,ie){return this.consumeTill(B,ie,I)}consumeTypedTime(B,ie){let pe=ie;return pe=this.consumeOneOrMore(B,pe,k),de(B[pe])?pe+1:pe}consumeRepeatInterval(B,ie){if(!q(B[ie]))throw new Error("Invalid repeat interval");for(ie+=1;k(B[ie]);)ie+=1;return de(B[ie])&&(ie+=1),ie}consumePort(B,ie){return this.consumeOneOrMore(B,ie,k)}consume(B,ie,pe){for(let Ze=0;Ze<pe.length;Ze++){if(ie+Ze>=B.length)throw new Error("consume exceeding value length");if(B[ie+Ze]!==pe[Ze])throw new Error("consume ".concat(pe," failed at ").concat(Ze))}return ie+pe.length}consumeTill(B,ie,pe){let Ze=ie;for(;Ze<B.length&&(typeof pe!="string"||B[Ze]!==pe)&&(typeof pe!="function"||!pe(B[Ze]));)Ze++;return Ze}}class Vt extends nt{constructor(){super(),Xe(this,"records",[]),Xe(this,"currentLine",0)}parse(B){let ie=this.probeEOL(B);this.records=B.split(ie).filter(Er=>!!Er.trim()).map(this.parseLine),this.currentLine=0;let pe=this.parseVersion(),Ze=this.parseOrigin(),zt=this.parseSessionName(),Ei=this.parseInformation(),Mr=this.parseUri(),jo=this.parseEmail(),Bd=this.parsePhone(),SS=this.parseConnection(),Aa=this.parseBandWidth(),Ro=this.parseTimeFields(),yo=this.parseKey(),wl=this.parseSessionAttribute(),vi=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:pe,origin:Ze,sessionName:zt,information:Ei,uri:Mr,emails:jo,phones:Bd,connection:SS,bandwidths:Aa,timeFields:Ro,key:yo,attributes:wl,mediaDescriptions:vi}}getCurrentRecord(){let B=this.records[this.currentLine];if(!B)throw new Error("Record doesn't exit.");return B}probeEOL(B){for(let ie=0;ie<B.length;ie++)if(B[ie]===v)return B[ie-1]==="\r"?y:v;throw new Error("Invalid newline character.")}parseLine(B,ie){if(B.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let pe=B[0];if(B[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:pe,value:B.slice(2),line:ie,cur:0}}parseSessionAttribute(){let B=new ui;for(;this.currentLine<this.records.length;){let ie=this.getCurrentRecord();if(ie.type!==b.ATTRIBUTE)break;let pe={attField:this.extractOneOrMore(ie,Ze=>K(Ze)&&Ze!==":"),_cur:0};ie.value[ie.cur]===":"&&(ie.cur+=1,pe.attValue=this.extractOneOrMore(ie,he)),B.parse(pe),this.currentLine++}return B.digest()}parseMediaAttributes(B){let ie=new Ki(B);for(;this.currentLine<this.records.length;){let pe=this.getCurrentRecord();if(pe.type!==b.ATTRIBUTE)break;let Ze={attField:this.extractOneOrMore(pe,zt=>K(zt)&&zt!==":"),_cur:0};pe.value[pe.cur]===":"&&(pe.cur+=1,Ze.attValue=this.extractOneOrMore(pe,he)),ie.parse(Ze),this.currentLine++}return ie.digest()}parseKey(){let B=this.getCurrentRecord();if(B.type===b.KEY){if(B.value==="prompt"||B.value==="clear:"||B.value==="base64:"||B.value==="uri:")return B.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){let B=this.getCurrentRecord();if(B.type===b.ZONE_ADJUSTMENTS){let ie=[];for(;;)try{let pe=this.extract(B,this.consumeTime);this.consumeSpaceForRecord(B);let Ze=!1;B.value[B.cur]==="-"&&(Ze=!0,B.cur+=1);let zt=this.extract(B,this.consumeTypedTime);ie.push({time:pe,typedTime:zt,back:Ze})}catch{break}if(ie.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,ie}return[]}parseRepeat(){let B=[];for(;;){let ie=this.getCurrentRecord();if(ie.type!==b.REPEAT)break;{let pe=this.extract(ie,this.consumeRepeatInterval),Ze=this.parseTypedTime(ie);B.push({repeatInterval:pe,typedTimes:Ze}),this.currentLine++}}return B}parseTypedTime(B){let ie=[];for(;;)try{this.consumeSpaceForRecord(B),ie.push(this.extract(B,this.consumeTypedTime))}catch{break}if(ie.length===0)throw new Error("Invalid typed time.");return ie}parseTime(){let B=this.getCurrentRecord(),ie=this.extract(B,this.consumeTime);this.consumeSpaceForRecord(B);let pe=this.extract(B,this.consumeTime);return this.currentLine++,{startTime:ie,stopTime:pe}}parseBandWidth(){let B=[];for(;this.currentLine<this.records.length;){let ie=this.getCurrentRecord();if(ie.type!==b.BANDWIDTH)break;{let pe=this.extractOneOrMore(ie,K);if(ie.value[ie.cur]!==":")throw new Error("Invalid bandwidth field.");ie.cur++;let Ze=this.extractOneOrMore(ie,k);B.push({bwtype:pe,bandwidth:Ze}),this.currentLine++}}return B}parseVersion(){let B=this.getCurrentRecord();if(B.type!==b.VERSION)throw new Error("first sdp record must be version");let ie=B.value.slice(0,this.consumeOneOrMore(B.value,0,k));if(ie.length!==B.value.length)throw new Error('invalid proto version, "v='.concat(B.value,'"'));return this.currentLine++,ie}parseOrigin(){let B=this.getCurrentRecord();if(B.type!==b.ORIGIN)throw new Error("second line of sdp must be origin");let ie=this.extractOneOrMore(B,J);this.consumeSpaceForRecord(B);let pe=this.extractOneOrMore(B,k);this.consumeSpaceForRecord(B);let Ze=this.extractOneOrMore(B,k);this.consumeSpaceForRecord(B);let zt=this.extractOneOrMore(B,K);this.consumeSpaceForRecord(B);let Ei=this.extractOneOrMore(B,K);this.consumeSpaceForRecord(B);let Mr=this.extract(B,this.consumeUnicastAddress);return this.currentLine++,{username:ie,sessId:pe,sessVersion:Ze,nettype:zt,addrtype:Ei,unicastAddress:Mr}}parseSessionName(){let B=this.getCurrentRecord();if(B.type===b.SESSION_NAME){let ie=this.extract(B,this.consumeText);return this.currentLine++,ie}}parseInformation(){let B=this.getCurrentRecord();if(B.type!==b.INFORMATION)return;let ie=this.extract(B,this.consumeText);return this.currentLine++,ie}parseUri(){let B=this.getCurrentRecord();if(B.type===b.URI)return this.currentLine++,B.value}parseEmail(){let B=[];for(;;){let ie=this.getCurrentRecord();if(ie.type!==b.EMAIL)break;B.push(ie.value),this.currentLine++}return B}parsePhone(){let B=[];for(;;){let ie=this.getCurrentRecord();if(ie.type!==b.PHONE)break;B.push(ie.value),this.currentLine++}return B}parseConnection(){let B=this.getCurrentRecord();if(B.type===b.CONNECTION){let ie=this.extractOneOrMore(B,K);this.consumeSpaceForRecord(B);let pe=this.extractOneOrMore(B,K);this.consumeSpaceForRecord(B);let Ze=this.extract(B,this.consumeAddress);return this.currentLine++,{nettype:ie,addrtype:pe,address:Ze}}}parseMedia(){let B=this.getCurrentRecord(),ie=this.extract(B,this.consumeToken);this.consumeSpaceForRecord(B);let pe=this.extract(B,this.consumePort);B.value[B.cur]==="/"&&(B.cur+=1,pe+=this.extract(B,this.consumeInteger)),this.consumeSpaceForRecord(B);let Ze=[];for(Ze.push(this.extract(B,this.consumeToken));B.value[B.cur]==="/";)B.cur+=1,Ze.push(this.extract(B,this.consumeToken));if(Ze.length===0)throw new Error("Invalid proto");let zt=this.parseFmt(B);return this.currentLine++,{mediaType:ie,port:pe,protos:Ze,fmts:zt}}parseTimeFields(){let B=[];for(;this.getCurrentRecord().type===b.TIME;){let ie=this.parseTime(),pe=this.parseRepeat(),Ze=this.parseZone();B.push({time:ie,repeats:pe,zones:Ze})}return B}parseMediaDescription(){let B=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===b.MEDIA;){let ie=this.parseMedia(),pe=this.parseInformation(),Ze=this.parseConnections(),zt=this.parseBandWidth(),Ei=this.parseKey(),Mr=this.parseMediaAttributes(ie);B.push({media:ie,information:pe,connections:Ze,bandwidths:zt,key:Ei,attributes:Mr})}return B}parseConnections(){let B=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===b.CONNECTION;)B.push(this.parseConnection());return B}parseFmt(B){let ie=[];for(;;)try{this.consumeSpaceForRecord(B),ie.push(this.extract(B,this.consumeToken))}catch{break}if(ie.length===0)throw new Error("Invalid fmts");return ie}extract(B,ie,...pe){let Ze=ie.call(this,B.value,B.cur,...pe),zt=B.value.slice(B.cur,Ze);return B.cur=Ze,zt}extractOneOrMore(B,ie){let pe=this.consumeOneOrMore(B.value,B.cur,ie),Ze=B.value.slice(B.cur,pe);return B.cur=pe,Ze}consumeSpaceForRecord(B){if(B.value[B.cur]!==I)throw new Error("Invalid space at ".concat(B.cur,"."));B.cur+=1}}class rn extends nt{constructor(...B){super(...B),Xe(this,"attributes",void 0),Xe(this,"digested",!1)}extractOneOrMore(B,ie,pe){let Ze=this.consumeOneOrMore(B.attValue,B._cur,ie),zt=B.attValue.slice(B._cur,Ze),[Ei,Mr]=pe||[];if(typeof Ei=="number"&&zt.length<Ei)throw new Error("error in length, should be more or equal than ".concat(Ei," characters."));if(typeof Mr=="number"&&zt.length>Mr)throw new Error("error in length, should be less or equal than ".concat(Mr," characters."));return B._cur=Ze,zt}consumeAttributeSpace(B){if(B.attValue[B._cur]!==I)throw new Error("Invalid space at ".concat(B._cur,"."));B._cur+=1}extract(B,ie,...pe){if(!B.attValue)throw new Error("Nothing to extract from attValue.");let Ze=ie.call(this,B.attValue,B._cur,...pe),zt=B.attValue.slice(B._cur,Ze);return B._cur=Ze,zt}atEnd(B){if(!B.attValue)throw new Error;return B._cur>=B.attValue.length}peekChar(B){if(!B.attValue)throw new Error;return B.attValue[B._cur]}peek(B,ie){if(!B.attValue)throw new Error;for(let pe=0;pe<ie.length;pe++)if(ie[pe]!==B.attValue[B._cur+pe])return!1;return!0}parseIceUfrag(B){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(B,Ue,[4,256])}parseIcePwd(B){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(B,Ue,[22,256])}parseIceOptions(B){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");let ie=[];for(;!this.atEnd(B);){ie.push(this.extractOneOrMore(B,Ue));try{this.consumeAttributeSpace(B)}catch(pe){if(this.atEnd(B))break;throw pe}}this.attributes.iceOptions=ie}parseFingerprint(B){let ie=this.extract(B,this.consumeToken);this.consumeAttributeSpace(B);let pe=this.extract(B,this.consumeTill);this.attributes.fingerprints.push({hashFunction:ie,fingerprint:pe})}parseExtmap(B){let ie=this.extractOneOrMore(B,k),pe;this.peekChar(B)==="/"&&(this.extract(B,this.consume,"/"),pe=this.extract(B,this.consumeToken)),this.consumeAttributeSpace(B);let Ze=this.extract(B,this.consumeTill,I),zt=Ne(Ne({entry:parseInt(ie,10)},pe&&{direction:pe}),{},{extensionName:Ze});this.peekChar(B)===I&&(this.consumeAttributeSpace(B),zt.extensionAttributes=this.extract(B,this.consumeTill)),this.attributes.extmaps.push(zt)}parseSetup(B){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");let ie=this.extract(B,this.consumeTill);if(ie!=="active"&&ie!=="passive"&&ie!=="actpass"&&ie!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=ie}}class ui extends rn{constructor(...B){super(...B),Xe(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(B){if(this.digested)throw new Error("already digested");try{switch(B.attField){case"group":this.parseGroup(B);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(B);break;case"ice-pwd":this.parseIcePwd(B);break;case"ice-options":this.parseIceOptions(B);break;case"fingerprint":this.parseFingerprint(B);break;case"setup":this.parseSetup(B);break;case"tls-id":this.parseTlsId(B);break;case"identity":this.parseIdentity(B);break;case"extmap":this.parseExtmap(B);break;case"msid-semantic":this.parseMsidSemantic(B);break;default:B.ignored=!0,this.attributes.unrecognized.push(B)}}catch(ie){throw console.error("parsing session attribute ".concat(B.attField,' error, "a=').concat(B.attField,":").concat(B.attValue,'"')),ie}if(!B.ignored&&B.attValue&&!this.atEnd(B))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(B){let ie=this.extract(B,this.consumeToken),pe=[];for(;!this.atEnd(B)&&this.peekChar(B)===I;)this.consumeAttributeSpace(B),pe.push(this.extract(B,this.consumeToken));this.attributes.groups.push({semantic:ie,identificationTag:pe})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(B){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(B,Re)}parseIdentity(B){let ie=this.extractOneOrMore(B,Ie),pe=[];for(;!this.atEnd(B)&&this.peekChar(B)===I;){this.consumeAttributeSpace(B);let Ze=this.extract(B,this.consumeToken);this.extract(B,this.consume,"=");let zt=this.extractOneOrMore(B,Ei=>Ei!==I&&he(Ei));pe.push({name:Ze,value:zt})}this.attributes.identities.push({assertionValue:ie,extensions:pe})}parseMsidSemantic(B){this.peekChar(B)===I&&this.consumeAttributeSpace(B);let ie={semantic:this.extract(B,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(B)}catch{break}if(this.peekChar(B)==="*"){this.extract(B,this.consume,"*"),ie.applyForAll=!0;break}{let pe=this.extract(B,this.consumeTill,I);ie.identifierList.push(pe)}}this.attributes.msidSemantic=ie}}class Ki extends rn{constructor(B){super(),Xe(this,"attributes",void 0),B.protos.indexOf("RTP")!==-1||B.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(B){if(this.digested)throw new Error("already digested");try{switch(B.attField){case"extmap":this.parseExtmap(B);break;case"setup":this.parseSetup(B);break;case"ice-ufrag":this.parseIceUfrag(B);break;case"ice-pwd":this.parseIcePwd(B);break;case"ice-options":this.parseIceOptions(B);break;case"candidate":this.parseCandidate(B);break;case"remote-candidate":this.parseRemoteCandidate(B);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(B);break;case"rtpmap":this.parseRtpmap(B);break;case"ptime":this.parsePtime(B);break;case"maxptime":this.parseMaxPtime(B);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(B);break;case"ssrc":this.parseSSRC(B);break;case"fmtp":this.parseFmtp(B);break;case"rtcp-fb":this.parseRtcpFb(B);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(B);break;case"mid":this.parseMid(B);break;case"msid":this.parseMsid(B);break;case"imageattr":this.parseImageAttr(B);break;case"rid":this.parseRid(B);break;case"simulcast":this.parseSimulcast(B);break;case"sctp-port":this.parseSctpPort(B);break;case"max-message-size":this.parseMaxMessageSize(B);break;case"ssrc-group":this.parseSSRCGroup(B);break;default:B.ignored=!0,this.attributes.unrecognized.push(B)}}catch(ie){throw console.error("parsing media attribute ".concat(B.attField,' error, "a=').concat(B.attField,":").concat(B.attValue,'"')),ie}if(!B.ignored&&B.attValue&&!this.atEnd(B))throw new Error("attribute parsing error")}parseCandidate(B){let ie=this.extractOneOrMore(B,Ue,[1,32]);this.consumeAttributeSpace(B);let pe=this.extractOneOrMore(B,k,[1,5]);this.consumeAttributeSpace(B);let Ze=this.extract(B,this.consumeToken);this.consumeAttributeSpace(B);let zt=this.extractOneOrMore(B,k,[1,10]);this.consumeAttributeSpace(B);let Ei=this.extract(B,this.consumeAddress);this.consumeAttributeSpace(B);let Mr=this.extract(B,this.consumePort);this.consumeAttributeSpace(B),this.extract(B,this.consume,"typ"),this.consumeAttributeSpace(B);let jo={foundation:ie,componentId:pe,transport:Ze,priority:zt,connectionAddress:Ei,port:Mr,type:this.extract(B,this.consumeToken),extension:{}};for(this.peek(B," raddr")&&(this.extract(B,this.consume," raddr"),this.consumeAttributeSpace(B),jo.relAddr=this.extract(B,this.consumeAddress)),this.peek(B," rport")&&(this.extract(B,this.consume," rport"),this.consumeAttributeSpace(B),jo.relPort=this.extract(B,this.consumePort));this.peekChar(B)===I;){this.consumeAttributeSpace(B);let Bd=this.extract(B,this.consumeToken);this.consumeAttributeSpace(B),jo.extension[Bd]=this.extractOneOrMore(B,U)}this.attributes.candidates.push(jo)}parseRemoteCandidate(B){let ie=[];for(;;){let pe=this.extractOneOrMore(B,k,[1,5]);this.consumeAttributeSpace(B);let Ze=this.extract(B,this.consumeAddress);this.consumeAttributeSpace(B);let zt=this.extract(B,this.consumePort);ie.push({componentId:pe,connectionAddress:Ze,port:zt});try{this.consumeAttributeSpace(B)}catch{break}}this.attributes.remoteCandidatesList.push(ie)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(B){let ie=this.extract(B,this.consumeToken);this.consumeAttributeSpace(B);let pe=this.extract(B,this.consumeTill,"/");this.extract(B,this.consume,"/");let Ze={encodingName:pe,clockRate:this.extractOneOrMore(B,k)};this.atEnd(B)||this.peekChar(B)!=="/"||(this.extract(B,this.consume,"/"),Ze.encodingParameters=parseInt(this.extract(B,this.consumeTill),10));let zt=this.attributes.payloads.find(Ei=>Ei.payloadType===parseInt(ie,10));zt?zt.rtpMap=Ze:this.attributes.payloads.push({payloadType:parseInt(ie,10),rtpMap:Ze,rtcpFeedbacks:[]})}parsePtime(B){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(B,this.consumeTill)}parseMaxPtime(B){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(B,this.consumeTill)}parseDirection(B){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=B.attField}parseSSRC(B){let ie=this.extractOneOrMore(B,k);this.consumeAttributeSpace(B);let pe=this.extract(B,this.consumeTill,":"),Ze;this.peekChar(B)===":"&&(this.extract(B,this.consume,":"),Ze=this.extract(B,this.consumeTill));let zt=this.attributes.ssrcs.find(Ei=>Ei.ssrcId===parseInt(ie,10));zt?zt.attributes[pe]=Ze:this.attributes.ssrcs.push({ssrcId:parseInt(ie,10),attributes:{[pe]:Ze}})}parseFmtp(B){let ie=this.extract(B,this.consumeTill,I);this.consumeAttributeSpace(B);let pe=this.extract(B,this.consumeTill),Ze={};pe.split(";").forEach(Ei=>{let[Mr,jo]=Ei.split("=");Mr=Mr.trim();let Bd=typeof jo=="string"?jo.trim():null;typeof Mr=="string"&&Mr.length>0&&(Ze[Mr]=Bd)});let zt=this.attributes.payloads.find(Ei=>Ei.payloadType===parseInt(ie,10));zt?zt.fmtp={parameters:Ze}:this.attributes.payloads.push({payloadType:parseInt(ie,10),rtcpFeedbacks:[],fmtp:{parameters:Ze}})}parseFmtParameters(B){let ie={},pe=this.extract(B,this.consumeTill,"=");B._cur++;let Ze=this.extract(B,this.consumeTill,";");for(ie[pe]=Ze;B.attValue[B._cur]===";";){let zt=this.extract(B,this.consumeTill,"=");B._cur++;let Ei=this.extract(B,this.consumeTill,";");ie[zt]=Ei}return ie}parseRtcpFb(B){let ie="";ie=this.peekChar(B)==="*"?this.extract(B,this.consume,"*"):this.extract(B,this.consumeTill,I),this.consumeAttributeSpace(B);let pe=this.extract(B,this.consumeTill,I),Ze;if(pe==="trr-int")Ze={type:pe,interval:this.extract(B,this.consumeTill)};else{let zt={type:pe};this.peekChar(B)===I&&(this.consumeAttributeSpace(B),zt.parameter=this.extract(B,this.consumeToken),this.peekChar(B)===I&&(zt.additional=this.extract(B,this.consumeTill))),Ze=zt}if(ie==="*")this.attributes.rtcpFeedbackWildcards.push(Ze);else{let zt=this.attributes.payloads.find(Ei=>Ei.payloadType===parseInt(ie,10));zt?zt.rtcpFeedbacks.push(Ze):this.attributes.payloads.push({payloadType:parseInt(ie,10),rtcpFeedbacks:[Ze]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(B){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");let ie={port:this.extract(B,this.consumePort)};this.peekChar(B)===I&&(this.consumeAttributeSpace(B),ie.netType=this.extractOneOrMore(B,K),this.consumeAttributeSpace(B),ie.addressType=this.extractOneOrMore(B,K),this.consumeAttributeSpace(B),ie.address=this.extract(B,this.consumeAddress)),this.attributes.rtcp=ie}parseMsid(B){let ie={id:this.extractOneOrMore(B,K,[1,64])};this.peekChar(B)===I&&(this.consumeAttributeSpace(B),ie.appdata=this.extractOneOrMore(B,K,[1,64])),this.attributes.msids.push(ie)}parseImageAttr(B){this.attributes.imageattr.push(B.attValue)}parseRid(B){let ie=this.extractOneOrMore(B,Ze=>te(Ze)||k(Ze)||Ze==="_"||Ze==="-");this.consumeAttributeSpace(B);let pe={id:ie,direction:this.extract(B,this.consumeToken),params:[]};if(this.peekChar(B)===I){if(this.consumeAttributeSpace(B),this.peek(B,"pt=")){this.extract(B,this.consume,"pt=");let Ze=[];for(;;){let zt=this.extract(B,this.consumeToken);Ze.push(zt);try{this.extract(B,this.consume,",")}catch{break}}pe.payloads=Ze,this.peekChar(B)===I&&this.extract(B,this.consume,I)}for(;;){let Ze=this.extract(B,this.consumeToken);switch(Ze){case"depend":{let zt={type:Ze,rids:this.extract(B,this.consume,"=").split(",")};pe.params.push(zt);break}default:{let zt={type:Ze};this.peekChar(B)==="="&&(this.extract(B,this.consume,"="),zt.val=this.extract(B,this.consumeTill,";")),pe.params.push(zt)}}try{this.extract(B,this.consume,";")}catch{break}}}this.attributes.rids.push(pe)}parseSimulcast(B){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=B.attValue,this.extract(B,this.consumeTill)}parseSctpPort(B){this.attributes.sctpPort=this.extractOneOrMore(B,k,[1,5])}parseMaxMessageSize(B){this.attributes.maxMessageSize=this.extractOneOrMore(B,k,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(B){this.attributes.mid=this.extract(B,this.consumeToken)}parseSSRCGroup(B){let ie=this.extract(B,this.consumeToken),pe=[];for(;;)try{this.consumeAttributeSpace(B);let Ze=this.extract(B,this.consumeInteger);pe.push(parseInt(Ze,10))}catch{break}this.attributes.ssrcGroups.push({semantic:ie,ssrcIds:pe})}}function _i(ot,B,ie){return B in ot?Object.defineProperty(ot,B,{value:ie,enumerable:!0,configurable:!0,writable:!0}):ot[B]=ie,ot}class Ia{constructor(){_i(this,"eol",y)}print(B,ie){let pe="";return ie&&(this.eol=ie),pe+=this.printVersion(B.version),pe+=this.printOrigin(B.origin),pe+=this.printSessionName(B.sessionName),pe+=this.printInformation(B.information),pe+=this.printUri(B.uri),pe+=this.printEmail(B.emails),pe+=this.printPhone(B.phones),pe+=this.printConnection(B.connection),pe+=this.printBandwidth(B.bandwidths),pe+=this.printTimeFields(B.timeFields),pe+=this.printKey(B.key),pe+=this.printSessionAttributes(B.attributes),pe+=this.printMediaDescription(B.mediaDescriptions),pe}printVersion(B){return"v=".concat(B).concat(this.eol)}printOrigin(B){return"o=".concat(B.username," ").concat(B.sessId," ").concat(B.sessVersion," ").concat(B.nettype," ").concat(B.addrtype," ").concat(B.unicastAddress).concat(this.eol)}printSessionName(B){return B?"s=".concat(B).concat(this.eol):""}printInformation(B){return B?"i=".concat(B).concat(this.eol):""}printUri(B){return B?"u=".concat(B).concat(this.eol):""}printEmail(B){let ie="";for(let pe of B)ie+="e=".concat(pe).concat(this.eol);return ie}printPhone(B){let ie="";for(let pe of B)ie+="e=".concat(pe).concat(this.eol);return ie}printConnection(B){return B?"c=".concat(B.nettype," ").concat(B.addrtype," ").concat(B.address).concat(this.eol):""}printBandwidth(B){let ie="";for(let pe of B)ie+="b=".concat(pe.bwtype,":").concat(pe.bandwidth).concat(this.eol);return ie}printTimeFields(B){let ie="";for(let pe of B){ie+="t=".concat(pe.time.startTime," ").concat(pe.time.startTime).concat(this.eol);for(let Ze of pe.repeats)ie+="r=".concat(Ze.repeatInterval," ").concat(Ze.typedTimes.join(" ")).concat(this.eol);pe.zoneAdjustments&&(ie+="z=",ie+="z=".concat(pe.zoneAdjustments.map(Ze=>"".concat(Ze.time," ").concat(Ze.back?"-":""," ").concat(Ze.typedTime)).join(" ")).concat(this.eol),ie+=this.eol)}return ie}printKey(B){return B?"k=".concat(B).concat(this.eol):""}printAttributes(B){let ie="";for(let pe of B)ie+="a=".concat(pe.attField).concat(pe.attValue?":".concat(pe.attValue):"").concat(this.eol);return ie}printMediaDescription(B){let ie="";for(let pe of B)ie+=this.printMedia(pe.media),ie+=this.printInformation(pe.information),ie+=this.printConnections(pe.connections),ie+=this.printBandwidth(pe.bandwidths),ie+=this.printKey(pe.key),ie+=this.printMediaAttributes(pe);return ie}printConnections(B){let ie="";for(let pe of B)ie+=this.printConnection(pe);return ie}printMedia(B){return"m=".concat(B.mediaType," ").concat(B.port," ").concat(B.protos.join("/")," ").concat(B.fmts.join(" ")).concat(this.eol)}printSessionAttributes(B){return new rt(this.eol).print(B)}printMediaAttributes(B){return new mt(this.eol).print(B)}}class He{constructor(B){_i(this,"eol",void 0),this.eol=B}printIceUfrag(B){return B===void 0?"":"a=ice-ufrag:".concat(B).concat(this.eol)}printIcePwd(B){return B===void 0?"":"a=ice-pwd:".concat(B).concat(this.eol)}printIceOptions(B){return B===void 0?"":"a=ice-options:".concat(B.join(I)).concat(this.eol)}printFingerprints(B){return B.length>0?B.map(ie=>"a=fingerprint:".concat(ie.hashFunction).concat(I).concat(ie.fingerprint)).join(this.eol)+this.eol:""}printExtmap(B){return B.map(ie=>"a=extmap:".concat(ie.entry).concat(ie.direction?"/".concat(ie.direction):"").concat(I).concat(ie.extensionName).concat(ie.extensionAttributes?"".concat(I).concat(ie.extensionAttributes):"").concat(this.eol)).join("")}printSetup(B){return B===void 0?"":"a=setup:".concat(B).concat(this.eol)}printUnrecognized(B){return B.map(ie=>"a=".concat(ie.attField).concat(ie.attValue?":".concat(ie.attValue):"").concat(this.eol)).join("")}}class rt extends He{print(B){let ie="";return ie+=this.printGroups(B.groups),ie+=this.printMsidSemantic(B.msidSemantic),ie+=this.printIceLite(B.iceLite),ie+=this.printIceUfrag(B.iceUfrag),ie+=this.printIcePwd(B.icePwd),ie+=this.printIceOptions(B.iceOptions),ie+=this.printFingerprints(B.fingerprints),ie+=this.printSetup(B.setup),ie+=this.printTlsId(B.tlsId),ie+=this.printIdentity(B.identities),ie+=this.printExtmap(B.extmaps),ie+=this.printUnrecognized(B.unrecognized),ie}printGroups(B){let ie="";return B.length>0&&(ie+=B.map(pe=>"a=group:".concat(pe.semantic).concat(pe.identificationTag.map(Ze=>"".concat(I).concat(Ze)).join("")).concat(this.eol)).join("")),ie}printIceLite(B){return B===void 0?"":"a=ice-lite"+this.eol}printTlsId(B){return B?"a=tls-id:".concat(B).concat(this.eol):""}printIdentity(B){return B.length===0?"":B.map(ie=>"a=identity:".concat(ie.assertionValue).concat(ie.extensions.map(pe=>"".concat(I).concat(pe.name).concat(pe.value?"=".concat(pe.value):"")))).join(this.eol)+this.eol}printMsidSemantic(B){if(!B)return"";let ie="a=msid-semantic:".concat(B.semantic);return B.applyForAll?ie+="".concat(I,"*"):B.identifierList.length>0&&(ie+=B.identifierList.map(pe=>"".concat(I).concat(pe))),ie+this.eol}}class mt extends He{print(B){let ie=B.attributes,pe="";return pe+=this.printRTCP(ie.rtcp),pe+=this.printIceUfrag(ie.iceUfrag),pe+=this.printIcePwd(ie.icePwd),pe+=this.printIceOptions(ie.iceOptions),pe+=this.printCandidates(ie.candidates),pe+=this.printRemoteCandidatesList(ie.remoteCandidatesList),pe+=this.printEndOfCandidates(ie.endOfCandidates),pe+=this.printFingerprints(ie.fingerprints),pe+=this.printSetup(ie.setup),pe+=this.printMid(ie.mid),pe+=this.printExtmap(ie.extmaps),pe+=this.printRTPRelated(ie),pe+=this.printPtime(ie.ptime),pe+=this.printMaxPtime(ie.maxPtime),pe+=this.printDirection(ie.direction),pe+=this.printSSRCGroups(ie.ssrcGroups),pe+=this.printSSRC(ie.ssrcs),pe+=this.printRTCPMux(ie.rtcpMux),pe+=this.printRTCPMuxOnly(ie.rtcpMuxOnly),pe+=this.printRTCPRsize(ie.rtcpRsize),pe+=this.printMSId(ie.msids),pe+=this.printImageattr(ie.imageattr),pe+=this.printRid(ie.rids),pe+=this.printSimulcast(ie.simulcast),pe+=this.printSCTPPort(ie.sctpPort),pe+=this.printMaxMessageSize(ie.maxMessageSize),pe+=this.printUnrecognized(ie.unrecognized),pe}printCandidates(B){return B.map(ie=>"a=candidate:".concat(ie.foundation).concat(I).concat(ie.componentId).concat(I).concat(ie.transport).concat(I).concat(ie.priority).concat(I).concat(ie.connectionAddress).concat(I).concat(ie.port).concat(I,"typ").concat(I).concat(ie.type).concat(ie.relAddr?"".concat(I,"raddr").concat(I).concat(ie.relAddr):"").concat(ie.relPort?"".concat(I,"rport").concat(I).concat(ie.relPort):"").concat(Object.keys(ie.extension).map(pe=>"".concat(I).concat(pe).concat(I).concat(ie.extension[pe])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(B){return B.map(ie=>"a=remote-candidates:".concat(ie.join(I)).concat(this.eol)).join("")}printEndOfCandidates(B){return B===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(B){if(!B.payloads)return"";let ie=B.payloads,pe="";pe+=B.rtcpFeedbackWildcards.map(Ze=>this.printRTCPFeedback("*",Ze)).join("");for(let Ze of ie)pe+=this.printRtpMap(Ze.payloadType,Ze.rtpMap),pe+=this.printFmtp(Ze.payloadType,Ze.fmtp),pe+=Ze.rtcpFeedbacks.map(zt=>this.printRTCPFeedback(Ze.payloadType,zt)).join("");return pe}printFmtp(B,ie){if(!ie)return"";let pe=Object.keys(ie.parameters);return pe.length===1&&ie.parameters[pe[0]]===null?"a=fmtp:".concat(B).concat(I).concat(pe[0]).concat(this.eol):"a=fmtp:".concat(B).concat(I).concat(Object.keys(ie.parameters).map(Ze=>"".concat(Ze,"=").concat(ie.parameters[Ze])).join(";")).concat(this.eol)}printRtpMap(B,ie){return ie?"a=rtpmap:".concat(B).concat(I).concat(ie.encodingName,"/").concat(ie.clockRate).concat(ie.encodingParameters?"/".concat(ie.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(B,ie){let pe="a=rtcp-fb:".concat(B).concat(I),Ze=ie;return Ze.type==="trr-int"?pe+="ttr-int".concat(I).concat(Ze.interval):(pe+="".concat(Ze.type),Ze.parameter&&(pe+="".concat(I).concat(Ze.parameter),Ze.additional&&(pe+="".concat(I).concat(Ze.additional)))),pe+this.eol}printPtime(B){return B===void 0?"":"a=ptime:".concat(B).concat(this.eol)}printMaxPtime(B){return B===void 0?"":"a=maxptime:".concat(B).concat(this.eol)}printDirection(B){return B===void 0?"":"a=".concat(B).concat(this.eol)}printSSRC(B){return B.map(ie=>Object.keys(ie.attributes).map(pe=>"a=ssrc:".concat(ie.ssrcId.toString(10)).concat(I).concat(pe).concat(ie.attributes[pe]?":".concat(ie.attributes[pe]):"").concat(this.eol)).join("")).join("")}printRTCPMux(B){return B===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(B){return B===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(B){return B===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(B){if(B===void 0)return"";let ie="a=rtcp:".concat(B.port);return B.netType&&(ie+="".concat(I).concat(B.netType)),B.addressType&&(ie+="".concat(I).concat(B.addressType)),B.address&&(ie+="".concat(I).concat(B.address)),ie+this.eol}printMSId(B){return B.map(ie=>"a=msid:".concat(ie.id).concat(ie.appdata?"".concat(I).concat(ie.appdata):"").concat(this.eol)).join("")}printImageattr(B){return B.map(ie=>"a=imageattr:".concat(ie).concat(this.eol)).join("")}printRid(B){return B.map(ie=>{let pe="a=rid:".concat(ie.id).concat(I).concat(ie.direction);return ie.payloads&&(pe+="".concat(I,"pt=").concat(ie.payloads.join(","))),ie.params.length>0&&(pe+="".concat(I).concat(ie.params.map(Ze=>Ze.type==="depend"?"depend=".concat(Ze.rids.join(",")):"".concat(Ze.type,"=").concat(Ze.val)).join(";"))),pe+this.eol}).join("")}printSimulcast(B){return B===void 0?"":"a=simulcast:".concat(B).concat(this.eol)}printSCTPPort(B){return B===void 0?"":"a=sctp-port:".concat(B).concat(this.eol)}printMaxMessageSize(B){return B===void 0?"":"a=max-message-size:".concat(B).concat(this.eol)}printMid(B){return B===void 0?"":"a=mid:".concat(B).concat(this.eol)}printSSRCGroups(B){return B.map(ie=>"a=ssrc-group:".concat(ie.semantic).concat(ie.ssrcIds.map(pe=>"".concat(I).concat(pe.toString(10))).join("")).concat(this.eol)).join("")}}function Wt(ot){return new Vt().parse(ot)}function _n(ot,B){return new Ia().print(ot,B)}}},a={};function l(p){if(a[p])return a[p].exports;var f=a[p]={exports:{}};return i[p](f,f.exports,l),f.exports}return l.d=(p,f)=>{for(var g in f)l.o(f,g)&&!l.o(p,g)&&Object.defineProperty(p,g,{enumerable:!0,get:f[g]})},l.o=(p,f)=>Object.prototype.hasOwnProperty.call(p,f),l.r=p=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(p,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(p,"__esModule",{value:!0})},l(8)})()})(HC);var Ci=HC.exports;function Ra(s){if(Array.isArray(s))return s.map(i=>i);if(!Uf(s))return s;let t={};for(let i in s){let a=s[i];Uf(a)||Array.isArray(a)?t[i]=Ra(a):t[i]=a}return t}function Uf(s){return!(typeof s!="object"||Array.isArray(s)||!s)}class Zg{constructor(t){P(this,"input",[]),P(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}let Md={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},$g={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Md,remoteCandidate:Md}},lk={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},Hb={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},uk={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},hk={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function Kb(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Nh(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Kb(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Kb(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class eS{constructor(t,i){P(this,"onFirstVideoReceived",void 0),P(this,"onFirstVideoDecoded",void 0),P(this,"onFirstAudioReceived",void 0),P(this,"onFirstVideoDecodedTimeout",void 0),P(this,"onFirstAudioDecoded",void 0),P(this,"onSelectedLocalCandidateChanged",void 0),P(this,"onSelectedRemoteCandidateChanged",void 0),P(this,"videoIsReady",!1),P(this,"videoIsReady2",{}),P(this,"pc",void 0),P(this,"options",void 0),P(this,"intervalTimer",void 0),P(this,"stats",Ra($g)),P(this,"isFirstVideoReceived",{}),P(this,"isFirstVideoDecoded",{}),P(this,"isFirstAudioReceived",{}),P(this,"isFirstAudioDecoded",{}),P(this,"isFirstVideoDecodedTimeout",{}),P(this,"lossRateWindowStats",[]),this.pc=t,this.options=i,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Pe(t=>{t({local:Nh({},Md),remote:Nh({},Md)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,i){this.videoIsReady2[t]=i}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let i=this.lossRateWindowStats.length,a=["videoSend","audioSend","videoRecv","audioRecv"],l=0,p=0,f=0,g=0;for(let v of a)t[v].forEach((y,I)=>{if(!this.lossRateWindowStats[i-1][v][I]||!this.lossRateWindowStats[0][v][I])return;let b=this.lossRateWindowStats[i-1][v][I].packets-this.lossRateWindowStats[0][v][I].packets,k=this.lossRateWindowStats[i-1][v][I].packetsLost-this.lossRateWindowStats[0][v][I].packetsLost;v==="videoSend"||v==="audioSend"?(l+=b,f+=k):(p+=b,g+=k),Number.isNaN(b)||Number.isNaN(b)?y.packetLostRate=0:y.packetLostRate=b<=0||k<=0?0:k/(b+k)});t.sendPacketLossRate=l<=0||f<=0?0:f/(l+f),t.recvPacketLossRate=p<=0||g<=0?0:g/(p+g)}}function pk(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function mk(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?pk(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):pk(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class fk extends eS{constructor(){super(...arguments),P(this,"_stats",$g),P(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){let t=await this._getStats(),i=this.statsResponsesToObjects(t);this._stats=Ra($g);let a=i.filter(p=>p.type==="ssrc");this.processSSRCStats(a);let l=i.find(p=>p.type==="VideoBwe");l&&this.processBandwidthStats(l),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(i=>{var a;let l=xe(a=i.id).call(a,"send");switch("".concat(i.mediaType,"_").concat(l?"send":"recv")){case"video_send":{let p=Ra(Hb);p.codec=i.googCodecName,p.adaptionChangeReason="none",i.googCpuLimitedResolution&&(p.adaptionChangeReason="cpu"),i.googBandwidthLimitedResolution&&(p.adaptionChangeReason="bandwidth"),p.avgEncodeMs=Number(i.googAvgEncodeMs),p.inputFrame={width:Number(i.googFrameWidthInput)||Number(i.googFrameWidthSent),height:Number(i.googFrameHeightInput)||Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},p.sentFrame={width:Number(i.googFrameWidthSent),height:Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},p.firsCount=Number(i.googFirReceived),p.nacksCount=Number(i.googNacksReceived),p.plisCount=Number(i.googPlisReceived),p.frameCount=Number(i.framesEncoded),p.bytes=Number(i.bytesSent),p.packets=Number(i.packetsSent),p.packetsLost=Number(i.packetsLost),p.ssrc=Number(i.ssrc),p.rttMs=Number(i.googRtt||0),this._stats.videoSend.push(p),this._stats.rtt=p.rttMs;break}case"video_recv":{let p=Ra(lk),f=this.lastDecodeVideoReceiverStats.get(Number(i.ssrc));if(p.codec=i.googCodecName,p.targetDelayMs=Number(i.googTargetDelayMs),p.renderDelayMs=Number(i.googRenderDelayMs),p.currentDelayMs=Number(i.googCurrentDelayMs),p.minPlayoutDelayMs=Number(i.googMinPlayoutDelayMs),p.decodeMs=Number(i.googDecodeMs),p.maxDecodeMs=Number(i.googMaxDecodeMs),p.receivedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateReceived)},p.decodedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateDecoded)},p.decodeFrameRate=Number(i.googFrameRateDecoded),p.outputFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateOutput)},p.jitterBufferMs=Number(i.googJitterBufferMs),p.firsCount=Number(i.googFirsSent),p.nacksCount=Number(i.googNacksSent),p.plisCount=Number(i.googPlisSent),p.framesDecodeCount=Number(i.framesDecoded),p.bytes=Number(i.bytesReceived),p.packets=Number(i.packetsReceived),p.packetsLost=Number(i.packetsLost),p.ssrc=Number(i.ssrc),p.packets>0&&!this.isFirstVideoReceived[p.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(p.ssrc),this.isFirstVideoReceived[p.ssrc]=!0),p.framesDecodeCount>0&&!this.isFirstVideoDecoded[p.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(p.ssrc,p.decodedFrame.width,p.decodedFrame.height),this.isFirstVideoDecoded[p.ssrc]=!0),f){let g=f.stats,v=Date.now()-f.lts;p.framesDecodeFreezeTime=g.framesDecodeFreezeTime,p.framesDecodeInterval=g.framesDecodeInterval,p.framesDecodeCount>g.framesDecodeCount&&this.isFirstVideoDecoded[p.ssrc]?(f.lts=Date.now(),p.framesDecodeInterval=v,p.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(i.ssrc,10))?p.framesDecodeFreezeTime+=p.framesDecodeInterval:this.setVideoIsReady2(parseInt(i.ssrc,10),!0))):p.framesDecodeCount<f.stats.framesDecodeCount&&(p.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(p.ssrc,{stats:mk({},p),lts:Date.now()}),this._stats.videoRecv.push(p);break}case"audio_recv":{let p=Ra(hk);p.codec=i.googCodecName,p.outputLevel=Math.abs(Number(i.audioOutputLevel))/32767,p.decodingCNG=Number(i.googDecodingCNG),p.decodingCTN=Number(i.googDecodingCTN),p.decodingCTSG=Number(i.googDecodingCTSG),p.decodingNormal=Number(i.googDecodingNormal),p.decodingPLC=Number(i.googDecodingPLC),p.decodingPLCCNG=Number(i.googDecodingPLCCNG),p.expandRate=Number(i.googExpandRate),p.accelerateRate=Number(i.googAccelerateRate),p.preemptiveExpandRate=Number(i.googPreemptiveExpandRate),p.secondaryDecodedRate=Number(i.googSecondaryDecodedRate),p.speechExpandRate=Number(i.googSpeechExpandRate),p.preferredJitterBufferMs=Number(i.googPreferredJitterBufferMs),p.jitterBufferMs=Number(i.googJitterBufferMs),p.jitterMs=Number(i.googJitterReceived),p.bytes=Number(i.bytesReceived),p.packets=Number(i.packetsReceived),p.packetsLost=Number(i.packetsLost),p.ssrc=Number(i.ssrc),p.receivedFrames=Number(i.googDecodingCTN)||Number(i.packetsReceived),p.droppedFrames=Number(i.googDecodingPLC)+Number(i.googDecodingPLCCNG)||Number(i.packetsLost),p.receivedFrames>0&&!this.isFirstAudioReceived[p.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(p.ssrc),this.isFirstAudioReceived[p.ssrc]=!0),p.decodingNormal>0&&!this.isFirstAudioDecoded[p.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(p.ssrc),this.isFirstAudioDecoded[p.ssrc]=!0),this._stats.audioRecv.push(p);break}case"audio_send":{let p=Ra(uk);p.codec=i.googCodecName,p.inputLevel=Math.abs(Number(i.audioInputLevel))/32767,p.aecReturnLoss=Number(i.googEchoCancellationReturnLoss||0),p.aecReturnLossEnhancement=Number(i.googEchoCancellationReturnLossEnhancement||0),p.residualEchoLikelihood=Number(i.googResidualEchoLikelihood||0),p.residualEchoLikelihoodRecentMax=Number(i.googResidualEchoLikelihoodRecentMax||0),p.bytes=Number(i.bytesSent),p.packets=Number(i.packetsSent),p.packetsLost=Number(i.packetsLost),p.ssrc=Number(i.ssrc),p.rttMs=Number(i.googRtt||0),this._stats.rtt=p.rttMs,this._stats.audioSend.push(p);break}}})}_getStats(){return new Pe((t,i)=>{this.pc.getStats(t,i)})}statsResponsesToObjects(t){let i=[];return t.result().forEach(a=>{let l={id:a.id,timestamp:a.timestamp.valueOf().toString(),type:a.type};a.names().forEach(p=>{l[p]=a.stat(p)}),i.push(l)}),i}}function _k(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function um(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?_k(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):_k(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class Yb extends eS{constructor(){super(...arguments),P(this,"_stats",$g),P(this,"report",void 0),P(this,"lastDecodeVideoReceiverStats",new Map),P(this,"lastVideoFramesRecv",new Map),P(this,"lastVideoFramesSent",new Map),P(this,"lastVideoFramesDecode",new Map),P(this,"lastVideoJBDelay",new Map),P(this,"lastAudioJBDelay",new Map),P(this,"mediaBytesSent",new Map),P(this,"mediaBytesRetransmit",new Map),P(this,"mediaBytesTargetEncode",new Map),P(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=Ra($g),this.report.forEach(t=>{switch(t.type){case Ct.OUTBOUND:case Ct.INBOUND:{let i=t.mediaType||t.kind,a=!i&&"frameWidth"in t,l=!i&&!("frameWidth"in t);t.type===Ct.OUTBOUND?i==="audio"||l?this.processAudioOutboundStats(t):(i==="video"||a)&&this.processVideoOutboundStats(t):t.type===Ct.INBOUND&&(i==="audio"||l?this.processAudioInboundStats(t):(i==="video"||a)&&this.processVideoInboundStats(t));break}case Ct.TRANSPORT:{let i=this.report.get(t.selectedCandidatePairId);i&&this.processCandidatePairStats(i);break}case Ct.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){let t=await this.pc.getStats(),i={local:um({},Md),remote:um({},Md)};return t.forEach(a=>{let l;if(a.type===Ct.TRANSPORT&&(l=t.get(a.selectedCandidatePairId)),a.type===Ct.CANDIDATE_PAIR&&a.selected&&(l=a),l){let p=(f,g)=>{f.type=g.type,f.id=g.id,g.address&&(f.address=g.address),g.candidateType&&(f.candidateType=g.candidateType),g.port&&(f.port=g.port),g.priority&&(f.priority=g.priority),g.protocol&&(f.protocol=g.protocol),g.relayProtocol&&(f.relayProtocol=g.relayProtocol)};if(l.localCandidateId){let f=t.get(l.localCandidateId);f&&p(i.local,f)}if(l.remoteCandidateId){let f=t.get(l.remoteCandidateId);f&&p(i.remote,f)}}}),i}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(i=>{t.currentRoundTripTime&&(i.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(i=>{t.currentRoundTripTime&&(i.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){let i=this.report.get(t.localCandidateId);i&&this.processCandidateStats(i)}if(t.remoteCandidateId){let i=this.report.get(t.remoteCandidateId);i&&this.processCandidateStats(i)}}processCandidateStats(t){let i;t.type===Ct.LOCAL_CANDIDATE&&(i=this._stats.selectedCandidatePair.localCandidate),t.type===Ct.REMOTE_CANDIDATE&&(i=this._stats.selectedCandidatePair.remoteCandidate),i&&(i.type=t.type,i.id=t.id,t.address&&(i.address=t.address),t.candidateType&&(i.candidateType=t.candidateType),t.port&&(i.port=t.port),t.priority&&(i.priority=t.priority),t.protocol&&(i.protocol=t.protocol),t.relayProtocol&&(i.relayProtocol=t.relayProtocol),t.type===Ct.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==i.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(um({},i),um({},this.stats.selectedCandidatePair.localCandidate)),t.type===Ct.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==i.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(um({},i),um({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let i=this._stats.audioRecv.find(a=>a.ssrc===t.ssrc);i||(i=Ra(hk),this._stats.audioRecv.push(i)),i.ssrc=t.ssrc,i.packets=t.packetsReceived,i.packetsLost=t.packetsLost,i.bytes=t.bytesReceived,i.jitterMs=1e3*t.jitter,this.processAudioTrackReceiverStats(t,t.trackId,i),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),i.receivedFrames||(i.receivedFrames=t.packetsReceived),i.droppedFrames||(i.droppedFrames=t.packetsLost),i.receivedFrames>0&&!this.isFirstAudioReceived[i.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(i.ssrc),this.isFirstAudioReceived[i.ssrc]=!0),i.outputLevel&&i.outputLevel>0&&!this.isFirstAudioDecoded[i.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(i.ssrc),this.isFirstAudioDecoded[i.ssrc]=!0),typeof t.concealedSamples=="number"&&(i.concealedSamples=t.concealedSamples)}processVideoInboundStats(t){let i=this._stats.videoRecv.find(f=>f.ssrc===t.ssrc);i||(i=Ra(lk),this._stats.videoRecv.push(i)),i.ssrc=t.ssrc,i.packets=t.packetsReceived,i.packetsLost=t.packetsLost,i.bytes=t.bytesReceived,i.firsCount=t.firCount,i.nacksCount=t.nackCount,i.plisCount=t.pliCount,i.framesDecodeCount=t.framesDecoded,i.totalInterFrameDelay=t.totalInterFrameDelay,i.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay;let a=this.lastDecodeVideoReceiverStats.get(i.ssrc),l=this.lastVideoFramesDecode.get(i.ssrc),p=Date.now();if(i.framesDecodeCount>0&&!this.isFirstVideoDecoded[i.ssrc]){let f=i.decodedFrame?i.decodedFrame.width:0,g=i.decodedFrame?i.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(i.ssrc,f,g),this.isFirstVideoDecoded[i.ssrc]=!0}if(a){let f=a.stats,g=p-a.lts;i.framesDecodeFreezeTime=f.framesDecodeFreezeTime,i.framesDecodeInterval=f.framesDecodeInterval,!this.isFirstVideoDecoded[i.ssrc]&&g>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[i.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(i.ssrc),this.isFirstVideoDecodedTimeout[i.ssrc]=!0),i.framesDecodeCount>f.framesDecodeCount&&this.isFirstVideoDecoded[i.ssrc]?(a.lts=Date.now(),i.framesDecodeInterval=g,i.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?i.framesDecodeFreezeTime+=i.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):i.framesDecodeCount<f.framesDecodeCount&&(i.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(a.stats.framesDecodeCount>t.framesDecoded?i.qpSumPerFrame=t.qpSum/t.framesDecoded:i.qpSumPerFrame=(t.qpSum-a.qpSum)/(t.framesDecoded-a.stats.framesDecodeCount))}l&&p-l.lts>=800?(i.decodeFrameRate=Math.round((i.framesDecodeCount-l.count)/((p-l.lts)/1e3)),this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:p,rate:i.decodeFrameRate})):l?i.decodeFrameRate=l.rate:this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:p,rate:0}),t.totalDecodeTime&&(i.decodeMs=1e3*t.totalDecodeTime),this.processVideoTrackReceiverStats(t,t.trackId,i),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(i.framesRateFirefox=t.framerateMean),i.packets>0&&!this.isFirstVideoReceived[i.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(i.ssrc),this.isFirstVideoReceived[i.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(i.ssrc,{stats:um({},i),lts:a?a.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let i=this._stats.videoSend.find(l=>l.ssrc===t.ssrc);i||(i=Ra(Hb),this._stats.videoSend.push(i));let a=this.mediaBytesSent.get(t.ssrc);if(a)a.add(t.bytesSent);else{let l=new Zg(10);l.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,l)}if(t.retransmittedBytesSent!==void 0){let l=this.mediaBytesRetransmit.get(t.ssrc);if(l)l.add(t.retransmittedBytesSent);else{let p=new Zg(10);p.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,p)}}if(t.totalEncodedBytesTarget){let l=this.mediaBytesTargetEncode.get(t.ssrc);if(l)l.add(t.totalEncodedBytesTarget);else{let p=new Zg(10);p.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,p)}}if(i.ssrc=t.ssrc,i.bytes=t.bytesSent,i.packets=t.packetsSent,i.firsCount=t.firCount,i.nacksCount=t.nackCount,i.plisCount=t.pliCount,i.frameCount=t.framesEncoded,i.adaptionChangeReason=t.qualityLimitationReason,i.scalabilityMode=t.scalabilityMode,t.totalEncodeTime&&t.framesEncoded){let l=this.lastEncoderMs.get(t.ssrc);if(!l||l.lastFrameCount>t.framesEncoded)i.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{let p=t.framesEncoded-l.lastFrameCount,f=t.totalEncodeTime-l.lastEncoderTime;i.avgEncodeMs=1e3*f/p}}if(t.framesEncoded&&t.qpSum){let l=this.lastEncoderMs.get(t.ssrc);!l||l.lastFrameCount>t.framesEncoded?i.qpSumPerFrame=t.qpSum/t.framesEncoded:i.qpSumPerFrame=(t.qpSum-l.lastQpSum)/(t.framesEncoded-l.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,i),this.processVideoTrackSenderStats(t,t.trackId,i),t.remoteId)this.processRemoteInboundStats(t.remoteId,i);else{let l=this.findRemoteStatsId(t.ssrc,Ct.REMOTE_INBOUND);l&&this.processRemoteInboundStats(l,i)}}processAudioOutboundStats(t){let i=this._stats.audioSend.find(a=>a.ssrc===t.ssrc);if(i||(i=Ra(uk),this._stats.audioSend.push(i)),i.ssrc=t.ssrc,i.packets=t.packetsSent,i.bytes=t.bytesSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,i),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,i),t.remoteId)this.processRemoteInboundStats(t.remoteId,i);else{let a=this.findRemoteStatsId(t.ssrc,Ct.REMOTE_INBOUND);a&&this.processRemoteInboundStats(a,i)}}findRemoteStatsId(t,i){var a;let l=Array.from(hc(a=this.report).call(a)).find(p=>p.type===i&&p.ssrc===t);return l?l.id:null}processVideoMediaSource(t,i){let a=this.report.get(t);a&&a.width&&a.height&&a.framesPerSecond&&(i.inputFrame={width:a.width,height:a.height,frameRate:a.framesPerSecond})}processAudioMediaSource(t,i){let a=this.report.get(t);a&&(i.inputLevel=a.audioLevel)}processVideoTrackSenderStats(t,i,a){var l,p,f,g;let v=i?this.report.get(i):void 0,y=(l=v==null?void 0:v.framesSent)!==null&&l!==void 0?l:t.framesSent;if(typeof y!="number")return;let I=(p=v==null?void 0:v.frameWidth)!==null&&p!==void 0?p:t.frameWidth,b=(f=v==null?void 0:v.frameHeight)!==null&&f!==void 0?f:t.frameHeight,k=(g=v==null?void 0:v.framesPerSecond)!==null&&g!==void 0?g:t.framesPerSecond;if(typeof I=="number"&&typeof b=="number"||(I=0,b=0),k==null){let U=Date.now(),J=this.lastVideoFramesSent.get(a.ssrc);J&&U-J.lts>=800?(k=Math.round((y-J.count)/((U-J.lts)/1e3)),this.lastVideoFramesSent.set(a.ssrc,{count:y,lts:U,rate:k})):J?k=J.rate:this.lastVideoFramesSent.set(a.ssrc,{count:y,lts:U,rate:0})}a.sentFrame={width:I,height:b,frameRate:Math.max(0,k)}}processVideoTrackReceiverStats(t,i,a){var l,p,f,g,v;let y=i?this.report.get(i):void 0,I=(l=y==null?void 0:y.framesReceived)!==null&&l!==void 0?l:t.framesReceived,b=(p=y==null?void 0:y.frameWidth)!==null&&p!==void 0?p:t.frameWidth,k=(f=y==null?void 0:y.frameHeight)!==null&&f!==void 0?f:t.frameHeight,U=(g=y==null?void 0:y.jitterBufferDelay)!==null&&g!==void 0?g:t.jitterBufferDelay,J=(v=y==null?void 0:y.jitterBufferEmittedCount)!==null&&v!==void 0?v:t.jitterBufferEmittedCount;if(typeof I=="number"){let K=this.lastVideoFramesRecv.get(a.ssrc),q=Date.now();a.framesReceivedCount=I;let te=0;K&&q-K.lts>=800?(te=Math.round((I-K.count)/((q-K.lts)/1e3)),this.lastVideoFramesRecv.set(a.ssrc,{count:I,lts:q,rate:te})):K?te=K.rate:this.lastVideoFramesRecv.set(a.ssrc,{count:I,lts:q,rate:0}),a.receivedFrame={width:b||0,height:k||0,frameRate:te||0},a.decodedFrame={width:b||0,height:k||0,frameRate:a.decodeFrameRate||0},a.outputFrame={width:b||0,height:k||0,frameRate:a.decodeFrameRate||0}}if(U&&J){let K=this.lastVideoJBDelay.get(a.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},q=K.jitterBufferMs,te=J-K.jitterBufferEmittedCount;te>0&&(q=1e3*(U-K.jitterBufferDelay)/te),a.jitterBufferMs=q,a.currentDelayMs=Math.round(q),this.lastVideoJBDelay.set(a.ssrc,{jitterBufferDelay:U,jitterBufferEmittedCount:J,jitterBufferMs:a.currentDelayMs})}}processAudioTrackSenderStats(t,i,a){var l,p,f,g;let v=i?this.report.get(i):void 0,y=(l=(p=v==null?void 0:v.echoReturnLoss)!==null&&p!==void 0?p:t.echoReturnLoss)!==null&&l!==void 0?l:0,I=(f=(g=v==null?void 0:v.echoReturnLossEnhancement)!==null&&g!==void 0?g:t.echoReturnLossEnhancement)!==null&&f!==void 0?f:0;a.aecReturnLoss=y,a.aecReturnLossEnhancement=I}processAudioTrackReceiverStats(t,i,a){var l,p,f,g,v,y,I;let b=i?this.report.get(i):void 0,k=(l=b==null?void 0:b.removedSamplesForAcceleration)!==null&&l!==void 0?l:t.removedSamplesForAcceleration,U=(p=b==null?void 0:b.totalSamplesReceived)!==null&&p!==void 0?p:t.totalSamplesReceived,J=(f=b==null?void 0:b.jitterBufferDelay)!==null&&f!==void 0?f:t.jitterBufferDelay,K=(g=b==null?void 0:b.jitterBufferEmittedCount)!==null&&g!==void 0?g:t.jitterBufferEmittedCount,q=(v=b==null?void 0:b.audioLevel)!==null&&v!==void 0?v:t==null?void 0:t.audioLevel,te=(y=b==null?void 0:b.totalSamplesDuration)!==null&&y!==void 0?y:t==null?void 0:t.totalSamplesDuration,de=(I=b==null?void 0:b.concealedSamples)!==null&&I!==void 0?I:t.concealedSamples;if(k&&U&&(a.accelerateRate=k/U),J&&K){let Ue=this.lastAudioJBDelay.get(a.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},Re=Ue.jitterBufferMs,Ie=K-Ue.jitterBufferEmittedCount;Ie>0&&(Re=1e3*(J-Ue.jitterBufferDelay)/Ie),a.jitterBufferMs=Math.round(Re),this.lastAudioJBDelay.set(a.ssrc,{jitterBufferDelay:J,jitterBufferEmittedCount:K,jitterBufferMs:a.jitterBufferMs})}a.outputLevel=q;let he=1920;te&&U&&(he=U/te/50,a.receivedFrames=Math.round(U/he)),de&&(a.droppedFrames=Math.round(de/he))}processRemoteInboundStats(t,i){let a=this.report.get(t);a&&(i.packetsLost=a.packetsLost,a.roundTripTime&&(i.rttMs=1e3*a.roundTripTime),a.jitter&&(i.jitterMs=1e3*a.jitter),a.timestamp&&(i.timestamp=a.timestamp))}getCodecFromCodecStats(t){let i=this.report.get(t);if(!i)return"";let a=i.mimeType.match(/\/(.*)$/);return a&&a[1]?a[1]:""}updateSendBitrate(){let t=0,i=null,a=null;this.mediaBytesSent.forEach(p=>{t+=p.diffMean()}),this.mediaBytesRetransmit.forEach(p=>{i=i===null?p.diffMean():i+p.diffMean()}),this.mediaBytesTargetEncode.forEach(p=>{a=a===null?p.diffMean():a+p.diffMean()});let l=i!==null?t-i:t;this._stats.bitrate={actualEncoded:8*l/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},i!==null&&(this._stats.bitrate.retransmit=8*i/(this.options.updateInterval/1e3)),a!==null&&(this._stats.bitrate.targetEncoded=8*a/(this.options.updateInterval/1e3))}}class k3 extends eS{updateStats(){return Pe.resolve()}}function KC(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,l=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4,p=function(){let f=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return f&&f[0]?Number(f[0].split("/")[1]):null}();return p?p<76?new fk(s,{updateInterval:t,lossRateInterval:i,freezeRateLimit:a,firstVideoDecodedTimeout:l}):new Yb(s,{updateInterval:t,lossRateInterval:i,freezeRateLimit:a,firstVideoDecodedTimeout:l}):function(f){return!!window.RTCStatsReport&&f.getStats()instanceof Pe}(s)?new Yb(s,{updateInterval:t,lossRateInterval:i,freezeRateLimit:a,firstVideoDecodedTimeout:l}):new k3(s,{updateInterval:t,lossRateInterval:i,freezeRateLimit:a,firstVideoDecodedTimeout:l})}function zb(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Ek(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?zb(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):zb(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function tS(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},a=arguments.length>3?arguments[3]:void 0,{filterRTX:l,filterVideoFec:p,filterAudioFec:f,filterAudioCodec:g,filterVideoCodec:v}=t,{useXR:y}=i,I=[],b=[],k=[],U=[],J=!1,K=!1;if(Ci.parse(s).mediaDescriptions.forEach(te=>{a&&a!==te.attributes.direction||(te.media.mediaType!=="video"||J||(b=te.attributes.payloads,U=te.attributes.extmaps,J=!0),te.media.mediaType!=="audio"||K||(I=te.attributes.payloads,k=te.attributes.extmaps,K=!0))}),!U||b.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!k||I.length===0)throw new Error("Cannot get audio capabilities from SDP.");b.forEach(te=>{var de;(de=te.rtpMap)!==null&&de!==void 0&&de.clockRate&&(te.rtpMap.clockRate=parseInt(te.rtpMap.clockRate)),y&&te.rtcpFeedbacks.push({type:"rrtr"})}),I.forEach(te=>{var de;(de=te.rtpMap)!==null&&de!==void 0&&de.clockRate&&(te.rtpMap.clockRate=parseInt(te.rtpMap.clockRate)),y&&te.rtcpFeedbacks.push({type:"rrtr"})}),l&&(I=I.filter(te=>{var de;return((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName.toLowerCase())!=="rtx"}),b=b.filter(te=>{var de;return((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName.toLowerCase())!=="rtx"})),p&&(b=b.filter(te=>{var de;return!/(red)|(ulpfec)|(flexfec)/i.test(((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName)||"")})),f&&(I=I.filter(te=>{var de;return!/(red)|(ulpfec)|(flexfec)/i.test(((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName)||"")})),g&&(g==null?void 0:g.length)>0&&(I=I.filter(te=>{var de;return xe(g).call(g,((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName.toLowerCase())||"")})),v&&(v==null?void 0:v.length)>0&&(b=b.filter(te=>{var de;return xe(v).call(v,((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName.toLowerCase())||"")}));let q=ce("UNSUPPORTED_VIDEO_CODEC");return q&&q.length>0&&(b=b.filter(te=>!(te.rtpMap&&xe(q).call(q,te.rtpMap.encodingName.toLowerCase())))),{audioCodecs:I,videoCodecs:b,audioExtensions:k,videoExtensions:U}}function Ud(s){let t=Ci.parse(s),i,a;for(let l of t.mediaDescriptions){if(!i){let p=l.attributes.iceUfrag,f=l.attributes.icePwd;if(!p||!f)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:p,icePwd:f}}if(!a){let p=l.attributes.fingerprints;p.length>0&&(a={fingerprints:p})}}if(!a&&t.attributes.fingerprints.length>0&&(a={fingerprints:t.attributes.fingerprints}),!a||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:a}}function YC(s,t){let i=[],a=s.attributes.ssrcGroups.filter(f=>f.semantic==="FID"),l=s.attributes.ssrcGroups.find(f=>f.semantic==="SIM"),p=s.attributes.ssrcs;if(l)l.ssrcIds.forEach(f=>{var g;let v=(g=a.find(y=>y.ssrcIds[0]===f))===null||g===void 0?void 0:g.ssrcIds[1];i.push({ssrcId:f,rtx:t?v:void 0})});else if(a.length>0){let f=a[0].ssrcIds[0],g=a[0].ssrcIds[1];i.push({ssrcId:f,rtx:t?g:void 0})}else{if(p.length===0)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:p[0].ssrcId})}return i}function zC(s,t){let{cname:i}=s,a;t&&t.ip&&typeof t.port=="number"?(a=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],x.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(a.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),x.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):a=s.iceParameters.candidates.map(g=>({foundation:g.foundation,componentId:"1",transport:g.protocol,priority:g.priority.toString(),connectionAddress:g.ip,port:g.port.toString(),type:g.type,extension:{}}));let l={fingerprints:s.dtlsParameters.fingerprints.map(g=>({hashFunction:g.algorithm,fingerprint:g.fingerprint}))},p={iceUfrag:s.iceParameters.iceUfrag,icePwd:s.iceParameters.icePwd},f;switch(s.dtlsParameters.role){case"server":f="passive";break;case"client":f="active";break;case"auto":f="actpass"}return{dtlsParameters:l,iceParameters:p,candidates:a,rtpCapabilities:xf(s.rtpCapabilities),setup:f,cname:i}}function xo(s,t,i){let a=[],l=[];return s.forEach(p=>{let{ssrcId:f,rtx:g}=p,v=si(8,"track-"),y={ssrcId:f,attributes:Ek({label:v,mslabel:i=i||si(10,""),msid:"".concat(i," ").concat(v)},t&&{cname:t})};if(a.push(y),g!==void 0){let I={ssrcId:g,attributes:Ek({label:v,mslabel:i,msid:"".concat(i," ").concat(v)},t&&{cname:t})};a.push(I),l.push({semantic:"FID",ssrcIds:[f,g]})}}),s.length>1&&l.push({semantic:"SIM",ssrcIds:s.map(p=>{let{ssrcId:f}=p;return f})}),{ssrcs:a,ssrcGroups:l}}function xd(s,t){t instanceof Vn&&s.attributes.payloads.forEach(i=>{var a;let l=(a=i.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase();if(!l||["opus","pcmu","pcma","g722"].indexOf(l)===-1)return;i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters.minptime="10",i.fmtp.parameters.useinbandfec="1";let p=t._encoderConfig;p&&l!=="pcmu"&&l!=="pcma"&&l!=="g722"&&(p.bitrate&&!Hn()&&(i.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*p.bitrate))),p.sampleRate&&(i.fmtp.parameters.maxplaybackrate="".concat(p.sampleRate),i.fmtp.parameters["sprop-maxcapturerate"]="".concat(p.sampleRate)),p.stereo&&(i.fmtp.parameters.stereo="1",i.fmtp.parameters["sprop-stereo"]="1"))})}function bu(s){let t=s.attributes.unrecognized.findIndex(i=>i.attField==="x-google-flag"&&i.attValue==="conference");t!==-1&&s.attributes.unrecognized.splice(t,1)}function qC(s,t){var i;if(!(t instanceof jt&&t._encoderConfig&&t._hints.indexOf(Un.SCREEN_TRACK)===-1))return;let a=t._encoderConfig;zn().supportMinBitrate&&a.bitrateMin&&s.attributes.payloads.forEach(l=>{var p,f;xe(p=["h264","h265","vp8","vp9","av1"]).call(p,((f=l.rtpMap)===null||f===void 0?void 0:f.encodingName.toLowerCase())||"")&&(l.fmtp||(l.fmtp={parameters:{}}),l.fmtp.parameters["x-google-min-bitrate"]="".concat(a.bitrateMin))}),zn().supportMinBitrate&&!xe(i=t._hints).call(i,Un.LOW_STREAM)&&a.bitrateMax&&s.attributes.payloads.forEach(l=>{var p,f;xe(p=["h264","h265","vp8","vp9","av1"]).call(p,((f=l.rtpMap)===null||f===void 0?void 0:f.encodingName.toLowerCase())||"")&&(l.fmtp||(l.fmtp={parameters:{}}),l.fmtp.parameters["x-google-start-bitrate"]="".concat(ce("X_GOOGLE_START_BITRATE")||Math.floor(a.bitrateMax)))})}function qb(s){if(s.media.mediaType!=="video")return;let t=En();if(t.name!==Ee.SAFARI&&t.os!==Cr.IOS)return;let i=s.attributes.extmaps.findIndex(a=>/video-orientation/g.test(a.extensionName));i!==-1&&s.attributes.extmaps.splice(i,1)}function hm(s,t,i){if(!t)return;let a,l;if(s.media.mediaType==="video"?(a=i.videoExtensions,l=i.videoCodecs):(a=i.audioExtensions,l=i.audioCodecs),t.twcc===!0){let p=a.find(f=>f.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");p&&(s.attributes.extmaps.find(f=>f.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||s.attributes.extmaps.push({entry:p.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(f,g){return g.filter(v=>!!f.find(y=>y.payloadType===v.payloadType&&!!y.rtcpFeedbacks.find(I=>I.type==="transport-cc")))}(l,s.attributes.payloads).forEach(f=>{f.rtcpFeedbacks.find(g=>g.type==="transport-cc")||f.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(t.twcc===!1){let p=s.attributes.extmaps.findIndex(f=>f.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");p!==-1&&s.attributes.extmaps.splice(p,1),s.attributes.payloads.forEach(f=>{let g=f.rtcpFeedbacks.findIndex(v=>v.type==="transport-cc");g!==-1&&f.rtcpFeedbacks.splice(g,1)})}if(t.remb===!0){let p=a.find(f=>f.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");p&&(s.attributes.extmaps.find(f=>f.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||s.attributes.extmaps.push({entry:p.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(f,g){return g.filter(v=>!!f.find(y=>y.payloadType===v.payloadType&&!!y.rtcpFeedbacks.find(I=>I.type==="goog-remb")))}(l,s.attributes.payloads).forEach(f=>{f.rtcpFeedbacks.find(g=>g.type==="goog-remb")||f.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(t.remb===!1){let p=s.attributes.extmaps.findIndex(f=>f.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");p!==-1&&s.attributes.extmaps.splice(p,1),s.attributes.payloads.forEach(f=>{let g=f.rtcpFeedbacks.findIndex(v=>v.type==="goog-remb");g!==-1&&f.rtcpFeedbacks.splice(g,1)})}}function nS(s,t,i){if(Hn()||s.media.mediaType!=="video"||!(t instanceof jt)||i!=="vp9"&&i!=="vp8"||i==="vp8"&&!ce("SIMULCAST")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;let a=i==="vp8"?2:t._scalabilityMode.numSpatialLayers,l=s.attributes.ssrcs[0],p=s.attributes.ssrcGroups.find(g=>g.semantic==="FID"&&g.ssrcIds[0]===l.ssrcId),f={semantic:"SIM",ssrcIds:[l.ssrcId]};for(let g=1;g<a;g++)s.attributes.ssrcs.push({ssrcId:l.ssrcId+g,attributes:Gn(l.attributes)}),f.ssrcIds.push(l.ssrcId+g),p&&(s.attributes.ssrcs.push({ssrcId:p.ssrcIds[1]+g,attributes:Gn(l.attributes)}),s.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[l.ssrcId+g,p.ssrcIds[1]+g]}));s.attributes.ssrcGroups.unshift(f)}async function Ba(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});let a=(await i.createOffer()).sdp,{send:l,recv:p,sendrecv:f}=function(){let g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},y=arguments.length>2?arguments[2]:void 0,I=tS(y,g,v,"sendonly"),b=tS(y,g,v,"recvonly"),k={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},U={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},J={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ec(I,b,"videoExtensions",k,U,J),Ec(I,b,"videoCodecs",k,U,J),Ec(I,b,"audioExtensions",k,U,J),Ec(I,b,"audioCodecs",k,U,J),ce("RAISE_H264_BASELINE_PRIORITY")){let K=J.videoCodecs.findIndex(q=>{var te,de;return((te=q.rtpMap)===null||te===void 0?void 0:te.encodingName.toLocaleLowerCase())==="h264"&&((de=q.fmtp)===null||de===void 0?void 0:de.parameters["profile-level-id"])==="42001f"});if(K!==-1){let q=J.videoCodecs.findIndex(te=>{var de;return((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName.toLocaleLowerCase())==="h264"});if(q<K){x.debug("raising H264 baseline profile priority");let te=J.videoCodecs[K];J.videoCodecs.splice(K,1),J.videoCodecs.splice(q,0,te)}q!==-1&&(U.videoCodecs=U.videoCodecs.filter(te=>{var de,he;return!(((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName.toLocaleLowerCase())==="h264"&&((he=te.fmtp)===null||he===void 0?void 0:he.parameters["profile-level-id"])!=="42001f")})),q!==-1&&ce("FILTER_SEND_H264_BASELINE")&&(k.videoCodecs=k.videoCodecs.filter(te=>{var de,he;return!(((de=te.rtpMap)===null||de===void 0?void 0:de.encodingName.toLocaleLowerCase())==="h264"&&((he=te.fmtp)===null||he===void 0?void 0:he.parameters["profile-level-id"])!=="42001f")}))}}return{send:k,recv:U,sendrecv:J}}(s,t,a);try{i.close()}catch{}return{send:l,recv:p,sendrecv:f}}function gk(){let s={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=tS(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},l={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ec(s,t,"videoExtensions",i,a,l),Ec(s,t,"videoCodecs",i,a,l),Ec(s,t,"audioExtensions",i,a,l),Ec(s,t,"audioCodecs",i,a,l),ce("RAISE_H264_BASELINE_PRIORITY")){let p=l.videoCodecs.findIndex(f=>f.rtpMap&&f.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&f.fmtp&&f.fmtp.parameters["profile-level-id"]==="42001f");if(p!==-1){let f=l.videoCodecs.findIndex(g=>g.rtpMap&&g.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(f<p){x.debug("raising H264 baseline profile priority");let g=l.videoCodecs[p];l.videoCodecs.splice(p,1),l.videoCodecs.splice(f,0,g)}f!==-1&&(a.videoCodecs=a.videoCodecs.filter(g=>!(g.rtpMap&&g.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&g.fmtp&&g.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:i,recv:a,sendrecv:l}}function Ec(s,t,i,a,l,p){if(i==="videoExtensions"||i==="audioExtensions"){let f=[];return s[i].forEach(g=>{t[i].some((v,y)=>{if(g.entry===v.entry&&g.extensionName===v.extensionName)return f.push(y),!0})?p[i].push(g):a[i].push(g)}),void t[i].forEach((g,v)=>{f.indexOf(v)===-1&&l[i].push(g)})}if(i==="videoCodecs"||i==="audioCodecs"){let f=[];return s[i].forEach(g=>{t[i].some((v,y)=>{if(g.payloadType===v.payloadType&&JSON.stringify(g)===JSON.stringify(v))return f.push(y),!0})?p[i].push(g):a[i].push(g)}),void t[i].forEach((g,v)=>{f.indexOf(v)===-1&&l[i].push(g)})}}function xf(s){let{send:t,recv:i,sendrecv:a}=s;if(!a){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let l,p;return t?(l={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},l.audioCodecs=[...t.audioCodecs,...a.audioCodecs],l.videoCodecs=[...t.videoCodecs,...a.videoCodecs],l.audioExtensions=[...t.audioExtensions,...a.audioExtensions],l.videoExtensions=[...t.videoExtensions,...a.videoExtensions]):l=a,i?(p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p.audioCodecs=[...i.audioCodecs,...a.audioCodecs],p.videoCodecs=[...i.videoCodecs,...a.videoCodecs],p.audioExtensions=[...i.audioExtensions,...a.audioExtensions],p.videoExtensions=[...i.videoExtensions,...a.videoExtensions]):p=a,{send:l,recv:p}}function Vd(s){s.media.mediaType==="audio"&&s.attributes.payloads.filter(t=>{var i;return((i=t.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function iS(s){s.mediaDescriptions.forEach(t=>{t.media.mediaType!=="video"&&t.media.mediaType!=="audio"||t.attributes.payloads.forEach(i=>{i.rtcpFeedbacks.findIndex(a=>a.type==="rrtr")===-1&&i.rtcpFeedbacks.push({type:"rrtr"})})})}function Ou(s,t,i,a){let l=[];if(s===We.VIDEO){if(ce("H264_PROFILE_LEVEL_ID")&&a==="h264"&&(l=t.videoCodecs.filter(p=>{var f;return xe(f=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(f,a)&&p&&p.fmtp&&p.fmtp.parameters["profile-level-id"]===ce("H264_PROFILE_LEVEL_ID")})),!Array.isArray(l)||l.length===0){let p=[],f=[],g=[];i.videoCodecs.forEach(v=>{var y,I,b;xe(y=v.rtpMap&&v.rtpMap.encodingName.toLowerCase()||"").call(y,a)&&p.push(v),xe(I=v.rtpMap&&v.rtpMap.encodingName.toLowerCase()||"").call(I,"vp8")&&f.push(v),xe(b=v.rtpMap&&v.rtpMap.encodingName.toLowerCase()||"").call(b,"h264")&&g.push(v)}),p.length===0&&(f.length!==0?(p=f,x.warning("codec ".concat(a," not included in rtpCapabilities, fallback to default payloads: vp8"))):g.length!==0&&(p=g,x.warning("codec ".concat(a," not included in rtpCapabilities, fallback to default payloads: h264")))),p.length!==0&&(l=t.videoCodecs.filter(v=>p.some(y=>y.payloadType===v.payloadType)))}if(ce("USE_PUB_RTX")){let p=l.map(g=>g.payloadType.toString()),f=t.videoCodecs.filter(g=>g.rtpMap&&g.rtpMap.encodingName==="rtx"&&xe(p).call(p,g.fmtp&&g.fmtp.parameters.apt||""));l=[...l,...f]}l.length===0&&(x.warning("codec ".concat(a," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),l=t.videoCodecs)}else l=t.audioCodecs.filter(p=>{var f;return xe(f=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(f,a)}),l.length===0&&(x.warning("codec ".concat(a," not included in rtpCapabilities, fallback to opus")),l=t.audioCodecs.filter(p=>{var f;return xe(f=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(f,"opus")}));return l}let Sk=class{get localCapabilities(){return Gn(this._localCapabilities)}get rtpCapabilities(){return Gn(this._rtpCapabilities)}get candidates(){return Gn(this._candidates)}get iceParameters(){return Gn(this._iceParameters)}get dtlsParameters(){return Gn(this._dtlsParameters)}constructor(s){P(this,"sessionDesc",void 0),P(this,"_localCapabilities",void 0),P(this,"_rtpCapabilities",void 0),P(this,"_candidates",void 0),P(this,"_iceParameters",void 0),P(this,"_dtlsParameters",void 0),P(this,"setup",void 0),P(this,"currentMidIndex",void 0),P(this,"cname","o/i14u9pJrxRKAsu"),P(this,"firefoxSsrcMidMap",new Map),s=Gn(s);let{remoteIceParameters:t,remoteDtlsParameters:i,candidates:a,remoteRTPCapabilities:l,localCapabilities:p,direction:f,setup:g,videoCodec:v,audioCodec:y}=s,I;this.setup=g,I=f===Ks.RECEIVE_ONLY?Ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=l,this._candidates=a,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=p;let b=f===Ks.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,k=f===Ks.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,U=f===Ks.RECEIVE_ONLY?l.send.videoCodecs:Ou(We.VIDEO,b,k,v),J=f===Ks.RECEIVE_ONLY?l.send.audioCodecs:Ou(We.AUDIO,b,k,y);for(let K of I.mediaDescriptions){if(K.attributes.iceUfrag=t.iceUfrag,K.attributes.icePwd=t.icePwd,K.attributes.fingerprints=i.fingerprints,K.attributes.candidates=a,K.attributes.setup=this.setup,K.media.mediaType==="application"&&(K.attributes.sctpPort="5000"),K.media.mediaType==="video"&&(K.media.fmts=U.map(q=>q.payloadType.toString(10)),K.attributes.payloads=U,K.attributes.extmaps=b.videoExtensions,ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:q,ssrcGroups:te}=xo([{ssrcId:4e4,rtx:ce("USE_SUB_RTX")?40001:void 0}],this.cname);K.attributes.ssrcs=q,K.attributes.ssrcGroups=te}if(K.media.mediaType==="audio"&&(K.media.fmts=J.map(q=>q.payloadType.toString(10)),K.attributes.payloads=J,K.attributes.extmaps=b.audioExtensions,Vd(K),ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:q,ssrcGroups:te}=xo([{ssrcId:2e4}],this.cname);K.attributes.ssrcs=q,K.attributes.ssrcGroups=te}}this.sessionDesc=I,this.currentMidIndex=I.mediaDescriptions.length-1}toString(){return Ci.print(this.sessionDesc)}hasMid(s){return Array.isArray(s)?s.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===s)}send(s,t,i,a,l){i=i.replace(/ /g,"-");let{ssrcs:p,ssrcGroups:f}=xo(t,this.cname,ce("SYNC_GROUP")?i:void 0),g=this.findPreloadMediaDesc(p);if(g){if(Hn()&&this.firefoxSsrcMidMap.set(p[0].ssrcId,g.attributes.mid),l&&(l.twcc||l.remb)){let v=this.sessionDesc.mediaDescriptions.indexOf(g);return this.sessionDesc.mediaDescriptions[v]=this.mungSendMediaDesc(g,l),{mid:g.attributes.mid,needExchangeSDP:!0}}return{mid:g.attributes.mid,needExchangeSDP:!1}}{let v=this.findAvailableMediaIndex(s,p,a),y;return v===-1?(y=this.createOrRecycleSendMedia(s,p,f,"sendonly",a,l),this.updateBundleMids()):(y=Gn(this.sessionDesc.mediaDescriptions[v]),y.attributes.direction="sendonly",y.attributes.ssrcs=p,y.attributes.ssrcGroups=f,this.sessionDesc.mediaDescriptions[v]=this.mungSendMediaDesc(y,l)),Hn()&&this.firefoxSsrcMidMap.set(p[0].ssrcId,y.attributes.mid),{needExchangeSDP:!0,mid:y.attributes.mid}}}stopSending(s){let t=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&s.indexOf(i.attributes.mid)!==-1);if(t.length!==s.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(i=>{i.attributes.ssrcs=[]}),this.updateBundleMids()}receive(s,t,i){let a=[];return s.forEach(l=>{let p=l._mediaStreamTrack.kind,f=this.findAvailableRecvMediaIndex(p),g,v=!1;f===-1?(v=!0,g=this.createOrRecycleRecvMedia(l,[],"recvonly",t,i),this.updateBundleMids()):(g=Gn(this.sessionDesc.mediaDescriptions[f]),g.attributes.direction="recvonly"),a.push({mid:g.attributes.mid,needCreateTransceiver:v})}),a}stopReceiving(s){let t=this.sessionDesc.mediaDescriptions.filter(i=>s.indexOf(i.attributes.mid)!==-1);if(t.length!==s.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(s){let{foundation:t,protocol:i,address:a,port:l,type:p,relatedAddress:f,relatedPort:g,priority:v}=new RTCIceCandidate(s),y={foundation:t??"",componentId:"1",transport:i??"",priority:v?v+"":"",connectionAddress:a??"",port:l?l+"":"",type:p?p+"":"",relAddr:f??"",relPort:g?g+"":"",extension:{}};this.candidates.some(I=>I.priority===y.priority&&I.connectionAddress===y.connectionAddress&&I.port===y.port)||(this._candidates.push(y),this.sessionDesc.mediaDescriptions.forEach(I=>{I.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(s,t,i,a,l){let p=s._mediaStreamTrack.kind,f=this.rtpCapabilities.recv,g=Ou(p,f,this.localCapabilities.send,p===We.AUDIO?l:a),v=p===We.VIDEO?f.videoExtensions:f.audioExtensions,y="".concat(++this.currentMidIndex),I={media:{mediaType:p,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:g.map(k=>k.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:v,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:g,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(y)}};I=this.mungRecvMediaDsec(I,s);let b=this.findFirstClosedMedia(p);if(b){let k=this.sessionDesc.mediaDescriptions.indexOf(b);this.sessionDesc.mediaDescriptions[k]=I}else this.sessionDesc.mediaDescriptions.push(I);return I}muteRemote(s){let t=this.sessionDesc.mediaDescriptions.filter(i=>xe(s).call(s,i.attributes.mid||""));if(t.length!==s.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(s){let t=this.sessionDesc.mediaDescriptions.filter(i=>xe(s).call(s,i.attributes.mid||""));if(t.length!==s.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="recvonly"})}findAvailableMediaIndex(s,t,i){return this.sessionDesc.mediaDescriptions.findIndex(a=>{let l=a.media.mediaType===s&&a.media.port!=="0"&&(a.attributes.direction==="sendonly"||a.attributes.direction==="sendrecv")&&a.attributes.ssrcs.length===0;if(Hn()){if(l){let p=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(p||a.attributes.mid!=="0"&&a.attributes.mid!=="1")||!(!p||p!==a.attributes.mid)}return!1}return l&&a.attributes.mid===i})}findAvailableRecvMediaIndex(s){return this.sessionDesc.mediaDescriptions.findIndex(t=>{let i=t.media.mediaType===s&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&i})}predictReceivingMids(s){let t=[];for(let i=0;i<s;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(s){s=Gn(s),this._iceParameters=s,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=s.iceUfrag,t.attributes.icePwd=s.icePwd})}createOrRecycleSendMedia(s,t,i,a,l,p){let f=this.rtpCapabilities.send,g=s===We.VIDEO?f.videoCodecs:f.audioCodecs,v=s===We.VIDEO?f.videoExtensions:f.audioExtensions;Hn()&&(l="".concat(++this.currentMidIndex));let y={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:g.map(b=>b.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:v,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:g,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:a,rtcpMux:!0,rtcpRsize:!0,mid:l}};y=this.mungSendMediaDesc(y,p);let I=this.findFirstClosedMedia(s);if(I){let b=this.sessionDesc.mediaDescriptions.indexOf(I);this.sessionDesc.mediaDescriptions[b]=y}else this.sessionDesc.mediaDescriptions.push(y);return y}mungRecvMediaDsec(s,t,i){let a=Gn(s);return bu(a),xd(a,t),qC(a,t),qb(a),hm(a,i,this.localCapabilities.send),a}mungSendMediaDesc(s,t){let i=Gn(s);return hm(i,t,this.localCapabilities.recv),Vd(i),i}updateRecvMedia(s,t){let i=this.sessionDesc.mediaDescriptions.findIndex(a=>a.attributes.mid===s);if(i!==-1){let a=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=a}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(s=>s.media.port!=="0").map(s=>s.attributes.mid)}findPreloadMediaDesc(s){return this.sessionDesc.mediaDescriptions.find(t=>{var i;return((i=t.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===s[0].ssrcId})}findFirstClosedMedia(s){return this.sessionDesc.mediaDescriptions.find(t=>Hn()?t.media.port==="0"&&t.media.mediaType===s:t.media.port==="0")}},L3=["sdp"];function Tk(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Dh(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Tk(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Tk(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}let oo=class gv extends fh{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,i;return(t=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,a){super(t,i),P(this,"direction",void 0),P(this,"name",void 0),P(this,"store",void 0),P(this,"spec",void 0),P(this,"peerConnection",void 0),P(this,"initialOffer",void 0),P(this,"transport",void 0),P(this,"statsFilter",void 0),P(this,"localCandidateCount",0),P(this,"allCandidatesReceived",!1),P(this,"localCandidateAddress",null),P(this,"useXR",ce("USE_XR")),P(this,"filter",{filterRTX:!ce("USE_PUB_RTX")&&!ce("USE_SUB_RTX"),filterVideoFec:ce("FILTER_VIDEO_FEC"),filterAudioFec:ce("FILTER_AUDIO_FEC")}),P(this,"extension",{useXR:this.useXR}),P(this,"_isInRestartIce",!1),P(this,"mutex",new sn("P2PConnection-mutex")),P(this,"onLocalCandidate",void 0),P(this,"remoteSDP",void 0),P(this,"pendingCandidates",[]),P(this,"localCapabilities",void 0),P(this,"isReady",!1),P(this,"restartCnt",0),P(this,"curTurnServerIndex",0),this.store=i,this.spec=t,this.peerConnection=new RTCPeerConnection(gv.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=a??Ks.SEND_ONLY,this.name=this.direction===Ks.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=KC(this.peerConnection,ce("STATS_UPDATE_INTERVAL"),void 0,Hn()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{let i=await Ba(this.filter,this.extension);if(this.localCapabilities=xf(i),t){let{sdp:a}=t,l=P3(t,L3),p=function(){let I={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},b=tS(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),k={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},U={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},J={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ec(b,I,"videoExtensions",k,U,J),Ec(b,I,"videoCodecs",k,U,J),Ec(b,I,"audioExtensions",k,U,J),Ec(b,I,"audioCodecs",k,U,J),ce("RAISE_H264_BASELINE_PRIORITY")){let K=J.videoCodecs.findIndex(q=>q.rtpMap&&q.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&q.fmtp&&q.fmtp.parameters["profile-level-id"]==="42001f");if(K!==-1){let q=J.videoCodecs.findIndex(te=>te.rtpMap&&te.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(q<K){x.debug("raising H264 baseline profile priority");let te=J.videoCodecs[K];J.videoCodecs.splice(K,1),J.videoCodecs.splice(q,0,te)}q!==-1&&ce("FILTER_SEND_H264_BASELINE")&&(k.videoCodecs=k.videoCodecs.filter(te=>!(te.rtpMap&&te.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&te.fmtp&&te.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:k,recv:U,sendrecv:J}}(this.filter,this.extension,a);this.remoteSDP=new Sk({remoteIceParameters:l.iceParameters,remoteDtlsParameters:l.dtlsParameters,candidates:[],remoteRTPCapabilities:p,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;let f=await this.peerConnection.createAnswer();if(!f.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");let g=Ud(f.sdp);await this.peerConnection.setLocalDescription(f);let v=await gk(this.filter,this.extension,f.sdp);this.localCapabilities=xf(v);let y=this.peerConnection.getTransceivers()[0];return y!=null&&y.receiver&&y.receiver.transport&&this.tryBindTransportEvents(y.receiver.transport),Dh(Dh({},g),{},{sdp:f.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});let a=await this.peerConnection.createOffer();if(!a.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let l=Ud(a.sdp);return this.initialOffer=a,Dh(Dh({},l),{},{sdp:a.sdp})}}catch(i){throw new Ve(Z.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);let{sdp:i,iceParameters:a,dtlsParameters:l}=t,p=await gk(this.filter,this.extension,i);this.remoteSDP=new Sk({remoteIceParameters:a,remoteDtlsParameters:l,candidates:[],remoteRTPCapabilities:p,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});let f=this.peerConnection.getTransceivers()[0];f!=null&&f.sender&&f.sender.transport&&this.tryBindTransportEvents(f.sender.transport)}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i)}),this.pendingCandidates=[])}catch(i){throw new Ve(Z.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(i.toString()))}}send(t,i,a){var l=this;return Ca(function*(){let p=yield nn(l.mutex.lock("From P2PConnection.send"));try{if(!l.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let f=[],g=l.remoteSDP.receive(t,i,a);t.forEach((q,te)=>{if(g[te].needCreateTransceiver){let de=l.peerConnection.addTransceiver(q._mediaStreamTrack,{direction:"sendonly"});f.push(de),q._updateRtpTransceiver(de)}else{let de=l.peerConnection.getTransceivers().find(he=>he.mid===g[te].mid);if(!de)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(g[te].mid));f.push(de),q._updateRtpTransceiver(de)}}),Hn()&&ce("SIMULCAST")===!0&&(yield nn(l.applySimulcastForFirefox(f,t)));let v=g.map(q=>q.mid),y=yield nn(l.peerConnection.createOffer()),I=l.mungSendOfferSDP(y.sdp,t,v),b=Ci.parse(I),k=v.map(q=>{let te=b.mediaDescriptions.find(de=>de.attributes.mid===q);if(!te)throw new Error("Cannot extract ssrc from mediaDescription.");return YC(te,ce("USE_PUB_RTX"))}),U=f.map((q,te)=>{let de=v[te];return{localSSRC:k[te],id:de}});yield nn(l.peerConnection.setLocalDescription({type:"offer",sdp:I}));try{yield U}catch(q){let te=l.remoteSDP.toString();throw yield nn(l.peerConnection.setLocalDescription({type:"offer",sdp:I})),yield nn(l.peerConnection.setRemoteDescription({type:"answer",sdp:te})),yield nn(l.stopSending(v,!0)),q}yield nn(l.applySimulcastEncodings(f,t)),yield nn(l.applySendEncodings(f,t));let J=l.remoteSDP.toString(),K=l.logSDPExchange(I,"offer","local","send");return K==null||K(J),yield nn(l.setRemoteDescription({type:"answer",sdp:J})),f.map((q,te)=>{let de=v[te];return{localSSRC:k[te],id:de}})}catch(f){throw f instanceof Ve?f:new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(f.toString()))}finally{p()}})()}async stopSending(t,i){let a=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let l=this.peerConnection.getTransceivers().filter(v=>t.indexOf(v.mid)!==-1);if(l.length!==t.length)throw new Error("Transceivers' length (".concat(l.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));l.map(v=>{var y;v.direction="inactive",(y=v.stop)===null||y===void 0||y.call(v)});let p=await this.peerConnection.createOffer(),f=this.logSDPExchange(p.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(p),this.remoteSDP.stopReceiving(t);let g=this.remoteSDP.toString();f==null||f(g),await this.setRemoteDescription({type:"answer",sdp:g})}catch(l){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(l.toString()))}finally{a&&a()}}async receive(t,i,a,l){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{mid:p,needExchangeSDP:f}=this.remoteSDP.send(t,i,a,l);if(f){let v=this.remoteSDP.toString(),y=this.logSDPExchange(v,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:v});let I=await this.peerConnection.createAnswer(),b=this.mungReceiveAnswerSDP(I.sdp,p,t);y==null||y(b||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:b}),x.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else x.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));let g=this.peerConnection.getTransceivers().find(v=>v.mid===p);if(!g||g.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:g.receiver.track,mid:g.mid,transceiver:g}}catch(p){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(p.toString()))}}async mockReceive(t,i,a,l){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{mid:p,needExchangeSDP:f}=this.remoteSDP.send(t,i,a,l);if(f){let g=this.remoteSDP.toString(),v=this.logSDPExchange(g,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:g});let y=await this.peerConnection.createAnswer(),I=this.mungReceiveAnswerSDP(y.sdp,p,t);v==null||v(I||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:I}),x.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else x.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(p){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(p.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:i});let l=await this.peerConnection.createAnswer();a==null||a(l.sdp||""),await this.peerConnection.setLocalDescription(l)}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===Ko.Auto&&(this.store.p2pTransport=Ko.SdRtn,zn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(gv.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,zn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(gv.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;let i=await this.peerConnection.createOffer({iceRestart:!0});if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let{iceParameters:a}=Ud(i.sdp);return this.store.descriptionStart(),this.direction===Ks.SEND_ONLY&&await this.peerConnection.setLocalDescription(i),a}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===Ks.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});let i=await this.peerConnection.createAnswer();if(!i.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");let{iceParameters:a}=Ud(i.sdp);return await this.peerConnection.setLocalDescription(i),a}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let a=await this.peerConnection.createOffer(),l=this.mungSendOfferSDP(a.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);let p=this.remoteSDP.toString(),f=this.logSDPExchange(l,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),f==null||f(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(a){throw new Ve(Z.EXCHANGE_SDP_FAILED,a.toString())}}async updateSendParameters(t,i){let a=this.peerConnection.getTransceivers().filter(l=>l.mid===t);a.length===1&&(this.isVP8Simulcast(i)?Hn()||await this.applySimulcastEncodings(a,[i]):await this.applySendEncodings(a,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let a=this.peerConnection.getTransceivers().find(l=>l.mid===i);a&&await a.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){let t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){let i=t[0].transport.iceTransport,{local:a,remote:l}=i.getSelectedCandidatePair();return{local:Dh(Dh({},Md),{},{candidateType:a.type,protocol:a.protocol,address:a.address,port:a.port}),remote:Dh(Dh({},Md),{},{candidateType:l.type,protocol:l.protocol,address:l.address,port:l.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,i;xe(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(i=this.onICEConnectionStateChange)===null||i===void 0||i.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var i;t.candidate.candidate&&(this.localCandidateAddress=t.candidate.address,(i=this.onLocalCandidate)===null||i===void 0||i.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else this.allCandidatesReceived=!0,x.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,i){let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,l={iceServers:[]};var p;return t.iceServers?l.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(nh(t.turnServer.servers)?l.iceServers=t.turnServer.servers:(l.iceServers&&l.iceServers.push(...gv.turnServerConfigToIceServers(t.turnServer.servers,i,a)),ce("USE_TURN_SERVER_OF_GATEWAY")&&l.iceServers&&t.turnServer.serversFromGateway&&l.iceServers.push(...gv.turnServerConfigToIceServers(t.turnServer.serversFromGateway,i,a)),xe(p=[Ko.Relay,Ko.SdRtn]).call(p,i)&&(l.iceTransportPolicy="relay"),ce("FORCE_TURN_TCP")?l.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(f=>{f.forceturn&&(l.iceTransportPolicy="relay")}))),ce("ENABLE_ENCODED_TRANSFORM")&&zn().supportWebRTCEncodedTransform&&(l.encodedInsertableStreams=!0),x.debug("P2PConnection p2pTransport is ".concat(i)),l}static turnServerConfigToIceServers(t,i){let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,l=[],p=t.filter(g=>g.tcpport);x.debug("P2PConnection turnServers is ".concat(p,", current index is ").concat(a));let f=p.length>a?p[a]:p[0];switch(i){case Ko.SdRtn:let g=t.filter(y=>{var I;return xe(I=y.username).call(I,"glb:")&&y.turnServerURL==y.turnServerURL}),v=g.length>a?g[a]:g[0];v&&(l.push({username:v.username,credential:v.password,credentialType:"password",urls:"turn:".concat(hl(v.turnServerURL),":").concat(v.tcpport,"?transport=udp")}),l.push({username:v.username,credential:v.password,credentialType:"password",urls:"turns:".concat(hl(v.turnServerURL),":").concat(v.tcpport,"?transport=tcp")}));break;case Ko.Relay:f&&(l.push({username:f.username,credential:f.password,credentialType:"password",urls:"turn:".concat(f.turnServerURL,":").concat(f.tcpport,"?transport=udp")}),l.push({username:f.username,credential:f.password,credentialType:"password",urls:"turns:".concat(hl(f.turnServerURL),":").concat(f.tcpport,"?transport=tcp")}));break;default:f&&(l.push({username:f.username,credential:f.password,credentialType:"password",urls:"turn:".concat(f.turnServerURL,":").concat(f.tcpport,"?transport=udp")}),l.push({username:f.username,credential:f.password,credentialType:"password",urls:"turns:".concat(hl(f.turnServerURL),":").concat(f.tcpport,"?transport=tcp")}),l.push({username:f.username,credential:f.password,credentialType:"password",urls:"stun:".concat(f.turnServerURL,":").concat(f.tcpport)}))}return l}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var a;t!=null&&t.state&&((a=this.onDTLSTransportStateChange)===null||a===void 0||a.call(this,t.state))},t.onerror=a=>{var l;(l=this.onDTLSTransportError)===null||l===void 0||l.call(this,"error"in a?a.error:a)};let i=t.iceTransport;i&&(i.onstatechange=()=>{let a=t==null?void 0:t.iceTransport.state;var l;a&&((l=this.onICETransportStateChange)===null||l===void 0||l.call(this,a))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:a,remote:l}=i.getSelectedCandidatePair();x.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:a.type,protocol:a.protocol}),", remote ").concat(JSON.stringify({candidateType:l.type,protocol:l.protocol,address:l.address,port:l.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var a;if(i||(i=this.peerConnection.getSenders().find(I=>I.track===t._mediaStreamTrack)),!i)return x.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return x.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!zn().supportSetRtpSenderParameters)return x.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let l={},p={};switch(t._optimizationMode){case"motion":l.degradationPreference="maintain-framerate";break;case"detail":l.degradationPreference="maintain-resolution";break;default:l.degradationPreference="balanced"}if(t._encoderConfig){var f;let{bitrateMax:I,frameRate:b,scaleResolutionDownBy:k}=t._encoderConfig;I&&(p.maxBitrate=1e3*I),xe(f=t._hints).call(f,Un.LOW_STREAM)&&(b&&(p.maxFramerate=zo(b)),k&&k>=1&&(p.scaleResolutionDownBy=k))}if(ce("DSCP_TYPE")&&Ql()){var g;let I=ce("DSCP_TYPE");xe(g=["very-low","low","medium","high"]).call(g,I)&&(p.networkPriority=I)}let v=i.getParameters(),y=(a=v.encodings)===null||a===void 0?void 0:a[0];Hn()&&!y&&(l.encodings=[p]),y&&Object.assign(y,p),Object.assign(v,l),x.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(v.encodings))),await i.setParameters(v)}async applySendEncodings(t,i){try{if(!zn().supportSetRtpSenderParameters||t.length!==i.length)return;for(let a=0;a<t.length;a++){let l=t[a],p=i[a];p instanceof jt&&!this.isVP8Simulcast(p)&&await this.updateRtpSenderEncodings(p,l.sender)}}catch{x.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i,a){let l=Ci.parse(t);return i.forEach((p,f)=>{let g=a[f],v=l.mediaDescriptions.find(y=>y.attributes.mid===g);v&&(xd(v,p),nS(v,p,this.store.codec))}),Ci.print(l)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,a)=>{var l;(l=this.onFirstVideoDecoded)===null||l===void 0||l.call(this,t,i,a)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var a;(a=this.onSelectedLocalCandidateChanged)===null||a===void 0||a.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var a;(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0||a.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let v=0;v<t.length;v++){var a,l,p,f,g;let y=t[v],I=i[v];if(I instanceof jt&&!xe(a=I._hints).call(a,Un.LOW_STREAM)&&(l=I._encoderConfig)!==null&&l!==void 0&&l.bitrateMax&&((p=I._encoderConfig)===null||p===void 0?void 0:p.bitrateMax)>200&&(f=I._scalabilityMode)!==null&&f!==void 0&&f.numSpatialLayers&&((g=I._scalabilityMode)===null||g===void 0?void 0:g.numSpatialLayers)>1&&this.store.codec==="vp8"){let b={},k={high:1e3*(I._encoderConfig.bitrateMax-50),medium:5e4};b.encodings=[{rid:"m",active:!0,maxBitrate:k.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:k.high}];let U=y.sender.getParameters();await y.sender.setParameters(Object.assign(U,b))}}}async applySimulcastEncodings(t,i){if(!Hn()&&t.length===i.length)for(let a=0;a<t.length;a++){let l=i[a];if(l instanceof jt&&this.isVP8Simulcast(l)){let p=t[a],f={},g={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};f.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:g.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:g.medium,scaleResolutionDownBy:4}];let v=p.sender.getParameters();await p.sender.setParameters(Object.assign(v,f))}}}isVP8Simulcast(t){var i,a,l,p,f;return!!(t instanceof jt&&ce("SIMULCAST")&&this.store.codec==="vp8"&&!xe(i=t._hints).call(i,Un.LOW_STREAM)&&(a=t._encoderConfig)!==null&&a!==void 0&&a.bitrateMax&&((l=t._encoderConfig)===null||l===void 0?void 0:l.bitrateMax)>200&&(p=t._scalabilityMode)!==null&&p!==void 0&&p.numSpatialLayers&&((f=t._scalabilityMode)===null||f===void 0?void 0:f.numSpatialLayers)>1)}logSDPExchange(t,i,a,l){if(ce("SDP_LOGGING"))return x.upload("[".concat(this.store.clientId,"] exchanging ").concat(a," ").concat(i," SDP during P2PConnection.").concat(l,`
`),t),i==="offer"?p=>{this.logSDPExchange(p,"answer",a==="local"?"remote":"local",l)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(f=>f.mid&&t.indexOf(f.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(f=>{f.direction="inactive"});let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.muteRemote(t);let p=this.remoteSDP.toString();l==null||l(p),await this.setRemoteDescription({type:"answer",sdp:p})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(f=>f.mid&&t.indexOf(f.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async f=>{f.direction="sendonly"});let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.unmuteRemote(t);let p=this.remoteSDP.toString();l==null||l(p),await this.setRemoteDescription({type:"answer",sdp:p})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}async getRemoteSSRC(t,i){var a,l;if(i=(a=i)!==null&&a!==void 0?a:(l=this.currentRemoteDescription)===null||l===void 0?void 0:l.sdp){var p;let f=(p=Ci.parse(i).mediaDescriptions.find(g=>g.attributes.mid===t))===null||p===void 0?void 0:p.attributes.ssrcs;return f==null?void 0:f[0].ssrcId}}async setRemoteDescription(t){var i;await this.peerConnection.setRemoteDescription(t),xe(i=["connected","completed"]).call(i,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,i,a){let l=Ci.parse(t),p=l.mediaDescriptions.find(f=>f.attributes.mid===i);return p&&(a===We.AUDIO&&p.media.mediaType==="audio"&&Vd(p),this.useXR&&iS(l)),Ci.print(l)}};function gc(s,t,i){let a=s[t];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let l=this.mutex,p=await l.lock("From P2PConnection.".concat(t));try{for(var f=arguments.length,g=new Array(f),v=0;v<f;v++)g[v]=arguments[v];return await a.apply(this,g)}finally{p()}},i}function Jb(s,t){let i=document.createElement("video"),a=document.createElement("canvas");i.setAttribute("style","display:none"),a.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),a.width=zo(t.width),a.height=zo(t.height);let l=zo(t.framerate||15);document.body.append(i),document.body.append(a);let p=s._mediaStreamTrack;i.srcObject=new MediaStream([p]),i.play();let f=a.getContext("2d");if(!f)throw new Ce(Z.UNEXPECTED_ERROR,"can not get canvas context");let g=zn(),v=a.captureStream(g.supportRequestFrame?0:l).getVideoTracks()[0];v.canvas||(v.canvas=a),a.startCapture=()=>{if(!i)return a.stopCapture&&a.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){let I=i.videoWidth,b=i.videoHeight/I,k=a.width*b;Math.abs(k-a.height)>=2&&(x.debug("adjust low stream resolution","".concat(a.width,"x").concat(a.height," -> ").concat(a.width,"x").concat(k)),a.height=k)}f.drawImage(i,0,0,a.width,a.height),v.requestFrame&&v.requestFrame(),p!==s._mediaStreamTrack&&(p=s._mediaStreamTrack,i.srcObject=new MediaStream([p]))},a.stopCapture=Zw(()=>a.startCapture&&a.startCapture(),l);let y=v.stop;return v.stop=()=>{y.call(v),i&&(i.remove(),i.srcObject=null,i=null),a&&(a.width=0,a.remove(),a.stopCapture&&a.stopCapture(),a.startCapture=void 0,a.stopCapture=void 0,a=null),x.debug("clean low stream renderer")},v}var rS,Ck,Kr,Ph,Ls,Vf,Xb,Nu,Sc,Qb,ya;Be([gc,Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],oo.prototype,"establish",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],oo.prototype,"connect",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[String,Array,String,String]),Y("design:returntype",Pe)],oo.prototype,"receive",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[String,Array,String,String]),Y("design:returntype",Pe)],oo.prototype,"mockReceive",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],oo.prototype,"stopReceiving",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],oo.prototype,"restartICE",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],oo.prototype,"close",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],oo.prototype,"updateEncoderConfig",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],oo.prototype,"updateSendParameters",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[tn,String]),Y("design:returntype",Pe)],oo.prototype,"replaceTrack",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],oo.prototype,"muteLocal",null),Be([gc,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],oo.prototype,"unmuteLocal",null),function(s){s[s.HEIGHT=2033]="HEIGHT",s[s.FRAME_RATE=2034]="FRAME_RATE",s[s.WIDTH=2035]="WIDTH"}(rS||(rS={})),function(s){s[s.HEIGHT=2072]="HEIGHT",s[s.FRAME_RATE=2074]="FRAME_RATE",s[s.WIDTH=2076]="WIDTH"}(Ck||(Ck={})),function(s){s[s.FRAME_RATE=2002]="FRAME_RATE",s[s.WIDTH=2003]="WIDTH",s[s.HEIGHT=2004]="HEIGHT",s[s.PACKAGE_LOST=2005]="PACKAGE_LOST",s[s.AVG_ENCODE=2007]="AVG_ENCODE",s[s.NACKS=2009]="NACKS",s[s.PLIS=2010]="PLIS",s[s.FIRS=2011]="FIRS",s[s.BITRATE=2012]="BITRATE",s[s.PACKAGE_RATE=2031]="PACKAGE_RATE",s[s.ADAPTATION=2032]="ADAPTATION",s[s.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",s[s.BANDWIDTH=2061]="BANDWIDTH",s[s.RETRANSMIT=2062]="RETRANSMIT",s[s.TARGET_ENCODED=2064]="TARGET_ENCODED",s[s.TRANSMIT=2066]="TRANSMIT",s[s.FREEZE=2082]="FREEZE",s[s.DISABLED=2095]="DISABLED",s[s.PLAYER_STATUS=2128]="PLAYER_STATUS",s[s.QP_SUM=2143]="QP_SUM"}(Kr||(Kr={})),function(s){s[s.BITRATE=2069]="BITRATE",s[s.PACKAGE_LOST=2070]="PACKAGE_LOST",s[s.PACKAGE_RATE=2071]="PACKAGE_RATE",s[s.HEIGHT=2073]="HEIGHT",s[s.FRAME_RATE=2075]="FRAME_RATE",s[s.WIDTH=2077]="WIDTH"}(Ph||(Ph={})),function(s){s[s.JITTER=-1]="JITTER",s[s.PACKAGE_LOST=2014]="PACKAGE_LOST",s[s.WIDTH=2018]="WIDTH",s[s.HEIGHT=2019]="HEIGHT",s[s.FRAME_RATE=2020]="FRAME_RATE",s[s.JITTER_BUFFER=2023]="JITTER_BUFFER",s[s.CURRENT_DELAY=2024]="CURRENT_DELAY",s[s.NACKS=2026]="NACKS",s[s.PLIS=2027]="PLIS",s[s.FIRS=2028]="FIRS",s[s.BITRATE=2029]="BITRATE",s[s.PACKAGE_RATE=2078]="PACKAGE_RATE",s[s.FREEZE=2084]="FREEZE",s[s.DISABLED=2101]="DISABLED",s[s.PLAYER_STATUS=2129]="PLAYER_STATUS",s[s.QP_SUM=2144]="QP_SUM",s[s.I_FRAME_DELAY=2149]="I_FRAME_DELAY"}(Ls||(Ls={})),function(s){s[s.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",s[s.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",s[s.FREEZE_TIME=2109]="FREEZE_TIME",s[s.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER"}(Vf||(Vf={})),function(s){s[s.PCM_LEVEL=2104]="PCM_LEVEL"}(Xb||(Xb={})),function(s){s[s.PACKAGE_LOST=-1]="PACKAGE_LOST",s[s.LEVEL=2038]="LEVEL",s[s.BITRATE=2039]="BITRATE",s[s.PACKAGE_RATE=2040]="PACKAGE_RATE",s[s.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",s[s.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",s[s.FREEZE=2081]="FREEZE",s[s.DISABLED=2096]="DISABLED"}(Nu||(Nu={})),function(s){s[s.BITRATE=2044]="BITRATE",s[s.PACKAGE_LOST=2045]="PACKAGE_LOST",s[s.PACKAGE_RATE=2046]="PACKAGE_RATE",s[s.CURRENT_DELAY=2047]="CURRENT_DELAY",s[s.JITTER_BUFFER=2054]="JITTER_BUFFER",s[s.JITTER=2055]="JITTER",s[s.FREEZE=2083]="FREEZE",s[s.DISABLED=2102]="DISABLED",s[s.PCM_LEVEL=2105]="PCM_LEVEL",s[s.PLAYER_STATUS=2130]="PLAYER_STATUS",s[s.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES"}(Sc||(Sc={})),function(s){s[s.FREEZE_TIME=-1]="FREEZE_TIME",s[s.LEVEL=2043]="LEVEL"}(Qb||(Qb={})),function(s){s[s.RTT=2006]="RTT",s[s.CONN_TYPE=801]="CONN_TYPE"}(ya||(ya={}));let Du=1e3,pm=3;function ln(s,t,i){i!=null&&Number.isFinite(i)&&(s[t]=Math.round(Math.max(0,i)))}function kh(s){let t={[ya.CONN_TYPE]:0,[ya.RTT]:s.rtt};switch(s.selectedCandidatePair.localCandidate.candidateType){case"relay":{let i=s.selectedCandidatePair.localCandidate.relayProtocol;i==="udp"&&(t[ya.CONN_TYPE]=1),i==="tcp"&&(t[ya.CONN_TYPE]=3),i==="tls"&&(t[ya.CONN_TYPE]=4);break}case"srflx":t[ya.CONN_TYPE]=2}return t}class JC extends ri{constructor(t){super(),P(this,"store",void 0),P(this,"uploadWRTCStatsTimer",void 0),P(this,"uploadOutboundDenoiserStatsTimer",void 0),P(this,"uploadExtStatsTimer",void 0),P(this,"uploadExtUsageStatsTimer",void 0),P(this,"uploadInboundExtStatsTimer",void 0),P(this,"requestStats",void 0),P(this,"requestTransportStats",void 0),P(this,"requestLocalMedia",void 0),P(this,"requestRemoteMedia",void 0),P(this,"requestAllTracks",void 0),P(this,"requestVideoIsReady",void 0),P(this,"requestUploadStats",void 0),P(this,"requestUpload",void 0),P(this,"uploadOutboundStarted",!1),P(this,"uploadInboundStarted",!1),P(this,"uploadTransportStarted",!1),P(this,"uploadExtensionUsageStarted",!1),P(this,"lastRecvStats",void 0),P(this,"lastSendStats",void 0),P(this,"lastFullRecvStats",void 0),P(this,"lastFullSendStats",void 0),P(this,"needUploadRenderFreezeTime",!0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;let i,a;if(this.uploadTransportStarted&&(i=this.requestStats(),this.store.useP2P&&(a=this.requestStats(!0))),!i&&this.uploadOutboundStarted&&(i=this.requestStats()),!a&&this.uploadInboundStarted&&(a=this.requestStats(!0)),i||a){let l={};if(this.uploadTransportStarted&&i){let p=this.getTransportStats(i,a,t);p&&(l.misc=[p])}if(this.uploadOutboundStarted&&i){let p=this.getOutboundStats(i,t?this.lastSendStats:this.lastFullSendStats,t);p&&(l.outbound=[p])}if(this.uploadInboundStarted&&a){let p=this.getInboundStats(a,t?this.lastRecvStats:this.lastFullRecvStats,t);p&&(l.inbound=p)}this.requestUploadStats(l)}this.lastRecvStats=a,this.lastSendStats=i,t||(this.lastFullRecvStats=a,this.lastFullSendStats=i)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(t!==pm),++t===pm+1&&(t=1)},Du)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(t,i,a){if(!this.requestStats)return;if(a)return t.rtt==null?void 0:{addition:{[ya.RTT]:t.rtt,[ya.CONN_TYPE]:void 0}};let l=kh(t);if(this.store.useP2P){if(i){let p=kh(i);l[ya.CONN_TYPE]+=p[ya.CONN_TYPE]<<3}l[ya.CONN_TYPE]+=110}else l[ya.CONN_TYPE]+=100;return{addition:l}}getOutboundStats(t,i,a){if(!this.requestUploadStats||!this.requestLocalMedia)return;let l=this.requestLocalMedia();if(!l||l.length===0)return;let p,f,g;return l.forEach(v=>{let[y,{track:I,ssrcs:b}]=v;switch(y){case Ke.LocalVideoLowTrack:case Ke.LocalVideoTrack:if(y===Ke.LocalVideoTrack){let k=function(K,q,te,de,he){let Ue=q.videoSend.find(Xe=>Xe.ssrc===K);if(!Ue)return;let Re={},{sentFrame:Ie,inputFrame:De}=Ue;if(De&&Ie){let Xe=De.frameRate,nt=Ie.frameRate;Re[Kr.FREEZE]=function(Vt,rn){let ui=!0;return ui=!(Vt<=5)&&(Vt<=10?rn<3:Vt<=20?rn<4:rn<5),ui}(Xe,nt)?1:0}if(ln(Re,Kr.QP_SUM,Ue.qpSumPerFrame),he)return Re;switch(Ie&&(ln(Re,Kr.HEIGHT,Ie.height),ln(Re,Kr.WIDTH,Ie.width),ln(Re,Kr.FRAME_RATE,Ie.frameRate)),Re[Kr.DISABLED]=de._originMediaStreamTrack&&!de._originMediaStreamTrack.enabled||de._mediaStreamTrack&&!de._mediaStreamTrack.enabled?1:0,Ue.adaptionChangeReason){case"none":Re[Kr.ADAPTATION]=0;break;case"cpu":Re[Kr.ADAPTATION]=1;break;case"bandwidth":Re[Kr.ADAPTATION]=2;break;case"other":Re[Kr.ADAPTATION]=3}Re[Kr.PLAYER_STATUS]=EC[de._player?de._player.videoElementStatus:"uninit"],ln(Re,Kr.NACKS,Ue.nacksCount),ln(Re,Kr.PLIS,Ue.plisCount),ln(Re,Kr.FIRS,Ue.firsCount),ln(Re,Kr.AVG_ENCODE,Ue.avgEncodeMs);let Ne=te&&te.videoSend.find(Xe=>Xe.ssrc===K);if(Ne){let Xe=he?Du:Du*pm;Ne.timestamp&&Ue.timestamp&&(Xe=Ue.timestamp-Ne.timestamp),Ne.packets!=null&&Ue.packets!=null&&ln(Re,Kr.PACKAGE_RATE,1e3*(Ue.packets-Ne.packets)/Xe),Ue.packetsLost!=null&&Ne.packetsLost!=null&&ln(Re,Kr.PACKAGE_LOST,Ue.packetsLost-Ne.packetsLost),Ne.bytes!=null&&Ue.bytes!=null&&ln(Re,Kr.BITRATE,8*(Ue.bytes-Ne.bytes)/Xe)}return Re}(b[0].ssrcId,t,i,I,a),U=a?null:function(K,q,te){let de=q.videoSend.find(Ne=>Ne.ssrc===K);if(!de)return null;let he={},Ue=de.inputFrame,Re=Ue&&Ue.height||te&&te._videoHeight||0,Ie=Ue&&Ue.width||te&&te._videoWidth||0,De=Ue&&Ue.frameRate||0;return ln(he,rS.HEIGHT,Re),ln(he,rS.WIDTH,Ie),ln(he,rS.FRAME_RATE,De),he}(b[0].ssrcId,t,I),J=a?null:function(K){let q={};return ln(q,Kr.RETRANSMIT,K.bitrate.retransmit),ln(q,Kr.TARGET_ENCODED,K.bitrate.targetEncoded),ln(q,Kr.ACTUAL_ENCODED,K.bitrate.actualEncoded),ln(q,Kr.TRANSMIT,K.bitrate.transmit),ln(q,Kr.BANDWIDTH,K.sendBandwidth),q}(t);f=Object.assign({},k,U,J)}else g=a?void 0:function(k,U,J){let K=U.videoSend.find(de=>de.ssrc===k);if(!K)return;let q={},te=K.sentFrame;if(te&&(ln(q,Ph.HEIGHT,te.height),ln(q,Ph.WIDTH,te.width),ln(q,Ph.FRAME_RATE,te.frameRate)),J){let de=J.videoSend.find(he=>he.ssrc===k);if(de){let he=Du*pm;de.timestamp&&K.timestamp&&(he=K.timestamp-de.timestamp),de.packets!=null&&K.packets!=null&&ln(q,Ph.PACKAGE_RATE,1e3*(K.packets-de.packets)/he),K.packetsLost!=null&&de.packetsLost!=null&&ln(q,Ph.PACKAGE_LOST,K.packetsLost-de.packetsLost),de.bytes!=null&&K.bytes!=null&&ln(q,Ph.BITRATE,8*(K.bytes-de.bytes)/he)}}return q}(b[0].ssrcId,t,i);break;case Ke.LocalAudioTrack:p=a?void 0:function(k,U,J,K){let q=U.audioSend.find(Re=>Re.ssrc===k);if(!q)return;let te={};te[Nu.DISABLED]=K._originMediaStreamTrack&&!K._originMediaStreamTrack.enabled||K._mediaStreamTrack&&!K._mediaStreamTrack.enabled?1:0;let de=K._source.getAccurateVolumeLevel(),he=q.inputLevel;ln(te,Nu.LEVEL,100*(he??de)),ln(te,Xb.PCM_LEVEL,100*de),ln(te,Nu.AEC_RETURN_LOSS,q.aecReturnLoss),ln(te,Nu.AEC_RETURN_LOSS_ENH,q.aecReturnLossEnhancement),te[Nu.FREEZE]=0;let Ue=J&&J.audioSend.find(Re=>Re.ssrc===k);if(Ue){let Re=Du*pm;Ue.timestamp&&q.timestamp&&(Re=q.timestamp-Ue.timestamp),Ue.bytes!=null&&q.bytes!=null&&ln(te,Nu.BITRATE,8*(q.bytes-Ue.bytes)/Re),Ue.packets!=null&&q.packets!=null&&ln(te,Nu.PACKAGE_RATE,1e3*(q.packets-Ue.packets)/Re)}return te}(b[0].ssrcId,t,i,I)}}),{high:f,low:g,audio:p}}getInboundStats(t,i,a){if(!this.requestRemoteMedia)return;let l=this.requestRemoteMedia()||[],p=[];return l.forEach(f=>{let[g,v]=f,y={peer:g.uid};if(v.has(We.VIDEO)&&g.videoTrack){let I=g._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(g._videoSSRC)||!1,b=g.videoTrack?function(k,U,J,K,q,te,de){let he=U.videoRecv.find(Xe=>Xe.ssrc===k);if(!he)return;let Ue={},{receivedFrame:Re,outputFrame:Ie,decodeFrameRate:De}=he,Ne=J&&J.videoRecv.find(Xe=>Xe.ssrc===k);if(Ue[Ls.FREEZE]=q&&nd.isRemoteVideoFreeze(K,he,Ne)?1:0,ln(Ue,Vf.FRAME_RATE_DECODE,De),ln(Ue,Ls.QP_SUM,he.qpSumPerFrame),he.framesRateFirefox&&ln(Ue,Ls.FRAME_RATE,he.framesRateFirefox),Re&&ln(Ue,Ls.FRAME_RATE,Re.frameRate),Ne){let Xe=U.timestamp-J.timestamp||(de?Du:pm*Du);he.packetsLost!=null&&Ne.packetsLost!=null&&ln(Ue,Ls.PACKAGE_LOST,he.packetsLost-Ne.packetsLost),Ne.bytes!=null&&he.bytes!=null&&ln(Ue,Ls.BITRATE,8*(he.bytes-Ne.bytes)/Xe),Ne.packets!=null&&he.packets!=null&&ln(Ue,Ls.PACKAGE_RATE,1e3*(he.packets-Ne.packets)/Xe)}if(de)return Ue;if(Re?(ln(Ue,Ls.HEIGHT,Re.height),ln(Ue,Ls.WIDTH,Re.width)):K&&(ln(Ue,Ls.HEIGHT,K._videoHeight||0),ln(Ue,Ls.WIDTH,K._videoWidth||0)),Ie&&ln(Ue,Vf.FRAME_RATE_RENDER,Ie.frameRate),ln(Ue,Ls.JITTER_BUFFER,he.jitterBufferMs),ln(Ue,Ls.CURRENT_DELAY,he.currentDelayMs),ln(Ue,Ls.FIRS,he.firsCount),ln(Ue,Ls.NACKS,he.nacksCount),ln(Ue,Ls.PLIS,he.plisCount),K){Ue[Ls.DISABLED]=K._originMediaStreamTrack.enabled&&K._mediaStreamTrack.enabled?0:1;let Xe=K._player;if(Xe){let{freezeTimeCounterList:nt,renderFreezeAccTime:Vt}=Xe;if(nt&&nt.length>0&&ln(Ue,Vf.FREEZE_TIME,nt.splice(0,1)[0]),te&&fl.visibility==="visible"){let rn=Math.min(6e3,Vt);Xe.renderFreezeAccTime=Math.max(0,Vt-rn),ln(Ue,Vf.FREEZE_TIME_RENDER,rn)}}}if(Ue[Ls.PLAYER_STATUS]=EC[K._player?K._player.videoElementStatus:"uninit"],Ne&&he.totalInterFrameDelay!==void 0&&he.totalSquaredInterFrameDelay!==void 0&&Ne.totalInterFrameDelay!==void 0&&Ne.totalSquaredInterFrameDelay!==void 0){let Xe=he.totalInterFrameDelay-Ne.totalInterFrameDelay,nt=he.totalSquaredInterFrameDelay-Ne.totalSquaredInterFrameDelay,Vt=he.framesDecodeCount-Ne.framesDecodeCount,rn=Xe/Vt*1e3,ui=Math.round(1e3*Math.sqrt((nt-Math.pow(Xe,2)/Vt)/Vt));!isNaN(ui)&&rn+ui>Math.max(3*rn,rn+150)&&(Ue[Ls.I_FRAME_DELAY]=ui)}return Ue}(g._videoSSRC,t,i,g.videoTrack,I===!0,this.needUploadRenderFreezeTime,a):void 0;b&&(y.video=b)}if(v.has(We.AUDIO)&&g.audioTrack){let I=g.audioTrack?function(b,k,U,J,K){let q=k.audioRecv.find(Xe=>Xe.ssrc===b);if(!q)return;let te={},de=U&&U.audioRecv.find(Xe=>Xe.ssrc===b),{receivedFrames:he,droppedFrames:Ue}=q;var Re,Ie;if(ln(te,Sc.JITTER,q.jitterMs),he!=null&&Ue!=null&&(te[Sc.FREEZE]=(Ie=Ue,(Re=he)===0||100*Ie/Re>20?1:0)),de){let Xe=k.timestamp-U.timestamp||(K?Du:Du*pm);q.packets!=null&&de.packets!=null&&ln(te,Sc.PACKAGE_RATE,1e3*(q.packets-de.packets)/Xe),de.bytes!=null&&q.bytes!=null&&ln(te,Sc.BITRATE,8*(q.bytes-de.bytes)/Xe),q.packetsLost!=null&&de.packetsLost!=null&&ln(te,Sc.PACKAGE_LOST,q.packetsLost-de.packetsLost)}if(K)return te;let De=J._source.getAccurateVolumeLevel(),Ne=q.outputLevel;if(ln(te,Qb.LEVEL,100*(Ne??De)),ln(te,Sc.PCM_LEVEL,100*De),J&&(te[Sc.DISABLED]=J._originMediaStreamTrack.enabled&&J._mediaStreamTrack.enabled?0:1),ln(te,Sc.JITTER_BUFFER,q.jitterBufferMs),ln(te,Sc.CURRENT_DELAY,q.jitterBufferMs),te[Sc.PLAYER_STATUS]=EC[Po.getPlayerState(J.getTrackId())],de){let Xe=q.concealedSamples-de.concealedSamples;Xe>0&&ln(te,Sc.CONCEALED_SAMPLES,Xe)}return te}(g._audioSSRC,t,i,g.audioTrack,a):void 0;I&&(y.audio=I)}(y.video||y.audio)&&p.push(y)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,p}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;let t=(this.requestAllTracks()||[]).find(i=>i instanceof pu);if(t&&t._external.getDenoiserStats){let i=t._external.getDenoiserStats();i&&this.requestUpload(Li.DENOISER_STATS,i)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[i,a]=t;a.has(We.VIDEO)&&i.videoTrack&&i.videoTrack.getProcessorStats().forEach(l=>{this.requestUpload&&this.requestUpload(l.type,l.stats)}),a.has(We.AUDIO)&&i.audioTrack&&i.audioTrack.getProcessorStats().forEach(l=>{this.requestUpload&&this.requestUpload(l.type,l.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);let t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{let i=Date.now(),a={connectionInterval:ce("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:i},l=[],p=this.requestAllTracks&&this.requestAllTracks()||[];for(let y of p)!y.muted&&y.enabled&&(l=l.concat(await y.getProcessorUsage()));let f=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(let[y,I]of f)I.has(We.VIDEO)&&y.videoTrack&&(l=l.concat(await y.videoTrack.getProcessorUsage())),I.has(We.AUDIO)&&y.audioTrack&&(l=l.concat(await y.audioTrack.getProcessorUsage()));if(l.length===0)return;a.details=function(y,I){let b={};for(let{id:K,value:q,level:te,direction:de}of y){var k;let he=(k=I.get(K))!==null&&k!==void 0?k:0,Ue=q===2?he+ce("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:he;var U,J;I.set(K,Ue),b[K]?(q===2&&(b[K].value=q),te>b[K].level&&(b[K].level=te),de==="remote"&&(b[K].remoteUidCount+=1),b[K].totalTs=(U=I.get(K))!==null&&U!==void 0?U:0):b[K]={value:q,level:te,remoteUidCount:de==="local"?0:1,totalTs:(J=I.get(K))!==null&&J!==void 0?J:0}}return Object.keys(b).map(K=>{let{level:q,value:te,totalTs:de}=b[K];return{id:K,level:q,value:te,totalTs:de}})}(l,t);let g=Date.now(),v=g>i?g:i+1;this.requestUpload&&this.requestUpload(Li.EXTENSION_USAGE_STATS,{usageStats:a,sendTs:v})},ce("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class ms{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,i){P(this,"uid",void 0),P(this,"_uintid",void 0),P(this,"_trust_in_room_",!0),P(this,"_trust_audio_enabled_state_",!0),P(this,"_trust_video_enabled_state_",!0),P(this,"_trust_audio_mute_state_",!0),P(this,"_trust_video_mute_state_",!0),P(this,"_audio_muted_",!1),P(this,"_video_muted_",!1),P(this,"_audio_enabled_",!0),P(this,"_video_enabled_",!0),P(this,"_audio_added_",!1),P(this,"_video_added_",!1),P(this,"_is_pre_created",!1),P(this,"_video_pre_subscribed",!1),P(this,"_audio_pre_subscribed",!1),P(this,"_trust_video_stream_added_state_",!0),P(this,"_trust_audio_stream_added_state_",!0),P(this,"_audioTrack",void 0),P(this,"_videoTrack",void 0),P(this,"_dataChannels",[]),P(this,"_audioSSRC",void 0),P(this,"_videoSSRC",void 0),P(this,"_audioOrtc",void 0),P(this,"_videoOrtc",void 0),P(this,"_cname",void 0),P(this,"_rtxSsrcId",void 0),P(this,"_videoMid",void 0),P(this,"_audioMid",void 0),this.uid=t,this._uintid=i}}var Ga;function vk(s,t){var i;let a;switch(t){case Ke.LocalAudioTrack:a=At.Audio;break;case Ke.LocalVideoTrack:a=xe(i=s._hints).call(i,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalVideoLowTrack:a=At.Low}return a}function Zb(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function XC(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Zb(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Zb(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}(function(s){s.SEND_ONLY="SEND_ONLY",s.RECEIVE_ONLY="RECEIVE_ONLY"})(Ga||(Ga={}));class nr extends ri{get state(){return this._state}set state(t){let i=this._state;this._state=t,this.emit(wt.StateChange,i,this._state)}constructor(t,i){super(),P(this,"store",void 0),P(this,"statsUploader",void 0),P(this,"sendConnection",void 0),P(this,"recvConnection",void 0),P(this,"localTrackMap",new Map),P(this,"remoteUserMap",new Map),P(this,"localDataChannels",[]),P(this,"pendingLocalTracks",[]),P(this,"pendingRemoteTracks",[]),P(this,"statsCollector",void 0),P(this,"dtlsFailedCount",0),P(this,"sendMutex",new sn("P2PChannel2-send-mutex")),P(this,"recvMutex",new sn("P2PChannel2-recv-mutex")),P(this,"_state",Yt.Disconnected),P(this,"_restartStates",["disconnected","failed"]),P(this,"reconnectInterval",void 0),P(this,"uploadUnplinkStarted",!1),P(this,"uploadDownlinkStarted",!1),P(this,"uplinkStateUploadInterval",void 0),P(this,"downlinkStatsUploadInterval",void 0),P(this,"handleMuteLocalTrack",async(a,l,p)=>{let f=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Yt.Connected)return void p(new Ve(Z.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let y=this.filterTobeMutedTracks(a);if(y.length===0)return void l();let I=y.find(J=>J[0]==="videoLowTrack");I&&I[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(y.map(J=>{let[,{id:K}]=J;return K}));let b=!1;var g,v;a.trackMediaType==="video"?b=!((g=this.localTrackMap.get(Ke.LocalAudioTrack))===null||g===void 0||!g.track._muted):b=((v=this.localTrackMap.get(Ke.LocalVideoTrack))===null||v===void 0?void 0:v.id)===void 0;let k=this.createMuteMessage(y);await fn(this,wt.RequestMuteLocal,k);let U=a.trackMediaType==="video"?ul.MUTE_LOCAL_VIDEO:ul.MUTE_LOCAL_AUDIO;await fn(this,wt.RequestP2PMuteLocal,{action:U,message:k,isMuteAll:b}),l()}catch(y){p(y)}finally{f()}}),P(this,"handleUnmuteLocalTrack",async(a,l,p)=>{let f=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Yt.Connected)return void p(new Ve(Z.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let g=this.filterTobeUnmutedTracks(a);if(g.length===0)return void l();await this.sendConnection.unmuteLocal(g.map(I=>{let[,{id:b}]=I;return b}));let v=this.createUnmuteMessage(g),y=a.trackMediaType==="video"?ul.UNMUTE_LOCAL_VIDEO:ul.UNMUTE_LOCAL_AUDIO;await fn(this,wt.RequestP2PMuteLocal,{action:y,message:v}),l()}catch(g){p(g)}finally{f()}}),P(this,"handleUpdateVideoEncoder",async(a,l,p)=>{let f=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{let g=this.localTrackMap.get(Ke.LocalVideoTrack);if(!this.sendConnection||!g||g.track!==a||this.state!==Yt.Connected)return void l();let{id:v,track:y}=g;v&&(await this.sendConnection.updateSendParameters(v,y),await this.sendConnection.updateEncoderConfig(v,y),this.emit(wt.UpdateVideoEncoder,y)),l()}catch(g){p(g)}finally{f()}}),P(this,"handleSetOptimizationMode",async(a,l,p)=>{let f=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{let g=this.localTrackMap.get(Ke.LocalVideoTrack);if(!this.sendConnection||!g||g.track!==a||this.state!==Yt.Connected)return;let{id:v,track:y}=g;v&&await this.sendConnection.updateSendParameters(v,y),l()}catch(g){p(g)}finally{f()}}),P(this,"handleReplaceTrack",async(a,l,p,f)=>{let g;x.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(a.getTrackId(),"]")),typeof f=="boolean"&&f||(g=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var v;let I=Array.from(this.localTrackMap.entries()).find(b=>{let[,{track:k}]=b;return a===k});if(!this.sendConnection||!I||I[1].id===void 0||this.state!==Yt.Connected)return void l();if(await((v=this.sendConnection)===null||v===void 0?void 0:v.replaceTrack(a,I[1].id)),I[0]===Ke.LocalVideoTrack&&zn().supportDualStreamEncoding){let b=this.localTrackMap.get(Ke.LocalVideoLowTrack);if(b){let k=a._mediaStreamTrack.clone();b.track._originMediaStreamTrack.stop(),b.track._mediaStreamTrack=k,b.track._originMediaStreamTrack=k,await new Pe((U,J)=>{this.handleReplaceTrack(b.track,U,J,!0)})}}l()}catch(I){p(I)}finally{var y;(y=g)===null||y===void 0||y()}}),P(this,"handleGetLocalVideoStats",a=>{a(this.statsCollector.getLocalVideoTrackStats())}),P(this,"handleGetLocalAudioStats",a=>{a(this.statsCollector.getLocalAudioTrackStats())}),P(this,"handleGetRemoteVideoStats",a=>this.statsCollector.getRemoteVideoTrackStats(a.uid)[a.uid]),P(this,"handleGetRemoteAudioStats",a=>this.statsCollector.getRemoteAudioTrackStats(a.uid)[a.uid]),this.store=t,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new JC(t),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(a=>{a&&(a.iceConnectionState!=="disconnected"&&a.iceConnectionState!=="failed"||this.handleDisconnect(a.direction))})},ce("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,i){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t,i,a,l,p,f){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,i){let a;try{if(i){this.recvConnection&&(x.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),a=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new oo(t,this.store,Ks.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);let l=await this.recvConnection.establish(i);return{iceParameters:l.iceParameters,dtlsParameters:l.dtlsParameters,sdp:l.sdp}}{this.state=Yt.New,this.sendConnection&&(x.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),a=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new oo(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);let l=await this.sendConnection.establish();return{iceParameters:l.iceParameters,dtlsParameters:l.dtlsParameters,sdp:l.sdp}}}finally{a&&a()}}async p2pConnect(t){if(!this.sendConnection)throw new Ve(Z.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Yt.Connected}async addRemoteCandidate(t,i){if(i===Ks.RECEIVE_ONLY){if(!this.sendConnection)throw new Ve(Z.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new Ve(Z.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,i,a){var l=this;return Ca(function*(){let p=yield nn(l.sendMutex.lock("From P2PChannel.publish"));try{if(!l.sendConnection||l.state!==Yt.Connected){l.throwIfTrackTypeNotMatch(t);let I=t.filter(b=>l.pendingLocalTracks.indexOf(b)===-1);return void(l.pendingLocalTracks=l.pendingLocalTracks.concat(I))}l.store.pubId=l.store.pubId+1,Is.markPublishStart(l.store.clientId,l.store.pubId);let f=l.filterTobePublishedTracks(t,i,a);if(f.length===0)return void(yield nn(l.tryToUnmuteAudio(t)));f.forEach(I=>{let{track:b,type:k}=I,U=Date.now();l.store.publish(b.getTrackId(),k===Ke.LocalAudioTrack?"audio":"video",U)}),l.bindLocalTrackEvents(f);let g=yield nn(l.sendConnection.send(f.map(I=>{let{track:b}=I;return b}),l.store.codec,l.store.audioCodec)),v=(yield nn(g.next())).value,y=l.createGatewayPublishMessage(f,v);try{yield y}catch(I){throw g.throw(I),(I==null?void 0:I.code)===Z.WS_ABORT&&f.forEach(b=>{let{track:k}=b;l.pendingLocalTracks.indexOf(k)===-1&&l.pendingLocalTracks.push(k)}),l.unbindLocalTrackEvents(f),I}yield nn(g.next()),f.forEach(I=>{let{type:b}=I;l.statsCollector.addLocalStats(b)}),l.statsUploader.startUploadOutboundStats(),l.assignLocalTracks(f,v),f.forEach(I=>{let{track:b,type:k}=I,U=Date.now();l.store.publish(b.getTrackId(),k===Ke.LocalAudioTrack?"audio":"video",void 0,U)}),l.startUploadUplinkState()}finally{p()}})()}async unpublish(t){if(!this.sendConnection||this.state!==Yt.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(p=>!xe(t).call(t,p)));let i=this.filterTobeUnpublishedTracks(t);if(i.length===0)return;let a=i.find(p=>p[0]==="videoLowTrack");a&&a[1].track.close();let l=this.createGatewayUnpublishMessage(i);if(await this.sendConnection.stopSending(i.map(p=>{let[,{id:f}]=p;return f})),this.withdrawLocalTracks(i),this.unbindLocalTrackEvents(i.map(p=>{let[f,{track:g}]=p;return{type:f,track:g}})),i.forEach(p=>{let[f]=p;this.statsCollector.removeLocalStats(f)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Yt.Connected)return a&&a[1].track.close(),l;t.forEach(p=>{let f=this.pendingLocalTracks.indexOf(p);f!==-1&&this.pendingLocalTracks.splice(f,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);let t=()=>{let i=[],a=[];Array.from(this.localTrackMap.entries()).forEach(l=>{let[p,{track:f,ssrcs:g}]=l,v={stream_type:vk(f,p),ssrcs:g};f._muted||!f._enabled?i.push(v):a.push(v)}),i.length>0&&i.forEach(l=>{fn(this,wt.RequestMuteLocal,[l])}),a.length>0&&a.forEach(l=>{fn(this,wt.RequestUnmuteLocal,[l])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return Ca(function*(){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(x.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await In(this,wt.RequestRePublish,this.pendingLocalTracks),this.emit(wt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,i,a,l){var p;if(!this.recvConnection)throw new Ve(Z.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((p=this.remoteUserMap.get(t))!==null&&p!==void 0&&p.has(i))return;let{track:f,mid:g,transceiver:v}=await this.recvConnection.receive(i,[{ssrcId:a}],String(t.uid),l);i===We.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(f):(t._audioTrack=new Jc(f,t.uid,t._uintid,this.store),x.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),v&&t._audioTrack._updateRtpTransceiver(v),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=a,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(f):(t._videoTrack=new fc(f,t.uid,t._uintid,this.store),x.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),v&&t._videoTrack._updateRtpTransceiver(v),this.bindRemoteTrackEvents(t,t._videoTrack));let y=this.remoteUserMap.get(t);y?y.set(i,g):this.remoteUserMap.set(t,new Map([[i,g]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();let I=this.pendingRemoteTracks.findIndex(b=>{let{user:k,kind:U}=b;return k.uid===t.uid&&i===U});I!==-1&&(this.pendingRemoteTracks.splice(I,1),this.emit(wt.MediaReconnectEnd,t.uid))}async mockSubscribe(t,i,a,l){if(!this.recvConnection)throw new Ve(Z.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(i,[{ssrcId:a}],String(t.uid),l)}async unsubscribe(t,i,a){let l=this.pendingRemoteTracks.filter(f=>{let{user:g,kind:v}=f;return i!==void 0?g.uid===t.uid&&i===v:g.uid===t.uid});if(l.forEach(f=>{let g=this.pendingRemoteTracks.indexOf(f);this.pendingRemoteTracks.splice(g,1)}),this.recvConnection||a||l.forEach(f=>{let{kind:g}=f;var v;if(g===We.AUDIO)(v=t._audioTrack)===null||v===void 0||v._destroy(),t._audioTrack=void 0;else if(g===We.VIDEO){var y;(y=t._videoTrack)===null||y===void 0||y._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;let p=this.filterTobeUnSubscribedTracks(t,i);p.length!==0&&(await this.recvConnection.stopReceiving(p.map(f=>{let[,{id:g}]=f;return g})),this.withdrawRemoteTracks(p),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),p.forEach(f=>{let[g,{kind:v}]=f;var y,I;if(v===We.VIDEO&&g._videoSSRC&&((y=this.recvConnection)===null||y===void 0||y.setStatsRemoteVideoIsReady(g._videoSSRC,!1)),v===We.VIDEO)this.unbindRemoteTrackEvents(g._videoTrack),a||((I=g._videoTrack)===null||I===void 0||I._destroy(),g._videoTrack=void 0);else if(v===We.AUDIO){var b;this.unbindRemoteTrackEvents(g._audioTrack),!a&&((b=g._audioTrack)===null||b===void 0||b._destroy(),g._audioTrack=void 0)}}),p.forEach(f=>{let[,{kind:g}]=f;fn(this,wt.RequestP2PMuteRemote,g)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=()=>Array.from(this.remoteUserMap.entries()).forEach(i=>{let[,a]=i;[We.VIDEO,We.AUDIO].forEach(l=>{a.has(l)?fn(this,wt.RequestP2PUnmuteRemote,l):fn(this,wt.RequestP2PMuteRemote,l)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new Ve(Z.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,i){if(!this.recvConnection)return;let a=this.remoteUserMap.get(t);if(!a)return void x.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!a.get(i))return void x.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(i,"."));let l=i===We.VIDEO?t._videoSSRC:t._audioSSRC;l!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(l,!1)}async unmuteRemote(t,i){return this.unmuteRemoteNoLock(t,i)}async unmuteRemoteNoLock(t,i){if(!this.recvConnection)return;let a=this.remoteUserMap.get(t);if(!a)return void x.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));a.get(i)||x.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(i,"."))}getAllTracks(t){let i=this.localTrackMap.get(Ke.LocalAudioTrack);if((i==null?void 0:i.track)instanceof lr){let a=i.track;return Array.from(this.localTrackMap.entries()).filter(l=>{let[p]=l;return p!==Ke.LocalAudioTrack}).filter(l=>{let[p]=l;return!(t&&p===Ke.LocalVideoLowTrack)}).map(l=>{let[,{track:p}]=l;return p}).concat(a.trackList)}return Array.from(this.localTrackMap.entries()).filter(a=>{let[l]=a;return!(t&&l===Ke.LocalVideoLowTrack)}).map(a=>{let[,{track:l}]=a;return l})}reportPublishEvent(t,i,a,l,p){if(t){let g=this.localTrackMap.get(Ke.LocalAudioTrack),v=l?this.localTrackMap.get(Ke.LocalVideoLowTrack):this.localTrackMap.get(Ke.LocalVideoTrack);Tt.publish(this.store.sessionId,{eventElapse:Is.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:i,audioName:g==null?void 0:g.track.getTrackLabel(),videoName:v==null?void 0:v.track.getTrackLabel(),screenshare:(v==null?void 0:v.track._hints.indexOf(Un.SCREEN_TRACK))!==-1,audio:!!g,video:!!v,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:p})}else{var f;a||(a=[]);let g=a.find(y=>y instanceof Vn),v=l?(f=this.localTrackMap.get(Ke.LocalVideoTrack))===null||f===void 0?void 0:f.track:a.find(y=>y instanceof jt);Tt.publish(this.store.sessionId,{eventElapse:Is.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:i,audioName:g==null?void 0:g.getTrackLabel(),videoName:v==null?void 0:v.getTrackLabel(),screenshare:(v==null?void 0:v._hints.indexOf(Un.SCREEN_TRACK))!==-1,audio:!!g,video:!!v,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:p})}}reportSubscribeEvent(t,i,a,l){let p=l===We.VIDEO?a._videoSSRC:a._audioSSRC;p&&Tt.subscribe(this.store.sessionId,{succ:t,ec:i,video:l===We.VIDEO,audio:l===We.AUDIO,peerid:a.uid,subscribeRequestid:l===We.VIDEO?a._videoSSRC:a._audioSSRC,p2pid:this.store.p2pId,eventElapse:Is.measureFromSubscribeStart(this.store.clientId,p)})}reset(){x.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new sn("P2PChannel2-send-mutex"),this.sendMutex=new sn("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(Ke.LocalAudioTrack);if((t==null?void 0:t.track)instanceof lr){if(t.track.trackList.length>0){let i=t.track;t.track.trackList.forEach(a=>{i.removeAudioTrack(a)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Yt.Disconnected}getStats(t){var i,a;return t?(a=this.recvConnection)===null||a===void 0?void 0:a.getStats():(i=this.sendConnection)===null||i===void 0?void 0:i.getStats()}getRemoteVideoIsReady(t){var i;return((i=this.recvConnection)===null||i===void 0?void 0:i.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(Ke.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(Ke.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){let i=this.localTrackMap.get(t);return i&&i.track instanceof jt||i&&i.track instanceof Vn?i.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,i){if(!t)return this.remoteUserMap.size>0;let a=this.remoteUserMap.get(t);return!!a&&(!i||a.has(i))}async hasRemoteMediaWithLock(t,i){if(!t)return this.remoteUserMap.size>0;let a=this.remoteUserMap.get(t);return!!a&&(!i||a.has(i))}getRemoteMedia(t){var i;let a=Array.from(Ho(i=this.remoteUserMap).call(i)).find(l=>l.uid===t);return a?{audioTrack:a.audioTrack,audioSSRC:a._audioSSRC,videoTrack:a.videoTrack,videoSSRC:a._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(a=>{let[l]=a;return{uid:l.uid,level:l.audioTrack?100*l.audioTrack._source.getAccurateVolumeLevel():0}}),i=this.localTrackMap.get(Ke.LocalAudioTrack);return i&&t.push({level:100*i.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=kE(t).call(t,(a,l)=>a.level-l.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(x.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Yt.Reconnecting,ce("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i]=t;var a;i._videoTrack&&i._videoTrack._player&&((a=i._videoTrack._player.getVideoElement())===null||a===void 0||a.pause(),i._videoTrack._player.isKeepLastFrame=!0,i._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var i;let[a,{track:l}]=t;switch(a){case Ke.LocalVideoTrack:xe(i=l._hints).call(i,Un.LOW_STREAM)?l.close():this.pendingLocalTracks.push(l);break;case Ke.LocalAudioTrack:l instanceof lr?this.pendingLocalTracks=this.pendingLocalTracks.concat(l.trackList):this.pendingLocalTracks.push(l);case Ke.LocalVideoLowTrack:}}),this.emit(wt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i,a]=t;Array.from(Ho(a).call(a)).forEach(l=>{this.setPendingRemoteMedia(i,l)}),this.emit(wt.MediaReconnectStart,i.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),x.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,i){for(let a of this.pendingRemoteTracks){let{user:l,kind:p}=a;if((t instanceof ms?t.uid:t)===l.uid&&i===p)return!0}return!1}setPendingRemoteMedia(t,i){this.hasPendingRemoteMedia(t,i)||this.pendingRemoteTracks.push({user:t,kind:i})}async restartICE(t,i){let a,l;if(t===Ks.SEND_ONLY){if(!this.sendConnection)throw new Ve(Z.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");a=await this.sendMutex.lock("From P2PChannel.restartICE"),l=this.sendConnection}else{if(!this.recvConnection)throw new Ve(Z.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");a=await this.recvMutex.lock("From P2PChannel.restartICE"),l=this.recvConnection}try{if(i){let p=await l.restartICE(i);return l.isInRestartIce=!1,p}{let p=await l.restartICE();if(p){let f=await In(this,wt.RequestP2PRestartICE,{direction:Ks.RECEIVE_ONLY,iceParameter:p});await l.restartICE(f),l.isInRestartIce=!1}}}finally{a()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let t=this.sendConnection.getStats(),i=this.localTrackMap.get(Ke.LocalVideoTrack),a=this.localTrackMap.get(Ke.LocalAudioTrack),l=t.videoSend.find(J=>{var K;return J.ssrc===(i==null||(K=i.ssrcs)===null||K===void 0?void 0:K[0].ssrcId)}),p=t.audioSend.find(J=>{var K;return J.ssrc===(a==null||(K=a.ssrcs)===null||K===void 0?void 0:K[0].ssrcId)});if(!l||!p)return 1;let f=us(this,wt.NeedSignalRTT),g=l?l.rttMs:void 0,v=p?p.rttMs:void 0,y=g&&v?(g+v)/2:g||v,I=(y&&f?(y+f)/2:y||f)||0,b=100*t.sendPacketLossRate*.7/50+.3*I/1500,k=b<.17?1:b<.36?2:b<.59?3:b<.1?4:5,U=i==null?void 0:i.track;if(U&&U._encoderConfig&&U._hints.indexOf(Un.SCREEN_TRACK)===-1){let J=U._encoderConfig.bitrateMax,K=t.bitrate.actualEncoded;if(J&&K){let q=(1e3*J-K)/(1e3*J);return kp[q<.15?0:q<.3?1:q<.45?2:q<.6?3:4][k]}}return k}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let t=this.recvConnection.getStats(),i=0;return Array.from(this.remoteUserMap.entries()).forEach(a=>{let[l]=a,p=l._audioSSRC,f=l._videoSSRC,g=t.audioRecv.find(K=>K.ssrc===p),v=t.videoRecv.find(K=>K.ssrc===f);if(!g&&!v)return void(i+=1);let y=us(this,wt.NeedSignalRTT),I=t.rtt,b=(I&&y?(I+y)/2:I||y)||0,k=g?g.jitterMs:void 0,U=t.recvPacketLossRate,J=.7*U*100/50+.3*b/1500;k&&(J=.6*U*100/50+.2*b/1500+.2*k/400),i+=J<.1?1:J<.17?2:J<.36?3:J<.59?4:5}),this.remoteUserMap.size>0?Math.round(i/this.remoteUserMap.size):i}async muteLocalTrack(t){return new Pe((i,a)=>{this.handleMuteLocalTrack(t,i,a)})}filterTobePublishedTracks(t,i,a){let l=[],p=zn(),f=this.getAllTracks();t=Mn(t=t.filter(y=>f.indexOf(y)===-1));let g=!1,v=!1;for(let y of t){if(y instanceof jt&&(this.localTrackMap.has(Ke.LocalVideoTrack)||g?new Ve(Z.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(l.push({track:y,type:Ke.LocalVideoTrack}),g=!0),i)){let I=this.getLowVideoTrack(y,a);l.push({track:I,type:Ke.LocalVideoLowTrack})}if(y instanceof Vn){let I=this.localTrackMap.get(Ke.LocalAudioTrack);if(I){if(!(I.track instanceof lr))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(y._bypassWebAudio)throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");I.track.addAudioTrack(y),this.bindLocalAudioTrackEvents(y,!0)}else if(v){let b=l.find(k=>{let{type:U}=k;return U===Ke.LocalAudioTrack});if(!(b.track instanceof lr))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(y._bypassWebAudio)throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");b.track.addAudioTrack(y)}else{if(!p.webAudioMediaStreamDest||y instanceof lr||y._bypassWebAudio)l.push({track:y,type:Ke.LocalAudioTrack});else{let b=new lr;b.addAudioTrack(y),l.push({track:b,type:Ke.LocalAudioTrack})}v=!0}}}return l}filterTobeUnpublishedTracks(t){let i=[],a=this.getAllTracks();t=Mn(t=t.filter(l=>a.indexOf(l)!==-1));for(let l of t){if(l instanceof Vn){let p=this.localTrackMap.get(Ke.LocalAudioTrack);if(!p)continue;p.track instanceof lr?(p.track.removeAudioTrack(l),this.unbindLocalAudioTrackEvents(l),p.track.trackList.length===0&&(i.push([Ke.LocalAudioTrack,p]),p.track.close())):i.push([Ke.LocalAudioTrack,p])}if(l instanceof jt){let p=this.localTrackMap.get(Ke.LocalVideoTrack);if(!p)continue;i.push([Ke.LocalVideoTrack,p]);let f=this.localTrackMap.get(Ke.LocalVideoLowTrack);f&&i.push([Ke.LocalVideoLowTrack,f])}}return i}bindLocalTrackEvents(t){t.forEach(i=>{let{track:a,type:l}=i;switch(l){case Ke.LocalVideoTrack:a.addListener(ut.GET_STATS,this.handleGetLocalVideoStats),a.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),a.addListener(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),a.addListener(ut.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),a.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),a.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Ke.LocalAudioTrack:this.bindLocalAudioTrackEvents(a);case Ke.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,i){t instanceof lr?t.trackList.forEach(a=>{a.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),a.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),a.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),t.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),i||t.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(i=>{let[a,{track:l}]=i;return{track:l,type:a}})),t.forEach(i=>{let{track:a,type:l}=i;switch(l){case Ke.LocalVideoTrack:a.off(ut.GET_STATS,this.handleGetLocalVideoStats),a.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),a.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),a.off(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),a.off(ut.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),a.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),a.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),a.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Ke.LocalAudioTrack:this.unbindLocalAudioTrackEvents(a);case Ke.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof lr?t.trackList.forEach(i=>{i.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(ut.GET_STATS,this.handleGetLocalAudioStats),i.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(ut.GET_STATS,this.handleGetLocalAudioStats),t.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,i){i instanceof fc&&i.addListener(ut.GET_STATS,a=>{a(this.handleGetRemoteVideoStats(t))}),i instanceof Jc&&i.addListener(ut.GET_STATS,a=>{a(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(ut.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i,a]=t;a.has(We.AUDIO)&&this.unbindRemoteTrackEvents(i._audioTrack),a.has(We.VIDEO)&&this.unbindRemoteTrackEvents(i._videoTrack)})}createGatewayPublishMessage(t,i){return t.map((a,l)=>{var p;let f,{track:g,type:v}=a;switch(v){case Ke.LocalAudioTrack:f=At.Audio;break;case Ke.LocalVideoTrack:f=xe(p=g._hints).call(p,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalVideoLowTrack:f=At.Low}return{kind:v===Ke.LocalAudioTrack?We.AUDIO:We.VIDEO,stream_type:f,mid:i[l].id,ssrcs:i[l].localSSRC,isMuted:g.muted||!g.enabled}})}createGatewayUnpublishMessage(t){return t.map(i=>{var a;let l,[p,{track:f,ssrcs:g,id:v}]=i;switch(p){case Ke.LocalVideoTrack:l=xe(a=f._hints).call(a,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalAudioTrack:l=At.Audio;break;case Ke.LocalVideoLowTrack:l=At.Low}return{stream_type:l,ssrcs:g,mid:v}})}assignLocalTracks(t,i){t.forEach((a,l)=>{let{track:p,type:f}=a;this.localTrackMap.set(f,{track:p,id:i[l].id,ssrcs:i[l].localSSRC})})}withdrawLocalTracks(t){t.forEach(i=>{let[a]=i;this.localTrackMap.delete(a)})}bindConnectionEvents(t){t.onConnectionStateChange=async i=>{var a;x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(i,")")),this.emit(wt.PeerConnectionStateChange,i),i!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),i==="connected"&&(t.isInRestartIce=!1),xe(a=this._restartStates).call(a,i)&&!t.isInRestartIce&&(i==="disconnected"&&await Qr(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=i=>{i!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(i,")")),Tt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:i,tag:Pi.TRACER}).onSuccess(),this.emit(wt.IceConnectionStateChange,i)},t.onICETransportStateChange=i=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(i,")"))},t.onDTLSTransportStateChange=i=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(i,")"))},t.onDTLSTransportError=i=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(i,")"))},t.onFirstAudioDecoded=i=>{var a;let l=Array.from(Ho(a=this.remoteUserMap).call(a)).find(f=>f._audioSSRC===i);var p;l&&(this.store.subscribe(l.uid,"audio",void 0,void 0,void 0,Date.now()),(p=l.audioTrack)===null||p===void 0||p.emit(Th.FIRST_FRAME_DECODED),Tt.firstRemoteFrame(this.store.sessionId,kt.FIRST_AUDIO_DECODE,ai.FIRST_AUDIO_DECODE,{peer:l._uintid,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=i=>{var a;let l=Array.from(Ho(a=this.remoteUserMap).call(a)).find(p=>p._audioSSRC===i);l&&Tt.firstRemoteFrame(this.store.sessionId,kt.FIRST_AUDIO_RECEIVED,ai.FIRST_AUDIO_RECEIVED,{peer:l._uintid,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(i,a,l)=>{this.reportVideoFirstFrameDecoded(i,a,l)},t.onFirstVideoReceived=i=>{var a;let l=Array.from(Ho(a=this.remoteUserMap).call(a)).find(p=>p._videoSSRC===i);l&&Tt.firstRemoteFrame(this.store.sessionId,kt.FIRST_VIDEO_RECEIVED,ai.FIRST_VIDEO_RECEIVED,{peer:l._uintid,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(i,a)=>{let l=i.candidateType==="relay",p=a.candidateType==="relay";a.candidateType!=="unknown"&&l===p||this.emit(wt.ConnectionTypeChange,l),x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(qo(a))," -> ").concat(JSON.stringify(qo(i)),")"))},t.onSelectedRemoteCandidateChanged=(i,a)=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(qo(a))," -> ").concat(JSON.stringify(qo(i)),")"))},t.onFirstVideoDecodedTimeout=i=>{this.reportVideoFirstFrameDecoded(i,void 0,void 0,!0)},t.onLocalCandidate=i=>{this.emit(wt.LocalCandidate,{candidate:i,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){let i=t===Ks.SEND_ONLY?this.sendConnection:this.recvConnection;i&&!i.isInRestartIce&&(i.isInRestartIce=!0,x.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(i.name,"] start use restartICE")),t===Ks.SEND_ONLY?this.restartICE(t):In(this,wt.RequestP2PRestartICE,{direction:Ks.SEND_ONLY}))}filterTobeMutedTracks(t){let i=[];if(this.getAllTracks().indexOf(t)===-1)return i;let a=this.localTrackMap.get(Ke.LocalAudioTrack);if(t instanceof Vn&&(a==null?void 0:a.track)instanceof lr)return a.track.isActive||i.push([Ke.LocalAudioTrack,a]),i;let l=Array.from(this.localTrackMap.entries()).find(p=>{let[,{track:f}]=p;return t===f});if(l&&(i.push(l),l[0]===Ke.LocalVideoTrack)){let p=this.localTrackMap.get(Ke.LocalVideoLowTrack);p&&i.push([Ke.LocalVideoLowTrack,p])}return i}filterTobeUnmutedTracks(t){let i=[],a=this.localTrackMap.get(Ke.LocalAudioTrack);if(t instanceof Vn&&(a==null?void 0:a.track)instanceof lr)return a.track.isActive&&i.push([Ke.LocalAudioTrack,a]),i;let l=Array.from(this.localTrackMap.entries()).find(p=>{let[,{track:f}]=p;return t===f});if(l)if(l[0]===Ke.LocalVideoTrack){i.push(l);let p=this.localTrackMap.get(Ke.LocalVideoLowTrack);p&&i.push([Ke.LocalVideoLowTrack,p])}else i.push(l);return i}createMuteMessage(t){return t.map(i=>{var a;let l,[p,{track:f,ssrcs:g,id:v}]=i;switch(p){case Ke.LocalAudioTrack:l=At.Audio;break;case Ke.LocalVideoTrack:l=xe(a=f._hints).call(a,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalVideoLowTrack:l=At.Low}return{stream_type:l,ssrcs:g,mid:v}})}createUnmuteMessage(t){return t.map(i=>{var a;let l,[p,{track:f,ssrcs:g,id:v}]=i;switch(p){case Ke.LocalAudioTrack:l=At.Audio;break;case Ke.LocalVideoTrack:l=xe(a=f._hints).call(a,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalVideoLowTrack:l=At.Low}return{stream_type:l,ssrcs:g,mid:v}})}filterTobeUnSubscribedTracks(t,i){let a=[],l=this.remoteUserMap.get(t);if(!l)return a;if(i){let p=l.get(i);if(!p)return a;a.push([t,{kind:i,id:p}])}else Array.from(l.entries()).forEach(p=>{let[f,g]=p;a.push([t,{kind:f,id:g}])});return a}createUnsubscribeMessage(t){let i=[];return t.forEach(a=>{let[l,{kind:p,id:f}]=a;switch(p){case We.VIDEO:return void(l._videoSSRC&&i.push({stream_type:We.VIDEO,ssrcId:l._videoSSRC}));case We.AUDIO:return void(l._audioSSRC&&i.push({stream_type:We.AUDIO,ssrcId:l._audioSSRC}))}}),i}withdrawRemoteTracks(t){t.forEach(i=>{let[a,{kind:l}]=i,p=this.remoteUserMap.get(a);p&&(p.delete(l),Array.from(p.entries()).length===0&&this.remoteUserMap.delete(a))})}async updateBitrateLimit(t){let i=this.localTrackMap.get(Ke.LocalVideoTrack),a=this.localTrackMap.get(Ke.LocalVideoLowTrack);i&&await i.track.setBitrateLimit(t.uplink),a&&t.low_stream_uplink&&await a.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let t=this.sendConnection.peerConnectionState,i=this.recvConnection.peerConnectionState;return t!=="connected"&&i!=="connected"}return!0}async tryToUnmuteAudio(t){for(let i=0;i<t.length;i++)if(t[i]instanceof Vn){let a=this.filterTobeUnmutedTracks(t[i]);if(a.length===0)continue;let l=this.createUnmuteMessage(a);return void await fn(this,wt.RequestUnmuteLocal,l)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:i}]=t;return!!i}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var i;return!((i=this.recvConnection)===null||i===void 0||!i.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,i)=>this.emit(wt.RequestUpload,t,i),this.statsUploader.requestUploadStats=t=>this.emit(wt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Qr(eu(this.dtlsFailedCount,dr)),this.emit(wt.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(Ke.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof jt)}throwIfTrackTypeNotMatch(t){if(t.filter(i=>i instanceof jt).length>1)throw new Ve(Z.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(i=>i instanceof Vn).length>1&&(t.some(i=>i instanceof Vn&&i._bypassWebAudio)||!zn().webAudioMediaStreamDest))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let i of t){if(i instanceof jt&&this.pendingLocalTracks.some(a=>a instanceof jt))throw new Ve(Z.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(i instanceof Vn&&this.pendingLocalTracks.some(a=>a instanceof Vn)&&(!zn().webAudioMediaStreamDest||i._bypassWebAudio||this.pendingLocalTracks.some(a=>a instanceof Vn&&a._bypassWebAudio)))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,i){let a=!ce("DISABLE_DUAL_STREAM_USE_ENCODING")&&zn().supportDualStreamEncoding,l=XC(XC({},{width:160,height:120,framerate:15,bitrate:50}),i),p;p=a?t._mediaStreamTrack.clone():Jb(t,l);let f=si(8,"track-low-"),g=new jt(p,XC(XC({},a&&{scaleResolutionDownBy:oC(l,t)}),{},{frameRate:l.framerate,bitrateMax:l.bitrate,bitrateMin:l.bitrate}),void 0,void 0,f);return g.on(Sh.TRANSCEIVER_UPDATED,v=>{t._updateRtpTransceiver(v,pa.LOW_STREAM)}),g._hints.push(Un.LOW_STREAM),t.addListener(ut.NEED_CLOSE,()=>{g.close()}),g}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,i,a,l){var p;let f=Array.from(Ho(p=this.remoteUserMap).call(p)).find(g=>g._videoSSRC===t);if(f){l||this.store.subscribe(f.uid,"video",void 0,void 0,void 0,void 0,Date.now());let g=this.store.keyMetrics,v=g.subscribe.find(y=>y.userId===f.uid&&y.type==="video");Tt.firstRemoteVideoDecode(this.store.sessionId,kt.FIRST_VIDEO_DECODE,ai.FIRST_VIDEO_DECODE,{peer:f._uintid,videowidth:i,videoheight:a,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:g.requestAPEnd||0,apStart:g.requestAPStart||0,joinGwEnd:g.joinGatewayEnd||0,joinGwStart:g.joinGatewayStart||0,pcEnd:g.peerConnectionEnd||0,pcStart:g.peerConnectionStart||0,subscriberEnd:(v==null?void 0:v.subscribeEnd)||0,subscriberStart:(v==null?void 0:v.subscribeStart)||0,videoAddNotify:(v==null?void 0:v.streamAdded)||0,state:l?1:0})}}async remoteMediaSsrcChanged(t,i,a){if(!this.recvConnection)return!1;let l=this.remoteUserMap.get(t);if(!l)return!1;let p=l.get(i);if(!p)return!1;let f=await this.recvConnection.getRemoteSSRC(p);return f!==void 0&&f!==a}resetConnection(t){x.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(t)),this.state===Yt.Connected?(x.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(t){throw new Ve(Z.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new Ve(Z.NOT_SUPPORTED)}async subscribeDataChannel(t,i){throw new Ve(Z.NOT_SUPPORTED)}async unsubscribeDataChannel(t,i){throw new Ve(Z.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,i){throw new Ve(Z.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,i){throw new Ve(Z.NOT_SUPPORTED)}async preConnect(t,i,a,l,p,f){throw new Ve(Z.NOT_SUPPORTED)}getEstablishParams(){throw new Ve(Z.NOT_SUPPORTED)}async reSubscribe(t){throw new Ve(Z.NOT_SUPPORTED)}async updateVideoStreamParameter(t,i){throw new Ve(Z.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[i,{track:a}]=t;i===Ke.LocalVideoLowTrack?a._updateRtpTransceiver(void 0,pa.LOW_STREAM):a._updateRtpTransceiver(void 0)})}}function Tc(s){return function(t,i,a){let l=t[i];if(typeof l!="function")throw new Error("Cannot use mutex on object property.");return a.value=async function(){for(var p=arguments.length,f=new Array(p),g=0;g<p;g++)f[g]=arguments[g];switch(s){case Ga.SEND_ONLY:{let v=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await l.apply(this,f)}finally{v()}}case Ga.RECEIVE_ONLY:{let v=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await l.apply(this,f)}finally{v()}}default:{let v=await this.sendMutex.lock("From P2PChannel2.".concat(i)),y=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await l.apply(this,f)}finally{v(),y()}}}},a}}function $b(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Lh(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?$b(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):$b(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}Be([Tc(Ga.SEND_ONLY),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],nr.prototype,"p2pConnect",null),Be([Tc(Ga.SEND_ONLY),Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],nr.prototype,"unpublish",null),Be([Tc(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],nr.prototype,"unpublishLowStream",null),Be([Tc(Ga.RECEIVE_ONLY),Y("design:type",Function),Y("design:paramtypes",[ms,String,Number,String]),Y("design:returntype",Pe)],nr.prototype,"subscribe",null),Be([Tc(Ga.RECEIVE_ONLY),Y("design:type",Function),Y("design:paramtypes",[ms,String,Number,String]),Y("design:returntype",Pe)],nr.prototype,"mockSubscribe",null),Be([Tc(Ga.RECEIVE_ONLY),Y("design:type",Function),Y("design:paramtypes",[ms,String,Boolean]),Y("design:returntype",Pe)],nr.prototype,"unsubscribe",null),Be([Tc(Ga.RECEIVE_ONLY),Y("design:type",Function),Y("design:paramtypes",[ms,String]),Y("design:returntype",Pe)],nr.prototype,"muteRemote",null),Be([Tc(Ga.RECEIVE_ONLY),Y("design:type",Function),Y("design:paramtypes",[ms,String]),Y("design:returntype",Pe)],nr.prototype,"unmuteRemote",null),Be([Tc(Ga.RECEIVE_ONLY),Y("design:type",Function),Y("design:paramtypes",[ms,String]),Y("design:returntype",Pe)],nr.prototype,"hasRemoteMediaWithLock",null),Be([Tc(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],nr.prototype,"disconnectForReconnect",null),Be([Tc(Ga.RECEIVE_ONLY),Y("design:type",Function),Y("design:paramtypes",[ms,String,Number]),Y("design:returntype",Pe)],nr.prototype,"remoteMediaSsrcChanged",null);class nd{constructor(t){P(this,"store",void 0),P(this,"onStatsException",void 0),P(this,"onUploadPublishDuration",void 0),P(this,"onStatsChanged",void 0),P(this,"localStats",new Map),P(this,"remoteStats",new Map),P(this,"updateStatsInterval",void 0),P(this,"trafficStats",void 0),P(this,"trafficStatsPeerList",[]),P(this,"uplinkStats",void 0),P(this,"exceptionMonitor",void 0),P(this,"p2pChannel",void 0),P(this,"scalabilityMode",Ts.L1T1),P(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=t,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new Lf,this.exceptionMonitor.on("exception",(i,a,l)=>{this.onStatsException&&this.onStatsException(i,a,l)})}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Ke.LocalAudioTrack)||Lh({},ys)}getLocalVideoTrackStats(){return this.localStats.get(Ke.LocalVideoTrack)||Lh({},Eo)}getRemoteAudioTrackStats(t){let i=(p,f)=>{if(!this.trafficStats)return f;let g=this.trafficStats.peer_delay.find(v=>v.peer_uid===p);return g&&(f.publishDuration=g.B_ppad+(Date.now()-this.trafficStats.timestamp)),f},a={};if(t){var l;let p=(l=this.remoteStats.get(t))===null||l===void 0?void 0:l.audioStats;p&&(a[t]=i(t,p))}else Array.from(this.remoteStats.entries()).forEach(p=>{let[f,{audioStats:g}]=p;g&&(a[f]=i(f,g))});return a}getRemoteNetworkQualityStats(t){let i={};if(t){var a;let l=(a=this.remoteStats.get(t))===null||a===void 0?void 0:a.networkStats;l&&(i[t]=l)}else Array.from(this.remoteStats.entries()).forEach(l=>{let[p,{networkStats:f}]=l;f&&(i[p]=f)});return i}getRemoteVideoTrackStats(t){let i=(p,f)=>{if(!this.trafficStats)return f;let g=this.trafficStats.peer_delay.find(v=>v.peer_uid===p);return g&&(f.publishDuration=g.B_ppvd+(Date.now()-this.trafficStats.timestamp)),f},a={};if(t){var l;let p=(l=this.remoteStats.get(t))===null||l===void 0?void 0:l.videoStats;p&&(a[t]=i(t,p))}else Array.from(this.remoteStats.entries()).forEach(p=>{let[f,{videoStats:g}]=p;g&&(a[f]=i(f,g))});return a}getRTCStats(){let t=0,i=0,a=0,l=0,p=this.localStats.get(Ke.LocalAudioTrack);p&&(t+=p.sendBytes,i+=p.sendBitrate);let f=this.localStats.get(Ke.LocalVideoTrack);f&&(t+=f.sendBytes,i+=f.sendBitrate);let g=this.localStats.get(Ke.LocalVideoLowTrack);g&&(t+=g.sendBytes,i+=g.sendBitrate),this.remoteStats.forEach(y=>{let{audioStats:I,videoStats:b}=y;I&&(a+=I.receiveBytes,l+=I.receiveBitrate),b&&(a+=b.receiveBytes,l+=b.receiveBitrate)});let v=1;return this.trafficStats&&(v+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:v,SendBitrate:i,SendBytes:t,RecvBytes:a,RecvBitrate:l,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(i=>i.B_ppad!==void 0||i.B_ppvd!==void 0),t.peer_delay.filter(i=>this.trafficStatsPeerList.indexOf(i.peer_uid)===-1).forEach(i=>{var a;let l=(a=this.p2pChannel)===null||a===void 0?void 0:a.getRemoteMedia(i.peer_uid),p=l!=null&&l.videoSSRC?Is.measureFromSubscribeStart(this.store.clientId,l.videoSSRC):0,f=l!=null&&l.audioSSRC?Is.measureFromSubscribeStart(this.store.clientId,l.audioSSRC):0;i.B_ppad!==void 0&&i.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(i.peer_uid,i.B_ppad,i.B_ppvd,p>f?p:f),this.trafficStatsPeerList.push(i.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&x.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,i,a){if(!t)return!1;let l=!!a&&i.framesDecodeFreezeTime>a.framesDecodeFreezeTime,p=!a||i.framesDecodeCount>a.framesDecodeCount;return l||!p}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(i=>{let[a,l]=i;switch(a){case Ke.LocalVideoTrack:case Ke.LocalVideoLowTrack:{let f=l,g=Lh({},Eo),v=t.getStats(),y=t.getLocalMedia(a);if(v){let I=v.videoSend.find(b=>b.ssrc===(y==null?void 0:y.ssrcs[0].ssrcId));if(I){let b=t.getLocalVideoSize(),k=t.getEncoderConfig(Ke.LocalVideoTrack);I.codec!=="H264"&&I.codec!=="H265"&&I.codec!=="VP8"&&I.codec!=="VP9"&&I.codec!=="AV1X"&&I.codec!=="AV1"||(g.codecType=I.codec),g.sendBytes=I.bytes,g.sendBitrate=f?8*Math.max(0,g.sendBytes-f.sendBytes):0,I.inputFrame?(g.captureFrameRate=I.inputFrame.frameRate,g.captureResolutionHeight=I.inputFrame.height,g.captureResolutionWidth=I.inputFrame.width):b&&(g.captureResolutionWidth=b.width,g.captureResolutionHeight=b.height),I.sentFrame?(g.sendFrameRate=I.sentFrame.frameRate,g.sendResolutionHeight=I.sentFrame.height,g.sendResolutionWidth=I.sentFrame.width):b&&(g.sendResolutionWidth=b.width,g.sendResolutionHeight=b.height),I.avgEncodeMs&&(g.encodeDelay=I.avgEncodeMs),k&&k.bitrateMax&&(g.targetSendBitrate=1e3*k.bitrateMax),g.sendPackets=I.packets,g.sendPacketsLost=I.packetsLost,g.sendJitterMs=I.jitterMs,g.sendRttMs=I.rttMs,g.totalDuration=f?f.totalDuration+1:1,g.totalFreezeTime=f?f.totalFreezeTime:0,this.isLocalVideoFreeze(I)&&(g.totalFreezeTime+=1),I.scalabilityMode&&this.scalabilityMode!==I.scalabilityMode&&(x.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(I.scalabilityMode)),this.scalabilityMode=I.scalabilityMode)}this.trafficStats&&(g.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var p;this.localStats.set(a,g),((f==null?void 0:f.sendResolutionWidth)!==g.sendResolutionWidth||(f==null?void 0:f.sendResolutionHeight)!==g.sendResolutionHeight)&&((p=this.onStatsChanged)===null||p===void 0||p.call(this,"resolution",{width:g.sendResolutionWidth,height:g.sendResolutionHeight})),g&&y&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,y.track,g);break}case Ke.LocalAudioTrack:{let f=l,g=Lh({},ys),v=t.getStats(),y=t.getLocalMedia(a);if(v){let I=v.audioSend.find(b=>b.ssrc===(y==null?void 0:y.ssrcs[0].ssrcId));if(I){if(I.codec!=="opus"&&I.codec!=="aac"&&I.codec!=="PCMU"&&I.codec!=="PCMA"&&I.codec!=="G722"||(g.codecType=I.codec),I.inputLevel)g.sendVolumeLevel=Math.round(32767*I.inputLevel);else{let b=t.getLocalAudioVolume();b&&(g.sendVolumeLevel=Math.round(32767*b))}g.sendBytes=I.bytes,g.sendPackets=I.packets,g.sendPacketsLost=I.packetsLost,g.sendJitterMs=I.jitterMs,g.sendRttMs=I.rttMs,g.sendBitrate=f?8*Math.max(0,g.sendBytes-f.sendBytes):0}}this.trafficStats&&(g.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(Ke.LocalAudioTrack,g),g&&y&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,y.track,g);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(i=>{var a,l;let[p,{videoStats:f,audioStats:g,videoPcStats:v}]=i,y=g,I=f,b=v,k=Lh({},Ch),U=Lh({},ks),J=Lh({},uu),{audioTrack:K,videoTrack:q,audioSSRC:te,videoSSRC:de}=t.getRemoteMedia(p),he;he=t instanceof nr?t.getStats(!0):t.getStats();let Ue=(a=he)===null||a===void 0?void 0:a.audioRecv.find(De=>De.ssrc===te),Re=(l=he)===null||l===void 0?void 0:l.videoRecv.find(De=>De.ssrc===de),Ie=this.trafficStats&&this.trafficStats.peer_delay.find(De=>De.peer_uid===p);if(Ue&&(Ue.codec!=="opus"&&Ue.codec!=="aac"&&Ue.codec!=="PCMU"&&Ue.codec!=="PCMA"&&Ue.codec!=="G722"||(k.codecType=Ue.codec),Ue.outputLevel?k.receiveLevel=Math.round(32767*Ue.outputLevel):K&&(k.receiveLevel=Math.round(32767*K.getVolumeLevel())),k.receiveBytes=Ue.bytes,k.receivePackets=Ue.packets,k.receivePacketsLost=Ue.packetsLost,k.packetLossRate=k.receivePacketsLost/(k.receivePackets+k.receivePacketsLost),k.receiveBitrate=y?8*Math.max(0,k.receiveBytes-y.receiveBytes):0,k.totalDuration=y?y.totalDuration+1:1,k.totalFreezeTime=y?y.totalFreezeTime:0,k.freezeRate=k.totalFreezeTime/k.totalDuration,k.receiveDelay=Ue.jitterBufferMs,k.totalDuration>10&&nd.isRemoteAudioFreeze(K)&&(k.totalFreezeTime+=1)),Re){Re.codec!=="H264"&&Re.codec!=="H265"&&Re.codec!=="VP8"&&Re.codec!=="VP9"&&Re.codec!=="AV1X"&&Re.codec!=="AV1"||(U.codecType=Re.codec),U.receiveBytes=Re.bytes,U.receiveBitrate=I?8*Math.max(0,U.receiveBytes-I.receiveBytes):0,U.decodeFrameRate=Re.decodeFrameRate<0?0:Re.decodeFrameRate,U.renderFrameRate=Re.decodeFrameRate<0?0:Re.decodeFrameRate,Re.outputFrame&&(U.renderFrameRate=Re.outputFrame.frameRate),Re.receivedFrame?(U.receiveFrameRate=Re.receivedFrame.frameRate,U.receiveResolutionHeight=Re.receivedFrame.height,U.receiveResolutionWidth=Re.receivedFrame.width):q&&(U.receiveResolutionHeight=q._videoHeight||0,U.receiveResolutionWidth=q._videoWidth||0),Re.framesRateFirefox!==void 0&&(U.receiveFrameRate=Math.round(Re.framesRateFirefox)),U.receivePackets=Re.packets,U.receivePacketsLost=Re.packetsLost,U.packetLossRate=U.receivePacketsLost/(U.receivePackets+U.receivePacketsLost),U.totalDuration=I?I.totalDuration+1:1,U.totalFreezeTime=I?I.totalFreezeTime:0,U.receiveDelay=Re.jitterBufferMs||0;let De=!!de&&t.getRemoteVideoIsReady(de);q&&De&&nd.isRemoteVideoFreeze(q,Re,b)&&(U.totalFreezeTime+=1),U.freezeRate=U.totalFreezeTime/U.totalDuration}Ie&&(k.end2EndDelay=Ie.B_ad,U.end2EndDelay=Ie.B_vd,k.transportDelay=Ie.B_ed,U.transportDelay=Ie.B_ed,k.currentPacketLossRate=Ie.B_ealr4/100,U.currentPacketLossRate=Ie.B_evlr4/100,J.uplinkNetworkQuality=Ie.B_punq?Ie.B_punq:0,J.downlinkNetworkQuality=Ie.B_pdnq?Ie.B_pdnq:0),this.remoteStats.set(p,{audioStats:k,videoStats:U,videoPcStats:Re,networkStats:J}),K&&this.exceptionMonitor.setRemoteAudioStats(K,k),q&&this.exceptionMonitor.setRemoteVideoStats(q,U)})}}function Rk(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function sS(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Rk(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Rk(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class M3 extends ri{constructor(t,i,a,l){super(),P(this,"spec",void 0),P(this,"token",void 0),P(this,"websocket",void 0),P(this,"pingpongTimer",void 0),P(this,"reconnectMode","retry"),P(this,"serviceMode",void 0),P(this,"reqId",0),P(this,"commandReqId",0),P(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),P(this,"handleWebSocketMessage",p=>{if(!p.data)return;let f=JSON.parse(p.data);f.requestId?this.emit("@".concat(f.requestId,"-").concat(f.sid),f):this.serviceMode===br.INJECT?this.emit(Cs.INJECT_STREAM_STATUS,f):(Tt.workerEvent(this.spec.sid,{actionType:"status",serverCode:f.code,workerType:this.serviceMode===br.TRANSCODE?1:2}),this.emit(Cs.PUBLISH_STREAM_STATUS,f))}),this.spec=i,this.token=t,this.serviceMode=l,this.websocket=new Up("live-streaming",a),this.websocket.on(xt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(xt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(xt.REQUEST_NEW_URLS,(p,f)=>{In(this,Cs.REQUEST_NEW_ADDRESS).then(p).catch(f)}),this.websocket.on(xt.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,i,a,l){this.reqId+=1,t==="request"&&(this.commandReqId+=1);let p=this.commandReqId,f=this.reqId;if(!f||!this.websocket)throw new Ce(Z.UNEXPECTED_ERROR);let g=sS({command:t,sdkVersion:Gt==="4.20.0"?"0.0.1":Gt,seq:f,requestId:f,allocate:a,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},i);if(this.websocket.state==="closed")throw new Ce(Z.WS_DISCONNECT);let v=()=>new Pe((k,U)=>{this.websocket.once(xt.CLOSED,()=>U(new Ce(Z.WS_ABORT))),this.websocket.once(xt.CONNECTED,k)});this.websocket.state!=="connected"&&await v(),g.clientRequest&&(g.clientRequest.workerToken=this.token);let y=new Pe((k,U)=>{let J=()=>{U(new Ce(Z.WS_ABORT))};this.websocket.once(xt.RECONNECTING,J),this.websocket.once(xt.CLOSED,J),this.once("@".concat(f,"-").concat(this.spec.sid),K=>{k(K)})});l&&Tt.workerEvent(this.spec.sid,sS(sS({},l),{},{requestId:p,actionType:"request",payload:JSON.stringify(i.clientRequest),serverCode:0,code:0}));let I=Date.now();this.websocket.sendMessage(g);let b=null;try{b=await y}catch(k){if(this.websocket.state==="closed")throw k;return await v(),await this.request(t,i,a)}return l&&Tt.workerEvent(this.spec.sid,sS(sS({},l),{},{requestId:p,actionType:"response",payload:JSON.stringify(b.serverResponse),serverCode:b.code,success:b.code===200,responseTime:Date.now()-I})),b.code!==200&&this.handleResponseError(b),b}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){let t=Gt==="4.20.0"?"0.0.1":Gt;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case Ti.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void x.warning("live stream response already exists stream");case Ti.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Ti.LIVE_STREAM_RESPONSE_BAD_STREAM:case Ti.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Ce(Z.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case Ti.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Ti.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Ce(Z.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case Ti.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let i=new Ce(Z.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Cs.WARNING,i,t.serverResponse.url)}case Ti.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let i=new Ce(Z.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Cs.WARNING,i,t.serverResponse.url)}case Ti.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Ti.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Ce(Z.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case Ti.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let i=new Ce(Z.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Cs.WARNING,i,t.serverResponse.url)}case Ti.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case Ti.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Ti.LIVE_STREAM_RESPONSE_WORKER_LOST:case Ti.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Ti.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Ti.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Ti.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Ti.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Ti.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Ce(Z.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch($m)},6e3)}}function e0(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Vo(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?e0(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):e0(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class U3 extends ri{constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:dr,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:dr;super(),P(this,"onLiveStreamWarning",void 0),P(this,"onLiveStreamError",void 0),P(this,"onInjectStatusChange",void 0),P(this,"spec",void 0),P(this,"retryTimeout",1e4),P(this,"connection",void 0),P(this,"httpRetryConfig",void 0),P(this,"wsRetryConfig",void 0),P(this,"streamingTasks",new Map),P(this,"isStartingStreamingTask",!1),P(this,"taskMutex",new sn("live-streaming")),P(this,"cancelToken",mr.CancelToken.source()),P(this,"transcodingConfig",void 0),P(this,"injectConfig",Vo({},Ys)),P(this,"injectLoopTimes",0),P(this,"uapResponse",void 0),P(this,"lastTaskId",1),P(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=a,this.wsRetryConfig=i}async setTranscodingConfig(t){let i=Vo(Vo({},iP),t);i.videoCodecProfile!==66&&i.videoCodecProfile!==77&&i.videoCodecProfile!==100&&(x.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map(f=>Vo(Vo(Vo({},Hc),f),{},{zOrder:f.zOrder?f.zOrder+1:1}))),function(f){ke(f.width)||bn(f.width,"config.width",0,1e4),ke(f.height)||bn(f.height,"config.height",0,1e4),ke(f.videoBitrate)||bn(f.videoBitrate,"config.videoBitrate",1,1e6),ke(f.videoFrameRate)||bn(f.videoFrameRate,"config.videoFrameRate"),ke(f.lowLatency)||$l(f.lowLatency,"config.lowLatency"),ke(f.audioSampleRate)||vr(f.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),ke(f.audioBitrate)||bn(f.audioBitrate,"config.audioBitrate",1,128),ke(f.audioChannels)||vr(f.audioChannels,"config.audioChannels",[1,2,3,4,5]),ke(f.videoGop)||bn(f.videoGop,"config.videoGop"),ke(f.videoCodecProfile)||vr(f.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),ke(f.userCount)||bn(f.userCount,"config.userCount",0,17),ke(f.backgroundColor)||bn(f.backgroundColor,"config.backgroundColor",0,16777215),ke(f.userConfigExtraInfo)||jr(f.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),f.transcodingUsers&&!ke(f.transcodingUsers)&&(Q(f.transcodingUsers,"config.transcodingUsers"),f.transcodingUsers.forEach((g,v)=>{Dw(g.uid),ke(g.x)||bn(g.x,"transcodingUser[".concat(v,"].x"),0,1e4),ke(g.y)||bn(g.y,"transcodingUser[".concat(v,"].y"),0,1e4),ke(g.width)||bn(g.width,"transcodingUser[".concat(v,"].width"),0,1e4),ke(g.height)||bn(g.height,"transcodingUser[".concat(v,"].height"),0,1e4),ke(g.zOrder)||bn(g.zOrder-1,"transcodingUser[".concat(v,"].zOrder"),0,100),ke(g.alpha)||bn(g.alpha,"transcodingUser[".concat(v,"].alpha"),0,1,!1)})),ke(f.watermark)||Xi(f.watermark,"watermark"),ke(f.backgroundImage)||Xi(f.backgroundImage,"backgroundImage"),f.images&&!ke(f.images)&&(Q(f.images,"config.images"),f.images.forEach((g,v)=>{Xi(g,"images[".concat(v,"]"))}))}(i);let a=[];i.images&&a.push(...i.images.map(f=>Vo(Vo(Vo({},ph),f),{},{zOrder:255}))),i.backgroundImage&&(a.push(Vo(Vo(Vo({},ph),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(a.push(Vo(Vo(Vo({},ph),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=a,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map(f=>Vo({},f)),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);let l=(i.userConfigs||[]).map(f=>typeof f.uid=="number"?Pe.resolve(f.uid):bP(f.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Pe.all(l)).forEach((f,g)=>{i.userConfigs&&i.userConfigs[g]&&(i.userConfigs[g].uid=f)}),this.transcodingConfig=i,this.connection)try{var p;let f=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(hc(p=this.streamingTasks).call(p)).map(g=>g.taskId).join("#")});x.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(f.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(f){if(!f.data||!f.data.retry)throw f;f.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(g=>{x.warning("[".concat(this.spec.clientId,"] live streaming receive error"),f.toString(),"try to republish",g.url),this.startLiveStreamingTask(g.url,g.mode,f).then(()=>{x.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(g.url," success"))}).catch(v=>{x.error("[".concat(this.spec.clientId,"] live streaming republish failed"),g.url,v.toString()),this.onLiveStreamError&&this.onLiveStreamError(g.url,v)})})}}setInjectStreamConfig(t,i){this.injectConfig=Object.assign({},this.injectConfig,t),this.injectLoopTimes=i}async startLiveStreamingTask(t,i,a){var l;if(Array.from(hc(l=this.streamingTasks).call(l)).find(v=>v.mode===br.INJECT)&&i===br.INJECT)return new Ce(Z.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===br.TRANSCODE)throw new Ce(Z.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let p={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};x.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(i));let f=await this.taskMutex.lock();if(!this.connection&&a)return void f();if(this.streamingTasks.get(t)&&!a)return f(),new Ce(Z.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(v){throw f(),v}switch(i){case br.TRANSCODE:p.transcodingConfig=Vo({},this.transcodingConfig);break;case br.RAW:break;case br.INJECT:p={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(p.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let g=this.lastTaskId++;try{let v=new Pe((I,b)=>{Qr(this.retryTimeout).then(()=>{if(a)return b(a);let k=this.statusError.get(t);return k?(this.statusError.delete(t),b(k)):void 0})}),y=await Pe.race([this.connection.request("request",{clientRequest:p},!0,{url:t,command:"PublishStream",workerType:i===br.TRANSCODE?1:2,requestByUser:!a,tid:g.toString()}),v]);this.isStartingStreamingTask=!1,x.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(y.code)),this.streamingTasks.set(t,{clientRequest:p,mode:i,url:t,taskId:g}),f()}catch(v){if(f(),this.isStartingStreamingTask=!1,!v.data||!v.data.retry||a)throw v;return v.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,i,v)):await this.startLiveStreamingTask(t,i,v)}}stopLiveStreamingTask(t){return new Pe((i,a)=>{let l=this.streamingTasks.get(t);if(!l||!this.connection)return new Ce(Z.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let p=l.mode;l.abortTask=()=>{x.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),i()},this.connection.request("request",{clientRequest:{command:p===br.INJECT?"UninjectStream":"UnpublishStream",url:l.url}},!1,{url:t,command:"UnPublishStream",workerType:p===br.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(f=>{x.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(f.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&p!==br.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),p===br.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(hh.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)}).catch(a)})}async controlInjectStream(t,i,a,l){let p=this.streamingTasks.get(t);if(!p||!this.connection||p.mode!==br.INJECT)throw new Ce(Z.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:t,control:i,audioVolume:a,position:l}})).serverResponse}resetAllTask(){var t;let i=Array.from(hc(t=this.streamingTasks).call(t));this.terminate();for(let a of i)this.startLiveStreamingTask(a.url,a.mode).catch(l=>{this.onLiveStreamError&&this.onLiveStreamError(a.url,l)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=mr.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new Ce(Z.UNEXPECTED_ERROR,"live streaming connection has already connected");let i=await In(this,hs.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=i,this.connection=new M3(i.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Cs.WARNING,(a,l)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(l,a)),this.connection.on(Cs.PUBLISH_STREAM_STATUS,a=>this.handlePublishStreamServer(a)),this.connection.on(Cs.INJECT_STREAM_STATUS,a=>this.handleInjectStreamServerStatus(a)),this.connection.on(Cs.REQUEST_NEW_ADDRESS,(a,l)=>{if(!this.connection)return l(new Ce(Z.UNEXPECTED_ERROR,"can not get new live streaming address list"));In(this,hs.REQUEST_WORKER_MANAGER_LIST,t).then(p=>{this.uapResponse=p,a(p.addressList)}).catch(l)}),await this.connection.init(i.addressList),this.connection}handlePublishStreamServer(t){let i=t.serverStatus&&t.serverStatus.url||"empty_url",a=this.streamingTasks.get(i),l=t.reason;switch(t.code){case Ti.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Ti.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Ti.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Ti.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let f=new Ce(Z.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(a)return x.error(f.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,f);if(!this.isStartingStreamingTask)return;this.statusError.set(i,f)}case Ti.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let f=new Ce(Z.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,l);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,f)}case Ti.LIVE_STREAM_RESPONSE_WORKER_LOST:case Ti.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var p;if(!this.connection)return;this.connection.tryNextAddress();let f=Array.from(hc(p=this.streamingTasks).call(p));for(let g of f)g.abortTask?g.abortTask():(x.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",g.url),this.startLiveStreamingTask(g.url,g.mode,new Ce(Z.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{x.debug("[".concat(this.spec.clientId,"] republish live stream success"),g.url)}).catch(v=>{x.error(v.toString()),this.onLiveStreamError&&this.onLiveStreamError(g.url,v)}));return}}}handleInjectStreamServerStatus(t){let i=Number(t.uid),a=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(hh.INJECT_STREAM_STATUS_START_SUCCESS,i,a));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(hh.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,a),void this.streamingTasks.delete(a);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(hh.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,a),void this.streamingTasks.delete(a);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(hh.INJECT_STREAM_STATUS_BROKEN,i,a),void this.streamingTasks.delete(a);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(hh.INJECT_STREAM_STATUS_START_TIMEOUT,i,a),void this.streamingTasks.delete(a);default:return void x.debug("inject stream server status",t)}}hasUrl(t){return this.streamingTasks.has(t)}}class QC{constructor(){P(this,"destChannelMediaInfos",new Map),P(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){Pw(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){Pw(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Nw(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function ZC(s){if(!(s instanceof QC))return new Ce(Z.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let t=s.getSrcChannelMediaInfo(),i=s.getDestChannelMediaInfo();if(!t)return new Ce(Z.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(i.size===0)return new Ce(Z.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class x3 extends ri{constructor(t,i,a){super(),P(this,"ws",void 0),P(this,"requestId",1),P(this,"heartBeatTimer",void 0),P(this,"joinInfo",void 0),P(this,"clientId",void 0),P(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),P(this,"onClose",l=>{this.emit("close"),this.dispose()}),P(this,"onMessage",l=>{let p=JSON.parse(l.data);if(!p||p.command!=="serverResponse"||!p.requestId)return p&&p.command==="serverStatus"&&p.serverStatus&&p.serverStatus.command?(this.emit("status",p.serverStatus),void this.emit(p.serverStatus.command,p.serverStatus)):void 0;this.emit("req_".concat(p.requestId),p)}),this.joinInfo=t,this.clientId=i,this.ws=new Up("cross-channel-".concat(this.clientId),a),this.ws.on(xt.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(xt.CONNECTED,this.onOpen),this.ws.on(xt.ON_MESSAGE,this.onMessage),this.ws.on(xt.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){let i=this.requestId++;return t.requestId=i,t.seq=i,this.ws.sendMessage(t),i}waitStatus(t){return new Pe((i,a)=>{let l=window.setTimeout(()=>{a(new Ce(Z.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,p=>{window.clearTimeout(l),p.state&&p.state!==0?a(new Ce(Z.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):i(void 0)}),this.once("dispose",()=>{window.clearTimeout(l),a(new Ce(Z.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new Ce(Z.WS_DISCONNECT);let i=()=>new Pe((f,g)=>{this.ws.once(xt.CLOSED,()=>g(new Ce(Z.WS_ABORT))),this.ws.once(xt.CONNECTED,f)});this.ws.state!=="connected"&&await i();let a=this.sendMessage(t),l=new Pe((f,g)=>{let v=()=>{g(new Ce(Z.WS_ABORT))};this.ws.once(xt.RECONNECTING,v),this.ws.once(xt.CLOSED,v),this.once("req_".concat(a),f),Qr(3e3).then(()=>{this.removeAllListeners("req_".concat(a)),this.ws.off(xt.RECONNECTING,v),this.ws.off(xt.CLOSED,v),g(new Ce(Z.TIMEOUT,"cross channel ws request timeout"))})}),p=await l;if(!p||p.code!==200)throw new Ce(Z.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(p)));return p}async connect(t){this.ws.removeAllListeners(xt.REQUEST_NEW_URLS),this.ws.on(xt.REQUEST_NEW_URLS,i=>{i(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){let i=this.requestId++;return t.requestId=i,this.ws.sendMessage(t),i}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class t0 extends ri{set state(t){t!==this._state&&(t!==Yn.RELAY_STATE_FAILURE&&(this.errorCode=bd.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,i,a,l,p){super(),P(this,"joinInfo",void 0),P(this,"sid",void 0),P(this,"clientId",void 0),P(this,"cancelToken",mr.CancelToken.source()),P(this,"workerToken",void 0),P(this,"requestId",0),P(this,"signal",void 0),P(this,"prevChannelMediaConfig",void 0),P(this,"httpRetryConfig",void 0),P(this,"_resolution",void 0),P(this,"_state",Yn.RELAY_STATE_IDLE),P(this,"errorCode",bd.RELAY_OK),P(this,"onStatus",f=>{x.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(f))),f&&f.command&&(f.command==="onAudioPacketReceived"&&this.emit("event",Do.PACKET_RECEIVED_AUDIO_FROM_SRC),f.command==="onVideoPacketReceived"&&this.emit("event",Do.PACKET_RECEIVED_VIDEO_FROM_SRC),f.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=bd.SRC_TOKEN_EXPIRED,this.state=Yn.RELAY_STATE_FAILURE),f.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=bd.DEST_TOKEN_EXPIRED,this.state=Yn.RELAY_STATE_FAILURE))}),P(this,"onReconnect",async()=>{x.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Do.NETWORK_DISCONNECTED),this.state=Yn.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(f=>{this.state!==Yn.RELAY_STATE_IDLE&&(x.error("auto restart channel media relay failed",f.toString()),this.errorCode=bd.SERVER_CONNECTION_LOST,this.state=Yn.RELAY_STATE_FAILURE)})}),this.joinInfo=t,this.clientId=i,this.sid=YA(),this.signal=new x3(this.joinInfo,this.clientId,a),this.httpRetryConfig=l,this._resolution=p}async startChannelMediaRelay(t){if(this.state!==Yn.RELAY_STATE_IDLE)throw new Ce(Z.INVALID_OPERATION);this.state=Yn.RELAY_STATE_CONNECTING,await this.connect(),x.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(i){throw i.data&&i.data.serverResponse&&i.data.serverResponse.command==="SetSourceChannel"?new Ce(Z.CROSS_CHANNEL_FAILED_JOIN_SRC):i.data&&i.data.serverResponse&&i.serverResponse.command==="SetDestChannelStatus"?new Ce(Z.CROSS_CHANNEL_FAILED_JOIN_DEST):i.data&&i.data.serverResponse&&i.serverResponse.command==="StartPacketTransfer"?new Ce(Z.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):i}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==Yn.RELAY_STATE_RUNNING)throw new Ce(Z.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==Yn.RELAY_STATE_RUNNING)throw new Ce(Z.INVALID_OPERATION);let i=this.genMessage(An.SetVideoProfile);await this.signal.request(i),x.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),x.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Yn.RELAY_STATE_IDLE,this.dispose()}dispose(){x.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=mr.CancelToken.source(),this.state=Yn.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){let t=await qs(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",Do.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){let i=this.genMessage(An.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),x.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));let a=this.genMessage(An.SetSdkProfile,t);await this.signal.request(a),x.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let l=this.genMessage(An.SetSourceChannel,t);await this.signal.request(l),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Do.PACKET_JOINED_SRC_CHANNEL),x.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let p=this.genMessage(An.SetSourceUserId,t);await this.signal.request(p),x.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let f=this.genMessage(An.SetDestChannel,t);await this.signal.request(f),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Do.PACKET_JOINED_DEST_CHANNEL),x.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let g=this.genMessage(An.StartPacketTransfer,t);await this.signal.request(g),this.emit("event",Do.PACKET_SENT_TO_DEST_CHANNEL),this.state=Yn.RELAY_STATE_RUNNING,x.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){let i=this.genMessage(An.UpdateDestChannel,t);await this.signal.request(i),this.emit("event",Do.PACKET_UPDATE_DEST_CHANNEL),x.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){let t=this.genMessage(An.StopPacketTransfer);await this.signal.request(t),x.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,i){let a=[],l=[],p=[];this.requestId+=1;let f={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Gt,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};f.sdkVersion==="4.20.0"&&(f.sdkVersion="0.0.1");let g=null,v=null;switch(t){case An.SetSdkProfile:return f.clientRequest={command:"SetSdkProfile",type:"multi_channel"},f;case An.SetSourceChannel:if(v=i&&i.getSrcChannelMediaInfo(),!v)throw new Ce(Z.UNEXPECTED_ERROR,"can not find source config");return f.clientRequest={command:"SetSourceChannel",uid:"0",channelName:v.channelName,token:v.token||this.joinInfo.appId},f;case An.SetSourceUserId:if(v=i&&i.getSrcChannelMediaInfo(),!v)throw new Ce(Z.UNEXPECTED_ERROR,"can not find source config");return f.clientRequest={command:"SetSourceUserId",uid:v.uid+""},f;case An.SetDestChannel:if(g=i&&i.getDestChannelMediaInfo(),!g)throw new Ce(Z.UNEXPECTED_ERROR,"can not find dest config");return g.forEach(y=>{a.push(y.channelName),l.push(y.uid+""),p.push(y.token||this.joinInfo.appId)}),f.clientRequest={command:"SetDestChannel",channelName:a,uid:l,token:p},f;case An.StartPacketTransfer:return f.clientRequest={command:"StartPacketTransfer"},f;case An.Reconnect:return f.clientRequest={command:"Reconnect"},f;case An.StopPacketTransfer:return f.clientRequest={command:"StopPacketTransfer"},f;case An.UpdateDestChannel:if(g=i&&i.getDestChannelMediaInfo(),!g)throw new Ce(Z.UNEXPECTED_ERROR,"can not find dest config");return g.forEach(y=>{a.push(y.channelName),l.push(y.uid+""),p.push(y.token||this.joinInfo.appId)}),f.clientRequest={command:"UpdateDestChannel",channelName:a,uid:l,token:p},f;case An.SetVideoProfile:f.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return f}}function oS(s){var t={},i=!1;function a(l,p){return i=!0,{done:!1,value:new jb(p=new Jg(function(f){f(s[l](p))}),1)}}return t[gp!==void 0&&ZO||"@@iterator"]=function(){return this},t.next=function(l){return i?(i=!1,l):a("next",l)},typeof s.throw=="function"&&(t.throw=function(l){if(i)throw i=!1,l;return a("throw",l)}),typeof s.return=="function"&&(t.return=function(l){return i?(i=!1,l):a("return",l)}),t}var Cc=A(ok);function aS(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function vc(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?aS(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):aS(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function yk(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function $C(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?yk(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):yk(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class Pr extends pg{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var i;return xe(i=Object.keys(au)).call(i,t)}))]}constructor(t,i){super(t,i),P(this,"store",void 0),P(this,"peerConnection",void 0),P(this,"remoteSDP",void 0),P(this,"initialOffer",void 0),P(this,"statsFilter",void 0),P(this,"useRTX",!1),P(this,"localCapabilities",void 0),P(this,"localCandidateCount",0),P(this,"allCandidatesReceived",!1),P(this,"establishPromise",void 0),P(this,"mutex",new sn("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(Pr.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=KC(this.peerConnection,ce("STATS_UPDATE_INTERVAL"),void 0,Hn()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{let t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=Ud(t.sdp),a=tS(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:ce("FILTER_VIDEO_FEC"),filterAudioFec:ce("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=a,this.initialOffer=t,$C($C({},i),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:a},offerSDP:t.sdp})}catch(t){throw new Ve(Z.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,i,a,l,p,f){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(v){P(this,"sessionDesc",void 0),P(this,"localCapabilities",void 0),P(this,"rtpCapabilities",void 0),P(this,"candidates",void 0),P(this,"iceParameters",void 0),P(this,"dtlsParameters",void 0),P(this,"setup",void 0),P(this,"currentMidIndex",void 0),P(this,"cname",void 0),v=Gn(v);let{remoteIceParameters:y,remoteDtlsParameters:I,candidates:b,remoteRTPCapabilities:k,remoteSetup:U,localCapabilities:J,sdkCodec:K,cname:q}=v,te=Ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=k,this.candidates=b,this.iceParameters=y,this.dtlsParameters=I,this.setup=U,this.localCapabilities=J,this.cname=q;for(let de=0;de<te.mediaDescriptions.length;de++){let he=te.mediaDescriptions[de];if(he.attributes.iceUfrag=y.iceUfrag,he.attributes.icePwd=y.icePwd,he.attributes.fingerprints=I.fingerprints,he.attributes.candidates=b,he.attributes.setup=U,he.media.mediaType==="video"){he.media.fmts=k.videoCodecs.map(Re=>Re.payloadType.toString(10));let Ue=k.videoCodecs.filter(Re=>{var Ie,De;return(Ie=Re.rtpMap)===null||Ie===void 0?void 0:xe(De=Ie.encodingName.toLowerCase()).call(De,K)});Ue.length===0&&(Ue=k.videoCodecs),he.attributes.payloads=Ue,he.attributes.extmaps=k.videoExtensions}he.media.mediaType==="audio"&&(he.media.fmts=k.audioCodecs.map(Ue=>Ue.payloadType.toString(10)),he.attributes.payloads=k.audioCodecs,he.attributes.extmaps=k.audioExtensions),te.mediaDescriptions[de]=this.mungMediaDesc(he)}this.sessionDesc=te,this.currentMidIndex=te.mediaDescriptions.length-1}toString(){return Ci.print(this.sessionDesc)}send(v,y,I){let{ssrcs:b,ssrcGroups:k}=xo(y,this.cname),U=this.sessionDesc.mediaDescriptions.find(q=>v===We.VIDEO?q.media.mediaType==="video":q.media.mediaType==="audio"),J=b[0].attributes.label,K=b[0].attributes.mslabel;return U.attributes.ssrcs=U.attributes.ssrcs.concat(b),U.attributes.ssrcGroups=U.attributes.ssrcGroups.concat(k),{id:J,mslabel:K}}batchSend(v){return v.map(y=>{let{kind:I,ssrcMsg:b}=y;return this.send(I,b,void 0)})}stopSending(v){this.sessionDesc.mediaDescriptions.forEach(y=>{let I=[],b=[],k=[];y.attributes.ssrcs.forEach(U=>{xe(v).call(v,U.attributes.label||"")?k.push(U):I.push(U)}),y.attributes.ssrcGroups.forEach(U=>{var J;xe(J=k.map(K=>K.ssrcId)).call(J,U.ssrcIds[0])||b.push(U)}),y.attributes.ssrcs=I,y.attributes.ssrcGroups=b})}mute(v){let y=this.sessionDesc.mediaDescriptions.find(I=>I.attributes.mid===v);if(!y)throw new Error("mediaDescription not found with ".concat(v," in remote SDP when calling RemoteSDP.mute."));y.attributes.direction="inactive"}unmute(v){let y=this.sessionDesc.mediaDescriptions.find(I=>I.attributes.mid===v);if(!y)throw new Error("mediaDescription not found with ".concat(v," in remote SDP when calling RemoteSDP.unmute."));y.attributes.direction="sendonly"}receive(v,y,I){v.forEach((b,k)=>{let U=b._mediaStreamTrack,J=this.sessionDesc.mediaDescriptions.findIndex(q=>q.attributes.mid===U.kind),K=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[J],b);this.sessionDesc.mediaDescriptions[J]=K})}stopReceiving(v){}updateCandidates(v){v===vs.TCP?this.candidates.forEach(y=>{this.candidates.findIndex(I=>I.transport==="tcp"&&I.connectionAddress===y.connectionAddress&&I.port===y.port)===-1&&this.candidates.push(vc(vc({},y),{},{foundation:"tcpcandidate",priority:Number(y.priority)-1+"",transport:"tcp",port:Number(y.port)+90+""}))}):this.candidates=this.candidates.filter(y=>y.transport!=="tcp");for(let y of this.sessionDesc.mediaDescriptions)y.attributes.candidates=this.candidates}restartICE(v){v=Gn(v),this.iceParameters=v,this.sessionDesc.mediaDescriptions.forEach(y=>{y.attributes.iceUfrag=v.iceUfrag,y.attributes.icePwd=v.icePwd})}predictReceivingMids(v){let y=[];for(let I=0;I<v;I++)y.push((this.currentMidIndex+I+1).toString(10));return y}mungRecvMediaDsec(v,y){let I=Gn(v);return xd(I,y),qC(I,y),I}updateRecvMedia(v,y){let I=this.sessionDesc.mediaDescriptions.findIndex(b=>b.attributes.mid===v);if(I!==-1){let b=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[I],y);this.sessionDesc.mediaDescriptions[I]=b}}bumpMid(v){this.currentMidIndex+=v}updateTrackLabel(v,y,I){let b=this.sessionDesc.mediaDescriptions.find(U=>v===We.VIDEO?U.attributes.mid==="video":U.attributes.mid==="audio");if(b){let U=b.attributes.ssrcs.find(J=>J.attributes.label===y);var k;U&&(U.attributes.label=I,(k=U.attributes.msid)===null||k===void 0||k.replace(y,I))}}mungMediaDesc(v){let y=Gn(v);return bu(y),function(I){let b=I.attributes.extmaps.find(k=>k.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");b&&I.attributes.extmaps.splice(I.attributes.extmaps.indexOf(b),1),I.attributes.payloads.forEach(k=>{let U=k.rtcpFeedbacks.findIndex(J=>J.type==="transport-cc");U!==-1&&k.rtcpFeedbacks.splice(U,1)})}(y),y}getSSRC(v){for(let y of this.sessionDesc.mediaDescriptions)for(let I of y.attributes.ssrcs)if(I.attributes.label===v)return[I]}}({remoteIceParameters:t,remoteDtlsParameters:i,candidates:a,remoteRTPCapabilities:l.send,remoteSetup:p,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:f});let g=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:g})}catch(g){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(g.toString()))}}async updateRemoteRTPCapabilities(t,i){throw new Ve(Z.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(t,i){var a=this;return Ca(function*(){let l=yield nn(a.mutex.lock());try{if(!a.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let p=t.map(k=>a.peerConnection.addTrack(k._mediaStreamTrack)),f=yield nn(a.peerConnection.createOffer()),g=Ci.parse(f.sdp),v=t.map(k=>{let U=k._mediaStreamTrack,J=g.mediaDescriptions.find(K=>K.attributes.mid===U.kind);if(!J)throw new Error("Cannot extract ssrc from mediaDescription.");return function(K,q,te){let de=K.attributes.ssrcs.filter(Ue=>Ue.attributes.label===q),he=K.attributes.ssrcGroups;if(de.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(he&&de.length>1){let Ue=he.find(Re=>Re.ssrcIds.indexOf(de[0].ssrcId)!==-1);return Ue?[{ssrcId:Ue.ssrcIds[0],rtx:te?Ue.ssrcIds[1]:void 0}]:[{ssrcId:de[0].ssrcId}]}return[{ssrcId:de[0].ssrcId}]}(J,U.id,a.useRTX)}),y;try{y=yield v}catch(k){throw p.forEach(U=>{qt()&&U.replaceTrack(null),a.peerConnection.removeTrack(U)}),k}let I=a.mungSendOfferSDP(f.sdp,t);a.remoteSDP.receive(t,i,y);let b=a.remoteSDP.toString();return yield nn(a.peerConnection.setLocalDescription({type:"offer",sdp:I})),yield nn(a.applySendEncodings(p,t)),yield nn(a.peerConnection.setRemoteDescription({type:"answer",sdp:b})),t.map((k,U)=>{let J=k._mediaStreamTrack.id;return{localSSRC:v[U],id:J}})}catch(p){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(p.toString()))}finally{l()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let i=this.peerConnection.getSenders().filter(p=>{var f;return t.indexOf(((f=p.track)===null||f===void 0?void 0:f.id)||"")!==-1});if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(p=>{qt()&&p.replaceTrack(null),this.peerConnection.removeTrack(p)});let a=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(a),this.remoteSDP.stopReceiving(t);let l=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}}async receive(t,i,a,l){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{id:p,mslabel:f}=this.remoteSDP.send(t,i,l),g=new Pe((I,b)=>{let k=setTimeout(()=>{b(new Error("Cannot receive track, id: ".concat(p)))},1e4),U=J=>{let K=En();if((K.name==="Safari"&&Number(K.version)===11||Gs())&&J.track.id!==p&&J.streams[0].id===f){var q;let te=J.streams[0].getTracks()[0];return(q=this.remoteSDP)===null||q===void 0||q.updateTrackLabel(t,p,J.track.id),this.peerConnection.removeEventListener("track",U),clearTimeout(k),void I(te)}if(J.track.id===p)return this.peerConnection.removeEventListener("track",U),clearTimeout(k),void I(J.track)};this.peerConnection.addEventListener("track",U)}),v=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:v});let y=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(y),{track:await g,id:p}}catch(p){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(p.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a)}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getSenders().filter(a=>{var l;return t.indexOf(((l=a.track)===null||l===void 0?void 0:l.id)||"")!==-1});if(i.length!==t.length)throw new Error("sender' length doesn't match mids' length.");i.map(a=>{if(qt()&&a.track)a.track.enabled=!1;else{let l=a.getParameters();l.encodings.forEach(p=>p.active=!1),a.setParameters(l)}})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getSenders().filter(p=>{var f;return t.indexOf(((f=p.track)===null||f===void 0?void 0:f.id)||"")!==-1});if(i.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");i.map(async p=>{if(qt()&&p.track)p.track.enabled=!0;else{let f=p.getParameters();f.encodings.forEach(g=>g.active=!0),await p.setParameters(f)}});let a=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(a);let l=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return Ca(function*(){let a=yield nn(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(zn().supportPCSetConfiguration){let v=i.peerConnection.getConfiguration(),y=t===vs.RELAY?"relay":"all";v.iceTransportPolicy!==y&&(x.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(v.iceTransportPolicy,"] to [").concat(y,"]")),v.iceTransportPolicy=y,i.peerConnection.setConfiguration(v))}else if(t===vs.RELAY)return;t!==vs.RELAY&&i.remoteSDP.updateCandidates(t);let l=yield nn(i.peerConnection.createOffer({iceRestart:!0}));if(!l.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let p=Ud(l.sdp),{remoteIceParameters:f}=yield p.iceParameters;i.remoteSDP.restartICE(f);let g=i.remoteSDP.toString();yield nn(i.peerConnection.setLocalDescription(l)),yield nn(i.peerConnection.setRemoteDescription({type:"answer",sdp:g}))}catch(l){x.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),l)}finally{a()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let a=await this.peerConnection.createOffer(),l=this.mungSendOfferSDP(a.sdp,[i]);this.remoteSDP.updateRecvMedia(i._mediaStreamTrack.kind,i);let p=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(a){throw new Ve(Z.EXCHANGE_SDP_FAILED,a.toString())}}async updateSendParameters(t,i){let a=this.peerConnection.getSenders().filter(l=>{var p;return((p=l.track)===null||p===void 0?void 0:p.id)===t});a.length===1&&await this.applySendEncodings(a,[i])}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let a=this.peerConnection.getSenders().find(l=>{var p;return((p=l.track)===null||p===void 0?void 0:p.id)===i});a&&await a.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,i){throw new Ve(Z.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new Ve(Z.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,x.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,x.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},ce("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){let i={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(nh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...Pr.turnServerConfigToIceServers(t.turnServer.servers)),ce("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...Pr.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(a=>{a.security?a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}):(a.udpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.udpport,"?transport=udp")}),a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}))}),i}async updateRtpSenderEncodings(t,i){var a;if(i||(i=this.peerConnection.getSenders().find(y=>{var I;return((I=y.track)===null||I===void 0?void 0:I.id)===t._mediaStreamTrack.id})),!i)return x.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!zn().supportSetRtpSenderParameters)return x.warn("Browser not support set rtp-sender parameters");let l={},p={};if(t instanceof jt)switch(t._optimizationMode){case"motion":l.degradationPreference="maintain-framerate";break;case"detail":l.degradationPreference="maintain-resolution";break;default:l.degradationPreference="balanced"}if(ce("DSCP_TYPE")&&Ql()){var f;let y=ce("DSCP_TYPE");xe(f=["very-low","low","medium","high"]).call(f,y)&&(p.networkPriority=y)}let g=i.getParameters(),v=(a=g.encodings)===null||a===void 0?void 0:a[0];v&&Object.assign(v,p),Object.assign(g,l),x.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(g.encodings))),await i.setParameters(g)}async applySendEncodings(t,i){try{if(!zn().supportSetRtpSenderParameters||t.length!==i.length)return;for(let a=0;a<t.length;a++){let l=t[a],p=i[a];l&&p&&await this.updateRtpSenderEncodings(p,l)}}catch{x.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i){let a=Ci.parse(t);return i.forEach((l,p)=>{let f=l._mediaStreamTrack,g=a.mediaDescriptions.find(v=>v.attributes.mid===f.kind);g&&xd(g,l)}),Ci.print(a)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,a)=>{var l;(l=this.onFirstVideoDecoded)===null||l===void 0||l.call(this,t,i,a)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var a;(a=this.onSelectedLocalCandidateChanged)===null||a===void 0||a.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var a;(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0||a.call(this,t,i)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let i=this.remoteSDP.batchSend(t).map((p,f)=>{let{id:g,mslabel:v}=p,{kind:y}=t[f];return new Pe((I,b)=>{let k=setTimeout(()=>{b(new Error("Cannot receive track, id: ".concat(g)))},1e4),U=J=>{let K=En();if(K.name==="Safari"&&Number(K.version)===11&&J.track.id!==g&&J.streams[0].id===v){var q;let te=J.streams[0].getTracks()[0];return(q=this.remoteSDP)===null||q===void 0||q.updateTrackLabel(y,g,J.track.id),this.peerConnection.removeEventListener("track",U),clearTimeout(k),void I({track:te,id:g})}if(J.track.id===g)return this.peerConnection.removeEventListener("track",U),clearTimeout(k),void I({track:J.track,id:g})};this.peerConnection.addEventListener("track",U)})}),a=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:a});let l=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(l),await Pe.all(i)}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(t);return i==null?void 0:i[0].ssrcId}setConfiguration(t){if(zn().supportPCSetConfiguration){let i=Pr.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}}function vo(s,t,i){let a=s[t];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let l=this.mutex,p=await l.lock("Locking from P2PConnection.".concat(t));try{for(var f=arguments.length,g=new Array(f),v=0;v<f;v++)g[v]=arguments[v];return await a.apply(this,g)}finally{p()}},i}function id(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Mh(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?id(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):id(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}Be([vo,Y("design:type",Function),Y("design:paramtypes",[Object,Object,Array,Object,String,String]),Y("design:returntype",Pe)],Pr.prototype,"connect",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Pr.prototype,"stopSending",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[String,Array,String,Object]),Y("design:returntype",Pe)],Pr.prototype,"receive",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Pr.prototype,"stopReceiving",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Pr.prototype,"muteRemote",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Pr.prototype,"unmuteRemote",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Pr.prototype,"muteLocal",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Pr.prototype,"unmuteLocal",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Pr.prototype,"close",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],Pr.prototype,"updateEncoderConfig",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],Pr.prototype,"updateSendParameters",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[tn,String]),Y("design:returntype",Pe)],Pr.prototype,"replaceTrack",null),Be([vo,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Pr.prototype,"getRemoteSSRC",null);let cS="9",yl=4e4;function Ik(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Ff(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Ik(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Ik(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class zi extends pg{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,i;return(t=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var i;return xe(i=Object.keys(au)).call(i,t)}))]}constructor(t,i){super(t,i),P(this,"store",void 0),P(this,"peerConnection",void 0),P(this,"remoteSDP",void 0),P(this,"initialOffer",void 0),P(this,"transportEventReceiver",void 0),P(this,"statsFilter",void 0),P(this,"useXR",ce("USE_XR")),P(this,"localCapabilities",void 0),P(this,"remoteCodecs",void 0),P(this,"localCandidateCount",0),P(this,"allCandidatesReceived",!1),P(this,"dataStreamChannelMap",new Map),P(this,"establishPromise",void 0),P(this,"mutex",new sn("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(zi.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=KC(this.peerConnection,ce("STATS_UPDATE_INTERVAL"),void 0,Hn()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(t,i){if(this.remoteCodecs=i,!this.remoteSDP)return void x.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(t,i,this.store.codec)){let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a);let p=this.remoteSDP.toString();l==null||l(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}else x.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=Ud(t.sdp),a=await Ba({filterRTX:!ce("USE_PUB_RTX")&&!ce("USE_SUB_RTX"),filterVideoFec:ce("FILTER_VIDEO_FEC"),filterAudioFec:ce("FILTER_AUDIO_FEC"),filterVideoCodec:ce("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=xf(a),this.initialOffer=t,Ff(Ff({},i),{},{rtpCapabilities:a,offerSDP:t.sdp})}catch(t){throw new Ve(Z.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,i,a,l,p,f){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return Gn(this._localCapabilities)}get rtpCapabilities(){return Gn(this._rtpCapabilities)}get candidates(){return Gn(this._candidates)}get iceParameters(){return Gn(this._iceParameters)}get dtlsParameters(){return Gn(this._dtlsParameters)}constructor(U){P(this,"sessionDesc",void 0),P(this,"_localCapabilities",void 0),P(this,"_rtpCapabilities",void 0),P(this,"_candidates",void 0),P(this,"_iceParameters",void 0),P(this,"_dtlsParameters",void 0),P(this,"setup",void 0),P(this,"currentMidIndex",void 0),P(this,"cname",void 0),P(this,"firefoxSsrcMidMap",new Map),U=Gn(U);let{remoteIceParameters:J,remoteDtlsParameters:K,candidates:q,remoteRTPCapabilities:te,remoteSetup:de,localCapabilities:he,cname:Ue}=U,Re=Ci.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=te,this._candidates=q,this._iceParameters=J,this._dtlsParameters=K,this._localCapabilities=he,this.setup=de,this.cname=Ue;let Ie=this.rtpCapabilities.send;for(let De of Re.mediaDescriptions){if(De.attributes.iceUfrag=J.iceUfrag,De.attributes.icePwd=J.icePwd,De.attributes.fingerprints=K.fingerprints,De.attributes.candidates=q,De.attributes.setup=de,De.media.mediaType==="video"&&(De.media.fmts=Ie.videoCodecs.map(Ne=>Ne.payloadType.toString(10)),De.attributes.payloads=Ie.videoCodecs,De.attributes.extmaps=Ie.videoExtensions,ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:Ne,ssrcGroups:Xe}=xo([{ssrcId:yl,rtx:ce("USE_SUB_RTX")?40001:void 0}],this.cname);De.attributes.ssrcs=Ne,De.attributes.ssrcGroups=Xe}if(De.media.mediaType==="audio"&&(De.media.fmts=Ie.audioCodecs.map(Ne=>Ne.payloadType.toString(10)),De.attributes.payloads=Ie.audioCodecs,De.attributes.extmaps=Ie.audioExtensions,Vd(De),ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:Ne,ssrcGroups:Xe}=xo([{ssrcId:2e4}],this.cname);De.attributes.ssrcs=Ne,De.attributes.ssrcGroups=Xe}}this.sessionDesc=Re,this.currentMidIndex=Re.mediaDescriptions.length-1}preloadRemoteMedia(){let U=ce("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;let J=this.candidates,K=this.dtlsParameters,q=this.iceParameters,te=this.rtpCapabilities.send;for(let de=1;de<U;de++){let he=2*de+2e4,Ue=2*de+yl,{ssrcs:Re,ssrcGroups:Ie}=xo([{ssrcId:he}],this.cname),{ssrcs:De,ssrcGroups:Ne}=xo([{ssrcId:Ue,rtx:ce("USE_SUB_RTX")?Ue+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:cS,protos:["UDP","TLS","RTP","SAVPF"],fmts:te.videoCodecs.map(Xe=>Xe.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:q.iceUfrag,icePwd:q.icePwd,unrecognized:[],candidates:J,extmaps:te.videoExtensions,fingerprints:K.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:De,ssrcGroups:Ne,rtcpFeedbackWildcards:[],payloads:te.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*de)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:cS,protos:["UDP","TLS","RTP","SAVPF"],fmts:te.audioCodecs.map(Xe=>Xe.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:q.iceUfrag,icePwd:q.icePwd,unrecognized:[],candidates:J,extmaps:te.audioExtensions,fingerprints:K.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:Re,ssrcGroups:Ie,rtcpFeedbackWildcards:[],payloads:te.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*de+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Ci.print(this.sessionDesc)}send(U,J,K,q){let{ssrcs:te,ssrcGroups:de}=xo(J,this.cname,ce("SYNC_GROUP")?K:void 0),he=this.findPreloadMediaDesc(te);if(he){if(Hn()&&this.firefoxSsrcMidMap.set(te[0].ssrcId,he.attributes.mid),q&&(q.twcc||q.remb)){let Ue=this.sessionDesc.mediaDescriptions.indexOf(he);return this.sessionDesc.mediaDescriptions[Ue]=this.mungSendMediaDesc(he,q),{mid:he.attributes.mid,needExchangeSDP:!0}}return{mid:he.attributes.mid,needExchangeSDP:!1}}{let Ue=this.findAvailableMediaIndex(U,te),Re;return Ue===-1||Ue===1&&(qt()||tl())||Ue===0&&ce("USE_SUB_RTX")||Jr()?(Re=this.createOrRecycleSendMedia(U,te,de,"sendonly",q),this.updateBundleMids()):(Re=Gn(this.sessionDesc.mediaDescriptions[Ue]),Re.attributes.direction="sendonly",Re.attributes.ssrcs=te,Re.attributes.ssrcGroups=de,this.sessionDesc.mediaDescriptions[Ue]=this.mungSendMediaDesc(Re,q)),Hn()&&this.firefoxSsrcMidMap.set(te[0].ssrcId,Re.attributes.mid),{mid:Re.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:U,needExchangeSDP:J}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:U.attributes.mid,needExchangeSDP:J}}batchSend(U){let J=U.map(te=>{let{kind:de,ssrcMsg:he,mslabel:Ue}=te;return this.send(de,he,Ue)}),K=[],q=!1;return J.forEach(te=>{let{mid:de,needExchangeSDP:he}=te;he&&(q=!0),K.push(de)}),{mids:K,needExchangeSDP:q}}stopSending(U){let J=this.sessionDesc.mediaDescriptions.filter(K=>K.attributes.mid&&U.indexOf(K.attributes.mid)!==-1);if(J.length!==U.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");J.forEach(K=>{K.attributes.mid==="0"||Hn()||Jr()?K.attributes.ssrcs=[]:(K.attributes.ssrcs=[],K.attributes.direction="inactive",K.media.port="0")}),this.updateBundleMids()}mute(U){let J=this.sessionDesc.mediaDescriptions.find(K=>K.attributes.mid===U);if(!J)throw new Error("mediaDescription not found with ".concat(U," in remote SDP when calling RemoteSDP.mute."));J.attributes.direction="inactive"}unmute(U){let J=this.sessionDesc.mediaDescriptions.find(K=>K.attributes.mid===U);if(!J)throw new Error("mediaDescription not found with ".concat(U," in remote SDP when calling RemoteSDP.unmute."));J.attributes.direction="sendonly"}muteRemote(U){let J=this.sessionDesc.mediaDescriptions.filter(K=>xe(U).call(U,K.attributes.mid||""));if(J.length!==U.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");J.forEach(K=>{K.attributes.direction="inactive"})}unmuteRemote(U){let J=this.sessionDesc.mediaDescriptions.filter(K=>xe(U).call(U,K.attributes.mid||""));if(J.length!==U.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");J.forEach(K=>{K.attributes.direction="recvonly"})}receive(U,J,K,q){U.forEach((te,de)=>{this.createOrRecycleRecvMedia(te,[],"recvonly",J,K,q[de])}),this.updateBundleMids()}stopReceiving(U){let J=this.sessionDesc.mediaDescriptions.filter(K=>U.indexOf(K.attributes.mid)!==-1);if(J.length!==U.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");J.forEach(K=>{K.media.port="0",K.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(U){let J=this._candidates.filter(K=>K.transport==="udp");if(U===vs.TCP){if(J.length===0)return;if(ce("TCP_CANDIDATE_ONLY")){let K=this._candidates.filter(q=>q.transport==="tcp");J.forEach(q=>{K.findIndex(te=>te.connectionAddress===q.connectionAddress)===-1&&K.push(Mh(Mh({},q),{},{foundation:"tcpcandidate",priority:Number(q.priority)-1+"",transport:"tcp",port:Number(q.port)+90+""}))}),this._candidates=K}else{let K=[];J.forEach(q=>{K.push(Mh(Mh({},q),{},{foundation:"tcpcandidate",priority:Number(q.priority)-1+"",transport:"tcp",port:Number(q.port)+90+""}))}),this._candidates=[...J,...K]}}else if(U===vs.RELAY){if(J.length!==0)return;{let K=this._candidates.filter(q=>q.transport==="tcp");K.forEach(q=>{J.push(Mh(Mh({},q),{},{foundation:"udpcandidate",priority:Number(q.priority)+1+"",transport:"udp",port:Number(q.port)-90+""}))}),this._candidates=[...J,...K]}}else J.length===0?(this._candidates.filter(K=>K.transport==="tcp").forEach(K=>{J.push(Mh(Mh({},K),{},{foundation:"udpcandidate",priority:Number(K.priority)+1+"",transport:"udp",port:Number(K.port)-90+""}))}),this._candidates=J):this._candidates=this._candidates.filter(K=>K.transport!=="tcp");for(let K of this.sessionDesc.mediaDescriptions)K.attributes.candidates=this.candidates}restartICE(U){U=Gn(U),this._iceParameters=U,this.sessionDesc.mediaDescriptions.forEach(J=>{J.attributes.iceUfrag=U.iceUfrag,J.attributes.icePwd=U.icePwd})}predictReceivingMids(U){let J=[];for(let K=0;K<U;K++)J.push((this.currentMidIndex+K+1).toString(10));return J}findAvailableMediaIndex(U,J){return this.sessionDesc.mediaDescriptions.findIndex(K=>{let q=K.media.mediaType===U&&K.media.port!=="0"&&(K.attributes.direction==="sendonly"||K.attributes.direction==="sendrecv")&&K.attributes.ssrcs.length===0;if(Hn()){if(q){let te=this.firefoxSsrcMidMap.get(J[0].ssrcId);return!(te||K.attributes.mid!=="0"&&K.attributes.mid!=="1")||!(!te||te!==K.attributes.mid)}return!1}return q})}createOrRecycleDataChannel(){for(let K of this.sessionDesc.mediaDescriptions)if(K.media.mediaType==="application")return{mediaDesc:K,needExchangeSDP:!1};this.currentMidIndex+=1;let U="".concat(this.currentMidIndex),J={media:{mediaType:"application",port:cS,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(U),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(J),{mediaDesc:J,needExchangeSDP:!0}}createOrRecycleRecvMedia(U,J,K,q,te,de){let he=U._mediaStreamTrack.kind,Ue=this.rtpCapabilities.recv,Re=Ou(he,Ue,this.localCapabilities.send,he===We.VIDEO?q:te),Ie=he===We.VIDEO?Ue.videoExtensions:Ue.audioExtensions;this.currentMidIndex+=1;let De="".concat(this.currentMidIndex),Ne={media:{mediaType:he,port:cS,protos:["UDP","TLS","RTP","SAVPF"],fmts:Re.map(nt=>nt.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:Ie,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:J,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:Re,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:K,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(De)}};Ne=this.mungRecvMediaDsec(Ne,U,de);let Xe=this.findFirstClosedMedia(he);if(Xe){let nt=this.sessionDesc.mediaDescriptions.indexOf(Xe);this.sessionDesc.mediaDescriptions[nt]=Ne}else this.sessionDesc.mediaDescriptions.push(Ne);return Ne}updateRemoteCodec(U,J,K){let q=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(Ne=>Ne.rtpMap&&Ne.rtpMap.encodingName.toLowerCase()||"").filter(Ne=>{var Xe;return xe(Xe=Object.keys(au)).call(Xe,Ne)}))],te=new Set(J);if(q.every(Ne=>te.has(Ne)))return x.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(J)),!1;let de=this._rtpCapabilities.recv.videoCodecs.filter(Ne=>J.some(Xe=>{var nt;return xe(nt=Ne.rtpMap&&Ne.rtpMap.encodingName.toLowerCase()||"").call(nt,Xe)}));if(de.length===0)return x.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(q," codecs: ").concat(J)),!1;let he=[...new Set(de.map(Ne=>Ne.rtpMap&&Ne.rtpMap.encodingName.toLowerCase()||""))],Ue;if(x.debug("updateRemoteCodec, from ".concat(q," to ").concat(he)),U.length===0)Ue=this.sessionDesc.mediaDescriptions.filter(Ne=>Ne.media.mediaType==="video"&&Ne.attributes.direction==="recvonly");else if(Ue=this.sessionDesc.mediaDescriptions.filter(Ne=>Ne.attributes.mid&&xe(U).call(U,Ne.attributes.mid)&&Ne.attributes.direction==="recvonly"),Ue.length!==U.length)return x.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(U,", codecs: ").concat(J)),!1;this._rtpCapabilities.recv.videoCodecs=de;let Re=this.localCapabilities.send,Ie=this.rtpCapabilities.recv,De=Ou(We.VIDEO,Ie,Re,K);return Ue.forEach(Ne=>{let Xe=De.map(nt=>nt.payloadType.toString(10));x.debug("updateRemoteCodec mid: ".concat(Ne.attributes.mid,", from ").concat(Ne.attributes.payloads," to ").concat(De)),Ne.attributes.payloads=De,Ne.media.fmts=Xe}),!0}createOrRecycleSendMedia(U,J,K,q,te){let de=this.rtpCapabilities.send,he=U===We.VIDEO?de.videoCodecs:de.audioCodecs,Ue=U===We.VIDEO?de.videoExtensions:de.audioExtensions;this.currentMidIndex+=1;let Re="".concat(this.currentMidIndex),Ie={media:{mediaType:U,port:cS,protos:["UDP","TLS","RTP","SAVPF"],fmts:he.map(Ne=>Ne.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:Ue,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:J,ssrcGroups:K,rtcpFeedbackWildcards:[],payloads:he,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:q,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(Re)}};Ie=this.mungSendMediaDesc(Ie,te);let De=this.findFirstClosedMedia(U);if(De){let Ne=this.sessionDesc.mediaDescriptions.indexOf(De);this.sessionDesc.mediaDescriptions[Ne]=Ie}else this.sessionDesc.mediaDescriptions.push(Ie);return Ie}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(U=>U.media.port!=="0").map(U=>U.attributes.mid)}mungRecvMediaDsec(U,J,K){let q=Gn(U);return bu(q),xd(q,J),qC(q,J),qb(q),hm(q,K,this.localCapabilities.send),q}mungSendMediaDesc(U,J){let K=Gn(U);return hm(K,J,this.localCapabilities.recv),Vd(K),K}updateRecvMedia(U,J){let K=this.sessionDesc.mediaDescriptions.findIndex(q=>q.attributes.mid===U);if(K!==-1){let q=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[K],J);this.sessionDesc.mediaDescriptions[K]=q}}bumpMid(U){this.currentMidIndex+=U}findFirstClosedMedia(U){return this.sessionDesc.mediaDescriptions.find(J=>Hn()?J.media.port==="0"&&J.media.mediaType===U:J.media.port==="0")}findPreloadMediaDesc(U){return this.sessionDesc.mediaDescriptions.find(J=>{var K;return((K=J.attributes)===null||K===void 0||(K=K.ssrcs[0])===null||K===void 0?void 0:K.ssrcId)===U[0].ssrcId})}getSSRC(U){var J;return(J=this.sessionDesc.mediaDescriptions.find(K=>K.attributes.mid===U))===null||J===void 0?void 0:J.attributes.ssrcs}}({remoteIceParameters:t,remoteDtlsParameters:i,candidates:a,remoteRTPCapabilities:l,remoteSetup:p,localCapabilities:this.localCapabilities,cname:f}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let g=this.remoteSDP.toString(),v=Ci.parse(this.initialOffer.sdp),y=v.mediaDescriptions.find(U=>U.media.mediaType==="audio");y&&Vd(y),this.useXR&&iS(v);let I=Ci.print(v),b=this.logSDPExchange(I||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:I}),b==null||b(g),await this.peerConnection.setRemoteDescription({type:"answer",sdp:g});let k=this.peerConnection.getTransceivers()[0];if(k!=null&&k.receiver&&this.tryBindTransportEvents(k.receiver),ce("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();let U=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:U});let J=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(J)}}catch(g){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(g.toString()))}}send(t,i,a){var l=this;return Ca(function*(){let p=yield nn(l.mutex.lock("From P2PConnection.send"));try{if(!l.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let f=[];t.forEach(K=>{let q=l.peerConnection.addTransceiver(K._mediaStreamTrack,{direction:"sendonly"});f.push(q),K._updateRtpTransceiver(q)}),Hn()&&ce("SIMULCAST")===!0&&(yield nn(l.applySimulcastForFirefox(f,t)));let g=yield nn(l.peerConnection.createOffer()),v=l.remoteSDP.predictReceivingMids(t.length),y=l.mungSendOfferSDP(g.sdp,t,v),I=Ci.parse(y),b=v.map(K=>{let q=I.mediaDescriptions.find(te=>te.attributes.mid===K);if(!q)throw new Error("Cannot extract ssrc from mediaDescription.");return YC(q,ce("USE_PUB_RTX"))}),k;try{k=yield b}catch(K){k=[],l.remoteSDP.receive(t,i,a,k);let q=l.remoteSDP.toString();throw yield nn(l.peerConnection.setLocalDescription({type:"offer",sdp:y})),yield nn(l.peerConnection.setRemoteDescription({type:"answer",sdp:q})),yield nn(l.stopSending(v,!0)),K}l.remoteSDP.receive(t,i,a,k);let U=l.remoteSDP.toString(),J=l.logSDPExchange(y,"offer","local","send");return yield nn(l.peerConnection.setLocalDescription({type:"offer",sdp:y})),yield nn(l.applySimulcastEncodings(f,t)),yield nn(l.applySendEncodings(f,t)),J==null||J(U),yield nn(l.peerConnection.setRemoteDescription({type:"answer",sdp:U})),f.map((K,q)=>{let te=v[q];return{localSSRC:b[q],id:te,transceiver:K}})}catch(f){throw f instanceof Ve?f:new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(f.toString()))}finally{p()}})()}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let a=this.dataStreamChannelMap.get(t);a&&a.readyState==="open"?x.debug("[P2PConnection] Channels are already available and can be reused directly."):(a=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:ce("DATASTREAM_MAX_RETRANSMITS")}),a.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,a)),i.forEach(p=>{p._updateOriginDataChannel(a)});let{needExchangeSDP:l}=this.remoteSDP.sendDataChannel();if(l){let p=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:p});let f=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(f),x.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else x.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(a){throw a instanceof Ve?a:new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(a.toString()))}}async stopDataChannels(t){try{let i=this.dataStreamChannelMap.get(t);return i==null||i.close(),void this.dataStreamChannelMap.delete(t)}catch(i){throw i instanceof Ve?i:new Ve(Z.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(i.toString()))}}async stopSending(t,i){let a=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let l=this.peerConnection.getTransceivers().filter(v=>t.indexOf(v.mid)!==-1);if(l.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");l.map(v=>{var y;v.direction="inactive",(y=v.stop)===null||y===void 0||y.call(v)});let p=await this.peerConnection.createOffer(),f=this.logSDPExchange(p.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(p),this.remoteSDP.stopReceiving(t);let g=this.remoteSDP.toString();f==null||f(g),await this.peerConnection.setRemoteDescription({type:"answer",sdp:g})}catch(l){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(l.toString()))}finally{a&&a()}}async receive(t,i,a,l){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{mid:p,needExchangeSDP:f}=this.remoteSDP.send(t,i,a,l);if(f){let v=this.remoteSDP.toString(),y=this.logSDPExchange(v,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:v});let I=await this.peerConnection.createAnswer(),b=this.mungReceiveAnswerSDP(I.sdp,p,t);y==null||y(b||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:b}),x.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else x.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));let g=this.peerConnection.getTransceivers().find(v=>v.mid===p);if(!g)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:g.receiver.track,id:p,transceiver:g}}catch(p){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(p.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:i,needExchangeSDP:a}=this.remoteSDP.batchSend(t);if(a){let l=this.remoteSDP.toString(),p=this.logSDPExchange(l,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:l});let f=await this.peerConnection.createAnswer();p==null||p(f.sdp||""),await this.peerConnection.setLocalDescription(f),x.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else x.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return i.map(l=>{let p=this.peerConnection.getTransceivers().find(f=>f.mid===l);if(!p)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:p.receiver.track,id:l,transceiver:p}})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let l=await this.peerConnection.createAnswer();a==null||a(l.sdp||""),await this.peerConnection.setLocalDescription(l)}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);let i=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let l=await this.peerConnection.createAnswer();a==null||a(l.sdp||""),await this.peerConnection.setLocalDescription(l)}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);let i=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let l=await this.peerConnection.createAnswer();a==null||a(l.sdp||""),await this.peerConnection.setLocalDescription(l)}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(f=>f.mid&&t.indexOf(f.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(f=>{f.direction="inactive"});let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.muteRemote(t);let p=this.remoteSDP.toString();l==null||l(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(f=>f.mid&&t.indexOf(f.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(f,g)=>{f.direction="sendonly"});let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.unmuteRemote(t);let p=this.remoteSDP.toString();l==null||l(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(i){throw new Ve(Z.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return Ca(function*(){let a=yield nn(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(zn().supportPCSetConfiguration){let y=i.peerConnection.getConfiguration(),I=t===vs.RELAY?"relay":"all";y.iceTransportPolicy!==I&&(x.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(y.iceTransportPolicy,"] to [").concat(I,"]")),y.iceTransportPolicy=I,i.peerConnection.setConfiguration(y))}else if(t===vs.RELAY)return;i.remoteSDP.updateCandidates(t);let l=yield nn(i.peerConnection.createOffer({iceRestart:!0}));if(!l.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let p=Ud(l.sdp),{remoteIceParameters:f}=yield p.iceParameters;i.remoteSDP.restartICE(f);let g=i.remoteSDP.toString(),v=i.logSDPExchange(l.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield nn(i.peerConnection.setLocalDescription(l)),v==null||v(g),yield nn(i.peerConnection.setRemoteDescription({type:"answer",sdp:g}))}catch(l){x.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),l)}finally{a()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let a=await this.peerConnection.createOffer(),l=this.mungSendOfferSDP(a.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);let p=this.remoteSDP.toString(),f=this.logSDPExchange(l,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),f==null||f(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(a){throw new Ve(Z.EXCHANGE_SDP_FAILED,a.toString())}}async updateSendParameters(t,i){let a=this.peerConnection.getTransceivers().filter(l=>l.mid===t);a.length===1&&(this.isVP8Simulcast(i)?Hn()||await this.applySimulcastEncodings(a,[i]):await this.applySendEncodings(a,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let a=this.peerConnection.getTransceivers().find(l=>l.mid===i);a&&await a.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){let t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){let i=t[0].transport.iceTransport,{local:a,remote:l}=i.getSelectedCandidatePair();return{local:Ff(Ff({},Md),{},{candidateType:a.type,protocol:a.protocol,address:a.address,port:a.port}),remote:Ff(Ff({},Md),{},{candidateType:l.type,protocol:l.protocol,address:l.address,port:l.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,x.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,x.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},ce("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){let i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(nh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...zi.turnServerConfigToIceServers(t.turnServer.servers)),ce("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...zi.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),ce("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(i.iceTransportPolicy="relay")}))),ce("ENABLE_ENCODED_TRANSFORM")&&zn().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(a=>{a.security?a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(hl(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}):(a.udpport&&!ce("FORCE_TURN_TCP")&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.udpport,"?transport=udp")}),a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}))}),i}tryBindTransportEvents(t){let i=t.transport;if(i){this.transportEventReceiver=t,i.onstatechange=()=>{var l;i!=null&&i.state&&((l=this.onDTLSTransportStateChange)===null||l===void 0||l.call(this,i.state))},i.onerror=l=>{var p;(p=this.onDTLSTransportError)===null||p===void 0||p.call(this,"error"in l?l.error:l)};let a=i.iceTransport;a&&(a.onstatechange=()=>{let l=i==null?void 0:i.iceTransport.state;var p;l&&((p=this.onICETransportStateChange)===null||p===void 0||p.call(this,l))},a.getSelectedCandidatePair&&(a.onselectedcandidatepairchange=()=>{if(a.getSelectedCandidatePair()){let{local:l,remote:p}=a.getSelectedCandidatePair();x.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:l.type,protocol:l.protocol}),", remote ").concat(JSON.stringify({candidateType:p.type,protocol:p.protocol,address:p.address,port:p.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var a;if(i||(i=this.peerConnection.getSenders().find(I=>I.track===t._mediaStreamTrack)),!i)return x.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return x.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!zn().supportSetRtpSenderParameters)return x.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let l={},p={};switch(t._optimizationMode){case"motion":l.degradationPreference="maintain-framerate";break;case"detail":l.degradationPreference="maintain-resolution";break;default:l.degradationPreference="balanced"}if(t._encoderConfig){var f;let{bitrateMax:I,frameRate:b,scaleResolutionDownBy:k}=t._encoderConfig;I&&(p.maxBitrate=1e3*I),(xe(f=t._hints).call(f,Un.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(b&&(p.maxFramerate=zo(b)),k&&k>=1&&(p.scaleResolutionDownBy=k))}if(ce("DSCP_TYPE")&&Ql()){var g;let I=ce("DSCP_TYPE");xe(g=["very-low","low","medium","high"]).call(g,I)&&(p.networkPriority=I)}let v=i.getParameters(),y=(a=v.encodings)===null||a===void 0?void 0:a[0];Hn()&&!y&&(l.encodings=[p]),y&&Object.assign(y,p),Object.assign(v,l),x.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(v.encodings))),await i.setParameters(v)}async applySendEncodings(t,i){try{if(!zn().supportSetRtpSenderParameters||t.length!==i.length)return;for(let a=0;a<t.length;a++){let l=t[a],p=i[a];p instanceof jt&&!this.isVP8Simulcast(p)&&await this.updateRtpSenderEncodings(p,l.sender)}}catch{x.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i,a){let l=Ci.parse(t);return i.forEach((p,f)=>{let g=a[f],v=l.mediaDescriptions.find(y=>y.attributes.mid===g);v&&(xd(v,p),nS(v,p,this.store.codec))}),Ci.print(l)}mungReceiveAnswerSDP(t,i,a){let l=Ci.parse(t),p=l.mediaDescriptions.find(f=>f.attributes.mid===i);return p&&(a===We.AUDIO&&p.media.mediaType==="audio"&&Vd(p),this.useXR&&iS(l)),Ci.print(l)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,a)=>{var l;(l=this.onFirstVideoDecoded)===null||l===void 0||l.call(this,t,i,a)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var a;(a=this.onSelectedLocalCandidateChanged)===null||a===void 0||a.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var a;(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0||a.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let v=0;v<t.length;v++){var a,l,p,f,g;let y=t[v],I=i[v];if(I instanceof jt&&!xe(a=I._hints).call(a,Un.LOW_STREAM)&&(l=I._encoderConfig)!==null&&l!==void 0&&l.bitrateMax&&((p=I._encoderConfig)===null||p===void 0?void 0:p.bitrateMax)>200&&(f=I._scalabilityMode)!==null&&f!==void 0&&f.numSpatialLayers&&((g=I._scalabilityMode)===null||g===void 0?void 0:g.numSpatialLayers)>1&&this.store.codec==="vp8"){let b={},k={high:1e3*(I._encoderConfig.bitrateMax-50),medium:5e4};b.encodings=[{rid:"m",active:!0,maxBitrate:k.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:k.high}];let U=y.sender.getParameters();await y.sender.setParameters(Object.assign(U,b))}}}async applySimulcastEncodings(t,i){if(!Hn()&&t.length===i.length)for(let a=0;a<t.length;a++){let l=i[a];if(l instanceof jt&&this.isVP8Simulcast(l)){let p=t[a],f={},g={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};f.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:g.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:g.medium,scaleResolutionDownBy:4}];let v=p.sender.getParameters();await p.sender.setParameters(Object.assign(v,f))}}}isVP8Simulcast(t){var i,a,l,p,f;return!!(t instanceof jt&&ce("SIMULCAST")&&this.store.codec==="vp8"&&!xe(i=t._hints).call(i,Un.LOW_STREAM)&&(a=t._encoderConfig)!==null&&a!==void 0&&a.bitrateMax&&((l=t._encoderConfig)===null||l===void 0?void 0:l.bitrateMax)>200&&(p=t._scalabilityMode)!==null&&p!==void 0&&p.numSpatialLayers&&((f=t._scalabilityMode)===null||f===void 0?void 0:f.numSpatialLayers)>1)}logSDPExchange(t,i,a,l){if(ce("SDP_LOGGING"))return x.upload("[".concat(this.store.clientId,"] exchanging ").concat(a," ").concat(i," SDP during P2PConnection.").concat(l,`
`),t),i==="offer"?p=>{this.logSDPExchange(p,"answer",a==="local"?"remote":"local",l)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(t);return i==null?void 0:i[0].ssrcId}setConfiguration(t){if(zn().supportPCSetConfiguration){let i=zi.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}}function Zo(s,t,i){let a=s[t];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let l=this.mutex,p=await l.lock("From P2PConnection.".concat(t));try{for(var f=arguments.length,g=new Array(f),v=0;v<f;v++)g[v]=arguments[v];return await a.apply(this,g)}finally{p()}},i}function Ak(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function dS(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Ak(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Ak(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}Be([Zo,Y("design:type",Function),Y("design:paramtypes",[Array,Array]),Y("design:returntype",Pe)],zi.prototype,"updateRemoteRTPCapabilities",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[Object,Object,Array,Object,String,String]),Y("design:returntype",Pe)],zi.prototype,"connect",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[Object,Array]),Y("design:returntype",Pe)],zi.prototype,"createDataChannels",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[String,Array,String,Object]),Y("design:returntype",Pe)],zi.prototype,"receive",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],zi.prototype,"batchReceive",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],zi.prototype,"stopReceiving",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],zi.prototype,"muteRemote",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],zi.prototype,"unmuteRemote",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],zi.prototype,"muteLocal",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],zi.prototype,"unmuteLocal",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],zi.prototype,"close",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],zi.prototype,"updateEncoderConfig",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],zi.prototype,"updateSendParameters",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[tn,String]),Y("design:returntype",Pe)],zi.prototype,"replaceTrack",null),Be([Zo,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],zi.prototype,"getRemoteSSRC",null);let wk=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,ev="9",mm=2e4,lS=4e4;class tv{get localCapabilities(){return Gn(this._localCapabilities)}get rtpCapabilities(){return Gn(this._rtpCapabilities)}get candidates(){return Gn(this._candidates)}get iceParameters(){return Gn(this._iceParameters)}get dtlsParameters(){return Gn(this._dtlsParameters)}constructor(t){P(this,"sessionDesc",void 0),P(this,"_localCapabilities",void 0),P(this,"_rtpCapabilities",void 0),P(this,"_candidates",void 0),P(this,"_iceParameters",void 0),P(this,"_dtlsParameters",void 0),P(this,"setup",void 0),P(this,"currentMidIndex",void 0),P(this,"cname",void 0),P(this,"firefoxSsrcMidMap",new Map),t=Gn(t);let{remoteIceParameters:i,remoteDtlsParameters:a,candidates:l,remoteRTPCapabilities:p,remoteSetup:f,localCapabilities:g,cname:v}=t,y=Ci.parse(wk);this._rtpCapabilities=p,this._candidates=l,this._iceParameters=i,this._dtlsParameters=a,this._localCapabilities=g,this.setup=f,this.cname=v;let I=this.rtpCapabilities.send;for(let b of y.mediaDescriptions){if(b.attributes.iceUfrag=i.iceUfrag,b.attributes.icePwd=i.icePwd,b.attributes.fingerprints=a.fingerprints,b.attributes.candidates=l,b.attributes.setup=f,b.media.mediaType==="application"&&(b.attributes.sctpPort="5000"),b.media.mediaType==="video"&&(b.media.fmts=I.videoCodecs.map(k=>k.payloadType.toString(10)),b.attributes.payloads=I.videoCodecs,b.attributes.extmaps=I.videoExtensions,ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:k,ssrcGroups:U}=xo([{ssrcId:lS,rtx:ce("USE_SUB_RTX")?40001:void 0}],this.cname);b.attributes.ssrcs=k,b.attributes.ssrcGroups=U}if(b.media.mediaType==="audio"&&(b.media.fmts=I.audioCodecs.map(k=>k.payloadType.toString(10)),b.attributes.payloads=I.audioCodecs,b.attributes.extmaps=I.audioExtensions,Vd(b),ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:k,ssrcGroups:U}=xo([{ssrcId:mm}],this.cname);b.attributes.ssrcs=k,b.attributes.ssrcGroups=U}}this.sessionDesc=y,this.currentMidIndex=y.mediaDescriptions.length-1}updateRemoteRTPCapabilities(t){let i=Ci.parse(wk);this._rtpCapabilities=t;let a=this.rtpCapabilities.send;for(let l of i.mediaDescriptions){if(l.attributes.iceUfrag=this._iceParameters.iceUfrag,l.attributes.icePwd=this._iceParameters.icePwd,l.attributes.fingerprints=this._dtlsParameters.fingerprints,l.attributes.candidates=this._candidates,l.attributes.setup=this.setup,l.media.mediaType==="application"&&(l.attributes.sctpPort="5000"),l.media.mediaType==="video"&&(l.media.fmts=a.videoCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=a.videoCodecs,l.attributes.extmaps=a.videoExtensions,ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:p,ssrcGroups:f}=xo([{ssrcId:lS,rtx:ce("USE_SUB_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=f}if(l.media.mediaType==="audio"&&(l.media.fmts=a.audioCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=a.audioCodecs,l.attributes.extmaps=a.audioExtensions,ce("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:p,ssrcGroups:f}=xo([{ssrcId:mm}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=f}}this.sessionDesc=i,this.currentMidIndex=i.mediaDescriptions.length-1}preloadRemoteMedia(t){this.rtpCapabilities;let i=this.candidates,a=this.dtlsParameters,l=this.iceParameters,p=this.rtpCapabilities.send;for(let f=1;f<t;f++){let g=2*f+mm,v=2*f+lS,{ssrcs:y,ssrcGroups:I}=xo([{ssrcId:g}],this.cname),{ssrcs:b,ssrcGroups:k}=xo([{ssrcId:v,rtx:ce("USE_SUB_RTX")?v+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:ev,protos:["UDP","TLS","RTP","SAVPF"],fmts:p.videoCodecs.map(U=>U.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:l.iceUfrag,icePwd:l.icePwd,unrecognized:[],candidates:i,extmaps:p.videoExtensions,fingerprints:a.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:b,ssrcGroups:k,rtcpFeedbackWildcards:[],payloads:p.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*f-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:ev,protos:["UDP","TLS","RTP","SAVPF"],fmts:p.audioCodecs.map(U=>U.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:l.iceUfrag,icePwd:l.icePwd,unrecognized:[],candidates:i,extmaps:p.audioExtensions,fingerprints:a.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:y,ssrcGroups:I,rtcpFeedbackWildcards:[],payloads:p.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*f)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Ci.print(this.sessionDesc)}send(t,i,a,l){let{ssrcs:p,ssrcGroups:f}=xo(i,this.cname,ce("SYNC_GROUP")?a:void 0),g=this.findPreloadMediaDesc(p);if(g){if(Hn()&&this.firefoxSsrcMidMap.set(p[0].ssrcId,g.attributes.mid),l&&(l.twcc||l.remb)){let v=this.sessionDesc.mediaDescriptions.indexOf(g);return this.sessionDesc.mediaDescriptions[v]=this.mungSendMediaDesc(g,l),{mid:g.attributes.mid,needExchangeSDP:!0}}return{mid:g.attributes.mid,needExchangeSDP:!1}}{let v=this.findAvailableMediaIndex(t,p),y;return v===-1||qt()||Gs()||tl()||v===0&&ce("USE_SUB_RTX")?(y=this.createOrRecycleSendMedia(t,p,f,"sendonly",l),this.updateBundleMids()):(y=Gn(this.sessionDesc.mediaDescriptions[v]),y.attributes.direction="sendonly",y.attributes.ssrcs=p,y.attributes.ssrcGroups=f,this.sessionDesc.mediaDescriptions[v]=this.mungSendMediaDesc(y,l)),Hn()&&this.firefoxSsrcMidMap.set(p[0].ssrcId,y.attributes.mid),{mid:y.attributes.mid,needExchangeSDP:!0}}}batchSend(t){let i=t.map(p=>{let{kind:f,ssrcMsg:g,mslabel:v}=p;return this.send(f,g,v)}),a=[],l=!1;return i.forEach(p=>{let{mid:f,needExchangeSDP:g}=p;g&&(l=!0),a.push(f)}),{mids:a,needExchangeSDP:l}}stopSending(t){let i=this.sessionDesc.mediaDescriptions.filter(a=>a.attributes.mid&&t.indexOf(a.attributes.mid)!==-1);if(i.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");i.forEach(a=>{a.attributes.mid==="0"||Hn()||qt()||Gs()?a.attributes.ssrcs=[]:(a.attributes.ssrcs=[],a.attributes.direction="inactive",a.media.port="0")}),this.updateBundleMids()}mute(t){let i=this.sessionDesc.mediaDescriptions.find(a=>a.attributes.mid===t);if(!i)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(t){let i=this.sessionDesc.mediaDescriptions.find(a=>a.attributes.mid===t);if(!i)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}muteRemote(t){let i=this.sessionDesc.mediaDescriptions.filter(a=>xe(t).call(t,a.attributes.mid||""));if(i.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(a=>{a.attributes.direction="inactive"})}unmuteRemote(t){let i=this.sessionDesc.mediaDescriptions.filter(a=>xe(t).call(t,a.attributes.mid||""));if(i.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(a=>{a.attributes.direction="recvonly"})}receive(t,i,a,l){t.forEach((p,f)=>{this.createOrRecycleRecvMedia(p,[],"recvonly",i,a,l[f])}),this.updateBundleMids()}stopReceiving(t){let i=this.sessionDesc.mediaDescriptions.filter(a=>t.indexOf(a.attributes.mid)!==-1);if(i.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");i.forEach(a=>{a.media.port="0",a.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(t){t===vs.TCP?this._candidates.forEach(i=>{this._candidates.findIndex(a=>a.transport==="tcp"&&a.connectionAddress===i.connectionAddress&&a.port===i.port)===-1&&this._candidates.push(dS(dS({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}):this._candidates=this._candidates.filter(i=>i.transport!=="tcp");for(let i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}restartICE(t){t=Gn(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=t.iceUfrag,i.attributes.icePwd=t.icePwd})}predictReceivingMids(t){let i=[];for(let a=0;a<t;a++)i.push((this.currentMidIndex+a+1).toString(10));return i}findAvailableMediaIndex(t,i){return this.sessionDesc.mediaDescriptions.findIndex(a=>{let l=a.media.mediaType===t&&a.media.port!=="0"&&(a.attributes.direction==="sendonly"||a.attributes.direction==="sendrecv")&&a.attributes.ssrcs.length===0;if(Hn()){if(l){let p=this.firefoxSsrcMidMap.get(i[0].ssrcId);return!(p||a.attributes.mid!=="0"&&a.attributes.mid!=="1")||!(!p||p!==a.attributes.mid)}return!1}return l})}createOrRecycleRecvMedia(t,i,a,l,p,f){let g=t._mediaStreamTrack.kind,v=this.rtpCapabilities.recv,y=Ou(g,v,this.localCapabilities.send,g===We.VIDEO?l:p),I=g===We.VIDEO?v.videoExtensions:v.audioExtensions;this.currentMidIndex+=1;let b="".concat(this.currentMidIndex),k={media:{mediaType:g,port:ev,protos:["UDP","TLS","RTP","SAVPF"],fmts:y.map(J=>J.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:I,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:y,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:a,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(b)}};k=this.mungRecvMediaDsec(k,t,f);let U=this.findFirstClosedMedia(g);if(U){let J=this.sessionDesc.mediaDescriptions.indexOf(U);this.sessionDesc.mediaDescriptions[J]=k}else this.sessionDesc.mediaDescriptions.push(k);return k}updateRemoteCodec(t,i,a){let l=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(k=>k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||"").filter(k=>{var U;return xe(U=Object.keys(au)).call(U,k)}))],p=new Set(i);if(l.every(k=>p.has(k)))return x.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;let f=this._rtpCapabilities.recv.videoCodecs.filter(k=>i.some(U=>{var J;return xe(J=k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||"").call(J,U)}));if(f.length===0)return x.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(l," codecs: ").concat(i)),!1;let g=[...new Set(f.map(k=>k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||""))],v;if(x.debug("updateRemoteCodec, from ".concat(l," to ").concat(g)),t.length===0)v=this.sessionDesc.mediaDescriptions.filter(k=>k.media.mediaType==="video"&&k.attributes.direction==="recvonly");else if(v=this.sessionDesc.mediaDescriptions.filter(k=>k.attributes.mid&&xe(t).call(t,k.attributes.mid)&&k.attributes.direction==="recvonly"),v.length!==t.length)return x.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(i)),!1;this._rtpCapabilities.recv.videoCodecs=f;let y=this.localCapabilities.send,I=this.rtpCapabilities.recv,b=Ou(We.VIDEO,I,y,a);return v.forEach(k=>{let U=b.map(J=>J.payloadType.toString(10));x.debug("updateRemoteCodec mid: ".concat(k.attributes.mid,", from ").concat(k.attributes.payloads," to ").concat(b)),k.attributes.payloads=b,k.media.fmts=U}),!0}createOrRecycleSendMedia(t,i,a,l,p){let f=this.rtpCapabilities.send,g=t===We.VIDEO?f.videoCodecs:f.audioCodecs,v=t===We.VIDEO?f.videoExtensions:f.audioExtensions;this.currentMidIndex+=1;let y="".concat(this.currentMidIndex),I={media:{mediaType:t,port:ev,protos:["UDP","TLS","RTP","SAVPF"],fmts:g.map(k=>k.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:v,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:a,rtcpFeedbackWildcards:[],payloads:g,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:l,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(y)}};I=this.mungSendMediaDesc(I,p);let b=this.findFirstClosedMedia(t);if(b){let k=this.sessionDesc.mediaDescriptions.indexOf(b);this.sessionDesc.mediaDescriptions[k]=I}else this.sessionDesc.mediaDescriptions.push(I);return I}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}mungRecvMediaDsec(t,i,a){let l=Gn(t);return bu(l),xd(l,i),qC(l,i),qb(l),hm(l,a,this.localCapabilities.send),l}mungSendMediaDesc(t,i){let a=Gn(t);return hm(a,i,this.localCapabilities.recv),Vd(a),a}updateRecvMedia(t,i){let a=this.sessionDesc.mediaDescriptions.findIndex(l=>l.attributes.mid===t);if(a!==-1){let l=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],i);this.sessionDesc.mediaDescriptions[a]=l}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(i=>Hn()?i.media.port==="0"&&i.media.mediaType===t:i.media.port==="0")}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(i=>{var a;return((a=i.attributes)===null||a===void 0||(a=a.ssrcs[0])===null||a===void 0?void 0:a.ssrcId)===t[0].ssrcId})}getSSRC(t){var i;return(i=this.sessionDesc.mediaDescriptions.find(a=>a.attributes.mid===t))===null||i===void 0?void 0:i.attributes.ssrcs}}function bk(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function uS(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?bk(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):bk(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}class qi extends pg{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let t;return this.localCapabilities&&(t=xf(this.localCapabilities)),[...new Set(t&&t.send.videoCodecs.map(i=>i.rtpMap&&i.rtpMap.encodingName.toLowerCase()||"").filter(i=>{var a;return xe(a=Object.keys(au)).call(a,i)}))]}constructor(t,i,a){super(t,i),P(this,"store",void 0),P(this,"peerConnection",void 0),P(this,"remoteSDP",void 0),P(this,"initialOffer",void 0),P(this,"transportEventReceiver",void 0),P(this,"statsFilter",void 0),P(this,"useXR",ce("USE_XR")),P(this,"localCapabilities",void 0),P(this,"localCandidateCount",0),P(this,"allCandidatesReceived",!1),P(this,"remoteCodecs",void 0),P(this,"dataStreamChannelMap",new Map),P(this,"establishPromise",void 0),P(this,"mutex",new sn("NVExtentionsConnection-mutex")),P(this,"rtcMedia",void 0),this.store=i,this.peerConnection=a,this.statsFilter=KC(this.peerConnection,ce("STATS_UPDATE_INTERVAL"),void 0,Hn()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(t){try{let i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let a=Ud(i.sdp),l=await Ba({filterRTX:!ce("USE_PUB_RTX")&&!ce("USE_SUB_RTX"),filterVideoFec:ce("FILTER_VIDEO_FEC"),filterAudioFec:ce("FILTER_AUDIO_FEC"),filterVideoCodec:ce("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=l,this.initialOffer=i,uS(uS({},a),{},{rtpCapabilities:l,offerSDP:i.sdp})}catch(i){throw new Ce(Z.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(t,i,a,l,p,f){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new tv({remoteIceParameters:t,remoteDtlsParameters:i,candidates:a,remoteRTPCapabilities:l,remoteSetup:p,localCapabilities:xf(this.localCapabilities),cname:f});let g=this.remoteSDP.toString(),v=Ci.parse(this.initialOffer.sdp),y=v.mediaDescriptions.find(k=>k.media.mediaType==="audio");y&&Vd(y),this.useXR&&iS(v);let I=Ci.print(v),b=this.logSDPExchange(I||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:I}),b==null||b(g),await this.peerConnection.setRemoteDescription({type:"answer",sdp:g})}catch(g){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(g.toString()))}}async updateRemoteRTPCapabilities(t,i){if(this.remoteCodecs=i,!this.remoteSDP)return void x.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(t,i,this.store.codec)){let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a);let p=this.remoteSDP.toString();l==null||l(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}else x.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(t){var i,a,l,p;(i=this.remoteSDP)===null||i===void 0||i.updateRemoteRTPCapabilities(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((p=this.remoteSDP)===null||p===void 0||p.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(a=this.remoteSDP)===null||a===void 0||a.preloadRemoteMedia(2);let f=(l=this.remoteSDP)===null||l===void 0?void 0:l.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:f});let g=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(g),x.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(t,i,a){var l=this;return Ca(function*(){let p=yield nn(l.mutex.lock("From NVExtentionsConnection.send"));try{if(!l.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");let f=[];t.forEach(K=>{let q=l.peerConnection.addTransceiver(K._mediaStreamTrack,{direction:"sendonly"});f.push(q)}),Hn()&&ce("SIMULCAST")===!0&&(yield nn(l.applySimulcastForFirefox(f,t)));let g=yield nn(l.peerConnection.createOffer()),v=l.remoteSDP.predictReceivingMids(t.length),y=l.mungSendOfferSDP(g.sdp,t,v),I=Ci.parse(y),b=v.map(K=>{let q=I.mediaDescriptions.find(te=>te.attributes.mid===K);if(!q)throw new Error("Cannot extract ssrc from mediaDescription.");return YC(q,ce("USE_PUB_RTX"))}),k;try{k=yield b}catch(K){k=[],l.remoteSDP.receive(t,i,a,k);let q=l.remoteSDP.toString();throw yield nn(l.peerConnection.setLocalDescription({type:"offer",sdp:y})),yield nn(l.peerConnection.setRemoteDescription({type:"answer",sdp:q})),yield nn(l.stopSending(v,!0)),K}l.remoteSDP.receive(t,i,a,k);let U=l.remoteSDP.toString(),J=l.logSDPExchange(y,"offer","local","send");return yield nn(l.peerConnection.setLocalDescription({type:"offer",sdp:y})),yield nn(l.applySimulcastEncodings(f,t)),yield nn(l.applySendEncodings(f,t)),J==null||J(U),yield nn(l.peerConnection.setRemoteDescription({type:"answer",sdp:U})),f.map((K,q)=>{let te=v[q];return{localSSRC:b[q],id:te,transceiver:K}})}catch(f){throw f instanceof Ce?f:new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(f.toString()))}finally{p()}})()}async stopSending(t,i){let a=i?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");let l=this.peerConnection.getTransceivers().filter(v=>t.indexOf(v.mid)!==-1);if(l.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");l.map(v=>{var y;v.direction="inactive",(y=v.stop)===null||y===void 0||y.call(v)});let p=await this.peerConnection.createOffer(),f=this.logSDPExchange(p.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(p),this.remoteSDP.stopReceiving(t);let g=this.remoteSDP.toString();f==null||f(g),await this.peerConnection.setRemoteDescription({type:"answer",sdp:g})}catch(l){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(l.toString()))}finally{a&&a()}}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let a=this.dataStreamChannelMap.get(t);return a&&a.readyState==="open"?x.debug("[P2PConnection] Channels are already available and can be reused directly."):(a=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:ce("DATASTREAM_MAX_RETRANSMITS")}),a.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,a)),void i.forEach(l=>{l._updateOriginDataChannel(a)})}catch(a){throw a instanceof Ce?a:new Ce(Z.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(a.toString()))}}async stopDataChannels(t){try{let i=this.dataStreamChannelMap.get(t);return i==null||i.close(),void this.dataStreamChannelMap.delete(t)}catch(i){throw i instanceof Ce?i:new Ce(Z.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(i.toString()))}}async receive(t,i,a,l){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));let{mid:p,needExchangeSDP:f}=this.remoteSDP.send(t,i,a,l);if(f){let v=this.remoteSDP.toString(),y=this.logSDPExchange(v,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:v});let I=await this.peerConnection.createAnswer(),b=this.mungReceiveAnswerSDP(I.sdp,p,t);y==null||y(b||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:b}),x.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else x.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));let g=this.peerConnection.getTransceivers().find(v=>v.mid===p);if(!g)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:g.receiver.track,id:p}}catch(p){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(p.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");let{mids:i,needExchangeSDP:a}=this.remoteSDP.batchSend(t);if(a){let l=this.remoteSDP.toString(),p=this.logSDPExchange(l,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:l});let f=await this.peerConnection.createAnswer();p==null||p(f.sdp||""),await this.peerConnection.setLocalDescription(f),x.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else x.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map(l=>{let p=this.peerConnection.getTransceivers().find(f=>f.mid===l);if(!p)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:p.receiver.track,id:l}})}catch(i){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let l=await this.peerConnection.createAnswer();a==null||a(l.sdp||""),await this.peerConnection.setLocalDescription(l)}catch(i){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);let i=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let l=await this.peerConnection.createAnswer();a==null||a(l.sdp||""),await this.peerConnection.setLocalDescription(l)}catch(i){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);let i=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let l=await this.peerConnection.createAnswer();a==null||a(l.sdp||""),await this.peerConnection.setLocalDescription(l)}catch(i){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(f=>f.mid&&t.indexOf(f.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(f=>{f.direction="inactive"});let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.muteRemote(t);let p=this.remoteSDP.toString();l==null||l(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(i){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(f=>f.mid&&t.indexOf(f.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(f,g)=>{f.direction="sendonly"});let a=await this.peerConnection.createOffer(),l=this.logSDPExchange(a.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(a),this.remoteSDP.unmuteRemote(t);let p=this.remoteSDP.toString();l==null||l(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(i){throw new Ce(Z.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return Ca(function*(){let a=yield nn(i.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(zn().supportPCSetConfiguration){let y=i.peerConnection.getConfiguration(),I=t===vs.RELAY?"relay":"all";y.iceTransportPolicy!==I&&(x.debug("restartICE change iceTransportPolicy from [".concat(y.iceTransportPolicy,"] to [").concat(I,"]")),y.iceTransportPolicy=I,i.peerConnection.setConfiguration(y))}else if(t===vs.RELAY)return;t!==vs.RELAY&&i.remoteSDP.updateCandidates(t);let l=yield nn(i.peerConnection.createOffer({iceRestart:!0}));if(!l.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let p=Ud(l.sdp),{remoteIceParameters:f}=yield p.iceParameters;i.remoteSDP.restartICE(f);let g=i.remoteSDP.toString(),v=i.logSDPExchange(l.sdp||"","offer","local","restartICE");yield nn(i.peerConnection.setLocalDescription(l)),v==null||v(g),yield nn(i.peerConnection.setRemoteDescription({type:"answer",sdp:g}))}catch(l){x.warning("restart ICE failed, abort operation",l)}finally{a()}})()}close(){var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");let a=await this.peerConnection.createOffer(),l=this.mungSendOfferSDP(a.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);let p=this.remoteSDP.toString(),f=this.logSDPExchange(l,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),f==null||f(p),await this.peerConnection.setRemoteDescription({type:"answer",sdp:p})}catch(a){throw new Ce(Z.EXCHANGE_SDP_FAILED,a.toString())}}async updateSendParameters(t,i){let a=this.peerConnection.getTransceivers().filter(l=>l.mid===t);a.length===1&&(this.isVP8Simulcast(i)?Hn()||await this.applySimulcastEncodings(a,[i]):await this.applySendEncodings(a,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let a=this.peerConnection.getTransceivers().find(l=>l.mid===i);a&&await a.sender.replaceTrack(t._mediaStreamTrack)}getP2PConnectionParams(){var t;if((t=this.peerConnection.currentLocalDescription)===null||t===void 0||!t.sdp||!this.localCapabilities)throw new Error;return uS(uS({},Ud(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,x.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,x.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},ce("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){let i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(nh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...qi.turnServerConfigToIceServers(t.turnServer.servers)),ce("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...qi.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),ce("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(a=>{a.security?a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(hl(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}):(a.udpport&&!ce("FORCE_TURN_TCP")&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.udpport,"?transport=udp")}),a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}))}),i}async applySendEncodings(t,i){try{if(!zn().supportSetRtpSenderParameters||t.length!==i.length)return;for(let b=0;b<t.length;b++){let k=t[b],U=i[b];if(U&&U instanceof jt){var a,l,p;if(this.isVP8Simulcast(U))continue;let J={},K={};switch(U._optimizationMode){case"motion":J.degradationPreference="maintain-framerate";break;case"detail":J.degradationPreference="maintain-resolution";break;default:J.degradationPreference="balanced"}var f,g,v,y;if((a=U._encoderConfig)!==null&&a!==void 0&&a.bitrateMax&&(K.maxBitrate=1e3*((f=U._encoderConfig)===null||f===void 0?void 0:f.bitrateMax)),xe(l=U._hints).call(l,Un.LOW_STREAM)&&((g=U._encoderConfig)!==null&&g!==void 0&&g.frameRate&&(K.maxFramerate=zo(U._encoderConfig.frameRate)),(v=U._encoderConfig)!==null&&v!==void 0&&v.scaleResolutionDownBy&&((y=U._encoderConfig)===null||y===void 0?void 0:y.scaleResolutionDownBy)>1&&(K.scaleResolutionDownBy=U._encoderConfig.scaleResolutionDownBy)),ce("DSCP_TYPE")&&Ql()){var I;let de=ce("DSCP_TYPE");xe(I=["very-low","low","medium","high"]).call(I,de)&&(K.networkPriority=de)}let q=k.sender.getParameters(),te=(p=q.encodings)===null||p===void 0?void 0:p[0];Hn()&&!te&&(J.encodings=[K]),te&&Object.assign(te,K),Object.assign(q,J),await k.sender.setParameters(q)}}}catch{x.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(t,i,a){let l=Ci.parse(t);return i.forEach((p,f)=>{let g=a[f],v=l.mediaDescriptions.find(y=>y.attributes.mid===g);v&&(xd(v,p),nS(v,p,this.store.codec))}),Ci.print(l)}mungReceiveAnswerSDP(t,i,a){let l=Ci.parse(t),p=l.mediaDescriptions.find(f=>f.attributes.mid===i);return p&&a===We.AUDIO&&p.media.mediaType==="audio"&&Vd(p),this.useXR&&iS(l),Ci.print(l)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,a)=>{var l;(l=this.onFirstVideoDecoded)===null||l===void 0||l.call(this,t,i,a)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var a;(a=this.onSelectedLocalCandidateChanged)===null||a===void 0||a.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var a;(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0||a.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let v=0;v<t.length;v++){var a,l,p,f,g;let y=t[v],I=i[v];if(I instanceof jt&&!xe(a=I._hints).call(a,Un.LOW_STREAM)&&(l=I._encoderConfig)!==null&&l!==void 0&&l.bitrateMax&&((p=I._encoderConfig)===null||p===void 0?void 0:p.bitrateMax)>200&&(f=I._scalabilityMode)!==null&&f!==void 0&&f.numSpatialLayers&&((g=I._scalabilityMode)===null||g===void 0?void 0:g.numSpatialLayers)>1&&this.store.codec==="vp8"){let b={},k={high:1e3*(I._encoderConfig.bitrateMax-50),medium:5e4};b.encodings=[{rid:"m",active:!0,maxBitrate:k.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:k.high}];let U=y.sender.getParameters();await y.sender.setParameters(Object.assign(U,b))}}}async applySimulcastEncodings(t,i){if(!Hn()&&t.length===i.length)for(let a=0;a<t.length;a++){let l=i[a];if(l instanceof jt&&this.isVP8Simulcast(l)){let p=t[a],f={},g={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};f.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:g.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:g.medium,scaleResolutionDownBy:4}];let v=p.sender.getParameters();await p.sender.setParameters(Object.assign(v,f))}}}isVP8Simulcast(t){var i,a,l,p,f;return!!(t instanceof jt&&ce("SIMULCAST")&&this.store.codec==="vp8"&&!xe(i=t._hints).call(i,Un.LOW_STREAM)&&(a=t._encoderConfig)!==null&&a!==void 0&&a.bitrateMax&&((l=t._encoderConfig)===null||l===void 0?void 0:l.bitrateMax)>200&&(p=t._scalabilityMode)!==null&&p!==void 0&&p.numSpatialLayers&&((f=t._scalabilityMode)===null||f===void 0?void 0:f.numSpatialLayers)>1)}logSDPExchange(t,i,a,l){if(ce("SDP_LOGGING"))return x.upload("exchanging ".concat(a," ").concat(i," SDP during NVExtentionsConnection.").concat(l,`
`),t),i==="offer"?p=>{this.logSDPExchange(p,"answer",a==="local"?"remote":"local",l)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(t);return i==null?void 0:i[0].ssrcId}setConfiguration(t){if(zn().supportPCSetConfiguration){let i=qi.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}}function kr(s,t,i){let a=s[t];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let l=this.mutex,p=await l.lock("From NVExtentionsConnection.".concat(t));try{for(var f=arguments.length,g=new Array(f),v=0;v<f;v++)g[v]=arguments[v];return await a.apply(this,g)}finally{p()}},i}function jf(s){var t,i,a,l=2;for(typeof Symbol<"u"&&(i=Cc,a=Symbol.iterator);l--;){if(i&&(t=s[i])!=null)return t.call(s);if(a&&(t=s[a])!=null)return new nv(t.call(s));i="@@asyncIterator",a="@@iterator"}throw new TypeError("Object is not async iterable")}function nv(s){function t(i){if(Object(i)!==i)return Pe.reject(new TypeError(i+" is not an object."));var a=i.done;return Pe.resolve(i.value).then(function(l){return{value:l,done:a}})}return nv=function(i){this.s=i,this.n=i.next},nv.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var a=this.s.return;return a===void 0?Pe.resolve({value:i,done:!0}):t(a.apply(this.s,arguments))},throw:function(i){var a=this.s.return;return a===void 0?Pe.reject(i):t(a.apply(this.s,arguments))}},new nv(s)}Be([kr,Y("design:type",Function),Y("design:paramtypes",[Object,Object,Array,Object,String,String]),Y("design:returntype",Pe)],qi.prototype,"connect",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[Array,Array]),Y("design:returntype",Pe)],qi.prototype,"updateRemoteRTPCapabilities",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],qi.prototype,"updateRemoteConnect",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[Object,Array]),Y("design:returntype",Pe)],qi.prototype,"createDataChannels",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[String,Array,String,Object]),Y("design:returntype",Pe)],qi.prototype,"receive",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],qi.prototype,"batchReceive",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],qi.prototype,"stopReceiving",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],qi.prototype,"muteRemote",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],qi.prototype,"unmuteRemote",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],qi.prototype,"muteLocal",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],qi.prototype,"unmuteLocal",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],qi.prototype,"close",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],qi.prototype,"updateEncoderConfig",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],qi.prototype,"updateSendParameters",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[tn,String]),Y("design:returntype",Pe)],qi.prototype,"replaceTrack",null),Be([kr,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],qi.prototype,"getRemoteSSRC",null);class Lr extends pg{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,i){super(t,i),P(this,"store",void 0),P(this,"peerConnection",void 0),P(this,"cname",void 0),P(this,"mutex",new sn("DataChannelConnection-mutex")),P(this,"dataChannel",void 0),P(this,"_p2pConnection",void 0),P(this,"establishPromise",void 0),P(this,"_nvMedia",void 0),this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Lr.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new qi(t,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var t;let i=(t=this._nvMedia)===null||t===void 0?void 0:t.getLocalRtpCapabilities();return await this._p2pConnection.establish(i)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(t,i,a,l,p,f){return this.cname=f,await this._p2pConnection.connect(t,i,a,l,p,f),await new Pe((g,v)=>{let y=setTimeout(()=>{this.closeSignal(),v(new Ce(Z.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(a))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(y),void g()},this.dataChannel.onerror=I=>{this.closeSignal(),v(I)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,i){return this._p2pConnection.updateRemoteRTPCapabilities(t,i)}send(t,i,a){var l=this;return Ca(function*(){let p=yield nn(l.mutex.lock("From DataChannelConnection.send"));try{return yield*oS(jf(l._p2pConnection.send(t,i,a)))}finally{p()}})()}async stopSending(t,i){return this._p2pConnection.stopSending(t,i)}async createDataChannels(t,i){return this._p2pConnection.createDataChannels(t,i)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,i,a,l){return this._nvMedia?(x.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,i,this.cname)):(x.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,i,a,l))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var i=this;return Ca(function*(){return yield*oS(jf(i._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var i;(i=this._nvMedia)===null||i===void 0||i.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,i){return await this._p2pConnection.updateEncoderConfig(t,i)}async updateSendParameters(t,i){return await this._p2pConnection.updateSendParameters(t,i)}setStatsRemoteVideoIsReady(t,i){this._p2pConnection.setStatsRemoteVideoIsReady(t,i)}async replaceTrack(t,i){return await this._p2pConnection.replaceTrack(t,i)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,i,a,l){if(ce("SDP_LOGGING"))return x.upload("exchanging ".concat(a," ").concat(i," SDP during DataChannelConnection.").concat(l,`
`),t),i==="offer"?p=>{this.logSDPExchange(p,"answer",a==="local"?"remote":"local",l)}:void 0}static resolvePCConfiguration(t){let i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(nh(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...Lr.turnServerConfigToIceServers(t.turnServer.servers)),ce("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...Lr.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),ce("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(a=>{a.security?a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(hl(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}):(a.udpport&&!ce("FORCE_TURN_TCP")&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.udpport,"?transport=udp")}),a.tcpport&&i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=tcp")}))}),i}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var i;return(i=this.onICEConnectionStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var i;return(i=this.onConnectionStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var i;return(i=this.onDTLSTransportStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var i;return(i=this.onDTLSTransportError)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var i;return(i=this.onICETransportStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var i;return(i=this.onFirstAudioReceived)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var i;return(i=this.onFirstVideoReceived)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var i;return(i=this.onFirstAudioDecoded)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,i,a)=>{var l;return(l=this.onFirstVideoDecoded)===null||l===void 0?void 0:l.call(this,t,i,a)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var i;return(i=this.onFirstVideoDecodedTimeout)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,i)=>{var a;return(a=this.onSelectedLocalCandidateChanged)===null||a===void 0?void 0:a.call(this,t,i)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,i)=>{var a;return(a=this.onSelectedRemoteCandidateChanged)===null||a===void 0?void 0:a.call(this,t,i)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}}function ao(s,t,i){let a=s[t];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let l=this.mutex,p=await l.lock("From DataChannelConnection.".concat(t));try{for(var f=arguments.length,g=new Array(f),v=0;v<f;v++)g[v]=arguments[v];return await a.apply(this,g)}finally{p()}},i}function iv(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Uh(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?iv(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):iv(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}function Ok(s){var t,i,a,l=2;for(typeof Symbol<"u"&&(i=Cc,a=Symbol.iterator);l--;){if(i&&(t=s[i])!=null)return t.call(s);if(a&&(t=s[a])!=null)return new xh(t.call(s));i="@@asyncIterator",a="@@iterator"}throw new TypeError("Object is not async iterable")}function xh(s){function t(i){if(Object(i)!==i)return Pe.reject(new TypeError(i+" is not an object."));var a=i.done;return Pe.resolve(i.value).then(function(l){return{value:l,done:a}})}return xh=function(i){this.s=i,this.n=i.next},xh.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var a=this.s.return;return a===void 0?Pe.resolve({value:i,done:!0}):t(a.apply(this.s,arguments))},throw:function(i){var a=this.s.return;return a===void 0?Pe.reject(i):t(a.apply(this.s,arguments))}},new xh(s)}Be([ao,Y("design:type",Function),Y("design:paramtypes",[Object,Object,Array,Object,String,String]),Y("design:returntype",Pe)],Lr.prototype,"connect",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[Array,Array]),Y("design:returntype",Pe)],Lr.prototype,"updateRemoteRTPCapabilities",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[Object,Array]),Y("design:returntype",Pe)],Lr.prototype,"createDataChannels",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[String,Array,String,Object]),Y("design:returntype",Pe)],Lr.prototype,"receive",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Lr.prototype,"stopReceiving",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Lr.prototype,"muteRemote",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Lr.prototype,"unmuteRemote",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Lr.prototype,"muteLocal",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Lr.prototype,"unmuteLocal",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Lr.prototype,"close",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],Lr.prototype,"updateEncoderConfig",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[String,tn]),Y("design:returntype",Pe)],Lr.prototype,"updateSendParameters",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[tn,String]),Y("design:returntype",Pe)],Lr.prototype,"replaceTrack",null),Be([ao,Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Lr.prototype,"getRemoteSSRC",null);class Ir extends ri{get state(){return this._state}set state(t){let i=this._state;this._state=t,this.emit(wt.StateChange,i,this._state)}constructor(t,i){super(),P(this,"store",void 0),P(this,"statsUploader",void 0),P(this,"connection",void 0),P(this,"localTrackMap",new Map),P(this,"remoteUserMap",new Map),P(this,"localDataChannels",[]),P(this,"remoteDataChannelMap",new Map),P(this,"pendingLocalTracks",[]),P(this,"pendingRemoteTracks",[]),P(this,"pendingLocalDataChannels",[]),P(this,"pendingRemoteDataChannels",[]),P(this,"statsCollector",void 0),P(this,"isPlanB",!1),P(this,"shouldForwardP2PCreation",void 0),P(this,"iceFailedCount",0),P(this,"dtlsFailedCount",0),P(this,"mutex",new sn("P2PChannel-mutex")),P(this,"_state",Yt.Disconnected),P(this,"_pcStatsUploadType",ce("NEW_ICE_RESTART")?$r.FIRST_CONNECTION:$r.OLD_FIRST_CONNECTION),P(this,"_isInRestartIce",!1),P(this,"_isStartRestartIce",!1),P(this,"_restartStates",["disconnected","failed"]),P(this,"_restartTimer",void 0),P(this,"_isFirstConnected",!0),P(this,"handleMuteLocalTrack",async(a,l,p)=>{let f=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Yt.Connected)return void p(new Ve(Z.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let g=this.filterTobeMutedTracks(a);if(g.length===0)return void l();let v=g.find(I=>I[0]==="videoLowTrack");v&&v[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(g.map(I=>{let[,{id:b}]=I;return b}));let y=this.createMuteMessage(g);await fn(this,wt.RequestMuteLocal,y),l()}catch(g){p(g)}finally{f()}}),P(this,"handleUnmuteLocalTrack",async(a,l,p)=>{let f=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Yt.Connected)return void p(new Ve(Z.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let g=this.filterTobeUnmutedTracks(a);if(g.length===0)return void l();let v=g.find(I=>I[0]==="videoLowTrack");if(v){let I=v[1];if(I.track._originMediaStreamTrack.stop(),!ce("DISABLE_DUAL_STREAM_USE_ENCODING")&&zn().supportDualStreamEncoding){let b=a._mediaStreamTrack.clone();I.track._mediaStreamTrack=b,I.track._originMediaStreamTrack=b}else{let b=Jb(a,ih(this,wt.RequestLowStreamParameter));I.track._mediaStreamTrack=b,I.track._originMediaStreamTrack=b}await new Pe((b,k)=>{this.handleReplaceTrack(I.track,b,k,!0)})}await this.connection.unmuteLocal(g.map(I=>{let[,{id:b}]=I;return b}));let y=this.createUnmuteMessage(g);await fn(this,wt.RequestUnmuteLocal,y),l()}catch(g){p(g)}finally{f()}}),P(this,"handleUpdateVideoEncoder",async(a,l,p)=>{let f=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{let g=this.localTrackMap.get(Ke.LocalVideoTrack);if(!this.connection||!g||g.track!==a||this.state!==Yt.Connected)return void l();let{id:v,track:y}=g;await this.connection.updateSendParameters(v,y),await this.connection.updateEncoderConfig(v,y),this.emit(wt.UpdateVideoEncoder,y),l()}catch(g){p(g)}finally{f()}}),P(this,"handleSetOptimizationMode",async(a,l,p)=>{let f=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{let g=this.localTrackMap.get(Ke.LocalVideoTrack);if(!this.connection||!g||g.track!==a||this.state!==Yt.Connected)return;let{id:v,track:y}=g;await this.connection.updateSendParameters(v,y),l()}catch(g){p(g)}finally{f()}}),P(this,"handleReplaceTrack",async(a,l,p,f)=>{let g;x.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(a.getTrackId(),"]")),typeof f=="boolean"&&f||(g=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var v;let I=Array.from(this.localTrackMap.entries()).find(b=>{let[,{track:k}]=b;return a===k});if(!this.connection||!I||this.state!==Yt.Connected)return void l();if(await((v=this.connection)===null||v===void 0?void 0:v.replaceTrack(a,I[1].id)),this.isPlanB){let b=I[1];b.id=a._mediaStreamTrack.id,this.localTrackMap.set(I[0],b)}if(I[0]===Ke.LocalVideoTrack&&!ce("DISABLE_DUAL_STREAM_USE_ENCODING")&&zn().supportDualStreamEncoding){let b=this.localTrackMap.get(Ke.LocalVideoLowTrack);if(b){let k=a._mediaStreamTrack.clone();b.track._originMediaStreamTrack.stop(),b.track._mediaStreamTrack=k,b.track._originMediaStreamTrack=k,await new Pe((U,J)=>{this.handleReplaceTrack(b.track,U,J,!0)})}}l()}catch(I){p(I)}finally{var y;(y=g)===null||y===void 0||y()}}),P(this,"handleGetRTCStats",a=>{a(this.statsCollector.getRTCStats())}),P(this,"handleGetLocalVideoStats",a=>{a(this.statsCollector.getLocalVideoTrackStats())}),P(this,"handleGetLocalAudioStats",a=>{a(this.statsCollector.getLocalAudioTrackStats())}),P(this,"handleGetRemoteVideoStats",a=>this.statsCollector.getRemoteVideoTrackStats(a.uid)[a.uid]),P(this,"handleGetRemoteAudioStats",a=>this.statsCollector.getRemoteAudioTrackStats(a.uid)[a.uid]),this.store=t,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new JC(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!zn().supportUnifiedPlan||ce("CHROME_FORCE_PLAN_B")&&Ql(),this.shouldForwardP2PCreation=ce("FORWARD_P2P_CREATION")&&zn().supportPCSetConfiguration&&function(){let a=ar();return a===Cr.ANDROID||a===Cr.IOS||a===Cr.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Lr({},this.store):this.isPlanB?new Pr({},this.store):new zi({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,i){var a;this.state=Yt.New;let l=this.shouldForwardP2PCreation&&((a=this.connection)===null||a===void 0?void 0:a.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!l||(l&&this.connection&&(x.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Lr(t,this.store):this.isPlanB?new Pr(t,this.store):new zi(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new Ve(Z.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=ce("NEW_ICE_RESTART")?$r.FIRST_CONNECTION:$r.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,i,a,l,p,f){if(!this.connection)throw new Ve(Z.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Lr?this.connection.updateRemoteConnect(l):(this.store.peerConnectionStart(),await this.connection.connect(t,i,a,l,p,f),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Yt.Connected)}updateRemoteRTPCapabilities(t){let i=Array.from(this.localTrackMap.entries()).filter(p=>{var f;let[g]=p;return xe(f=[Ke.LocalVideoLowTrack,Ke.LocalVideoTrack]).call(f,g)}),a=i.map(p=>{let[,{id:f}]=p;return f}),l=i.map(p=>{let[f]=p;return f});if(this.connection instanceof zi){if(Tt.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(l),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!xe(t).call(t,this.store.codec)){let p=["vp8","h264"].find(f=>xe(t).call(t,f));p&&(this.store.codec=p,x.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(p,".")))}this.connection.updateRemoteRTPCapabilities(a,t)}}async preConnect(t,i,a,l,p,f){if(!this.connection)throw new Ve(Z.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();let g=await this.connection.connect(t,i,a,l,p,f);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Yt.Connected,g}getEstablishParams(){if(this.connection instanceof Lr)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(t){if(!this.connection){if(this.state===Yt.Disconnected)throw new Ve(Z.UNEXPECTED_ERROR,"PeerConnection already disconnected.");let a=t.filter(l=>this.pendingLocalDataChannels.findIndex(p=>p.id===l.id)!==-1);return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(a))}let i=this.filterTobePublishedDataChannels(t);i.length!==0&&(i.forEach(a=>{let l=Date.now();this.store.publish(a.id.toString(),"datachannel",l)}),await this.connection.createDataChannels(this.store.uid,i),i.forEach(a=>{this.localDataChannels.push(a);let l=Date.now();this.store.publish(a.id+"","datachannel",void 0,l)}))}publish(t,i,a){var l=this;return Ca(function*(){let p=yield nn(l.mutex.lock("From P2PChannel.publish"));try{if(!l.connection||l.state!==Yt.Connected){if(l.state===Yt.Disconnected)throw new Ve(Z.UNEXPECTED_ERROR,"PeerConnection already disconnected.");l.throwIfTrackTypeNotMatch(t);let g=t.filter(v=>l.pendingLocalTracks.indexOf(v)===-1);return void(l.pendingLocalTracks=l.pendingLocalTracks.concat(g))}l.store.pubId=l.store.pubId+1,Is.markPublishStart(l.store.clientId,l.store.pubId);let f=l.filterTobePublishedTracks(t,i,a);if(f.length===0)return void(yield nn(l.tryToUnmuteAudio(t)));yield*oS(Ok(l.doPublish(l.connection,f)))}finally{p()}})()}doPublish(t,i){var a=this;return Ca(function*(){i.forEach(I=>{let{track:b,type:k}=I,U=Date.now();a.store.publish(b.getTrackId(),k===Ke.LocalAudioTrack?"audio":"video",U)}),a.bindLocalTrackEvents(i);let l=yield nn(t.send(i.map(I=>{let{track:b}=I;return b}),a.store.codec,a.store.audioCodec)),p=(yield nn(l.next())).value,f=a.createGatewayPublishMessage(i,p),g;try{g=yield f}catch(I){throw l.throw(I),(I==null?void 0:I.code)===Z.WS_ABORT&&i.forEach(b=>{let{track:k}=b;a.pendingLocalTracks.indexOf(k)===-1&&a.pendingLocalTracks.push(k)}),a.unbindLocalTrackEvents(i),I}let v=a.mapPubResToRemoteConfig(f,g),y=(yield nn(l.next(v))).value;i.forEach(I=>{let{type:b}=I;a.statsCollector.addLocalStats(b)}),a.assignLocalTracks(i,y),a.statsUploader.startUploadOutboundStats(),i.forEach(I=>{let{track:b,type:k}=I,U=Date.now();a.store.publish(b.getTrackId(),k===Ke.LocalAudioTrack?"audio":"video",void 0,U)})})()}async updateVideoStreamParameter(t,i){let a=this.localTrackMap.get(i);if(!a)return;if(!(a.track instanceof jt))return x.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof zi||this.connection instanceof Pr))return x.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");let{track:l}=a,p=function(f,g){let v={};return f.height&&f.width&&(v.scaleResolutionDownBy=oC(f,g)),v.maxFramerate=f.framerate?zo(f.framerate):void 0,v.maxBitrate=f.bitrate?1e3*f.bitrate:void 0,v}(t,l);if(l._encoderConfig||(l._encoderConfig={}),i!==Ke.LocalVideoLowTrack||!ce("DISABLE_DUAL_STREAM_USE_ENCODING")&&zn().supportDualStreamEncoding)p.scaleResolutionDownBy!=null&&(l._encoderConfig.scaleResolutionDownBy=p.scaleResolutionDownBy);else{let f=l._originMediaStreamTrack;if(!f.canvas)return x.warn("[".concat(l.getTrackId(),"] no canvas on track"));(function(g,v){let y=g.canvas;v.width&&(y.width=zo(v.width)),v.height&&(y.height=zo(v.height)),v.framerate&&(y.stopCapture&&y.stopCapture(),y.stopCapture=Zw(()=>{!y.startCapture&&y.stopCapture&&y.stopCapture(),y.startCapture&&y.startCapture()},zo(v.framerate)))})(f,t)}p.maxBitrate!=null&&(l._encoderConfig.bitrateMax=p.maxBitrate/1e3),p.maxFramerate!=null&&(l._encoderConfig.frameRate&&typeof l._encoderConfig.frameRate=="object"?l._encoderConfig.frameRate.max=p.maxFramerate:l._encoderConfig.frameRate={max:p.maxFramerate}),x.debug("[".concat(l.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(l._encoderConfig))),await this.connection.updateRtpSenderEncodings(l)}publishLowStream(t){var i=this;return Ca(function*(){if(!i.connection||i.state!==Yt.Connected)return;let a=yield nn(i.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let p=i.localTrackMap.get(Ke.LocalVideoTrack);if(!p)throw new Ve(Z.UNEXPECTED_ERROR,"Could not find high stream");if(i.localTrackMap.has(Ke.LocalVideoLowTrack))throw new Ve(Z.UNEXPECTED_ERROR,"[".concat(i.store.clientId,"] Can't publish low stream when stream already publish"));let f=[{track:i.getLowVideoTrack(p.track,t),type:Ke.LocalVideoLowTrack}];if(yield*oS(Ok(i.doPublish(i.connection,f))),p.track.muted||!p.track.enabled){var l;let g=(l=i.localTrackMap.get(Ke.LocalVideoLowTrack))===null||l===void 0?void 0:l.id;g!==void 0&&(yield nn(i.connection.muteLocal([g])))}}finally{a()}})()}async republish(){this.pendingLocalTracks.length>0&&(x.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await In(this,wt.RequestRePublish,this.pendingLocalTracks),this.emit(wt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(x.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await In(this,wt.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(t){for(let i=this.pendingRemoteTracks.length-1;i>=0;i--){let{user:a,kind:l}=this.pendingRemoteTracks[i];(l!==We.AUDIO||a._audio_added_&&a._audioSSRC)&&(l!==We.VIDEO||a._video_added_&&a._videoSSRC)||this.pendingRemoteTracks.splice(i,1)}if(t)await In(this,wt.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:i,kind:a}of this.pendingRemoteTracks)await this.subscribe(i,a,a===We.VIDEO?i._videoSSRC:i._audioSSRC);this.pendingRemoteTracks.forEach(i=>{let{user:a}=i;this.emit(wt.MediaReconnectEnd,a.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==Yt.Connected)return void t.forEach(l=>{let p=this.pendingLocalTracks.indexOf(l);p!==-1&&this.pendingLocalTracks.splice(p,1)});let i=this.filterTobeUnpublishedTracks(t);if(i.length===0)return;let a=i.find(l=>l[0]==="videoLowTrack");return a&&a[1].track.close(),this.doUnpublish(this.connection,i)}async unpublishDataChannel(t){if(!this.connection||this.state!==Yt.Connected)return void t.forEach(a=>{let l=this.pendingLocalDataChannels.indexOf(a);l!==-1&&this.pendingLocalDataChannels.splice(l,1)});let i=this.filterTobeUnpublishedDataChannels(t);return i.length!==0?(i.forEach(a=>{let l=this.localDataChannels.indexOf(a);l!==-1&&this.localDataChannels.splice(l,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),i.map(a=>a.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Yt.Connected)return;let t=this.localTrackMap.get(Ke.LocalVideoLowTrack);if(!t)return;t.track.close();let i=[[Ke.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,i)}async doUnpublish(t,i){let a=this.createGatewayUnpublishMessage(i);return await t.stopSending(i.map(l=>{let[,{id:p}]=l;return p})),this.withdrawLocalTracks(i),this.unbindLocalTrackEvents(i.map(l=>{let[p,{track:f}]=l;return{type:p,track:f}})),i.forEach(l=>{let[p]=l;this.statsCollector.removeLocalStats(p)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),a}async subscribeDataChannel(t,i){if(!this.connection||this.state!==Yt.Connected)throw new Ve(Z.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let a=i.filter(l=>{var p;return!((p=this.remoteDataChannelMap.get(t))!==null&&p!==void 0&&p.get(l.id))});if(a.length!==0)return await this.connection.createDataChannels(t.uid,a),a.forEach(l=>{var p;this.remoteDataChannelMap.has(t)?(p=this.remoteDataChannelMap.get(t))===null||p===void 0||p.set(l.id,l):this.remoteDataChannelMap.set(t,new Map([[l.id,l]]));let f=this.pendingRemoteDataChannels.findIndex(g=>{let{user:v,id:y}=g;return v.uid===t.uid&&y===l.id});f!==-1&&this.pendingRemoteDataChannels.splice(f,1)}),a.map(l=>l.id)}async subscribe(t,i,a,l,p){var f;if(!this.connection||this.state!==Yt.Connected)throw new Ve(Z.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((f=this.remoteUserMap.get(t))!==null&&f!==void 0&&f.has(i))return;let g,v,y;if(p){let k=p.find(J=>{let{stream_type:K}=J;return K===i});if(!k)throw new Ve(Z.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(i," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(i,"."));let U=await this.connection.receive(i,k.ssrcs,String(t._uintid),k.attributes);this.connection instanceof zi&&(y=U.transceiver),g=U.track,v=U.id}else{let k=await this.connection.receive(i,[{ssrcId:a,rtx:l}],String(t._uintid),void 0);this.connection instanceof zi&&(y=k.transceiver),g=k.track,v=k.id}i===We.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(g):(t._audioTrack=new Jc(g,t.uid,t._uintid,this.store),x.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),y&&t._audioTrack._updateRtpTransceiver(y),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(g):(t._videoTrack=new fc(g,t.uid,t._uintid,this.store),x.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),y&&t._videoTrack._updateRtpTransceiver(y),this.bindRemoteTrackEvents(t,t._videoTrack));let I=this.remoteUserMap.get(t);I?I.set(i,v):this.remoteUserMap.set(t,new Map([[i,v]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();let b=this.pendingRemoteTracks.findIndex(k=>{let{user:U,kind:J}=k;return U.uid===t.uid&&i===J});b!==-1&&(this.pendingRemoteTracks.splice(b,1),this.emit(wt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==Yt.Connected)throw new Ve(Z.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(a=>{var l;let{user:p,mediaType:f}=a;return!((l=this.remoteUserMap.get(p))!==null&&l!==void 0&&l.has(f))});let i=await this.connection.batchReceive(t.map(a=>{let{user:l,mediaType:p,ssrcId:f,rtxSsrcId:g}=a;return{kind:p,ssrcMsg:[{ssrcId:f,rtx:g}],mslabel:String(l._uintid)}}));t.forEach((a,l)=>{let{user:p,mediaType:f}=a,{track:g,id:v,transceiver:y}=i[l];f===We.AUDIO?(p._audioTrack?p._audioTrack._updateOriginMediaStreamTrack(g):(p._audioTrack=new Jc(g,p.uid,p._uintid,this.store),x.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(p._audioTrack.getTrackId()))),y&&p._audioTrack._updateRtpTransceiver(y),this.bindRemoteTrackEvents(p,p._audioTrack)):(p._videoTrack?p._videoTrack._updateOriginMediaStreamTrack(g):(p._videoTrack=new fc(g,p.uid,p._uintid,this.store),x.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(p._videoTrack.getTrackId()))),y&&p._videoTrack._updateRtpTransceiver(y),this.bindRemoteTrackEvents(p,p._videoTrack));let I=this.remoteUserMap.get(p);I?I.set(f,v):this.remoteUserMap.set(p,new Map([[f,v]])),this.statsCollector.addRemoteStats(p.uid),this.statsUploader.startUploadInboundStats();let b=this.pendingRemoteTracks.findIndex(k=>{let{user:U,kind:J}=k;return U.uid===p.uid&&f===J});b!==-1&&(this.pendingRemoteTracks.splice(b,1),this.emit(wt.MediaReconnectEnd,p.uid))})}async unsubscribe(t,i,a){let l=this.pendingRemoteTracks.filter(g=>{let{user:v,kind:y}=g;return i!==void 0?v.uid===t.uid&&i===y:v.uid===t.uid});if(l.forEach(g=>{let v=this.pendingRemoteTracks.indexOf(g);this.pendingRemoteTracks.splice(v,1)}),this.connection&&this.state===Yt.Connected||a||l.forEach(g=>{let{kind:v}=g;var y;if(v===We.AUDIO)(y=t._audioTrack)===null||y===void 0||y._destroy(),t._audioTrack=void 0;else if(v===We.VIDEO){var I;(I=t._videoTrack)===null||I===void 0||I._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==Yt.Connected)return;let p=this.filterTobeUnSubscribedTracks(t,i);if(p.length===0)return;await this.connection.stopReceiving(p.map(g=>{let[,{id:v}]=g;return v}));let f=this.createUnsubscribeMessage(p);return this.withdrawRemoteTracks(p),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),p.forEach(g=>{let[v,{kind:y}]=g;var I,b;if(y===We.VIDEO&&v._videoSSRC&&((I=this.connection)===null||I===void 0||I.setStatsRemoteVideoIsReady(v._videoSSRC,!1)),y===We.VIDEO)this.unbindRemoteTrackEvents(v._videoTrack),a||((b=v._videoTrack)===null||b===void 0||b._destroy(),v._videoTrack=void 0);else if(y===We.AUDIO){var k;this.unbindRemoteTrackEvents(v._audioTrack),!a&&((k=v._audioTrack)===null||k===void 0||k._destroy(),v._audioTrack=void 0)}}),f}async unsubscribeDataChannel(t,i){if(i.forEach(p=>{let f=this.pendingRemoteDataChannels.findIndex(g=>g.id===p.id);f!==-1&&this.pendingRemoteDataChannels.splice(f,1)}),!this.connection)return;let a=this.filterTobeUnSubscribedDataChannels(t,i);if(a.length===0)return;i.forEach(p=>{p._close()});let l=this.remoteDataChannelMap.get(t);return a.forEach(p=>{l&&l.delete(p.id)}),l&&l.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),a.map(p=>p.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let i=[];for(let{user:p,mediaType:f}of t){let g=this.pendingRemoteTracks.filter(v=>{let{user:y,kind:I}=v;return f!==void 0?y.uid===p.uid&&f===I:y.uid===p.uid});g.forEach(v=>{let y=this.pendingRemoteTracks.indexOf(v);this.pendingRemoteTracks.splice(y,1)}),i=i.concat(g)}if(!this.connection||this.state!==Yt.Connected)return void i.forEach(p=>{let{user:f,kind:g}=p;var v;if(g===We.AUDIO)(v=f._audioTrack)===null||v===void 0||v._destroy(),f._audioTrack=void 0;else if(g===We.VIDEO){var y;(y=f._videoTrack)===null||y===void 0||y._destroy(),f._videoTrack=void 0}});let a=oh(t).call(t,(p,f)=>{let{user:g,mediaType:v}=f,y=this.filterTobeUnSubscribedTracks(g,v);return p.concat(y)},[]);if(a.length===0)return;await this.connection.stopReceiving(a.map(p=>{let[,{id:f}]=p;return f}));let l=this.createUnsubscribeAllMessage(a);return this.withdrawRemoteTracks(a),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),a.forEach(p=>{let[f,{kind:g}]=p;var v,y;if(g===We.VIDEO&&f._videoSSRC&&((v=this.connection)===null||v===void 0||v.setStatsRemoteVideoIsReady(f._videoSSRC,!1)),g===We.VIDEO)this.unbindRemoteTrackEvents(f._videoTrack),(y=f._videoTrack)===null||y===void 0||y._destroy(),f._videoTrack=void 0;else if(g===We.AUDIO){var I;this.unbindRemoteTrackEvents(f._audioTrack),(I=f._audioTrack)===null||I===void 0||I._destroy(),f._audioTrack=void 0}}),l}async muteRemote(t,i){if(!this.connection)return;let a=this.remoteUserMap.get(t);if(!a)return void x.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!a.get(i))return void x.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(i,"."));let l=i===We.VIDEO?t._videoSSRC:t._audioSSRC;l!==void 0&&this.connection.setStatsRemoteVideoIsReady(l,!1)}async unmuteRemote(t,i){return this.unmuteRemoteNoLock(t,i)}async unmuteRemoteNoLock(t,i){if(!this.connection)return;let a=this.remoteUserMap.get(t);if(!a)return void x.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));a.get(i)||x.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(i,"."))}getAllTracks(t){let i=this.localTrackMap.get(Ke.LocalAudioTrack);if((i==null?void 0:i.track)instanceof lr){let a=i.track;return Array.from(this.localTrackMap.entries()).filter(l=>{let[p]=l;return p!==Ke.LocalAudioTrack}).filter(l=>{let[p]=l;return!(t&&p===Ke.LocalVideoLowTrack)}).map(l=>{let[,{track:p}]=l;return p}).concat(a.trackList)}return Array.from(this.localTrackMap.entries()).filter(a=>{let[l]=a;return!(t&&l===Ke.LocalVideoLowTrack)}).map(a=>{let[,{track:l}]=a;return l})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,i,a,l,p){if(t){let g=this.localTrackMap.get(Ke.LocalAudioTrack),v=l?this.localTrackMap.get(Ke.LocalVideoLowTrack):this.localTrackMap.get(Ke.LocalVideoTrack);Tt.publish(this.store.sessionId,{eventElapse:Is.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:i,audioName:g==null?void 0:g.track.getTrackLabel(),videoName:v==null?void 0:v.track.getTrackLabel(),screenshare:(v==null?void 0:v.track._hints.indexOf(Un.SCREEN_TRACK))!==-1,audio:!!g,video:!!v,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:p})}else{var f;a||(a=[]);let g=a.find(y=>y instanceof Vn),v=l?(f=this.localTrackMap.get(Ke.LocalVideoTrack))===null||f===void 0?void 0:f.track:a.find(y=>y instanceof jt);Tt.publish(this.store.sessionId,{eventElapse:Is.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:i,audioName:g==null?void 0:g.getTrackLabel(),videoName:v==null?void 0:v.getTrackLabel(),screenshare:(v==null?void 0:v._hints.indexOf(Un.SCREEN_TRACK))!==-1,audio:!!g,video:!!v,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:p})}}reportSubscribeEvent(t,i,a,l){let p=l===We.VIDEO?a._videoSSRC:a._audioSSRC;p&&Tt.subscribe(this.store.sessionId,{succ:t,ec:i,video:l===We.VIDEO,audio:l===We.AUDIO,peerid:a.uid,subscribeRequestid:l===We.VIDEO?a._videoSSRC:a._audioSSRC,p2pid:this.store.p2pId,eventElapse:Is.measureFromSubscribeStart(this.store.clientId,p)})}reset(){x.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new sn("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Lr({},this.store):this.isPlanB?new Pr({},this.store):new zi({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(Ke.LocalAudioTrack);if((t==null?void 0:t.track)instanceof lr){if(t.track.trackList.length>0){let i=t.track;t.track.trackList.forEach(a=>{i.removeAudioTrack(a)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Yt.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var i;return((i=this.connection)===null||i===void 0?void 0:i.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(Ke.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(Ke.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){let i=this.localTrackMap.get(t);return i&&i.track instanceof jt||i&&i.track instanceof Vn?i.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,i){if(!t)return this.remoteUserMap.size>0;let a=this.remoteUserMap.get(t);return!!a&&(!i||a.has(i))}async hasRemoteMediaWithLock(t,i){if(!t)return this.remoteUserMap.size>0;let a=this.remoteUserMap.get(t);return!!a&&(!i||a.has(i))}getRemoteMedia(t){var i;let a=Array.from(Ho(i=this.remoteUserMap).call(i)).find(l=>l.uid===t);return a?{audioTrack:a.audioTrack,audioSSRC:a._audioSSRC,videoTrack:a.videoTrack,videoSSRC:a._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(a=>{let[l]=a;return{uid:l.uid,level:l.audioTrack?100*l.audioTrack._source.getAccurateVolumeLevel():0}}),i=this.localTrackMap.get(Ke.LocalAudioTrack);return i&&t.push({level:100*i.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=kE(t).call(t,(a,l)=>a.level-l.level),t}async disconnectForReconnect(){this.connection&&(x.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Yt.Reconnecting,ce("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i]=t;var a;i._videoTrack&&i._videoTrack._player&&((a=i._videoTrack._player.getVideoElement())===null||a===void 0||a.pause(),i._videoTrack._player.isKeepLastFrame=!0,i._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Lr({},this.store):this.isPlanB?new Pr({},this.store):new zi({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var i;let[a,{track:l}]=t;switch(a){case Ke.LocalVideoTrack:xe(i=l._hints).call(i,Un.LOW_STREAM)?l.close():this.pendingLocalTracks.push(l);break;case Ke.LocalAudioTrack:l instanceof lr?this.pendingLocalTracks=this.pendingLocalTracks.concat(l.trackList):this.pendingLocalTracks.push(l);case Ke.LocalVideoLowTrack:}}),this.emit(wt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i,a]=t;Array.from(Ho(a).call(a)).forEach(l=>{this.setPendingRemoteMedia(i,l)}),this.emit(wt.MediaReconnectStart,i.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[i,a]=t;Array.from(Ho(a).call(a)).forEach(l=>{this.setPendingRemoteDataChannel(i,l)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),x.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,i){for(let a of this.pendingRemoteDataChannels){let{user:l,id:p}=a;if((t instanceof ms?t.uid:t)===l.uid&&p===i)return!0}return!1}setPendingRemoteDataChannel(t,i){this.hasPendingRemoteDataChannel(t,i)||this.pendingRemoteDataChannels.push({user:t,id:i})}hasPendingRemoteMedia(t,i){for(let a of this.pendingRemoteTracks){let{user:l,kind:p}=a;if((t instanceof ms?t.uid:t)===l.uid&&i===p)return!0}return!1}setPendingRemoteMedia(t,i){this.hasPendingRemoteMedia(t,i)||this.pendingRemoteTracks.push({user:t,kind:i})}restartICE(t){var i=this;return Ca(function*(){if(!i.connection||i.state!==Yt.Connected||i.connection instanceof Lr)return;let a=yield nn(i.mutex.lock("From P2PChannel.restartICE")),l;try{l=yield nn(i.connection.restartICE(t));let f=yield nn(l.next());if(f.done)return;let g=f.value,v=yield g;switch(i.reportPCDisconnectedOrFailed(t),t){case vs.TCP:i._pcStatsUploadType=$r.TCP_RESTART;break;case vs.RELAY:i._pcStatsUploadType=$r.RELAY_RESTART;break;default:i._pcStatsUploadType=$r.OLD_RESTART}i._isInRestartIce=!0,l.next(v)}catch(f){var p;(p=l)===null||p===void 0||p.throw(f)}finally{a()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),i=this.localTrackMap.get(Ke.LocalVideoTrack),a=this.localTrackMap.get(Ke.LocalAudioTrack),l=t.videoSend.find(J=>J.ssrc===(i==null?void 0:i.ssrcs[0].ssrcId)),p=t.audioSend.find(J=>J.ssrc===(a==null?void 0:a.ssrcs[0].ssrcId));if(!l||!p)return 1;let f=us(this,wt.NeedSignalRTT),g=l?l.rttMs:void 0,v=p?p.rttMs:void 0,y=g&&v?(g+v)/2:g||v,I=(y&&f?(y+f)/2:y||f)||0,b=100*t.sendPacketLossRate*.7/50+.3*I/1500,k=b<.17?1:b<.36?2:b<.59?3:b<.1?4:5,U=i==null?void 0:i.track;if(U&&U._encoderConfig&&U._hints.indexOf(Un.SCREEN_TRACK)===-1){let J=U._encoderConfig.bitrateMax,K=t.bitrate.actualEncoded;if(J&&K){let q=(1e3*J-K)/(1e3*J);return kp[q<.15?0:q<.3?1:q<.45?2:q<.6?3:4][k]}}return k}getDownlinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),i=0;return Array.from(this.remoteUserMap.entries()).forEach(a=>{let[l]=a,p=l._audioSSRC,f=l._videoSSRC,g=t.audioRecv.find(K=>K.ssrc===p),v=t.videoRecv.find(K=>K.ssrc===f);if(!g&&!v)return void(i+=1);let y=us(this,wt.NeedSignalRTT),I=t.rtt,b=(I&&y?(I+y)/2:I||y)||0,k=g?g.jitterMs:void 0,U=t.recvPacketLossRate,J=.7*U*100/50+.3*b/1500;k&&(J=.6*U*100/50+.2*b/1500+.2*k/400),i+=J<.1?1:J<.17?2:J<.36?3:J<.59?4:5}),this.remoteUserMap.size>0?Math.round(i/this.remoteUserMap.size):i}async muteLocalTrack(t){return new Pe((i,a)=>{this.handleMuteLocalTrack(t,i,a)})}filterTobePublishedTracks(t,i,a){let l=[],p=zn(),f=this.getAllTracks();t=Mn(t=t.filter(y=>f.indexOf(y)===-1));let g=!1,v=!1;for(let y of t){if(y instanceof jt&&(this.localTrackMap.has(Ke.LocalVideoTrack)||g?new Ve(Z.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(l.push({track:y,type:Ke.LocalVideoTrack}),g=!0),i)){let I=this.getLowVideoTrack(y,a);l.push({track:I,type:Ke.LocalVideoLowTrack})}if(y instanceof Vn){let I=this.localTrackMap.get(Ke.LocalAudioTrack);if(I){if(!(I.track instanceof lr))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(y._bypassWebAudio)throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");I.track.addAudioTrack(y),this.bindLocalAudioTrackEvents(y,!0)}else if(v){let b=l.find(k=>{let{type:U}=k;return U===Ke.LocalAudioTrack});if(!(b.track instanceof lr))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(y._bypassWebAudio)throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");b.track.addAudioTrack(y)}else{if(!p.webAudioMediaStreamDest||y instanceof lr||y._bypassWebAudio)l.push({track:y,type:Ke.LocalAudioTrack});else{let b=new lr;b.addAudioTrack(y),l.push({track:b,type:Ke.LocalAudioTrack})}v=!0}}}return l}filterTobeUnpublishedTracks(t){let i=[],a=this.getAllTracks();t=Mn(t=t.filter(l=>a.indexOf(l)!==-1));for(let l of t){if(l instanceof Vn){let p=this.localTrackMap.get(Ke.LocalAudioTrack);if(!p)continue;p.track instanceof lr?(p.track.removeAudioTrack(l),this.unbindLocalAudioTrackEvents(l),p.track.trackList.length===0&&(i.push([Ke.LocalAudioTrack,p]),p.track.close())):i.push([Ke.LocalAudioTrack,p])}if(l instanceof jt){let p=this.localTrackMap.get(Ke.LocalVideoTrack);if(!p)continue;i.push([Ke.LocalVideoTrack,p]);let f=this.localTrackMap.get(Ke.LocalVideoLowTrack);f&&i.push([Ke.LocalVideoLowTrack,f])}}return i}filterTobePublishedDataChannels(t){return t=(t=Mn(t)).filter(i=>this.localDataChannels.findIndex(a=>a.id===i.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=Mn(t)).filter(i=>this.localDataChannels.indexOf(i)!==-1)).filter(i=>i._originDataChannel)}bindLocalTrackEvents(t){t.forEach(i=>{let{track:a,type:l}=i;switch(l){case Ke.LocalVideoTrack:a.addListener(ut.GET_STATS,this.handleGetLocalVideoStats),a.addListener(ut.GET_RTC_STATS,this.handleGetRTCStats),a.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),a.addListener(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),a.addListener(ut.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),a.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),a.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Ke.LocalAudioTrack:this.bindLocalAudioTrackEvents(a);case Ke.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,i){t instanceof lr?t.trackList.forEach(a=>{a.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),a.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),a.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),a.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(ut.GET_STATS,this.handleGetLocalAudioStats),t.addListener(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),i||t.addListener(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(i=>{let[a,{track:l}]=i;return{track:l,type:a}})),t.forEach(i=>{let{track:a,type:l}=i;switch(l){case Ke.LocalVideoTrack:a.off(ut.GET_STATS,this.handleGetLocalVideoStats),a.off(ut.GET_RTC_STATS,this.handleGetRTCStats),a.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),a.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),a.off(ut.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),a.off(ut.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),a.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),a.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),a.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Ke.LocalAudioTrack:this.unbindLocalAudioTrackEvents(a);case Ke.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof lr?t.trackList.forEach(i=>{i.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(ut.GET_STATS,this.handleGetLocalAudioStats),i.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(ut.GET_STATS,this.handleGetLocalAudioStats),t.off(ut.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ut.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(ut.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ut.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,i){i instanceof fc&&i.addListener(ut.GET_STATS,a=>{a(this.handleGetRemoteVideoStats(t))}),i instanceof Jc&&i.addListener(ut.GET_STATS,a=>{a(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(ut.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[i,a]=t;a.has(We.AUDIO)&&this.unbindRemoteTrackEvents(i._audioTrack),a.has(We.VIDEO)&&this.unbindRemoteTrackEvents(i._videoTrack)})}createGatewayPublishMessage(t,i){return t.map((a,l)=>{var p;let f,g,{track:v,type:y}=a;switch(y){case Ke.LocalAudioTrack:f=At.Audio,g={dtx:v instanceof pu&&v._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Ke.LocalVideoTrack:f=xe(p=v._hints).call(p,Un.SCREEN_TRACK)?At.Screen:At.High,g=Uh(Uh({},du(v)),{},{codec:this.store.codec});break;case Ke.LocalVideoLowTrack:f=At.Low,g=Uh(Uh({},du(v)),{},{codec:this.store.codec})}return{stream_type:f,attributes:g,ssrcs:i[l]}})}createGatewayUnpublishMessage(t){return t.map(i=>{var a;let l,[p,{track:f,ssrcs:g,id:v}]=i;switch(p){case Ke.LocalVideoTrack:l=xe(a=f._hints).call(a,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalAudioTrack:l=At.Audio;break;case Ke.LocalVideoLowTrack:l=At.Low}return{stream_type:l,ssrcs:g,mid:v}})}assignLocalTracks(t,i){t.forEach((a,l)=>{let{track:p,type:f}=a;this.localTrackMap.set(f,{track:p,id:i[l].id,ssrcs:i[l].localSSRC})})}withdrawLocalTracks(t){t.forEach(i=>{let[a]=i;this.localTrackMap.delete(a)})}bindConnectionEvents(t){t.onConnectionStateChange=async i=>{if(x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(wt.PeerConnectionStateChange,i),i!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),i==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),ce("NEW_ICE_RESTART")){var a;if(xe(a=this._restartStates).call(a,i)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let l=g=>{(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")&&(x.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(g)),us(this,wt.QueryClientConnectionState)==="CONNECTED"&&this.emit(wt.RequestRestartICE,g))},p=()=>{t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="checking"&&t.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),x.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(wt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},f=ce("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(ce("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&zn().supportPCSetConfiguration)l(vs.RELAY),this._restartTimer=window.setTimeout(p,f);else if(Hn())l(vs.UDP),this._restartTimer=window.setTimeout(p,4e3);else{if(l(vs.TCP),zn().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{l(vs.RELAY),this._restartTimer=window.setTimeout(p,f)},f));this._restartTimer=window.setTimeout(p,f)}},800))}}else{if(i==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&ce("ICE_RESTART")&&us(this,wt.QueryClientConnectionState)==="CONNECTED"&&this.emit(wt.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(x.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(wt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);i==="failed"&&(x.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(wt.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=i=>{i!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(i,")")),Tt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:i,tag:Pi.TRACER}).onSuccess(),this.emit(wt.IceConnectionStateChange,i)},t.onICETransportStateChange=i=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(i,")"))},t.onDTLSTransportStateChange=i=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(i,")"))},t.onDTLSTransportError=i=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(i,")"))},t.onFirstAudioDecoded=i=>{var a;let l=Array.from(Ho(a=this.remoteUserMap).call(a)).find(f=>f._audioSSRC===i);var p;l&&(this.store.subscribe(l.uid,"audio",void 0,void 0,void 0,Date.now()),(p=l.audioTrack)===null||p===void 0||p.emit(Th.FIRST_FRAME_DECODED),Tt.firstRemoteFrame(this.store.sessionId,kt.FIRST_AUDIO_DECODE,ai.FIRST_AUDIO_DECODE,{peer:l._uintid,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=i=>{var a;let l=Array.from(Ho(a=this.remoteUserMap).call(a)).find(p=>p._audioSSRC===i);l&&Tt.firstRemoteFrame(this.store.sessionId,kt.FIRST_AUDIO_RECEIVED,ai.FIRST_AUDIO_RECEIVED,{peer:l._uintid,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(i,a,l)=>{this.reportVideoFirstFrameDecoded(i,a,l)},t.onFirstVideoReceived=i=>{var a;let l=Array.from(Ho(a=this.remoteUserMap).call(a)).find(p=>p._videoSSRC===i);l&&Tt.firstRemoteFrame(this.store.sessionId,kt.FIRST_VIDEO_RECEIVED,ai.FIRST_VIDEO_RECEIVED,{peer:l._uintid,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,i),subscribeRequestid:i,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(i,a)=>{let l=i.candidateType==="relay",p=a.candidateType==="relay";a.candidateType!=="unknown"&&l===p||this.emit(wt.ConnectionTypeChange,l),x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(qo(a))," -> ").concat(JSON.stringify(qo(i)),")"))},t.onSelectedRemoteCandidateChanged=(i,a)=>{x.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(qo(a))," -> ").concat(JSON.stringify(qo(i)),")"))},t.onFirstVideoDecodedTimeout=i=>{this.reportVideoFirstFrameDecoded(i,void 0,void 0,!0)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(t){let i=[];if(this.getAllTracks().indexOf(t)===-1)return i;let a=this.localTrackMap.get(Ke.LocalAudioTrack);if(t instanceof Vn&&(a==null?void 0:a.track)instanceof lr)return a.track.isActive||i.push([Ke.LocalAudioTrack,a]),i;let l=Array.from(this.localTrackMap.entries()).find(p=>{let[,{track:f}]=p;return t===f});if(l&&(i.push(l),l[0]===Ke.LocalVideoTrack)){let p=this.localTrackMap.get(Ke.LocalVideoLowTrack);p&&i.push([Ke.LocalVideoLowTrack,p])}return i}filterTobeUnmutedTracks(t){let i=[],a=this.localTrackMap.get(Ke.LocalAudioTrack);if(t instanceof Vn&&(a==null?void 0:a.track)instanceof lr)return a.track.isActive&&i.push([Ke.LocalAudioTrack,a]),i;let l=Array.from(this.localTrackMap.entries()).find(p=>{let[,{track:f}]=p;return t===f});if(l)if(l[0]===Ke.LocalVideoTrack){i.push(l);let p=this.localTrackMap.get(Ke.LocalVideoLowTrack);p&&i.push([Ke.LocalVideoLowTrack,p])}else i.push(l);return i}createMuteMessage(t){return t.map(i=>{var a;let l,[p,{track:f,ssrcs:g,id:v}]=i;switch(p){case Ke.LocalAudioTrack:l=At.Audio;break;case Ke.LocalVideoTrack:l=xe(a=f._hints).call(a,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalVideoLowTrack:l=At.Low}return{stream_type:l,ssrcs:g,mid:v}})}createUnmuteMessage(t){return t.map(i=>{var a;let l,[p,{track:f,ssrcs:g,id:v}]=i;switch(p){case Ke.LocalAudioTrack:l=At.Audio;break;case Ke.LocalVideoTrack:l=xe(a=f._hints).call(a,Un.SCREEN_TRACK)?At.Screen:At.High;break;case Ke.LocalVideoLowTrack:l=At.Low}return{stream_type:l,ssrcs:g,mid:v}})}filterTobeUnSubscribedTracks(t,i){let a=[],l=this.remoteUserMap.get(t);if(!l)return a;if(i){let p=l.get(i);if(!p)return a;a.push([t,{kind:i,id:p}])}else Array.from(l.entries()).forEach(p=>{let[f,g]=p;a.push([t,{kind:f,id:g}])});return a}filterTobeUnSubscribedDataChannels(t,i){let a=[];return i.forEach(l=>{var p;(p=this.remoteDataChannelMap.get(t))!==null&&p!==void 0&&p.has(l.id)&&a.push(l)}),a}createUnsubscribeMessage(t){let i=[];return t.forEach(a=>{let[l,{kind:p,id:f}]=a;switch(p){case We.VIDEO:return void(l._videoSSRC&&i.push({stream_type:We.VIDEO,ssrcId:l._videoSSRC}));case We.AUDIO:return void(l._audioSSRC&&i.push({stream_type:We.AUDIO,ssrcId:l._audioSSRC}))}}),i}createUnsubscribeAllMessage(t){let i=new Map;return t.forEach(a=>{let[l,{kind:p}]=a;if(i.has(l)){let f=i.get(l);p===We.VIDEO?f|=On.Video:f|=On.Audio,i.set(l,f)}else p===We.VIDEO?i.set(l,On.Video):i.set(l,On.Audio)}),{users:Array.from(i.entries()).map(a=>{let[l,p]=a;return{stream_id:l.uid,stream_type:p}})}}withdrawRemoteTracks(t){t.forEach(i=>{let[a,{kind:l}]=i,p=this.remoteUserMap.get(a);p&&(p.delete(l),Array.from(p.entries()).length===0&&this.remoteUserMap.delete(a))})}async updateBitrateLimit(t){let i=this.localTrackMap.get(Ke.LocalVideoTrack),a=this.localTrackMap.get(Ke.LocalVideoLowTrack);i&&await i.track.setBitrateLimit(t.uplink),a&&t.low_stream_uplink&&await a.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,i){return t.map((a,l)=>{var p;let{stream_type:f}=a;return(p=i.find(g=>{let{stream_type:v}=g;return f===v}))===null||p===void 0?void 0:p.attributes})}async tryToUnmuteAudio(t){for(let a=0;a<t.length;a++)if(t[a]instanceof Vn){var i;let l=this.filterTobeUnmutedTracks(t[a]);if(l.length===0)continue;await((i=this.connection)===null||i===void 0?void 0:i.unmuteLocal(l.map(f=>{let[,{id:g}]=f;return g})));let p=this.createUnmuteMessage(l);return void await fn(this,wt.RequestUnmuteLocal,p)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var i;return!((i=this.connection)===null||i===void 0||!i.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,i)=>this.emit(wt.RequestUpload,t,i),this.statsUploader.requestUploadStats=t=>this.emit(wt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Qr(eu(this.dtlsFailedCount,dr)),this.emit(wt.RequestReconnect)}async reconnectP2P(){let t=Array.from(this.localTrackMap.entries()),i=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),i.length>0&&await In(this,wt.RequestUnpublishForReconnectPC,i),this.disconnectForReconnect(),this.emit(wt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Ke.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof jt)}throwIfTrackTypeNotMatch(t){if(t.filter(i=>i instanceof jt).length>1)throw new Ve(Z.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(i=>i instanceof Vn).length>1&&(t.some(i=>i instanceof Vn&&i._bypassWebAudio)||!zn().webAudioMediaStreamDest))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let i of t){if(i instanceof jt&&this.pendingLocalTracks.some(a=>a instanceof jt))throw new Ve(Z.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(i instanceof Vn&&this.pendingLocalTracks.some(a=>a instanceof Vn)&&(!zn().webAudioMediaStreamDest||i._bypassWebAudio||this.pendingLocalTracks.some(a=>a instanceof Vn&&a._bypassWebAudio)))throw new Ve(Z.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,i){let a=!ce("DISABLE_DUAL_STREAM_USE_ENCODING")&&zn().supportDualStreamEncoding,l=Uh(Uh({},{width:160,height:120,framerate:15,bitrate:50}),i),p;p=a?t._mediaStreamTrack.clone():Jb(t,l);let f=si(8,"track-low-"),g=new jt(p,Uh(Uh({},a&&{scaleResolutionDownBy:oC(l,t)}),{},{frameRate:l.framerate,bitrateMax:l.bitrate,bitrateMin:l.bitrate}),void 0,void 0,f);return g.on(Sh.TRANSCEIVER_UPDATED,v=>{t._updateRtpTransceiver(v,pa.LOW_STREAM)}),g._hints.push(Un.LOW_STREAM),t.addListener(ut.NEED_CLOSE,()=>{g.close()}),g}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,i,a){let l=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof zi){var p,f,g,v;let y=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:I,dtlsTransportState:b,peerConnectionState:k}=this.connection,{local:U,remote:J}=await this.connection.getSelectedCandidatePair();Tt.pcStats(this.store.sessionId,{startTime:y,eventElapse:t-y||0,iceconnectionsate:I,dtlsstate:b,connectionstate:k,intSucc:i?1:2,error:l,selectedLocalCandidateProtocol:(p=U==null?void 0:U.protocol)!==null&&p!==void 0?p:"",selectedLocalCandidateType:(f=U.candidateType)!==null&&f!==void 0?f:"",selectedLocalCandidateAddress:"".concat(U.address,":").concat(U.port),selectedRemoteCandidateProtocol:(g=J.protocol)!==null&&g!==void 0?g:"",selectedRemoteCandidateType:(v=J.candidateType)!==null&&v!==void 0?v:"",selectedRemoteCandidateAddress:"".concat(J.address,":").concat(J.port),restartCnt:a})}}reportVideoFirstFrameDecoded(t,i,a,l){var p;let f=Array.from(Ho(p=this.remoteUserMap).call(p)).find(g=>g._videoSSRC===t);if(f){l||this.store.subscribe(f.uid,"video",void 0,void 0,void 0,void 0,Date.now());let g=this.store.keyMetrics,v=g.subscribe.find(y=>y.userId===f.uid&&y.type==="video");Tt.firstRemoteVideoDecode(this.store.sessionId,kt.FIRST_VIDEO_DECODE,ai.FIRST_VIDEO_DECODE,{peer:f._uintid,videowidth:i,videoheight:a,subscribeElapse:Is.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:g.requestAPEnd||0,apStart:g.requestAPStart||0,joinGwEnd:g.joinGatewayEnd||0,joinGwStart:g.joinGatewayStart||0,pcEnd:g.peerConnectionEnd||0,pcStart:g.peerConnectionStart||0,subscriberEnd:(v==null?void 0:v.subscribeEnd)||0,subscriberStart:(v==null?void 0:v.subscribeStart)||0,videoAddNotify:(v==null?void 0:v.streamAdded)||0,state:l?1:0})}}async remoteMediaSsrcChanged(t,i,a){if(!this.connection)return!1;let l=this.remoteUserMap.get(t);if(!l)return!1;let p=l.get(i);if(!p)return!1;let f=await this.connection.getRemoteSSRC(p);return f!==void 0&&f!==a}resetConnection(t){x.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===Yt.Connected?(x.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===Lp.datachannel?new Lr({},this.store):this.isPlanB?new Pr({},this.store):new zi({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[i,{track:a}]=t;i===Ke.LocalVideoLowTrack?a._updateRtpTransceiver(void 0,pa.LOW_STREAM):a._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof zi&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===$r.TCP_RESTART&&t===vs.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,$r.DISCONNECTED_OR_FAILED)))}}function Xs(s,t,i){let a=s[t];if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let l=this.mutex,p=await l.lock("From P2PChannel.".concat(t));try{for(var f=arguments.length,g=new Array(f),v=0;v<f;v++)g[v]=arguments[v];return await a.apply(this,g)}finally{p()}},i}function n0(s){let t=kk();return function(i,a){let l=i.appId;l!==void 0&&(Fn(a,10),Fd(a,l));let p=i.cid;p!==void 0&&(Fn(a,16),Fn(a,p));let f=i.cname;f!==void 0&&(Fn(a,26),Fd(a,f));let g=i.deviceId;g!==void 0&&(Fn(a,34),Fd(a,g));let v=i.elapse;v!==void 0&&(Fn(a,40),ku(a,v));let y=i.fileSize;y!==void 0&&(Fn(a,48),ku(a,_m(y)));let I=i.height;I!==void 0&&(Fn(a,56),ku(a,_m(I)));let b=i.jpg;b!==void 0&&(Fn(a,66),Fn(a,b.length),function(Ia,He){let rt=Il(Ia,He.length);Ia.bytes.set(He,rt)}(a,b));let k=i.networkType;k!==void 0&&(Fn(a,72),ku(a,_m(k)));let U=i.osType;U!==void 0&&(Fn(a,80),ku(a,_m(U)));let J=i.requestId;J!==void 0&&(Fn(a,90),Fd(a,J));let K=i.sdkVersion;K!==void 0&&(Fn(a,98),Fd(a,K));let q=i.sequence;q!==void 0&&(Fn(a,104),ku(a,_m(q)));let te=i.sid;te!==void 0&&(Fn(a,114),Fd(a,te));let de=i.timestamp;de!==void 0&&(Fn(a,120),ku(a,de));let he=i.uid;he!==void 0&&(Fn(a,128),Fn(a,he));let Ue=i.vid;Ue!==void 0&&(Fn(a,136),Fn(a,Ue));let Re=i.width;Re!==void 0&&(Fn(a,144),ku(a,_m(Re)));let Ie=i.service;Ie!==void 0&&(Fn(a,152),Fn(a,Ie));let De=i.callbackData;De!==void 0&&(Fn(a,162),Fd(a,De));let Ne=i.jpgEncryption;Ne!==void 0&&(Fn(a,168),Fn(a,Ne));let Xe=i.requestType;Xe!==void 0&&(Fn(a,176),Fn(a,Xe));let nt=i.scorePorn;nt!==void 0&&(Fn(a,185),sv(a,nt));let Vt=i.scoreSexy;Vt!==void 0&&(Fn(a,193),sv(a,Vt));let rn=i.scoreNeutral;rn!==void 0&&(Fn(a,201),sv(a,rn));let ui=i.scene;ui!==void 0&&(Fn(a,208),Fn(a,ui));let Ki=i.ossFilePrefix;Ki!==void 0&&(Fn(a,218),Fd(a,Ki));let _i=i.serviceVendor;if(_i!==void 0)for(let Ia of _i){Fn(a,226);let He=kk();Dk(Ia,He),Fn(a,He.limit),o0(a,He),j3(He)}}(s,t),function(i){let a=i.bytes,l=i.limit;return a.length===l?a:a.subarray(0,l)}(t)}function fm(s){return function(i){let a={};e:for(;!Lk(i);){let l=Al(i);switch(l>>>3){case 0:break e;case 1:a.code=Al(i);break;case 2:a.msg=s0(i,Al(i));break;case 3:{let p=V3(i);a.data=Nk(i),i.limit=p;break}default:rv(i,7&l)}}return a}({bytes:t=s,offset:0,limit:t.length});var t}function Nk(s){let t={};e:for(;!Lk(s);){let i=Al(s);switch(i>>>3){case 0:break e;case 1:t.requestId=s0(s,Al(s));break;case 2:t.requestType=Al(s)>>>0;break;case 3:t.scorePorn=Em(s);break;case 4:t.scoreSexy=Em(s);break;case 5:t.scoreNeutral=Em(s);break;case 6:t.requestScene=Al(s)>>>0;break;case 7:t.scene=Al(s)>>>0;break;default:rv(s,7&i)}}return t}function Dk(s,t){let i=s.service;i!==void 0&&(Fn(t,8),Fn(t,i));let a=s.vendor;a!==void 0&&(Fn(t,16),Fn(t,a));let l=s.token;l!==void 0&&(Fn(t,26),Fd(t,l));let p=s.callbackUrl;p!==void 0&&(Fn(t,34),Fd(t,p))}function V3(s){let t=Al(s),i=s.limit;return s.limit=s.offset+t,i}function rv(s,t){switch(t){case 0:for(;128&Pu(s););break;case 2:r0(s,Al(s));break;case 5:r0(s,4);break;case 1:r0(s,8);break;default:throw new Error("Unimplemented type: "+t)}}Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Object,Boolean]),Y("design:returntype",Pe)],Ir.prototype,"startP2PConnection",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Object,Object,Array,Object,String,String]),Y("design:returntype",Pe)],Ir.prototype,"connect",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",void 0)],Ir.prototype,"updateRemoteRTPCapabilities",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Object,Object,Array,Object,String,String]),Y("design:returntype",Pe)],Ir.prototype,"preConnect",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Ir.prototype,"publishDataChannel",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Ir.prototype,"unpublish",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Ir.prototype,"unpublishDataChannel",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Ir.prototype,"unpublishLowStream",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,Array]),Y("design:returntype",Pe)],Ir.prototype,"subscribeDataChannel",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,String,Number,Number,Array]),Y("design:returntype",Pe)],Ir.prototype,"subscribe",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Ir.prototype,"massSubscribe",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,String,Boolean]),Y("design:returntype",Pe)],Ir.prototype,"unsubscribe",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,Array]),Y("design:returntype",Pe)],Ir.prototype,"unsubscribeDataChannel",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Ir.prototype,"massUnsubscribe",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,String]),Y("design:returntype",Pe)],Ir.prototype,"muteRemote",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,String]),Y("design:returntype",Pe)],Ir.prototype,"unmuteRemote",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,String]),Y("design:returntype",Pe)],Ir.prototype,"hasRemoteMediaWithLock",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Ir.prototype,"disconnectForReconnect",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Ir.prototype,"updateBitrateLimit",null),Be([Xs,Y("design:type",Function),Y("design:paramtypes",[ms,String,Number]),Y("design:returntype",Pe)],Ir.prototype,"remoteMediaSsrcChanged",null);let F3=new Float32Array(1);new Uint8Array(F3.buffer);let i0=new Float64Array(1),$o=new Uint8Array(i0.buffer);function _m(s){return{low:s|=0,high:s>>31,unsigned:s>=0}}let Pk=[];function kk(){let s=Pk.pop();return s?(s.offset=s.limit=0,s):{bytes:new Uint8Array(64),offset:0,limit:0}}function j3(s){Pk.push(s)}function r0(s,t){if(s.offset+t>s.limit)throw new Error("Skip past limit");s.offset+=t}function Lk(s){return s.offset>=s.limit}function Il(s,t){let i=s.bytes,a=s.offset,l=s.limit,p=a+t;if(p>i.length){let f=new Uint8Array(2*p);f.set(i),s.bytes=f}return s.offset=p,p>l&&(s.limit=p),a}function Bf(s,t){let i=s.offset;if(i+t>s.limit)throw new Error("Read past limit");return s.offset+=t,i}function s0(s,t){let i=Bf(s,t),a=String.fromCharCode,l=s.bytes,p="�",f="";for(let g=0;g<t;g++){let v,y,I,b,k=l[g+i];128&k?(224&k)==192?g+1>=t?f+=p:(v=l[g+i+1],(192&v)!=128?f+=p:(b=(31&k)<<6|63&v,b<128?f+=p:(f+=a(b),g++))):(240&k)==224?g+2>=t?f+=p:(v=l[g+i+1],y=l[g+i+2],(49344&(v|y<<8))!=32896?f+=p:(b=(15&k)<<12|(63&v)<<6|63&y,b<2048||b>=55296&&b<=57343?f+=p:(f+=a(b),g+=2))):(248&k)==240?g+3>=t?f+=p:(v=l[g+i+1],y=l[g+i+2],I=l[g+i+3],(12632256&(v|y<<8|I<<16))!=8421504?f+=p:(b=(7&k)<<18|(63&v)<<12|(63&y)<<6|63&I,b<65536||b>1114111?f+=p:(b-=65536,f+=a(55296+(b>>10),56320+(1023&b)),g+=3))):f+=p:f+=a(k)}return f}function Fd(s,t){let i=t.length,a=0;for(let f=0;f<i;f++){let g=t.charCodeAt(f);g>=55296&&g<=56319&&f+1<i&&(g=(g<<10)+t.charCodeAt(++f)-56613888),a+=g<128?1:g<2048?2:g<65536?3:4}Fn(s,a);let l=Il(s,a),p=s.bytes;for(let f=0;f<i;f++){let g=t.charCodeAt(f);g>=55296&&g<=56319&&f+1<i&&(g=(g<<10)+t.charCodeAt(++f)-56613888),g<128?p[l++]=g:(g<2048?p[l++]=g>>6&31|192:(g<65536?p[l++]=g>>12&15|224:(p[l++]=g>>18&7|240,p[l++]=g>>12&63|128),p[l++]=g>>6&63|128),p[l++]=63&g|128)}}function o0(s,t){let i=Il(s,t.limit),a=s.bytes,l=t.bytes;for(let p=0,f=t.limit;p<f;p++)a[p+i]=l[p]}function Pu(s){return s.bytes[Bf(s,1)]}function hS(s,t){let i=Il(s,1);s.bytes[i]=t}function Em(s){let t=Bf(s,8),i=s.bytes;return $o[0]=i[t++],$o[1]=i[t++],$o[2]=i[t++],$o[3]=i[t++],$o[4]=i[t++],$o[5]=i[t++],$o[6]=i[t++],$o[7]=i[t++],i0[0]}function sv(s,t){let i=Il(s,8),a=s.bytes;i0[0]=t,a[i++]=$o[0],a[i++]=$o[1],a[i++]=$o[2],a[i++]=$o[3],a[i++]=$o[4],a[i++]=$o[5],a[i++]=$o[6],a[i++]=$o[7]}function Al(s){let t,i=0,a=0;do t=Pu(s),i<32&&(a|=(127&t)<<i),i+=7;while(128&t);return a}function Fn(s,t){for(t>>>=0;t>=128;)hS(s,127&t|128),t>>>=7;hS(s,t)}function ku(s,t){let i=t.low>>>0,a=(t.low>>>28|t.high<<4)>>>0,l=t.high>>>24,p=l===0?a===0?i<16384?i<128?1:2:i<1<<21?3:4:a<16384?a<128?5:6:a<1<<21?7:8:l<128?9:10,f=Il(s,p),g=s.bytes;switch(p){case 10:g[f+9]=l>>>7&1;case 9:g[f+8]=p!==9?128|l:127&l;case 8:g[f+7]=p!==8?a>>>21|128:a>>>21&127;case 7:g[f+6]=p!==7?a>>>14|128:a>>>14&127;case 6:g[f+5]=p!==6?a>>>7|128:a>>>7&127;case 5:g[f+4]=p!==5?128|a:127&a;case 4:g[f+3]=p!==4?i>>>21|128:i>>>21&127;case 3:g[f+2]=p!==3?i>>>14|128:i>>>14&127;case 2:g[f+1]=p!==2?i>>>7|128:i>>>7&127;case 1:g[f]=p!==1?128|i:127&i}}function ov(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}let Mk=new Map([["moderation",1],["supervise",2]]);class pS extends ri{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;let i=this._connectionState;this._connectionState=t,this.emit(ci.CONNECTION_STATE_CHANGE,i,t)}get inspectType(){return this._inspectType}set inspectType(t){var i;this._inspectMode=oh(i=t.map(a=>Mk.get(a)||0)).call(i,(a,l)=>a+l),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),P(this,"name","AgoraRTCVideoContentInspect"),P(this,"_connectionState",Gr.CONNECTING),P(this,"_innerConnectionState",void 0),P(this,"sequence",0),P(this,"inspectStartTime",void 0),P(this,"workerManagerConnection",void 0),P(this,"workerConnection",void 0),P(this,"workerMessageLengthLimit",void 0),P(this,"inspectIntervalMinimum",void 0),P(this,"qualityRatio",void 0),P(this,"_connectInfo",void 0),P(this,"_cancelTokenSource",mr.CancelToken.source()),P(this,"_retryConfig",void 0),P(this,"wmSequence",0),P(this,"inspectInterval",void 0),P(this,"inspectTimer",null),P(this,"ossFilePrefix",void 0),P(this,"extraInfo",void 0),P(this,"_inspectType",void 0),P(this,"_inspectMode",void 0),P(this,"_quality",1),P(this,"qualityTimer",null),P(this,"_inspectId",void 0),P(this,"_needWorkUrlOnly",!1),P(this,"inspectImage",()=>{if(this.connectionState!==Gr.CONNECTED)throw new Ce(Z.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Gr.CONNECTED?this.requestToInspectImage():x.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=si(5,"inspect-"),this.workerMessageLengthLimit=ce("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=ce("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=ce("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Up("worker-manager-"+this._inspectId,dr),this.on(ci.STATE_CHANGE,(i,a)=>{this._innerConnectionState=i,x.debug("[".concat(this._inspectId,"] Inspect operation :").concat(la[i]," ").concat(a||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Up("worker-"+this._inspectId,dr),this.handleWorkerEvents()}async init(t,i){this.emit(ci.STATE_CHANGE,la.CONNECT_AP),this._connectInfo=t;let a=this._cancelTokenSource.token;return this._retryConfig=i,new Pe((l,p)=>{this.on(ci.CONNECTION_STATE_CHANGE,(f,g)=>{g===Gr.CONNECTED&&l()}),this.requestAP(t,a,i).then(f=>{this.connectWorkerManager(f)}).catch(f=>{p(f)})})}async requestAP(t,i,a){let l=ce("WEBCS_DOMAIN").map(g=>"https://".concat(g,"/api/v1")),p=await function(g,v,y,I){let{appId:b,areaCode:k,cname:U,sid:J,token:K,uid:q}=v;jp++;let te="image_moderation_api",de={service_name:te,json_body:JSON.stringify({appId:b,areaCode:k,cname:U,command:"allocateEdge",requestId:jp,seq:jp,sid:J,token:K,ts:Date.now(),uid:q+""})},he,Ue,Re=g[0];return ca(async()=>{he=Date.now();let Ie=await Kc(Re,{data:de,cancelToken:y,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(Ue=Date.now()-he,Ie.code!==0){let nt=new Ce(Z.UNEXPECTED_RESPONSE,"image inspect ap error, code"+Ie.code,{retry:!0,responseTime:Ue});throw x.error(nt.toString()),nt}let De=JSON.parse(Ie.json_body);if(De.code!==200){let nt=new Ce(Z.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(De.code,", reason: ").concat(De.reason),{code:De.code,responseTime:Ue});throw x.error(nt.toString()),nt}if(!De.servers||!Array.isArray(De.servers)||De.servers.length===0){let nt=new Ce(Z.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:De.code,responseTime:Ue});throw x.error(nt.toString()),nt}let Ne=ce("VIDEO_INSPECT_WORKER_MANAGER_HOST"),Xe=ce("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:De.servers.map(nt=>{let{address:Vt,wss:rn}=nt;if(Vt&&rn)return"wss://".concat(Vt.replace(/\./g,"-"),".").concat(Ne,":").concat(Xe||rn)}).filter(nt=>!!nt),workerToken:De.workerToken,vid:De.vid,responseTime:Ue}},(Ie,De)=>(Tt.apworkerEvent(J,{success:!0,sc:200,serviceName:te,responseDetail:JSON.stringify(Ie.addressList),firstSuccess:De===0,responseTime:Ue,serverIp:g[De%g.length]}),!1),(Ie,De)=>(Tt.apworkerEvent(J,{success:!1,sc:Ie.data&&Ie.data.code||200,serviceName:te,responseTime:Ue,serverIp:g[De%g.length]}),!!(Ie.code!==Z.OPERATION_ABORTED&&Ie.code!==Z.UNEXPECTED_RESPONSE||Ie.data&&Ie.data.retry)&&(Re=g[(De+1)%g.length],!0)),I)}(l,t,i,a);this.emit(ci.STATE_CHANGE,la.AP_CONNECTED);let{addressList:f}=p;return this.wmSequence++,f}async connectWorkerManager(t){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=i,this.emit(ci.STATE_CHANGE,la.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(xt.CONNECTED,async()=>{this.emit(ci.STATE_CHANGE,la.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(xt.CLOSED,()=>{this._innerConnectionState<la.GET_WORKER_MANAGER_RESPONSE&&x.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(xt.FAILED,()=>{this._innerConnectionState<la.GET_WORKER_MANAGER_RESPONSE&&x.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(xt.RECONNECTING,()=>{this._innerConnectionState<la.GET_WORKER_MANAGER_RESPONSE&&x.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(xt.ON_MESSAGE,async t=>{this.emit(ci.STATE_CHANGE,la.GET_WORKER_MANAGER_RESPONSE);let i=this.workerManagerConnection.url;this.workerManagerConnection.close();let a=JSON.parse(t.data);if(a.code!==200)throw x.error("[".concat(this._inspectId,"] Unexpected code ").concat(a.code," from worker manager")),new Ce(Z.UNEXPECTED_RESPONSE,"response code of worker is unexpected",a);if(!(a.serverResponse&&a.serverResponse.portWss&&i))throw x.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(a))),new Ce(Z.UNEXPECTED_RESPONSE,"response content of worker is unexpected",a);{let l=ce("VIDEO_INSPECT_WORKER_PORT")||a.serverResponse.portWss,p=i.replace(/:\d+\/?$/,":".concat(l));this.emit(ci.STATE_CHANGE,la.CONNECT_WORKER,p),this._needWorkUrlOnly?this.emit(ci.REQUEST_NEW_WORKER_URL,p):await this.connectWorker(p)}}),this.workerManagerConnection.on(xt.WILL_RECONNECT,(t,i,a)=>{a(t)}),this.workerManagerConnection.on(xt.REQUEST_NEW_URLS,(t,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(i)})}handleWorkerEvents(){this.workerConnection.on(xt.CONNECTED,async()=>{this.emit(ci.STATE_CHANGE,la.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Gr.CONNECTED}),this.workerConnection.on(xt.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){let a=fm(new Uint8Array(t.data));if(ce("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&x.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(a)),a.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(ci.INSPECT_RESULT,void 0,void 0);if(a.data&&a.data.scorePorn&&a.data.scoreSexy&&a.data.scoreNeutral){var i;let l={porn:a.data.scorePorn,sexy:a.data.scoreSexy,neutral:a.data.scoreNeutral},p=oh(i=Object.keys(l)).call(i,(g,v)=>l[g]>l[v]?g:v,"porn"),f=Object.keys(l).find(g=>g===p);this.emit(ci.INSPECT_RESULT,f)}else this.emit(ci.INSPECT_RESULT,void 0,new Ce(Z.UNEXPECTED_RESPONSE,a.code+"","There is an unexpected data on message"))}else this.emit(ci.INSPECT_RESULT,void 0,new Ce(Z.UNEXPECTED_RESPONSE,a.code+"",a.msg))}else x.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(ci.INSPECT_RESULT,void 0,new Ce(Z.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(xt.CLOSED,()=>{this.connectionState=Gr.CLOSED}),this.workerConnection.on(xt.FAILED,()=>{this.connectionState=Gr.CLOSED}),this.workerConnection.on(xt.RECONNECTING,()=>{this.connectionState=this.connectionState===Gr.CONNECTED?Gr.RECONNECTING:Gr.CONNECTING}),this.workerConnection.on(xt.WILL_RECONNECT,(t,i,a)=>{t==="recover"&&a(t),a("tryNext")}),this.workerConnection.on(xt.REQUEST_NEW_URLS,(t,i)=>{this.workerManagerConnection.close(),this.once(ci.REQUEST_NEW_WORKER_URL,a=>{t([a])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(a=>{this.connectWorkerManager(a,!0)}).catch(a=>{i(a)})})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){this.sequence++;let t=us(this,ci.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(ci.INSPECT_RESULT,void 0,new Ce(Z.INVALID_OPERATION,"Only the track being played can be inspected"));let a=await this.generateRequestData(t,i);this.workerConnection.sendMessage(a,!0,!0)}else this.emit(ci.INSPECT_RESULT,void 0,new Ce(Z.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,i){let{appId:a,cname:l,cid:p,vid:f,sid:g,uid:v}=i,y=Date.now(),I=await t.getCurrentFrameImage("image/jpeg",this.quality),b=await Ng(I,a,l),k=this.sequence+"-"+p+"-"+v+"-"+y+"-"+si(12,""),U={appId:a,cid:p,cname:l,deviceId:"",elapse:pS.intToLong(Number(y-this.inspectStartTime)),fileSize:b.byteLength,jpgEncryption:2,height:I.height,width:I.width,jpg:b,networkType:6,osType:7,requestId:k,sdkVersion:"4.20.0",sequence:this.sequence,sid:g,timestamp:pS.intToLong(y),uid:v,vid:f,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete U.callbackData,this.ossFilePrefix===void 0&&delete U.ossFilePrefix;let J=n0(U);if(J.byteLength<this.workerMessageLengthLimit){if(ce("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let K=function(q){for(var te=1;te<arguments.length;te++){var de=arguments[te]!=null?arguments[te]:{};te%2?ov(Object(de),!0).forEach(function(he){P(q,he,de[he])}):Object.getOwnPropertyDescriptors?Object.defineProperties(q,Object.getOwnPropertyDescriptors(de)):ov(Object(de)).forEach(function(he){Object.defineProperty(q,he,Object.getOwnPropertyDescriptor(de,he))})}return q}({},U);delete K.jpg,x.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(K))}return J}{let K=this.quality*this.qualityRatio;return this.quality=K,await this.generateRequestData(t,{appId:a,cname:l,cid:p,vid:f,sid:g,uid:v})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=mr.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Gr.CLOSED,this.emit(ci.STATE_CHANGE,la.CLOSED)}}function a0(s){let t=function(){let i=av.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(i,a){let l=i.appId;l!==void 0&&(fi(a,10),Rc(a,l));let p=i.cid;p!==void 0&&(fi(a,16),fi(a,p));let f=i.cname;f!==void 0&&(fi(a,26),Rc(a,f));let g=i.deviceId;g!==void 0&&(fi(a,34),Rc(a,g));let v=i.elapse;v!==void 0&&(fi(a,40),yc(a,v));let y=i.fileSize;y!==void 0&&(fi(a,48),yc(a,Lu(y)));let I=i.height;I!==void 0&&(fi(a,56),yc(a,Lu(I)));let b=i.jpg;b!==void 0&&(fi(a,66),fi(a,b.length),d0(a,b));let k=i.networkType;k!==void 0&&(fi(a,72),yc(a,Lu(k)));let U=i.osType;U!==void 0&&(fi(a,80),yc(a,Lu(U)));let J=i.requestId;J!==void 0&&(fi(a,90),Rc(a,J));let K=i.sdkVersion;K!==void 0&&(fi(a,98),Rc(a,K));let q=i.sequence;q!==void 0&&(fi(a,104),yc(a,Lu(q)));let te=i.sid;te!==void 0&&(fi(a,114),Rc(a,te));let de=i.timestamp;de!==void 0&&(fi(a,120),yc(a,de));let he=i.uid;he!==void 0&&(fi(a,128),fi(a,he));let Ue=i.vid;Ue!==void 0&&(fi(a,136),fi(a,Ue));let Re=i.width;Re!==void 0&&(fi(a,144),yc(a,Lu(Re)));let Ie=i.service;Ie!==void 0&&(fi(a,152),fi(a,Ie));let De=i.callbackData;De!==void 0&&(fi(a,162),fi(a,De.length),d0(a,De));let Ne=i.ticket;Ne!==void 0&&(fi(a,170),Rc(a,Ne));let Xe=i.vendorConfigs;Xe!==void 0&&(fi(a,178),Rc(a,Xe))}(s,t),function(i){let a=i.bytes,l=i.limit;return a.length===l?a:a.subarray(0,l)}(t)}function Uk(s){return function(i){let a={};e:for(;!c0(i);){let l=jd(i);switch(l>>>3){case 0:break e;case 1:a.code=jd(i);break;case 2:a.msg=dv(i,jd(i));break;case 3:a.requestId=dv(i,jd(i));break;case 4:a.timestamp=u0(i,!1);break;default:xk(i,7&l)}}return a}({bytes:t=s,offset:0,limit:t.length});var t}function xk(s,t){switch(t){case 0:for(;128&Ms(s););break;case 2:mS(s,jd(s));break;case 5:mS(s,4);break;case 1:mS(s,8);break;default:throw new Error("Unimplemented type: "+t)}}function Lu(s){return{low:s|=0,high:s>>31,unsigned:s>=0}}let av=[];function mS(s,t){if(s.offset+t>s.limit)throw new Error("Skip past limit");s.offset+=t}function c0(s){return s.offset>=s.limit}function Gf(s,t){let i=s.bytes,a=s.offset,l=s.limit,p=a+t;if(p>i.length){let f=new Uint8Array(2*p);f.set(i),s.bytes=f}return s.offset=p,p>l&&(s.limit=p),a}function cv(s,t){let i=s.offset;if(i+t>s.limit)throw new Error("Read past limit");return s.offset+=t,i}function d0(s,t){let i=Gf(s,t.length);s.bytes.set(t,i)}function dv(s,t){let i=cv(s,t),a=String.fromCharCode,l=s.bytes,p="�",f="";for(let g=0;g<t;g++){let v,y,I,b,k=l[g+i];128&k?(224&k)==192?g+1>=t?f+=p:(v=l[g+i+1],(192&v)!=128?f+=p:(b=(31&k)<<6|63&v,b<128?f+=p:(f+=a(b),g++))):(240&k)==224?g+2>=t?f+=p:(v=l[g+i+1],y=l[g+i+2],(49344&(v|y<<8))!=32896?f+=p:(b=(15&k)<<12|(63&v)<<6|63&y,b<2048||b>=55296&&b<=57343?f+=p:(f+=a(b),g+=2))):(248&k)==240?g+3>=t?f+=p:(v=l[g+i+1],y=l[g+i+2],I=l[g+i+3],(12632256&(v|y<<8|I<<16))!=8421504?f+=p:(b=(7&k)<<18|(63&v)<<12|(63&y)<<6|63&I,b<65536||b>1114111?f+=p:(b-=65536,f+=a(55296+(b>>10),56320+(1023&b)),g+=3))):f+=p:f+=a(k)}return f}function Rc(s,t){let i=t.length,a=0;for(let f=0;f<i;f++){let g=t.charCodeAt(f);g>=55296&&g<=56319&&f+1<i&&(g=(g<<10)+t.charCodeAt(++f)-56613888),a+=g<128?1:g<2048?2:g<65536?3:4}fi(s,a);let l=Gf(s,a),p=s.bytes;for(let f=0;f<i;f++){let g=t.charCodeAt(f);g>=55296&&g<=56319&&f+1<i&&(g=(g<<10)+t.charCodeAt(++f)-56613888),g<128?p[l++]=g:(g<2048?p[l++]=g>>6&31|192:(g<65536?p[l++]=g>>12&15|224:(p[l++]=g>>18&7|240,p[l++]=g>>12&63|128),p[l++]=g>>6&63|128),p[l++]=63&g|128)}}function Ms(s){return s.bytes[cv(s,1)]}function l0(s,t){let i=Gf(s,1);s.bytes[i]=t}function jd(s){let t,i=0,a=0;do t=Ms(s),i<32&&(a|=(127&t)<<i),i+=7;while(128&t);return a}function fi(s,t){for(t>>>=0;t>=128;)l0(s,127&t|128),t>>>=7;l0(s,t)}function u0(s,t){let i,a=0,l=0,p=0;return i=Ms(s),a=127&i,128&i&&(i=Ms(s),a|=(127&i)<<7,128&i&&(i=Ms(s),a|=(127&i)<<14,128&i&&(i=Ms(s),a|=(127&i)<<21,128&i&&(i=Ms(s),l=127&i,128&i&&(i=Ms(s),l|=(127&i)<<7,128&i&&(i=Ms(s),l|=(127&i)<<14,128&i&&(i=Ms(s),l|=(127&i)<<21,128&i&&(i=Ms(s),p=127&i,128&i&&(i=Ms(s),p|=(127&i)<<7))))))))),{low:a|l<<28,high:l>>>4|p<<24,unsigned:t}}function yc(s,t){let i=t.low>>>0,a=(t.low>>>28|t.high<<4)>>>0,l=t.high>>>24,p=l===0?a===0?i<16384?i<128?1:2:i<1<<21?3:4:a<16384?a<128?5:6:a<1<<21?7:8:l<128?9:10,f=Gf(s,p),g=s.bytes;switch(p){case 10:g[f+9]=l>>>7&1;case 9:g[f+8]=p!==9?128|l:127&l;case 8:g[f+7]=p!==8?a>>>21|128:a>>>21&127;case 7:g[f+6]=p!==7?a>>>14|128:a>>>14&127;case 6:g[f+5]=p!==6?a>>>7|128:a>>>7&127;case 5:g[f+4]=p!==5?128|a:127&a;case 4:g[f+3]=p!==4?i>>>21|128:i>>>21&127;case 3:g[f+2]=p!==3?i>>>14|128:i>>>14&127;case 2:g[f+1]=p!==2?i>>>7|128:i>>>7&127;case 1:g[f]=p!==1?128|i:127&i}}let ea={},Ic={},fS=4294967296,Vk=fS*fS,Fk=Vk/2;Gk(0,!0);let jk=Gk(0),B3=Wf(0,-2147483648,!1),Bk=Wf(-1,2147483647,!1);function Gk(s,t){let i,a,l;return t?(l=0<=(s>>>=0)&&s<256)&&(a=Ic[s],a)?a:(i=Wf(s,0,!0),l&&(Ic[s]=i),i):(l=-128<=(s|=0)&&s<128)&&(a=ea[s],a)?a:(i=Wf(s,s<0?-1:0,!1),l&&(ea[s]=i),i)}function Wf(s,t,i){return{low:0|s,high:0|t,unsigned:!!i}}function Wk(s,t){if(isNaN(s))return jk;{if(s<=-Fk)return B3;if(s+1>=Fk)return Bk}return s<0?jk:Wf(s%fS|0,s/fS|0,t)}function _S(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}class Hf extends ri{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;let i=this._connectionState;this._connectionState=t,this.emit(xa.CONNECTION_STATE_CHANGE,t,i)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var i;super(),P(this,"name","AgoraRTCImageModeration"),P(this,"_connectionState",es.CONNECTING),P(this,"_sequence",0),P(this,"_moderationStartTime",void 0),P(this,"_workerConnection",void 0),P(this,"_workerMessageLengthLimit",void 0),P(this,"_qualityRatio",void 0),P(this,"_connectInfo",void 0),P(this,"_cancelTokenSource",mr.CancelToken.source()),P(this,"_retryConfig",void 0),P(this,"_moderationInterval",void 0),P(this,"_moderationTimer",null),P(this,"_moderationMode",1),P(this,"_quality",1),P(this,"_qualityTimer",null),P(this,"_ticket",void 0),P(this,"_moderationIntervalMinimum",void 0),P(this,"_uploadFailedNum",0),P(this,"_uploadNum",0),P(this,"_uploadTimer",null),P(this,"_extraInfo",void 0),P(this,"_vendor",""),P(this,"_encoder",new TextEncoder),P(this,"_moderationId",void 0),P(this,"inspectImage",()=>{if(this.connectionState!==es.CONNECTED)throw new Ce(Z.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===es.CONNECTED?this.requestToInspectImage():x.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=si(5,"image-moderation-"),this._workerMessageLengthLimit=ce("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=ce("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(i=t.interval)!==null&&i!==void 0?i:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=ce("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Up("worker-"+this._moderationId,dr),this.on(xa.STATE_CHANGE,(a,l)=>{x.debug("[".concat(this._moderationId,"] Moderation operation :").concat(ll[a]," ").concat(l||""))}),this.handleWorkerEvents()}async init(t,i){this.emit(xa.STATE_CHANGE,ll.CONNECT_AP),this._connectInfo=t;let a=this._cancelTokenSource.token;return this._retryConfig=i,new Pe((l,p)=>{this.on(xa.CONNECTION_STATE_CHANGE,(f,g)=>{f===es.CONNECTED&&l()}),this.requestAP(t,a,i).then(f=>{this.connectWorker(f)}).catch(f=>{p(f)})})}updateConfig(t){var i;this._moderationInterval=(i=t.interval)!==null&&i!==void 0?i:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),x.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===es.CONNECTED&&this.inspectImage()}async requestAP(t,i,a){let l=ce("WEBCS_DOMAIN").map(v=>"https://".concat(v,"/api/v1")),p=await function(v,y,I,b){let{appId:k,areaCode:U,cname:J,sid:K,token:q,uid:te}=y;jp++;let de="moderation_plugin",he={service_name:de,json_body:JSON.stringify({appId:k,areaCode:U,cname:J,command:"allocateEdge",requestId:jp,seq:jp,sid:K,appToken:q,ts:Date.now(),uid:te+""})},Ue,Re,Ie=v[0];return ca(async()=>{Ue=Date.now();let De=await Kc(Ie,{data:he,cancelToken:I,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(Re=Date.now()-Ue,De.code!==0){let nt=new Ce(Z.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+De.code,{retry:!0,responseTime:Re});throw x.error(nt.toString()),nt}let Ne=JSON.parse(De.json_body);if(Ne.code!==200){let nt=new Ce(Z.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(Ne.code,", reason: ").concat(Ne.reason),{code:Ne.code,responseTime:Re});throw x.error(nt.toString()),nt}if(!Ne.servers||!Array.isArray(Ne.servers)||Ne.servers.length===0){let nt=new Ce(Z.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:Ne.code,responseTime:Re});throw x.error(nt.toString()),nt}if(!Ne.servers.some(nt=>!!nt.wss)){let nt=new Ce(Z.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:Ne.code,responseTime:Re});throw x.error(nt.toString()),nt}let Xe=ce("IMAGE_MODERATION_WORKER_HOST");return{addressList:Ne.servers.map(nt=>{let{address:Vt,wss:rn}=nt;if(Vt&&rn)return"wss://".concat(Vt.replace(/\./g,"-"),".").concat(Xe,":").concat(rn,"/moderation")}).filter(nt=>!!nt),workerToken:Ne.workerToken,vid:Ne.vid,ticket:Ne.appTicket,responseTime:Re}},(De,Ne)=>(Tt.apworkerEvent(K,{success:!0,sc:200,serviceName:de,responseDetail:JSON.stringify(De.addressList),firstSuccess:Ne===0,responseTime:Re,serverIp:v[Ne%v.length]}),!1),(De,Ne)=>(Tt.apworkerEvent(K,{success:!1,sc:De.data&&De.data.code||200,serviceName:de,responseTime:Re,serverIp:v[Ne%v.length]}),!!(De.code!==Z.OPERATION_ABORTED&&De.code!==Z.UNEXPECTED_RESPONSE||De.data&&De.data.retry)&&(Ie=v[(Ne+1)%v.length],!0)),b)}(l,t,i,a);this.emit(xa.STATE_CHANGE,ll.AP_CONNECTED);let{addressList:f,ticket:g}=p;return this._ticket=g,f}async connectWorker(t){this.emit(xa.STATE_CHANGE,ll.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(xt.CONNECTED,async()=>{this.emit(xa.STATE_CHANGE,ll.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=es.CONNECTED}),this._workerConnection.on(xt.CLOSED,()=>{this.connectionState=es.CLOSED}),this._workerConnection.on(xt.FAILED,()=>{this.connectionState=es.CLOSED}),this._workerConnection.on(xt.RECONNECTING,()=>{this.connectionState=this.connectionState===es.CONNECTED?es.RECONNECTING:es.CONNECTING}),this._workerConnection.on(xt.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){let i=Uk(new Uint8Array(t.data));ce("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&x.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),this._uploadNum++,i.code===void 0||i.code===0||(this._uploadFailedNum++,x.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{Tt.reportApiInvoke(this._connectInfo.sid||null,{name:cr.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,i.code],tag:Pi.TRACER}).onError(new Ce(Z.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),this._uploadTimer=null},ce("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else x.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(xt.WILL_RECONNECT,(t,i,a)=>{t==="recover"&&a(t),a("tryNext")}),this._workerConnection.on(xt.REQUEST_NEW_URLS,(t,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(i)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){let t=us(this,xa.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(ce("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&x.debug("Only the track being played can be inspected"));this._sequence++;let a=await this.generateRequestData(t,i);this._workerConnection.sendMessage(a,!0,!0)}else ce("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&x.debug("Only the track being published can be inspected")}async generateRequestData(t,i){let{appId:a,cname:l,cid:p,vid:f,sid:g,uid:v}=i,y=Date.now(),I=await t.getCurrentFrameImage("image/jpeg",this.quality),b=await Ng(I,a,l),k=this._sequence+"-"+p+"-"+v+"-"+y+"-"+si(12,""),U={appId:a,cid:p,cname:l,deviceId:"",elapse:Hf.intToLong(Number(y-this._moderationStartTime)),fileSize:I.buffer.byteLength,height:I.height,width:I.width,jpg:b,networkType:6,osType:7,requestId:k,sdkVersion:"4.20.0",sequence:this._sequence,sid:g,timestamp:Wk(y),uid:v,vid:f,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete U.callbackData;let J=a0(U);if(J.byteLength<this._workerMessageLengthLimit){if(ce("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let K=function(q){for(var te=1;te<arguments.length;te++){var de=arguments[te]!=null?arguments[te]:{};te%2?_S(Object(de),!0).forEach(function(he){P(q,he,de[he])}):Object.getOwnPropertyDescriptors?Object.defineProperties(q,Object.getOwnPropertyDescriptors(de)):_S(Object(de)).forEach(function(he){Object.defineProperty(q,he,Object.getOwnPropertyDescriptor(de,he))})}return q}({},U);delete K.jpg,x.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(K))}return J}{let K=this.quality*this._qualityRatio;return this.quality=K,await this.generateRequestData(t,{appId:a,cname:l,cid:p,vid:f,sid:g,uid:v})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=mr.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=es.CLOSED,this.emit(xa.STATE_CHANGE,ll.CLOSED)}}function ES(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Hk(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ES(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):ES(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}let G3=Date.now(),W3=20,Kf=new Map,Vh=new Map;async function Kk(s){let t=Kf.get(s),i=Array.isArray(t)&&t[t.length-1],a=Vh.get(s);if(!i)return void(a.isSyncing=!1);let l={uid:i.uid,payload:kT(i.payload)};a.firstRecvTs===0&&(a.firstRecvTs=i.recvTs,a.firstSendTs=i.sendTs);let p=i.sendTs-a.firstSendTs,f=p-(Date.now()-a.firstRecvTs);f>0&&(a.firstRecvTs=Date.now()-p);let g=i.mediaDelay+f;g<=0?(t.pop(),Yk(i.context,l),g=0):g=Math.min(g,W3),setTimeout(()=>t.length&&Kk(s),g)}function Yk(s,t){s.safeEmit(Dt.STREAM_MESSAGE,t.uid,t.payload),s.onStreamMessage&&s.onStreamMessage(t)}function zk(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!s.syncWithAudio)return Yk(i,{uid:s.uid,payload:kT(s.payload)});let a="".concat(i.id,"-").concat(s.uid),l=Kf.get(a)||[],p=l.findIndex(y=>s.sendTs>=y.sendTs),f=Hk(Hk({},s),{},{context:i,mediaDelay:t,recvTs:Date.now()});p===-1?l.push(f):l.splice(p,0,f),Kf.set(a,l);let g=!1;var v;Vh.has(a)?g=!((v=Vh.get(a))===null||v===void 0||!v.isSyncing):Vh.set(a,{isSyncing:g,firstRecvTs:0,firstSendTs:0}),g||Kk(a)}let Us=En().name;function h0(){return!function(s,t,i){let a=En();if(a.os!==Cr.IOS||!a.osVersion)return!1;let l=a.osVersion.split(".");return Number(l[0])<s}(16)&&!function(s,t,i){let a=En();if(a.name!==Ee.SAFARI||!a.osVersion)return!1;let l=a.version.split(".");return Number(l[0])<s}(16)}function Qt(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Mu(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Qt(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Qt(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}sn.setLogger(x);class Zn extends ri{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let i;if(super(),P(this,"store",void 0),P(this,"_uid",void 0),P(this,"_channelName",void 0),P(this,"_uintUid",void 0),P(this,"_users",[]),P(this,"_config",void 0),P(this,"_clientId",void 0),P(this,"_appId",void 0),P(this,"_sessionId",null),P(this,"_key",void 0),P(this,"_rtmConfig",{}),P(this,"_joinInfo",void 0),P(this,"_gateway",void 0),P(this,"_statsCollector",void 0),P(this,"_configDistribute",void 0),P(this,"_leaveMutex",new sn("client-leave")),P(this,"_publishMutex",new sn("client-publish")),P(this,"_renewTokenMutex",new sn("client-renewtoken")),P(this,"_subscribeMutex",new sn("client-subscribe")),P(this,"_encryptionMode","none"),P(this,"_encryptionSecret",null),P(this,"_encryptionSalt",null),P(this,"_proxyServer",void 0),P(this,"_turnServer",{servers:[],mode:"auto"}),P(this,"_cloudProxyServerMode","disabled"),P(this,"_isDualStreamEnabled",!1),P(this,"_defaultStreamFallbackType",void 0),P(this,"_lowStreamParameter",void 0),P(this,"_streamFallbackTypeCacheMap",new Map),P(this,"_remoteStreamTypeCacheMap",new Map),P(this,"_axiosCancelSource",mr.CancelToken.source()),P(this,"_audioVolumeIndicationInterval",void 0),P(this,"_networkQualityInterval",void 0),P(this,"_userOfflineTimeout",void 0),P(this,"_streamRemovedTimeout",void 0),P(this,"_injectStreamingClient",void 0),P(this,"_liveTranscodeStreamingClient",void 0),P(this,"_liveRawStreamingClient",void 0),P(this,"_channelMediaRelayClient",void 0),P(this,"_networkQualitySensitivity","normal"),P(this,"_p2pChannel",void 0),P(this,"_useLocalAccessPoint",!1),P(this,"_setLocalAPVersion",void 0),P(this,"_joinAndNotLeaveYet",!1),P(this,"_numberOfJoinCount",0),P(this,"_remoteDefaultVideoStreamType",void 0),P(this,"_inspect",void 0),P(this,"_moderation",void 0),P(this,"_license",void 0),P(this,"_pendingPublishedUsers",[]),P(this,"ntpAlignErrorCount",0),P(this,"remoteInboundOffset",0),P(this,"_handleLocalTrackEnable",(a,l,p)=>{this.publish(a,!1).then(l).catch(p)}),P(this,"_handleLocalTrackDisable",(a,l,p)=>{this.unpublish(a).then(l).catch(p)}),P(this,"_handleUserOnline",a=>{if(ce("BLOCK_LOCAL_CLIENT")&&Hs(a.uid,this.channelName))return void x.debug("[".concat(a.uid,"] will be ignored in local"));this.isStringUID&&typeof a.uid!="string"&&x.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let l=this._users.find(p=>p.uid===a.uid);if(l)l._trust_in_room_=!0,l._is_pre_created&&(l._is_pre_created=!1,this.safeEmit(Dt.USER_JOINED,l));else{let p=new ms(a.uid,a.uint_id||a.uid);this._users.push(p),x.debug("[".concat(this._clientId,"] user online"),a.uid),this.safeEmit(Dt.USER_JOINED,p)}}),P(this,"_handleUserOffline",a=>{if(ce("BLOCK_LOCAL_CLIENT")&&Hs(a.uid,this.channelName))return;let l=this._users.find(p=>p.uid===a.uid);l&&(this._handleRemoveStream(a),this._handleRemoveDataChannels(a),l._audio_pre_subscribed||l._video_pre_subscribed?l._is_pre_created=!0:Ji(this._users,l),this._remoteStreamTypeCacheMap.delete(l.uid),this._streamFallbackTypeCacheMap.delete(l.uid),x.debug("[".concat(this._clientId,"] user offline"),a.uid,"reason:",a.reason),this.safeEmit(Dt.USER_LEAVED,l,a.reason))}),P(this,"_handleAddAudioOrVideoStream",(a,l,p,f,g,v,y)=>{if(ce("BLOCK_LOCAL_CLIENT")&&Hs(l,this.channelName))return;let I=this._users.find(k=>k.uid===l);if(!I)return void x.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));x.debug("[".concat(this._clientId,"] stream added with uid ").concat(l,", type ").concat(a)),this.store.subscribe(I.uid,a,void 0,void 0,void 0,Date.now());let b=a==="audio"?I.hasAudio:I.hasVideo;I._uintid||(I._uintid=g||l),a==="audio"?I._trust_audio_stream_added_state_=!0:I._trust_video_stream_added_state_=!0,a==="audio"?(I._audio_added_=!0,p!==void 0&&(I._audioSSRC=p),f!==void 0&&(I._cname=f),v&&(I._audioOrtc=v)):(I._video_added_=!0,p!==void 0&&(I._videoSSRC=p),f!==void 0&&(I._cname=f),y!==void 0&&(I._rtxSsrcId=y),v&&(I._videoOrtc=v)),(a==="audio"?I.hasAudio:I.hasVideo)&&!b&&(x.info("[".concat(this._clientId,"] remote user ").concat(I.uid," published ").concat(a)),this.safeEmit(Dt.USER_PUBLISHED,I,a)),a==="video"?Tt.onGatewayStream(this._sessionId,kt.ON_ADD_VIDEO_STREAM,ai.ON_ADD_VIDEO_STREAM,{peer:g||l,ssrc:I._videoSSRC}):Tt.onGatewayStream(this._sessionId,kt.ON_ADD_AUDIO_STREAM,ai.ON_ADD_AUDIO_STREAM,{peer:g||l,ssrc:I._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(I,a,p).then(k=>{if(k&&(x.debug("[".concat(this._clientId,"] resubscribe ").concat(a," for user ").concat(I.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Ir))return this._p2pChannel.unsubscribe(I,a,!0).then(()=>this._subscribe(I,a,!0).catch(U=>{x.error("[".concat(this._clientId,"] resubscribe error"),U.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(I,a)&&(x.debug("[".concat(this._clientId,"] resubscribe ").concat(a," for user ").concat(I.uid," after reconnect.")),this._subscribe(I,a,!0).catch(k=>{x.error("[".concat(this._clientId,"] resubscribe error"),k.toString())}))}),P(this,"_handleRemoveStream",a=>{if(ce("BLOCK_LOCAL_CLIENT")&&Hs(a.uid,this.channelName))return;let l=this._users.find(f=>f.uid===a.uid);if(!l)return void x.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));x.debug("[".concat(this._clientId,"] stream removed with uid ").concat(a.uid));let p=()=>{};l.hasAudio&&l.hasVideo?p=()=>{x.info("[".concat(this._clientId,"] remote user ").concat(l.uid," unpublished audio track")),this.safeEmit(Dt.USER_UNPUBLISHED,l,"audio"),x.info("[".concat(this._clientId,"] remote user ").concat(l.uid," unpublished video track")),this.safeEmit(Dt.USER_UNPUBLISHED,l,"video")}:l.hasVideo?p=()=>{x.info("[".concat(this._clientId,"] remote user ").concat(l.uid," unpublished video track")),this.safeEmit(Dt.USER_UNPUBLISHED,l,"video")}:l.hasAudio&&(p=()=>{x.info("[".concat(this._clientId,"] remote user ").concat(l.uid," unpublished audio track")),this.safeEmit(Dt.USER_UNPUBLISHED,l,"audio")}),l._video_pre_subscribed||l._audio_pre_subscribed||(l._trust_audio_stream_added_state_=!0,l._trust_video_stream_added_state_=!0,l._audio_added_=!1,l._video_added_=!1,this._p2pChannel instanceof Ir&&this._p2pChannel.unsubscribe(l).then(f=>{if(f)return this._gateway.unsubscribe(f,l.uid)}),l._audioSSRC=void 0,l._videoSSRC=void 0,l._audioOrtc=void 0,l._videoOrtc=void 0,l._rtxSsrcId=void 0),Tt.onGatewayStream(this._sessionId,kt.ON_REMOVE_STREAM,ai.ON_REMOVE_STREAM,{peer:a.uint_id||a.uid}),p()}),P(this,"_handleSetStreamLocalEnable",(a,l,p)=>{if(ce("BLOCK_LOCAL_CLIENT")&&Hs(l,this.channelName))return;let f=this._users.find(y=>y.uid===l);if(!f)return void x.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));x.debug("[".concat(this._clientId,"] local ").concat(a," ").concat(p?"enabled":"disabled"," with uid ").concat(l));let g=a==="audio"?f.hasAudio:f.hasVideo;if(a==="audio"){f._trust_audio_enabled_state_=!0;let y=f._audio_enabled_;if(f._audio_enabled_=p,f._audio_enabled_===y)return;{let I=f._audio_enabled_?"enable-local-audio":"disable-local-audio";x.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(l,", msg: ").concat(I)),this.safeEmit(Dt.USER_INFO_UPDATED,l,I)}}else{f._trust_video_enabled_state_=!0;let y=f._video_enabled_;if(f._video_enabled_=p,f._video_enabled_===y)return;{let I=f._video_enabled_?"enable-local-video":"disable-local-video";x.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(l,", msg: ").concat(I)),this.safeEmit(Dt.USER_INFO_UPDATED,l,I)}}let v=a==="audio"?f.hasAudio:f.hasVideo;return g!==v?!g&&v?(x.info("[".concat(this._clientId,"] remote user ").concat(l," published ").concat(a)),void this.safeEmit(Dt.USER_PUBLISHED,f,a)):(a==="video"&&f._videoTrack&&f._videoTrack._destroy(),a==="audio"&&f._audioTrack,this._p2pChannel.muteRemote(f,a),x.info("[".concat(this._clientId,"] remote user ").concat(l," unpublished ").concat(a)),void this.safeEmit(Dt.USER_UNPUBLISHED,f,a)):void 0}),P(this,"_handleMuteStream",(a,l,p)=>{if(ce("BLOCK_LOCAL_CLIENT")&&Hs(a,this.channelName))return;x.debug("[".concat(this._clientId,"] receive mute message"),a,l,p);let f=this._users.find(y=>y.uid===a);if(!f)return void x.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(a));let g=l==="audio"?f.hasAudio:f.hasVideo;if(l==="audio"){f._trust_audio_mute_state_=!0;let y=f._audio_muted_;if(f._audio_muted_=p,f._audio_muted_===y)return;{let I=f._audio_muted_?"mute-audio":"unmute-audio";x.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(a,", msg: ").concat(I)),this.safeEmit(Dt.USER_INFO_UPDATED,a,I)}}else{f._trust_video_mute_state_=!0;let y=f._video_muted_;if(f._video_muted_=p,f._video_muted_===y)return;{let I=f._video_muted_?"mute-video":"unmute-video";x.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(a,", msg: ").concat(I)),this.safeEmit(Dt.USER_INFO_UPDATED,a,I)}}let v=l==="audio"?f.hasAudio:f.hasVideo;if(g!==v){if(!g&&v)return(l==="audio"?f._audioSSRC:f._videoSSRC)?(x.info("[".concat(this._clientId,"] remote user ").concat(a," published ").concat(l)),void this.safeEmit(Dt.USER_PUBLISHED,f,l)):void x.warning("[".concat(this._clientId,"] remote user ").concat(a," receive ").concat(l," unmute message  before add stream message, ").concat(l," SSRC doesn't exist yet."));l==="video"&&f._videoTrack&&!f._video_pre_subscribed&&f._videoTrack._destroy(),l==="audio"&&f._audioTrack,this._p2pChannel.muteRemote(f,l),x.info("[".concat(this._clientId,"] remote user ").concat(a," unpublished ").concat(l)),this.safeEmit(Dt.USER_UNPUBLISHED,f,l)}}),P(this,"_handleP2PLost",async a=>{x.debug("[".concat(this._clientId,"] receive p2p lost"),a),parseInt(a.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():x.warning("[".concat(this._clientId,"] P2PLost stream not found"),a)}),P(this,"_handleTokenWillExpire",()=>{x.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Dt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),P(this,"_handleBeforeUnload",a=>{a.type==="beforeunload"&&a.returnValue!==void 0&&a.returnValue!==""||(this.leave(),x.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),P(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(Dt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let a={downlinkNetworkQuality:0,uplinkNetworkQuality:0};a.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),a.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Dt.NETWORK_QUALITY,a)}),P(this,"_handleP2PAddAudioOrVideoStream",(a,l,p,f)=>{let g=this._users.find(y=>y.uid===l);if(!g)return void x.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));x.debug("[".concat(this._clientId,"] stream added with uid ").concat(l,", type ").concat(a)),this.store.subscribe(g.uid,a,void 0,void 0,void 0,Date.now());let v=a==="audio"?g.hasAudio:g.hasVideo;a==="audio"?g._trust_audio_stream_added_state_=!0:g._trust_video_stream_added_state_=!0,a==="audio"?(g._audio_added_=!0,p!==void 0&&(g._audioSSRC=p),f!==void 0&&(g._audioMid=f)):(g._video_added_=!0,p!==void 0&&(g._videoSSRC=p),f!==void 0&&(g._videoMid=f)),(a==="audio"?g.hasAudio:g.hasVideo)&&!v&&(x.info("[".concat(this._clientId,"] remote user ").concat(g.uid," published ").concat(a)),this.safeEmit(Dt.USER_PUBLISHED,g,a)),this._p2pChannel.hasPendingRemoteMedia(g,a)&&(x.debug("[".concat(this._clientId,"] resubscribe ").concat(a," for user ").concat(g.uid," after reconnect.")),this._subscribe(g,a,!0).catch(y=>{x.error("[".concat(this._clientId,"] resubscribe error"),y.toString())}))}),this._config=t,this._clientId=si(5,"client-"),this.store=new yw(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),x.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Gt," build: ").concat(nC,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{hn(t.clientRoleOptions),i=Object.assign({},t.clientRoleOptions)}catch(a){x.warning("[".concat(this._clientId,"] ").concat(a.toString()))}this._statsCollector=new nd(this.store),this._statsCollector.onStatsException=(a,l,p)=>{x.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(a,", msg: ").concat(l,", uid: ").concat(p)),this.safeEmit(Dt.EXCEPTION,{code:a,msg:l,uid:p})},this._statsCollector.onUploadPublishDuration=(a,l,p,f)=>{let g=this._users.find(v=>v.uid===a);g&&Tt.peerPublishStatus(this._sessionId,{subscribeElapse:f,audioPublishDuration:l,videoPublishDuration:p,peer:g._uintid})},this.store.useDataChannel=zn().supportDataChannel&&ce("SIGNAL_CHANNEL"),this.store.useP2P=t.mode==="p2p",this._gateway=new TP(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||dr,httpRetryConfig:t.httpRetryConfig||dr,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:i}),this._configDistribute=new Rn,this.store.useP2P?(this._p2pChannel=new nr(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Ir(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,i,a,l,p){let f=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],g=arguments.length>6&&arguments[6]!==void 0&&arguments[6];ei("JOIN_GATEWAY_USE_443PORT_ONLY",f),ei("JOIN_GATEWAY_USE_DUAL_DOMAIN",g);let v=this._gateway.signal.websocket;return v instanceof Eg&&(v.use443PortOnly=f,v.tryDoubleDomain=g),async function(y,I,b){NT.get(y)||NT.set(y,[]),$E.get(y)||$E.set(y,I),el.get(y)||el.set(y,0);let k=NT.get(y),U=$E.get(y);if(!k||!U)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(el.get(y)===U){let de=ZE();k.push(de),await de.promise}el.set(y,el.get(y)+1);for(var J=arguments.length,K=new Array(J>3?J-3:0),q=3;q<J;q++)K[q-3]=arguments[q];let te=await b(...K);return el.set(y,el.get(y)-1),el.get(y)===U-1&&k.length>0&&(k[0].resolve(),k.shift()),el.get(y)===0&&(NT.set(y,[]),$E.set(y,0),el.set(y,0)),te}("client.join",ce("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,i,a,l,p)}async join(t,i,a,l,p){let f=++this._numberOfJoinCount;this.store.joinStart(),l&&(this.store.uid=l);let g=QD(),v=It()?window.isSecureContext:"Browser Not Support";(!It()&&!g||!window.isSecureContext)&&x.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let y=YA();this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),x.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));let I=Tt.reportApiInvoke(y,{name:cr.JOIN,options:[t,i,a,l],states:{isHttps:g,isSecureContext:v},tag:Pi.TRACER});Tt.setAppId(t);try{if(!a&&a!==null)throw new Ce(Z.INVALID_PARAMS,"Invalid token: ".concat(a,". If you don not use token, set it to null"));a&&jr(a,"token",1,2047),jr(t,"appid",1,2047),Nw(i),l&&Dw(l),p&&jr(p,"optionalInfo",1,2047)}catch(K){throw I.onError(K),K}if(x.info("[".concat(this._clientId,"] start join channel ").concat(i,", join number: ").concat(f)),this._leaveMutex.isLocked&&(x.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),x.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){let K=new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw I.onError(K),K}this._sessionId||(this._sessionId=y,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";let b=Mu(Mu({},this._rtmConfig),{},{clientId:this._clientId,appId:t,sid:this._sessionId,cname:i,uid:typeof l!="string"?l:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:a||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:p,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(b.setLocalAPVersion=this._setLocalAPVersion),typeof l=="string"&&(b.stringUid=l,this._uintUid?(b.uid=this._uintUid,this._uintUid=void 0):b.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(b.aesmode=this._encryptionMode,b.aespassword=await RD(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(b.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:i,appId:t,stringUid:b.stringUid});let k=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&k===this._sessionId&&Tt.joinChannelTimeout(this._sessionId,5)},5e3);try{var U;let K,q=b.cloudProxyServer;if(xe(U=["proxy3","proxy4","proxy5"]).call(U,q)){let Re=ce("PROXY_SERVER_TYPE3");Array.isArray(Re)?b.proxyServer=Re[0]:b.proxyServer=Re}if(Tt.setProxyServer(b.proxyServer),x.setProxyServer(b.proxyServer),this.store.requestAPStart(),b.stringUid&&!b.uid){let Re;[Re,K]=await Pe.all([bP(b.stringUid,b,this._axiosCancelSource.token,this._config.httpRetryConfig||dr,this.store),wP(b,this._axiosCancelSource.token,this._config.httpRetryConfig||dr,!0,this.store)]),x.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(b.stringUid," => ").concat(Re)),b.uid=Re,K.gatewayInfo.uid=Re,K.gatewayInfo.res.uid=Re}else K=await wP(b,this._axiosCancelSource.token,this._config.httpRetryConfig||dr,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(b,this._axiosCancelSource.token),this._configDistribute.on(Je.UPDATE_BITRATE_LIMIT,Re=>{this._p2pChannel.updateBitrateLimit(Re)})},0),this._key=a||t;let te=K.gatewayInfo,de=b.uid?b.uid:te.uid;this._joinInfo=Mu(Mu({},b),{},{cid:te.cid,uid:de,vid:te.vid,apResponse:te.res,uni_lbs_ip:te.uni_lbs_ip,gatewayAddrs:te.gatewayAddrs}),this.store.intUid=de;let he=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));I.onSuccess(he),this._appId=t,this._channelName=b.cname,this._uid=he,this.store.uid=he,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(qt()?"beforeunload":"pagehide",this._handleBeforeUnload)},0);let Ue=b.stringUid?"string uid: ".concat(b.stringUid,",uid: ").concat(b.uid):"uid: ".concat(this._uid);return x.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(i,",").concat(Ue)),setTimeout(()=>{x.startUpload()},5e3),this.store.joinEnd(),J=this,xe(Wc).call(Wc,J)||Wc.push(J),he}catch(K){let q=Array.isArray(K)?K[0]:K;throw q&&q.code===Z.OPERATION_ABORTED?x.warning("[".concat(this._clientId,"] join number: ").concat(f,", Joining channel failed, rollback"),q):x.error("[".concat(this._clientId,"] join number: ").concat(f,", Joining channel failed, rollback"),q),q.code!==Z.OPERATION_ABORTED&&this._numberOfJoinCount===f&&(this._gateway.state="DISCONNECTED",this._reset()),I.onError(q),q}var J}_joinGateway(){if(!this._joinInfo||!this._key)throw new Ce(Z.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!ce("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(t=>t).catch(t=>{if(t.code===Z.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,dn.FALLBACK),t;if(t.code===Z.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,dn.FALLBACK),t;throw t}).then(t=>{if(t instanceof Ce){if(t.code===Z.INIT_WEBSOCKET_TIMEOUT){if(x.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new Ce(Z.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";let i=ce("PROXY_SERVER_TYPE3");if(Array.isArray(i))if(this._joinInfo.apUrl){let l=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),p=l.slice(l.length-2).join(".");i.forEach(f=>{this._joinInfo&&xe(f).call(f,p)&&(this._joinInfo.proxyServer=f)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=i[0])}else this._joinInfo.proxyServer=i[0];else this._joinInfo.proxyServer=i;let a=ce("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return a&&a[1]&&a[1]!=="443"&&x.setProxyServer(this._joinInfo.proxyServer),ce("STATS_COLLECTOR_PORT").toString()!=="443"&&Tt.setProxyServer(this._joinInfo.proxyServer),Tt.reportApiInvoke(this._sessionId,{name:cr.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:Pi.TRACER}).onSuccess(),this.safeEmit(Dt.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),ce("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(l=>{"forceturn"in l&&(l.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(x.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new Ce(Z.INVALID_OPERATION);return Tt.reportApiInvoke(this._sessionId,{name:cr.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:Pi.TRACER}).onSuccess(),this._joinGateway()}return t}).then(t=>t)}async leave(){x.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(qt()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(i){let a=Wc.indexOf(i);a!==-1&&Wc.splice(a,1)}(this);let t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return x.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED"),x.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof tn))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new Ce(Z.INVALID_PARAMS,"param list is empty");let a=t;if(this._gateway.role==="audience")throw new Ce(Z.INVALID_OPERATION,"audience can not publish stream");for(let p of a){if(!(p instanceof tn))throw new Ce(Z.INVALID_PARAMS,"parameter is not local track");if(!p._enabled&&i)throw new Ce(Z.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(p.getTrackId()))}x.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(a.map(p=>"".concat(p.getTrackId()," "))));let l=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),i&&a.forEach(p=>{let f=this._configDistribute.getBitrateLimit();p instanceof jt&&f&&p.setBitrateLimit(f.uplink)});try{await this._publishHighStream(a),x.info("[".concat(this._clientId,"] Publish success, id ").concat(a.map(p=>"".concat(p.getTrackId()," "))))}catch(p){throw x.error("[".concat(this._clientId,"] publish error"),p.toString()),p}finally{l()}}async _publishDataChannel(t){bn(t.id,"id",0,65535,!0),$l(t.ordered,"ordered"),jr(t.metadata,"metadata",0,512),x.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));let i=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(l=>l.id===t.id)!==-1)throw new Ce(Z.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new Ce(Z.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&ce("FORCE_TURN")&&!ce("TURN_ENABLE_TCP")&&!ce("TURN_ENABLE_UDP"))throw new Ce(Z.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let a=new Ld(t);await this._p2pChannel.publishDataChannel([a]);try{let l={streamId:t.id,ordered:t.ordered,maxRetransmits:ce("DATASTREAM_MAX_RETRANSMITS"),metadata:t.metadata,channelId:a._originDataChannelId};await this._gateway.publishDataChannel(this._uid,l,!0)}catch(l){if(l.code!==Z.DISCONNECT_P2P)throw l}return await a._waitTillOpen(),x.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(a.id)),a}catch(a){throw x.error("[".concat(this._clientId,"] publish datachannels error"),a.toString()),a}finally{i()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new Ce(Z.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let i=[];if(t)if(Array.isArray(t))i=t;else{if(!(t instanceof tn))return this._unpublishDataChannel([t]);i=[t]}else this.store.useP2P||await this._unpublishDataChannel(),i=this._p2pChannel.getAllTracks(!0);x.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(i.map(l=>"".concat(l.getTrackId()," "))," "));let a=await this._publishMutex.lock();try{if(this._p2pChannel instanceof nr){let l=await this._p2pChannel.unpublish(i);l&&await this._gateway.sendExtensionMessage(Hi.UNPUBLISH,{unpubMsg:l},!0)}else{let l=await this._p2pChannel.unpublish(i);l&&await this._gateway.unpublish(l,this._uid),x.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(i.map(p=>"".concat(p.getTrackId()))))}}catch(l){throw x.error("[".concat(this._clientId,"] unpublish error"),l.toString()),l}finally{a&&a()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),x.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(a=>"".concat(a.id," "))," "));let i=await this._publishMutex.lock();try{let a=await this._p2pChannel.unpublishDataChannel(t);a&&await this._gateway.unpublishDataChannel(a),x.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(l=>"".concat(l.id))))}catch(a){throw x.error("[".concat(this._clientId,"] unpublish dataChannel error"),a.toString()),a}finally{i&&i()}}async subscribe(t,i,a){return i==="datachannel"?this._subscribeDataChannel(t,a):this._subscribe(t,i)}async presubscribe(t,i){if(vr(i,"mediaType",["audio","video"]),this._p2pChannel instanceof nr)throw new Ce(Z.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));let a=i===We.AUDIO,l=i===We.VIDEO,p=await this._subscribeMutex.lock();try{let{ssrcId:f,ortc:g,rtxSsrcId:v,cname:y,uint_id:I}=await this._gateway.presubscribe(t,i,!0);if(f==null)throw new Ce(Z.UNEXPECTED_RESPONSE,"no ssrc id");let b=this._users.find(U=>U.uid===t);b||(b=new ms(t,I||t),b._is_pre_created=!0,this._users.push(b)),y&&(b._cname=y),b._uintid||(b._uintid=I||t),a&&(b._audioSSRC=f,b._audio_pre_subscribed=!0,g&&(b._audioOrtc=g)),l&&(b._videoSSRC=f,b._video_pre_subscribed=!0,g&&(b._videoOrtc=g),v!=null&&(b._rtxSsrcId=v)),x.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(f)),await this._p2pChannel.subscribe(b,i,f,v,g);let k=a?b._audioTrack:b._videoTrack;if(!k)throw new Ce(Z.UNEXPECTED_ERROR,"can not find remote track in user");return a&&(b._trust_audio_stream_added_state_=!0,b._audio_added_=!0),l&&(b._trust_video_stream_added_state_=!0,b._video_added_=!0),k}catch(f){throw x.error("[".concat(this._clientId,"] presub user ").concat(t," error"),f),f}finally{p()}}async _subscribeDataChannel(t,i){var a;if(bn(i,"channelId",0,65535,!0),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(g=>g===t))throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new Ce(Z.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new Ce(Z.INVALID_REMOTE_USER,"user is not published");let l=(a=t._dataChannels)===null||a===void 0?void 0:a.find(g=>g.id===i);if(!l)throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new Ce(Z.REMOTE_USER_IS_NOT_PUBLISHED);let p=await this._subscribeMutex.lock();x.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{let g=await this._p2pChannel.subscribeDataChannel(t,[l]);if(g&&xe(g).call(g,l.id))try{var f;if(!l._originDataChannelId)throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new Ce(Z.REMOTE_USER_IS_NOT_PUBLISHED);let v={id:l.id,datachannelId:l._originDataChannelId,ordered:l.ordered,maxRetransmits:l.maxRetransmits,metadata:(f=l.metadata)!==null&&f!==void 0?f:""};await this._gateway.subscribeDataChannel(t.uid,v,!0)}catch(v){if((v==null?void 0:v.code)!==Z.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[l]),v;await this._p2pChannel.unsubscribeDataChannel(t,[l]),this._p2pChannel.setPendingRemoteDataChannel(t,l.id)}return await l._waitTillOpen(),x.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),l}finally{p()}}async _p2pSubscribe(t,i,a){if(vr(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(p=>p===t)){let p=new Ce(Z.INVALID_REMOTE_USER,"user is not in the channel");throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),p}if(!t.hasAudio&&!t.hasVideo){let p=new Ce(Z.INVALID_REMOTE_USER,"user is not published");throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),p}if(!a&&(i==="audio"&&!t.hasAudio||i==="video"&&!t.hasVideo)){let p=new Ce(Z.REMOTE_USER_IS_NOT_PUBLISHED);throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(i,", remote track is not published")),p}let l=await this._subscribeMutex.lock();x.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,i))await this._p2pChannel.unmuteRemote(t,i);else try{let f=i==="audio"?t._audioSSRC:t._videoSSRC,g=i==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,i,Date.now()),this._p2pChannel instanceof nr&&await this._p2pChannel.subscribe(t,i,f,g)}catch(f){throw f}x.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(f=>{x.warning("[".concat(this._clientId,"] auto set fallback failed"),f)});let p=i==="audio"?t._audioTrack:t._videoTrack;if(!p)throw new Ce(Z.UNEXPECTED_ERROR,"can not find remote track in user object");return p}catch(p){throw x.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),p),p}finally{l()}}async _subscribe(t,i,a){if(this._p2pChannel instanceof nr)return this._p2pSubscribe(t,i);if(vr(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(y=>y===t)){let y=new Ce(Z.INVALID_REMOTE_USER,"user is not in the channel");throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),y}if(!t.hasAudio&&!t.hasVideo){let y=new Ce(Z.INVALID_REMOTE_USER,"user is not published");throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),y}if(!(a||(i!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(i!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){let y=new Ce(Z.REMOTE_USER_IS_NOT_PUBLISHED);throw x.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(i,", remote track is not published")),y}let l=i==="audio"?t._audioSSRC:t._videoSSRC,p=i==="audio"?t._audioOrtc:t._videoOrtc,f=i==="video"?t._rtxSsrcId:void 0,g={stream_type:i==="audio"?We.AUDIO:We.VIDEO,ssrcId:l},v=await this._subscribeMutex.lock();x.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,i))await this._p2pChannel.unmuteRemote(t,i);else try{let I=i==="audio"?t._audioSSRC:t._videoSSRC;I!==void 0&&I!==l&&(l=I,p=i==="audio"?t._audioOrtc:t._videoOrtc,f=i==="video"?t._rtxSsrcId:void 0,g={stream_type:i==="audio"?We.AUDIO:We.VIDEO,ssrcId:l}),Is.markSubscribeStart(this.store.clientId,l),this.store.subscribe(t.uid,i,Date.now()),await this._p2pChannel.subscribe(t,i,l,f,p);try{await this._gateway.subscribe(t.uid,g,!0)}catch(b){if((b==null?void 0:b.code)!==Z.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,i),b;await this._p2pChannel.unsubscribe(t,i,!0),this._p2pChannel.setPendingRemoteMedia(t,i)}this.store.subscribe(t.uid,i,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,i)}catch(I){throw this._p2pChannel.reportSubscribeEvent(!1,I==null?void 0:I.code,t,i),I}x.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(I=>{x.warning("[".concat(this._clientId,"] auto set fallback failed"),I)});let y=i==="audio"?t._audioTrack:t._videoTrack;if(!y)throw new Ce(Z.UNEXPECTED_ERROR,"can not find remote track in user object");return y}catch(y){throw x.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),y),y}finally{v()}}async massSubscribe(t){if(Q(t,"subscribeList"),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let i=Date.now(),a=new Map,l=await this._subscribeMutex.lock();x.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(v=>{let{user:y,mediaType:I}=v;return"user: ".concat(y==null?void 0:y.uid,", mediaType: ").concat(I)}).join("; ")));let p=(t=[...t]).map(v=>{let{user:y,mediaType:I}=v;return{user:y,mediaType:I}}),f=await this._p2pChannel.globalLock();try{var g;for(let y=t.length-1;y>=0;y--){let I=t[y],{user:b,mediaType:k}=I;if(vr(k,"mediaType",["audio","video"]),!b){let K=new Ce(Z.INVALID_PARAMS,"user property does not exist in subscribeList item");throw x.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),K}if(!this._users.find(K=>K===b)){let K=new Ce(Z.INVALID_REMOTE_USER,"user is not in the channel");x.error("[".concat(this._clientId,"] can not massSubscribe ").concat(b.uid,", this user is not in the channel")),p[y].error=K,t.splice(y,1);continue}if(k==="audio"&&(!b.hasAudio||b._audioSSRC===void 0)||k==="video"&&(!b.hasVideo||b._videoSSRC===void 0)){let K=new Ce(Z.REMOTE_USER_IS_NOT_PUBLISHED);x.error("[".concat(this._clientId,"] can not subscribe ").concat(b.uid," with mediaType ").concat(k,", remote user is not published")),p[y].error=K,t.splice(y,1);continue}let U=On.Video|On.LwoVideo,J=a.get(b);if(J){if(k==="video"?J&U:J&On.Audio){t.splice(y,1),x.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(b.uid,", mediaType:").concat(k," twice"));continue}a.set(b,J|(k==="video"?U:On.Audio))}else a.set(b,k==="video"?U:On.Audio)}for(let y=t.length-1;y>=0;y--){let I=t[y],{user:b,mediaType:k}=I,U=On.Video|On.LwoVideo;if(this._p2pChannel.hasRemoteMedia(b,k)){await this._p2pChannel.unmuteRemoteNoLock(b,k);let J=a.get(b);a.set(b,k==="video"?J^U:J^On.Audio),t.splice(y,1)}}this.store.massSubscribe(t.map(y=>({userId:y.user.uid,type:y.mediaType})),i);let v=oh(g=Array.from(a.entries())).call(g,(y,I)=>{let[b,k]=I;if(k===0)return y;let U={stream_id:b.uid,stream_type:k};return k&On.Audio&&(U.audio_ssrc=b._audioSSRC),k&On.Video&&(U.video_ssrc=b._videoSSRC),y.push(U),y},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(I=>{let{user:b,mediaType:k}=I;return{user:b,mediaType:k,ssrcId:k===We.VIDEO?b._videoSSRC:b._audioSSRC,rtxSsrcId:k===We.VIDEO?b._rtxSsrcId:void 0}}));let y=new Map;if(v.length>0){let I=await this._gateway.subscribeAll(v,!0);((I==null?void 0:I.users)||[]).forEach(b=>{let{stream_id:k,video_error_code:U,audio_error_code:J,error_code:K}=b;(U||J||K)&&y.set(k,{video_error_code:U,audio_error_code:J,error_code:K})})}if(Array.from(y.entries()).length>0){let I=Array.from(y.entries()).map(b=>{let k,[U,J]=b;return J.error_code||J.video_error_code&&J.audio_error_code?k=void 0:J.video_error_code?k=We.VIDEO:J.audio_error_code&&(k=We.AUDIO),{user:this.remoteUsers.find(K=>K.uid===U),mediaType:k}});await this._p2pChannel.massUnsubscribeNoLock(I)}for(let I of p){let b=y.get(I.user.uid);if(b){let k=b.error_code||I.mediaType==="audio"&&b.audio_error_code||I.mediaType==="video"&&b.video_error_code;if(k){let U=Mp(k);x.error("user:".concat(I.user.uid," mediaType:").concat(I.mediaType," has massSubscribe error ").concat(U.desc)),I.error=new Ce(Z.SUBSCRIBE_FAILED,"code ".concat(k,": ").concat(U.desc))}}I.error||(I.mediaType==="video"?I.track=I.user.videoTrack:I.track=I.user.audioTrack)}return this.store.massSubscribe(p.filter(I=>!I.error).map(I=>({userId:I.user.uid,type:I.mediaType})),void 0,Date.now()),p.forEach(I=>{var b;Tt.subscribe(this.store.sessionId,{succ:!!I.error,ec:((b=I.error)===null||b===void 0?void 0:b.code)||null,video:I.mediaType===We.VIDEO,audio:I.mediaType===We.AUDIO,peerid:I.user.uid,subscribeRequestid:I.mediaType===We.VIDEO?I.user._videoSSRC:I.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-i)},!0)}),x.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(I=>{let{user:b,mediaType:k}=I;return"user: ".concat(b==null?void 0:b.uid,", mediaType: ").concat(k)}).join("; "))),p}catch(y){throw await this._p2pChannel.massUnsubscribeNoLock(t),y}}finally{f(),l()}}async unsubscribe(t,i,a){if(i||this.store.useP2P){if(i==="datachannel")return this._unsubscribeDataChannel(t,a)}else await this._unsubscribeDataChannel(t,a);if(i&&vr(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(p=>p===t)){let p=new Ce(Z.INVALID_REMOTE_USER,"user is not in the channel");throw x.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),p}x.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(i));let l=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof nr)await this._p2pChannel.unsubscribe(t,i);else{let p=await this._p2pChannel.unsubscribe(t,i);p&&await this._gateway.unsubscribe(p,t.uid),i&&i!=="audio"||(t._audio_pre_subscribed=!1),i&&i!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&Ji(this._users,t),x.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(i))}}catch(p){if(p.code===Z.DISCONNECT_P2P)return void x.warning("disconnecting p2p, abort unsubscribe request.");throw x.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),p.toString()),p}finally{l()}}async _unsubscribeDataChannel(t,i){if(i&&bn(i,"id",0,65535,!0),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(l=>l===t)){let l=new Ce(Z.INVALID_REMOTE_USER,"user is not in the channel");throw x.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),l}let a;if(typeof i=="number"){let l=t._dataChannels.find(p=>p.id===i);l&&(a=[l])}else a=t._dataChannels;if(a===void 0){let l=new Ce(Z.REMOTE_USER_IS_NOT_PUBLISHED);throw x.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(i,", remote datachannel is not published")),l}x.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(a.map(l=>l.id)));try{let l=await this._p2pChannel.unsubscribeDataChannel(t,a);l&&await this._gateway.unsubscribeDataChannel(l,t.uid),x.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(l))}catch(l){if(l.code===Z.DISCONNECT_P2P)return void x.warning("disconnecting p2p, abort unsubscribe request.");throw x.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),l.toString()),l}}async massUnsubscribe(t){if(Q(t,"unsubscribeList"),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");x.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(a=>{let{user:l,mediaType:p}=a;return"user: ".concat(l==null?void 0:l.uid,", mediaType: ").concat(p,";")}).join())),t=[...t];let i=new Map;for(let a=t.length-1;a>=0;a--){let{user:l,mediaType:p}=t[a];if(!l){let g=new Ce(Z.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw x.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),g}if(vr(p,"mediaType",["video","audio",void 0]),!this._users.find(g=>g===l)){x.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(l.uid,", user is not in the channel")),t.splice(a,1);continue}let f=On.Video|On.LwoVideo;if(i.has(l)){let g=i.get(l),v;switch(p){case"video":v=g&f;break;case"audio":v=g&On.Audio;break;default:v=g&(On.Audio|f)}if(v){x.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(l.uid,",mediaType:").concat(p," twice.")),t.splice(a,1);continue}p?p==="audio"?i.set(l,g|On.Audio):p==="video"&&i.set(l,g|f):i.set(l,g|On.Audio|f)}else p?p==="audio"?i.set(l,On.Audio):p==="video"&&i.set(l,f):i.set(l,On.Audio|f)}try{let a=await this._p2pChannel.massUnsubscribe(t);a&&await this._gateway.massUnsubscribe(a),x.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(l=>{let{user:p,mediaType:f}=l;return"user: ".concat(p==null?void 0:p.uid,", mediaType: ").concat(f,";")}).join()))}catch(a){if(a.code===Z.DISCONNECT_P2P)return void x.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw x.error("[".concat(this._clientId,"] massUnsubscribe error"),a.toString()),a}}async setLowStreamParameter(t){(function(a){if(!a)throw new Ve(Z.INVALID_PARAMS);ke(a.width)||Qm(a.width,"streamParameter.width"),ke(a.height)||Qm(a.height,"streamParameter.height"),ke(a.framerate)||Qm(a.framerate,"streamParameter.framerate"),ke(a.bitrate)||bn(a.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&x.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),x.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));let i=this._configDistribute.getLowStreamConfigDistribute();if(i&&i.bitrate&&t.bitrate&&i.bitrate<t.bitrate&&(t.bitrate=i.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,Ke.LocalVideoLowTrack)}async enableDualStream(){if(!zn().supportDualStream)throw Tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Ce(Z.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Ce(Z.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw Tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,Tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),x.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Ke.LocalVideoLowTrack))try{let t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw Tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,Tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),x.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,i){if(function(a){vr(a,"role",["audience","host"])}(t),i&&hn(i),this.mode==="rtc"||this.mode==="p2p")throw x.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new Ce(Z.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(i&&i.level&&t==="host")throw new Ce(Z.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new Ce(Z.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,i),this._config.role=t,x.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(i&&i.level))}getRemoteInboundOffset(){var t;let i=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!i||!i.timestamp)return 0;let a=i.timestamp-Date.now();return Math.abs(a)>1e3+i.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?a:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,i){if(jr(t,"proxyServer"),!i){if(this.connectionState!=="DISCONNECTED")throw new Ce(Z.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new Ce(Z.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,Tt.setProxyServer(this._proxyServer),x.setProxyServer(this._proxyServer),x.info("[".concat(this._clientId,"] Set proxy server ").concat(i?"by initialize call":""," success."))}setTurnServer(t,i){if(Array.isArray(t)||(t=[t]),!i){if(this.connectionState!=="DISCONNECTED")throw new Ce(Z.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new Ce(Z.INVALID_OPERATION,"You have already set the proxy")}if(nh(t))return this._turnServer={servers:t,mode:"original-manual"},void x.info("[".concat(this._clientId,"] Set original turnserver ").concat(i?"by initialize call":""," success: ").concat(t.map(a=>a.urls).join(","),"."));t.forEach(a=>un(a)),this._turnServer={servers:t,mode:"manual"},x.info("[".concat(this._clientId,"] Set turnserver ").concat(i?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new Ce(Z.INVALID_OPERATION,"you should set license before join channel");if(jr(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new Ce(Z.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,x.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new Ce(Z.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new Ce(Z.INVALID_OPERATION,"You have already set the proxy");let i=[3,4,5],a;switch(t===void 0&&(t=3),t){case 1:case 2:throw new Ce(Z.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:a="proxy3";break;case 4:a="proxy4";break;case 5:a="proxy5";break;default:throw new Ce(Z.INVALID_PARAMS,"proxy server mode must be ".concat(i.join("|")))}this._cloudProxyServerMode=a,this.store.cloudProxyServerMode=a,x.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new Ce(Z.INVALID_OPERATION,"Stop proxy server after leave channel");Tt.setProxyServer(),x.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",x.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new Ce(Z.INVALID_PARAMS,"accessPoints is required.");Q(t.accessPoints.serverList,"accessPoints.serverList"),jr(t.accessPoints.domain,"accessPoints.domain");let i=(U,J)=>{bn(U,J,0,65535,!0)},a=443;if(t.accessPoints.port&&(i(t.accessPoints.port,"accessPoints.port"),a=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new Ce(Z.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");ce("CLOSE_AFB_FOR_LOCAL_AP")&&(ei("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),ei("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let l=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,p=t.accessPoints.domain,f=t.accessPoints.serverList.map(U=>l.test(U)?"".concat(U.replace(/\./g,"-"),".").concat(p):U),g=f.map(U=>"".concat(U,":").concat(a));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,ei("WEBCS_DOMAIN",g),ei("WEBCS_DOMAIN_BACKUP_LIST",g),ei("GATEWAY_DOMAINS",[p]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(Q(t.report.hostname,"report.hostname"),ei("EVENT_REPORT_DOMAIN",t.report.hostname[0]),ei("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(ei("EVENT_REPORT_DOMAIN",f[0]),ei("EVENT_REPORT_BACKUP_DOMAIN",f[1]||f[0]));let v=6443;t.report&&t.report.port&&(i(t.report.port,"report.port"),v=t.report.port),ei("STATS_COLLECTOR_PORT",v),t.report?ei("ENABLE_EVENT_REPORT",!0):ei("ENABLE_EVENT_REPORT",!1);let y="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(Q(t.log.hostname,"log.hostname"),y=t.log.hostname[0]):y=f[0];let I=6444;t.log&&t.log.port&&(i(t.log.port,"log.port"),I=t.log.port),ei("LOG_UPLOAD_SERVER","".concat(y,":").concat(I));let b=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(Q(t.cds.hostname,"cds.hostname"),b=t.cds.hostname):b=f;let k=443;t.cds&&t.cds.port&&(i(t.cds.port,"cds.port"),k=t.cds.port),ei("CDS_AP",b.map(U=>"".concat(U,":").concat(k))),t.cds?ei("ENABLE_CONFIG_DISTRIBUTE",!0):ei("ENABLE_CONFIG_DISTRIBUTE",!1),x.info("set local access point v2 success")}setLocalAccessPoints(t,i){if(Q(t,"serverList"),jr(i,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new Ce(Z.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let a=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(l=>a.test(l)?"".concat(l.replace(/\./g,"-"),".").concat(i):l),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,ei("WEBCS_DOMAIN",t),ei("WEBCS_DOMAIN_BACKUP_LIST",t),ei("GATEWAY_DOMAINS",[i]),ei("EVENT_REPORT_DOMAIN",t[0]),ei("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),ei("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),x.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(vr(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(i){throw x.error("[".concat(this._clientId,"] set default remote video stream type error"),i.toString()),i}else x.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,i){vr(i,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,i),setTimeout(()=>{let a=this._users.find(l=>l.uid===t);a&&a.videoTrack&&a.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(a){throw x.error("[".concat(this._clientId,"] set remote video stream type error"),a.toString()),a}x.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(i)),this._remoteStreamTypeCacheMap.set(t,i)}async setStreamFallbackOption(t,i){vr(i,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,i)}catch(a){throw x.error("[".concat(this._clientId,"] set stream fallback option"),a.toString()),a}x.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(i)),this._streamFallbackTypeCacheMap.set(t,i)}setEncryptionConfig(t,i,a){(function(p){vr(p,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),jr(i,"secret");let l=["aes-128-gcm2","aes-256-gcm2"];if(xe(l).call(l,t)){if(!a||!(a instanceof Uint8Array&&a.length===32))throw new Ce(Z.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(a)throw new Ce(Z.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(i)||x.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=i,a&&(this._encryptionSalt=Zm(a))}async renewToken(t){if(jr(t,"token",1,2047),!this._key||!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"renewToken should not be called before user join");let i=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);let a=await this._renewTokenMutex.lock();try{if(ce("USE_NEW_TOKEN")){x.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let l=await Dn(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||dr);x.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:l})}else x.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});x.debug("[".concat(this._clientId,"] renewToken success"))}catch(l){throw this._key=i,this._joinInfo.token=i,x.error("[".concat(this._clientId,"] renewToken failed"),l.toString()),l}finally{a()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?x.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let t=this._p2pChannel.getAudioLevels();this.safeEmit(Dt.VOLUME_INDICATOR,t)},ce("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){let t=this._statsCollector.getRTCStats(),i=this._gateway.getInChannelInfo();return t.Duration=Math.round(i.duration/1e3),t}async startLiveStreaming(t,i){if(!i){if(this.codec!=="h264")throw new Ce(Z.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Ce(Z.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new Ce(Z.LIVE_STREAMING_TASK_CONFLICT);let a=i?br.TRANSCODE:br.RAW;return this._createLiveStreamingClient(a).startLiveStreamingTask(t,a)}setLiveTranscoding(t){return this._createLiveStreamingClient(br.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){let i=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(a=>a&&a.hasUrl(t));if(!i.length)throw new Ce(Z.INVALID_PARAMS,"can not find live streaming url to stop");await Pe.all(i.map(a=>a&&a.stopLiveStreamingTask(t)))}async addInjectStreamUrl(t,i){if(!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");let a=this._createLiveStreamingClient(br.INJECT);a.setInjectStreamConfig(i,0),await a.startLiveStreamingTask(t,br.INJECT)}async removeInjectStreamUrl(){var t;let i=this._createLiveStreamingClient(br.INJECT),a=Array.from(hc(t=i.streamingTasks).call(t)).find(l=>l.mode===br.INJECT);if(!this._joinInfo||!a)throw new Ce(Z.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await i.stopLiveStreamingTask(a.url)}async startChannelMediaRelay(t){ZC(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){ZC(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){let a=new TextEncoder;t.payload=a.encode(t.payload)}if(new Blob([t.payload]).size>1024)throw new Ce(Z.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(qe.DATA_STREAM,{payload:Zm(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-G3},!i)}sendMetadata(t){if(!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new Ce(Z.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(qe.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Zm(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach($D),!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"can not send custom report, not joined");await Tt.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,i){vr(i.spatialLayer,"spatialLayer",[0,1,2,3]),vr(i.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,i)}catch(a){throw x.error("[".concat(this._clientId,"] pick SVC layer failed"),a.toString()),a}}async setRTMConfig(t){let{apRTM:i=!1,rtmFlag:a}=t;if($l(i,"apRTM"),bn(a,"rtmFlag",0),this._rtmConfig.apRTM=i,this._rtmConfig.rtmFlag=a,x.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=i,this._joinInfo.rtmFlag=a,this._gateway.setRTM2Flag(a)}_reset(){if(x.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=mr.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(i=>i._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new sn("client-publish"),this._subscribeMutex=new sn("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,i){var a;let l=t||YA();t?x.debug("[".concat(this._clientId,"] new Session ").concat(l)):x.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(l));let p=t?"":this._sessionId||"";this._sessionId=l,this.store.sessionId=l;let f={lts:new Date().getTime(),mode:this.mode,stringUid:(i==null?void 0:i.stringUid)||((a=this._joinInfo)===null||a===void 0?void 0:a.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:p,clientRole:this.role==="audience"?2:1};i?Tt.sessionInit(this._sessionId,Mu({cname:i.channel,appid:i.appId},f)):this._joinInfo?Tt.sessionInit(this._sessionId,Mu({cname:this._joinInfo.cname,appid:this._joinInfo.appId},f)):this._gateway.joinInfo&&Tt.sessionInit(this._sessionId,Mu({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},f)),this._joinInfo&&(this._joinInfo.sid=l),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=l)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new Ce(Z.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&ce("FORCE_TURN")&&!ce("TURN_ENABLE_TCP")&&!ce("TURN_ENABLE_UDP"))throw new Ce(Z.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");x.debug("[".concat(this._clientId,"] publish high stream"));try{let a=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof nr){let l=(await a.next()).value;if(l){try{await this._gateway.sendExtensionMessage(Hi.PUBLISH,l,!0)}catch(p){throw a.throw(p),p}await a.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{let l=(await a.next()).value;if(l){var i;let p;try{p=await this._gateway.publish(this._uid,l,!0)}catch(f){if(f.code!==Z.DISCONNECT_P2P)throw a.throw(f),f}await a.next(((i=p)===null||i===void 0?void 0:i.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(let p of t)p instanceof jt&&p._encoderConfig&&this._gateway.setVideoProfile(p._encoderConfig),!p.muted&&p.enabled||await this._p2pChannel.muteLocalTrack(p)}}catch(a){if(this._p2pChannel.reportPublishEvent(!1,a==null?void 0:a.code,t),(a==null?void 0:a.code)===Z.WS_ABORT)return;throw a}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new Ce(Z.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Ce(Z.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));x.debug("[".concat(this._clientId,"] publish low stream"));let t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{let a=await this._p2pChannel.publishLowStream(this._lowStreamParameter),l=(await a.next()).value;if(l){var i;let p;try{p=await this._gateway.publish(this._uid,l,!0)}catch(f){if(f.code!==Z.DISCONNECT_P2P)throw a.throw(f),f}a.next(((i=p)===null||i===void 0?void 0:i.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(a){if(this._p2pChannel.reportPublishEvent(!1,a==null?void 0:a.code,void 0,!0),(a==null?void 0:a.code)===Z.WS_ABORT)return;throw a}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new Ce(Z.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let i=()=>new U3(this._joinInfo,this._config.websocketRetryConfig||dr,this._config.httpRetryConfig||dr),a=l=>{l.onLiveStreamError=(p,f)=>{Tt.reportApiInvoke(this._sessionId,{name:cr.ON_LIVE_STREAM_ERROR,options:[p,f],tag:Pi.TRACER}).onSuccess(),this.safeEmit(Dt.LIVE_STREAMING_ERROR,p,f)},l.onLiveStreamWarning=(p,f)=>{Tt.reportApiInvoke(this._sessionId,{name:cr.ON_LIVE_STREAM_WARNING,options:[p,f],tag:Pi.TRACER}).onSuccess(),this.safeEmit(Dt.LIVE_STREAMING_WARNING,p,f)},l.on(hs.REQUEST_WORKER_MANAGER_LIST,(p,f,g)=>{if(!this._joinInfo)return g(new Ce(Z.INVALID_OPERATION,"can not find join info to get worker manager"));NP(p,this._joinInfo,this._axiosCancelSource.token,dr).then(f).catch(g)})};switch(t){case br.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=i(),a(this._liveRawStreamingClient)),this._liveRawStreamingClient;case br.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=i(),a(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case br.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=i(),this._injectStreamingClient.on(hs.REQUEST_WORKER_MANAGER_LIST,(l,p,f)=>{if(!this._joinInfo)return f(new Ce(Z.INVALID_OPERATION,"can not find join info to get worker manager"));NP(l,this._joinInfo,this._axiosCancelSource.token,dr).then(p).catch(f)}),this._injectStreamingClient.onInjectStatusChange=(l,p,f)=>{this.safeEmit(Dt.INJECT_STREAM_STATUS,l,p,f)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new Ce(Z.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:t,sendResolutionHeight:i}=this.getLocalVideoStats(),a={width:t,height:i};this._channelMediaRelayClient=new t0(this._joinInfo,this._clientId,this._config.websocketRetryConfig||dr,this._config.httpRetryConfig||dr,a),this._channelMediaRelayClient.on("state",l=>{l===Yn.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(Dt.CHANNEL_MEDIA_RELAY_STATE,l)}),this._channelMediaRelayClient.on("event",l=>{this.safeEmit(Dt.CHANNEL_MEDIA_RELAY_EVENT,l)}),this._statsCollector.onStatsChanged=(l,p)=>{var f;l==="resolution"&&((f=this._channelMediaRelayClient)===null||f===void 0||f.setVideoProfile(p))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(t,i){let{added:a,deleted:l}=t,p=[];Array.isArray(a)&&a.length>0&&a.forEach(f=>{let{uid:g,stream_id:v,ordered:y,max_retrans_times:I,metadata:b}=f,k=this._users.find(U=>U._uintid===g);if(!k)return void x.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(x.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(g)),xe(p).call(p,k)||p.push(k),k._uintid||(k._uintid=g),k._dataChannels.findIndex(U=>U.id===f.stream_id)===-1){let U={id:v,ordered:!!y,maxRetransmits:I,metadata:b},J=new WC(U);k._dataChannels.push(J),x.info("[".concat(this._clientId,"] remote user ").concat(k.uid," published datachannel")),i||this.safeEmit(Dt.USER_PUBLISHED,k,"datachannel",U)}this._p2pChannel.hasPendingRemoteDataChannel(k,f.stream_id)&&(x.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(k.uid," after reconnect.")),this._subscribeDataChannel(k,f.stream_id).catch(U=>{x.error("[".concat(this._clientId,"] resubscribe datachannel error"),U.toString())}))}),i&&(this.safeEmit(Dt.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(l)&&l.length>0&&l.forEach(f=>{let{uid:g,stream_id:v}=f,y=this._users.find(b=>b._uintid===g);if(!y)return void x.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let I=y._dataChannels.find(b=>b.id===f.stream_id);I&&(x.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(g)),this._p2pChannel.unsubscribeDataChannel(y,[I]).then(b=>{if(y._dataChannels=y._dataChannels.filter(k=>k!==I),b)return this._gateway.unsubscribeDataChannel(b,y.uid)}),x.info("[".concat(this._clientId,"] remote user ").concat(g," unpublished datachannel ,id:").concat(I.id)),this.safeEmit(Dt.USER_UNPUBLISHED,y,"datachannel",I._config))})}_handleRemoveDataChannels(t){let i=this._users.find(a=>a.uid===t.uid);if(i){if(i._dataChannels!==void 0&&i._dataChannels.length>0){x.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));let a=()=>{x.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished datachannel")),i._dataChannels.forEach(l=>{this.safeEmit(Dt.USER_UNPUBLISHED,i,"datachannel",l._config)})};this._p2pChannel.unsubscribeDataChannel(i,i._dataChannels).then(l=>{if(l)return this._gateway.unsubscribeDataChannel(l,i.uid)}),a()}}else x.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Wi.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Wi.CONNECTION_STATE_CHANGE,(t,i,a)=>{var l;if(a===dn.FALLBACK)return;let p=()=>{this.safeEmit(Dt.CONNECTION_STATE_CHANGE,t,i,a)};if(Tt.reportApiInvoke(this._sessionId||((l=this._gateway.joinInfo)===null||l===void 0?void 0:l.sid)||null,{name:cr.CONNECTION_STATE_CHANGE,options:[t,i,a],tag:Pi.TRACER}).onSuccess(JSON.stringify({cur:t,prev:i,reason:a})),x.info("[".concat(this._clientId,"] connection state change: ").concat(i," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void p();if(t==="RECONNECTING")this._users.forEach(g=>{g._trust_in_room_=!1,g._trust_audio_enabled_state_=!1,g._trust_video_enabled_state_=!1,g._trust_audio_mute_state_=!1,g._trust_video_mute_state_=!1,g._trust_audio_stream_added_state_=!1,g._trust_video_stream_added_state_=!1,g._is_pre_created||(g._audio_pre_subscribed||(g._audioSSRC=void 0,g._audioOrtc=void 0),g._video_pre_subscribed||(g._videoSSRC=void 0,g._videoOrtc=void 0,g._rtxSsrcId=void 0),g._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var f;this._streamFallbackTypeCacheMap.forEach((g,v)=>{this._gateway.setStreamFallbackOption(v,g).catch(y=>{x.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),y)})}),this._remoteStreamTypeCacheMap.forEach((g,v)=>{this._gateway.setRemoteVideoStreamType(v,g).catch(y=>{x.warning("[".concat(this._clientId,"] auto set remote stream type failed"),y)})}),this._remoteDefaultVideoStreamType!==void 0&&((f=this._joinInfo)===null||f===void 0?void 0:f.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{x.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(g=>{x.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(g))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(g=>!g._trust_in_room_).forEach(g=>{x.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(g.uid)),this._handleUserOffline({uid:g.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(g=>{g._trust_audio_mute_state_||(x.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(g.uid)),this._handleMuteStream(g.uid,We.AUDIO,!1)),g._trust_video_mute_state_||(x.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(g.uid)),this._handleMuteStream(g.uid,We.VIDEO,!1)),g._trust_audio_enabled_state_||(x.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(g.uid)),this._handleSetStreamLocalEnable("audio",g.uid,!0)),g._trust_video_enabled_state_||(x.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(g.uid)),this._handleSetStreamLocalEnable("video",g.uid,!0)),g._trust_video_stream_added_state_||(x.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(g.uid)),this._handleResetAddStream(g,"video")),g._trust_audio_stream_added_state_||(x.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(g.uid)),this._handleResetAddStream(g,"audio")),g._video_added_||g._audio_added_||(x.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(g.uid)),this._handleRemoveStream({uid:g.uid,uint_id:g._uintid}))}))},1e3))}p()}),this._gateway.on(Wi.REQUEST_NEW_GATEWAY_LIST,(t,i)=>{if(!this._joinInfo)return i(new Ce(Z.UNEXPECTED_ERROR,"can not recover, no join info"));hC(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||dr,this.store).then(a=>{this._joinInfo&&(this._joinInfo.apResponse=a.gatewayInfo.res,this._joinInfo.gatewayAddrs=a.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=a.gatewayInfo.uni_lbs_ip);let l=[];a.gatewayInfo.gatewayAddrs.forEach(p=>{let{address:f}=p,[g,v]=f.split(":");this._joinInfo&&this._joinInfo.proxyServer?l.push({proxy:this._joinInfo.proxyServer,host:g,port:v}):l.push({host:g,port:v})}),t(l)}).catch(i)}),this._gateway.on(Wi.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(Dt.NETWORK_QUALITY,t)}),this._gateway.on(Wi.STREAM_TYPE_CHANGE,(t,i)=>{this.safeEmit(Dt.STREAM_TYPE_CHANGED,t,i),Tt.reportApiInvoke(this._sessionId,{name:cr.STREAM_TYPE_CHANGE,options:[t,i],tag:Pi.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:i}))}),this._gateway.on(Wi.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(Wi.NEED_RENEW_SESSION,()=>{this._startSession()}),this._gateway.on(Wi.REQUEST_P2P_CONNECTION_PARAMS,async(t,i,a)=>{try{i(await this._p2pChannel.startP2PConnection(t))}catch(l){a(l)}}),this._gateway.on(Wi.JOIN_RESPONSE,(t,i)=>{if(this.store.useP2P)return;let{dtlsParameters:a,iceParameters:l,candidates:p,rtpCapabilities:f,setup:g,cname:v}=zC(t.ortc,i);this._p2pChannel.connect(l,a,p,f,g,v)}),this._gateway.on(Wi.REQUEST_DC_CONNECTION_PARAMS,t=>{t(this._p2pChannel.getEstablishParams())}),this._gateway.on(Wi.RESET_SIGNAL,t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents()}),this._gateway.on(Wi.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(Wi.DATACHANNEL_PRECONNECT,async(t,i,a,l)=>{var p,f,g,v,y,I;await this._p2pChannel.startP2PConnection({turnServer:(p=this._joinInfo)===null||p===void 0?void 0:p.turnServer},!0);let b=function(k,U){let J;return U&&U.ip&&typeof U.port=="number"?(J=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:U.ip,port:U.port.toString(),type:"host",extension:{}}],x.debug("Using remote candidate from AP ".concat(U.ip,":").concat(U.port)),U.ip6&&(J.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:U.ip6,port:U.port.toString(),type:"host",extension:{}}),x.debug("Using IPV6 remote candidate from AP ".concat(U.ip6,":").concat(U.port)))):J=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:k.ip,port:k.port.toString(),type:"host",extension:{}}],J}(t,i);return this._p2pChannel.preConnect({iceUfrag:"".concat((f=this._joinInfo)===null||f===void 0?void 0:f.apResponse.cid,"_").concat((g=this._joinInfo)===null||g===void 0?void 0:g.apResponse.cert),icePwd:"".concat((v=this._joinInfo)===null||v===void 0?void 0:v.apResponse.cid,"_").concat((y=this._joinInfo)===null||y===void 0?void 0:y.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(I=ce("FINGERPRINT"))!==null&&I!==void 0?I:t.fingerprint}]},b,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(a).catch(l)})}_handleGatewaySignalEvents(){this._gateway.signal.on(Ut.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Ut.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Ut.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(Ut.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(Ut.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(Ut.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams,deleted:[]},!0)}),this._gateway.signal.on(Ut.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Ut.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Ut.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,We.AUDIO,!0)),this._gateway.signal.on(Ut.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,We.AUDIO,!1)),this._gateway.signal.on(Ut.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,We.VIDEO,!0)),this._gateway.signal.on(Ut.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,We.VIDEO,!1)),this._gateway.signal.on(Ut.RECEIVE_METADATA,t=>{let i=kT(t.metadata);this.safeEmit(Dt.RECEIVE_METADATA,t.uid,i)}),this._gateway.signal.on(Ut.ON_DATA_STREAM,async t=>{if(!t)return;let i=0;if(t.ordered||t.syncWithAudio){let a=this._p2pChannel.getStats(),l=this.remoteUsers.find(f=>f.uid===t.uid),p=a==null?void 0:a.audioRecv.find(f=>f.ssrc===(l==null?void 0:l._audioSSRC));i=p==null?void 0:p.jitterBufferMs}i==null&&(i=0),zk(t,i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Ut.ON_CRYPT_ERROR,()=>{eg(()=>{x.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Dt.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Ut.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{x.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,dn.TOKEN_EXPIRE),this.safeEmit(Dt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Ut.ON_STREAM_FALLBACK_UPDATE,t=>{x.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(Dt.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Ut.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),x.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(Ut.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(Ut.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(st.REQUEST_TIMEOUT,(t,i)=>{if(this._joinInfo)switch(t){case qe.PUBLISH:{if(!i)return;let p=i.ortc;if(p){var a,l;let f=p.some(y=>{let{stream_type:I}=y;return I===At.Audio}),g=p.some(y=>{let{stream_type:I}=y;return I!==At.Audio}),v=p.some(y=>{let{stream_type:I}=y;return I===At.Screen||I===At.ScreenLow});i.state==="offer"&&Tt.publish(this._joinInfo.sid,{eventElapse:Is.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:Z.TIMEOUT,audio:f,video:g,p2pid:i.p2p_id,publishRequestid:this.store.pubId,screenshare:v,audioName:f?(a=p.find(y=>{let{stream_type:I}=y;return I===At.Audio}))===null||a===void 0||(a=a.ssrcs[0])===null||a===void 0?void 0:a.ssrcId.toString():void 0,videoName:g?(l=p.find(y=>{let{stream_type:I}=y;return I!==At.Audio}))===null||l===void 0||(l=l.ssrcs[0])===null||l===void 0?void 0:l.ssrcId.toString():void 0})}break}case qe.SUBSCRIBE:i&&Tt.subscribe(this._joinInfo.sid,{succ:!1,ec:Z.TIMEOUT,audio:i.stream_type===We.AUDIO,video:i.stream_type===We.VIDEO,peerid:i.stream_id,subscribeRequestid:i.ssrcId,p2pid:this.store.p2pId,eventElapse:Is.measureFromSubscribeStart(this.store.clientId,i.ssrcId)})}}),this._gateway.signal.on(Ut.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(Ut.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;ce("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(l=>!Hs(l.string_id||l.stream_id,this.channelName)));let i=[],a=[];for(let l of t.users){let p=this._users.find(b=>b._uintid===l.stream_id);p?p._trust_in_room_=!0:(p=new ms(l.string_id||l.stream_id,l.stream_id),this._users.push(p),this.getListeners(Dt.PUBLISHED_USER_LIST).length===0&&(x.debug("[".concat(this._clientId,"] user online"),l.stream_id),this.safeEmit(Dt.USER_JOINED,p)));let f=On.Audio&l.stream_type,g=(On.Video|On.LwoVideo)&l.stream_type,v=(65280&l.stream_type)!=0,y=f&&p.hasAudio,I=g&&p.hasVideo;g&&(p._trust_video_stream_added_state_=!0,p._video_added_=!0,p._videoSSRC=l.video_ssrc,p._rtxSsrcId=l.video_rtx),f&&(p._trust_audio_stream_added_state_=!0,p._audio_added_=!0,p._audioSSRC=l.audio_ssrc),f&&!y&&this.getListeners(Dt.PUBLISHED_USER_LIST).length===0&&(x.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published audio")),this.safeEmit(Dt.USER_PUBLISHED,p,"audio")),g&&!I&&this.getListeners(Dt.PUBLISHED_USER_LIST).length===0&&(x.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published video")),this.safeEmit(Dt.USER_PUBLISHED,p,"video")),(f&&!y||g&&!I||v)&&i.push(p),g&&this._p2pChannel.hasPendingRemoteMedia(p,"video")&&a.push({user:p,mediaType:"video"}),f&&this._p2pChannel.hasPendingRemoteMedia(p,"audio")&&a.push({user:p,mediaType:"audio"})}a.length>0&&(x.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(a.map(l=>"user: ".concat(l.user.uid,", mediaType: ").concat(l.mediaType)).join("; ")," ")),this.massSubscribe(a).catch(l=>{x.error("[".concat(this._clientId,"] mass resubscribe error"),l.toString())})),this.getListeners(Dt.PUBLISHED_USER_LIST).length>0?ce("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=i:(x.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(i.map(l=>l.uid).join(", "))),this.safeEmit(Dt.PUBLISHED_USER_LIST,i)):x.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(i.map(l=>l.uid).join(", ")))}),this._gateway.signal.on(Ut.ON_RTP_CAPABILITY_CHANGE,t=>{let{video_codec:i}=t;this._p2pChannel instanceof Ir&&this._p2pChannel.updateRemoteRTPCapabilities(i.map(a=>a.toLowerCase()).filter(a=>{var l;return xe(l=Object.keys(au)).call(l,a)}))})}_handleP2PEvents(){this._gateway.signal.on(Ut.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Hi.PUBLISH,(t,i,a)=>{let{uid:l}=t;t.forEach(p=>{let{kind:f,ssrcs:g,mid:v,isMuted:y}=p;this._handleP2PAddAudioOrVideoStream(f,l,g[0].ssrcId,v);let I=this._users.find(b=>b.uid===l);return I&&this._p2pChannel instanceof nr?this._p2pChannel.mockSubscribe(I,f,g[0].ssrcId,v).then(()=>{i()}).catch(a):i(),this._handleMuteStream(l,f,!!y)})}),this._gateway.signal.on(Hi.CALL,async(t,i,a)=>{if(this._p2pChannel instanceof nr)try{var l;i(await this._p2pChannel.startP2P({turnServer:(l=this._joinInfo)===null||l===void 0?void 0:l.turnServer},t))}catch(p){a(p)}}),this._gateway.signal.on(st.P2P_CONNECTION,async t=>{this._p2pChannel instanceof nr&&await this._p2pChannel.p2pConnect(t)}),this._gateway.signal.on(Hi.UNPUBLISH,async(t,i,a)=>{if(this._p2pChannel instanceof nr){let{unpubMsg:l,uid:p}=t,f=this._users.find(g=>g.uid===p);if(!f)return x.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(p)),void i();try{l.forEach(async g=>{let{stream_type:v}=g,y=v===At.Audio?We.AUDIO:We.VIDEO;await this._p2pChannel.unsubscribe(f,y),this._handleMuteStream(p,y,!0)}),i()}catch(g){a(g)}}}),this._gateway.signal.on(Hi.CONTROL,async(t,i)=>{let{action:a}=t;switch(a){case ul.MUTE_LOCAL_VIDEO:this._handleMuteStream(i,We.VIDEO,!0);break;case ul.MUTE_LOCAL_AUDIO:this._handleMuteStream(i,We.AUDIO,!0);break;case ul.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",i),this._handleMuteStream(i,We.VIDEO,!1);break;case ul.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",i),this._handleMuteStream(i,We.AUDIO,!1)}}),this._gateway.signal.on(Hi.RESTART_ICE,async(t,i,a)=>{if(this._p2pChannel instanceof nr)try{let{direction:l,iceParameter:p}=t;l!==Ks.SEND_ONLY||p?i(await this._p2pChannel.restartICE(l,p)):(this._p2pChannel.handleDisconnect(l),i())}catch(l){a(l)}}),this._gateway.signal.on(Hi.CANDIDATE,t=>{if(this._p2pChannel instanceof nr){let{candidate:i,direction:a}=t;this._p2pChannel.addRemoteCandidate(i,a)}}),this._p2pChannel.on(wt.RequestP2PRestartICE,async(t,i,a)=>{try{let{direction:l}=t;i(await this._gateway.sendExtensionMessage(Hi.RESTART_ICE,t,l===Ks.SEND_ONLY))}catch(l){a(l)}}),this._p2pChannel.on(wt.LocalCandidate,t=>{this._gateway.sendExtensionMessage(Hi.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(wt.RequestP2PMuteLocal,async(t,i,a)=>{try{await this._gateway.sendExtensionMessage(Hi.CONTROL,t,!0),i()}catch(l){a(l)}}),this._p2pChannel.on(wt.RequestP2PUnmuteRemote,async(t,i,a)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(l){l.code===Z.DISCONNECT_P2P?i():a(l)}else i()}),this._p2pChannel.on(wt.RequestP2PMuteRemote,async(t,i,a)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(l){l.code===Z.DISCONNECT_P2P?i():a(l)}else i()}),this._p2pChannel.on(wt.StateChange,(t,i)=>{i===Yt.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(wt.RequestMuteLocal,async(t,i,a)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(l){l.code===Z.DISCONNECT_P2P?i():a(l)}else i()}),this._p2pChannel.on(wt.RequestUnmuteLocal,async(t,i,a)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),i()}catch(l){l.code===Z.DISCONNECT_P2P?i():a(l)}else i()}),this._p2pChannel.on(wt.RequestRePublish,(t,i,a)=>{this.publish(t,!1).then(i).catch(a)}),this._p2pChannel.on(wt.RequestRePublishDataChannel,(t,i,a)=>{Pe.all(t.map(async l=>{await this._p2pChannel.publishDataChannel([l]);let p={streamId:l.id,ordered:l.ordered,maxRetransmits:l.maxRetransmits,metadata:l.metadata,channelId:l._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,p,!0)}catch(f){if(f.code!==Z.DISCONNECT_P2P)throw f}})).then(i).catch(a)}),this._p2pChannel.on(wt.RequestReSubscribe,async(t,i,a)=>{try{for(let{user:l,kind:p}of t)p===We.VIDEO?await this.subscribe(l,"video"):await this.subscribe(l,"audio");i()}catch(l){a(l)}}),this._p2pChannel.on(wt.RequestUpload,(t,i)=>{this._gateway.upload(t,i)}),this._p2pChannel.on(wt.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(wt.MediaReconnectStart,t=>{this.safeEmit(Dt.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(wt.MediaReconnectEnd,t=>{this.safeEmit(Dt.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(wt.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(wt.RequestRestartICE,async t=>{if(this._p2pChannel instanceof nr)return;let i=await this._p2pChannel.restartICE(t),a=await i.next();if(a.done)return;let l=a.value,p;try{p=await this._gateway.restartICE({iceParameters:l})}catch(g){return void i.throw(g)}let{iceParameters:f}=function(g){let v=g.iceParameters;return{iceParameters:{iceUfrag:v.iceUfrag,icePwd:v.icePwd}}}(p);await i.next({remoteIceParameters:f})}),this._p2pChannel.on(wt.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(wt.RequestReconnectPC,async()=>{var t;let{iceParameters:i,dtlsParameters:a,rtpCapabilities:l}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:p,gatewayAddress:f}=await this._gateway.reconnectPC({iceParameters:i,dtlsParameters:a,rtpCapabilities:l}),{dtlsParameters:g,iceParameters:v,candidates:y,rtpCapabilities:I,setup:b,cname:k}=zC(p,f);await this._p2pChannel.connect(v,g,y,I,b,k),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(wt.RequestUnpublishForReconnectPC,async(t,i,a)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),i()):a()}),this._p2pChannel.on(wt.P2PLost,()=>{this.safeEmit(Dt.P2P_LOST,this.store.uid)}),this._p2pChannel.on(wt.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(wt.ConnectionTypeChange,t=>{this.safeEmit(Dt.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(wt.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(wt.QueryClientConnectionState,t=>{t(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new Ce(Z.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new Ce(Z.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{let i=[...new Set(t.inspectType)];i.forEach(a=>{var l;if(!xe(l=["supervise","moderation"]).call(l,a))throw new Ce(Z.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(a," is not a valid inspect type."))}),t.inspectType=i}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new Ce(Z.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{let i=new pS(t);this._inspect=i,this.handleVideoInspectEvents(this._inspect),await i.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},dr)}catch(i){throw Array.isArray(i)?i[0]:i}}async disableContentInspect(){if(!this._inspect)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,i){if($l(t,"enabled"),t){if(!i)throw new Ce(Z.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(bn(i.interval,"interval",1e3,1/0),i&&i.extraInfo&&i.extraInfo.length>1024)throw new Ce(Z.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(i&&i.vendor&&i.vendor.length>1024)throw new Ce(Z.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(i);let a=new Hf(i);this._moderation=a,this.handleImageModerationEvents(this._moderation),await a.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},dr)}catch(a){throw Array.isArray(a)?a[0]:a}}else{if(!this._moderation)throw new Ce(Z.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(a){throw Array.isArray(a)?a[0]:a}}}setP2PTransport(t){if(function(i){vr(i,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new Ce(Z.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,x.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}handleImageModerationEvents(t){t.on(xa.CONNECTION_STATE_CHANGE,(i,a)=>{if(this.safeEmit(Dt.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,i,a),i===es.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new Ce(Z.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(xa.CLIENT_LOCAL_VIDEO_TRACK,i=>{i(this.localTracks.filter(a=>a.trackMediaType==="video")[0])})}handleVideoInspectEvents(t){t.on(ci.CONNECTION_STATE_CHANGE,(i,a)=>{if(this.safeEmit(Dt.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,i,a),a===Gr.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(Dt.CONTENT_INSPECT_ERROR,new Ce(Z.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(ci.INSPECT_RESULT,(i,a)=>{var l;if((a==null?void 0:a.code)===Z.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return x.debug("Stop inspect content because that has left channel"),this==null||(l=this._inspect)===null||l===void 0||l.close(),void(this._inspect=void 0);this.safeEmit(Dt.CONTENT_INSPECT_RESULT,i,a)}),t.on(ci.CLIENT_LOCAL_VIDEO_TRACK,i=>{i(this.localTracks.filter(a=>a.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return x.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){$l(t,"enabled"),ei("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,i){switch(i){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}}Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Zn.prototype,"leave",null),Be([bt({argsMap:(s,t)=>{if(!Array.isArray(t)){if(!(t instanceof tn))return[t];t=[t]}return t.map(i=>i?Object(i).toString():"null")}}),Y("design:type",Function),Y("design:paramtypes",[Object,Boolean]),Y("design:returntype",Pe)],Zn.prototype,"publish",null),Be([bt({argsMap:(s,t)=>(t||(t=[]),t instanceof Ld?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map(i=>i.getTrackId())))}),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Zn.prototype,"unpublish",null),Be([bt({argsMap:(s,t,i,a)=>[t.uid,i,a]}),Y("design:type",Function),Y("design:paramtypes",[ms,String,Number]),Y("design:returntype",Pe)],Zn.prototype,"subscribe",null),Be([bt({argsMap:(s,t,i)=>[t,i]}),Y("design:type",Function),Y("design:paramtypes",[Object,String]),Y("design:returntype",Pe)],Zn.prototype,"presubscribe",null),Be([bt({argsMap:(s,t)=>t.map(i=>{let{user:a,mediaType:l}=i;return[a==null?void 0:a.uid,l]})}),Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Zn.prototype,"massSubscribe",null),Be([bt({argsMap:(s,t,i,a)=>[t.uid,i,a]}),Y("design:type",Function),Y("design:paramtypes",[ms,String,Number]),Y("design:returntype",Pe)],Zn.prototype,"unsubscribe",null),Be([bt({argsMap:(s,t)=>t.map(i=>{let{user:a,mediaType:l}=i;return{uid:a==null?void 0:a.uid,mediaType:l}})}),Y("design:type",Function),Y("design:paramtypes",[Array]),Y("design:returntype",Pe)],Zn.prototype,"massUnsubscribe",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Zn.prototype,"setLowStreamParameter",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Zn.prototype,"enableDualStream",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Zn.prototype,"disableDualStream",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String,Object]),Y("design:returntype",Pe)],Zn.prototype,"setClientRole",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String,Boolean]),Y("design:returntype",void 0)],Zn.prototype,"setProxyServer",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object,Boolean]),Y("design:returntype",void 0)],Zn.prototype,"setTurnServer",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",void 0)],Zn.prototype,"setLicense",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Number]),Y("design:returntype",void 0)],Zn.prototype,"startProxyServer",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Zn.prototype,"stopProxyServer",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",void 0)],Zn.prototype,"setLocalAccessPointsV2",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Array,String]),Y("design:returntype",void 0)],Zn.prototype,"setLocalAccessPoints",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Number]),Y("design:returntype",Pe)],Zn.prototype,"setRemoteDefaultVideoStreamType",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object,Number]),Y("design:returntype",Pe)],Zn.prototype,"setRemoteVideoStreamType",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object,Number]),Y("design:returntype",Pe)],Zn.prototype,"setStreamFallbackOption",null),Be([bt({argsMap:(s,t)=>[t]}),Y("design:type",Function),Y("design:paramtypes",[String,String,Uint8Array]),Y("design:returntype",void 0)],Zn.prototype,"setEncryptionConfig",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Zn.prototype,"renewToken",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",void 0)],Zn.prototype,"enableAudioVolumeIndicator",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String,Boolean]),Y("design:returntype",Pe)],Zn.prototype,"startLiveStreaming",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Zn.prototype,"setLiveTranscoding",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",Pe)],Zn.prototype,"stopLiveStreaming",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String,Object]),Y("design:returntype",Pe)],Zn.prototype,"addInjectStreamUrl",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Zn.prototype,"removeInjectStreamUrl",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[QC]),Y("design:returntype",Pe)],Zn.prototype,"startChannelMediaRelay",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[QC]),Y("design:returntype",Pe)],Zn.prototype,"updateChannelMediaRelay",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Zn.prototype,"stopChannelMediaRelay",null),Be([bt({argsMap:(s,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Zn.prototype,"sendCustomReportMessage",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object,Object]),Y("design:returntype",Pe)],Zn.prototype,"pickSVCLayer",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Zn.prototype,"setRTMConfig",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Object]),Y("design:returntype",Pe)],Zn.prototype,"enableContentInspect",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Pe)],Zn.prototype,"disableContentInspect",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Boolean,Object]),Y("design:returntype",Pe)],Zn.prototype,"setImageModeration",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[String]),Y("design:returntype",void 0)],Zn.prototype,"setP2PTransport",null),Be([bt({reportResult:!0}),Y("design:type",Function),Y("design:paramtypes",[]),Y("design:returntype",Array)],Zn.prototype,"getJoinChannelServiceRecords",null),Be([bt(),Y("design:type",Function),Y("design:paramtypes",[Boolean]),Y("design:returntype",Pe)],Zn.prototype,"setPublishAudioFilterEnabled",null);class gS{constructor(t,i){P(this,"id",0),P(this,"element",void 0),P(this,"peerPair",void 0),P(this,"context",void 0),P(this,"audioPlayerElement",void 0),P(this,"audioTrack",void 0),gS.count+=1,this.id=gS.count,this.element=t,this.context=i}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{let i=document.createElement("audio");i.srcObject=new MediaStream([t.track]),i.play(),this.audioPlayerElement=i}}async switchSdp(){if(!this.peerPair)return;let t=async(a,l)=>{let p=l==="offer"?await a.createOffer():await a.createAnswer();return await a.setLocalDescription(p),a.iceGatheringState==="complete"?a.localDescription:new Pe(f=>{a.onicegatheringstatechange=()=>{a.iceGatheringState==="complete"&&f(a.localDescription)}})},i=async(a,l)=>await a.setRemoteDescription(l);try{let a=await t(this.peerPair[0],"offer");await i(this.peerPair[1],a);let l=await t(this.peerPair[1],"answer");await i(this.peerPair[0],l)}catch(a){throw new Ce(Z.LOCAL_AEC_ERROR,a.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let i;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),i=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(i)}catch(l){throw new Ce(Z.LOCAL_AEC_ERROR,l.toString()).print()}if(!i)throw new Ce(Z.LOCAL_AEC_ERROR,"no dest node when local aec").print();let a=i.stream.getAudioTracks()[0];return this.audioTrack=a,a}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let t=this.element,i=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(i),await this.switchSdp()}close(){x.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}P(gS,"count",0);let H3=window.AudioContext||window.webkitAudioContext;class lv{constructor(){P(this,"units",[]),P(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return x.debug("the system does not need to process local aec"),-1;this.context||(this.context=new H3);let i=this.units.find(a=>a&&a.getElement()===t);return i||(i=new gS(t,this.context),this.units.push(i)),i.startEchoCancellation(),x.debug("start processing local audio echo cancellation, id is",i.id),i.id}_doesEnvironmentNeedAEC(){return En().name!==Ee.SAFARI}}Be([bt({report:Tt}),Y("design:type",Function),Y("design:paramtypes",[HTMLAudioElement]),Y("design:returntype",Number)],lv.prototype,"processExternalMediaAEC",null);let qk=new lv;function Jk(s,t){var i=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(s,l).enumerable})),i.push.apply(i,a)}return i}function Yf(s){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Jk(Object(i),!0).forEach(function(a){P(s,a,i[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):Jk(Object(i)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(i,a))})}return s}let Fo=window||document;function p0(s){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Fo)return;let i=_r._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);let a=l=>{if(!(l&&l.blockedURI&&(_r.onSecurityPolicyViolation||_r.getListeners(Qn.SECURITY_POLICY_VIOLATION).length>0)))return;let p=l.blockedURI;ce("CSP_DETECTED_HOSTNAME_LIST").some(f=>xe(p).call(p,f))&&(_r.onSecurityPolicyViolation&&typeof _r.onSecurityPolicyViolation=="function"&&_r.onSecurityPolicyViolation(l),_r.getListeners(Qn.SECURITY_POLICY_VIOLATION).length>0&&_r.safeEmit(Qn.SECURITY_POLICY_VIOLATION,l))};i&&Fo.removeEventListener("securitypolicyviolation",i),(t||s&&typeof s=="function"||_r.getListeners(Qn.SECURITY_POLICY_VIOLATION).length>0)&&Fo.addEventListener("securitypolicyviolation",a),_r._cspEventHandlerPointer=a}ei("PROCESS_ID","process-".concat(si(8,""),"-").concat(si(4,""),"-").concat(si(4,""),"-").concat(si(4,""),"-").concat(si(12,""))),function(){let s;try{s=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void x.error("Error loading sdk config",t.message)}if(s)try{let t=JSON.parse(window.atob(s)),i=Date.now();x.debug("Loading global parameters from cache",t),Object.keys(t).forEach(a=>{if(Object.prototype.hasOwnProperty.call(io,a)){let{value:l,expires:p}=t[a];if(p&&p<=i)return;uc[a]=l,io[a]=l}})}catch(t){x.error("Error loading mutableParamsCache: ".concat(s),t.message)}}(),Array.isArray(uc.AREAS)&&uc.AREAS.length>0&&vg(uc.AREAS,!0);let Xk=(s,t,i)=>{x.debug("setParameter key:".concat(s,", value:").concat(JSON.stringify(t))),ei(s,t,i)},_r=function(s){let t=new ri,i=s,a={getListeners:t.getListeners.bind(t),on:(l,p)=>(function(f,g){f===Qn.SECURITY_POLICY_VIOLATION&&p0(g,!0)}(l,p),t.on.bind(t)(l,p)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return Yf(Yf({},i),a)}({__TRACK_LIST__:gh,VERSION:Gt,BUILD:nC,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:Xk,getParameter:ce,getSupportedCodec:async function(){let s={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});let i=(await t.createOffer()).sdp;if(!i)return s;t.close(),t=null,s=function(a){let l={video:[],audio:[]};return a.match(/ VP8/i)&&l.video.push("VP8"),a.match(/ VP9/i)&&l.video.push("VP9"),a.match(/ AV1/i)&&l.video.push("AV1"),a.match(/ H264/i)&&l.video.push("H264"),a.match(/ H265/i)&&l.video.push("H265"),a.match(/ opus/i)&&l.audio.push("OPUS"),a.match(/ PCMU/i)&&l.audio.push("PCMU"),a.match(/ PCMA/i)&&l.audio.push("PCMA"),a.match(/ G722/i)&&l.audio.push("G722"),l}(i)}catch(t){throw new Ce(Z.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return s},checkSystemRequirements:function(){let s=Tt.reportApiInvoke(null,{name:cr.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Pi.TRACER}),t=!1;try{let p=window.RTCPeerConnection,f=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,g=window.WebSocket;t=!!(p&&f&&g)}catch(p){return x.error("check system requirement failed: ",p),!1}let i=!1,a=En();a.name===Ee.CHROME&&Number(a.version)>=58&&(!Xl()||TD())&&(i=!0),a.name===Ee.FIREFOX&&Number(a.version)>=56&&(i=!0),a.name===Ee.OPERA&&Number(a.version)>=45&&(i=!0),a.name===Ee.SAFARI&&Number(a.version)>=11&&(i=!0),(FA()||En().name===Ee.QQ)&&(i=!0),x.debug("checkSystemRequirements, api:",t,"browser",i);let l=t&&i;return s.onSuccess(l),l},getDevices:function(s){return Ea.enumerateDevices(!0,!0,s)},getMicrophones:function(s){return Ea.getRecordingDevices(s)},getCameras:function(s){return Ea.getCamerasDevices(s)},getElectronScreenSources:fa,getPlaybackDevices:function(s){return Ea.getSpeakers(s)},createClient:function(){var s;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},i=Tt.reportApiInvoke(null,{name:cr.CREATE_CLIENT,options:[t],tag:Pi.TRACER});try{(function(a){vr(a.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),vr(a.mode,"config.mode",["rtc","live","p2p"]),a.audioCodec!==void 0&&vr(a.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),a.proxyServer!==void 0&&jr(a.proxyServer,"config.proxyServer",1,1e4),a.turnServer!==void 0&&un(a.turnServer),a.httpRetryConfig!==void 0&&wi(a.httpRetryConfig),a.websocketRetryConfig!==void 0&&wi(a.websocketRetryConfig)})(t)}catch(a){throw i.onError(a),a}return h0()||(t.codec==="vp9"&&(t.codec="vp8",x.debug("browser not support vp9, force use vp8")),ei("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),i.onSuccess(),new Zn(Mu(Mu({forceWaitGatewayResponse:!0},t),{},{role:xe(s=["rtc","p2p"]).call(s,t.mode)?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CREATE_CAM_VIDEO_TRACK,options:[Sf({},s)]}),i=bg(s),a=si(8,"track-cam-"),l=null,p=s.encoderConfig==="720p_auto";x.info("start create camera video track with config",JSON.stringify(s),"trackId",a);try{l=(await Xo({video:i},a)).getVideoTracks()[0]||null}catch(g){throw t.onError(g),g}if(!l){let g=new Ve(Z.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(g),g.throw(x)}s.optimizationMode&&IC(a,l,s,ha(s.encoderConfig));let f=new Qo(l,s,i,s.scalabiltyMode?ht(s.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},s.optimizationMode,a);return p&&f.startMonitorStats(),t.onSuccess(f.getTrackId()),x.info("create camera video success, trackId:",a),f},createCustomVideoTrack:function(s){let t=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CREATE_CUSTOM_VIDEO_TRACK,options:[s]}),i=new jt(s.mediaStreamTrack,{width:s.width,height:s.height,frameRate:s.frameRate,bitrateMax:s.bitrateMax,bitrateMin:s.bitrateMin},s.scalabiltyMode?ht(s.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},s.optimizationMode,si(8,"track-cus-"),[Un.CUSTOM_TRACK]);return t.onSuccess(i.getTrackId()),x.info("create custom video track success with config",s,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable",i=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CREATE_SCREEN_VIDEO_TRACK,options:[Sf({},s),t]}),a=s.encoderConfig==="720p_auto";s.encoderConfig?typeof s.encoderConfig=="string"||s.encoderConfig.width&&s.encoderConfig.height||(s.encoderConfig.width={max:1920},s.encoderConfig.height={max:1080}):s.encoderConfig="1080p_2";let l=function(b){let k={};b.screenSourceType&&(k.mediaSource=b.screenSourceType),b.extensionId&&bp()&&(k.extensionId=b.extensionId);let{displaySurface:U,selfBrowserSurface:J,surfaceSwitching:K,systemAudio:q}=b;(Xm(107)||CD(107)||vD(93))&&(U&&(vr(U,"displaySurface",["browser","window","monitor"]),k.displaySurface=U),J?(vr(J,"selfBrowserSurface",["exclude","include"]),k.selfBrowserSurface=J):k.selfBrowserSurface="include",K&&(vr(K,"surfaceSwitching",["exclude","include"]),k.surfaceSwitching=K)),(Xm(105)||CD(105)||vD(91))&&q&&(vr(q,"systemAudio",["exclude","include"]),k.systemAudio=q),b.electronScreenSourceId&&(k.sourceId=b.electronScreenSourceId);let te=b.encoderConfig?mC(b.encoderConfig):null;return k.mandatory={chromeMediaSource:"desktop",maxWidth:te?te.width:void 0,maxHeight:te?te.height:void 0},te&&(te.frameRate&&(typeof te.frameRate=="number"?(k.mandatory.maxFrameRate=te.frameRate,k.mandatory.minFrameRate=te.frameRate):(k.mandatory.maxFrameRate=te.frameRate.max||te.frameRate.ideal||te.frameRate.exact||void 0,k.mandatory.minFrameRate=te.frameRate.min||te.frameRate.ideal||te.frameRate.exact||void 0),k.frameRate=te.frameRate),te.width&&(k.width=te.width),te.height&&(k.height=te.height)),k}(s),p=si(8,"track-scr-v-"),f=null,g=null,v=zn();if(!v.supportShareAudio&&t==="enable"){let b=new Ve(Z.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(b),b.throw(x)}x.info("start create screen video track with config",s,"withAudio",t,"trackId",p);try{let b=await Xo({screen:l,screenAudio:t==="auto"?v.supportShareAudio:t==="enable"},p);f=b.getVideoTracks()[0]||null,g=b.getAudioTracks()[0]||null}catch(b){throw i.onError(b),b}if(!f){let b=new Ve(Z.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(b),b.throw(x)}if(!g&&t==="enable"){f&&f.stop();let b=new Ve(Z.SHARE_AUDIO_NOT_ALLOWED);return i.onError(b),b.throw(x)}s.optimizationMode||(s.optimizationMode="detail"),s.optimizationMode&&(IC(p,f,s,s.encoderConfig&&mC(s.encoderConfig)||void 0),s.encoderConfig&&typeof s.encoderConfig!="string"&&(s.encoderConfig.bitrateMin=s.encoderConfig.bitrateMax));let y=new jt(f,s.encoderConfig?mC(s.encoderConfig):{},s.scalabiltyMode?ht(s.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},s.optimizationMode,p,[Un.SCREEN_TRACK]);if(a&&y.startMonitorStats(),!g)return i.onSuccess(y.getTrackId()),x.info("create screen video track success","video:",y.getTrackId()),y;let I=new Vn(g,void 0,si(8,"track-scr-a-"),!1,!0);return i.onSuccess([y.getTrackId(),I.getTrackId()]),x.info("create screen video track success","video:",y.getTrackId(),"audio:",I.getTrackId()),[y,I]},createMicrophoneAndCameraTracks:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CREATE_MIC_AND_CAM_TRACKS,options:[s,t]}),a=t.encoderConfig==="720p_auto",l=bg(t),p=RC(s),f=si(8,"track-mic-"),g=si(8,"track-cam-"),v=null,y=null;x.info("start create camera video track(".concat(g,") and microphone audio track(").concat(f,") with config, audio: ").concat(JSON.stringify(s),", video: ").concat(JSON.stringify(t)));try{let k=await Xo({audio:p,video:l},"".concat(f,"-").concat(g));v=k.getAudioTracks()[0],y=k.getVideoTracks()[0]}catch(k){throw i.onError(k),k}if(!v||!y){let k=new Ve(Z.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(k),k.throw(x)}t.optimizationMode&&IC(g,y,t,ha(t.encoderConfig));let I=new pu(v,s,p,f),b=new Qo(y,t,l,t.scalabiltyMode?ht(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,g);return a&&b.startMonitorStats(),i.onSuccess([I.getTrackId(),b.getTrackId()]),x.info("create camera video track(".concat(g,") and microphone audio track(").concat(f,") success")),[I,b]},createMicrophoneAudioTrack:async function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CREATE_MIC_AUDIO_TRACK,options:[s]}),i=RC(s),a=si(8,"track-mic-"),l=null;x.info("start create microphone audio track with config",JSON.stringify(s),"trackId",a);try{l=(await Xo({audio:i},a)).getAudioTracks()[0]||null}catch(f){throw t.onError(f),f}if(!l){let f=new Ve(Z.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(f),f.throw(x)}let p=new pu(l,s,i,a);return t.onSuccess(p.getTrackId()),x.info("create microphone audio track success, trackId:",a),p},createCustomAudioTrack:function(s){let t=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CREATE_CUSTOM_AUDIO_TRACK,options:[s]}),i=new Vn(s.mediaStreamTrack,s.encoderConfig?Dd(s.encoderConfig):{},si(8,"track-cus-"),!1,!0);return x.info("create custom audio track success with config",s,"trackId",i.getTrackId()),t.onSuccess(i.getTrackId()),i},createBufferSourceAudioTrack:async function(s){var t;let{cacheOnlineFile:i,encoderConfig:a}=s,{source:l}=s,p={source:l instanceof AudioBuffer?"AudioBuffer":l instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":l,cacheOnlineFile:i,encoderConfig:a},f=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CREATE_BUFFER_AUDIO_TRACK,options:[p]});if(ce("DISABLE_WEBAUDIO"))throw new Ve(Z.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");let g=si(8,"track-buf-");x.info("start create buffer source audio track with config",JSON.stringify(p),"trackId",g);let v=l;if(!(l instanceof AudioBuffer))try{l=await VP(l,i)}catch(b){return f.onError(b),b.throw(x)}let y=new xP(l),I=new mu(v,y,a?Dd(a):{},g);return x.info("create buffer source audio track success, trackId:",g),f.onSuccess(I.getTrackId()),I},setAppType:function(s){if(x.debug("setAppType: ".concat(s)),!(Number.isInteger(s)&&s>=0))throw x.debug("Invalid appType"),new Ce(Z.INVALID_PARAMS,"invalid app type",s);ei("APP_TYPE",Math.floor(s))},setLogLevel:function(s){x.setLogLevel(s)},enableLogUpload:function(){ce("USE_NEW_LOG")?ei("UPLOAD_LOG",!0):x.enableLogUpload()},disableLogUpload:function(){ce("USE_NEW_LOG")?ei("UPLOAD_LOG",!1):x.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new QC},checkAudioTrackIsActive:async function(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,i=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(s instanceof Vn||s instanceof Jc)){let v=new Ce(Z.INVALID_TRACK,"the parameter is not a audio track");return i.onError(v),v.throw()}t&&t<1e3&&(t=1e3);let a=s instanceof Vn?s.getTrackLabel():"remote_track",l=s.getVolumeLevel(),p=l,f=l,g=Date.now();return new Pe(v=>{let y=setInterval(()=>{let I=s.getVolumeLevel();p=I>p?I:p,f=I<f?I:f;let b=p-f>1e-4,k=Date.now()-g;if(b||k>t){clearInterval(y);let U=b,J={duration:k,deviceLabel:a,maxVolumeLevel:p,result:U};x.info("[track-".concat(s.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(J))),i.onSuccess(J),v(U)}},200)})},checkVideoTrackIsActive:async function(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,i=Tt.reportApiInvoke(null,{tag:Pi.TRACER,name:cr.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(s instanceof jt||s instanceof fc)){let b=new Ce(Z.INVALID_TRACK,"the parameter is not a video track");return i.onError(b),b.throw()}t&&t<1e3&&(t=1e3);let a=s instanceof jt?s.getTrackLabel():"remote_track",l=s.getMediaStreamTrack(!0),p=document.createElement("video");p.style.width="1px",p.style.height="1px",p.setAttribute("muted",""),p.muted=!0,p.setAttribute("playsinline",""),p.controls=!1,(qt()||Jm())&&(p.style.opacity="0.01",p.style.position="fixed",p.style.left="0",p.style.top="0",document.body.appendChild(p)),p.srcObject=new MediaStream([l]),p.play();let f=document.createElement("canvas");f.width=160,f.height=120;let g=0,v=0;try{let b=Date.now();g=await function(k,U,J,K){let q,te=0,de=null;return new Pe((he,Ue)=>{function Re(){te>K&&q&&(q(),he(te));let Ie=J.getContext("2d");if(!Ie){let Xe=new Ce(Z.UNEXPECTED_ERROR,"can not get canvas 2d context.");return x.error(Xe.toString()),void Ue(Xe)}Ie.drawImage(k,0,0,160,120);let De=Ie.getImageData(0,0,J.width,J.height),Ne=Math.floor(De.data.length/3);if(de){for(let Xe=0;Xe<Ne;Xe+=3)if(De.data[Xe]!==de[Xe])return te+=1,void(de=De.data);de=De.data}else de=De.data}setTimeout(()=>{q&&(q(),he(te))},U),q=Zw(()=>{Re()},30)})}(p,t,f,4),v=Date.now()-b}catch(b){throw i.onError(b),b}Us===Ee.SAFARI&&(p.pause(),p.remove()),p.srcObject=null;let y=g>4,I={duration:v,changedPicNum:g,deviceLabel:a,result:y};return x.info("[track-".concat(s.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(I))),i.onSuccess(I),y},setArea:vg,audioElementPlayCenter:Po,resumeAudioContext:function(){Po.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(s){qk.processExternalMediaAEC(s)},registerExtensions:function(s){let t=ce("PLUGIN_INFO")||[];s.forEach(i=>{"name"in i&&!xe(t).call(t,i.name)&&t.push(i.name);let a=i;a.__registered__=!0,a.logger.hookLog=x.extLog,a.reporter.hookApiInvoke=Tt.extApiInvoke,a.parameters&&Object.keys(a.parameters).forEach(l=>{a.parameters[l]=ce(l)})}),Xk("PLUGIN_INFO",t)},ChannelMediaRelayError:bd,ChannelMediaRelayEvent:Do,ChannelMediaRelayState:Yn,RemoteStreamFallbackType:_C,RemoteStreamType:_o,ConnectionDisconnectedReason:dn,AudienceLatencyLevelType:WA,AREAS:Cn});return Object.defineProperties(_r,{onAudioAutoplayFailed:{get:()=>Fa.onAudioAutoplayFailed,set:s=>{Fa.onAudioAutoplayFailed=s}},onAutoplayFailed:{get:()=>Fa.onAutoplayFailed,set:s=>{Fa.onAutoplayFailed=s}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>_r._onSecurityPolicyViolation,set(s){_r._onSecurityPolicyViolation=s,p0(s)}},__CLIENT_LIST__:{get:()=>ce("SHOW_GLOBAL_CLIENT_LIST")?Wc:[]}}),Ea.on(ml.CAMERA_DEVICE_CHANGED,s=>{x.info("camera device changed",JSON.stringify(s)),_r.onCameraChanged&&_r.onCameraChanged(s),_r.safeEmit(Qn.CAMERA_CHANGED,s)}),Ea.on(ml.RECORDING_DEVICE_CHANGED,s=>{x.info("microphone device changed",JSON.stringify(s)),_r.onMicrophoneChanged&&_r.onMicrophoneChanged(s),_r.safeEmit(Qn.MICROPHONE_CHANGED,s)}),Ea.on(ml.PLAYOUT_DEVICE_CHANGED,s=>{x.debug("playout device changed",JSON.stringify(s)),_r.onPlaybackDeviceChanged&&_r.onPlaybackDeviceChanged(s),_r.safeEmit(Qn.PLAYBACK_DEVICE_CHANGED,s)}),Po.onAutoplayFailed=()=>{x.info("detect audio element autoplay failed"),Fa.onAudioAutoplayFailed&&Fa.onAudioAutoplayFailed()},Wn.on("autoplay-failed",()=>{x.info("detect webaudio autoplay failed"),Fa.onAudioAutoplayFailed&&Fa.onAudioAutoplayFailed(),_r.safeEmit(Qn.AUTOPLAY_FAILED)}),Wn.on(Wr.STATE_CHANGE,(s,t)=>{x.info("audio context state changed: ".concat(t," => ").concat(s)),_r.onAudioContextStateChanged&&_r.onAudioContextStateChanged(s,t),_r.safeEmit(Qn.AUDIO_CONTEXT_STATE_CHANGED,s,t)}),Bi.on(Si.NETWORK_STATE_CHANGE,(s,t)=>{x.info("[network-indicator] network state changed, ".concat(t," => ").concat(s))}),window&&(window.__ARTC__=_r),_r})}),NY={};GQ(NY,{AgoraRTCProvider:()=>kY,AgoraRTCReactError:()=>kc,AgoraRTCScreenShareProvider:()=>$Q,LocalAudioTrack:()=>BY,LocalUser:()=>fZ,LocalVideoTrack:()=>e5,RemoteAudioTrack:()=>KY,RemoteUser:()=>zY,RemoteVideoTrack:()=>YY,TrackBoundary:()=>hZ,VERSION:()=>gZ,default:()=>SZ,useAutoPlayAudioTrack:()=>Z4,useAutoPlayVideoTrack:()=>Q4,useClientEvent:()=>XQ,useConnectionState:()=>tZ,useCurrentUID:()=>nZ,useIsConnected:()=>Dm,useJoin:()=>MY,useLocalCameraTrack:()=>VY,useLocalMicrophoneTrack:()=>xY,useLocalScreenTrack:()=>lZ,useNetworkQuality:()=>iZ,usePublish:()=>UY,useRTCClient:()=>Ml,useRTCScreenShareClient:()=>eZ,useRemoteAudioTracks:()=>FY,useRemoteUserTrack:()=>GW,useRemoteUsers:()=>jY,useRemoteVideoTracks:()=>cZ,useTrackEvent:()=>QQ,useVolumeLevel:()=>sZ});var HQ=jS(BS());function Ja(d,h,E){return d.on(h,E),()=>d.off(h,E)}function KQ(d){try{return d()}catch(h){console.error(h)}}function GS(d){return()=>d.forEach(KQ)}function YQ(d,h){let E=setInterval(d,h);return()=>clearInterval(E)}function W1(d,h){let E=setTimeout(d,h);return()=>clearTimeout(E)}function J4(){let d,h,E;function T(){if(h){let ne=h;h=void 0,ne()}}async function A(){if(E){let ne=E;E=void 0;try{await ne()}catch(le){console.error(le)}}}async function O(ne){d=!0,await A();try{E=await ne()}catch(le){console.error(le)}d=!1,T()}async function V(){d=!0,await A(),d=!1,T()}function X(ne){d?h=()=>O(ne):O(ne)}function $(){d?h=V:V()}return{run:X,dispose:$}}var H1=typeof document<"u"?Oe.useLayoutEffect:Oe.useEffect;function zQ(d){return d!=null&&typeof d.then=="function"}function I_(){let d=Oe.useRef(!1);return Oe.useEffect(()=>(d.current=!1,()=>{d.current=!0}),[]),d}function qQ(){let d=I_();function h(E,T){return new Promise(async(A,O)=>{try{let V=await E;d.current||A(V)}catch(V){d.current?T&&T(V):O(V)}})}return Oe.useCallback(h,[d])}function DY(d){let h=qQ(),[E,T]=Oe.useState();return H1(()=>{zQ(d)?h(d).then(T):T(d)},[d,h]),E}function WS(d,h){let E=Oe.useRef();Oe.useEffect(()=>{let{run:T,dispose:A}=E.current||(E.current=J4());return T(d),A},h)}function JQ(d,h){let E=d.split("."),T=h.split("."),A=Math.max(E.length,T.length);for(let O=0;O<A;O++){let V=parseInt(E[O]||"0"),X=parseInt(T[O]||"0");if(V>X)return 1;if(V<X)return-1}return 0}function XQ(d,h,E){let T=Oe.useRef(E);H1(()=>{T.current=E},[E]),Oe.useEffect(()=>{if(d)return Ja(d,h,(...A)=>{T.current&&T.current(...A)})},[h,d])}function QQ(d,h,E){let T=Oe.useRef(E);H1(()=>{T.current=E},[E]),Oe.useEffect(()=>{if(d)return Ja(d,h,(...A)=>{T.current&&T.current(...A)})},[h,d])}var PY=Oe.createContext(null);function kY({client:d,children:h}){return F.jsx(PY.Provider,{value:d,children:h})}function ZQ(d){let h=Oe.useContext(PY);return d||h}function Ml(d){let h=ZQ(d);if(!h)throw new Error("Agora RTC client not found. Should be wrapped in <AgoraRTCProvider value={client} />");return h}var LY=Oe.createContext(null);function $Q({client:d,children:h}){return F.jsx(LY.Provider,{value:d,children:h})}function eZ(d){let h=Oe.useContext(LY);return d||h}function tZ(d){let h=Ml(d),[E,T]=Oe.useState(h?h.connectionState:"DISCONNECTED");return Oe.useEffect(()=>{if(h){T(h.connectionState);let A;return GS([Ja(h,"connection-state-change",O=>{A==null||A(),O==="CONNECTED"?A=W1(()=>T(O),0):T(O)}),()=>A==null?void 0:A()])}else T("DISCONNECTED")},[h]),E}function Dm(d){let h=Ml(d),[E,T]=Oe.useState(h?h.connectionState==="CONNECTED":!1);return Oe.useEffect(()=>{if(h){T(h.connectionState==="CONNECTED");let A;return GS([Ja(h,"connection-state-change",O=>{A==null||A(),A=W1(()=>T(O==="CONNECTED"),0)}),()=>A==null?void 0:A()])}else T(!1)},[h]),E}function nZ(d){let h=Ml(d),[E,T]=Oe.useState(h==null?void 0:h.uid);return Oe.useEffect(()=>{if(h)return Ja(h,"connection-state-change",A=>{if(A==="CONNECTED")return W1(()=>T(h.uid),0);A==="DISCONNECTED"&&T(void 0)})},[h]),E}var kc=class extends Error{constructor(h,E){var d=(...E$)=>(super(...E$),T0(this,"rtcMethod"),T0(this,"rtcError"),T0(this,"name","AgoraRTCReactException"),this);d(typeof E=="string"?E:E.message),this.rtcMethod=h,this.rtcError=E}log(h){console[h](this)}};function MY(d,h=!0,E){let T=Ml(E),A=Dm(E),O=Oe.useRef(),[V,X]=Oe.useState(!1),[$,ne]=Oe.useState(0),[le,ae]=Oe.useState(null),ge=I_();return WS(async()=>{if(ge.current||(ae(null),ne(0),X(!1)),h&&T){try{ge.current||X(!0);let{appid:Fe,channel:we,token:Ye,uid:Se}=typeof d=="function"?await d():d,ue=await T.join(Fe,we,Ye,Se);ge.current||ne(ue)}catch(Fe){console.error(Fe),ge.current||ae(new kc("IAgoraRTCClient.join",Fe))}ge.current||X(!1);let je=O.current||(O.current=J4());return GS([()=>{je.dispose()},()=>{je.run(()=>T.unpublish(T.localTracks))},()=>{for(let Fe of T.localTracks)Fe.isPlaying&&Fe.stop(),Fe.close();je.run(()=>T.leave())}])}},[h,E]),{data:$,isLoading:V,isConnected:A,error:le}}var M6=()=>({uplinkNetworkQuality:0,downlinkNetworkQuality:0,delay:0});function iZ(d){let h=Ml(d),[E,T]=Oe.useState(M6);return Oe.useEffect(()=>{if(h)return Ja(h,"network-quality",A=>T({uplinkNetworkQuality:A.uplinkNetworkQuality,downlinkNetworkQuality:A.downlinkNetworkQuality,delay:h.getRTCStats().RTT??0}));T(M6())},[h]),E}var rZ=jS(BS());function UY(d,h=!0,E){let T=Ml(E),A=Dm(E),O=Oe.useRef([]),[V,X]=Oe.useState(!1),[$,ne]=Oe.useState(null),le=I_();return WS(async()=>{if(le.current||(X(!1),ne(null)),!T||!A||!h)return;let ae=d.filter(Boolean),ge=we=>{let Ye=JQ(rZ.default.VERSION,"4.18.2")>=0;return Ye||new kc("usePublish","please check your agora-rtc-sdk-ng version in package.json, it's recommend upgrade to >= 4.18.2").log("warn"),Ye?T.mode!=="live"||T.role!=="audience":!0},je=we=>O.current.some(Ye=>Ye&&Ye.getTrackId()===we.getTrackId()),Fe=we=>ge()&&we.enabled&&h&&!je(we);for(let we=0;we<ae.length;we++){let Ye=ae[we];if(Ye&&Fe(Ye)){await T.unpublish(O.current.filter(Se=>(Se==null?void 0:Se.trackMediaType)===Ye.trackMediaType));try{le.current||X(!0),await T.publish(Ye)}catch(Se){console.error(Se),le.current||ne(new kc("IAgoraRTCClient.publish",Se))}le.current||X(!1)}}O.current=ae},[A,h,T,d]),{isLoading:V,error:$}}function sZ(d){let[h,E]=Oe.useState(0);return Oe.useEffect(()=>{if(d)return YQ(()=>{E(d.getVolumeLevel())},1e3)},[d]),h}var oZ=jS(BS());function xY(d=!0,h={ANS:!0,AEC:!0},E){let T=Dm(E),[A,O]=Oe.useState(null),[V,X]=Oe.useState(!1),[$,ne]=Oe.useState(null),le=I_();return WS(async()=>{if(le.current||(X(!1),ne(null)),T&&d&&!A){try{le.current||X(!0);let ae=await oZ.default.createMicrophoneAudioTrack(h);le.current||O(ae)}catch(ae){console.error(ae),le.current||ne(new kc("IAgoraRTC.createMicrophoneAudioTrack",ae))}le.current||X(!1)}!T&&!le.current&&O(null)},[T,d]),{localMicrophoneTrack:A,isLoading:V,error:$}}var aZ=jS(BS());function VY(d=!0,h,E){let T=Dm(E),[A,O]=Oe.useState(null),[V,X]=Oe.useState(!1),[$,ne]=Oe.useState(null),le=I_();return WS(async()=>{if(le.current||(X(!1),ne(null)),T&&d&&!A){try{le.current||X(!0);let ae=await aZ.default.createCameraVideoTrack(h);le.current||O(ae)}catch(ae){console.error(ae),le.current||ne(new kc("IAgoraRTC.createCameraVideoTrack",ae))}le.current||X(!1)}!T&&!le.current&&O(null)},[T,d]),{localCameraTrack:A,isLoading:V,error:$}}function FY(d,h){let E=Ml(h),[T,A]=Oe.useState([]),O=Dm(),V=Oe.useRef([]),[X,$]=Oe.useState(!1),[ne,le]=Oe.useState(null),ae=I_();return WS(async()=>{if(ae.current||le(null),!Array.isArray(d)||!O)return;let ge=async we=>{if(!we.audioTrack&&d.some(({uid:Ye})=>we.uid===Ye)){try{ae.current||$(!0),await E.subscribe(we,"audio")}catch(Ye){console.error(Ye),ae.current||le(new kc("IAgoraRTCClient.subscribe",Ye))}we.audioTrack&&!V.current.some(Ye=>Ye.getUserId()===we.uid)&&V.current.push(we.audioTrack),V.current=V.current.map(Ye=>we.audioTrack&&Ye.getUserId()===we.uid&&Ye.getTrackId()!==we.audioTrack.getTrackId()?we.audioTrack:Ye),ae.current||(A(V.current),$(!1))}},je=async we=>{if(d.some(({uid:Ye})=>we.uid===Ye)){ae.current||(V.current=V.current.filter(Ye=>Ye.getUserId()!==we.uid),A(V.current));try{ae.current||$(!0),await E.unsubscribe(we,"audio")}catch(Ye){console.error(Ye),ae.current||le(new kc("IAgoraRTCClient.unsubscribe",Ye))}ae.current||$(!1)}};d.map(we=>{!we.audioTrack&&we.hasAudio&&ge(we)});let Fe=[];for(let we=0;we<V.current.length;we++){let Ye=V.current[we];if(!d.some(Se=>Se.uid===Ye.getUserId())){let Se=E.remoteUsers.find(ue=>ue.uid===Ye.getUserId());Se&&Fe.push({user:Se,mediaType:"audio"}),V.current.splice(we,1),we--}}if(Fe.length>0){try{ae.current||$(!0),await E.massUnsubscribe(Fe)}catch(we){console.error(we),ae.current||le(new kc("IAgoraRTCClient.massUnsubscribe",we))}ae.current||(A(V.current.slice()),$(!1))}return GS([Ja(E,"user-published",(we,Ye)=>{d.find(Se=>Se.uid===we.uid)&&Ye==="audio"&&ge(we)}),Ja(E,"user-unpublished",(we,Ye)=>{d.find(Se=>Se.uid===we.uid)&&Ye==="audio"&&je(we)})])},[O,E,d]),{audioTracks:T,isLoading:X,error:ne}}function cZ(d,h){let E=Ml(h),[T,A]=Oe.useState([]),O=Dm(),V=Oe.useRef([]),[X,$]=Oe.useState(!1),[ne,le]=Oe.useState(null),ae=I_();return WS(async()=>{if(ae.current||le(null),!Array.isArray(d)||!O)return;let ge=async we=>{if(!we.videoTrack&&d.some(({uid:Ye})=>we.uid===Ye)){try{ae.current||$(!0),await E.subscribe(we,"video")}catch(Ye){console.error(Ye),ae.current||le(new kc("IAgoraRTCClient.subscribe",Ye))}we.videoTrack&&!V.current.some(Ye=>Ye.getUserId()===we.uid)&&V.current.push(we.videoTrack),V.current=V.current.map(Ye=>we.videoTrack&&Ye.getUserId()===we.uid&&Ye.getTrackId()!==we.videoTrack.getTrackId()?we.videoTrack:Ye),ae.current||(A(V.current),$(!1))}},je=async we=>{if(d.some(({uid:Ye})=>we.uid===Ye)){ae.current||(V.current=V.current.filter(Ye=>Ye.getUserId()!==we.uid),A(V.current));try{ae.current||$(!0),await E.unsubscribe(we,"video")}catch(Ye){console.error(Ye),ae.current||le(new kc("IAgoraRTCClient.unsubscribe",Ye))}ae.current||$(!1)}};d.map(we=>{!we.videoTrack&&we.hasVideo&&ge(we)});let Fe=[];for(let we=0;we<V.current.length;we++){let Ye=V.current[we];if(!d.some(Se=>Se.uid===Ye.getUserId())){let Se=E.remoteUsers.find(ue=>ue.uid===Ye.getUserId());Se&&Fe.push({user:Se,mediaType:"video"}),V.current.splice(we,1),we--}}if(Fe.length>0){try{ae.current||$(!0),await E.massUnsubscribe(Fe)}catch(we){console.error(we),ae.current||le(new kc("IAgoraRTCClient.massUnsubscribe",we))}ae.current||(A(V.current.slice()),$(!1))}return GS([Ja(E,"user-published",(we,Ye)=>{d.find(Se=>Se.uid===we.uid)&&Ye==="video"&&ge(we)}),Ja(E,"user-unpublished",(we,Ye)=>{d.find(Se=>Se.uid===we.uid)&&Ye==="video"&&je(we)})])},[O,E,d]),{videoTracks:T,isLoading:X,error:ne}}function GW(d,h,E){let T=Ml(E),A=h==="audio"?"audioTrack":"videoTrack",[O,V]=Oe.useState(d&&d[A]),X=Dm(),$=Oe.useRef(),[ne,le]=Oe.useState(!1),[ae,ge]=Oe.useState(null);return Oe.useEffect(()=>{if(!d||!X)return;let je=!1;je||ge(null);let Fe=h==="audio"?"hasAudio":"hasVideo",we=d.uid,Ye=async(ve,tt)=>{if(ve[A]&&T.remoteUsers.some(({uid:Rt})=>ve.uid===Rt))try{je||le(!0),await T.unsubscribe(ve,tt)}catch(Rt){je||ge(new kc("IAgoraRTCClient.unsubscribe",Rt)),console.error(Rt)}je||(V(void 0),le(!1))},Se=async(ve,tt)=>{try{!ve[A]&&T.remoteUsers.some(({uid:Rt})=>ve.uid===Rt)&&(je||le(!0),await T.subscribe(ve,tt)),je||V(ve[A])}catch(Rt){je||ge(new kc("IAgoraRTCClient.subscribe",Rt)),console.error(Rt)}je||le(!1)},ue=$.current||($.current=J4());return!d[A]&&d[Fe]?ue.run(()=>Se(d,h)):V(d[A]),GS([()=>{je=!0,ue.dispose()},Ja(T,"user-published",(ve,tt)=>{ve.uid===we&&tt===h&&ue.run(()=>Se(ve,h))}),Ja(T,"user-unpublished",(ve,tt)=>{ve.uid===we&&tt===h&&ue.run(()=>Ye(ve,h))})])},[X,T,d,h,A]),{track:O,isLoading:ne,error:ae}}function jY(d){let h=Ml(d),[E,T]=Oe.useState(h?h.remoteUsers:[]);return Oe.useEffect(()=>{if(h){let A=()=>T(h.remoteUsers.slice());return GS([Ja(h,"user-joined",A),Ja(h,"user-left",A),Ja(h,"user-published",A),Ja(h,"user-unpublished",A)])}},[h]),E}var dZ=jS(BS());function lZ(d=!0,h,E,T){let A=Dm(T),[O,V]=Oe.useState(null),[X,$]=Oe.useState(!1),[ne,le]=Oe.useState(null),ae=I_();return WS(async()=>{if(ae.current||($(!1),le(null)),A&&d&&!O){try{ae.current||$(!0);let ge=await dZ.default.createScreenVideoTrack(h,E);ae.current||V(ge)}catch(ge){console.error(ge),ae.current||le(new kc("IAgoraRTC.createScreenVideoTrack",ge))}ae.current||$(!1)}(!A||!d)&&!ae.current&&V(null)},[A,d]),{screenTrack:O,isLoading:X,error:ne}}function uZ(){let d=new Map,h=1500;return{onMount:E=>{let T=d.get(E);T&&(T(),d.delete(E))},onUnmount:E=>{let T=d.get(E);T&&T(),d.set(E,W1(()=>{E.isPlaying&&E.stop(),d.delete(E)},h))},dispose:()=>{for(let[E,T]of d)E.isPlaying&&E.stop(),T&&T();d.clear()}}}var X4=Oe.createContext(void 0);function hZ({children:d}){let[h]=Oe.useState(uZ);return Oe.useEffect(()=>h.dispose,[h]),F.jsx(X4.Provider,{value:h,children:d})}function Q4(d,h,E){let T=Oe.useContext(X4);Oe.useEffect(()=>{if(d)return E&&h?d.play(E):d.stop(),T?(T.onMount(d),()=>T.onUnmount(d)):()=>{d.isPlaying&&d.stop()}},[d,E,h,T])}function Z4(d,h){let E=Oe.useContext(X4);H1(()=>{if(d)return h?d.play():d.stop(),E?(E.onMount(d),()=>E.onUnmount(d)):()=>{d.isPlaying&&d.stop()}},[d,h,E])}function BY({track:d,play:h=!1,volume:E,disabled:T,muted:A,children:O}){let V=DY(d);return Z4(V,h),Oe.useEffect(()=>{V&&E!=null&&V.setVolume(E)},[V,E]),Oe.useEffect(()=>{V&&T!=null&&V.setEnabled(!T).catch(console.warn)},[T,V]),Oe.useEffect(()=>{V&&A!=null&&V.setMuted(A).catch(console.warn)},[A,V]),O?F.jsx(F.Fragment,{children:O}):null}var GY={position:"relative",width:"100%",height:"100%",overflow:"hidden",background:"#000"},WY={width:"100%",height:"100%"},$4={position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"hidden",zIndex:2},K1=(d,h)=>Oe.useMemo(()=>({...d,...h}),[d,h]);function e5({track:d,play:h,disabled:E,muted:T,style:A,...O}){let V=K1(WY,A),[X,$]=Oe.useState(null),ne=DY(d);return Q4(ne,h,X),Oe.useEffect(()=>{ne&&E!=null&&ne.setEnabled(!E).catch(console.warn)},[E,ne]),Oe.useEffect(()=>{ne&&T!=null&&ne.setMuted(T).catch(console.warn)},[T,ne]),F.jsx("div",{...O,ref:$,style:V})}var pZ={width:"100%",height:"100%",background:"#1a1e21 center/cover no-repeat",filter:"blur(16px) brightness(0.4)"},mZ={position:"absolute",top:"50%",left:"50%",maxWidth:"50%",maxHeight:"50%",aspectRatio:"1",transform:"translate(-50%, -50%)",borderRadius:"50%",overflow:"hidden",objectFit:"cover"};function HY({cover:d}){return F.jsx("div",{style:$4,children:typeof d=="string"?F.jsxs(F.Fragment,{children:[F.jsx("div",{style:{...pZ,backgroundImage:`url(${d})`}}),F.jsx("img",{src:d,style:mZ})]}):d()})}function fZ({micOn:d,cameraOn:h,audioTrack:E,videoTrack:T,playAudio:A,playVideo:O,volume:V,cover:X,children:$,style:ne,...le}){let ae=K1(GY,ne);return O=O??!!h,A=A??!!d,F.jsxs("div",{...le,style:ae,children:[F.jsx(e5,{disabled:!h,play:O,track:T}),F.jsx(BY,{disabled:!d,play:A,track:E,volume:V}),X&&!h&&F.jsx(HY,{cover:X}),F.jsx("div",{style:$4,children:$})]})}function KY({track:d,play:h=!1,playbackDeviceId:E,volume:T,children:A}){return Z4(d,h),Oe.useEffect(()=>{d&&E!=null&&d.setPlaybackDevice(E).catch(console.warn)},[d,E]),Oe.useEffect(()=>{d&&T!=null&&d.setVolume(T)},[d,T]),A?F.jsx(F.Fragment,{children:A}):null}function YY({track:d,play:h,style:E,...T}){let A=K1(WY,E),[O,V]=Oe.useState(null);return Q4(d,h,O),F.jsx("div",{...T,ref:V,style:A})}function zY({user:d,playVideo:h,playAudio:E,playbackDeviceId:T,volume:A,cover:O,style:V,children:X,...$}){let ne=K1(GY,V),{track:le}=GW(d,"video"),{track:ae}=GW(d,"audio");return h=h??(d==null?void 0:d.hasVideo),E=E??(d==null?void 0:d.hasAudio),F.jsxs("div",{...$,style:ne,children:[F.jsx(YY,{play:h,track:le}),F.jsx(KY,{play:E,playbackDeviceId:T,track:ae,volume:A}),O&&!h&&F.jsx(HY,{cover:O}),F.jsx("div",{style:$4,children:X})]})}var _Z=jS(BS()),EZ=class{constructor(){T0(this,"appType",1001);_Z.default.setAppType(this.appType)}};new EZ;var gZ="2.1.0";WQ(NY,jS(BS()));var SZ=HQ.default,qY={exports:{}};(function(d,h){(function(E,T){d.exports=T()})(lL,function(){function E(r,e){return e.forEach(function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach(function(o){if(o!=="default"&&!(o in r)){var c=Object.getOwnPropertyDescriptor(n,o);Object.defineProperty(r,o,c.get?c:{enumerable:!0,get:function(){return n[o]}})}})}),Object.freeze(r)}var T=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof lL<"u"?lL:typeof self<"u"?self:{};function A(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var O=function(r){try{return!!r()}catch{return!0}},V=!O(function(){var r=(function(){}).bind();return typeof r!="function"||r.hasOwnProperty("prototype")}),X=V,$=Function.prototype,ne=$.call,le=X&&$.bind.bind(ne,ne),ae=X?le:function(r){return function(){return ne.apply(r,arguments)}},ge=ae({}.isPrototypeOf),je=function(r){return r&&r.Math==Math&&r},Fe=je(typeof globalThis=="object"&&globalThis)||je(typeof window=="object"&&window)||je(typeof self=="object"&&self)||je(typeof T=="object"&&T)||function(){return this}()||T||Function("return this")(),we=V,Ye=Function.prototype,Se=Ye.apply,ue=Ye.call,ve=typeof Reflect=="object"&&Reflect.apply||(we?ue.bind(Se):function(){return ue.apply(Se,arguments)}),tt=ae,Rt=tt({}.toString),lt=tt("".slice),dt=function(r){return lt(Rt(r),8,-1)},Et=dt,Bt=ae,Ht=function(r){if(Et(r)==="Function")return Bt(r)},rr=typeof document=="object"&&document.all,Fr={all:rr,IS_HTMLDDA:rr===void 0&&rr!==void 0},vn=Fr.all,Ft=Fr.IS_HTMLDDA?function(r){return typeof r=="function"||r===vn}:function(r){return typeof r=="function"},as={},ii=!O(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),Os=V,Ot=Function.prototype.call,Nt=Os?Ot.bind(Ot):function(){return Ot.apply(Ot,arguments)},cn={},Vi={}.propertyIsEnumerable,Fi=Object.getOwnPropertyDescriptor,$s=Fi&&!Vi.call({1:2},1);cn.f=$s?function(r){var e=Fi(this,r);return!!e&&e.enumerable}:Vi;var yi,gs,sr=function(r,e){return{enumerable:!(1&r),configurable:!(2&r),writable:!(4&r),value:e}},Uc=O,Jv=dt,A_=Object,Y1=ae("".split),Pm=Uc(function(){return!A_("z").propertyIsEnumerable(0)})?function(r){return Jv(r)=="String"?Y1(r,""):A_(r)}:A_,zh=function(r){return r==null},z1=zh,q1=TypeError,Ul=function(r){if(z1(r))throw q1("Can't call method on "+r);return r},J1=Pm,X1=Ul,Za=function(r){return J1(X1(r))},Xv=Ft,Q1=Fr.all,qr=Fr.IS_HTMLDDA?function(r){return typeof r=="object"?r!==null:Xv(r)||r===Q1}:function(r){return typeof r=="object"?r!==null:Xv(r)},po={},w_=po,b_=Fe,Z1=Ft,Qv=function(r){return Z1(r)?r:void 0},hr=function(r,e){return arguments.length<2?Qv(w_[r])||Qv(b_[r]):w_[r]&&w_[r][e]||b_[r]&&b_[r][e]},$a=typeof navigator<"u"&&String(navigator.userAgent)||"",Zv=Fe,O_=$a,$v=Zv.process,eR=Zv.Deno,tR=$v&&$v.versions||eR&&eR.version,nR=tR&&tR.v8;nR&&(gs=(yi=nR.split("."))[0]>0&&yi[0]<4?1:+(yi[0]+yi[1])),!gs&&O_&&(!(yi=O_.match(/Edge\/(\d+)/))||yi[1]>=74)&&(yi=O_.match(/Chrome\/(\d+)/))&&(gs=+yi[1]);var ec=gs,iR=ec,$1=O,eM=Fe.String,pd=!!Object.getOwnPropertySymbols&&!$1(function(){var r=Symbol();return!eM(r)||!(Object(r)instanceof Symbol)||!Symbol.sham&&iR&&iR<41}),rR=pd&&!Symbol.sham&&typeof Symbol.iterator=="symbol",tM=hr,nM=Ft,iM=ge,rM=Object,xl=rR?function(r){return typeof r=="symbol"}:function(r){var e=tM("Symbol");return nM(e)&&iM(e.prototype,rM(r))},sM=String,md=function(r){try{return sM(r)}catch{return"Object"}},oM=Ft,aM=md,cM=TypeError,cs=function(r){if(oM(r))return r;throw cM(aM(r)+" is not a function")},dM=cs,lM=zh,N_=function(r,e){var n=r[e];return lM(n)?void 0:dM(n)},sR=Nt,oR=Ft,aR=qr,uM=TypeError,cR={exports:{}},dR=Fe,hM=Object.defineProperty,pM=function(r,e){try{hM(dR,r,{value:e,configurable:!0,writable:!0})}catch{dR[r]=e}return e},lR="__core-js_shared__",D_=Fe[lR]||pM(lR,{}),uR=D_;(cR.exports=function(r,e){return uR[r]||(uR[r]=e!==void 0?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var fd=cR.exports,mM=Ul,fM=Object,Oo=function(r){return fM(mM(r))},_M=Oo,EM=ae({}.hasOwnProperty),ji=Object.hasOwn||function(r,e){return EM(_M(r),e)},gM=ae,SM=0,TM=Math.random(),CM=gM(1 .toString),P_=function(r){return"Symbol("+(r===void 0?"":r)+")_"+CM(++SM+TM,36)},vM=fd,hR=ji,RM=P_,yM=pd,IM=rR,_d=Fe.Symbol,k_=vM("wks"),AM=IM?_d.for||_d:_d&&_d.withoutSetter||RM,wn=function(r){return hR(k_,r)||(k_[r]=yM&&hR(_d,r)?_d[r]:AM("Symbol."+r)),k_[r]},wM=Nt,pR=qr,mR=xl,bM=N_,OM=function(r,e){var n,o;if(oR(n=r.toString)&&!aR(o=sR(n,r))||oR(n=r.valueOf)&&!aR(o=sR(n,r)))return o;throw uM("Can't convert object to primitive value")},NM=TypeError,DM=wn("toPrimitive"),PM=function(r,e){if(!pR(r)||mR(r))return r;var n,o=bM(r,DM);if(o){if(n=wM(o,r,e),!pR(n)||mR(n))return n;throw NM("Can't convert object to primitive value")}return OM(r)},kM=xl,qh=function(r){var e=PM(r,"string");return kM(e)?e:e+""},fR=qr,L_=Fe.document,LM=fR(L_)&&fR(L_.createElement),M_=function(r){return LM?L_.createElement(r):{}},MM=M_,_R=!ii&&!O(function(){return Object.defineProperty(MM("div"),"a",{get:function(){return 7}}).a!=7}),UM=ii,xM=Nt,VM=cn,FM=sr,jM=Za,BM=qh,GM=ji,WM=_R,ER=Object.getOwnPropertyDescriptor;as.f=UM?ER:function(r,e){if(r=jM(r),e=BM(e),WM)try{return ER(r,e)}catch{}if(GM(r,e))return FM(!xM(VM.f,r,e),r[e])};var HM=O,KM=Ft,YM=/#|\.prototype\./,Vl=function(r,e){var n=qM[zM(r)];return n==XM||n!=JM&&(KM(e)?HM(e):!!e)},zM=Vl.normalize=function(r){return String(r).replace(YM,".").toLowerCase()},qM=Vl.data={},JM=Vl.NATIVE="N",XM=Vl.POLYFILL="P",gR=Vl,QM=cs,ZM=V,$M=Ht(Ht.bind),xc=function(r,e){return QM(r),e===void 0?r:ZM?$M(r,e):function(){return r.apply(e,arguments)}},ds={},SR=ii&&O(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),eU=qr,tU=String,nU=TypeError,ls=function(r){if(eU(r))return r;throw nU(tU(r)+" is not an object")},iU=ii,rU=_R,sU=SR,Jh=ls,TR=qh,oU=TypeError,U_=Object.defineProperty,aU=Object.getOwnPropertyDescriptor,x_="enumerable",V_="configurable",F_="writable";ds.f=iU?sU?function(r,e,n){if(Jh(r),e=TR(e),Jh(n),typeof r=="function"&&e==="prototype"&&"value"in n&&F_ in n&&!n[F_]){var o=aU(r,e);o&&o[F_]&&(r[e]=n.value,n={configurable:V_ in n?n[V_]:o[V_],enumerable:x_ in n?n[x_]:o[x_],writable:!1})}return U_(r,e,n)}:U_:function(r,e,n){if(Jh(r),e=TR(e),Jh(n),rU)try{return U_(r,e,n)}catch{}if("get"in n||"set"in n)throw oU("Accessors not supported");return"value"in n&&(r[e]=n.value),r};var cU=ds,dU=sr,ra=ii?function(r,e,n){return cU.f(r,e,dU(1,n))}:function(r,e,n){return r[e]=n,r},Xh=Fe,lU=ve,uU=Ht,hU=Ft,pU=as.f,mU=gR,Ed=po,fU=xc,gd=ra,CR=ji,_U=function(r){var e=function(n,o,c){if(this instanceof e){switch(arguments.length){case 0:return new r;case 1:return new r(n);case 2:return new r(n,o)}return new r(n,o,c)}return lU(r,this,arguments)};return e.prototype=r.prototype,e},Xt=function(r,e){var n,o,c,u,m,_,S,C,R,w=r.target,N=r.global,L=r.stat,H=r.proto,j=N?Xh:L?Xh[w]:(Xh[w]||{}).prototype,W=N?Ed:Ed[w]||gd(Ed,w,{})[w],ee=W.prototype;for(u in e)o=!(n=mU(N?u:w+(L?".":"#")+u,r.forced))&&j&&CR(j,u),_=W[u],o&&(S=r.dontCallGetSet?(R=pU(j,u))&&R.value:j[u]),m=o&&S?S:e[u],o&&typeof _==typeof m||(C=r.bind&&o?fU(m,Xh):r.wrap&&o?_U(m):H&&hU(m)?uU(m):m,(r.sham||m&&m.sham||_&&_.sham)&&gd(C,"sham",!0),gd(W,u,C),H&&(CR(Ed,c=w+"Prototype")||gd(Ed,c,{}),gd(Ed[c],u,m),r.real&&ee&&(n||!ee[u])&&gd(ee,u,m)))},EU=Math.ceil,gU=Math.floor,SU=Math.trunc||function(r){var e=+r;return(e>0?gU:EU)(e)},j_=function(r){var e=+r;return e!=e||e===0?0:SU(e)},TU=j_,CU=Math.max,vU=Math.min,vR=function(r,e){var n=TU(r);return n<0?CU(n+e,0):vU(n,e)},RU=j_,yU=Math.min,IU=function(r){return r>0?yU(RU(r),9007199254740991):0},Da=function(r){return IU(r.length)},AU=Za,wU=vR,bU=Da,RR=function(r){return function(e,n,o){var c,u=AU(e),m=bU(u),_=wU(o,m);if(r&&n!=n){for(;m>_;)if((c=u[_++])!=c)return!0}else for(;m>_;_++)if((r||_ in u)&&u[_]===n)return r||_||0;return!r&&-1}},B_={includes:RR(!0),indexOf:RR(!1)},OU=B_.includes;Xt({target:"Array",proto:!0,forced:O(function(){return!Array(1).includes()})},{includes:function(r){return OU(this,r,arguments.length>1?arguments[1]:void 0)}});var NU=po,sa=function(r){return NU[r+"Prototype"]},DU=sa("Array").includes,PU=qr,kU=dt,LU=wn("match"),MU=function(r){var e;return PU(r)&&((e=r[LU])!==void 0?!!e:kU(r)=="RegExp")},UU=TypeError,yR={};yR[wn("toStringTag")]="z";var G_=String(yR)==="[object z]",xU=G_,VU=Ft,Qh=dt,FU=wn("toStringTag"),jU=Object,BU=Qh(function(){return arguments}())=="Arguments",Pa=xU?Qh:function(r){var e,n,o;return r===void 0?"Undefined":r===null?"Null":typeof(n=function(c,u){try{return c[u]}catch{}}(e=jU(r),FU))=="string"?n:BU?Qh(e):(o=Qh(e))=="Object"&&VU(e.callee)?"Arguments":o},GU=Pa,WU=String,Bs=function(r){if(GU(r)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return WU(r)},HU=wn("match"),KU=Xt,YU=function(r){if(MU(r))throw UU("The method doesn't accept regular expressions");return r},zU=Ul,IR=Bs,qU=function(r){var e=/./;try{"/./"[r](e)}catch{try{return e[HU]=!1,"/./"[r](e)}catch{}}return!1},JU=ae("".indexOf);KU({target:"String",proto:!0,forced:!qU("includes")},{includes:function(r){return!!~JU(IR(zU(this)),IR(YU(r)),arguments.length>1?arguments[1]:void 0)}});var XU=sa("String").includes,AR=ge,QU=DU,ZU=XU,W_=Array.prototype,H_=String.prototype,xe=A(function(r){var e=r.includes;return r===W_||AR(W_,r)&&e===W_.includes?QU:typeof r=="string"||r===H_||AR(H_,r)&&e===H_.includes?ZU:e});let wR=!0,bR=!0;function Zh(r,e,n){const o=r.match(e);return o&&o.length>=n&&parseInt(o[n],10)}function tc(r,e,n){if(!r.RTCPeerConnection)return;const o=r.RTCPeerConnection.prototype,c=o.addEventListener;o.addEventListener=function(m,_){if(m!==e)return c.apply(this,arguments);const S=C=>{const R=n(C);R&&(_.handleEvent?_.handleEvent(R):_(R))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(_,S),c.apply(this,[m,S])};const u=o.removeEventListener;o.removeEventListener=function(m,_){if(m!==e||!this._eventMap||!this._eventMap[e])return u.apply(this,arguments);if(!this._eventMap[e].has(_))return u.apply(this,arguments);const S=this._eventMap[e].get(_);return this._eventMap[e].delete(_),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,u.apply(this,[m,S])},Object.defineProperty(o,"on"+e,{get(){return this["_on"+e]},set(m){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),m&&this.addEventListener(e,this["_on"+e]=m)},enumerable:!0,configurable:!0})}function $U(r){return typeof r!="boolean"?new Error("Argument type: "+typeof r+". Please use a boolean."):(wR=r,r?"adapter.js logging disabled":"adapter.js logging enabled")}function ex(r){return typeof r!="boolean"?new Error("Argument type: "+typeof r+". Please use a boolean."):(bR=!r,"adapter.js deprecation warnings "+(r?"disabled":"enabled"))}function OR(){if(typeof window=="object"){if(wR)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function K_(r,e){bR&&console.warn(r+" is deprecated, please use "+e+" instead.")}function NR(r){return Object.prototype.toString.call(r)==="[object Object]"}function DR(r){return NR(r)?Object.keys(r).reduce(function(e,n){const o=NR(r[n]),c=o?DR(r[n]):r[n],u=o&&!Object.keys(c).length;return c===void 0||u?e:Object.assign(e,{[n]:c})},{}):r}function Y_(r,e,n){e&&!n.has(e.id)&&(n.set(e.id,e),Object.keys(e).forEach(o=>{o.endsWith("Id")?Y_(r,r.get(e[o]),n):o.endsWith("Ids")&&e[o].forEach(c=>{Y_(r,r.get(c),n)})}))}function PR(r,e,n){const o=n?"outbound-rtp":"inbound-rtp",c=new Map;if(e===null)return c;const u=[];return r.forEach(m=>{m.type==="track"&&m.trackIdentifier===e.id&&u.push(m)}),u.forEach(m=>{r.forEach(_=>{_.type===o&&_.trackId===m.id&&Y_(r,_,c)})}),c}const kR=OR;function LR(r,e){const n=r&&r.navigator;if(!n.mediaDevices)return;const o=function(m){if(typeof m!="object"||m.mandatory||m.optional)return m;const _={};return Object.keys(m).forEach(S=>{if(S==="require"||S==="advanced"||S==="mediaSource")return;const C=typeof m[S]=="object"?m[S]:{ideal:m[S]};C.exact!==void 0&&typeof C.exact=="number"&&(C.min=C.max=C.exact);const R=function(w,N){return w?w+N.charAt(0).toUpperCase()+N.slice(1):N==="deviceId"?"sourceId":N};if(C.ideal!==void 0){_.optional=_.optional||[];let w={};typeof C.ideal=="number"?(w[R("min",S)]=C.ideal,_.optional.push(w),w={},w[R("max",S)]=C.ideal,_.optional.push(w)):(w[R("",S)]=C.ideal,_.optional.push(w))}C.exact!==void 0&&typeof C.exact!="number"?(_.mandatory=_.mandatory||{},_.mandatory[R("",S)]=C.exact):["min","max"].forEach(w=>{C[w]!==void 0&&(_.mandatory=_.mandatory||{},_.mandatory[R(w,S)]=C[w])})}),m.advanced&&(_.optional=(_.optional||[]).concat(m.advanced)),_},c=function(m,_){if(e.version>=61)return _(m);if((m=JSON.parse(JSON.stringify(m)))&&typeof m.audio=="object"){const S=function(C,R,w){R in C&&!(w in C)&&(C[w]=C[R],delete C[R])};S((m=JSON.parse(JSON.stringify(m))).audio,"autoGainControl","googAutoGainControl"),S(m.audio,"noiseSuppression","googNoiseSuppression"),m.audio=o(m.audio)}if(m&&typeof m.video=="object"){let S=m.video.facingMode;S=S&&(typeof S=="object"?S:{ideal:S});const C=e.version<66;if(S&&(S.exact==="user"||S.exact==="environment"||S.ideal==="user"||S.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||C)){let R;if(delete m.video.facingMode,S.exact==="environment"||S.ideal==="environment"?R=["back","rear"]:S.exact!=="user"&&S.ideal!=="user"||(R=["front"]),R)return n.mediaDevices.enumerateDevices().then(w=>{let N=(w=w.filter(L=>L.kind==="videoinput")).find(L=>R.some(H=>L.label.toLowerCase().includes(H)));return!N&&w.length&&R.includes("back")&&(N=w[w.length-1]),N&&(m.video.deviceId=S.exact?{exact:N.deviceId}:{ideal:N.deviceId}),m.video=o(m.video),kR("chrome: "+JSON.stringify(m)),_(m)})}m.video=o(m.video)}return kR("chrome: "+JSON.stringify(m)),_(m)},u=function(m){return e.version>=64?m:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[m.name]||m.name,message:m.message,constraint:m.constraint||m.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=(function(m,_,S){c(m,C=>{n.webkitGetUserMedia(C,_,R=>{S&&S(u(R))})})}).bind(n),n.mediaDevices.getUserMedia){const m=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(_){return c(_,S=>m(S).then(C=>{if(S.audio&&!C.getAudioTracks().length||S.video&&!C.getVideoTracks().length)throw C.getTracks().forEach(R=>{R.stop()}),new DOMException("","NotFoundError");return C},C=>Promise.reject(u(C))))}}}function MR(r){r.MediaStream=r.MediaStream||r.webkitMediaStream}function UR(r){if(typeof r=="object"&&r.RTCPeerConnection&&!("ontrack"in r.RTCPeerConnection.prototype)){Object.defineProperty(r.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const e=r.RTCPeerConnection.prototype.setRemoteDescription;r.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",o=>{let c;c=r.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(m=>m.track&&m.track.id===o.track.id):{track:o.track};const u=new Event("track");u.track=o.track,u.receiver=c,u.transceiver={receiver:c},u.streams=[n.stream],this.dispatchEvent(u)}),n.stream.getTracks().forEach(o=>{let c;c=r.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(m=>m.track&&m.track.id===o.id):{track:o};const u=new Event("track");u.track=o,u.receiver=c,u.transceiver={receiver:c},u.streams=[n.stream],this.dispatchEvent(u)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else tc(r,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function xR(r){if(typeof r=="object"&&r.RTCPeerConnection&&!("getSenders"in r.RTCPeerConnection.prototype)&&"createDTMFSender"in r.RTCPeerConnection.prototype){const e=function(c,u){return{track:u,get dtmf(){return this._dtmf===void 0&&(u.kind==="audio"?this._dtmf=c.createDTMFSender(u):this._dtmf=null),this._dtmf},_pc:c}};if(!r.RTCPeerConnection.prototype.getSenders){r.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const c=r.RTCPeerConnection.prototype.addTrack;r.RTCPeerConnection.prototype.addTrack=function(m,_){let S=c.apply(this,arguments);return S||(S=e(this,m),this._senders.push(S)),S};const u=r.RTCPeerConnection.prototype.removeTrack;r.RTCPeerConnection.prototype.removeTrack=function(m){u.apply(this,arguments);const _=this._senders.indexOf(m);_!==-1&&this._senders.splice(_,1)}}const n=r.RTCPeerConnection.prototype.addStream;r.RTCPeerConnection.prototype.addStream=function(c){this._senders=this._senders||[],n.apply(this,[c]),c.getTracks().forEach(u=>{this._senders.push(e(this,u))})};const o=r.RTCPeerConnection.prototype.removeStream;r.RTCPeerConnection.prototype.removeStream=function(c){this._senders=this._senders||[],o.apply(this,[c]),c.getTracks().forEach(u=>{const m=this._senders.find(_=>_.track===u);m&&this._senders.splice(this._senders.indexOf(m),1)})}}else if(typeof r=="object"&&r.RTCPeerConnection&&"getSenders"in r.RTCPeerConnection.prototype&&"createDTMFSender"in r.RTCPeerConnection.prototype&&r.RTCRtpSender&&!("dtmf"in r.RTCRtpSender.prototype)){const e=r.RTCPeerConnection.prototype.getSenders;r.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach(o=>o._pc=this),n},Object.defineProperty(r.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function VR(r){if(!r.RTCPeerConnection)return;const e=r.RTCPeerConnection.prototype.getStats;r.RTCPeerConnection.prototype.getStats=function(){const[n,o,c]=arguments;if(arguments.length>0&&typeof n=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof n!="function"))return e.apply(this,[]);const u=function(_){const S={};return _.result().forEach(C=>{const R={id:C.id,timestamp:C.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[C.type]||C.type};C.names().forEach(w=>{R[w]=C.stat(w)}),S[R.id]=R}),S},m=function(_){return new Map(Object.keys(_).map(S=>[S,_[S]]))};if(arguments.length>=2){const _=function(S){o(m(u(S)))};return e.apply(this,[_,n])}return new Promise((_,S)=>{e.apply(this,[function(C){_(m(u(C)))},S])}).then(o,c)}}function FR(r){if(!(typeof r=="object"&&r.RTCPeerConnection&&r.RTCRtpSender&&r.RTCRtpReceiver))return;if(!("getStats"in r.RTCRtpSender.prototype)){const n=r.RTCPeerConnection.prototype.getSenders;n&&(r.RTCPeerConnection.prototype.getSenders=function(){const c=n.apply(this,[]);return c.forEach(u=>u._pc=this),c});const o=r.RTCPeerConnection.prototype.addTrack;o&&(r.RTCPeerConnection.prototype.addTrack=function(){const c=o.apply(this,arguments);return c._pc=this,c}),r.RTCRtpSender.prototype.getStats=function(){const c=this;return this._pc.getStats().then(u=>PR(u,c.track,!0))}}if(!("getStats"in r.RTCRtpReceiver.prototype)){const n=r.RTCPeerConnection.prototype.getReceivers;n&&(r.RTCPeerConnection.prototype.getReceivers=function(){const o=n.apply(this,[]);return o.forEach(c=>c._pc=this),o}),tc(r,"track",o=>(o.receiver._pc=o.srcElement,o)),r.RTCRtpReceiver.prototype.getStats=function(){const o=this;return this._pc.getStats().then(c=>PR(c,o.track,!1))}}if(!("getStats"in r.RTCRtpSender.prototype)||!("getStats"in r.RTCRtpReceiver.prototype))return;const e=r.RTCPeerConnection.prototype.getStats;r.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof r.MediaStreamTrack){const n=arguments[0];let o,c,u;return this.getSenders().forEach(m=>{m.track===n&&(o?u=!0:o=m)}),this.getReceivers().forEach(m=>(m.track===n&&(c?u=!0:c=m),m.track===n)),u||o&&c?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):o?o.getStats():c?c.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function jR(r){r.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(u=>this._shimmedLocalStreams[u][0])};const e=r.RTCPeerConnection.prototype.addTrack;r.RTCPeerConnection.prototype.addTrack=function(u,m){if(!m)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const _=e.apply(this,arguments);return this._shimmedLocalStreams[m.id]?this._shimmedLocalStreams[m.id].indexOf(_)===-1&&this._shimmedLocalStreams[m.id].push(_):this._shimmedLocalStreams[m.id]=[m,_],_};const n=r.RTCPeerConnection.prototype.addStream;r.RTCPeerConnection.prototype.addStream=function(u){this._shimmedLocalStreams=this._shimmedLocalStreams||{},u.getTracks().forEach(S=>{if(this.getSenders().find(C=>C.track===S))throw new DOMException("Track already exists.","InvalidAccessError")});const m=this.getSenders();n.apply(this,arguments);const _=this.getSenders().filter(S=>m.indexOf(S)===-1);this._shimmedLocalStreams[u.id]=[u].concat(_)};const o=r.RTCPeerConnection.prototype.removeStream;r.RTCPeerConnection.prototype.removeStream=function(u){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[u.id],o.apply(this,arguments)};const c=r.RTCPeerConnection.prototype.removeTrack;r.RTCPeerConnection.prototype.removeTrack=function(u){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},u&&Object.keys(this._shimmedLocalStreams).forEach(m=>{const _=this._shimmedLocalStreams[m].indexOf(u);_!==-1&&this._shimmedLocalStreams[m].splice(_,1),this._shimmedLocalStreams[m].length===1&&delete this._shimmedLocalStreams[m]}),c.apply(this,arguments)}}function BR(r,e){if(!r.RTCPeerConnection)return;if(r.RTCPeerConnection.prototype.addTrack&&e.version>=65)return jR(r);const n=r.RTCPeerConnection.prototype.getLocalStreams;r.RTCPeerConnection.prototype.getLocalStreams=function(){const S=n.apply(this);return this._reverseStreams=this._reverseStreams||{},S.map(C=>this._reverseStreams[C.id])};const o=r.RTCPeerConnection.prototype.addStream;r.RTCPeerConnection.prototype.addStream=function(S){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},S.getTracks().forEach(C=>{if(this.getSenders().find(R=>R.track===C))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[S.id]){const C=new r.MediaStream(S.getTracks());this._streams[S.id]=C,this._reverseStreams[C.id]=S,S=C}o.apply(this,[S])};const c=r.RTCPeerConnection.prototype.removeStream;function u(S,C){let R=C.sdp;return Object.keys(S._reverseStreams||[]).forEach(w=>{const N=S._reverseStreams[w],L=S._streams[N.id];R=R.replace(new RegExp(L.id,"g"),N.id)}),new RTCSessionDescription({type:C.type,sdp:R})}r.RTCPeerConnection.prototype.removeStream=function(S){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.apply(this,[this._streams[S.id]||S]),delete this._reverseStreams[this._streams[S.id]?this._streams[S.id].id:S.id],delete this._streams[S.id]},r.RTCPeerConnection.prototype.addTrack=function(S,C){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const R=[].slice.call(arguments,1);if(R.length!==1||!R[0].getTracks().find(N=>N===S))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(N=>N.track===S))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const w=this._streams[C.id];if(w)w.addTrack(S),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const N=new r.MediaStream([S]);this._streams[C.id]=N,this._reverseStreams[N.id]=C,this.addStream(N)}return this.getSenders().find(N=>N.track===S)},["createOffer","createAnswer"].forEach(function(S){const C=r.RTCPeerConnection.prototype[S],R={[S](){const w=arguments;return arguments.length&&typeof arguments[0]=="function"?C.apply(this,[N=>{const L=u(this,N);w[0].apply(null,[L])},N=>{w[1]&&w[1].apply(null,N)},arguments[2]]):C.apply(this,arguments).then(N=>u(this,N))}};r.RTCPeerConnection.prototype[S]=R[S]});const m=r.RTCPeerConnection.prototype.setLocalDescription;r.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(S,C){let R=C.sdp;return Object.keys(S._reverseStreams||[]).forEach(w=>{const N=S._reverseStreams[w],L=S._streams[N.id];R=R.replace(new RegExp(N.id,"g"),L.id)}),new RTCSessionDescription({type:C.type,sdp:R})}(this,arguments[0]),m.apply(this,arguments)):m.apply(this,arguments)};const _=Object.getOwnPropertyDescriptor(r.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(r.RTCPeerConnection.prototype,"localDescription",{get(){const S=_.get.apply(this);return S.type===""?S:u(this,S)}}),r.RTCPeerConnection.prototype.removeTrack=function(S){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!S._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(S._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let C;this._streams=this._streams||{},Object.keys(this._streams).forEach(R=>{this._streams[R].getTracks().find(w=>S.track===w)&&(C=this._streams[R])}),C&&(C.getTracks().length===1?this.removeStream(this._reverseStreams[C.id]):C.removeTrack(S.track),this.dispatchEvent(new Event("negotiationneeded")))}}function z_(r,e){!r.RTCPeerConnection&&r.webkitRTCPeerConnection&&(r.RTCPeerConnection=r.webkitRTCPeerConnection),r.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const o=r.RTCPeerConnection.prototype[n],c={[n](){return arguments[0]=new(n==="addIceCandidate"?r.RTCIceCandidate:r.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};r.RTCPeerConnection.prototype[n]=c[n]})}function GR(r,e){tc(r,"negotiationneeded",n=>{const o=n.target;if(!(e.version<72||o.getConfiguration&&o.getConfiguration().sdpSemantics==="plan-b")||o.signalingState==="stable")return n})}var WR=Object.freeze({__proto__:null,fixNegotiationNeeded:GR,shimAddTrackRemoveTrack:BR,shimAddTrackRemoveTrackWithNative:jR,shimGetDisplayMedia:function(r,e){r.navigator.mediaDevices&&"getDisplayMedia"in r.navigator.mediaDevices||r.navigator.mediaDevices&&(typeof e=="function"?r.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then(o=>{const c=n.video&&n.video.width,u=n.video&&n.video.height,m=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:o,maxFrameRate:m||3}},c&&(n.video.mandatory.maxWidth=c),u&&(n.video.mandatory.maxHeight=u),r.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:xR,shimGetStats:VR,shimGetUserMedia:LR,shimMediaStream:MR,shimOnTrack:UR,shimPeerConnection:z_,shimSenderReceiverGetStats:FR});function HR(r,e){const n=r&&r.navigator,o=r&&r.MediaStreamTrack;if(n.getUserMedia=function(c,u,m){K_("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(c).then(u,m)},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const c=function(m,_,S){_ in m&&!(S in m)&&(m[S]=m[_],delete m[_])},u=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(m){return typeof m=="object"&&typeof m.audio=="object"&&(m=JSON.parse(JSON.stringify(m)),c(m.audio,"autoGainControl","mozAutoGainControl"),c(m.audio,"noiseSuppression","mozNoiseSuppression")),u(m)},o&&o.prototype.getSettings){const m=o.prototype.getSettings;o.prototype.getSettings=function(){const _=m.apply(this,arguments);return c(_,"mozAutoGainControl","autoGainControl"),c(_,"mozNoiseSuppression","noiseSuppression"),_}}if(o&&o.prototype.applyConstraints){const m=o.prototype.applyConstraints;o.prototype.applyConstraints=function(_){return this.kind==="audio"&&typeof _=="object"&&(_=JSON.parse(JSON.stringify(_)),c(_,"autoGainControl","mozAutoGainControl"),c(_,"noiseSuppression","mozNoiseSuppression")),m.apply(this,[_])}}}}function KR(r){typeof r=="object"&&r.RTCTrackEvent&&"receiver"in r.RTCTrackEvent.prototype&&!("transceiver"in r.RTCTrackEvent.prototype)&&Object.defineProperty(r.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function q_(r,e){if(typeof r!="object"||!r.RTCPeerConnection&&!r.mozRTCPeerConnection)return;!r.RTCPeerConnection&&r.mozRTCPeerConnection&&(r.RTCPeerConnection=r.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(c){const u=r.RTCPeerConnection.prototype[c],m={[c](){return arguments[0]=new(c==="addIceCandidate"?r.RTCIceCandidate:r.RTCSessionDescription)(arguments[0]),u.apply(this,arguments)}};r.RTCPeerConnection.prototype[c]=m[c]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=r.RTCPeerConnection.prototype.getStats;r.RTCPeerConnection.prototype.getStats=function(){const[c,u,m]=arguments;return o.apply(this,[c||null]).then(_=>{if(e.version<53&&!u)try{_.forEach(S=>{S.type=n[S.type]||S.type})}catch(S){if(S.name!=="TypeError")throw S;_.forEach((C,R)=>{_.set(R,Object.assign({},C,{type:n[C.type]||C.type}))})}return _}).then(u,m)}}function YR(r){if(typeof r!="object"||!r.RTCPeerConnection||!r.RTCRtpSender||r.RTCRtpSender&&"getStats"in r.RTCRtpSender.prototype)return;const e=r.RTCPeerConnection.prototype.getSenders;e&&(r.RTCPeerConnection.prototype.getSenders=function(){const o=e.apply(this,[]);return o.forEach(c=>c._pc=this),o});const n=r.RTCPeerConnection.prototype.addTrack;n&&(r.RTCPeerConnection.prototype.addTrack=function(){const o=n.apply(this,arguments);return o._pc=this,o}),r.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function zR(r){if(typeof r!="object"||!r.RTCPeerConnection||!r.RTCRtpSender||r.RTCRtpSender&&"getStats"in r.RTCRtpReceiver.prototype)return;const e=r.RTCPeerConnection.prototype.getReceivers;e&&(r.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(o=>o._pc=this),n}),tc(r,"track",n=>(n.receiver._pc=n.srcElement,n)),r.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function qR(r){r.RTCPeerConnection&&!("removeStream"in r.RTCPeerConnection.prototype)&&(r.RTCPeerConnection.prototype.removeStream=function(e){K_("removeStream","removeTrack"),this.getSenders().forEach(n=>{n.track&&e.getTracks().includes(n.track)&&this.removeTrack(n)})})}function JR(r){r.DataChannel&&!r.RTCDataChannel&&(r.RTCDataChannel=r.DataChannel)}function XR(r){if(typeof r!="object"||!r.RTCPeerConnection)return;const e=r.RTCPeerConnection.prototype.addTransceiver;e&&(r.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const o=n.length>0;o&&n.forEach(u=>{if("rid"in u&&!/^[a-z0-9]{0,16}$/i.test(u.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in u&&!(parseFloat(u.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in u&&!(parseFloat(u.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const c=e.apply(this,arguments);if(o){const{sender:u}=c,m=u.getParameters();(!("encodings"in m)||m.encodings.length===1&&Object.keys(m.encodings[0]).length===0)&&(m.encodings=n,u.sendEncodings=n,this.setParametersPromises.push(u.setParameters(m).then(()=>{delete u.sendEncodings}).catch(()=>{delete u.sendEncodings})))}return c})}function QR(r){if(typeof r!="object"||!r.RTCRtpSender)return;const e=r.RTCRtpSender.prototype.getParameters;e&&(r.RTCRtpSender.prototype.getParameters=function(){const n=e.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function ZR(r){if(typeof r!="object"||!r.RTCPeerConnection)return;const e=r.RTCPeerConnection.prototype.createOffer;r.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function $R(r){if(typeof r!="object"||!r.RTCPeerConnection)return;const e=r.RTCPeerConnection.prototype.createAnswer;r.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var ey=Object.freeze({__proto__:null,shimAddTransceiver:XR,shimCreateAnswer:$R,shimCreateOffer:ZR,shimGetDisplayMedia:function(r,e){r.navigator.mediaDevices&&"getDisplayMedia"in r.navigator.mediaDevices||r.navigator.mediaDevices&&(r.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const o=new DOMException("getDisplayMedia without video constraints is undefined");return o.name="NotFoundError",o.code=8,Promise.reject(o)}return n.video===!0?n.video={mediaSource:e}:n.video.mediaSource=e,r.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:QR,shimGetUserMedia:HR,shimOnTrack:KR,shimPeerConnection:q_,shimRTCDataChannel:JR,shimReceiverGetStats:zR,shimRemoveStream:qR,shimSenderGetStats:YR});function ty(r){if(typeof r=="object"&&r.RTCPeerConnection){if("getLocalStreams"in r.RTCPeerConnection.prototype||(r.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in r.RTCPeerConnection.prototype)){const e=r.RTCPeerConnection.prototype.addTrack;r.RTCPeerConnection.prototype.addStream=function(n){this._localStreams||(this._localStreams=[]),this._localStreams.includes(n)||this._localStreams.push(n),n.getAudioTracks().forEach(o=>e.call(this,o,n)),n.getVideoTracks().forEach(o=>e.call(this,o,n))},r.RTCPeerConnection.prototype.addTrack=function(n,...o){return o&&o.forEach(c=>{this._localStreams?this._localStreams.includes(c)||this._localStreams.push(c):this._localStreams=[c]}),e.apply(this,arguments)}}"removeStream"in r.RTCPeerConnection.prototype||(r.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(e);if(n===-1)return;this._localStreams.splice(n,1);const o=e.getTracks();this.getSenders().forEach(c=>{o.includes(c.track)&&this.removeTrack(c)})})}}function ny(r){if(typeof r=="object"&&r.RTCPeerConnection&&("getRemoteStreams"in r.RTCPeerConnection.prototype||(r.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in r.RTCPeerConnection.prototype))){Object.defineProperty(r.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=o=>{o.streams.forEach(c=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(c))return;this._remoteStreams.push(c);const u=new Event("addstream");u.stream=c,this.dispatchEvent(u)})})}});const e=r.RTCPeerConnection.prototype.setRemoteDescription;r.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(o){o.streams.forEach(c=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(c)>=0)return;n._remoteStreams.push(c);const u=new Event("addstream");u.stream=c,n.dispatchEvent(u)})}),e.apply(n,arguments)}}}function iy(r){if(typeof r!="object"||!r.RTCPeerConnection)return;const e=r.RTCPeerConnection.prototype,n=e.createOffer,o=e.createAnswer,c=e.setLocalDescription,u=e.setRemoteDescription,m=e.addIceCandidate;e.createOffer=function(S,C){const R=arguments.length>=2?arguments[2]:arguments[0],w=n.apply(this,[R]);return C?(w.then(S,C),Promise.resolve()):w},e.createAnswer=function(S,C){const R=arguments.length>=2?arguments[2]:arguments[0],w=o.apply(this,[R]);return C?(w.then(S,C),Promise.resolve()):w};let _=function(S,C,R){const w=c.apply(this,[S]);return R?(w.then(C,R),Promise.resolve()):w};e.setLocalDescription=_,_=function(S,C,R){const w=u.apply(this,[S]);return R?(w.then(C,R),Promise.resolve()):w},e.setRemoteDescription=_,_=function(S,C,R){const w=m.apply(this,[S]);return R?(w.then(C,R),Promise.resolve()):w},e.addIceCandidate=_}function ry(r){const e=r&&r.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const n=e.mediaDevices,o=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=c=>o(sy(c))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(n,o,c){e.mediaDevices.getUserMedia(n).then(o,c)}).bind(e))}function sy(r){return r&&r.video!==void 0?Object.assign({},r,{video:DR(r.video)}):r}function oy(r){if(!r.RTCPeerConnection)return;const e=r.RTCPeerConnection;r.RTCPeerConnection=function(n,o){if(n&&n.iceServers){const c=[];for(let u=0;u<n.iceServers.length;u++){let m=n.iceServers[u];!m.hasOwnProperty("urls")&&m.hasOwnProperty("url")?(K_("RTCIceServer.url","RTCIceServer.urls"),m=JSON.parse(JSON.stringify(m)),m.urls=m.url,delete m.url,c.push(m)):c.push(n.iceServers[u])}n.iceServers=c}return new e(n,o)},r.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(r.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function ay(r){typeof r=="object"&&r.RTCTrackEvent&&"receiver"in r.RTCTrackEvent.prototype&&!("transceiver"in r.RTCTrackEvent.prototype)&&Object.defineProperty(r.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function cy(r){const e=r.RTCPeerConnection.prototype.createOffer;r.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const o=this.getTransceivers().find(u=>u.receiver.track.kind==="audio");n.offerToReceiveAudio===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):n.offerToReceiveAudio!==!0||o||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const c=this.getTransceivers().find(u=>u.receiver.track.kind==="video");n.offerToReceiveVideo===!1&&c?c.direction==="sendrecv"?c.setDirection?c.setDirection("sendonly"):c.direction="sendonly":c.direction==="recvonly"&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive"):n.offerToReceiveVideo!==!0||c||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function dy(r){typeof r!="object"||r.AudioContext||(r.AudioContext=r.webkitAudioContext)}var ly=Object.freeze({__proto__:null,shimAudioContext:dy,shimCallbacksAPI:iy,shimConstraints:sy,shimCreateOfferLegacy:cy,shimGetUserMedia:ry,shimLocalStreamsAPI:ty,shimRTCIceServerUrls:oy,shimRemoteStreamsAPI:ny,shimTrackEventTransceiver:ay}),uy={exports:{}};(function(r){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split(`
`).map(o=>o.trim())},e.splitSections=function(n){return n.split(`
m=`).map((o,c)=>(c>0?"m="+o:o).trim()+`\r
`)},e.getDescription=function(n){const o=e.splitSections(n);return o&&o[0]},e.getMediaSections=function(n){const o=e.splitSections(n);return o.shift(),o},e.matchPrefix=function(n,o){return e.splitLines(n).filter(c=>c.indexOf(o)===0)},e.parseCandidate=function(n){let o;o=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");const c={foundation:o[0],component:{1:"rtp",2:"rtcp"}[o[1]]||o[1],protocol:o[2].toLowerCase(),priority:parseInt(o[3],10),ip:o[4],address:o[4],port:parseInt(o[5],10),type:o[7]};for(let u=8;u<o.length;u+=2)switch(o[u]){case"raddr":c.relatedAddress=o[u+1];break;case"rport":c.relatedPort=parseInt(o[u+1],10);break;case"tcptype":c.tcpType=o[u+1];break;case"ufrag":c.ufrag=o[u+1],c.usernameFragment=o[u+1];break;default:c[o[u]]===void 0&&(c[o[u]]=o[u+1])}return c},e.writeCandidate=function(n){const o=[];o.push(n.foundation);const c=n.component;c==="rtp"?o.push(1):c==="rtcp"?o.push(2):o.push(c),o.push(n.protocol.toUpperCase()),o.push(n.priority),o.push(n.address||n.ip),o.push(n.port);const u=n.type;return o.push("typ"),o.push(u),u!=="host"&&n.relatedAddress&&n.relatedPort&&(o.push("raddr"),o.push(n.relatedAddress),o.push("rport"),o.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(o.push("tcptype"),o.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(o.push("ufrag"),o.push(n.usernameFragment||n.ufrag)),"candidate:"+o.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let o=n.substring(9).split(" ");const c={payloadType:parseInt(o.shift(),10)};return o=o[0].split("/"),c.name=o[0],c.clockRate=parseInt(o[1],10),c.channels=o.length===3?parseInt(o[2],10):1,c.numChannels=c.channels,c},e.writeRtpMap=function(n){let o=n.payloadType;n.preferredPayloadType!==void 0&&(o=n.preferredPayloadType);const c=n.channels||n.numChannels||1;return"a=rtpmap:"+o+" "+n.name+"/"+n.clockRate+(c!==1?"/"+c:"")+`\r
`},e.parseExtmap=function(n){const o=n.substring(9).split(" ");return{id:parseInt(o[0],10),direction:o[0].indexOf("/")>0?o[0].split("/")[1]:"sendrecv",uri:o[1],attributes:o.slice(2).join(" ")}},e.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},e.parseFmtp=function(n){const o={};let c;const u=n.substring(n.indexOf(" ")+1).split(";");for(let m=0;m<u.length;m++)c=u[m].trim().split("="),o[c[0].trim()]=c[1];return o},e.writeFmtp=function(n){let o="",c=n.payloadType;if(n.preferredPayloadType!==void 0&&(c=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const u=[];Object.keys(n.parameters).forEach(m=>{n.parameters[m]!==void 0?u.push(m+"="+n.parameters[m]):u.push(m)}),o+="a=fmtp:"+c+" "+u.join(";")+`\r
`}return o},e.parseRtcpFb=function(n){const o=n.substring(n.indexOf(" ")+1).split(" ");return{type:o.shift(),parameter:o.join(" ")}},e.writeRtcpFb=function(n){let o="",c=n.payloadType;return n.preferredPayloadType!==void 0&&(c=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(u=>{o+="a=rtcp-fb:"+c+" "+u.type+(u.parameter&&u.parameter.length?" "+u.parameter:"")+`\r
`}),o},e.parseSsrcMedia=function(n){const o=n.indexOf(" "),c={ssrc:parseInt(n.substring(7,o),10)},u=n.indexOf(":",o);return u>-1?(c.attribute=n.substring(o+1,u),c.value=n.substring(u+1)):c.attribute=n.substring(o+1),c},e.parseSsrcGroup=function(n){const o=n.substring(13).split(" ");return{semantics:o.shift(),ssrcs:o.map(c=>parseInt(c,10))}},e.getMid=function(n){const o=e.matchPrefix(n,"a=mid:")[0];if(o)return o.substring(6)},e.parseFingerprint=function(n){const o=n.substring(14).split(" ");return{algorithm:o[0].toLowerCase(),value:o[1].toUpperCase()}},e.getDtlsParameters=function(n,o){return{role:"auto",fingerprints:e.matchPrefix(n+o,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,o){let c="a=setup:"+o+`\r
`;return n.fingerprints.forEach(u=>{c+="a=fingerprint:"+u.algorithm+" "+u.value+`\r
`}),c},e.parseCryptoLine=function(n){const o=n.substring(9).split(" ");return{tag:parseInt(o[0],10),cryptoSuite:o[1],keyParams:o[2],sessionParams:o.slice(3)}},e.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const o=n.substring(7).split("|");return{keyMethod:"inline",keySalt:o[0],lifeTime:o[1],mkiValue:o[2]?o[2].split(":")[0]:void 0,mkiLength:o[2]?o[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,o){return e.matchPrefix(n+o,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,o){const c=e.matchPrefix(n+o,"a=ice-ufrag:")[0],u=e.matchPrefix(n+o,"a=ice-pwd:")[0];return c&&u?{usernameFragment:c.substring(12),password:u.substring(10)}:null},e.writeIceParameters=function(n){let o="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(o+=`a=ice-lite\r
`),o},e.parseRtpParameters=function(n){const o={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=e.splitLines(n)[0].split(" ");o.profile=c[2];for(let m=3;m<c.length;m++){const _=c[m],S=e.matchPrefix(n,"a=rtpmap:"+_+" ")[0];if(S){const C=e.parseRtpMap(S),R=e.matchPrefix(n,"a=fmtp:"+_+" ");switch(C.parameters=R.length?e.parseFmtp(R[0]):{},C.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+_+" ").map(e.parseRtcpFb),o.codecs.push(C),C.name.toUpperCase()){case"RED":case"ULPFEC":o.fecMechanisms.push(C.name.toUpperCase())}}}e.matchPrefix(n,"a=extmap:").forEach(m=>{o.headerExtensions.push(e.parseExtmap(m))});const u=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return o.codecs.forEach(m=>{u.forEach(_=>{m.rtcpFeedback.find(S=>S.type===_.type&&S.parameter===_.parameter)||m.rtcpFeedback.push(_)})}),o},e.writeRtpDescription=function(n,o){let c="";c+="m="+n+" ",c+=o.codecs.length>0?"9":"0",c+=" "+(o.profile||"UDP/TLS/RTP/SAVPF")+" ",c+=o.codecs.map(m=>m.preferredPayloadType!==void 0?m.preferredPayloadType:m.payloadType).join(" ")+`\r
`,c+=`c=IN IP4 0.0.0.0\r
`,c+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,o.codecs.forEach(m=>{c+=e.writeRtpMap(m),c+=e.writeFmtp(m),c+=e.writeRtcpFb(m)});let u=0;return o.codecs.forEach(m=>{m.maxptime>u&&(u=m.maxptime)}),u>0&&(c+="a=maxptime:"+u+`\r
`),o.headerExtensions&&o.headerExtensions.forEach(m=>{c+=e.writeExtmap(m)}),c},e.parseRtpEncodingParameters=function(n){const o=[],c=e.parseRtpParameters(n),u=c.fecMechanisms.indexOf("RED")!==-1,m=c.fecMechanisms.indexOf("ULPFEC")!==-1,_=e.matchPrefix(n,"a=ssrc:").map(N=>e.parseSsrcMedia(N)).filter(N=>N.attribute==="cname"),S=_.length>0&&_[0].ssrc;let C;const R=e.matchPrefix(n,"a=ssrc-group:FID").map(N=>N.substring(17).split(" ").map(L=>parseInt(L,10)));R.length>0&&R[0].length>1&&R[0][0]===S&&(C=R[0][1]),c.codecs.forEach(N=>{if(N.name.toUpperCase()==="RTX"&&N.parameters.apt){let L={ssrc:S,codecPayloadType:parseInt(N.parameters.apt,10)};S&&C&&(L.rtx={ssrc:C}),o.push(L),u&&(L=JSON.parse(JSON.stringify(L)),L.fec={ssrc:S,mechanism:m?"red+ulpfec":"red"},o.push(L))}}),o.length===0&&S&&o.push({ssrc:S});let w=e.matchPrefix(n,"b=");return w.length&&(w=w[0].indexOf("b=TIAS:")===0?parseInt(w[0].substring(7),10):w[0].indexOf("b=AS:")===0?1e3*parseInt(w[0].substring(5),10)*.95-16e3:void 0,o.forEach(N=>{N.maxBitrate=w})),o},e.parseRtcpParameters=function(n){const o={},c=e.matchPrefix(n,"a=ssrc:").map(_=>e.parseSsrcMedia(_)).filter(_=>_.attribute==="cname")[0];c&&(o.cname=c.value,o.ssrc=c.ssrc);const u=e.matchPrefix(n,"a=rtcp-rsize");o.reducedSize=u.length>0,o.compound=u.length===0;const m=e.matchPrefix(n,"a=rtcp-mux");return o.mux=m.length>0,o},e.writeRtcpParameters=function(n){let o="";return n.reducedSize&&(o+=`a=rtcp-rsize\r
`),n.mux&&(o+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(o+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),o},e.parseMsid=function(n){let o;const c=e.matchPrefix(n,"a=msid:");if(c.length===1)return o=c[0].substring(7).split(" "),{stream:o[0],track:o[1]};const u=e.matchPrefix(n,"a=ssrc:").map(m=>e.parseSsrcMedia(m)).filter(m=>m.attribute==="msid");return u.length>0?(o=u[0].value.split(" "),{stream:o[0],track:o[1]}):void 0},e.parseSctpDescription=function(n){const o=e.parseMLine(n),c=e.matchPrefix(n,"a=max-message-size:");let u;c.length>0&&(u=parseInt(c[0].substring(19),10)),isNaN(u)&&(u=65536);const m=e.matchPrefix(n,"a=sctp-port:");if(m.length>0)return{port:parseInt(m[0].substring(12),10),protocol:o.fmt,maxMessageSize:u};const _=e.matchPrefix(n,"a=sctpmap:");if(_.length>0){const S=_[0].substring(10).split(" ");return{port:parseInt(S[0],10),protocol:S[1],maxMessageSize:u}}},e.writeSctpDescription=function(n,o){let c=[];return c=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+o.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+o.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+o.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+o.port+" "+o.protocol+` 65535\r
`],o.maxMessageSize!==void 0&&c.push("a=max-message-size:"+o.maxMessageSize+`\r
`),c.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,o,c){let u;const m=o!==void 0?o:2;return u=n||e.generateSessionId(),`v=0\r
o=`+(c||"thisisadapterortc")+" "+u+" "+m+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(n,o){const c=e.splitLines(n);for(let u=0;u<c.length;u++)switch(c[u]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[u].substring(2)}return o?e.getDirection(o):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return n.split(" ",2)[1]==="0"},e.parseMLine=function(n){const o=e.splitLines(n)[0].substring(2).split(" ");return{kind:o[0],port:parseInt(o[1],10),protocol:o[2],fmt:o.slice(3).join(" ")}},e.parseOLine=function(n){const o=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:o[0],sessionId:o[1],sessionVersion:parseInt(o[2],10),netType:o[3],addressType:o[4],address:o[5]}},e.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const o=e.splitLines(n);for(let c=0;c<o.length;c++)if(o[c].length<2||o[c].charAt(1)!=="=")return!1;return!0},r.exports=e})(uy);var hy=uy.exports,Sd=A(hy),tx=E({__proto__:null,default:Sd},[hy]);function $h(r){if(!r.RTCIceCandidate||r.RTCIceCandidate&&"foundation"in r.RTCIceCandidate.prototype)return;const e=r.RTCIceCandidate;r.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const o=new e(n),c=Sd.parseCandidate(n.candidate),u=Object.assign(o,c);return u.toJSON=function(){return{candidate:u.candidate,sdpMid:u.sdpMid,sdpMLineIndex:u.sdpMLineIndex,usernameFragment:u.usernameFragment}},u}return new e(n)},r.RTCIceCandidate.prototype=e.prototype,tc(r,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new r.RTCIceCandidate(n.candidate),writable:"false"}),n))}function J_(r){!r.RTCIceCandidate||r.RTCIceCandidate&&"relayProtocol"in r.RTCIceCandidate.prototype||tc(r,"icecandidate",e=>{if(e.candidate){const n=Sd.parseCandidate(e.candidate.candidate);n.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return e})}function ep(r,e){if(!r.RTCPeerConnection)return;"sctp"in r.RTCPeerConnection.prototype||Object.defineProperty(r.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const n=function(_){if(!_||!_.sdp)return!1;const S=Sd.splitSections(_.sdp);return S.shift(),S.some(C=>{const R=Sd.parseMLine(C);return R&&R.kind==="application"&&R.protocol.indexOf("SCTP")!==-1})},o=function(_){const S=_.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(S===null||S.length<2)return-1;const C=parseInt(S[1],10);return C!=C?-1:C},c=function(_){let S=65536;return e.browser==="firefox"&&(S=e.version<57?_===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),S},u=function(_,S){let C=65536;e.browser==="firefox"&&e.version===57&&(C=65535);const R=Sd.matchPrefix(_.sdp,"a=max-message-size:");return R.length>0?C=parseInt(R[0].substr(19),10):e.browser==="firefox"&&S!==-1&&(C=2147483637),C},m=r.RTCPeerConnection.prototype.setRemoteDescription;r.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:_}=this.getConfiguration();_==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const _=o(arguments[0]),S=c(_),C=u(arguments[0],_);let R;R=S===0&&C===0?Number.POSITIVE_INFINITY:S===0||C===0?Math.max(S,C):Math.min(S,C);const w={};Object.defineProperty(w,"maxMessageSize",{get:()=>R}),this._sctp=w}return m.apply(this,arguments)}}function tp(r){if(!r.RTCPeerConnection||!("createDataChannel"in r.RTCPeerConnection.prototype))return;function e(o,c){const u=o.send;o.send=function(){const m=arguments[0],_=m.length||m.size||m.byteLength;if(o.readyState==="open"&&c.sctp&&_>c.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+c.sctp.maxMessageSize+" bytes)");return u.apply(o,arguments)}}const n=r.RTCPeerConnection.prototype.createDataChannel;r.RTCPeerConnection.prototype.createDataChannel=function(){const o=n.apply(this,arguments);return e(o,this),o},tc(r,"datachannel",o=>(e(o.channel,o.target),o))}function X_(r){if(!r.RTCPeerConnection||"connectionState"in r.RTCPeerConnection.prototype)return;const e=r.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{const o=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=c=>{const u=c.target;if(u._lastConnectionState!==u.connectionState){u._lastConnectionState=u.connectionState;const m=new Event("connectionstatechange",c);u.dispatchEvent(m)}return c},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),o.apply(this,arguments)}})}function Q_(r,e){if(!r.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const n=r.RTCPeerConnection.prototype.setRemoteDescription;r.RTCPeerConnection.prototype.setRemoteDescription=function(o){if(o&&o.sdp&&o.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const c=o.sdp.split(`
`).filter(u=>u.trim()!=="a=extmap-allow-mixed").join(`
`);r.RTCSessionDescription&&o instanceof r.RTCSessionDescription?arguments[0]=new r.RTCSessionDescription({type:o.type,sdp:c}):o.sdp=c}return n.apply(this,arguments)}}function np(r,e){if(!r.RTCPeerConnection||!r.RTCPeerConnection.prototype)return;const n=r.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(r.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function ip(r,e){if(!r.RTCPeerConnection||!r.RTCPeerConnection.prototype)return;const n=r.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(r.RTCPeerConnection.prototype.setLocalDescription=function(){let o=arguments[0]||{};if(typeof o!="object"||o.type&&o.sdp)return n.apply(this,arguments);if(o={type:o.type,sdp:o.sdp},!o.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":o.type="offer";break;default:o.type="answer"}return o.sdp||o.type!=="offer"&&o.type!=="answer"?n.apply(this,[o]):(o.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(c=>n.apply(this,[c]))})}var nx=Object.freeze({__proto__:null,removeExtmapAllowMixed:Q_,shimAddIceCandidateNullOrEmpty:np,shimConnectionState:X_,shimMaxMessageSize:ep,shimParameterlessSetLocalDescription:ip,shimRTCIceCandidate:$h,shimRTCIceCandidateRelayProtocol:J_,shimSendThrowTypeError:tp});(function({window:r}={},e={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const n=OR,o=function(u){const m={browser:null,version:null};if(u===void 0||!u.navigator)return m.browser="Not a browser.",m;const{navigator:_}=u;if(_.mozGetUserMedia)m.browser="firefox",m.version=Zh(_.userAgent,/Firefox\/(\d+)\./,1);else if(_.webkitGetUserMedia||u.isSecureContext===!1&&u.webkitRTCPeerConnection)m.browser="chrome",m.version=Zh(_.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!u.RTCPeerConnection||!_.userAgent.match(/AppleWebKit\/(\d+)\./))return m.browser="Not a supported browser.",m;m.browser="safari",m.version=Zh(_.userAgent,/AppleWebKit\/(\d+)\./,1),m.supportsUnifiedPlan=u.RTCRtpTransceiver&&"currentDirection"in u.RTCRtpTransceiver.prototype}return m}(r),c={browserDetails:o,commonShim:nx,extractVersion:Zh,disableLog:$U,disableWarnings:ex,sdp:tx};switch(o.browser){case"chrome":if(!WR||!z_||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),c;if(o.version===null)return n("Chrome shim can not determine version, not shimming."),c;n("adapter.js shimming chrome."),c.browserShim=WR,np(r,o),ip(r),LR(r,o),MR(r),z_(r,o),UR(r),BR(r,o),xR(r),VR(r),FR(r),GR(r,o),$h(r),J_(r),X_(r),ep(r,o),tp(r),Q_(r,o);break;case"firefox":if(!ey||!q_||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),c;n("adapter.js shimming firefox."),c.browserShim=ey,np(r,o),ip(r),HR(r,o),q_(r,o),KR(r),qR(r),YR(r),zR(r),JR(r),XR(r),QR(r),ZR(r),$R(r),$h(r),X_(r),ep(r,o),tp(r);break;case"safari":if(!ly||!e.shimSafari)return n("Safari shim is not included in this adapter release."),c;n("adapter.js shimming safari."),c.browserShim=ly,np(r,o),ip(r),oy(r),cy(r),iy(r),ty(r),ny(r),ay(r),ry(r),dy(r),$h(r),J_(r),ep(r,o),tp(r),Q_(r,o);break;default:n("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var py={exports:{}},ix=Xt,rx=ii,my=ds.f;ix({target:"Object",stat:!0,forced:Object.defineProperty!==my,sham:!rx},{defineProperty:my});var fy=po.Object,sx=py.exports=function(r,e,n){return fy.defineProperty(r,e,n)};fy.defineProperty.sham&&(sx.sham=!0);var ox=A(py.exports),ax=dt,Z_=Array.isArray||function(r){return ax(r)=="Array"},cx=TypeError,dx=qh,lx=ds,ux=sr,HS=function(r,e,n){var o=dx(e);o in r?lx.f(r,o,ux(0,n)):r[o]=n},hx=Ft,$_=D_,px=ae(Function.toString);hx($_.inspectSource)||($_.inspectSource=function(r){return px(r)});var _y=$_.inspectSource,mx=ae,fx=O,Ey=Ft,_x=Pa,Ex=_y,gy=function(){},gx=[],Sy=hr("Reflect","construct"),eE=/^\s*(?:class|function)\b/,Sx=mx(eE.exec),Tx=!eE.exec(gy),Fl=function(r){if(!Ey(r))return!1;try{return Sy(gy,gx,r),!0}catch{return!1}},Ty=function(r){if(!Ey(r))return!1;switch(_x(r)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Tx||!!Sx(eE,Ex(r))}catch{return!0}};Ty.sham=!0;var KS=!Sy||fx(function(){var r;return Fl(Fl.call)||!Fl(Object)||!Fl(function(){r=!0})||r})?Ty:Fl,Cy=Z_,Cx=KS,vx=qr,Rx=wn("species"),vy=Array,yx=function(r){var e;return Cy(r)&&(e=r.constructor,(Cx(e)&&(e===vy||Cy(e.prototype))||vx(e)&&(e=e[Rx])===null)&&(e=void 0)),e===void 0?vy:e},Ry=function(r,e){return new(yx(r))(e===0?0:e)},Ix=O,Ax=ec,wx=wn("species"),bx=Xt,Ox=O,Nx=Z_,Dx=qr,Px=Oo,kx=Da,yy=function(r){if(r>9007199254740991)throw cx("Maximum allowed index exceeded");return r},Iy=HS,Lx=Ry,Mx=function(r){return Ax>=51||!Ix(function(){var e=[];return(e.constructor={})[wx]=function(){return{foo:1}},e[r](Boolean).foo!==1})},Ux=ec,Ay=wn("isConcatSpreadable"),xx=Ux>=51||!Ox(function(){var r=[];return r[Ay]=!1,r.concat()[0]!==r}),Vx=function(r){if(!Dx(r))return!1;var e=r[Ay];return e!==void 0?!!e:Nx(r)};bx({target:"Array",proto:!0,arity:1,forced:!xx||!Mx("concat")},{concat:function(r){var e,n,o,c,u,m=Px(this),_=Lx(m,0),S=0;for(e=-1,o=arguments.length;e<o;e++)if(Vx(u=e===-1?m:arguments[e]))for(c=kx(u),yy(S+c),n=0;n<c;n++,S++)n in u&&Iy(_,S,u[n]);else yy(S+1),Iy(_,S++,u);return _.length=S,_}});var tE={},rp={},nE=ji,Fx=Za,jx=B_.indexOf,Bx=rp,wy=ae([].push),by=function(r,e){var n,o=Fx(r),c=0,u=[];for(n in o)!nE(Bx,n)&&nE(o,n)&&wy(u,n);for(;e.length>c;)nE(o,n=e[c++])&&(~jx(u,n)||wy(u,n));return u},iE=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Gx=by,Wx=iE,km=Object.keys||function(r){return Gx(r,Wx)},Hx=ii,Kx=SR,Yx=ds,zx=ls,qx=Za,Jx=km;tE.f=Hx&&!Kx?Object.defineProperties:function(r,e){zx(r);for(var n,o=qx(e),c=Jx(e),u=c.length,m=0;u>m;)Yx.f(r,n=c[m++],o[n]);return r};var sp,Oy=hr("document","documentElement"),Xx=P_,Ny=fd("keys"),op=function(r){return Ny[r]||(Ny[r]=Xx(r))},Qx=ls,Zx=tE,Dy=iE,$x=rp,e2=Oy,t2=M_,rE="prototype",sE="script",Py=op("IE_PROTO"),oE=function(){},ky=function(r){return"<"+sE+">"+r+"</"+sE+">"},Ly=function(r){r.write(ky("")),r.close();var e=r.parentWindow.Object;return r=null,e},ap=function(){try{sp=new ActiveXObject("htmlfile")}catch{}var r,e,n;ap=typeof document<"u"?document.domain&&sp?Ly(sp):(e=t2("iframe"),n="java"+sE+":",e.style.display="none",e2.appendChild(e),e.src=String(n),(r=e.contentWindow.document).open(),r.write(ky("document.F=Object")),r.close(),r.F):Ly(sp);for(var o=Dy.length;o--;)delete ap[rE][Dy[o]];return ap()};$x[Py]=!0;var Yu=Object.create||function(r,e){var n;return r!==null?(oE[rE]=Qx(r),n=new oE,oE[rE]=null,n[Py]=r):n=ap(),e===void 0?n:Zx.f(n,e)},cp={},n2=by,i2=iE.concat("length","prototype");cp.f=Object.getOwnPropertyNames||function(r){return n2(r,i2)};var My={},Uy=vR,r2=Da,s2=HS,o2=Array,a2=Math.max,YS=function(r,e,n){for(var o=r2(r),c=Uy(e,o),u=Uy(n===void 0?o:n,o),m=o2(a2(u-c,0)),_=0;c<u;c++,_++)s2(m,_,r[c]);return m.length=_,m},c2=dt,d2=Za,xy=cp.f,l2=YS,Vy=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];My.f=function(r){return Vy&&c2(r)=="Window"?function(e){try{return xy(e)}catch{return l2(Vy)}}(r):xy(d2(r))};var zu={};zu.f=Object.getOwnPropertySymbols;var u2=ra,Vc=function(r,e,n,o){return o&&o.enumerable?r[e]=n:u2(r,e,n),r},h2=ds,aE=function(r,e,n){return h2.f(r,e,n)},Td={},p2=wn;Td.f=p2;var dp,jl,lp,Fy=po,m2=ji,f2=Td,_2=ds.f,qn=function(r){var e=Fy.Symbol||(Fy.Symbol={});m2(e,r)||_2(e,r,{value:f2.f(r)})},E2=Nt,g2=hr,S2=wn,T2=Vc,jy=function(){var r=g2("Symbol"),e=r&&r.prototype,n=e&&e.valueOf,o=S2("toPrimitive");e&&!e[o]&&T2(e,o,function(c){return E2(n,this)},{arity:1})},C2=Pa,v2=G_?{}.toString:function(){return"[object "+C2(this)+"]"},R2=G_,y2=ds.f,I2=ra,A2=ji,w2=v2,By=wn("toStringTag"),nc=function(r,e,n,o){if(r){var c=n?r:r.prototype;A2(c,By)||y2(c,By,{configurable:!0,value:e}),o&&!R2&&I2(c,"toString",w2)}},b2=Ft,Gy=Fe.WeakMap,O2=b2(Gy)&&/native code/.test(String(Gy)),Wy=Fe,N2=qr,D2=ra,cE=ji,dE=D_,P2=op,k2=rp,Hy="Object already initialized",lE=Wy.TypeError,L2=Wy.WeakMap;if(O2||dE.state){var eo=dE.state||(dE.state=new L2);eo.get=eo.get,eo.has=eo.has,eo.set=eo.set,dp=function(r,e){if(eo.has(r))throw lE(Hy);return e.facade=r,eo.set(r,e),e},jl=function(r){return eo.get(r)||{}},lp=function(r){return eo.has(r)}}else{var Cd=P2("state");k2[Cd]=!0,dp=function(r,e){if(cE(r,Cd))throw lE(Hy);return e.facade=r,D2(r,Cd,e),e},jl=function(r){return cE(r,Cd)?r[Cd]:{}},lp=function(r){return cE(r,Cd)}}var Bl={set:dp,get:jl,has:lp,enforce:function(r){return lp(r)?jl(r):dp(r,{})},getterFor:function(r){return function(e){var n;if(!N2(e)||(n=jl(e)).type!==r)throw lE("Incompatible receiver, "+r+" required");return n}}},M2=xc,U2=Pm,x2=Oo,V2=Da,F2=Ry,Ky=ae([].push),oa=function(r){var e=r==1,n=r==2,o=r==3,c=r==4,u=r==6,m=r==7,_=r==5||u;return function(S,C,R,w){for(var N,L,H=x2(S),j=U2(H),W=M2(C,R),ee=V2(j),re=0,fe=w||F2,be=e?fe(S,ee):n||m?fe(S,0):void 0;ee>re;re++)if((_||re in j)&&(L=W(N=j[re],re,H),r))if(e)be[re]=L;else if(L)switch(r){case 3:return!0;case 5:return N;case 6:return re;case 2:Ky(be,N)}else switch(r){case 4:return!1;case 7:Ky(be,N)}return u?-1:o||c?c:be}},j2={forEach:oa(0),map:oa(1),filter:oa(2),some:oa(3),every:oa(4),find:oa(5),findIndex:oa(6),filterReject:oa(7)},up=Xt,uE=Fe,hE=Nt,B2=ae,vd=ii,Rd=pd,G2=O,Ii=ji,W2=ge,pE=ls,hp=Za,mE=qh,H2=Bs,fE=sr,Gl=Yu,Yy=km,K2=cp,zy=My,Y2=zu,qy=as,Jy=ds,z2=tE,Xy=cn,Qy=Vc,q2=aE,_E=fd,Zy=rp,$y=P_,J2=wn,X2=Td,Q2=qn,Z2=jy,$2=nc,eI=Bl,pp=j2.forEach,Tr=op("hidden"),mp="Symbol",Wl="prototype",eV=eI.set,tI=eI.getterFor(mp),Ns=Object[Wl],ic=uE.Symbol,fp=ic&&ic[Wl],tV=uE.TypeError,EE=uE.QObject,nI=qy.f,rc=Jy.f,iI=zy.f,nV=Xy.f,rI=B2([].push),No=_E("symbols"),Hl=_E("op-symbols"),iV=_E("wks"),gE=!EE||!EE[Wl]||!EE[Wl].findChild,SE=vd&&G2(function(){return Gl(rc({},"a",{get:function(){return rc(this,"a",{value:7}).a}})).a!=7})?function(r,e,n){var o=nI(Ns,e);o&&delete Ns[e],rc(r,e,n),o&&r!==Ns&&rc(Ns,e,o)}:rc,TE=function(r,e){var n=No[r]=Gl(fp);return eV(n,{type:mp,tag:r,description:e}),vd||(n.description=e),n},_p=function(r,e,n){r===Ns&&_p(Hl,e,n),pE(r);var o=mE(e);return pE(n),Ii(No,o)?(n.enumerable?(Ii(r,Tr)&&r[Tr][o]&&(r[Tr][o]=!1),n=Gl(n,{enumerable:fE(0,!1)})):(Ii(r,Tr)||rc(r,Tr,fE(1,{})),r[Tr][o]=!0),SE(r,o,n)):rc(r,o,n)},CE=function(r,e){pE(r);var n=hp(e),o=Yy(n).concat(cI(n));return pp(o,function(c){vd&&!hE(sI,n,c)||_p(r,c,n[c])}),r},sI=function(r){var e=mE(r),n=hE(nV,this,e);return!(this===Ns&&Ii(No,e)&&!Ii(Hl,e))&&(!(n||!Ii(this,e)||!Ii(No,e)||Ii(this,Tr)&&this[Tr][e])||n)},oI=function(r,e){var n=hp(r),o=mE(e);if(n!==Ns||!Ii(No,o)||Ii(Hl,o)){var c=nI(n,o);return!c||!Ii(No,o)||Ii(n,Tr)&&n[Tr][o]||(c.enumerable=!0),c}},aI=function(r){var e=iI(hp(r)),n=[];return pp(e,function(o){Ii(No,o)||Ii(Zy,o)||rI(n,o)}),n},cI=function(r){var e=r===Ns,n=iI(e?Hl:hp(r)),o=[];return pp(n,function(c){!Ii(No,c)||e&&!Ii(Ns,c)||rI(o,No[c])}),o};Rd||(ic=function(){if(W2(fp,this))throw tV("Symbol is not a constructor");var r=arguments.length&&arguments[0]!==void 0?H2(arguments[0]):void 0,e=$y(r),n=function(o){this===Ns&&hE(n,Hl,o),Ii(this,Tr)&&Ii(this[Tr],e)&&(this[Tr][e]=!1),SE(this,e,fE(1,o))};return vd&&gE&&SE(Ns,e,{configurable:!0,set:n}),TE(e,r)},Qy(fp=ic[Wl],"toString",function(){return tI(this).tag}),Qy(ic,"withoutSetter",function(r){return TE($y(r),r)}),Xy.f=sI,Jy.f=_p,z2.f=CE,qy.f=oI,K2.f=zy.f=aI,Y2.f=cI,X2.f=function(r){return TE(J2(r),r)},vd&&q2(fp,"description",{configurable:!0,get:function(){return tI(this).description}})),up({global:!0,constructor:!0,wrap:!0,forced:!Rd,sham:!Rd},{Symbol:ic}),pp(Yy(iV),function(r){Q2(r)}),up({target:mp,stat:!0,forced:!Rd},{useSetter:function(){gE=!0},useSimple:function(){gE=!1}}),up({target:"Object",stat:!0,forced:!Rd,sham:!vd},{create:function(r,e){return e===void 0?Gl(r):CE(Gl(r),e)},defineProperty:_p,defineProperties:CE,getOwnPropertyDescriptor:oI}),up({target:"Object",stat:!0,forced:!Rd},{getOwnPropertyNames:aI}),Z2(),$2(ic,mp),Zy[Tr]=!0;var dI=pd&&!!Symbol.for&&!!Symbol.keyFor,rV=Xt,sV=hr,oV=ji,aV=Bs,lI=fd,cV=dI,vE=lI("string-to-symbol-registry"),dV=lI("symbol-to-string-registry");rV({target:"Symbol",stat:!0,forced:!cV},{for:function(r){var e=aV(r);if(oV(vE,e))return vE[e];var n=sV("Symbol")(e);return vE[e]=n,dV[n]=e,n}});var lV=Xt,uV=ji,hV=xl,pV=md,mV=dI,uI=fd("symbol-to-string-registry");lV({target:"Symbol",stat:!0,forced:!mV},{keyFor:function(r){if(!hV(r))throw TypeError(pV(r)+" is not a symbol");if(uV(uI,r))return uI[r]}});var hI=ae([].slice),pI=Z_,fV=Ft,mI=dt,_V=Bs,fI=ae([].push),EV=Xt,_I=hr,EI=ve,gV=Nt,Kl=ae,gI=O,SI=Ft,TI=xl,CI=hI,SV=function(r){if(fV(r))return r;if(pI(r)){for(var e=r.length,n=[],o=0;o<e;o++){var c=r[o];typeof c=="string"?fI(n,c):typeof c!="number"&&mI(c)!="Number"&&mI(c)!="String"||fI(n,_V(c))}var u=n.length,m=!0;return function(_,S){if(m)return m=!1,S;if(pI(this))return S;for(var C=0;C<u;C++)if(n[C]===_)return S}}},TV=pd,CV=String,aa=_I("JSON","stringify"),Ep=Kl(/./.exec),vI=Kl("".charAt),vV=Kl("".charCodeAt),RV=Kl("".replace),yV=Kl(1 .toString),IV=/[\uD800-\uDFFF]/g,RI=/^[\uD800-\uDBFF]$/,yI=/^[\uDC00-\uDFFF]$/,II=!TV||gI(function(){var r=_I("Symbol")();return aa([r])!="[null]"||aa({a:r})!="{}"||aa(Object(r))!="{}"}),AI=gI(function(){return aa("\uDF06\uD834")!=='"\\udf06\\ud834"'||aa("\uDEAD")!=='"\\udead"'}),AV=function(r,e){var n=CI(arguments),o=SV(e);if(SI(o)||r!==void 0&&!TI(r))return n[1]=function(c,u){if(SI(o)&&(u=gV(o,this,CV(c),u)),!TI(u))return u},EI(aa,null,n)},wV=function(r,e,n){var o=vI(n,e-1),c=vI(n,e+1);return Ep(RI,r)&&!Ep(yI,c)||Ep(yI,r)&&!Ep(RI,o)?"\\u"+yV(vV(r,0),16):r};aa&&EV({target:"JSON",stat:!0,arity:3,forced:II||AI},{stringify:function(r,e,n){var o=CI(arguments),c=EI(II?AV:aa,null,o);return AI&&typeof c=="string"?RV(c,IV,wV):c}});var wI=zu,bV=Oo;Xt({target:"Object",stat:!0,forced:!pd||O(function(){wI.f(1)})},{getOwnPropertySymbols:function(r){var e=wI.f;return e?e(bV(r)):[]}}),qn("asyncIterator"),qn("hasInstance"),qn("isConcatSpreadable"),qn("iterator"),qn("match"),qn("matchAll"),qn("replace"),qn("search"),qn("species"),qn("split");var OV=jy;qn("toPrimitive"),OV();var NV=hr,DV=nc;qn("toStringTag"),DV(NV("Symbol"),"Symbol"),qn("unscopables"),nc(Fe.JSON,"JSON",!0);var sc,bI,OI,PV=po.Symbol,yd={},RE=ii,kV=ji,NI=Function.prototype,LV=RE&&Object.getOwnPropertyDescriptor,yE=kV(NI,"name"),DI={EXISTS:yE,PROPER:yE&&(function(){}).name==="something",CONFIGURABLE:yE&&(!RE||RE&&LV(NI,"name").configurable)},MV=!O(function(){function r(){}return r.prototype.constructor=null,Object.getPrototypeOf(new r)!==r.prototype}),UV=ji,xV=Ft,VV=Oo,FV=MV,PI=op("IE_PROTO"),IE=Object,jV=IE.prototype,AE=FV?IE.getPrototypeOf:function(r){var e=VV(r);if(UV(e,PI))return e[PI];var n=e.constructor;return xV(n)&&e instanceof n?n.prototype:e instanceof IE?jV:null},BV=O,GV=Ft,WV=qr,HV=Yu,kI=AE,KV=Vc,wE=wn("iterator"),LI=!1;[].keys&&("next"in(OI=[].keys())?(bI=kI(kI(OI)))!==Object.prototype&&(sc=bI):LI=!0);var YV=!WV(sc)||BV(function(){var r={};return sc[wE].call(r)!==r});GV((sc=YV?{}:HV(sc))[wE])||KV(sc,wE,function(){return this});var MI={IteratorPrototype:sc,BUGGY_SAFARI_ITERATORS:LI},zV=MI.IteratorPrototype,qV=Yu,JV=sr,XV=nc,QV=yd,ZV=function(){return this},vO=function(r,e,n,o){var c=e+" Iterator";return r.prototype=qV(zV,{next:JV(+!o,n)}),XV(r,c,!1,!0),QV[c]=ZV,r},$V=ae,eF=cs,tF=Ft,nF=String,iF=TypeError,rF=function(r,e,n){try{return $V(eF(Object.getOwnPropertyDescriptor(r,e)[n]))}catch{}},sF=ls,oF=function(r){if(typeof r=="object"||tF(r))return r;throw iF("Can't set "+nF(r)+" as a prototype")},aF=Object.setPrototypeOf||("__proto__"in{}?function(){var r,e=!1,n={};try{(r=rF(Object.prototype,"__proto__","set"))(n,[]),e=n instanceof Array}catch{}return function(o,c){return sF(o),oF(c),e?r(o,c):o.__proto__=c,o}}():void 0),cF=Xt,dF=Nt,lF=DI,uF=vO,hF=AE,RO=nc,UI=Vc,yO=yd,pF=MI,zS=lF.PROPER,Lm=pF.BUGGY_SAFARI_ITERATORS,qS=wn("iterator"),bE="keys",OE="values",IO="entries",AO=function(){return this},xI=function(r,e,n,o,c,u,m){uF(n,e,o);var _,S,C,R=function(ee){if(ee===c&&j)return j;if(!Lm&&ee in L)return L[ee];switch(ee){case bE:case OE:case IO:return function(){return new n(this,ee)}}return function(){return new n(this)}},w=e+" Iterator",N=!1,L=r.prototype,H=L[qS]||L["@@iterator"]||c&&L[c],j=!Lm&&H||R(c),W=e=="Array"&&L.entries||H;if(W&&(_=hF(W.call(new r)))!==Object.prototype&&_.next&&(RO(_,w,!0,!0),yO[w]=AO),zS&&c==OE&&H&&H.name!==OE&&(N=!0,j=function(){return dF(H,this)}),c)if(S={values:R(OE),keys:u?j:R(bE),entries:R(IO)},m)for(C in S)(Lm||N||!(C in L))&&UI(L,C,S[C]);else cF({target:e,proto:!0,forced:Lm||N},S);return m&&L[qS]!==j&&UI(L,qS,j,{name:c}),yO[e]=j,S},wO=function(r,e){return{value:r,done:e}},bO=Za,VI=yd,OO=Bl;ds.f;var NO=xI,FI=wO,DO="Array Iterator",mF=OO.set,fF=OO.getterFor(DO);NO(Array,"Array",function(r,e){mF(this,{type:DO,target:bO(r),index:0,kind:e})},function(){var r=fF(this),e=r.target,n=r.kind,o=r.index++;return!e||o>=e.length?(r.target=void 0,FI(void 0,!0)):FI(n=="keys"?o:n=="values"?e[o]:[o,e[o]],!1)},"values"),VI.Arguments=VI.Array;var _F={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},EF=Fe,gF=Pa,PO=ra,jI=yd,JS=wn("toStringTag");for(var XS in _F){var QS=EF[XS],BI=QS&&QS.prototype;BI&&gF(BI)!==JS&&PO(BI,JS,XS),jI[XS]=jI.Array}var SF=PV,TF=wn,kO=ds.f,GI=TF("metadata"),LO=Function.prototype;LO[GI]===void 0&&kO(LO,GI,{value:null}),qn("dispose"),qn("metadata");var CF=SF;qn("asyncDispose");var WI=ae,HI=hr("Symbol"),vF=HI.keyFor,MO=WI(HI.prototype.valueOf),UO=HI.isRegisteredSymbol||function(r){try{return vF(MO(r))!==void 0}catch{return!1}};Xt({target:"Symbol",stat:!0},{isRegisteredSymbol:UO});for(var xO=fd,VO=hr,RF=ae,yF=xl,ZS=wn,NE=VO("Symbol"),KI=NE.isWellKnownSymbol,FO=VO("Object","getOwnPropertyNames"),jO=RF(NE.prototype.valueOf),$S=xO("wks"),eT=0,BO=FO(NE),GO=BO.length;eT<GO;eT++)try{var YI=BO[eT];yF(NE[YI])&&ZS(YI)}catch{}var gp=function(r){if(KI&&KI(r))return!0;try{for(var e=jO(r),n=0,o=FO($S),c=o.length;n<c;n++)if($S[o[n]]==e)return!0}catch{}return!1};Xt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:gp}),qn("matcher"),qn("observable"),Xt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:UO}),Xt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:gp}),qn("metadataKey"),qn("patternMatch"),qn("replaceAll");var qu=A(CF),zI=ae,IF=j_,AF=Bs,wF=Ul,WO=zI("".charAt),HO=zI("".charCodeAt),KO=zI("".slice),YO=function(r){return function(e,n){var o,c,u=AF(wF(e)),m=IF(n),_=u.length;return m<0||m>=_?r?"":void 0:(o=HO(u,m))<55296||o>56319||m+1===_||(c=HO(u,m+1))<56320||c>57343?r?WO(u,m):o:r?KO(u,m,m+2):c-56320+(o-55296<<10)+65536}},zO={codeAt:YO(!1),charAt:YO(!0)},qO=zO.charAt,bF=Bs,qI=Bl,JO=xI,XO=wO,QO="String Iterator",ZO=qI.set,DE=qI.getterFor(QO);JO(String,"String",function(r){ZO(this,{type:QO,string:bF(r),index:0})},function(){var r,e=DE(this),n=e.string,o=e.index;return o>=n.length?XO(void 0,!0):(r=qO(n,o),e.index+=r.length,XO(r,!1))});var $O=A(Td.f("iterator"));function PE(r){return PE=typeof qu=="function"&&typeof $O=="symbol"?function(e){return typeof e}:function(e){return e&&typeof qu=="function"&&e.constructor===qu&&e!==qu.prototype?"symbol":typeof e},PE(r)}var P=A(Td.f("toPrimitive"));function OF(r){var e=function(n,o){if(PE(n)!=="object"||n===null)return n;var c=n[P];if(c!==void 0){var u=c.call(n,o||"default");if(PE(u)!=="object")return u;throw new TypeError("@@toPrimitive must return a primitive value.")}return(o==="string"?String:Number)(n)}(r,"string");return PE(e)==="symbol"?e:String(e)}function D(r,e,n){return(e=OF(e))in r?ox(r,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):r[e]=n,r}var NF=sa("Array").keys,DF=Pa,PF=ji,JI=ge,kF=NF,Ho=Array.prototype,eN={DOMTokenList:!0,NodeList:!0},ka=A(function(r){var e=r.keys;return r===Ho||JI(Ho,r)&&e===Ho.keys||PF(eN,DF(r))?kF:e}),XI=md,LF=TypeError,tT=YS,MF=Math.floor,QI=function(r,e){var n=r.length,o=MF(n/2);return n<8?UF(r,e):xF(r,QI(tT(r,0,o),e),QI(tT(r,o),e),e)},UF=function(r,e){for(var n,o,c=r.length,u=1;u<c;){for(o=u,n=r[u];o&&e(r[o-1],n)>0;)r[o]=r[--o];o!==u++&&(r[o]=n)}return r},xF=function(r,e,n,o){for(var c=e.length,u=n.length,m=0,_=0;m<c||_<u;)r[m+_]=m<c&&_<u?o(e[m],n[_])<=0?e[m++]:n[_++]:m<c?e[m++]:n[_++];return r},nT=QI,tN=O,ZI=function(r,e){var n=[][r];return!!n&&tN(function(){n.call(null,e||function(){return 1},1)})},nN=$a.match(/firefox\/(\d+)/i),iN=!!nN&&+nN[1],VF=/MSIE|Trident/.test($a),rN=$a.match(/AppleWebKit\/(\d+)\./),sN=!!rN&&+rN[1],FF=Xt,oN=ae,aN=cs,jF=Oo,$I=Da,eA=function(r,e){if(!delete r[e])throw LF("Cannot delete property "+XI(e)+" of "+XI(r))},cN=Bs,tA=O,dN=nT,BF=ZI,nA=iN,lN=VF,Yl=ec,iA=sN,Ju=[],uN=oN(Ju.sort),GF=oN(Ju.push),WF=tA(function(){Ju.sort(void 0)}),hN=tA(function(){Ju.sort(null)}),HF=BF("sort"),pN=!tA(function(){if(Yl)return Yl<70;if(!(nA&&nA>3)){if(lN)return!0;if(iA)return iA<603;var r,e,n,o,c="";for(r=65;r<76;r++){switch(e=String.fromCharCode(r),r){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(o=0;o<47;o++)Ju.push({k:e+o,v:n})}for(Ju.sort(function(u,m){return m.v-u.v}),o=0;o<Ju.length;o++)e=Ju[o].k.charAt(0),c.charAt(c.length-1)!==e&&(c+=e);return c!=="DGBEFHACIJK"}});FF({target:"Array",proto:!0,forced:WF||!hN||!HF||!pN},{sort:function(r){r!==void 0&&aN(r);var e=jF(this);if(pN)return r===void 0?uN(e):uN(e,r);var n,o,c=[],u=$I(e);for(o=0;o<u;o++)o in e&&GF(c,e[o]);for(dN(c,function(m){return function(_,S){return S===void 0?-1:_===void 0?1:m!==void 0?+m(_,S)||0:cN(_)>cN(S)?1:-1}}(r)),n=$I(c),o=0;o<n;)e[o]=c[o++];for(;o<u;)eA(e,o++);return e}});var KF=sa("Array").sort,rA=ge,kE=KF,sA=Array.prototype,LE=A(function(r){var e=r.sort;return r===sA||rA(sA,r)&&e===sA.sort?kE:e}),YF=hr,zF=cp,qF=zu,JF=ls,mN=ae([].concat),XF=YF("Reflect","ownKeys")||function(r){var e=zF.f(JF(r)),n=qF.f;return n?mN(e,n(r)):e},fN=ji,QF=XF,ZF=as,$F=ds,_N=qr,ej=ra,EN=Error,gN=ae("".replace),tj=String(EN("zxcasd").stack),SN=/\n\s*at [^:]*:[^\n]*/,nj=SN.test(tj),ij=sr,rj=!O(function(){var r=Error("a");return!("stack"in r)||(Object.defineProperty(r,"stack",ij(1,7)),r.stack!==7)}),sj=ra,TN=function(r,e){if(nj&&typeof r=="string"&&!EN.prepareStackTrace)for(;e--;)r=gN(r,SN,"");return r},oj=rj,CN=Error.captureStackTrace,aj=yd,cj=wn("iterator"),vN=Array.prototype,RN=function(r){return r!==void 0&&(aj.Array===r||vN[cj]===r)},dj=Pa,yN=N_,IN=zh,lj=yd,uj=wn("iterator"),iT=function(r){if(!IN(r))return yN(r,uj)||yN(r,"@@iterator")||lj[dj(r)]},hj=Nt,pj=cs,mj=ls,fj=md,AN=iT,_j=TypeError,oA=function(r,e){var n=arguments.length<2?AN(r):e;if(pj(n))return mj(hj(n,r));throw _j(fj(r)+" is not iterable")},Ej=Nt,wN=ls,gj=N_,bN=function(r,e,n){var o,c;wN(r);try{if(!(o=gj(r,"return"))){if(e==="throw")throw n;return n}o=Ej(o,r)}catch(u){c=!0,o=u}if(e==="throw")throw n;if(c)throw o;return wN(o),n},Sj=xc,ON=Nt,Tj=ls,Cj=md,NN=RN,vj=Da,ME=ge,DN=oA,UE=iT,PN=bN,Rj=TypeError,rT=function(r,e){this.stopped=r,this.result=e},kN=rT.prototype,Xu=function(r,e,n){var o,c,u,m,_,S,C,R=n&&n.that,w=!(!n||!n.AS_ENTRIES),N=!(!n||!n.IS_RECORD),L=!(!n||!n.IS_ITERATOR),H=!(!n||!n.INTERRUPTED),j=Sj(e,R),W=function(re){return o&&PN(o,"normal",re),new rT(!0,re)},ee=function(re){return w?(Tj(re),H?j(re[0],re[1],W):j(re[0],re[1])):H?j(re,W):j(re)};if(N)o=r.iterator;else if(L)o=r;else{if(!(c=UE(r)))throw Rj(Cj(r)+" is not iterable");if(NN(c)){for(u=0,m=vj(r);m>u;u++)if((_=ee(r[u]))&&ME(kN,_))return _;return new rT(!1)}o=DN(r,c)}for(S=N?r.next:o.next;!(C=ON(S,o)).done;){try{_=ee(C.value)}catch(re){PN(o,"throw",re)}if(typeof _=="object"&&_&&ME(kN,_))return _}return new rT(!1)},yj=Bs,LN=Xt,aA=ge,cA=AE,sT=aF,Ij=function(r,e,n){for(var o=QF(e),c=$F.f,u=ZF.f,m=0;m<o.length;m++){var _=o[m];fN(r,_)||n&&fN(n,_)||c(r,_,u(e,_))}},MN=Yu,dA=ra,lA=sr,oT=function(r,e){_N(e)&&"cause"in e&&ej(r,"cause",e.cause)},Aj=function(r,e,n,o){oj&&(CN?CN(r,e):sj(r,"stack",TN(n,o)))},Mm=Xu,uA=function(r,e){return r===void 0?arguments.length<2?"":e:yj(r)},xE=wn("toStringTag"),zl=Error,UN=[].push,Qu=function(r,e){var n,o=aA(Sp,this);sT?n=sT(zl(),o?cA(this):Sp):(n=o?this:MN(Sp),dA(n,xE,"Error")),e!==void 0&&dA(n,"message",uA(e)),Aj(n,Qu,n.stack,1),arguments.length>2&&oT(n,arguments[2]);var c=[];return Mm(r,UN,{that:c}),dA(n,"errors",c),n};sT?sT(Qu,zl):Ij(Qu,zl,{name:!0});var Sp=Qu.prototype=MN(zl.prototype,{constructor:lA(1,Qu),message:lA(1,""),name:lA(1,"AggregateError")});LN({global:!0,constructor:!0,arity:2},{AggregateError:Qu});var VE,Um,xN,aT,FE=typeof process<"u"&&dt(process)=="process",wj=hr,bj=aE,Oj=ii,VN=wn("species"),FN=ge,Nj=TypeError,hA=function(r,e){if(FN(e,r))return r;throw Nj("Incorrect invocation")},Dj=KS,jN=md,Pj=TypeError,pA=ls,oc=function(r){if(Dj(r))return r;throw Pj(jN(r)+" is not a constructor")},kj=zh,Lj=wn("species"),mA=function(r,e){var n,o=pA(r).constructor;return o===void 0||kj(n=pA(o)[Lj])?e:oc(n)},Mj=TypeError,jE=function(r,e){if(r<e)throw Mj("Not enough arguments");return r},fA=/(?:ipad|iphone|ipod).*applewebkit/i.test($a),ac=Fe,BN=ve,Uj=xc,GN=Ft,xj=ji,cT=O,dT=Oy,Vj=hI,lT=M_,Fj=jE,WN=fA,jj=FE,BE=ac.setImmediate,Tp=ac.clearImmediate,HN=ac.process,GE=ac.Dispatch,_A=ac.Function,EA=ac.MessageChannel,KN=ac.String,uT=0,xm={},Cp="onreadystatechange";cT(function(){VE=ac.location});var WE=function(r){if(xj(xm,r)){var e=xm[r];delete xm[r],e()}},HE=function(r){return function(){WE(r)}},hT=function(r){WE(r.data)},gA=function(r){ac.postMessage(KN(r),VE.protocol+"//"+VE.host)};BE&&Tp||(BE=function(r){Fj(arguments.length,1);var e=GN(r)?r:_A(r),n=Vj(arguments,1);return xm[++uT]=function(){BN(e,void 0,n)},Um(uT),uT},Tp=function(r){delete xm[r]},jj?Um=function(r){HN.nextTick(HE(r))}:GE&&GE.now?Um=function(r){GE.now(HE(r))}:EA&&!WN?(aT=(xN=new EA).port2,xN.port1.onmessage=hT,Um=Uj(aT.postMessage,aT)):ac.addEventListener&&GN(ac.postMessage)&&!ac.importScripts&&VE&&VE.protocol!=="file:"&&!cT(gA)?(Um=gA,ac.addEventListener("message",hT,!1)):Um=Cp in lT("script")?function(r){dT.appendChild(lT("script"))[Cp]=function(){dT.removeChild(this),WE(r)}}:function(r){setTimeout(HE(r),0)});var SA={set:BE,clear:Tp},YN=function(){this.head=null,this.tail=null};YN.prototype={add:function(r){var e={item:r,next:null},n=this.tail;n?n.next=e:this.head=e,this.tail=e},get:function(){var r=this.head;if(r)return(this.head=r.next)===null&&(this.tail=null),r.item}};var Vm,ql,pT,TA,mT,zN=YN,Bj=/ipad|iphone|ipod/i.test($a)&&typeof Pebble<"u",Gj=/web0s(?!.*chrome)/i.test($a),vp=Fe,fT=xc,qN=as.f,_T=SA.set,JN=zN,ET=fA,XN=Bj,CA=Gj,Fm=FE,KE=vp.MutationObserver||vp.WebKitMutationObserver,QN=vp.document,Rp=vp.process,$d=vp.Promise,vA=qN(vp,"queueMicrotask"),RA=vA&&vA.value;if(!RA){var gT=new JN,Zu=function(){var r,e;for(Fm&&(r=Rp.domain)&&r.exit();e=gT.get();)try{e()}catch(n){throw gT.head&&Vm(),n}r&&r.enter()};ET||Fm||CA||!KE||!QN?!XN&&$d&&$d.resolve?((TA=$d.resolve(void 0)).constructor=$d,mT=fT(TA.then,TA),Vm=function(){mT(Zu)}):Fm?Vm=function(){Rp.nextTick(Zu)}:(_T=fT(_T,vp),Vm=function(){_T(Zu)}):(ql=!0,pT=QN.createTextNode(""),new KE(Zu).observe(pT,{characterData:!0}),Vm=function(){pT.data=ql=!ql}),RA=function(r){gT.head||Vm(),gT.add(r)}}var Wj=RA,jm=function(r){try{return{error:!1,value:r()}}catch(e){return{error:!0,value:e}}},yp=Fe.Promise,ZN=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",Hj=!ZN&&!FE&&typeof window=="object"&&typeof document=="object",Kj=Fe,Ip=yp,$N=Ft,Yj=gR,eD=_y,tD=wn,zj=Hj,YE=ZN,Fc=ec,yA=Ip&&Ip.prototype,qj=tD("species"),nD=!1,ST=$N(Kj.PromiseRejectionEvent),iD=Yj("Promise",function(){var r=eD(Ip),e=r!==String(Ip);if(!e&&Fc===66||!yA.catch||!yA.finally)return!0;if(!Fc||Fc<51||!/native code/.test(r)){var n=new Ip(function(c){c(1)}),o=function(c){c(function(){},function(){})};if((n.constructor={})[qj]=o,!(nD=n.then(function(){})instanceof o))return!0}return!e&&(zj||YE)&&!ST}),zE={CONSTRUCTOR:iD,REJECTION_EVENT:ST,SUBCLASSING:nD},cc={},Jl=cs,qE=TypeError,Jj=function(r){var e,n;this.promise=new r(function(o,c){if(e!==void 0||n!==void 0)throw qE("Bad Promise constructor");e=o,n=c}),this.resolve=Jl(e),this.reject=Jl(n)};cc.f=function(r){return new Jj(r)};var IA,rD,Xj=Xt,Bm=FE,$u=Fe,JE=Nt,Qj=Vc,sD=nc,AA=function(r){var e=wj(r);Oj&&e&&!e[VN]&&bj(e,VN,{configurable:!0,get:function(){return this}})},Zj=cs,wA=Ft,$j=qr,oD=hA,bA=mA,OA=SA.set,TT=Wj,CT=function(r,e){try{arguments.length==1?console.error(r):console.error(r,e)}catch{}},aD=jm,eB=zN,vT=Bl,NA=yp,cD=zE,Gm=cc,Wm="Promise",DA=cD.CONSTRUCTOR,PA=cD.REJECTION_EVENT,XE=vT.getterFor(Wm),kA=vT.set,tB=NA&&NA.prototype,QE=NA,RT=tB,LA=$u.TypeError,yT=$u.document,IT=$u.process,AT=Gm.f,nB=AT,dD=!!(yT&&yT.createEvent&&$u.dispatchEvent),lD="unhandledrejection",Ap=function(r){var e;return!(!$j(r)||!wA(e=r.then))&&e},wp=function(r,e){var n,o,c,u=e.value,m=e.state==1,_=m?r.ok:r.fail,S=r.resolve,C=r.reject,R=r.domain;try{_?(m||(e.rejection===2&&pD(e),e.rejection=1),_===!0?n=u:(R&&R.enter(),n=_(u),R&&(R.exit(),c=!0)),n===r.promise?C(LA("Promise-chain cycle")):(o=Ap(n))?JE(o,n,S,C):S(n)):C(u)}catch(w){R&&!c&&R.exit(),C(w)}},wT=function(r,e){r.notified||(r.notified=!0,TT(function(){for(var n,o=r.reactions;n=o.get();)wp(n,r);r.notified=!1,e&&!r.rejection&&uD(r)}))},MA=function(r,e,n){var o,c;dD?((o=yT.createEvent("Event")).promise=e,o.reason=n,o.initEvent(r,!1,!0),$u.dispatchEvent(o)):o={promise:e,reason:n},!PA&&(c=$u["on"+r])?c(o):r===lD&&CT("Unhandled promise rejection",n)},uD=function(r){JE(OA,$u,function(){var e,n=r.facade,o=r.value;if(hD(r)&&(e=aD(function(){Bm?IT.emit("unhandledRejection",o,n):MA(lD,n,o)}),r.rejection=Bm||hD(r)?2:1,e.error))throw e.value})},hD=function(r){return r.rejection!==1&&!r.parent},pD=function(r){JE(OA,$u,function(){var e=r.facade;Bm?IT.emit("rejectionHandled",e):MA("rejectionhandled",e,r.value)})},Hm=function(r,e,n){return function(o){r(e,o,n)}},Km=function(r,e,n){r.done||(r.done=!0,n&&(r=n),r.value=e,r.state=2,wT(r,!0))},Ym=function(r,e,n){if(!r.done){r.done=!0,n&&(r=n);try{if(r.facade===e)throw LA("Promise can't be resolved itself");var o=Ap(e);o?TT(function(){var c={done:!1};try{JE(o,e,Hm(Ym,c,r),Hm(Km,c,r))}catch(u){Km(c,u,r)}}):(r.value=e,r.state=1,wT(r,!1))}catch(c){Km({done:!1},c,r)}}};DA&&(RT=(QE=function(r){oD(this,RT),Zj(r),JE(IA,this);var e=XE(this);try{r(Hm(Ym,e),Hm(Km,e))}catch(n){Km(e,n)}}).prototype,(IA=function(r){kA(this,{type:Wm,done:!1,notified:!1,parent:!1,reactions:new eB,rejection:!1,state:0,value:void 0})}).prototype=Qj(RT,"then",function(r,e){var n=XE(this),o=AT(bA(this,QE));return n.parent=!0,o.ok=!wA(r)||r,o.fail=wA(e)&&e,o.domain=Bm?IT.domain:void 0,n.state==0?n.reactions.add(o):TT(function(){wp(o,n)}),o.promise}),rD=function(){var r=new IA,e=XE(r);this.promise=r,this.resolve=Hm(Ym,e),this.reject=Hm(Km,e)},Gm.f=AT=function(r){return r===QE||r===void 0?new rD(r):nB(r)}),Xj({global:!0,constructor:!0,wrap:!0,forced:DA},{Promise:QE}),sD(QE,Wm,!1,!0),AA(Wm);var mD=wn("iterator"),fD=!1;try{var iB=0,_D={next:function(){return{done:!!iB++}},return:function(){fD=!0}};_D[mD]=function(){return this},Array.from(_D,function(){throw 2})}catch{}var rB=yp,sB=function(r,e){if(!fD)return!1;var n=!1;try{var o={};o[mD]=function(){return{next:function(){return{done:n=!0}}}},r(o)}catch{}return n},bT=zE.CONSTRUCTOR||!sB(function(r){rB.all(r).then(void 0,function(){})}),oB=Nt,aB=cs,cB=cc,dB=jm,lB=Xu;Xt({target:"Promise",stat:!0,forced:bT},{all:function(r){var e=this,n=cB.f(e),o=n.resolve,c=n.reject,u=dB(function(){var m=aB(e.resolve),_=[],S=0,C=1;lB(r,function(R){var w=S++,N=!1;C++,oB(m,e,R).then(function(L){N||(N=!0,_[w]=L,--C||o(_))},c)}),--C||o(_)});return u.error&&c(u.value),n.promise}});var uB=Xt,hB=zE.CONSTRUCTOR;yp&&yp.prototype,uB({target:"Promise",proto:!0,forced:hB,real:!0},{catch:function(r){return this.then(void 0,r)}});var pB=Nt,mB=cs,fB=cc,ED=jm,_B=Xu;Xt({target:"Promise",stat:!0,forced:bT},{race:function(r){var e=this,n=fB.f(e),o=n.reject,c=ED(function(){var u=mB(e.resolve);_B(r,function(m){pB(u,e,m).then(n.resolve,o)})});return c.error&&o(c.value),n.promise}});var EB=Nt,gB=cc;Xt({target:"Promise",stat:!0,forced:zE.CONSTRUCTOR},{reject:function(r){var e=gB.f(this);return EB(e.reject,void 0,r),e.promise}});var SB=ls,TB=qr,CB=cc,gD=function(r,e){if(SB(r),TB(e)&&e.constructor===r)return e;var n=CB.f(r);return(0,n.resolve)(e),n.promise},vB=Xt,RB=yp,yB=zE.CONSTRUCTOR,IB=gD,AB=hr("Promise"),wB=!yB;vB({target:"Promise",stat:!0,forced:!0},{resolve:function(r){return IB(wB&&this===AB?RB:this,r)}});var bB=Nt,OB=cs,NB=cc,DB=jm,SD=Xu;Xt({target:"Promise",stat:!0,forced:bT},{allSettled:function(r){var e=this,n=NB.f(e),o=n.resolve,c=n.reject,u=DB(function(){var m=OB(e.resolve),_=[],S=0,C=1;SD(r,function(R){var w=S++,N=!1;C++,bB(m,e,R).then(function(L){N||(N=!0,_[w]={status:"fulfilled",value:L},--C||o(_))},function(L){N||(N=!0,_[w]={status:"rejected",reason:L},--C||o(_))})}),--C||o(_)});return u.error&&c(u.value),n.promise}});var PB=Nt,UA=cs,kB=hr,LB=cc,MB=jm,UB=Xu,xA="No one promise resolved";Xt({target:"Promise",stat:!0,forced:bT},{any:function(r){var e=this,n=kB("AggregateError"),o=LB.f(e),c=o.resolve,u=o.reject,m=MB(function(){var _=UA(e.resolve),S=[],C=0,R=1,w=!1;UB(r,function(N){var L=C++,H=!1;R++,PB(_,e,N).then(function(j){H||w||(w=!0,c(j))},function(j){H||w||(H=!0,S[L]=j,--R||u(new n(S,xA)))})}),--R||u(new n(S,xA))});return m.error&&u(m.value),o.promise}});var xB=Xt,OT=yp,Pe=O,VB=hr,ZE=Ft,NT=mA,$E=gD,el=OT&&OT.prototype;xB({target:"Promise",proto:!0,real:!0,forced:!!OT&&Pe(function(){el.finally.call({then:function(){}},function(){})})},{finally:function(r){var e=NT(this,VB("Promise")),n=ZE(r);return this.then(n?function(o){return $E(e,r()).then(function(){return o})}:r,n?function(o){return $E(e,r()).then(function(){throw o})}:r)}});var Cr=po.Promise,Ee=A(Cr);const VA=()=>{};function zm(){const r={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:VA};return r.promise=new Ee((e,n)=>{r.resolve=o=>{r.isFinished||(r.isResolved=!0,r.isFinished=!0,e(o),r.value=o)},r.reject=o=>{r.isFinished||(r.isRejected=!0,r.isFinished=!0,n(o))}}),r}const jc=new Map,qm=new Map,En=new Map;var ar,Pn;(function(r){r.WIN_10="Windows 10",r.WIN_81="Windows 8.1",r.WIN_8="Windows 8",r.WIN_7="Windows 7",r.WIN_VISTA="Windows Vista",r.WIN_SERVER_2003="Windows Server 2003",r.WIN_XP="Windows XP",r.WIN_2000="Windows 2000",r.ANDROID="Android",r.HARMONY_OS="HarmonyOS",r.OPEN_BSD="Open BSD",r.SUN_OS="Sun OS",r.LINUX="Linux",r.IOS="iOS",r.MAC_OS="Mac OS",r.CHROMIUM_OS="Chromium OS",r.QNX="QNX",r.UNIX="UNIX",r.BEOS="BeOS",r.OS_2="OS/2",r.SEARCH_BOT="Search Bot"})(ar||(ar={})),function(r){r.CHROME="Chrome",r.SAFARI="Safari",r.EDGE="Edge",r.FIREFOX="Firefox",r.OPERA="OPR",r.QQ="QQBrowser",r.WECHAT="MicroMessenger"}(Pn||(Pn={}));var Jm={exports:{}};(function(r,e){(function(n,o){var c="function",u="undefined",m="object",_="string",S="major",C="model",R="name",w="type",N="vendor",L="version",H="architecture",j="console",W="mobile",ee="tablet",re="smarttv",fe="wearable",be="embedded",_e="Amazon",ye="Apple",Le="ASUS",Me="BlackBerry",et="Browser",at="Chrome",Zt="Firefox",Sn="Google",gi="Huawei",Yr="LG",Mi="Microsoft",wc="Motorola",ze="Opera",it="Samsung",St="Sharp",Kt="Sony",jn="Xiaomi",ct="Zebra",G="Facebook",se="Chromium OS",me="Mac OS",$e=function(gr){for(var zr={},Ui=0;Ui<gr.length;Ui++)zr[gr[Ui].toUpperCase()]=gr[Ui];return zr},$t=function(gr,zr){return typeof gr===_&&Ni(zr).indexOf(Ni(gr))!==-1},Ni=function(gr){return gr.toLowerCase()},uo=function(gr,zr){if(typeof gr===_)return gr=gr.replace(/^\s\s*/,""),typeof zr===u?gr:gr.substring(0,350)},bc=function(gr,zr){for(var Ui,Oc,Bh,Sr,Bn,Ka,e_=0;e_<zr.length&&!Bn;){var Vu=zr[e_],iH=zr[e_+1];for(Ui=Oc=0;Ui<Vu.length&&!Bn&&Vu[Ui];)if(Bn=Vu[Ui++].exec(gr))for(Bh=0;Bh<iH.length;Bh++)Ka=Bn[++Oc],typeof(Sr=iH[Bh])===m&&Sr.length>0?Sr.length===2?typeof Sr[1]==c?this[Sr[0]]=Sr[1].call(this,Ka):this[Sr[0]]=Sr[1]:Sr.length===3?typeof Sr[1]!==c||Sr[1].exec&&Sr[1].test?this[Sr[0]]=Ka?Ka.replace(Sr[1],Sr[2]):o:this[Sr[0]]=Ka?Sr[1].call(this,Ka,Sr[2]):o:Sr.length===4&&(this[Sr[0]]=Ka?Sr[3].call(this,Ka.replace(Sr[1],Sr[2])):o):this[Sr]=Ka||o;e_+=2}},Tm=function(gr,zr){for(var Ui in zr)if(typeof zr[Ui]===m&&zr[Ui].length>0){for(var Oc=0;Oc<zr[Ui].length;Oc++)if($t(zr[Ui][Oc],gr))return Ui==="?"?o:Ui}else if($t(zr[Ui],gr))return Ui==="?"?o:Ui;return gr},cL={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},dL={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[L,[R,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[L,[R,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[R,L],[/opios[\/ ]+([\w\.]+)/i],[L,[R,ze+" Mini"]],[/\bopr\/([\w\.]+)/i],[L,[R,ze]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[R,L],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[L,[R,"UC"+et]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[L,[R,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[L,[R,"WeChat"]],[/konqueror\/([\w\.]+)/i],[L,[R,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[L,[R,"IE"]],[/yabrowser\/([\w\.]+)/i],[L,[R,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[R,/(.+)/,"$1 Secure "+et],L],[/\bfocus\/([\w\.]+)/i],[L,[R,Zt+" Focus"]],[/\bopt\/([\w\.]+)/i],[L,[R,ze+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[L,[R,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[L,[R,"Dolphin"]],[/coast\/([\w\.]+)/i],[L,[R,ze+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[L,[R,"MIUI "+et]],[/fxios\/([-\w\.]+)/i],[L,[R,Zt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[R,"360 "+et]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[R,/(.+)/,"$1 "+et],L],[/(comodo_dragon)\/([\w\.]+)/i],[[R,/_/g," "],L],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[R,L],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[R],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[R,G],L],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[R,L],[/\bgsa\/([\w\.]+) .*safari\//i],[L,[R,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[L,[R,at+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[R,at+" WebView"],L],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[L,[R,"Android "+et]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[R,L],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[L,[R,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[L,R],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[R,[L,Tm,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[R,L],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[R,"Netscape"],L],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[L,[R,Zt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[R,L],[/(cobalt)\/([\w\.]+)/i],[R,[L,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[H,"amd64"]],[/(ia32(?=;))/i],[[H,Ni]],[/((?:i[346]|x)86)[;\)]/i],[[H,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[H,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[H,"armhf"]],[/windows (ce|mobile); ppc;/i],[[H,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[H,/ower/,"",Ni]],[/(sun4\w)[;\)]/i],[[H,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[H,Ni]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[C,[N,it],[w,ee]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[C,[N,it],[w,W]],[/\((ip(?:hone|od)[\w ]*);/i],[C,[N,ye],[w,W]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[C,[N,ye],[w,ee]],[/(macintosh);/i],[C,[N,ye]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[C,[N,St],[w,W]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[C,[N,gi],[w,ee]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[C,[N,gi],[w,W]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[C,/_/g," "],[N,jn],[w,W]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[C,/_/g," "],[N,jn],[w,ee]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[C,[N,"OPPO"],[w,W]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[C,[N,"Vivo"],[w,W]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[C,[N,"Realme"],[w,W]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[C,[N,wc],[w,W]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[C,[N,wc],[w,ee]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[C,[N,Yr],[w,ee]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[C,[N,Yr],[w,W]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[C,[N,"Lenovo"],[w,ee]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[C,/_/g," "],[N,"Nokia"],[w,W]],[/(pixel c)\b/i],[C,[N,Sn],[w,ee]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[C,[N,Sn],[w,W]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[C,[N,Kt],[w,W]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[C,"Xperia Tablet"],[N,Kt],[w,ee]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[C,[N,"OnePlus"],[w,W]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[C,[N,_e],[w,ee]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[C,/(.+)/g,"Fire Phone $1"],[N,_e],[w,W]],[/(playbook);[-\w\),; ]+(rim)/i],[C,N,[w,ee]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[C,[N,Me],[w,W]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[C,[N,Le],[w,ee]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[C,[N,Le],[w,W]],[/(nexus 9)/i],[C,[N,"HTC"],[w,ee]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[N,[C,/_/g," "],[w,W]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[C,[N,"Acer"],[w,ee]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[C,[N,"Meizu"],[w,W]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[N,C,[w,W]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[N,C,[w,ee]],[/(surface duo)/i],[C,[N,Mi],[w,ee]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[C,[N,"Fairphone"],[w,W]],[/(u304aa)/i],[C,[N,"AT&T"],[w,W]],[/\bsie-(\w*)/i],[C,[N,"Siemens"],[w,W]],[/\b(rct\w+) b/i],[C,[N,"RCA"],[w,ee]],[/\b(venue[\d ]{2,7}) b/i],[C,[N,"Dell"],[w,ee]],[/\b(q(?:mv|ta)\w+) b/i],[C,[N,"Verizon"],[w,ee]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[C,[N,"Barnes & Noble"],[w,ee]],[/\b(tm\d{3}\w+) b/i],[C,[N,"NuVision"],[w,ee]],[/\b(k88) b/i],[C,[N,"ZTE"],[w,ee]],[/\b(nx\d{3}j) b/i],[C,[N,"ZTE"],[w,W]],[/\b(gen\d{3}) b.+49h/i],[C,[N,"Swiss"],[w,W]],[/\b(zur\d{3}) b/i],[C,[N,"Swiss"],[w,ee]],[/\b((zeki)?tb.*\b) b/i],[C,[N,"Zeki"],[w,ee]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[N,"Dragon Touch"],C,[w,ee]],[/\b(ns-?\w{0,9}) b/i],[C,[N,"Insignia"],[w,ee]],[/\b((nxa|next)-?\w{0,9}) b/i],[C,[N,"NextBook"],[w,ee]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[N,"Voice"],C,[w,W]],[/\b(lvtel\-)?(v1[12]) b/i],[[N,"LvTel"],C,[w,W]],[/\b(ph-1) /i],[C,[N,"Essential"],[w,W]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[C,[N,"Envizen"],[w,ee]],[/\b(trio[-\w\. ]+) b/i],[C,[N,"MachSpeed"],[w,ee]],[/\btu_(1491) b/i],[C,[N,"Rotor"],[w,ee]],[/(shield[\w ]+) b/i],[C,[N,"Nvidia"],[w,ee]],[/(sprint) (\w+)/i],[N,C,[w,W]],[/(kin\.[onetw]{3})/i],[[C,/\./g," "],[N,Mi],[w,W]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[C,[N,ct],[w,ee]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[C,[N,ct],[w,W]],[/smart-tv.+(samsung)/i],[N,[w,re]],[/hbbtv.+maple;(\d+)/i],[[C,/^/,"SmartTV"],[N,it],[w,re]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[N,Yr],[w,re]],[/(apple) ?tv/i],[N,[C,ye+" TV"],[w,re]],[/crkey/i],[[C,at+"cast"],[N,Sn],[w,re]],[/droid.+aft(\w)( bui|\))/i],[C,[N,_e],[w,re]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[C,[N,St],[w,re]],[/(bravia[\w ]+)( bui|\))/i],[C,[N,Kt],[w,re]],[/(mitv-\w{5}) bui/i],[C,[N,jn],[w,re]],[/Hbbtv.*(technisat) (.*);/i],[N,C,[w,re]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[N,uo],[C,uo],[w,re]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[w,re]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[N,C,[w,j]],[/droid.+; (shield) bui/i],[C,[N,"Nvidia"],[w,j]],[/(playstation [345portablevi]+)/i],[C,[N,Kt],[w,j]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[C,[N,Mi],[w,j]],[/((pebble))app/i],[N,C,[w,fe]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[C,[N,ye],[w,fe]],[/droid.+; (glass) \d/i],[C,[N,Sn],[w,fe]],[/droid.+; (wt63?0{2,3})\)/i],[C,[N,ct],[w,fe]],[/(quest( 2| pro)?)/i],[C,[N,G],[w,fe]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[N,[w,be]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[C,[w,W]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[C,[w,ee]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[w,ee]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[w,W]],[/(android[-\w\. ]{0,9});.+buil/i],[C,[N,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[L,[R,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[L,[R,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[R,L],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[L,R]],os:[[/microsoft (windows) (vista|xp)/i],[R,L],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[R,[L,Tm,cL]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[R,"Windows"],[L,Tm,cL]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[L,/_/g,"."],[R,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[R,me],[L,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[L,R],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[R,L],[/\(bb(10);/i],[L,[R,Me]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[L,[R,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[L,[R,Zt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[L,[R,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[L,[R,"watchOS"]],[/crkey\/([\d\.]+)/i],[L,[R,at+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[R,se],L],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[R,L],[/(sunos) ?([\w\.\d]*)/i],[[R,"Solaris"],L],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[R,L]]},Kd=function(gr,zr){if(typeof gr===m&&(zr=gr,gr=o),!(this instanceof Kd))return new Kd(gr,zr).getResult();var Ui=typeof n!==u&&n.navigator?n.navigator:o,Oc=gr||(Ui&&Ui.userAgent?Ui.userAgent:""),Bh=Ui&&Ui.userAgentData?Ui.userAgentData:o,Sr=zr?function(Bn,Ka){var e_={};for(var Vu in Bn)Ka[Vu]&&Ka[Vu].length%2==0?e_[Vu]=Ka[Vu].concat(Bn[Vu]):e_[Vu]=Bn[Vu];return e_}(dL,zr):dL;return this.getBrowser=function(){var Bn={};return Bn[R]=o,Bn[L]=o,bc.call(Bn,Oc,Sr.browser),Bn[S]=function(Ka){return typeof Ka===_?Ka.replace(/[^\d\.]/g,"").split(".")[0]:o}(Bn[L]),Ui&&Ui.brave&&typeof Ui.brave.isBrave==c&&(Bn[R]="Brave"),Bn},this.getCPU=function(){var Bn={};return Bn[H]=o,bc.call(Bn,Oc,Sr.cpu),Bn},this.getDevice=function(){var Bn={};return Bn[N]=o,Bn[C]=o,Bn[w]=o,bc.call(Bn,Oc,Sr.device),!Bn[w]&&Bh&&Bh.mobile&&(Bn[w]=W),Bn[C]=="Macintosh"&&Ui&&typeof Ui.standalone!==u&&Ui.maxTouchPoints&&Ui.maxTouchPoints>2&&(Bn[C]="iPad",Bn[w]=ee),Bn},this.getEngine=function(){var Bn={};return Bn[R]=o,Bn[L]=o,bc.call(Bn,Oc,Sr.engine),Bn},this.getOS=function(){var Bn={};return Bn[R]=o,Bn[L]=o,bc.call(Bn,Oc,Sr.os),!Bn[R]&&Bh&&Bh.platform!="Unknown"&&(Bn[R]=Bh.platform.replace(/chrome os/i,se).replace(/macos/i,me)),Bn},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Oc},this.setUA=function(Bn){return Oc=typeof Bn===_&&Bn.length>350?uo(Bn,350):Bn,this},this.setUA(Oc),this};Kd.VERSION="0.7.34",Kd.BROWSER=$e([R,L,S]),Kd.CPU=$e([H]),Kd.DEVICE=$e([C,N,w,j,W,re,ee,fe,be]),Kd.ENGINE=Kd.OS=$e([R,L]),r.exports&&(e=r.exports=Kd),e.UAParser=Kd;var $f=typeof n!==u&&(n.jQuery||n.Zepto);if($f&&!$f.ua){var _v=new Kd;$f.ua=_v.getResult(),$f.ua.get=function(){return _v.getUA()},$f.ua.set=function(gr){_v.setUA(gr);var zr=_v.getResult();for(var Ui in zr)$f.ua[Ui]=zr[Ui]}}})(typeof window=="object"?window:T)})(Jm,Jm.exports);const TD=new(A(Jm.exports));let Xl=TD.getResult(),bp=null;function qt(r){if(!bp){Xl=TD.getResult();const e=function(u){if(u.engine.name==="Blink"&&u.browser.name!=="WeChat")return Pn.CHROME;switch(u.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Pn.CHROME;case"Safari":case"Mobile Safari":return Pn.SAFARI;case"Edge":return Pn.EDGE;case"Firefox":return Pn.FIREFOX;case"QQBrowser":return Pn.QQ;case"Opera":return Pn.OPERA;case"WeChat":return Pn.WECHAT;default:return u.browser.name||""}}(Xl),n=function(u){let m;return m=u.engine.name==="Blink"?u.engine.version||"":u.browser.version||"",m.split(".")[0]}(Xl),o=function(u){return u.os.name==="Windows"?u.os.version?u.os.name+" "+u.os.version:u.os.name:u.os.name||""}(Xl),c=Xl.os.version;if(!(e&&n&&o&&c))return{name:e,version:n,os:o,osVersion:c};bp={name:e,version:n,os:o,osVersion:c}}return bp}function Hn(){return qt().os}function Gs(){const r=qt();return"".concat(r.os," ").concat(r.osVersion)}function Xm(){const r=qt();return!!(Xl.engine.name==="WebKit"&&r.os===ar.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&r.name!==Pn.SAFARI||Ds()&&r.name!==Pn.SAFARI)}function CD(){const r=qt();if(Xm()){if(r.os===ar.MAC_OS)return!0;if(r.os===ar.IOS){const e=Xl.os.version&&Xl.os.version.split(".");if(e&&Number(e[0])===14&&e[1]&&Number(e[1])>=3||e&&Number(e[0])>14)return!0}}return!1}function vD(){return Xl.engine.name==="WebKit"}function tl(){return qt().name===Pn.CHROME}function Jr(){return qt().name===Pn.SAFARI}function Ln(){return qt().name===Pn.FIREFOX}function Ds(){return qt().os===ar.IOS}function DT(r){const e=qt();return!(e.name!==Pn.CHROME||!e.osVersion)&&Number(e.version)>=r}function Id(r){const e=qt();return!(e.name!==Pn.EDGE||!e.osVersion)&&Number(e.version)>=r}function FA(r){const e=qt();return!(e.name!==Pn.OPERA||!e.osVersion)&&Number(e.version)>=r}function jA(){const r=qt();return!(r.name!==Pn.CHROME||!r.osVersion)&&Number(r.version)<=90}function Ql(){const r=qt();if(r.os!==ar.IOS||!r.osVersion)return!1;const e=r.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Zl(){const r=qt();if(r.os!==ar.IOS||!r.osVersion)return!1;const e=r.osVersion.split(".");return Number(e[0])===15}function Op(){const r=qt();if(r.os!==ar.IOS||!r.osVersion)return!1;const e=r.osVersion.split(".");return Number(e[0])===16}function Z(){const r=qt();if(r.os!==ar.IOS||!r.osVersion)return!1;const e=r.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Ve(){return Jr()&&navigator.maxTouchPoints>0}function $l(){return qt().name===Pn.WECHAT}function vr(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function bn(){const r=qt();return r.name===Pn.EDGE||r.name===Pn.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Qm(){return Hn()===ar.ANDROID}function jr(){const r=qt();return Qm()&&(r.name===Pn.CHROME||r.name===Pn.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var Q;(function(r){r.UNEXPECTED_ERROR="UNEXPECTED_ERROR",r.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",r.TIMEOUT="TIMEOUT",r.INVALID_PARAMS="INVALID_PARAMS",r.NOT_READABLE="NOT_READABLE",r.NOT_SUPPORTED="NOT_SUPPORTED",r.INVALID_OPERATION="INVALID_OPERATION",r.OPERATION_ABORTED="OPERATION_ABORTED",r.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",r.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",r.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",r.DATACHANNEL_FAILED="DATACHANNEL_FAILED",r.NETWORK_ERROR="NETWORK_ERROR",r.NETWORK_TIMEOUT="NETWORK_TIMEOUT",r.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",r.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",r.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",r.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",r.ELECTRON_IS_NULL="ELECTRON_IS_NULL",r.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",r.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",r.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",r.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",r.TRACK_IS_DISABLED="TRACK_IS_DISABLED",r.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",r.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",r.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",r.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",r.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",r.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",r.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",r.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",r.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",r.UID_CONFLICT="UID_CONFLICT",r.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",r.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",r.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",r.INVALID_TRACK="INVALID_TRACK",r.SENDER_NOT_FOUND="SENDER_NOT_FOUND",r.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",r.SET_ANSWER_FAILED="SET_ANSWER_FAILED",r.ICE_FAILED="ICE_FAILED",r.PC_CLOSED="PC_CLOSED",r.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",r.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",r.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",r.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",r.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",r.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",r.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",r.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",r.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",r.INVALID_REMOTE_USER="INVALID_REMOTE_USER",r.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",r.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",r.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",r.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",r.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",r.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",r.WS_ABORT="WS_ABORT",r.WS_DISCONNECT="WS_DISCONNECT",r.WS_ERR="WS_ERR",r.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",r.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",r.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",r.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",r.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",r.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",r.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",r.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",r.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",r.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",r.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",r.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",r.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",r.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",r.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",r.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",r.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",r.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",r.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",r.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",r.INVALID_PLUGIN="INVALID_PLUGIN",r.DISCONNECT_P2P="DISCONNECT_P2P",r.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",r.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",r.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",r.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",r.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",r.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",r.PROHIBITED_OPERATION="PROHIBITED_OPERATION",r.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",r.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED"})(Q||(Q={}));let ke=class extends Error{constructor(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(e),D(this,"code",void 0),D(this,"message",void 0),D(this,"data",void 0),D(this,"name","AgoraRTCException"),this.code=r,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=n}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return r==="error"&&(e||console).error(this.toString()),r==="warning"&&(e||console).warn(this.toString()),this}throw(r){throw this.print("error",r),this}};function nl(r,e){if(typeof r!="boolean")throw new ke(Q.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function Rr(r,e,n){if(!xe(n).call(n,r))throw new ke(Q.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(n)))}function Jn(r,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(r<n||r>o||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(c){return typeof c=="number"&&c%1==0}(r))throw new ke(Q.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(n,", ").concat(o,"]. integer only"))}function eh(r,e){if(typeof r!="number"){if(!(r.min||r.max||r.ideal||r.exact))throw new ke(Q.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));r.min!==void 0&&Jn(r.min,"".concat(e,".min"),0,1/0),r.max!==void 0&&Jn(r.max,"".concat(e,".max"),1,1/0),r.exact!==void 0&&Jn(r.exact,"".concat(e,".exact"),1,1/0),r.ideal!==void 0&&Jn(r.ideal,"".concat(e,".ideal"),1,1/0)}else Jn(r,e,1,1/0)}function Xr(r,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,c=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(r==null)throw new ke(Q.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!BA(r,n,o,c))throw new ke(Q.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(n,",").concat(o,"].").concat(c?" ASCII characters only.":""))}function il(r,e){if(!Array.isArray(r))throw new ke(Q.INVALID_PARAMS,"".concat(e," should be an array"))}function Ai(r){return r==null}function BA(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,o=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof r=="string"&&r.length<=n&&r.length>=e&&(!o||function(c){if(typeof c!="string")return!1;for(let u=0;u<c.length;u+=1){const m=c.charCodeAt(u);if(m<0||m>255)return!1}return!0}(r))}function RD(r,e,n){if("getBigUint64"in DataView.prototype)return r.getBigUint64(e,n);const o=r.getUint32(e,n),c=r.getUint32(e+4,n),u=+!!n,m=+!n;return BigInt(o*m+c*u)<<BigInt(32)|BigInt(o*u+c*m)}function PT(r,e,n,o){if("setBigUint64"in DataView.prototype)return r.setBigUint64(e,n,o);const c=Number(n>>BigInt(32)),u=Number(n&BigInt(4294967295));r.setUint32(e,c,o),r.setUint32(e+4,u,o)}var ri,th;(function(r){r.COVERED="COVERED",r.POSITION="POSITION",r.SIZE="SIZE",r.STYLE="STYLE"})(ri||(ri={})),function(r){r.UNMOUNTED="UNMOUNTED",r.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(th||(th={}));const GA=new class{constructor(){D(this,"_clientSize",null),D(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),D(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),D(this,"getStyle",r=>window.getComputedStyle(r,null)),D(this,"checkCssVisibleProperty",r=>{var e;let n=!0;const o=this.getStyle(r),{display:c,visibility:u,opacity:m,filter:_}=o;return(c==="none"||xe(e=["hidden","collapse"]).call(e,u)||Number(m)<.1)&&(n=!1),n?(_&&_.split(" ").filter(S=>{var C;const R=S.split("(")[0];return xe(C=["brightness","blur","opacity"]).call(C,R)}).map(S=>{const[C,R]=S.split(/\(|\)/);return[C,Number(R.match(/^[0-9\.]+/))]}).forEach(S=>{const[C,R]=S;switch(C){case"brightness":(R<.1||R>3)&&(n=!1);break;case"blur":R>3&&(n=!1);break;case"opacity":R<.1&&(n=!1)}}),n):!1}),D(this,"checkPropertyUpToAllParentNodes",(r,e)=>{let n=!0,o=!0;const c=m=>e(m);let u=r;for(;u&&o;)c(u)||(n=!1,o=!1),u=u.parentElement,u||(o=!1);return n}),D(this,"checkActualCssVisibleIncludeInherit",r=>this.checkPropertyUpToAllParentNodes(r,this.checkCssVisibleProperty)),D(this,"getSizeAboutClient",r=>{const{width:e,height:n,left:o,right:c,top:u,bottom:m}=r.getBoundingClientRect(),_=this.getClientWidth(),S=this.getClientHeight();return{width:e,height:n,left:o,right:c,top:u,bottom:m,clientWidth:_,clientHeight:S,clientMin:Math.min(_,S)}}),D(this,"checkActualSize",()=>{const{width:r,height:e,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(r,e,n)}),D(this,"elementFromPoint",(r,e)=>document.elementFromPoint?document.elementFromPoint(r,e):null),D(this,"checkCoverForAPoint",(r,e,n)=>{const o=this.elementFromPoint(r,e);return o!==null&&o!==n}),D(this,"getPointPositionList",()=>{const{width:r,height:e,left:n,top:o}=this._clientSize,c=r/6,u=e/6,m=[],_=10**6;for(let S=0;S<5;S++)for(let C=0;C<5;C++){const R=(n*_+(S===0?.1:S===4?(c*S*_-1e5)/_:c*S)*_)/_,w=(o*_+(C===0?.1:C===4?(u*C*_-1e5)/_:u*C)*_)/_;m.push({x:R,y:w})}return[...m]}),D(this,"checkElementCover",r=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,r)).filter(e=>!!e).length>6),D(this,"checkSizeIsVisible",(r,e,n)=>(r>50||n/r<=10)&&(e>50||n/e<=10)),D(this,"checkSizeOfPartInClient",()=>{const{left:r,right:e,top:n,bottom:o,clientHeight:c,clientWidth:u,clientMin:m}=this._clientSize;let _,S,C,R;if(r<0)_=0;else{if(!(r<u))return!1;_=r}if(e<0)return!1;if(S=e<u?e:u,n<0)C=0;else{if(!(n<c))return!1;C=n}if(o<0)return!1;R=o<c?o:c;const w=S-_,N=R-C;return this.checkSizeIsVisible(w,N,m)}),D(this,"returnHiddenResult",r=>(this._clientSize=null,{visible:!1,reason:r})),D(this,"checkOneElementVisible",r=>{if(r instanceof HTMLElement){if(this.checkElementIsMountedOnDom(r)){if(this.checkActualCssVisibleIncludeInherit(r)){if(this._clientSize=this.getSizeAboutClient(r),this.checkElementCover(r))return this.returnHiddenResult(ri.COVERED);{const e=this.checkActualSize(),n=this.checkSizeOfPartInClient();return e&&!n?this.returnHiddenResult(ri.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(ri.SIZE)}}return this.returnHiddenResult(ri.STYLE)}return this.returnHiddenResult(th.UNMOUNTED)}return this.returnHiddenResult(th.INVALID_HTML_ELEMENT)}),D(this,"checkElementIsMountedOnDom",r=>this.checkPropertyUpToAllParentNodes(r,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function cr(r){return new TextEncoder().encode(r)}const Pi=function(r,e){const n=new Uint8Array(r.byteLength+e.byteLength);return n.set(new Uint8Array(r),0),n.set(new Uint8Array(e),r.byteLength),n},WA=async r=>{const e=function(u){const m=window.atob(u),_=new Uint8Array(new ArrayBuffer(m.length));for(let S=0;S<m.length;S+=1)_[S]=m.charCodeAt(S);return _}(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),n=await window.crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),o=cr(r),c=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},n,o);return function(u){let m="";for(let _=0;_<u.length;_+=1)m+=String.fromCharCode(u[_]);return window.btoa(m)}(new Uint8Array(c))},dn=async r=>function(e,n){let o="";return new Uint8Array(e).forEach(c=>{o+=c.toString(n).padStart(2,"0")}),o}(await crypto.subtle.digest("SHA-256",cr(r)),16);class Dt{constructor(){D(this,"_events",{}),D(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(n=>n.listener):[]}on(e,n){this._events[e]||(this._events[e]=[]);const o=this._events[e];this._indexOfListener(o,n)===-1&&o.push({listener:n,once:!1})}once(e,n){this._events[e]||(this._events[e]=[]);const o=this._events[e];this._indexOfListener(o,n)===-1&&o.push({listener:n,once:!0})}off(e,n){if(!this._events[e])return;const o=this._events[e],c=this._indexOfListener(o,n);c!==-1&&o.splice(c,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const n=this._events[e].map(m=>m);for(var o=arguments.length,c=new Array(o>1?o-1:0),u=1;u<o;u++)c[u-1]=arguments[u];for(let m=0;m<n.length;m+=1){const _=n[m];_.once&&this.off(e,_.listener),_.listener.apply(this,c||[])}}safeEmit(e){for(var n=arguments.length,o=new Array(n>1?n-1:0),c=1;c<n;c++)o[c-1]=arguments[c];[...this._events[e]||[]].forEach(u=>{u.once&&this.off(e,u.listener);try{u.listener.apply(this,o)}catch(m){console.error("safeEmit event:".concat(e," error ").concat(m==null?void 0:m.toString()))}})}_indexOfListener(e,n){let o=e.length;for(;o--;)if(e[o].listener===n)return o;return-1}}let pr=null;function Ws(){if(pr)return pr;if(window.electron)return pr=window.electron;if(!window.require)return null;try{return pr=window.require("electron"),pr}catch{return null}}var Si,wi,nh,un,hn,In,fn,us;function ih(r){return Jn(r.timeout,"config.timeout",0,1e5),Jn(r.timeoutFactor,"config.timeoutFactor",0,100,!1),Jn(r.maxRetryCount,"config.maxRetryConfig",0,1/0),Jn(r.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function Bi(r){if(!Array.isArray(r)||r.length<1)return!1;try{r.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function HA(r){return Xr(r.turnServerURL,"turnServerURL"),Xr(r.username,"username"),Xr(r.password,"password"),r.udpport&&Jn(r.udpport,"udpport",1,99999,!0),r.forceturn&&nl(r.forceturn,"forceturn"),r.security&&nl(r.security,"security"),r.tcpport&&Jn(r.tcpport,"tcpport",1,99999,!0),!0}function rh(r){return r.level!==void 0&&Rr(r.level,"level",[1,2,3]),r.delay!==void 0&&Jn(r.delay,"delay",0,3e3,!0),!0}function Ji(r,e){for(var n=arguments.length,o=new Array(n>2?n-2:0),c=2;c<n;c++)o[c-2]=arguments[c];return r.getListeners(e).length===0?Ee.reject(new ke(Q.UNEXPECTED_ERROR,"can not emit promise")):new Ee((u,m)=>{r.emit(e,...o,u,m)})}function Mn(r,e){if(r.getListeners(e).length===0)return Ee.resolve();for(var n=arguments.length,o=new Array(n>2?n-2:0),c=2;c<n;c++)o[c-2]=arguments[c];return Ji(r,e,...o)}function mo(r,e){if(r.getListeners(e).length===0)return null;for(var n=arguments.length,o=new Array(n>2?n-2:0),c=2;c<n;c++)o[c-2]=arguments[c];return Gn(r,e,...o)}function Gn(r,e){let n=null,o=null;for(var c=arguments.length,u=new Array(c>2?c-2:0),m=2;m<c;m++)u[m-2]=arguments[m];if(r.emit(e,...u,_=>{n=_},_=>{o=_}),o!==null)throw o;if(n===null)throw new ke(Q.UNEXPECTED_ERROR,"handler is not sync");return n}(function(r){r.CREATE_CLIENT="createClient",r.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",r.SET_AREA="setArea",r.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",r.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",r.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",r.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",r.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",r.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",r.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",r.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",r.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",r.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",r.START_PROXY_SERVER="Client.startProxyServer",r.STOP_PROXY_SERVER="Client.stopProxyServer",r.SET_PROXY_SERVER="Client.setProxyServer",r.SET_TURN_SERVER="Client.setTurnServer",r.SET_CLIENT_ROLE="Client.setClientRole",r.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",r.ENABLE_DUAL_STREAM="Client.enableDualStream",r.DISABLE_DUAL_STREAM="Client.disableDualStream",r.JOIN="Client.join",r.LEAVE="Client.leave",r.PUBLISH="Client.publish",r.UNPUBLISH="Client.unpublish",r.SUBSCRIBE="Client.subscribe",r.MASS_SUBSCRIBE="Client.massSubscribe",r.MASS_UNSUBSCRIBE="Client.massUnsubscribe",r.UNSUBSCRIBE="Client.unsubscribe",r.RENEW_TOKEN="Client.renewToken",r.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",r.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",r.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",r.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",r.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",r.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",r.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",r.DATACHANNEL_FAILBACK="Client._datachannelFailback",r.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",r.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",r.START_LIVE_STREAMING="Client.startLiveStreaming",r.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",r.STOP_LIVE_STREAMING="Client.stopLiveStreaming",r.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",r.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",r.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",r.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",r.SET_CONFIG_DISTRIBUTE="_configDistribute",r.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",r.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",r.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",r.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",r.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",r.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",r.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",r.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",r.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",r.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",r.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",r.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",r.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",r.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",r.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",r.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",r.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",r.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",r.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",r.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",r.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",r.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",r.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",r.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",r.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",r.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",r.STREAM_TYPE_CHANGE="streamTypeChange",r.CONNECTION_STATE_CHANGE="connectionStateChange",r.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",r.IMAGE_MODERATION_UPLOAD="imageModerationUpload"})(Si||(Si={})),function(r){r.TRACER="tracer"}(wi||(wi={})),function(r){r[r.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",r[r.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",r[r.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(nh||(nh={})),function(r){r.LEAVE="LEAVE",r.NETWORK_ERROR="NETWORK_ERROR",r.SERVER_ERROR="SERVER_ERROR",r.UID_BANNED="UID_BANNED",r.IP_BANNED="IP_BANNED",r.CHANNEL_BANNED="CHANNEL_BANNED",r.FALLBACK="FALLBACK",r.LICENSE_MISSING="LICENSE_MISSING",r.LICENSE_EXPIRED="LICENSE_EXPIRED",r.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",r.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",r.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",r.LICENSE_ILLEGAL="LICENSE_ILLEGAL",r.TOKEN_EXPIRE="TOKEN_EXPIRE"}(un||(un={})),function(r){r.CONNECTION_STATE_CHANGE="connection-state-change",r.MEDIA_RECONNECT_START="media-reconnect-start",r.MEDIA_RECONNECT_END="media-reconnect-end",r.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",r.USER_JOINED="user-joined",r.USER_LEAVED="user-left",r.USER_PUBLISHED="user-published",r.USER_UNPUBLISHED="user-unpublished",r.USER_INFO_UPDATED="user-info-updated",r.CLIENT_BANNED="client-banned",r.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",r.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",r.VOLUME_INDICATOR="volume-indicator",r.CRYPT_ERROR="crypt-error",r.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",r.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",r.NETWORK_QUALITY="network-quality",r.STREAM_TYPE_CHANGED="stream-type-changed",r.STREAM_FALLBACK="stream-fallback",r.RECEIVE_METADATA="receive-metadata",r.STREAM_MESSAGE="stream-message",r.LIVE_STREAMING_ERROR="live-streaming-error",r.LIVE_STREAMING_WARNING="live-streaming-warning",r.INJECT_STREAM_STATUS="stream-inject-status",r.EXCEPTION="exception",r.ERROR="error",r.P2P_LOST="p2p_lost",r.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",r.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",r.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",r.PUBLISHED_USER_LIST="published-user-list",r.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",r.CONTENT_INSPECT_ERROR="content-inspect-error",r.CONTENT_INSPECT_RESULT="content-inspect-result",r.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(hn||(hn={})),function(r){r.NETWORK_ERROR="NETWORK_ERROR",r.SERVER_ERROR="SERVER_ERROR",r.MULTI_IP="MULTI_IP",r.TIMEOUT="TIMEOUT",r.OFFLINE="OFFLINE",r.LEAVE="LEAVE",r.P2P_FAILED="P2P_FAILED",r.FALLBACK="FALLBACK"}(In||(In={})),function(r){r.ONLINE="ONLINE",r.OFFLINE="OFFLINE"}(fn||(fn={})),function(r){r.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",r.ONLINE="ONLINE",r.OFFLINE="OFFLINE"}(us||(us={}));const ki=new class extends Dt{set networkState(r){this.emit(us.NETWORK_STATE_CHANGE,r,this._networkState),r===fn.ONLINE?this.emit(us.ONLINE):r===fn.OFFLINE&&(this.onlineWaiter=new Ee(e=>{this.once(us.ONLINE,()=>{this.onlineWaiter=void 0,e(fn.ONLINE)})}),this.emit(us.OFFLINE)),this._networkState=r}get networkState(){return this._networkState}get isOnline(){return this._networkState===fn.ONLINE}constructor(){super(),D(this,"_moduleName","network-indicator"),D(this,"_networkState",fn.ONLINE),D(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=fn.ONLINE}),window.addEventListener("offline",()=>{this.networkState=fn.OFFLINE})}};var yD=cs,eg=Oo,kT=Pm,Zm=Da,rl=TypeError,KA=function(r){return function(e,n,o,c){yD(n);var u=eg(e),m=kT(u),_=Zm(u),S=r?_-1:0,C=r?-1:1;if(o<2)for(;;){if(S in m){c=m[S],S+=C;break}if(S+=C,r?S<0:_<=S)throw rl("Reduce of empty array with no initial value")}for(;r?S>=0:_>S;S+=C)S in m&&(c=n(c,m[S],S,u));return c}},FB={left:KA(!1),right:KA(!0)}.left;Xt({target:"Array",proto:!0,forced:!FE&&ec>79&&ec<83||!ZI("reduce")},{reduce:function(r){var e=arguments.length;return FB(this,r,e,e>1?arguments[1]:void 0)}});var Qr=sa("Array").reduce,si=ge,YA=Qr,$m=Array.prototype,sl=A(function(r){var e=r.reduce;return r===$m||si($m,r)&&e===$m.reduce?YA:e});function zA(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function sh(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?zA(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):zA(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function ef(r,e){const n=r.indexOf(e);n!==-1&&r.splice(n,1)}function tf(r){const e=[];return r.forEach(n=>{e.indexOf(n)===-1&&e.push(n)}),e}function Np(r){Ee!==void 0?Ee.resolve().then(r):setTimeout(r,0)}function sn(r){return JSON.parse(JSON.stringify(r))}function Bc(r){try{return sn(r)}catch{return r}}const dr={};function eu(r,e){dr[e]||(dr[e]=!0,r())}function ca(r){const e=window.atob(r),n=new Uint8Array(new ArrayBuffer(e.length));for(let o=0;o<e.length;o+=1)n[o]=e.charCodeAt(o);return n}function nf(r){let e="";for(let n=0;n<r.length;n+=1)e+=String.fromCharCode(r[n]);return window.btoa(e)}function ID(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];const o=sl(e).call(e,(m,_)=>m+_.length,0),c=new Uint8Array(new ArrayBuffer(o));let u=0;return e.forEach(m=>{c.set(m,u),u+=m.length}),c}function ol(r){return window.TextEncoder?new TextEncoder().encode(r).length:r.length}function AD(r){let e=0;return/DingTalk/i.test(navigator.userAgent)&&r.realFormData&&(r=r.realFormData),r.forEach(n=>{e+=typeof n=="string"?ol(n):n.size}),e+138}function jB(r){const e=new ke(Q.TIMEOUT,"timeout");return new Ee((n,o)=>{window.setTimeout(()=>o(e),r)})}function Br(r){return new Ee(e=>{window.setTimeout(e,r)})}function oi(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,r).toLowerCase();return n.length===r?"".concat(e).concat(n):"".concat(e).concat(n)+oi(r-n.length,"")}function qA(){return oi(32,"").toUpperCase()}const LT=()=>{},wD=new class{constructor(){D(this,"fnMap",new Map)}throttleByKey(r,e,n,o){for(var c=arguments.length,u=new Array(c>4?c-4:0),m=4;m<c;m++)u[m-4]=arguments[m];if(this.fnMap.has(e)){const _=this.fnMap.get(e);if(_.threshold!==n){_.fn(..._.args),clearTimeout(_.timer);const S=window.setTimeout(()=>{const C=this.fnMap.get(e);C&&C.fn(...C.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:r,threshold:n,timer:S,args:u,skipFn:o})}else _.skipFn&&_.skipFn(..._.args),this.fnMap.set(e,sh(sh({},_),{},{fn:r,args:u,skipFn:o}))}else{const _=window.setTimeout(()=>{const S=this.fnMap.get(e);S&&S.fn(...S.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:r,threshold:n,timer:_,args:u,skipFn:o})}}},MT=wD.throttleByKey.bind(wD);function oh(r){return typeof r=="object"&&r!==null&&!(r instanceof RegExp)}function tg(r,e){if(!oh(r)||!oh(e)||Array.isArray(r)&&!Array.isArray(e)||!Array.isArray(r)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(r)){const n=[...r];for(let o=0;o<e.length;o++)n[o]=tg(r[o],e[o]);return n}{const n=sh({},r);for(const o in e)Object.prototype.hasOwnProperty.call(e,o)&&(Object.prototype.hasOwnProperty.call(r,o)?n[o]=tg(r[o],e[o]):n[o]=e[o]);return n}}function UT(r,e){let n=[0];if(n=new Array(e).fill(0),r===0)return n;let o=0;for(;r>0&&(n[o]=255&r,r>>=8,o++,o!==e););return n}let JA=1,ng=console;class Zr{static setLogger(e){ng=e}constructor(e){D(this,"lockingPromise",Ee.resolve()),D(this,"locks",0),D(this,"name",""),D(this,"lockId",void 0),this.lockId=JA++,e&&(this.name=e),ng.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let n;this.locks+=1,ng.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:""));const o=new Ee(u=>{n=()=>{this.locks-=1,ng.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:"")),u()}}),c=this.lockingPromise.then(()=>n);return this.lockingPromise=this.lockingPromise.then(()=>o),c}}function ah(r,e){return function(n,o,c){const u=c.value;if(typeof u!="function")throw new Error("Cannot use mutex on object property.");return c.value=async function(){const m=this[e];if(!m)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(r));const _=await m.lock("From ".concat(r,".").concat(o));try{for(var S=arguments.length,C=new Array(S),R=0;R<S;R++)C[R]=arguments[R];return await u.apply(this,C)}finally{_()}},c}}const or={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function al(r,e){const n=Math.floor(e.timeout*Math.pow(e.timeoutFactor,r));return Math.min(e.maxRetryTimeout,n)}function dc(r,e,n,o){const c=Object.assign({},or,o);let u=c.timeout;const m=async()=>{await function(C){return new Ee(R=>{window.setTimeout(R,C)})}(u),u*=c.timeoutFactor,u=Math.min(c.maxRetryTimeout,u)};let _=!1;const S=new Ee(async(C,R)=>{e=e||(()=>!1),n=n||(()=>!0);for(let w=0;w<c.maxRetryCount;w+=1){if(_)return R(new ke(Q.OPERATION_ABORTED));try{const N=await r();if(!e(N,w)||w+1===c.maxRetryCount)return C(N);await m()}catch(N){if(!n(N,w)||w+1===c.maxRetryCount)return R(N);await m()}}});return S.cancel=()=>_=!0,S}let rf=class{constructor(r){D(this,"input",[]),D(this,"size",void 0),this.size=r}add(r){this.input.push(r),this.input.length>this.size&&this.input.splice(0,1)}mean(){var r;return this.input.length===0?0:sl(r=this.input).call(r,(e,n)=>e+n)/this.input.length}};function XA(r,e){return function(){return r.apply(e,arguments)}}const{toString:bD}=Object.prototype,{getPrototypeOf:sf}=Object,xT=(QA=Object.create(null),r=>{const e=bD.call(r);return QA[e]||(QA[e]=e.slice(8,-1).toLowerCase())});var QA;const cl=r=>(r=r.toLowerCase(),e=>xT(e)===r),VT=r=>e=>typeof e===r,{isArray:ch}=Array,ig=VT("undefined"),FT=cl("ArrayBuffer"),ZA=VT("string"),Gc=VT("function"),fo=VT("number"),tu=r=>r!==null&&typeof r=="object",rg=r=>{if(xT(r)!=="object")return!1;const e=sf(r);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||Symbol.toStringTag in r||Symbol.iterator in r)},OD=cl("Date"),BB=cl("File"),jT=cl("Blob"),ND=cl("FileList"),DD=cl("URLSearchParams");function sg(r,e,{allOwnKeys:n=!1}={}){if(r==null)return;let o,c;if(typeof r!="object"&&(r=[r]),ch(r))for(o=0,c=r.length;o<c;o++)e.call(null,r[o],o,r);else{const u=n?Object.getOwnPropertyNames(r):Object.keys(r),m=u.length;let _;for(o=0;o<m;o++)_=u[o],e.call(null,r[_],_,r)}}function PD(r,e){e=e.toLowerCase();const n=Object.keys(r);let o,c=n.length;for(;c-- >0;)if(o=n[c],e===o.toLowerCase())return o;return null}const Dp=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:lL,BT=r=>!ig(r)&&r!==Dp,kD=(GT=typeof Uint8Array<"u"&&sf(Uint8Array),r=>GT&&r instanceof GT);var GT;const LD=cl("HTMLFormElement"),WT=(({hasOwnProperty:r})=>(e,n)=>r.call(e,n))(Object.prototype),MD=cl("RegExp"),$A=(r,e)=>{const n=Object.getOwnPropertyDescriptors(r),o={};sg(n,(c,u)=>{let m;(m=e(c,u,r))!==!1&&(o[u]=m||c)}),Object.defineProperties(r,o)},HT="abcdefghijklmnopqrstuvwxyz",UD="0123456789",xD={DIGIT:UD,ALPHA:HT,ALPHA_DIGIT:HT+HT.toUpperCase()+UD},ew=cl("AsyncFunction");var _t={isArray:ch,isArrayBuffer:FT,isBuffer:function(r){return r!==null&&!ig(r)&&r.constructor!==null&&!ig(r.constructor)&&Gc(r.constructor.isBuffer)&&r.constructor.isBuffer(r)},isFormData:r=>{let e;return r&&(typeof FormData=="function"&&r instanceof FormData||Gc(r.append)&&((e=xT(r))==="formdata"||e==="object"&&Gc(r.toString)&&r.toString()==="[object FormData]"))},isArrayBufferView:function(r){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(r):r&&r.buffer&&FT(r.buffer),e},isString:ZA,isNumber:fo,isBoolean:r=>r===!0||r===!1,isObject:tu,isPlainObject:rg,isUndefined:ig,isDate:OD,isFile:BB,isBlob:jT,isRegExp:MD,isFunction:Gc,isStream:r=>tu(r)&&Gc(r.pipe),isURLSearchParams:DD,isTypedArray:kD,isFileList:ND,forEach:sg,merge:function r(){const{caseless:e}=BT(this)&&this||{},n={},o=(c,u)=>{const m=e&&PD(n,u)||u;rg(n[m])&&rg(c)?n[m]=r(n[m],c):rg(c)?n[m]=r({},c):ch(c)?n[m]=c.slice():n[m]=c};for(let c=0,u=arguments.length;c<u;c++)arguments[c]&&sg(arguments[c],o);return n},extend:(r,e,n,{allOwnKeys:o}={})=>(sg(e,(c,u)=>{n&&Gc(c)?r[u]=XA(c,n):r[u]=c},{allOwnKeys:o}),r),trim:r=>r.trim?r.trim():r.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:r=>(r.charCodeAt(0)===65279&&(r=r.slice(1)),r),inherits:(r,e,n,o)=>{r.prototype=Object.create(e.prototype,o),r.prototype.constructor=r,Object.defineProperty(r,"super",{value:e.prototype}),n&&Object.assign(r.prototype,n)},toFlatObject:(r,e,n,o)=>{let c,u,m;const _={};if(e=e||{},r==null)return e;do{for(c=Object.getOwnPropertyNames(r),u=c.length;u-- >0;)m=c[u],o&&!o(m,r,e)||_[m]||(e[m]=r[m],_[m]=!0);r=n!==!1&&sf(r)}while(r&&(!n||n(r,e))&&r!==Object.prototype);return e},kindOf:xT,kindOfTest:cl,endsWith:(r,e,n)=>{r=String(r),(n===void 0||n>r.length)&&(n=r.length),n-=e.length;const o=r.indexOf(e,n);return o!==-1&&o===n},toArray:r=>{if(!r)return null;if(ch(r))return r;let e=r.length;if(!fo(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=r[e];return n},forEachEntry:(r,e)=>{const n=(r&&r[Symbol.iterator]).call(r);let o;for(;(o=n.next())&&!o.done;){const c=o.value;e.call(r,c[0],c[1])}},matchAll:(r,e)=>{let n;const o=[];for(;(n=r.exec(e))!==null;)o.push(n);return o},isHTMLForm:LD,hasOwnProperty:WT,hasOwnProp:WT,reduceDescriptors:$A,freezeMethods:r=>{$A(r,(e,n)=>{if(Gc(r)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const o=r[n];Gc(o)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))})},toObjectSet:(r,e)=>{const n={},o=c=>{c.forEach(u=>{n[u]=!0})};return ch(r)?o(r):o(String(r).split(e)),n},toCamelCase:r=>r.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,o){return n.toUpperCase()+o}),noop:()=>{},toFiniteNumber:(r,e)=>(r=+r,Number.isFinite(r)?r:e),findKey:PD,global:Dp,isContextDefined:BT,ALPHABET:xD,generateString:(r=16,e=xD.ALPHA_DIGIT)=>{let n="";const{length:o}=e;for(;r--;)n+=e[Math.random()*o|0];return n},isSpecCompliantForm:function(r){return!!(r&&Gc(r.append)&&r[Symbol.toStringTag]==="FormData"&&r[Symbol.iterator])},toJSONObject:r=>{const e=new Array(10),n=(o,c)=>{if(tu(o)){if(e.indexOf(o)>=0)return;if(!("toJSON"in o)){e[c]=o;const u=ch(o)?[]:{};return sg(o,(m,_)=>{const S=n(m,c+1);!ig(S)&&(u[_]=S)}),e[c]=void 0,u}}return o};return n(r,0)},isAsyncFn:ew,isThenable:r=>r&&(tu(r)||Gc(r))&&Gc(r.then)&&Gc(r.catch)};function bi(r,e,n,o,c){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=r,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),o&&(this.request=o),c&&(this.response=c)}_t.inherits(bi,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:_t.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const tw=bi.prototype,nw={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(r=>{nw[r]={value:r}}),Object.defineProperties(bi,nw),Object.defineProperty(tw,"isAxiosError",{value:!0}),bi.from=(r,e,n,o,c,u)=>{const m=Object.create(tw);return _t.toFlatObject(r,m,function(_){return _!==Error.prototype},_=>_!=="isAxiosError"),bi.call(m,r.message,e,n,o,c),m.cause=r,m.name=r.name,u&&Object.assign(m,u),m};function KT(r){return _t.isPlainObject(r)||_t.isArray(r)}function iw(r){return _t.endsWith(r,"[]")?r.slice(0,-2):r}function rw(r,e,n){return r?r.concat(e).map(function(o,c){return o=iw(o),!n&&c?"["+o+"]":o}).join(n?".":""):e}const sw=_t.toFlatObject(_t,{},null,function(r){return/^is[A-Z]/.test(r)});function og(r,e,n){if(!_t.isObject(r))throw new TypeError("target must be an object");e=e||new FormData;const o=(n=_t.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(N,L){return!_t.isUndefined(L[N])})).metaTokens,c=n.visitor||C,u=n.dots,m=n.indexes,_=(n.Blob||typeof Blob<"u"&&Blob)&&_t.isSpecCompliantForm(e);if(!_t.isFunction(c))throw new TypeError("visitor must be a function");function S(N){if(N===null)return"";if(_t.isDate(N))return N.toISOString();if(!_&&_t.isBlob(N))throw new bi("Blob is not supported. Use a Buffer instead.");return _t.isArrayBuffer(N)||_t.isTypedArray(N)?_&&typeof Blob=="function"?new Blob([N]):Buffer.from(N):N}function C(N,L,H){let j=N;if(N&&!H&&typeof N=="object"){if(_t.endsWith(L,"{}"))L=o?L:L.slice(0,-2),N=JSON.stringify(N);else if(_t.isArray(N)&&function(W){return _t.isArray(W)&&!W.some(KT)}(N)||(_t.isFileList(N)||_t.endsWith(L,"[]"))&&(j=_t.toArray(N)))return L=iw(L),j.forEach(function(W,ee){!_t.isUndefined(W)&&W!==null&&e.append(m===!0?rw([L],ee,u):m===null?L:L+"[]",S(W))}),!1}return!!KT(N)||(e.append(rw(H,L,u),S(N)),!1)}const R=[],w=Object.assign(sw,{defaultVisitor:C,convertValue:S,isVisitable:KT});if(!_t.isObject(r))throw new TypeError("data must be an object");return function N(L,H){if(!_t.isUndefined(L)){if(R.indexOf(L)!==-1)throw Error("Circular reference detected in "+H.join("."));R.push(L),_t.forEach(L,function(j,W){(!(_t.isUndefined(j)||j===null)&&c.call(e,j,_t.isString(W)?W.trim():W,H,w))===!0&&N(j,H?H.concat(W):[W])}),R.pop()}}(r),e}function ow(r){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(r).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function YT(r,e){this._pairs=[],r&&og(r,this,e)}const VD=YT.prototype;function GB(r){return encodeURIComponent(r).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function aw(r,e,n){if(!e)return r;const o=n&&n.encode||GB,c=n&&n.serialize;let u;if(u=c?c(e,n):_t.isURLSearchParams(e)?e.toString():new YT(e,n).toString(o),u){const m=r.indexOf("#");m!==-1&&(r=r.slice(0,m)),r+=(r.indexOf("?")===-1?"?":"&")+u}return r}VD.append=function(r,e){this._pairs.push([r,e])},VD.toString=function(r){const e=r?function(n){return r.call(this,n,ow)}:ow;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};var FD=class{constructor(){this.handlers=[]}use(r,e,n){return this.handlers.push({fulfilled:r,rejected:e,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(r){this.handlers[r]&&(this.handlers[r]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(r){_t.forEach(this.handlers,function(e){e!==null&&r(e)})}},jD={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},zT={isBrowser:!0,classes:{URLSearchParams:typeof URLSearchParams<"u"?URLSearchParams:YT,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const BD=typeof window<"u"&&typeof document<"u",WB=(to=typeof navigator<"u"&&navigator.product,BD&&["ReactNative","NativeScript","NS"].indexOf(to)<0);var to;const GD=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function";var Ad={...Object.freeze({__proto__:null,hasBrowserEnv:BD,hasStandardBrowserEnv:WB,hasStandardBrowserWebWorkerEnv:GD}),...zT};function WD(r){function e(n,o,c,u){let m=n[u++];if(m==="__proto__")return!0;const _=Number.isFinite(+m),S=u>=n.length;return m=!m&&_t.isArray(c)?c.length:m,S?(_t.hasOwnProp(c,m)?c[m]=[c[m],o]:c[m]=o,!_):(c[m]&&_t.isObject(c[m])||(c[m]=[]),e(n,o,c[m],u)&&_t.isArray(c[m])&&(c[m]=function(C){const R={},w=Object.keys(C);let N;const L=w.length;let H;for(N=0;N<L;N++)H=w[N],R[H]=C[H];return R}(c[m])),!_)}if(_t.isFormData(r)&&_t.isFunction(r.entries)){const n={};return _t.forEachEntry(r,(o,c)=>{e(function(u){return _t.matchAll(/\w+|\[(\w*)]/g,u).map(m=>m[0]==="[]"?"":m[1]||m[0])}(o),c,n,0)}),n}return null}const cw={transitional:jD,adapter:["xhr","http"],transformRequest:[function(r,e){const n=e.getContentType()||"",o=n.indexOf("application/json")>-1,c=_t.isObject(r);if(c&&_t.isHTMLForm(r)&&(r=new FormData(r)),_t.isFormData(r))return o?JSON.stringify(WD(r)):r;if(_t.isArrayBuffer(r)||_t.isBuffer(r)||_t.isStream(r)||_t.isFile(r)||_t.isBlob(r))return r;if(_t.isArrayBufferView(r))return r.buffer;if(_t.isURLSearchParams(r))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),r.toString();let u;if(c){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(m,_){return og(m,new Ad.classes.URLSearchParams,Object.assign({visitor:function(S,C,R,w){return Ad.isNode&&_t.isBuffer(S)?(this.append(C,S.toString("base64")),!1):w.defaultVisitor.apply(this,arguments)}},_))}(r,this.formSerializer).toString();if((u=_t.isFileList(r))||n.indexOf("multipart/form-data")>-1){const m=this.env&&this.env.FormData;return og(u?{"files[]":r}:r,m&&new m,this.formSerializer)}}return c||o?(e.setContentType("application/json",!1),function(m,_,S){if(_t.isString(m))try{return(_||JSON.parse)(m),_t.trim(m)}catch(C){if(C.name!=="SyntaxError")throw C}return(0,JSON.stringify)(m)}(r)):r}],transformResponse:[function(r){const e=this.transitional||cw.transitional,n=e&&e.forcedJSONParsing,o=this.responseType==="json";if(r&&_t.isString(r)&&(n&&!this.responseType||o)){const c=!(e&&e.silentJSONParsing)&&o;try{return JSON.parse(r)}catch(u){if(c)throw u.name==="SyntaxError"?bi.from(u,bi.ERR_BAD_RESPONSE,this,null,this.response):u}}return r}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Ad.classes.FormData,Blob:Ad.classes.Blob},validateStatus:function(r){return r>=200&&r<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};_t.forEach(["delete","get","head","post","put","patch"],r=>{cw.headers[r]={}});var dw=cw;const HD=_t.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),lw=Symbol("internals");function dh(r){return r&&String(r).trim().toLowerCase()}function ag(r){return r===!1||r==null?r:_t.isArray(r)?r.map(ag):String(r)}function qT(r,e,n,o,c){return _t.isFunction(o)?o.call(this,e,n):(c&&(e=n),_t.isString(e)?_t.isString(o)?e.indexOf(o)!==-1:_t.isRegExp(o)?o.test(e):void 0:void 0)}class of{constructor(e){e&&this.set(e)}set(e,n,o){const c=this;function u(_,S,C){const R=dh(S);if(!R)throw new Error("header name must be a non-empty string");const w=_t.findKey(c,R);(!w||c[w]===void 0||C===!0||C===void 0&&c[w]!==!1)&&(c[w||S]=ag(_))}const m=(_,S)=>_t.forEach(_,(C,R)=>u(C,R,S));return _t.isPlainObject(e)||e instanceof this.constructor?m(e,n):_t.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim())?m((_=>{const S={};let C,R,w;return _&&_.split(`
`).forEach(function(N){w=N.indexOf(":"),C=N.substring(0,w).trim().toLowerCase(),R=N.substring(w+1).trim(),!C||S[C]&&HD[C]||(C==="set-cookie"?S[C]?S[C].push(R):S[C]=[R]:S[C]=S[C]?S[C]+", "+R:R)}),S})(e),n):e!=null&&u(n,e,o),this}get(e,n){if(e=dh(e)){const o=_t.findKey(this,e);if(o){const c=this[o];if(!n)return c;if(n===!0)return function(u){const m=Object.create(null),_=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let S;for(;S=_.exec(u);)m[S[1]]=S[2];return m}(c);if(_t.isFunction(n))return n.call(this,c,o);if(_t.isRegExp(n))return n.exec(c);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=dh(e)){const o=_t.findKey(this,e);return!(!o||this[o]===void 0||n&&!qT(0,this[o],o,n))}return!1}delete(e,n){const o=this;let c=!1;function u(m){if(m=dh(m)){const _=_t.findKey(o,m);!_||n&&!qT(0,o[_],_,n)||(delete o[_],c=!0)}}return _t.isArray(e)?e.forEach(u):u(e),c}clear(e){const n=Object.keys(this);let o=n.length,c=!1;for(;o--;){const u=n[o];e&&!qT(0,this[u],u,e,!0)||(delete this[u],c=!0)}return c}normalize(e){const n=this,o={};return _t.forEach(this,(c,u)=>{const m=_t.findKey(o,u);if(m)return n[m]=ag(c),void delete n[u];const _=e?function(S){return S.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(C,R,w)=>R.toUpperCase()+w)}(u):String(u).trim();_!==u&&delete n[u],n[_]=ag(c),o[_]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const n=Object.create(null);return _t.forEach(this,(o,c)=>{o!=null&&o!==!1&&(n[c]=e&&_t.isArray(o)?o.join(", "):o)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,n])=>e+": "+n).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...n){const o=new this(e);return n.forEach(c=>o.set(c)),o}static accessor(e){const n=(this[lw]=this[lw]={accessors:{}}).accessors,o=this.prototype;function c(u){const m=dh(u);n[m]||(function(_,S){const C=_t.toCamelCase(" "+S);["get","set","has"].forEach(R=>{Object.defineProperty(_,R+C,{value:function(w,N,L){return this[R].call(this,S,w,N,L)},configurable:!0})})}(o,u),n[m]=!0)}return _t.isArray(e)?e.forEach(c):c(e),this}}of.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),_t.reduceDescriptors(of.prototype,({value:r},e)=>{let n=e[0].toUpperCase()+e.slice(1);return{get:()=>r,set(o){this[n]=o}}}),_t.freezeMethods(of);var nu=of;function uw(r,e){const n=this||dw,o=e||n,c=nu.from(o.headers);let u=o.data;return _t.forEach(r,function(m){u=m.call(n,u,c.normalize(),e?e.status:void 0)}),c.normalize(),u}function hw(r){return!(!r||!r.__CANCEL__)}function af(r,e,n){bi.call(this,r??"canceled",bi.ERR_CANCELED,e,n),this.name="CanceledError"}_t.inherits(af,bi,{__CANCEL__:!0});var pw=Ad.hasStandardBrowserEnv?{write(r,e,n,o,c,u){const m=[r+"="+encodeURIComponent(e)];_t.isNumber(n)&&m.push("expires="+new Date(n).toGMTString()),_t.isString(o)&&m.push("path="+o),_t.isString(c)&&m.push("domain="+c),u===!0&&m.push("secure"),document.cookie=m.join("; ")},read(r){const e=document.cookie.match(new RegExp("(^|;\\s*)("+r+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(r){this.write(r,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function KD(r,e){return r&&!function(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}(e)?function(n,o){return o?n.replace(/\/?\/$/,"")+"/"+o.replace(/^\/+/,""):n}(r,e):e}var HB=Ad.hasStandardBrowserEnv?function(){const r=/(msie|trident)/i.test(navigator.userAgent),e=document.createElement("a");let n;function o(c){let u=c;return r&&(e.setAttribute("href",u),u=e.href),e.setAttribute("href",u),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:e.pathname.charAt(0)==="/"?e.pathname:"/"+e.pathname}}return n=o(window.location.href),function(c){const u=_t.isString(c)?o(c):c;return u.protocol===n.protocol&&u.host===n.host}}():function(){return!0};function YD(r,e){let n=0;const o=function(c,u){c=c||10;const m=new Array(c),_=new Array(c);let S,C=0,R=0;return u=u!==void 0?u:1e3,function(w){const N=Date.now(),L=_[R];S||(S=N),m[C]=w,_[C]=N;let H=R,j=0;for(;H!==C;)j+=m[H++],H%=c;if(C=(C+1)%c,C===R&&(R=(R+1)%c),N-S<u)return;const W=L&&N-L;return W?Math.round(1e3*j/W):void 0}}(50,250);return c=>{const u=c.loaded,m=c.lengthComputable?c.total:void 0,_=u-n,S=o(_);n=u;const C={loaded:u,total:m,progress:m?u/m:void 0,bytes:_,rate:S||void 0,estimated:S&&m&&u<=m?(m-u)/S:void 0,event:c};C[e?"download":"upload"]=!0,r(C)}}var mw=typeof XMLHttpRequest<"u"&&function(r){return new Promise(function(e,n){let o=r.data;const c=nu.from(r.headers).normalize();let u,m,{responseType:_,withXSRFToken:S}=r;function C(){r.cancelToken&&r.cancelToken.unsubscribe(u),r.signal&&r.signal.removeEventListener("abort",u)}if(_t.isFormData(o)){if(Ad.hasStandardBrowserEnv||Ad.hasStandardBrowserWebWorkerEnv)c.setContentType(!1);else if((m=c.getContentType())!==!1){const[H,...j]=m?m.split(";").map(W=>W.trim()).filter(Boolean):[];c.setContentType([H||"multipart/form-data",...j].join("; "))}}let R=new XMLHttpRequest;if(r.auth){const H=r.auth.username||"",j=r.auth.password?unescape(encodeURIComponent(r.auth.password)):"";c.set("Authorization","Basic "+btoa(H+":"+j))}const w=KD(r.baseURL,r.url);function N(){if(!R)return;const H=nu.from("getAllResponseHeaders"in R&&R.getAllResponseHeaders());(function(j,W,ee){const re=ee.config.validateStatus;ee.status&&re&&!re(ee.status)?W(new bi("Request failed with status code "+ee.status,[bi.ERR_BAD_REQUEST,bi.ERR_BAD_RESPONSE][Math.floor(ee.status/100)-4],ee.config,ee.request,ee)):j(ee)})(function(j){e(j),C()},function(j){n(j),C()},{data:_&&_!=="text"&&_!=="json"?R.response:R.responseText,status:R.status,statusText:R.statusText,headers:H,config:r,request:R}),R=null}if(R.open(r.method.toUpperCase(),aw(w,r.params,r.paramsSerializer),!0),R.timeout=r.timeout,"onloadend"in R?R.onloadend=N:R.onreadystatechange=function(){R&&R.readyState===4&&(R.status!==0||R.responseURL&&R.responseURL.indexOf("file:")===0)&&setTimeout(N)},R.onabort=function(){R&&(n(new bi("Request aborted",bi.ECONNABORTED,r,R)),R=null)},R.onerror=function(){n(new bi("Network Error",bi.ERR_NETWORK,r,R)),R=null},R.ontimeout=function(){let H=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const j=r.transitional||jD;r.timeoutErrorMessage&&(H=r.timeoutErrorMessage),n(new bi(H,j.clarifyTimeoutError?bi.ETIMEDOUT:bi.ECONNABORTED,r,R)),R=null},Ad.hasStandardBrowserEnv&&(S&&_t.isFunction(S)&&(S=S(r)),S||S!==!1&&HB(w))){const H=r.xsrfHeaderName&&r.xsrfCookieName&&pw.read(r.xsrfCookieName);H&&c.set(r.xsrfHeaderName,H)}o===void 0&&c.setContentType(null),"setRequestHeader"in R&&_t.forEach(c.toJSON(),function(H,j){R.setRequestHeader(j,H)}),_t.isUndefined(r.withCredentials)||(R.withCredentials=!!r.withCredentials),_&&_!=="json"&&(R.responseType=r.responseType),typeof r.onDownloadProgress=="function"&&R.addEventListener("progress",YD(r.onDownloadProgress,!0)),typeof r.onUploadProgress=="function"&&R.upload&&R.upload.addEventListener("progress",YD(r.onUploadProgress)),(r.cancelToken||r.signal)&&(u=H=>{R&&(n(!H||H.type?new af(null,r,R):H),R.abort(),R=null)},r.cancelToken&&r.cancelToken.subscribe(u),r.signal&&(r.signal.aborted?u():r.signal.addEventListener("abort",u)));const L=function(H){const j=/^([-+\w]{1,25})(:?\/\/|:)/.exec(H);return j&&j[1]||""}(w);L&&Ad.protocols.indexOf(L)===-1?n(new bi("Unsupported protocol "+L+":",bi.ERR_BAD_REQUEST,r)):R.send(o||null)})};const JT={http:null,xhr:mw};_t.forEach(JT,(r,e)=>{if(r){try{Object.defineProperty(r,"name",{value:e})}catch{}Object.defineProperty(r,"adapterName",{value:e})}});const fw=r=>`- ${r}`,lc=r=>_t.isFunction(r)||r===null||r===!1;var _w={getAdapter:r=>{r=_t.isArray(r)?r:[r];const{length:e}=r;let n,o;const c={};for(let u=0;u<e;u++){let m;if(n=r[u],o=n,!lc(n)&&(o=JT[(m=String(n)).toLowerCase()],o===void 0))throw new bi(`Unknown adapter '${m}'`);if(o)break;c[m||"#"+u]=o}if(!o){const u=Object.entries(c).map(([m,_])=>`adapter ${m} `+(_===!1?"is not supported by the environment":"is not available in the build"));throw new bi("There is no suitable adapter to dispatch the request "+(e?u.length>1?`since :
`+u.map(fw).join(`
`):" "+fw(u[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return o},adapters:JT};function XT(r){if(r.cancelToken&&r.cancelToken.throwIfRequested(),r.signal&&r.signal.aborted)throw new af(null,r)}function zD(r){return XT(r),r.headers=nu.from(r.headers),r.data=uw.call(r,r.transformRequest),["post","put","patch"].indexOf(r.method)!==-1&&r.headers.setContentType("application/x-www-form-urlencoded",!1),_w.getAdapter(r.adapter||dw.adapter)(r).then(function(e){return XT(r),e.data=uw.call(r,r.transformResponse,e),e.headers=nu.from(e.headers),e},function(e){return hw(e)||(XT(r),e&&e.response&&(e.response.data=uw.call(r,r.transformResponse,e.response),e.response.headers=nu.from(e.response.headers))),Promise.reject(e)})}const iu=r=>r instanceof nu?r.toJSON():r;function lh(r,e){e=e||{};const n={};function o(C,R,w){return _t.isPlainObject(C)&&_t.isPlainObject(R)?_t.merge.call({caseless:w},C,R):_t.isPlainObject(R)?_t.merge({},R):_t.isArray(R)?R.slice():R}function c(C,R,w){return _t.isUndefined(R)?_t.isUndefined(C)?void 0:o(void 0,C,w):o(C,R,w)}function u(C,R){if(!_t.isUndefined(R))return o(void 0,R)}function m(C,R){return _t.isUndefined(R)?_t.isUndefined(C)?void 0:o(void 0,C):o(void 0,R)}function _(C,R,w){return w in e?o(C,R):w in r?o(void 0,C):void 0}const S={url:u,method:u,data:u,baseURL:m,transformRequest:m,transformResponse:m,paramsSerializer:m,timeout:m,timeoutMessage:m,withCredentials:m,withXSRFToken:m,adapter:m,responseType:m,xsrfCookieName:m,xsrfHeaderName:m,onUploadProgress:m,onDownloadProgress:m,decompress:m,maxContentLength:m,maxBodyLength:m,beforeRedirect:m,transport:m,httpAgent:m,httpsAgent:m,cancelToken:m,socketPath:m,responseEncoding:m,validateStatus:_,headers:(C,R)=>c(iu(C),iu(R),!0)};return _t.forEach(Object.keys(Object.assign({},r,e)),function(C){const R=S[C]||c,w=R(r[C],e[C],C);_t.isUndefined(w)&&R!==_||(n[C]=w)}),n}const Ew="1.6.7",QT={};["object","boolean","number","function","string","symbol"].forEach((r,e)=>{QT[r]=function(n){return typeof n===r||"a"+(e<1?"n ":" ")+r}});const gw={};QT.transitional=function(r,e,n){function o(c,u){return"[Axios v"+Ew+"] Transitional option '"+c+"'"+u+(n?". "+n:"")}return(c,u,m)=>{if(r===!1)throw new bi(o(u," has been removed"+(e?" in "+e:"")),bi.ERR_DEPRECATED);return e&&!gw[u]&&(gw[u]=!0,console.warn(o(u," has been deprecated since v"+e+" and will be removed in the near future"))),!r||r(c,u,m)}};var ZT={assertOptions:function(r,e,n){if(typeof r!="object")throw new bi("options must be an object",bi.ERR_BAD_OPTION_VALUE);const o=Object.keys(r);let c=o.length;for(;c-- >0;){const u=o[c],m=e[u];if(m){const _=r[u],S=_===void 0||m(_,u,r);if(S!==!0)throw new bi("option "+u+" must be "+S,bi.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new bi("Unknown option "+u,bi.ERR_BAD_OPTION)}},validators:QT};const ru=ZT.validators;let cg=class{constructor(r){this.defaults=r,this.interceptors={request:new FD,response:new FD}}async request(r,e){try{return await this._request(r,e)}catch(n){if(n instanceof Error){let o;Error.captureStackTrace?Error.captureStackTrace(o={}):o=new Error;const c=o.stack?o.stack.replace(/^.+\n/,""):"";n.stack?c&&!String(n.stack).endsWith(c.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+c):n.stack=c}throw n}}_request(r,e){typeof r=="string"?(e=e||{}).url=r:e=r||{},e=lh(this.defaults,e);const{transitional:n,paramsSerializer:o,headers:c}=e;n!==void 0&&ZT.assertOptions(n,{silentJSONParsing:ru.transitional(ru.boolean),forcedJSONParsing:ru.transitional(ru.boolean),clarifyTimeoutError:ru.transitional(ru.boolean)},!1),o!=null&&(_t.isFunction(o)?e.paramsSerializer={serialize:o}:ZT.assertOptions(o,{encode:ru.function,serialize:ru.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let u=c&&_t.merge(c.common,c[e.method]);c&&_t.forEach(["delete","get","head","post","put","patch","common"],L=>{delete c[L]}),e.headers=nu.concat(u,c);const m=[];let _=!0;this.interceptors.request.forEach(function(L){typeof L.runWhen=="function"&&L.runWhen(e)===!1||(_=_&&L.synchronous,m.unshift(L.fulfilled,L.rejected))});const S=[];let C;this.interceptors.response.forEach(function(L){S.push(L.fulfilled,L.rejected)});let R,w=0;if(!_){const L=[zD.bind(this),void 0];for(L.unshift.apply(L,m),L.push.apply(L,S),R=L.length,C=Promise.resolve(e);w<R;)C=C.then(L[w++],L[w++]);return C}R=m.length;let N=e;for(w=0;w<R;){const L=m[w++],H=m[w++];try{N=L(N)}catch(j){H.call(this,j);break}}try{C=zD.call(this,N)}catch(L){return Promise.reject(L)}for(w=0,R=S.length;w<R;)C=C.then(S[w++],S[w++]);return C}getUri(r){return aw(KD((r=lh(this.defaults,r)).baseURL,r.url),r.params,r.paramsSerializer)}};_t.forEach(["delete","get","head","options"],function(r){cg.prototype[r]=function(e,n){return this.request(lh(n||{},{method:r,url:e,data:(n||{}).data}))}}),_t.forEach(["post","put","patch"],function(r){function e(n){return function(o,c,u){return this.request(lh(u||{},{method:r,headers:n?{"Content-Type":"multipart/form-data"}:{},url:o,data:c}))}}cg.prototype[r]=e(),cg.prototype[r+"Form"]=e(!0)});var dg=cg;class Sw{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(c){n=c});const o=this;this.promise.then(c=>{if(!o._listeners)return;let u=o._listeners.length;for(;u-- >0;)o._listeners[u](c);o._listeners=null}),this.promise.then=c=>{let u;const m=new Promise(_=>{o.subscribe(_),u=_}).then(c);return m.cancel=function(){o.unsubscribe(u)},m},e(function(c,u,m){o.reason||(o.reason=new af(c,u,m),n(o.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}static source(){let e;return{token:new Sw(function(n){e=n}),cancel:e}}}var qD=Sw;const Tw={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Tw).forEach(([r,e])=>{Tw[e]=r});var JD=Tw;const Ps=function r(e){const n=new dg(e),o=XA(dg.prototype.request,n);return _t.extend(o,dg.prototype,n,{allOwnKeys:!0}),_t.extend(o,n,null,{allOwnKeys:!0}),o.create=function(c){return r(lh(e,c))},o}(dw);Ps.Axios=dg,Ps.CanceledError=af,Ps.CancelToken=qD,Ps.isCancel=hw,Ps.VERSION=Ew,Ps.toFormData=og,Ps.AxiosError=bi,Ps.Cancel=Ps.CanceledError,Ps.all=function(r){return Promise.all(r)},Ps.spread=function(r){return function(e){return r.apply(null,e)}},Ps.isAxiosError=function(r){return _t.isObject(r)&&r.isAxiosError===!0},Ps.mergeConfig=lh,Ps.AxiosHeaders=nu,Ps.formToJSON=r=>WD(_t.isHTMLForm(r)?new FormData(r):r),Ps.getAdapter=_w.getAdapter,Ps.HttpStatusCode=JD,Ps.default=Ps;var no=Ps;function XD(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Cw(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?XD(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):XD(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}let su,ou=0,$T=0;function vw(r,e,n,o){return new Ee((c,u)=>{e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),ou+=ol(e.data)):n&&(e.data.size?ou+=e.data.size:e.data instanceof FormData?ou+=AD(e.data):ou+=ol(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=r,no.request(e).then(m=>{typeof m.data=="string"?$T+=ol(m.data):m.data instanceof ArrayBuffer||m.data instanceof Uint8Array?$T+=m.data.byteLength:$T+=ol(JSON.stringify(m.data)),c(m.data)}).catch(m=>{no.isCancel(m)?u(new ke(Q.OPERATION_ABORTED,"cancel token canceled")):m.code==="ECONNABORTED"?u(new ke(Q.NETWORK_TIMEOUT,m.message)):m.response?u(new ke(Q.NETWORK_RESPONSE_ERROR,m.response.status)):u(new ke(Q.NETWORK_ERROR,m.message))})})}async function eC(r,e){const n=new Blob([e.data],{type:"buffer"});return await vw(r,Cw(Cw({},e),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const KB=()=>(su||su||(su=(window.location.protocol.split(":")[0]||"").toUpperCase(),su))==="HTTPS",da=()=>window.isSecureContext!==void 0,mr=function(r){if(r.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return r;const e=r.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){const o=e[1],c=e[2];return"".concat(o,".").concat(c)}const n=r.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(n&&n[1]&&n[2]){const o=n[1],c=n[2];return"".concat(o,".").concat(100*(Number(c)+1))}return"4.0.0.999"}("4.20.2"),tC=function(){try{return JSON.parse("true")===!0}catch{return!0}}();var dl;(function(r){r.Default="default",r.Auto="auto",r.Relay="relay",r.SdRtn="sd-rtn"})(dl||(dl={}));const cf="v4.20.2-0-g8ae7fdad(3/20/2024, 4:48:46 PM)",Ss={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],PLUGIN_INFO:[]};function Kn(r,e,n){var o,c;xe(o=Object.keys(Ss)).call(o,r)&&(!n&&xe(c=Object.keys(uh)).call(c,r)||(Ss[r]=e,r==="ENABLE_VIDEO_SEI"&&e===!0&&(Ss.ENABLE_ENCODED_TRANSFORM=!0)))}function oe(r){return Ss[r]}const uh={};function QD(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function It(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?QD(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):QD(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}var Gt;(function(r){r.SET_SESSION_ID="SET_SESSION_ID",r.SET_P2P_ID="SET_P2P_id",r.SET_DC_ID="SET_DC_id",r.SET_UID="SET_UID",r.SET_INT_UID="SET_INT_UID",r.SET_PUB_ID="SET_PUB_ID",r.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",r.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",r.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",r.AVOID_JOIN_START="AVOID_JOIN_START",r.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",r.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",r.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",r.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",r.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",r.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",r.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",r.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",r.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",r.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",r.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",r.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",r.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",r.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",r.RESET_KEY_METRICS="RESET_KEY_METRICS",r.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",r.SET_USE_P2P="SET_USE_P2P",r.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE"})(Gt||(Gt={}));class Rw{constructor(e,n,o,c){D(this,"state",void 0),this.state={codec:e,audioCodec:n,mode:o,clientId:c,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:dl.Default}}dispatch(e){this.state=function(n,o){switch(o.type){case Gt.SET_SESSION_ID:return It(It({},n),{},{sessionId:o.sessionId});case Gt.SET_P2P_ID:return It(It({},n),{},{p2pId:o.p2pId});case Gt.SET_UID:return It(It({},n),{},{uid:o.uid});case Gt.SET_INT_UID:return It(It({},n),{},{intUid:o.intUid});case Gt.SET_PUB_ID:return It(It({},n),{},{pubId:o.pubId});case Gt.KEY_METRIC_CLIENT_CREATED:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{clientCreated:o.metric})});case Gt.KEY_METRIC_JOIN_START:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{joinStart:o.metric})});case Gt.AVOID_JOIN_START:return It(It({},n),{},{avoidJoinStart:o.avoidJoinStart});case Gt.KEY_METRIC_JOIN_END:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{joinEnd:o.metric})});case Gt.KEY_METRIC_REQUEST_AP_START:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{requestAPStart:o.metric})});case Gt.KEY_METRIC_REQUEST_AP_END:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{requestAPEnd:o.metric})});case Gt.KEY_METRIC_JOIN_GATEWAY_START:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{joinGatewayStart:o.metric})});case Gt.KEY_METRIC_JOIN_GATEWAY_END:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{joinGatewayEnd:o.metric})});case Gt.KEY_METRIC_PEER_CONNECTION_START:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{peerConnectionStart:o.metric})});case Gt.KEY_METRIC_PEER_CONNECTION_END:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{peerConnectionEnd:o.metric})});case Gt.KEY_METRIC_DESCRIPTION_START:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{descriptionStart:o.metric})});case Gt.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{signalChannelOpen:o.metric})});case Gt.KEY_METRIC_ICE_CONNECTION_END:return It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{iceConnectionEnd:o.metric})});case Gt.KEY_METRIC_PUBLISH:{const c=n.keyMetrics.publish,u=c.findIndex(m=>m.trackId===o.metric.trackId);return u!==-1?(c[u]=It(It({},c[u]),o.metric),It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{publish:[...c]})})):It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{publish:[...n.keyMetrics.publish,o.metric]})})}case Gt.KEY_METRIC_SUBSCRIBE:{const c=n.keyMetrics.subscribe,u=c.findIndex(m=>m.userId===o.metric.userId&&m.type===o.metric.type);return u!==-1?(c[u]=It(It({},c[u]),o.metric),It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{subscribe:[...c]})})):It(It({},n),{},{keyMetrics:It(It({},n.keyMetrics),{},{subscribe:[...n.keyMetrics.subscribe,o.metric]})})}case Gt.SET_CLOUD_PROXY_SERVER_MODE:return n.cloudProxyServerMode=o.mode,n;case Gt.RECORD_JOIN_CHANNEL_SERVICE:return typeof o.index!="number"?n.joinChannelServiceRecords=[...n.joinChannelServiceRecords,o.record]:(n.joinChannelServiceRecords[o.index]=It(It({},n.joinChannelServiceRecords[o.index]),o.record),n.joinChannelServiceRecords=[...n.joinChannelServiceRecords]),n;case Gt.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return n.joinChannelServiceRecords=[],n;case Gt.RESET_KEY_METRICS:return n.keyMetrics={publish:[],subscribe:[]},n;case Gt.SET_USE_DATACHANNEL:return It(It({},n),{},{useDataChannel:o.val});case Gt.SET_USE_P2P:return It(It({},n),{},{useP2P:o.val});case Gt.SET_TRANSPORT_TYPE:return It(It({},n),{},{p2pTransport:o.val});default:return n}}(this.state,e)}set sessionId(e){this.dispatch({type:Gt.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:Gt.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:Gt.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:Gt.SET_UID,uid:e})}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:Gt.SET_INT_UID,intUid:e})}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:Gt.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:Gt.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:Gt.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:Gt.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:Gt.SET_TRANSPORT_TYPE,val:e})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:Gt.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Gt.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:Gt.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Gt.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Gt.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Gt.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Gt.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Gt.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Gt.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:Gt.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Gt.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Gt.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,n,o,c){this.dispatch({type:Gt.KEY_METRIC_PUBLISH,metric:It(It({trackId:e,type:n},o&&{publishStart:o}),c&&{publishEnd:c})})}subscribe(e,n,o,c,u,m,_){this.dispatch({type:Gt.KEY_METRIC_SUBSCRIBE,metric:It(It(It(It(It({userId:e,type:n},o&&{subscribeStart:o}),c&&{subscribeEnd:c}),u&&{firstFrame:u}),m&&{streamAdded:m}),_&&{firstDecoded:_})})}massSubscribe(e,n,o,c){e.forEach(u=>{this.dispatch({type:Gt.KEY_METRIC_SUBSCRIBE,metric:It(It(It({userId:u.userId,type:u.type},n&&{subscribeStart:n}),o&&{subscribeEnd:o}),c&&{firstFrame:c})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,n){e.service==="gateway"&&Array.isArray(e.urls)&&(e.urls=e.urls.map(o=>o.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof n!="number"?(this.dispatch({type:Gt.RECORD_JOIN_CHANNEL_SERVICE,record:It(It({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(n<0||n>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Gt.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:n}),n)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Gt.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Gt.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:Gt.AVOID_JOIN_START,avoidJoinStart:e})}}var Ko,nC;(function(r){r.h264="h264",r.h265="h265",r.vp8="vp8",r.vp9="vp9",r.av1="av1"})(Ko||(Ko={})),function(r){r.opus="opus",r.pcma="pcma",r.pcmu="pcmu",r.g722="g722"}(nC||(nC={}));const io=128,ei=96,ce=1e3,uc=10;let ZD=0;const yt=new class extends Dt{reportLogUploadError(r){this.emit("REPORT_LOG_UPLOAD",r)}};class pn{constructor(e){D(this,"logger",void 0),D(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];this.logger.debug(...this.prefixLists,...n)}info(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];this.logger.info(...this.prefixLists,...n)}warning(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];this.logger.warning(...this.prefixLists,...n)}error(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];this.logger.error(...this.prefixLists,...n)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function yw(){const r=new Date;return r.toTimeString().split(" ")[0]+":"+r.getMilliseconds()}function au(){const r=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+r.getUTCMilliseconds():r.toTimeString().split(" ")[0]+":"+r.getMilliseconds()}const La={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Pp=Date.now(),lg=r=>{for(const e in La)if(Object.prototype.hasOwnProperty.call(La,e)&&La[e]===r)return e;return"DEFAULT"},M=new class{constructor(){D(this,"proxyServerURL",void 0),D(this,"logLevel",La.DEBUG),D(this,"uploadState","collecting"),D(this,"uploadLogWaitingList",[]),D(this,"uploadLogUploadingList",[]),D(this,"uploadErrorCount",0),D(this,"currentLogID",0),D(this,"url",void 0),D(this,"extLog",(r,e)=>{this.appendLogToWaitingList(r,...e)})}debug(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];const o=[La.DEBUG].concat(e);this.log.apply(this,o)}info(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];const o=[La.INFO].concat(e);this.log.apply(this,o)}warning(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];const o=[La.WARNING].concat(e);this.log.apply(this,o)}warn(){this.warning(...arguments)}error(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];const o=[La.ERROR].concat(e);this.log.apply(this,o)}upload(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];const o=[La.DEBUG].concat(e);this.uploadLog.apply(this,o)}setLogLevel(r){r=Math.min(Math.max(0,r),4),this.logLevel=r}enableLogUpload(){Kn("UPLOAD_LOG",!0)}disableLogUpload(){Kn("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(r){this.proxyServerURL=r}prefix(r){return new pn(this).prefix(r)}log(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];if(Date.now()-Pp<100)return void setTimeout(()=>{this.log(...e)},Date.now()-Pp);const o=Math.max(0,Math.min(4,e[0]));if(e[0]=yw()+" Agora-SDK [".concat(lg(o),"]:"),this.appendLogToWaitingList(o,...e),o<this.logLevel)return;const c=yw()+" %cAgora-SDK [".concat(lg(o),"]:");let u=[];if(!oe("USE_NEW_LOG"))switch(o){case La.DEBUG:u=[c,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,u);break;case La.INFO:u=[c,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,u);break;case La.WARNING:u=[c,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,u);break;case La.ERROR:u=[c,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,u)}}uploadLog(){for(var r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];if(Date.now()-Pp<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-Pp);const o=Math.max(0,Math.min(4,e[0]));e[0]=yw()+" Agora-SDK [".concat(lg(o),"]:"),this.appendLogToWaitingList(o,...e)}appendLogToWaitingList(r){if(!oe("UPLOAD_LOG"))return;for(var e=arguments.length,n=new Array(e>1?e-1:0),o=1;o<e;o++)n[o-1]=arguments[o];Array.isArray(n[0])?n[0][0]=au()+" Agora-SDK [".concat(lg(r),"]:"):n[0]=au()+" Agora-SDK [".concat(lg(r),"]:");let c="";n.forEach(u=>{typeof u=="object"&&(u=JSON.stringify(u)),c+="".concat(u," ")}),this.uploadLogWaitingList.push({payload_str:c,log_level:r,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const r=this.uploadLogUploadingList,e={sdk_version:mr,process_id:oe("PROCESS_ID"),payload:JSON.stringify(r)};return dc(async()=>{const n=await no.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(oe("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(oe("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(n.data!=="OK"){const o=new Error("unexpected upload log response");throw o.response=n,o}},()=>(this.uploadLogUploadingList=[],!1),n=>(n.response?yt.reportLogUploadError({status:n.response.status,data:n.response.data,headers:n.response.headers,message:n.message}):n.request?yt.reportLogUploadError({status:n.request.status,message:n.message}):yt.reportLogUploadError({status:-1,message:n.message}),!0),{timeout:oe("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:oe("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,oe("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),oe("UPLOAD_LOG_INTERVAL"))}).catch(r=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),oe("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),oe("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var Iw,Ma;function iC(r){return Xr(r.reportId,"params.reportId",0,100,!1),Xr(r.category,"params.category",0,100,!1),Xr(r.event,"params.event",0,100,!1),Xr(r.label,"params.label",0,100,!1),Jn(r.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(function(r){r.FREE="free",r.UPLOADING="uploading"})(Iw||(Iw={})),function(r){r[r.MISC=0]="MISC",r[r.INTERNAL_EVENT=1]="INTERNAL_EVENT",r[r.PUBLIC_EVENT=2]="PUBLIC_EVENT",r[r.WEB_EVENT=3]="WEB_EVENT",r[r.INTERNAL_API=4]="INTERNAL_API",r[r.WEB_API=5]="WEB_API",r[r.PUBLIC_API=6]="PUBLIC_API"}(Ma||(Ma={}));const ug={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var x,pi,Aw,$D;function eP(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function kt(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?eP(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):eP(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}(function(r){r.PUBLISH="publish",r.SUBSCRIBE="subscribe",r.WS_COMPRESSOR_INIT="ws_compressor_init",r.SESSION_INIT="session_init",r.JOIN_CHOOSE_SERVER="join_choose_server",r.REQ_USER_ACCOUNT="req_user_account",r.JOIN_GATEWAY="join_gateway",r.REJOIN_GATEWAY="rejoin_gateway",r.STREAM_SWITCH="stream_switch",r.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",r.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",r.FIRST_VIDEO_RECEIVED="first_video_received",r.FIRST_AUDIO_RECEIVED="first_audio_received",r.FIRST_VIDEO_DECODE="first_video_decode",r.FIRST_AUDIO_DECODE="first_audio_decode",r.ON_ADD_AUDIO_STREAM="on_add_audio_stream",r.ON_ADD_VIDEO_STREAM="on_add_video_stream",r.ON_UPDATE_STREAM="on_update_stream",r.ON_REMOVE_STREAM="on_remove_stream",r.USER_ANALYTICS="req_user_analytics",r.PC_STATS="pc_stats",r.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities"})(x||(x={})),function(r){r.SESSION="io.agora.pb.Wrtc.Session",r.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",r.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",r.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",r.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",r.PUBLISH="io.agora.pb.Wrtc.Publish",r.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",r.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",r.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",r.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",r.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",r.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",r.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",r.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",r.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",r.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",r.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",r.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",r.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",r.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",r.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",r.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",r.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",r.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",r.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",r.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",r.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",r.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",r.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",r.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",r.PC_STATS="io.agora.pb.Wrtc.PCStats",r.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities"}(pi||(pi={})),function(r){r[r.WORKER_EVENT=156]="WORKER_EVENT",r[r.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(Aw||(Aw={})),function(r){r[r.SESSION=26]="SESSION",r[r.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",r[r.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",r[r.JOIN_GATEWAY=28]="JOIN_GATEWAY",r[r.PUBLISH=30]="PUBLISH",r[r.SUBSCRIBE=29]="SUBSCRIBE",r[r.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",r[r.STREAM_SWITCH=32]="STREAM_SWITCH",r[r.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",r[r.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",r[r.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",r[r.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",r[r.API_INVOKE=41]="API_INVOKE",r[r.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",r[r.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",r[r.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",r[r.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",r[r.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",r[r.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",r[r.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",r[r.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",r[r.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",r[r.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",r[r.WORKER_EVENT=156]="WORKER_EVENT",r[r.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",r[r.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",r[r.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",r[r.USER_ANALYTICS=1e4]="USER_ANALYTICS",r[r.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}($D||($D={}));class ai{constructor(){D(this,"baseInfoMap",new Map),D(this,"proxyServer",void 0),D(this,"eventUploadTimer",void 0),D(this,"setSessionIdTimer",void 0),D(this,"url",void 0),D(this,"backupUrl",void 0),D(this,"_appId",void 0),D(this,"keyEventUploadPendingItems",[]),D(this,"normalEventUploadPendingItems",[]),D(this,"apiInvokeUploadPendingItems",[]),D(this,"apiInvokeCount",0),D(this,"ltsList",[]),D(this,"lastSendNormalEventTime",Date.now()),D(this,"customReportCounterTimer",void 0),D(this,"customReportCount",0),D(this,"extApiInvoke",async e=>{for(const n of e){const o=kt(kt({},n),{},{sid:null,invokeId:++this.apiInvokeCount,tag:wi.TRACER});this.sendApiInvoke(o)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),oe("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),oe("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void M.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));const n=this.baseInfoMap.get(e),o=Date.now(),c=n.startTime;n.startTime=o,M.debug("rewrite session ".concat(e," startTime: ").concat(o," , ").concat(o-c,"ms")),this.baseInfoMap.set(e,n)}setAppId(e){this._appId=e}reportApiInvoke(e,n,o){n.timeout=n.timeout||6e4,n.reportResult=n.reportResult===void 0||n.reportResult;const c=Date.now();this.apiInvokeCount+=1;const u=this.apiInvokeCount,m=()=>({tag:n.tag,invokeId:u,sid:e,name:n.name,apiInvokeTime:c,options:n.options,states:n.states||null}),_=!!oe("SHOW_REPORT_INVOKER_LOG");_&&M.info("".concat(n.name," start"),n.options);let S=!1;Br(n.timeout).then(()=>{S||(this.sendApiInvoke(kt(kt({},m()),{},{error:Q.API_INVOKE_TIMEOUT,success:!1})),M.debug("".concat(n.name," timeout")))});const C=new ke(Q.UNEXPECTED_ERROR,"".concat(n.name,": this api invoke is end"));return{onSuccess:R=>{const w=()=>{if(S)throw C;return S=!0,this.sendApiInvoke(kt(kt({},m()),{},{success:!0},n.reportResult&&{result:R})),_&&M.info("".concat(n.name," onSuccess")),R};return o?MT(w,n.name+"Success",o,()=>S=!0):w()},onError:R=>{const w=()=>{if(S)throw R;S=!0,this.sendApiInvoke(kt(kt({},m()),{},{success:!1,error:R})),_&&M.info("".concat(n.name," onFailure"),R.toString())};return o?MT(w,n.name+"Error",o,()=>S=!0):w()}}}sessionInit(e,n){if(this.baseInfoMap.has(e))return;const o=Date.now(),c=this.createBaseInfo(e,o);c.cname=n.cname;const u=Object.assign({},{willUploadConsoleLog:oe("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:tC?"global":"oversea",areas:oe("AREAS")&&oe("AREAS").join(",")},n.extend),{stringUid:m,channelProfile:_,channelMode:S,isABTestSuccess:C,lsid:R,clientRole:w}=n,N=Date.now(),L=kt(kt({},c),{},{eventType:x.SESSION_INIT,appid:n.appid,browser:navigator.userAgent,build:cf,lts:N,elapse:N-o,extend:JSON.stringify(u),mode:n.mode,process:oe("PROCESS_ID"),appType:oe("APP_TYPE"),success:!0,version:mr,stringUid:m,channelProfile:_,channelMode:S,isABTestSuccess:C,lsid:R,clientType:20,clientRole:w,serviceId:oe("PROCESS_ID"),extensionID:oe("PLUGIN_INFO").join(",")||""});this.send({type:pi.SESSION,data:L},!0)}joinChooseServer(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt({},c),{},{eventType:x.JOIN_CHOOSE_SERVER,lts:u,eventElapse:u-n.lts,chooseServerAddr:n.csAddr,errorCode:n.ec,elapse:u-o.startTime,success:n.succ,chooseServerAddrList:JSON.stringify(n.serverList),uid:n.uid?parseInt(n.uid):null,cid:n.cid?parseInt(n.cid):null,chooseServerIp:n.csIp||"",opid:n.opid,unilbsServerIds:n.unilbsServerIds,extend:n.extend||void 0,isHttp3:n.isHttp3});this.send({type:pi.JOIN_CHOOSE_SERVER,data:m},!0)}reqUserAccount(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt({},c),{},{eventType:x.REQ_USER_ACCOUNT,lts:u,success:n.success,serverAddress:n.serverAddr,stringUid:n.stringUid,uid:n.uid,errorCode:n.errorCode,elapse:u-o.startTime,eventElapse:u-n.lts,extend:JSON.stringify(n.extend)});this.send({type:pi.REQ_USER_ACCOUNT,data:m},!0)}joinGateway(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info;n.vid&&(c.vid=n.vid),c.uid=n.uid,c.cid=n.cid;const u=Date.now(),{firstSuccess:m,avoidJoinStartTime:_,isProxy:S,addr:C}=n,R=u-(m&&_?_:o.startTime),w=kt(kt({},c),{},{eventType:x.JOIN_GATEWAY,lts:u,gatewayAddr:n.addr,success:n.succ,errorCode:n.ec,elapse:R,eventElapse:u-n.lts,firstSuccess:m,signalChannel:n.signalChannel}),N=w.success?1:0;if(n.succ&&(o.lastJoinSuccessTime=u),m)this.send({type:pi.JOIN_GATEWAY,data:w},!0);else{let L;if(C)if(S){const j=C.match(/h=(\d{1,3}-){3}\d{1,3}/g),W=C.match(/p=[0-9]{1,6}/g);L={isSuccess:N,gatewayIp:j&&j.length?j[0].split("=")[1].replace(/-/g,"."):"",port:W&&W.length?W[0].split("=")[1]:"",isProxy:S?1:0}}else{const j=C.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),W=C.match(/(:|p=)[0-9]{1,6}/g);L={isSuccess:N,gatewayIp:j&&j.length?j[0].split("//")[1].replace(/-/g,"."):"",port:W&&W.length?W[0].split(/:|p=/g)[1]:"",isProxy:S?1:0}}else L={isSuccess:N,gatewayIp:"",port:"",isProxy:S?1:0};delete w.success,delete w.eventType,delete w.firstSuccess,w.vid=Number(w.vid);const H=Object.assign({},w,L,{eventType:x.REJOIN_GATEWAY});this.send({type:pi.RE_JOIN_GATEWAY,data:H},!0)}}joinChannelTimeout(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=Date.now(),u=kt(kt({},o.info),{},{lts:c,timeout:n,elapse:c-o.startTime});this.send({type:pi.JOIN_CHANNEL_TIMEOUT,data:u},!0)}publish(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt({},c),{},{eventType:x.PUBLISH,lts:u,eventElapse:n.eventElapse,elapse:u-o.startTime,success:n.succ,errorCode:n.ec,videoName:n.videoName,audioName:n.audioName,screenName:n.screenName,screenshare:n.screenshare,audio:n.audio,video:n.video,p2pid:n.p2pid,publishRequestid:n.publishRequestid});this.send({type:pi.PUBLISH,data:m},!0)}subscribe(e,n,o){const c=this.baseInfoMap.get(e);if(!c)return;const u=c.info,m=Date.now(),_=kt(kt({},u),{},{eventType:x.SUBSCRIBE,lts:m,eventElapse:n.eventElapse,elapse:m-c.startTime,success:n.succ,errorCode:n.ec,video:n.video,audio:n.audio,subscribeRequestid:n.subscribeRequestid,p2pid:n.p2pid},o&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof n.peerid=="string"?_.peerSuid=n.peerid:_.peer=n.peerid,this.send({type:pi.SUBSCRIBE,data:_},!0)}wsCompressorInit(e){var n;const o=[...ka(n=this.baseInfoMap).call(n)],c=o.length?o[0]:"UnableToGetSid",u=this.baseInfoMap.get(c);if(!u)return;const m=u.info,_=Date.now(),S=kt(kt({},m),{},{eventType:x.WS_COMPRESSOR_INIT,lts:_,eventElapse:e.eventElapse,elapse:_-u.startTime,status:e.status?1:2});this.send({type:pi.WS_COMPRESSOR_INIT,data:S},!0)}firstRemoteVideoDecode(e,n,o,c){const u=this.baseInfoMap.get(e);if(!u)return;const m=u.info,_=Date.now(),S=kt(kt(kt({},m),c),{},{elapse:_-u.startTime,eventType:n,lts:_,firstDecodeFrame:Math.max(_-u.startTime,0),apEnd:Math.max(c.apEnd-u.startTime,0),apStart:Math.max(c.apStart-u.startTime,0),joinGwEnd:Math.max(c.joinGwEnd-u.startTime,0),joinGwStart:Math.max(c.joinGwStart-u.startTime,0),pcEnd:Math.max(c.pcEnd-u.startTime,0),pcStart:Math.max(c.pcStart-u.startTime,0),subscriberEnd:Math.max(c.subscriberEnd-u.startTime,0),subscriberStart:Math.max(c.subscriberStart-u.startTime,0),videoAddNotify:Math.max(c.videoAddNotify-u.startTime,0)});this.send({type:o,data:S},!0)}firstRemoteFrame(e,n,o,c){const u=this.baseInfoMap.get(e);if(!u)return;const m=u.info,_=Date.now(),S=kt(kt(kt({},m),c),{},{elapse:_-u.startTime,eventType:n,lts:_});this.send({type:o,data:S},!0)}pcStats(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt(kt({},c),n),{},{vid:c.vid===void 0?0:Number(c.vid),elapse:u-o.startTime,eventType:x.PC_STATS,lts:u});this.send({type:pi.PC_STATS,data:m},!0)}updateRemoteRTPCapabilities(e,n){if(e){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt(kt({},c),n),{},{vid:c.vid===void 0?0:Number(c.vid),eventType:x.UPDATE_REMOTE_RTPCAPABILITIES,lts:u});this.send({type:pi.UPDATE_REMOTE_RTPCAPABILITIES,data:m},!0)}}onGatewayStream(e,n,o,c){const u=this.baseInfoMap.get(e);if(!u)return;const m=u.info,_=Date.now(),S=kt(kt(kt({},m),c),{},{eventType:n,lts:_});this.send({type:o,data:S},!0)}streamSwitch(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt({},c),{},{eventType:x.STREAM_SWITCH,lts:u,isDual:n.isdual,elapse:u-o.startTime,success:n.succ});this.send({type:pi.STREAM_SWITCH,data:m},!0)}requestProxyAppCenter(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt({},c),{},{eventType:x.REQUEST_PROXY_APPCENTER,lts:u,eventElapse:u-n.lts,elapse:u-o.startTime,APAddr:n.APAddr,workerManagerList:n.workerManagerList,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:pi.REQUEST_PROXY_APPCENTER,data:m},!0)}requestProxyWorkerManager(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt({},c),{},{eventType:x.REQUEST_PROXY_WORKER_MANAGER,lts:u,eventElapse:u-n.lts,elapse:u-o.startTime,workerManagerAddr:n.workerManagerAddr,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:pi.REQUEST_PROXY_WORKER_MANAGER,data:m},!0)}setProxyServer(e){this.proxyServer=e,e?M.debug("reportProxyServerurl: ".concat(e)):M.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt({},c),{},{subscribeElapse:n.subscribeElapse,peer:n.peer,peerPublishDuration:Math.max(n.audioPublishDuration,n.videoPublishDuration),audiotag:n.audioPublishDuration>0?1:-1,videotag:n.videoPublishDuration>0?1:-1,lts:u,elapse:u-o.startTime,joinChannelSuccessElapse:u-(o.lastJoinSuccessTime||u),peerPublishDurationVideo:n.videoPublishDuration,peerPublishDurationAudio:n.audioPublishDuration});this.send({type:pi.PEER_PUBLISH_STATUS,data:m},!0)}workerEvent(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now();(function(_,S,C){const R=_[S];if(!R||typeof R!="string")return[_];_[S]="";const w=ol(JSON.stringify(_));let N=0;const L=[];let H=0;for(let j=0;j<R.length;j++)H+=R.charCodeAt(j)<=127?1:3,H<=C-w||(L[L.length]=sh(sh({},_),{},{[S]:R.substring(N,j)}),N=j,H=R.charCodeAt(j)<=127?1:3);return N!==R.length-1&&(L[L.length]=sh(sh({},_),{},{[S]:R.substring(N)})),L})(kt(kt(kt({},c),n),{},{elapse:u-o.startTime,lts:u,productType:"WebRTC"}),"payload",1300).forEach(_=>this.send({type:pi.WORKER_EVENT,data:_},!0))}apworkerEvent(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt(kt({},c),n),{},{elapse:u-o.startTime,lts:u});this.send({type:pi.AP_WORKER_EVENT,data:m},!0)}joinWebProxyAP(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt(kt({},c),n),{},{elapse:u-o.startTime,lts:u,extend:n.extend||void 0});this.send({type:pi.JOIN_WEB_PROXY_AP,data:m},!0)}WebSocketQuit(e,n){const o=this.baseInfoMap.get(e);if(!o)return;const c=o.info,u=Date.now(),m=kt(kt(kt({},c),n),{},{elapse:u-o.startTime,lts:u});this.send({type:pi.WEBSOCKET_QUIT,data:m},!0)}async sendCustomReportMessage(e,n){if(this.customReportCount+=n.length,this.customReportCount>oe("CUSTOM_REPORT_LIMIT"))throw new ke(Q.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const o=Date.now(),c=n.map(u=>({type:pi.USER_ANALYTICS,data:kt(kt({sid:e},u),{},{lts:o})}));try{oe("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(c):await this.postDataToStatsCollector(c)}catch(u){throw M.error("send custom report message failed",u.toString()),new ke(Q.CUSTOM_REPORT_SEND_FAILED,u.message)}}sendApiInvoke(e){const n=oe("NOT_REPORT_EVENT");if(e.tag&&xe(n)&&xe(n).call(n,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const o=this.baseInfoMap.get(e.sid);if(!o)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:c,uid:u,cid:m}=o.info;let _;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof ke){const{code:C,message:R}=e.error;_=C||R||e.error.toString()}else _=e.error.toString();const S={invokeId:e.invokeId,sid:e.sid,cname:c,cid:m,uid:u,lts:e.lts,success:e.success,elapse:e.lts-o.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?_:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:pi.API_INVOKE,data:S},!1),!0}appendSessionId(){ai.__CLIENT_LIST__.forEach(e=>{if(e._sessionId){const n=this.apiInvokeUploadPendingItems.length;for(let o=0;o<n;o++){const c=this.apiInvokeUploadPendingItems.shift();c&&(c.sid=e._sessionId,this.sendApiInvoke(Object.assign({},c)))}}})}send(e,n){if(n)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>oe("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,n){const o=[],c=[];for(;e.length;){const m=e.shift();o.length<20?o.push(m):c.push(m)}e.push(...c);for(const m of[...o]){var u;this.ltsList.indexOf(m.data.lts)!==-1?(m.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(m.data.lts)):(this.ltsList.push(m.data.lts),LE(u=this.ltsList).call(u,(_,S)=>_-S))}return n||(this.lastSendNormalEventTime=Date.now()),oe("ENABLE_EVENT_REPORT")&&o.length&&(oe("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(o):this.postDataToStatsCollector(o)).catch((m=>_=>{oe("EVENT_REPORT_RETRY")&&(n?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(m):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(m),this.normalEventUploadPendingItems.length>oe("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-oe("NORMAL_EVENT_QUEUE_CAPACITY")),M.warning("report: drop normal events"))))})(o)),e}async postDataToStatsCollector2(e){ki.networkState===fn.OFFLINE&&await Ee.race([ki.onlineWaiter,Br(2*or.maxRetryTimeout)]);const n=u=>{let m=new Uint8Array;return u.forEach(_=>{const S=cr(JSON.stringify(_.data)),C=new ArrayBuffer(5),R=(N=>{let L=0;return Object.entries(pi).forEach(H=>{let[j,W]=H;W===N.type&&(L=EventNameToID[j])}),L})(_),w=new DataView(C);w.setUint16(0,S.byteLength,!0),w.setUint8(2,255&R),w.setUint8(3,R>>>8&255),w.setUint8(4,R>>>16&255),m=Pi(m,new Uint8Array(C)),m=Pi(m,S)}),m},o="event";let c=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(oe("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(o):"https://".concat(oe("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(o);for(let u=0;u<2;u+=1){u===1&&(c=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(oe("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(o):"https://".concat(oe("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(o));try{await vw(c,{timeout:1e4,data:n(e),headers:kt(kt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(m){if(u===1)throw m;continue}return}}async postDataToStatsCollector(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const o={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(m=>JSON.stringify(m)),vid:(m=>{const _=m&&m.data.sid&&this.baseInfoMap.get(m.data.sid);return _&&_.info.vid&&+_.info.vid||0})(e[0])};ki.networkState===fn.OFFLINE&&await Ee.race([ki.onlineWaiter,Br(2*or.maxRetryTimeout)]);const c=n?"/events/proto-raws":"/events/messages";let u=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(oe("EVENT_REPORT_DOMAIN"),"&p=").concat(oe("STATS_COLLECTOR_PORT"),"&d=").concat(c):"https://".concat(oe("EVENT_REPORT_DOMAIN"),":").concat(oe("STATS_COLLECTOR_PORT")).concat(c));for(let m=0;m<2;m+=1){m===1&&(u=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(oe("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(oe("STATS_COLLECTOR_PORT"),"&d=").concat(c):"https://".concat(oe("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(oe("STATS_COLLECTOR_PORT")).concat(c)));try{n?await eC(u,{timeout:1e4,data:o}):await vw(u,{timeout:1e4,data:o})}catch(_){if(m===1)throw _;continue}return}}createBaseInfo(e,n){const o=Object.assign({},ug);return o.sid=e,this.baseInfoMap.set(e,{info:o,startTime:n}),o}reportResourceTiming(e,n){const o=performance.getEntriesByName(e),c=o[o.length-1];c&&this.reportApiInvoke(n,{name:"Client.resourceTiming",options:c,tag:wi.TRACER}).onSuccess()}}function Lt(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,n,o){const c=o.value;if(typeof c=="function"){const u=r.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);o.value=function(){for(var m=arguments.length,_=new Array(m),S=0;S<m;S++)_[S]=arguments[S];let C=_;if(r.argsMap)try{C=r.argsMap(this,..._)}catch(w){M.warning(w),C=[]}try{JSON.stringify(C)}catch{M.warning("arguments for method ".concat(u,".").concat(String(n)," not serializable for apiInvoke.")),C=[]}const R=(r.report||vt).reportApiInvoke(this._sessionId||null,{name:"".concat(u,".").concat(String(n)),options:C,tag:wi.TRACER,reportResult:r.reportResult},r.throttleTime);try{const w=c.apply(this,_);return w instanceof Ee?w.then(N=>(R.onSuccess(r.reportResult&&N),N)).catch(N=>{throw R.onError(N),N}):(R.onSuccess(r.reportResult&&w),w)}catch(w){throw R.onError(w),w}}}return o}}D(ai,"__CLIENT_LIST__",[]);const vt=new ai;yt.on("REPORT_LOG_UPLOAD",r=>{r.networkState=ki.networkState,vt.reportApiInvoke(null,{name:"logUploadError",options:r,tag:wi.TRACER})});const tP=["CHINA","GLOBAL"],Mt=function(){const r="us".concat("erna","me"),e="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const o=n.join(""),c=[];for(let _=0;_<6;_++)c.push("1");const u=c.join(""),m={};return m[r]=o,m[e]=u,Object.assign(m,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Mt,tC||(Ss.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Ss.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Ss.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Ss.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Ss.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Ss.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Ss.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Ss.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Ss.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Ss.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Ss.AREAS=["NORTH_AMERICA","OVERSEA"]);const df=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],bt=[];function Tt(r,e){return!!e&&bt.some(n=>n.uid===r&&n.channelName===e)}ai.__CLIENT_LIST__=bt;var ww,Gi,kp,Wc,Hs,Ts,Ct,Jt,pt,ft,fr,Qe,an,st,qe,Li,Ut,nP=sa("Array").values,Ks=Pa,xt=ji,br=ge,hh=nP,bw=Array.prototype,YB={DOMTokenList:!0,NodeList:!0},wd=A(function(r){var e=r.values;return r===bw||br(bw,r)&&e===bw.values||xt(YB,Ks(r))?hh:e});function Ge(r,e,n,o){var c,u=arguments.length,m=u<3?e:o===null?o=Object.getOwnPropertyDescriptor(e,n):o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")m=Reflect.decorate(r,e,n,o);else for(var _=r.length-1;_>=0;_--)(c=r[_])&&(m=(u<3?c(m):u>3?c(e,n,m):c(e,n))||m);return u>3&&m&&Object.defineProperty(e,n,m),m}function z(r,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,e)}(function(r){r.L1T1="L1T1",r.L1T2="L1T2",r.L1T3="L1T3",r.L2T1_KEY="L2T1_KEY",r.L2T2_KEY="L2T2_KEY",r.L2T3_KEY="L2T3_KEY",r.L3T1_KEY="L3T1_KEY",r.L3T2_KEY="L3T2_KEY",r.L3T3_KEY="L3T3_KEY"})(ww||(ww={})),function(r){r.CERTIFICATE="certificate",r.CODEC="codec",r.CANDIDATE_PAIR="candidate-pair",r.LOCAL_CANDIDATE="local-candidate",r.REMOTE_CANDIDATE="remote-candidate",r.INBOUND="inbound-rtp",r.TRACK="track",r.OUTBOUND="outbound-rtp",r.PC="peer-connection",r.REMOTE_INBOUND="remote-inbound-rtp",r.REMOTE_OUTBOUND="remote-outbound-rtp",r.TRANSPORT="transport",r.CSRC="csrc",r.DATA_CHANNEL="data-channel",r.STREAM="stream",r.SENDER="sender",r.RECEIVER="receiver"}(Gi||(Gi={})),function(r){r[r.ACCESS_POINT=101]="ACCESS_POINT",r[r.UNILBS=201]="UNILBS",r[r.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(kp||(kp={})),function(r){r[r.IIIEGAL_APPID=1]="IIIEGAL_APPID",r[r.IIIEGAL_UID=2]="IIIEGAL_UID",r[r.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(Wc||(Wc={})),function(r){r[r.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",r[r.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",r[r.INTERNAL_ERROR=8]="INTERNAL_ERROR",r[r.NO_AUTHORIZED=9]="NO_AUTHORIZED",r[r.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",r[r.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",r[r.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",r[r.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",r[r.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",r[r.USER_OVERLOAD=16]="USER_OVERLOAD",r[r.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",r[r.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(Hs||(Hs={})),function(r){r[r.NO_FLAG_SET=100]="NO_FLAG_SET",r[r.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",r[r.INVALID_FALG_SET=102]="INVALID_FALG_SET",r[r.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",r[r.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",r[r.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",r[r.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",r[r.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",r[r.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",r[r.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",r[r.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",r[r.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",r[r.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",r[r.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",r[r.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",r[r.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",r[r.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",r[r.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",r[r.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(Ts||(Ts={})),function(r){r[r.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",r[r.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",r[r.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",r[r.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",r[r.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",r[r.K_TICKET_INVALID=7]="K_TICKET_INVALID",r[r.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",r[r.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",r[r.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",r[r.K_UID_BANNED=14]="K_UID_BANNED",r[r.K_IP_BANNED=15]="K_IP_BANNED",r[r.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",r[r.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",r[r.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",r[r.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",r[r.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",r[r.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",r[r.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",r[r.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",r[r.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",r[r.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",r[r.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",r[r.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",r[r.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",r[r.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",r[r.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",r[r.ERR_INVALID_UID=117]="ERR_INVALID_UID",r[r.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",r[r.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",r[r.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",r[r.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",r[r.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",r[r.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",r[r.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",r[r.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",r[r.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",r[r.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",r[r.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",r[r.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",r[r.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",r[r.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",r[r.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",r[r.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",r[r.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",r[r.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",r[r.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",r[r.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",r[r.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",r[r.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",r[r.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",r[r.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",r[r.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",r[r.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",r[r.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",r[r.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",r[r.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",r[r.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",r[r.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",r[r.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",r[r.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",r[r.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",r[r.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",r[r.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",r[r.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(Ct||(Ct={})),function(r){r.CONNECTING="connecting",r.CONNECTED="connected",r.RECONNECTING="reconnecting",r.CLOSED="closed"}(Jt||(Jt={})),function(r){r.WS_CONNECTED="ws_connected",r.WS_RECONNECTING="ws_reconnecting",r.WS_CLOSED="ws_closed",r.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",r.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",r.ON_BINARY_DATA="on_binary_data",r.REQUEST_RECOVER="request_recover",r.REQUEST_JOIN_INFO="request_join_info",r.REQUEST_REJOIN_INFO="req_rejoin_info",r.IS_P2P_DISCONNECTED="is_p2p_dis",r.DISCONNECT_P2P="dis_p2p",r.ABORT_P2P_EXECUTION="abort_p2p_execution",r.NEED_RENEW_SESSION="need-sid",r.REPORT_JOIN_GATEWAY="report_join_gateway",r.REQUEST_TIMEOUT="request_timeout",r.REQUEST_SUCCESS="request_success",r.JOIN_RESPONSE="join_response",r.DATACHANNEL_PRECONNECT="datachannel_preconnect",r.DATACHANNEL_CONNECTING="datachannel_connecting",r.DATACHANNEL_FAILBACK="datachannel_failback",r.P2P_CONNECTION="p2p_connection",r.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",r.P2P_SUBSCRIBE="p2p_subscribe",r.P2P_UNSUBSCRIBE="p2p_unsubscribe",r.P2P_EXCHANGE_SDP="p2p_exchange_sdp",r.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",r.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(pt||(pt={})),function(r){r.PING="ping",r.PING_BACK="ping_back",r.JOIN="join_v3",r.REJOIN="rejoin_v3",r.LEAVE="leave",r.SET_CLIENT_ROLE="set_client_role",r.PUBLISH="publish",r.PUBLISH_DATASTREAM="publish_datastream",r.UNPUBLISH="unpublish",r.UNPUBLISH_DATASTREAM="unpublish_datastream",r.SUBSCRIBE="subscribe",r.PRE_SUBSCRIBE="pre_subscribe",r.SUBSCRIBE_DATASTREAM="subscribe_datastream",r.SUBSCRIBE_STREAMS="subscribe_streams",r.UNSUBSCRIBE="unsubscribe",r.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",r.UNSUBSCRIBE_STREAMS="unsubscribe_streams",r.SUBSCRIBE_CHANGE="subscribe_change",r.TRAFFIC_STATS="traffic_stats",r.RENEW_TOKEN="renew_token",r.SWITCH_VIDEO_STREAM="switch_video_stream",r.DEFAULT_VIDEO_STREAM="default_video_stream",r.SET_FALLBACK_OPTION="set_fallback_option",r.GATEWAY_INFO="gateway_info",r.CONTROL="control",r.SEND_METADATA="send_metadata",r.DATA_STREAM="data_stream",r.PICK_SVC_LAYER="pick_svc_layer",r.RESTART_ICE="restart_ice",r.CONNECT_PC="connect_pc",r.SET_VIDEO_PROFILE="set_video_profile",r.SET_PARAMETER="set_parameter",r.SET_RTM2_FLAG="set_rtm2_flag"}(ft||(ft={})),function(r){r.WRTC_STATS="wrtc_stats",r.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",r.DENOISER_STATS="denoiser_stats",r.EXTENSION_USAGE_STATS="extension_usage_stats"}(fr||(fr={})),function(r){r.ON_USER_ONLINE="on_user_online",r.ON_USER_OFFLINE="on_user_offline",r.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",r.ON_PUBLISH_STREAM="on_publish_stream",r.ON_UPLINK_STATS="on_uplink_stats",r.ON_P2P_LOST="on_p2p_lost",r.ON_REMOVE_STREAM="on_remove_stream",r.ON_ADD_AUDIO_STREAM="on_add_audio_stream",r.ON_ADD_VIDEO_STREAM="on_add_video_stream",r.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",r.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",r.ON_USER_BANNED="on_user_banned",r.ON_USER_LICENSE_BANNED="on_user_license_banned",r.ON_NOTIFICATION="on_notification",r.ON_CRYPT_ERROR="on_crypt_error",r.MUTE_AUDIO="mute_audio",r.MUTE_VIDEO="mute_video",r.UNMUTE_AUDIO="unmute_audio",r.UNMUTE_VIDEO="unmute_video",r.ON_P2P_OK="on_p2p_ok",r.RECEIVE_METADATA="receive_metadata",r.ON_DATA_STREAM="on_data_stream",r.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",r.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",r.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",r.ENABLE_LOCAL_VIDEO="enable_local_video",r.DISABLE_LOCAL_VIDEO="disable_local_video",r.ENABLE_LOCAL_AUDIO="enable_local_audio",r.DISABLE_LOCAL_AUDIO="disable_local_audio",r.ON_PUBLISHED_USER_LIST="on_published_user_list"}(Qe||(Qe={})),function(r){r.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",r.NEED_ANSWER="NEED_ANSWER",r.NEED_RENEGOTIATE="NEED_RENEGOTIATE",r.P2P_LOST="P2P_LOST",r.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",r.NEED_UNPUB="NEED_UNPUB",r.NEED_UNSUB="NEED_UNSUB",r.NEED_UPLOAD="NEED_UPLOAD",r.NEED_CONTROL="NEED_CONTROL",r.START_RECONNECT="START_RECONNECT",r.END_RECONNECT="END_RECONNECT",r.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(an||(an={})),function(r){r.SEND_ONLY="SEND_ONLY",r.RECEIVE_ONLY="RECEIVE_ONLY"}(st||(st={})),function(r){r.CONNECTED="websocket:connected",r.RECONNECTING="websocket:reconnecting",r.WILL_RECONNECT="websocket:will_reconnect",r.CLOSED="websocket:closed",r.FAILED="websocket:failed",r.ON_MESSAGE="websocket:on_message",r.REQUEST_NEW_URLS="websocket:request_new_urls",r.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",r.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",r.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(qe||(qe={}));class Te extends ke{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),D(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,M)}throw(){super.throw(M)}}function Ow(r){if(typeof r!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(r))throw M.error("Invalid Channel Name ".concat(r)),new Te(Q.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function hc(r){if(e=r,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||BA(r,1,255)))throw new Te(Q.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof r=="string"&&M.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}(function(r){r.TRANSCODE="mix_streaming",r.RAW="raw_streaming",r.INJECT="inject_streaming"})(Li||(Li={})),function(r){r[r.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",r[r.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",r[r.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",r[r.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",r[r.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",r[r.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",r[r.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",r[r.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",r[r.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",r[r.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",r[r.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(Ut||(Ut={}));const Be={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Y={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Ce(r,e){Xr(r.url,"".concat(e,".url"),1,1e3,!1),Ai(r.x)||Jn(r.x,"".concat(e,".x"),0,1e4),Ai(r.y)||Jn(r.y,"".concat(e,".y"),0,1e4),Ai(r.width)||Jn(r.width,"".concat(e,".width"),0,1e4),Ai(r.height)||Jn(r.height,"".concat(e,".height"),0,1e4),Ai(r.zOrder)||Jn(r.zOrder,"".concat(e,".zOrder"),0,255),Ai(r.alpha)||Jn(r.alpha,"".concat(e,".alpha"),0,1,!1)}const Nw={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Dw={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var Hc,ph,Xi,iP,Ys,Cs,hs,Ti,Nn,An,Do,Yn,bd,At;function Wi(r){if(!r.channelName)throw new Te(Q.INVALID_PARAMS,"invalid channelName in info");if(typeof r.uid!="number")throw new Te(Q.INVALID_PARAMS,"invalid uid in info, uid must be a number");return r.token&&Xr(r.token,"info.token",1,2047),hc(r.uid),Ow(r.channelName),!0}(function(r){r.WARNING="@live_uap-warning",r.ERROR="@line_uap-error",r.PUBLISH_STREAM_STATUS="@live_uap-publish-status",r.INJECT_STREAM_STATUS="@live_uap-inject-status",r.WORKER_STATUS="@live_uap-worker-status",r.REQUEST_NEW_ADDRESS="@live_uap-request-address"})(Hc||(Hc={})),function(r){r.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(ph||(ph={})),function(r){r[r.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",r[r.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",r[r.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",r[r.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",r[r.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",r[r.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",r[r.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",r[r.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",r[r.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",r[r.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",r[r.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",r[r.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",r[r.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",r[r.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",r[r.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",r[r.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",r[r.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",r[r.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",r[r.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",r[r.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",r[r.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(Xi||(Xi={})),function(r){r.CONNECT_FAILED="connect failed",r.CONNECT_TIMEOUT="connect timeout",r.WS_DISCONNECTED="websocket disconnected",r.REQUEST_TIMEOUT="request timeout",r.REQUEST_FAILED="request failed",r.WAIT_STATUS_TIMEOUT="wait status timeout",r.WAIT_STATUS_ERROR="wait status error",r.BAD_STATE="bad state",r.WS_ABORT="ws abort",r.AP_REQUEST_TIMEOUT="AP request timeout",r.AP_JSON_PARSE_ERROR="AP json parse error",r.AP_REQUEST_ERROR="AP request error",r.AP_REQUEST_ABORT="AP request abort"}(iP||(iP={})),function(r){r[r.SetSdkProfile=0]="SetSdkProfile",r[r.SetSourceChannel=1]="SetSourceChannel",r[r.SetSourceUserId=2]="SetSourceUserId",r[r.SetDestChannel=3]="SetDestChannel",r[r.StartPacketTransfer=4]="StartPacketTransfer",r[r.StopPacketTransfer=5]="StopPacketTransfer",r[r.UpdateDestChannel=6]="UpdateDestChannel",r[r.Reconnect=7]="Reconnect",r[r.SetVideoProfile=8]="SetVideoProfile"}(Ys||(Ys={})),function(r){r.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",r.NETWORK_CONNECTED="NETWORK_CONNECTED",r.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",r.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",r.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",r.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",r.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",r.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",r.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",r.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(Cs||(Cs={})),function(r){r.RELAY_STATE_IDLE="RELAY_STATE_IDLE",r.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",r.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",r.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(hs||(hs={})),function(r){r.RELAY_OK="RELAY_OK",r.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",r.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",r.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(Ti||(Ti={})),function(r){r.High="high",r.Low="low",r.Audio="audio",r.Screen="screen",r.ScreenLow="screen_low"}(Nn||(Nn={})),function(r){r.DISCONNECT="disconnect",r.CONNECTION_STATE_CHANGE="connection-state-change",r.NETWORK_QUALITY="network-quality",r.STREAM_TYPE_CHANGE="stream-type-change",r.IS_P2P_DISCONNECTED="is-p2p-dis",r.DISCONNECT_P2P="dis-p2p",r.REQUEST_NEW_GATEWAY_LIST="req-gate-url",r.NEED_RENEW_SESSION="need-sid",r.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",r.JOIN_RESPONSE="join-response",r.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",r.RESET_CONNECTION_EVENTS="reset-connection-events",r.DATACHANNEL_PRECONNECT="datachannel_preconnect",r.DATACHANNEL_FAILBACK="datachannel_failback",r.RESET_SIGNAL="reset-signal"}(An||(An={})),function(r){r.P2P_DISCONNECTED="P2P_DISCONNECTED",r.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",r.TIMEOUT="TIMEOUT",r.UNKNOWN_REASON="UNKNOWN_REASON"}(Do||(Do={})),function(r){r[r.Nothing=0]="Nothing",r[r.Audio=1]="Audio",r[r.LwoVideo=2]="LwoVideo",r[r.Video=4]="Video",r[r.Data=8]="Data",r[r.DataStream0=256]="DataStream0",r[r.DataStream1=512]="DataStream1",r[r.DataStream2=1024]="DataStream2",r[r.DataStream3=2048]="DataStream3",r[r.DataStream4=4096]="DataStream4",r[r.DataStream5=8192]="DataStream5",r[r.DataStream6=16384]="DataStream6",r[r.DataStream7=32768]="DataStream7"}(Yn||(Yn={})),function(r){r[r.websocket=0]="websocket",r[r.datachannel=1]="datachannel"}(bd||(bd={})),function(r){r.CHINA="CHINA",r.ASIA="ASIA",r.NORTH_AMERICA="NORTH_AMERICA",r.EUROPE="EUROPE",r.JAPAN="JAPAN",r.INDIA="INDIA",r.KOREA="KOREA",r.HKMC="HKMC",r.US="US",r.OCEANIA="OCEANIA",r.SOUTH_AMERICA="SOUTH_AMERICA",r.AFRICA="AFRICA",r.OVERSEA="OVERSEA",r.GLOBAL="GLOBAL",r.EXTENSIONS="EXTENSIONS"}(At||(At={}));const mh=[At.AFRICA,At.ASIA,At.CHINA,At.EUROPE,At.GLOBAL,At.INDIA,At.JAPAN,At.NORTH_AMERICA,At.OCEANIA,At.OVERSEA,At.SOUTH_AMERICA];var On;(function(r){r.CHINA="CN",r.ASIA="AS",r.NORTH_AMERICA="NA",r.EUROPE="EU",r.JAPAN="JP",r.INDIA="IN",r.KOREA="KR",r.HKMC="HK",r.US="US",r.OCEANIA="OC",r.SOUTH_AMERICA="SA",r.AFRICA="AF",r.OVERSEA="OVERSEA",r.GLOBAL="GLOBAL",r.EXTENSIONS="GLOBAL"})(On||(On={}));const Lp={CHINA:{},ASIA:{CODE:On.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:On.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:On.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:On.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:On.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:On.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:On.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:On.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:On.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:On.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:On.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:On.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:On.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var Cn,Pw,gt,Xn,Ua,Je,kn,We,vs,$r,Ke,Yt,wt,Qi,Gr,la,ci,Rs,mi,Qn,cu,es,xa,ll;tC&&(Lp.CHINA={CODE:On.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(r){r.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(Cn||(Cn={}));class Hi extends Dt{constructor(e,n){super(),D(this,"onICEConnectionStateChange",void 0),D(this,"onConnectionStateChange",void 0),D(this,"onDTLSTransportStateChange",void 0),D(this,"onDTLSTransportError",void 0),D(this,"onICETransportStateChange",void 0),D(this,"onFirstAudioReceived",void 0),D(this,"onFirstVideoReceived",void 0),D(this,"onFirstAudioDecoded",void 0),D(this,"onFirstVideoDecoded",void 0),D(this,"onFirstVideoDecodedTimeout",void 0),D(this,"onSelectedLocalCandidateChanged",void 0),D(this,"onSelectedRemoteCandidateChanged",void 0)}}class Od extends Hi{constructor(e,n){super(e,n)}}(function(r){r.SEND="sendonly",r.RECV="recvonly",r.SENDRECV="sendrecv",r.INACTIVE="inactive"})(Pw||(Pw={})),function(r){r.VIDEO="video",r.AUDIO="audio"}(gt||(gt={})),function(r){r[r.UDP=0]="UDP",r[r.TCP=1]="TCP",r[r.RELAY=2]="RELAY"}(Xn||(Xn={})),function(r){r[r.FIRST_CONNECTION=0]="FIRST_CONNECTION",r[r.TCP_RESTART=1]="TCP_RESTART",r[r.RELAY_RESTART=2]="RELAY_RESTART",r[r.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",r[r.OLD_RESTART=11]="OLD_RESTART",r[r.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(Ua||(Ua={})),function(r){r.LocalVideoTrack="videoTrack",r.LocalAudioTrack="audioTrack",r.LocalVideoLowTrack="videoLowTrack"}(Je||(Je={})),function(r){r.New="new",r.Connected="connected",r.Reconnecting="reconnecting",r.Disconnected="disconnected"}(kn||(kn={})),function(r){r.StateChange="stateChange",r.IceConnectionStateChange="iceConnectionStateChange",r.RequestMuteLocal="requestMuteLocal",r.RequestUnmuteLocal="requestUnmuteLocal",r.RequestRePublish="requestRePublish",r.RequestRePublishDataChannel="requestRePublishDataChannel",r.RequestReSubscribe="requestReSubscribe",r.RequestUploadStats="requestUploadStats",r.RequestUpload="requestUpload",r.MediaReconnectStart="MediaReconnectStart",r.MediaReconnectEnd="MediaReconnectEnd",r.NeedSignalRTT="NeedSignalRTT",r.RequestRestartICE="RequestRestartIce",r.PeerConnectionStateChange="PeerConnectionStateChange",r.RequestReconnect="RequestReconnect",r.RequestReconnectPC="RequestReconnectPC",r.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",r.P2PLost="P2PLost",r.UpdateVideoEncoder="UpdateVideoEncoder",r.ConnectionTypeChange="ConnectionTypeChange",r.RequestLowStreamParameter="RequestLowStreamParameter",r.QueryClientConnectionState="QueryClientConnectionState",r.LocalCandidate="LocalCandidate",r.RequestP2PMuteLocal="requestP2PMuteLocal",r.RequestP2PUnPublish="RequestP2PUnPublish",r.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",r.RequestP2PMuteRemote="RequestP2PMuteRemote",r.RequestP2PRestartICE="RequestP2PRestartICE"}(We||(We={})),function(r){r.MUTE_LOCAL_VIDEO="mute_local_video",r.MUTE_LOCAL_AUDIO="mute_local_audio",r.UNMUTE_LOCAL_VIDEO="unmute_local_video",r.UNMUTE_LOCAL_AUDIO="unmute_local_audio",r.MUTE_REMOTE_VIDEO="mute_remote_video",r.MUTE_REMOTE_AUDIO="mute_remote_audio",r.UNMUTE_REMOTE_VIDEO="unmute_remote_video",r.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(vs||(vs={})),function(r){r.CONNECTING="CONNECTING",r.RECONNECTING="RECONNECTING",r.CONNECTED="CONNECTED",r.CLOSED="CLOSED"}($r||($r={})),function(r){r[r.CONNECT_AP=0]="CONNECT_AP",r[r.AP_CONNECTED=1]="AP_CONNECTED",r[r.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",r[r.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",r[r.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",r[r.CONNECT_WORKER=5]="CONNECT_WORKER",r[r.WORKER_CONNECTED=6]="WORKER_CONNECTED",r[r.CLOSED=7]="CLOSED"}(Ke||(Ke={})),function(r){r.CONNECTION_STATE_CHANGE="connection-state-change",r.STATE_CHANGE="state-change",r.INSPECT_RESULT="inspect-result",r.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",r.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Yt||(Yt={})),function(r){r.NETWORK_ERROR="NETWORK_ERROR",r.SERVER_ERROR="SERVER_ERROR",r.MULTI_IP="MULTI_IP",r.TIMEOUT="TIMEOUT",r.OFFLINE="OFFLINE",r.LEAVE="LEAVE",r.P2P_FAILED="P2P_FAILED",r.FALLBACK="FALLBACK"}(wt||(wt={})),function(r){r.CONNECTED="transmitter:connected",r.RECONNECTING="transmitter:reconnecting",r.WILL_RECONNECT="transmitter:will_reconnect",r.CLOSED="transmitter:closed",r.FAILED="transmitter:failed",r.ON_MESSAGE="transmitter:on_message",r.REQUEST_NEW_URLS="transmitter:request_new_urls",r.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",r.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",r.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",r.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",r.FAILBACK="transmitter:failback"}(Qi||(Qi={})),function(r){r.CAMERA_CHANGED="camera-changed",r.MICROPHONE_CHANGED="microphone-changed",r.PLAYBACK_DEVICE_CHANGED="playback-device-changed",r.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",r.AUTOPLAY_FAILED="autoplay-failed",r.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",r.SECURITY_POLICY_VIOLATION="security-policy-violation"}(Gr||(Gr={})),function(r){r[r.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",r[r.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",r[r.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",r[r.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",r[r.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",r[r.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",r[r.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",r[r.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",r[r.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",r[r.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",r[r.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",r[r.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",r[r.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",r[r.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",r[r.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",r[r.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",r[r.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",r[r.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",r[r.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",r[r.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(la||(la={})),function(r){r.CONNECTING="CONNECTING",r.RECONNECTING="RECONNECTING",r.CONNECTED="CONNECTED",r.CLOSED="CLOSED"}(ci||(ci={})),function(r){r.CONNECTION_STATE_CHANGE="connection-state-change",r.STATE_CHANGE="state-change",r.INSPECT_RESULT="inspect-result",r.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",r.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Rs||(Rs={})),function(r){r[r.CONNECT_AP=0]="CONNECT_AP",r[r.AP_CONNECTED=1]="AP_CONNECTED",r[r.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",r[r.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",r[r.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",r[r.CONNECT_WORKER=5]="CONNECT_WORKER",r[r.WORKER_CONNECTED=6]="WORKER_CONNECTED",r[r.CLOSED=7]="CLOSED"}(mi||(mi={})),function(r){r.CALL="call",r.CANDIDATE="candidate",r.PUBLISH="publish",r.UNPUBLISH="unpublish",r.CONTROL="control",r.RESTART_ICE="restart_ice",r.ACK="ack",r.RESPONSE="response",r.JOIN="join",r.CHECK="check"}(Qn||(Qn={})),function(r){r.ABORT="abort"}(cu||(cu={})),function(r){r.MUTE_LOCAL_AUDIO="mute_local_audio",r.MUTE_LOCAL_VIDEO="mute_local_video",r.UNMUTE_LOCAL_AUDIO="unmute_local_audio",r.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(es||(es={})),function(r){r[r.SUCCESS=1]="SUCCESS",r[r.FAILED=0]="FAILED"}(xa||(xa={})),function(r){r.P2P_TOKEN_TIMEOUT="p2p_token_timeout",r.P2P_TOKEN_CHANGED="p2p_token_changed"}(ll||(ll={}));const ul={[kp.ACCESS_POINT]:{[Ts.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Ts.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Ts.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Ts.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Ts.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Ts.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Ts.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[kp.UNILBS]:{[Hs.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Hs.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Hs.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Hs.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Hs.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Hs.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Hs.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Hs.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Hs.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Hs.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Hs.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Hs.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[kp.STRING_UID_ALLOCATOR]:{[Wc.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Wc.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Wc.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function hg(r){const e=ul[Math.floor(r/1e4)];if(!e)return{desc:"unkonw error",retry:!1};const n=e[r%1e4];if(!n){if(Math.floor(r/1e4)===kp.ACCESS_POINT){const o=r%1e4;if(o.toString()[0]==="1")return{desc:r.toString(),retry:!1};if(o.toString()[0]==="2")return{desc:r.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return n}const kw={[Ct.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Ct.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Ct.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Ct.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Ct.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Ct.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Ct.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Ct.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Ct.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Ct.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Ct.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Ct.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Ct.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Ct.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Ct.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Ct.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Ct.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Ct.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Ct.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Ct.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Ct.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Ct.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Ct.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Ct.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Ct.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Ct.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Ct.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Ct.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Ct.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Ct.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Ct.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Ct.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Ct.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Ct.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Ct.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Ct.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Ct.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Ct.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Ct.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Ct.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Ct.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Ct.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Ct.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Ct.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Ct.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Ct.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Ct.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Ct.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Ct.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Ct.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Ct.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Ct.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Ct.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Ct.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Ct.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Ct.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Ct.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Ct.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Ct.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Ct.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Ct.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Ct.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Ct.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function fh(r){return kw[r]||{desc:"UNKNOW_ERROR_".concat(r),action:"failed"}}function pg(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Lw(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?pg(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):pg(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function mg(r){return r.every(e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)}function rP(r,e){if(typeof r=="string")return r;const{proxy:n,host:o,port:c}=r;if(e){const u=oe("JOIN_GATEWAY_FALLBACK_PORT")||443;return u===443?"wss://".concat(o,"/ws/?p=").concat(Number(c)+150):"wss://".concat(o,":").concat(u,"/ws/?p=").concat(Number(c)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(o,"&p=").concat(c):"wss://".concat(o,":").concat(c)}const Mp=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,sP=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Mw=/wss:\/\/(.+):([0-9]+)\/?/,oP=/wss:\/\/(.[^\/]+)\/?/;let aP=0;class zB{constructor(e,n){D(this,"id",0),D(this,"store",void 0),D(this,"recordIndex",void 0),D(this,"websockets",[]),D(this,"try443PortDuration",2e3),D(this,"forceCloseWSDuration",5e3),D(this,"try443PortTimeout",null),D(this,"forceCloseTimeout",null),D(this,"isTry443PortFailed",!1),D(this,"isNormalPortFailed",!1),D(this,"useDoubleDomain",!1),D(this,"useProxy",!1),D(this,"startTime",Date.now()),this.id=++aP,this.try443PortDuration=oe("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const n=Date.now()-this.startTime;for(var o=arguments.length,c=new Array(o),u=0;u<o;u++)c[u]=arguments[u];M.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...c)}createWebSocket(e,n,o){this.logger("createWebSocket:",e,{isTry443Port:n,hasTimeoutDetection:o});const c=oe("GATEWAY_DOMAINS"),u=Date.now(),m=[],_=c.find(R=>{var w;return xe(w=e.host).call(w,R)});_||(this.useDoubleDomain=!1);const S=[];if(this.useDoubleDomain)c.forEach(R=>{S.push(rP(Lw(Lw({},e),{},{host:e.host.replace(_,R)}),n))});else{const R=Lw({},e);if(n&&_){const w=c.find(N=>N!==_);w&&(R.host=R.host.replace(_,w))}S.push(rP(R,n))}try{S.forEach(R=>{const w=new WebSocket(R);w.binaryType="arraybuffer",m.push(w),this.logger("ws is connecting:",w.url)})}catch(R){if(this.logger("ws create failed"),m.forEach(w=>w.close()),m.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,n,o);if(!n&&Number(e.port)!==443)return this.createWebSocket(e,!0,o);throw new Te(Q.WS_ERR,"init websocket failed! Error: ".concat(R.toString()))}const C=zm();return this.store&&this.store.recordJoinChannelService({urls:m.map(R=>R.url),service:"gateway"},this.recordIndex),m.forEach(R=>{R.onopen=()=>{this.logger("onopen: ws ".concat(R.url," open cost ").concat(Date.now()-u,"ms")),this.websockets.forEach(w=>{w!==R&&(w.onopen=null,w.onclose=null,w.onmessage=null,w.close(),this.logger("close backup websocket: ".concat(w.url)))}),this.websockets.length=0,C.resolve(R)},R.onclose=w=>{this.logger("onclose: ws ".concat(R.url," closed cost ").concat(Date.now()-u,"ms state: ").concat(R.readyState)),n?this.isTry443PortFailed=mg(m):this.isNormalPortFailed=mg(m),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(n&&this.isTry443PortFailed||!n&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(w.reason)),C.reject({code:w.code,reason:Do.A_ROUND_WS_FAILED}))},R.onmessage=w=>this.logger("".concat(R.url," onmessage: ").concat(w.data))}),this.websockets.push(...m),o||(()=>{const R=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",C.isResolved),this.websockets.forEach(w=>w.readyState!==WebSocket.OPEN&&w.close())};if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(R,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",C.isResolved),C.isResolved)return R();qt().os===ar.MAC_OS&&Ln()&&R(),this.createWebSocket(e,!0,!0).then(w=>C.resolve(w)).catch(w=>{this.isNormalPortFailed&&C.reject(w),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(R,this.forceCloseWSDuration)},this.try443PortDuration)})(),C.promise}chooseBestWebsocket(e,n,o,c){return this.useDoubleDomain=!!n,typeof e=="string"&&(e=function(u){let m,_,S;return[,m,_,S]=u.match(Mp)||[],m||([,_,S]=u.match(sP)||[]),_&&S||([,_,S]=u.match(Mw)||[]),_&&S||([,_]=u.match(oP)||[]),_||M.warning("un-destructible url: ",u),{proxy:m,host:_,port:S||"443"}}(e)),this.recordIndex=c,this.useProxy=!!e.proxy,o&&this.useProxy&&(M.warn("cannot use 443 only when use proxy"),o=!1),this.createWebSocket(e,!!o,!1).finally(()=>this.clearTimeout())}}function cP(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}class dP extends Dt{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;xe(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(qe.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(qe.CONNECTED):this._state==="closed"?this.emit(qe.CLOSED):this._state==="failed"&&this.emit(qe.FAILED))}resetReconnectCount(e){M.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,n){let o=arguments.length>2&&arguments[2]!==void 0&&arguments[2],c=arguments.length>3&&arguments[3]!==void 0&&arguments[3],u=arguments.length>4&&arguments[4]!==void 0&&arguments[4],m=arguments.length>5?arguments[5]:void 0;super(),D(this,"connectionID",0),D(this,"currentURLIndex",0),D(this,"urls",[]),D(this,"_reconnectMode","tryNext"),D(this,"reconnectReason",void 0),D(this,"_initMutex",new Zr("websocket")),D(this,"name",void 0),D(this,"_state","closed"),D(this,"reconnectInterrupter",void 0),D(this,"websocket",void 0),D(this,"retryConfig",void 0),D(this,"reconnectCount",0),D(this,"forceCloseTimeout",5e3),D(this,"onlineReconnectListener",void 0),D(this,"useCompress",void 0),D(this,"tryDoubleDomain",!1),D(this,"use443PortOnly",!1),D(this,"wsInflateLength",0),D(this,"wsDeflateLength",0),D(this,"closeEstablishingWs",()=>{}),D(this,"store",void 0),D(this,"joinGatewayRecordIndex",void 0),this.store=m,this.name=e,this.retryConfig=function(w){for(var N=1;N<arguments.length;N++){var L=arguments[N]!=null?arguments[N]:{};N%2?cP(Object(L),!0).forEach(function(H){D(w,H,L[H])}):Object.getOwnPropertyDescriptors?Object.defineProperties(w,Object.getOwnPropertyDescriptors(L)):cP(Object(L)).forEach(function(H){Object.defineProperty(w,H,Object.getOwnPropertyDescriptor(L,H))})}return w}({},n),this.useCompress=o,this.tryDoubleDomain=c,this.use443PortOnly=u;const{timeout:_,timeoutFactor:S}=n,C=Math.max(300,Math.floor(3*_/5)),R=Math.max(1.2,Math.floor(8*S)/10);fn.ONLINE&&(this.retryConfig.timeout=C,this.retryConfig.timeoutFactor=R),ki.on(us.NETWORK_STATE_CHANGE,(w,N)=>{w!==N&&(this.resetReconnectCount("network state change: ".concat(N," -> ").concat(w)),w===fn.ONLINE?(this.retryConfig.timeout=C,this.retryConfig.timeoutFactor=R):(this.retryConfig.timeout=_,this.retryConfig.timeoutFactor=S))})}getConnection(){return this.websocket||void 0}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const o=await this._initMutex.lock();this.forceCloseTimeout=n,this.urls=e,this.state="connecting";try{const c=zm(),u=this.urls[this.currentURLIndex];this.createWebSocketConnection(u).then(c.resolve).catch(c.reject),this.once(qe.CLOSED,()=>{c.reject(new ke(Q.WS_DISCONNECT))}),this.once(qe.CONNECTED,c.resolve),await c.promise}catch{}finally{o()}}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const o=this.websocket;n?setTimeout(()=>o.close(),500):o.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,n){if(!this.websocket)return void M.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),M.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const o=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),o&&o.bind(this.websocket)({code:9999,reason:n})}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new ke(Q.WS_ABORT,"websocket is not ready");try{n||(e=JSON.stringify(e)),this.websocket.send(e)}catch(o){throw new ke(Q.WS_ERR,"send websocket message error"+o.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var n;const o=zm();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const c=R=>{var w;(w=this.store)===null||w===void 0||w.signalChannelOpen(),M.debug("[".concat(this.name,"] websocket opened:"),R),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),o.resolve()},u=async R=>{var w;if(M.debug("[".concat(this.name,"] websocket close ").concat((w=this.websocket)===null||w===void 0?void 0:w.url,", code: ").concat(R.code,", reason: ").concat(R.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)o.reject(new ke(Q.WS_DISCONNECT,"websocket close: ".concat(R.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=R.reason,this.state="reconnecting");const N=mo(this,qe.WILL_RECONNECT,this.reconnectMode,R.reason)||this.reconnectMode,L=await this.reconnectWithAction(N);if(this.state==="closed")return void M.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!L)return o.reject(new ke(Q.WS_DISCONNECT,"websocket reconnect failed: ".concat(R.code))),this.close(!0);o.resolve()}},m=R=>{this.emit(qe.ON_MESSAGE,R)},_=R=>{M.warn("[".concat(this.connectionID,"] ws open error ").concat(R))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),oe("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=oe("GATEWAY_WSS_ADDRESS")),M.debug("[".concat(this.name,"] start connect, url:"),e);const S=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var C;const R=await this.chooseBestWebsocketConnection(e);this.websocket=R,c&&c(this.websocket.url),this.websocket.onclose=u,this.websocket.onmessage=m,this.websocket.onerror=_,(C=this.store)===null||C===void 0||C.recordJoinChannelService({endTs:Date.now(),status:"success"},S),this.joinGatewayRecordIndex=S}catch(R){const w=this.state==="closed",N=R instanceof ke,L=N&&R.code===Q.WS_ABORT,H=N&&R.code===Q.WS_ERR,j=N?R.message:R&&(R.reason||R.toString());M.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(j)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:L?"aborted":"error",errors:[R]},S),w||H?(o.reject(w?new ke(Q.WS_DISCONNECT,"websocket is closed: ".concat(j)):new ke(Q.WS_ERR,"init websocket failed: ".concat(j))),H&&M.error("[".concat(this.name,"] init websocket failed: ").concat(j))):u&&u(R)}return o.promise}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;M.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||ki.isOnline||!ki.onlineWaiter||(this.onlineReconnectListener=ki.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let o=!0;if(this.reconnectInterrupter=()=>o=!1,n){const m=al(this.reconnectCount,this.retryConfig);M.debug("[".concat(this.name,"] wait ").concat(m,"ms to reconnect websocket, mode: ").concat(e)),await Ee.race([Br(m),this.onlineReconnectListener||new Ee(()=>{})])}if(this._state==="closed"||!o)return!1;this.reconnectCount+=1;const c=async(m,_)=>{this.emit(qe.RECONNECT_CREATE_CONNECTION,_),await this.createWebSocketConnection(m)};try{if(e==="retry")this.emit(qe.RECONNECT_WAITTING_FINISH,e),await c(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);M.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(qe.RECONNECT_WAITTING_FINISH,e),await c(this.urls[this.currentURLIndex],e)}else e==="recover"&&(M.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(qe.RECONNECT_WAITTING_FINISH,e),this.urls=await Ji(this,qe.REQUEST_NEW_URLS),this.currentURLIndex=0,await c(this.urls[this.currentURLIndex],e))}catch(m){var u;M.error("[".concat(this.name,"] reconnect failed ").concat(m&&m.toString()));const _=m==null||(u=m.data)===null||u===void 0?void 0:u.desc;return Array.isArray(_)&&xe(_).call(_,"dynamic key expired")?(this.emit(qe.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,n)}return!0}}class fg extends dP{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){const o=zm(),c=function(m,_){return new zB(m,_)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{M.debug("[choose-best-ws] close establishing websockets"),c.closeAllWebsockets(),o.reject(new ke(Q.WS_ABORT,"choose best websocket aborted"))};const u=oe("GATEWAY_DOMAINS");return M.debug("[choose-best-ws] currentDomain: ",e,", domains: ",u,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),c.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,n).then(o.resolve).catch(o.reject),o.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class _g extends dP{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){return new Ee((o,c)=>{let u=!1;const m=[];this.closeEstablishingWs=()=>{M.debug("[choose-best-ws] close establishing websockets"),m.forEach(H=>{H.onclose=null,H.onopen=null,H.onmessage=null,H.close()}),c(new ke(Q.WS_ABORT,"choose best websocket aborted"))};const _=oe("GATEWAY_DOMAINS");let S;const C=e.indexOf("?h="),R=_.find(H=>C!==-1?xe(e).call(e,H,C):xe(e).call(e,H));M.debug("[choose-best-ws] currentDomain: ",R,", domains: ",_);let w=!this.tryDoubleDomain||!R;if(!w&&R){var N;const H=Date.now();try{_.forEach(j=>{const W=C===-1?e.replace(R,j):e.substr(0,C)+e.substr(C).replace(R,j),ee=new WebSocket(W);ee.binaryType="arraybuffer",m.push(ee),M.debug("[choose-best-ws] ws is connecting:",ee.url)})}catch{for(M.debug("[choose-best-ws] ws create failed, fallback to single url"),m.forEach(W=>W.close());m.length;)m.pop();w=!0}(N=this.store)===null||N===void 0||N.recordJoinChannelService({urls:m.map(j=>j.url),service:"gateway"},n),m.forEach(j=>{j.onopen=()=>{if(u)return;const W=Date.now()-H;M.debug("[choose-best-ws] ws open cost ".concat(W,"ms")),m.filter(ee=>ee!==j).forEach(ee=>{M.debug("[choose-best-ws]close backup websocket: ".concat(ee.url)),ee.close()}),u=!0,o(j)},j.onclose=W=>{S=W,!u&&(m.find(ee=>!(ee.readyState===WebSocket.CLOSED||ee.readyState===WebSocket.CLOSING))||(M.debug("[choose-best-ws] all websocket is closed"),u=!0,c(S)))},j.onmessage=W=>{M.debug("[choose-best-ws]".concat(j.url," onmessage: ").concat(W.data))}}),Br(this.forceCloseTimeout).then(()=>{m.forEach(j=>{j.readyState!==WebSocket.OPEN&&j.close()})})}if(w){var L;let H;M.debug("[choose-best-ws] use single url: ",e),(L=this.store)===null||L===void 0||L.recordJoinChannelService({urls:[e],service:"gateway"},n);try{H=new WebSocket(e),m.push(H),H.binaryType="arraybuffer"}catch(j){const W=new ke(Q.WS_ERR,"init websocket failed! Error: ".concat(j.toString()));return M.error("[".concat(this.name,"]").concat(W)),void c(W)}H.onopen=()=>{o(H)},H.onclose=j=>{c(j)},H.onmessage=j=>{M.debug("[choose-best-ws]".concat(H.url," onmessage: ").concat(j.data))},Br(this.forceCloseTimeout).then(()=>{H&&H.readyState!==WebSocket.OPEN&&H.close()})}}).then(o=>(this.closeEstablishingWs=void 0,o)).catch(o=>{throw this.closeEstablishingWs=void 0,o})}}class lP extends Dt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Jt.CONNECTED?this.emit(pt.WS_CONNECTED):e===Jt.RECONNECTING?this.emit(pt.WS_RECONNECTING,this._websocketReconnectReason):e===Jt.CLOSED&&this.emit(pt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),D(this,"_disconnectedReason",void 0),D(this,"_websocketReconnectReason",void 0),D(this,"_connectionState",Jt.CLOSED),D(this,"reconnectToken",void 0),D(this,"websocket",void 0),D(this,"openConnectionTime",void 0),D(this,"clientId",void 0),D(this,"lastMsgTime",Date.now()),D(this,"uploadCache",[]),D(this,"uploadCacheInterval",void 0),D(this,"rttRolling",new rf(5)),D(this,"pingpongTimer",void 0),D(this,"wsInflateDataTimer",void 0),D(this,"pingpongTimeoutCount",0),D(this,"joinResponse",void 0),D(this,"multiIpOption",void 0),D(this,"initError",void 0),D(this,"spec",void 0),D(this,"store",void 0),D(this,"onWebsocketMessage",o=>{if(o.data instanceof ArrayBuffer)return void this.emit(pt.ON_BINARY_DATA,o.data);const c=JSON.parse(o.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(c,"_id")){const u="res-@".concat(c._id);this.emit(u,c._result,c._message)}else if(Object.prototype.hasOwnProperty.call(c,"_type")){if(this.emit(c._type,c._message),c._type===Qe.ON_NOTIFICATION&&this.handleNotification(c._message),c._type===Qe.ON_USER_BANNED)switch(c._message.error_code){case 14:this.close(un.UID_BANNED);break;case 15:this.close(un.IP_BANNED);break;case 16:this.close(un.CHANNEL_BANNED)}if(c._type===Qe.ON_USER_LICENSE_BANNED)switch(c._message.error_code){case Ct.ERR_LICENSE_MISSING:this.close(un.LICENSE_MISSING);break;case Ct.ERR_LICENSE_EXPIRED:this.close(un.LICENSE_EXPIRED);break;case Ct.ERR_LICENSE_MINUTES_EXCEEDED:this.close(un.LICENSE_MINUTES_EXCEEDED);break;case Ct.ERR_LICENSE_PERIOD_INVALID:this.close(un.LICENSE_PERIOD_INVALID);break;case Ct.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(un.LICENSE_MULTIPLE_SDK_SERVICE);break;case Ct.ERR_LICENSE_ILLEGAL:this.close(un.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new fg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,oe("JOIN_GATEWAY_USE_DUAL_DOMAIN"),oe("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Jt.CONNECTED&&this.reconnect("retry",In.OFFLINE)})}async request(e,n,o,c){const u=oi(6,""),m={_id:u,_type:e,_message:n},_=this.websocket.connectionID,S=()=>new Ee((H,j)=>{if(this.connectionState===Jt.CONNECTED)return H();const W=()=>{this.off(pt.WS_CLOSED,ee),H()},ee=()=>{this.off(pt.WS_CONNECTED,W),j(new Te(Q.WS_ABORT))};this.once(pt.WS_CONNECTED,W),this.once(pt.WS_CLOSED,ee),e!==ft.PUBLISH&&e!==ft.PUBLISH_DATASTREAM&&e!==ft.SUBSCRIBE&&e!==ft.SUBSCRIBE_DATASTREAM&&e!==ft.UNSUBSCRIBE&&e!==ft.UNSUBSCRIBE_DATASTREAM&&e!==ft.UNPUBLISH&&e!==ft.UNPUBLISH_DATASTREAM&&e!==ft.CONTROL&&e!==ft.RESTART_ICE||this.once(pt.DISCONNECT_P2P,()=>{j(new Te(Q.DISCONNECT_P2P))}),e!==ft.PUBLISH&&e!==ft.RESTART_ICE||this.once(pt.ABORT_P2P_EXECUTION,()=>{j(new Te(Q.DISCONNECT_P2P))})});if(this.connectionState!==Jt.CONNECTING&&this.connectionState!==Jt.RECONNECTING||e===ft.JOIN||e===ft.REJOIN||await S(),this.websocket.sendMessage(m,!0),c)return;const C=new Ee((H,j)=>{let W=!1;const ee=(fe,be)=>{W=!0,H({isSuccess:fe==="success",message:be||{}}),this.off(pt.WS_CLOSED,re),this.off(pt.WS_RECONNECTING,re),this.emit(pt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(u),ee);const re=()=>{j(new Te(Q.WS_ABORT,"type: ".concat(e))),this.off(pt.WS_CLOSED,re),this.off(pt.WS_RECONNECTING,re),this.off("res-@".concat(u),ee)};this.once(pt.WS_CLOSED,re),this.once(pt.WS_RECONNECTING,re),Br(oe("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==_||W||(M.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(pt.REQUEST_TIMEOUT,e,n))})});let R=null;try{R=await C}catch(H){if(this.connectionState===Jt.CLOSED||e===ft.LEAVE)throw new Te(Q.WS_ABORT);return!this.spec.forceWaitGatewayResponse||o?H.throw():e===ft.JOIN||e===ft.REJOIN?null:(await S(),await this.request(e,n))}if(R.isSuccess)return R.message;const w=Number(R.message.error_code||R.message.code),N=fh(w),L=new Te(Q.UNEXPECTED_RESPONSE,"".concat(N.desc,": ").concat(R.message.error_str),{code:w,data:R.message});return N.action==="success"?R.message:(M.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(w,", message: ").concat(N.desc,", action: ").concat(N.action)),w===Ct.ERR_TOO_MANY_BROADCASTERS?((e===ft.JOIN||e===ft.REJOIN)&&(this.initError=L,this.close()),L.throw()):N.action==="failed"?L.throw():N.action==="quit"?(this.initError=L,this.close(),L.throw()):(w===Ct.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=R.message.option,M.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",In.MULTI_IP)):this.reconnect(N.action,In.SERVER_ERROR),e===ft.JOIN||e===ft.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new Ee(o=>{const c=u=>{(!n||n(u))&&(this.off(e,c),o(u))};this.on(e,c)})}uploadWRTCStats(e){if(!this.store.sessionId)return void M.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(fr.WRTC_STATS,n)}upload(e,n){const o={_type:e,_message:n};try{this.websocket.sendMessage(o)}catch{const u=oe("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(o),this.uploadCache.length>u&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Jt.CONNECTED)return;const m=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(m._type,m._message)},oe("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const o={_type:e,_message:n};this.websocket.sendMessage(o)}init(e,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Ee((o,c)=>{this.once(pt.WS_CONNECTED,()=>o(this.joinResponse)),this.once(pt.WS_CLOSED,()=>c(this.initError||new Te(Q.WS_ABORT))),this.connectionState=Jt.CONNECTING,this.websocket.init(e).catch(c),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||un.LEAVE,this.connectionState=Jt.CLOSED,M.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===un.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new fg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,oe("JOIN_GATEWAY_USE_DUAL_DOMAIN"),oe("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(pt.ABORT_P2P_EXECUTION);const e=await Ji(this,pt.REQUEST_JOIN_INFO),n=await this.request(ft.JOIN,e);if(!n)return this.emit(pt.REPORT_JOIN_GATEWAY,Do.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(pt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Te(Q.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=Gn(this,pt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const n=await this.request(ft.REJOIN,e);return!!n&&(this.connectionState=Jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(o=>{this.emit(Qe.ON_USER_ONLINE,{uid:o.uid}),o.audio&&this.emit(Qe.ON_ADD_AUDIO_STREAM,{uid:o.uid,uint_id:o.uint_id,audio:!0,ssrcId:o.audio_ssrc}),o.video&&this.emit(Qe.ON_ADD_VIDEO_STREAM,{uid:o.uid,uint_id:o.uint_id,video:!0,ssrcId:o.video_ssrc}),o.audio_mute?this.emit(Qe.MUTE_AUDIO,{uid:o.uid}):this.emit(Qe.UNMUTE_AUDIO,{uid:o.uid}),o.video_mute?this.emit(Qe.MUTE_VIDEO,{uid:o.uid}):this.emit(Qe.UNMUTE_VIDEO,{uid:o.uid}),o.audio_enable_local?this.emit(Qe.ENABLE_LOCAL_AUDIO,{uid:o.uid}):this.emit(Qe.DISABLE_LOCAL_AUDIO,{uid:o.uid}),o.video_enable_local?this.emit(Qe.ENABLE_LOCAL_VIDEO,{uid:o.uid}):this.emit(Qe.DISABLE_LOCAL_VIDEO,{uid:o.uid}),o.audio||o.video||this.emit(Qe.ON_REMOVE_STREAM,{uid:o.uid,uint_id:o.uint_id})}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleNotification(e){M.debug("[".concat(this.clientId,"] receive notification: "),e);const n=fh(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(un.UID_BANNED),void this.close()):void this.reconnect(n.action,In.SERVER_ERROR);M.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=oe("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(M.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>oe("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",In.TIMEOUT):this.request(ft.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const o=Date.now()-n;this.rttRolling.add(o),oe("REPORT_STATS")&&this.send(ft.PING_BACK,{pingpongElapse:o})}).catch(o=>{})}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:n}=this.websocket.getWsInflateData();e!==0&&n!==0&&this.upload(fr.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(qe.RECONNECT_WAITTING_FINISH,e=>{this.emit(pt.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(qe.RECONNECT_CREATE_CONNECTION,e=>{this.emit(pt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(qe.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(qe.CLOSED,()=>{this.connectionState=Jt.CLOSED}),this.websocket.on(qe.FAILED,()=>{this._disconnectedReason=un.NETWORK_ERROR,this.connectionState=Jt.CLOSED}),this.websocket.on(qe.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Jt.CONNECTED?this.connectionState=Jt.RECONNECTING:this.connectionState=Jt.CONNECTING}),this.websocket.on(qe.WILL_RECONNECT,(e,n,o)=>{const c=Gn(this,pt.IS_P2P_DISCONNECTED),u=c||e!=="retry";c&&e==="retry"&&(M.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",n=Do.P2P_DISCONNECTED),u&&(M.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(pt.REPORT_JOIN_GATEWAY,n||Do.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(pt.NEED_RENEW_SESSION),this.emit(pt.DISCONNECT_P2P)),o(e)}),this.websocket.on(qe.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{M.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",In.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(pt.REPORT_JOIN_GATEWAY,e.message||e.code||Do.UNKNOWN_REASON,this.url||""),e instanceof Te&&e.code===Q.UNEXPECTED_RESPONSE&&e.data.code===Ct.ERR_NO_AUTHORIZED)return M.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",In.SERVER_ERROR);M.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",In.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(qe.REQUEST_NEW_URLS,(e,n)=>{Ji(this,pt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(qe.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Qe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var Uw=`	
\v\f\r                　\u2028\u2029\uFEFF`,uP=Ul,Eg=Bs,Up=Uw,xw=ae("".replace),hP=RegExp("^["+Up+"]+"),qB=RegExp("(^|[^"+Up+"])["+Up+"]+$"),Vw=function(r){return function(e){var n=Eg(uP(e));return 1&r&&(n=xw(n,hP,"")),2&r&&(n=xw(n,qB,"$1")),n}},Fw={start:Vw(1),end:Vw(2),trim:Vw(3)},pP=DI.PROPER,JB=O,mP=Uw,jw=Fw.trim;Xt({target:"String",proto:!0,forced:function(r){return JB(function(){return!!mP[r]()||"​᠎"[r]()!=="​᠎"||pP&&mP[r].name!==r})}("trim")},{trim:function(){return jw(this)}});var ts,pc,XB=sa("String").trim,fP=ge,QB=XB,Or=String.prototype,ua=A(function(r){var e=r.trim;return typeof r=="string"||r===Or||fP(Or,r)&&e===Or.trim?QB:e});function _P(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function rC(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?_P(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):_P(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function _h(r){return r.match(/^[\.\:\d]+$/)?"".concat(r.replace(/[^\d]/g,"-"),".").concat(oe("TURN_DOMAIN")):(M.info("Unidentified as ip: ".concat(r,", use as host")),r)}function sC(r,e){r.addresses||(r.addresses=[]);const n=function(u,m){if(oe("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return u.map(C=>{let{ip:R,port:w}=C;return{address:"".concat(R,":").concat(w)}});const _=oe("GATEWAY_DOMAINS");let S=_[1]&&xe(m).call(m,_[1])?1:0;return u.map(C=>{let{domain_prefix:R,port:w,ip:N}=C;if(R)return{address:"".concat(R,".").concat(_[S++%_.length],":").concat(w)};const L=/^[\.\:\d]+$/.test(N),H=L?"".concat(N.replace(/[^\d]/g,"-"),".").concat(_[S++%_.length],":").concat(w):"".concat(N,":").concat(w);return L||M.info("Unidentified as ip: ".concat(N,", use as host")),{ip:N,port:w,address:H}})}(r.addresses,e),o=Array.isArray(r.detail)&&r.detail[18];if(o&&typeof o=="string"){const u=o.split(";");for(let m=0;m<u.length;m++){var c;const _=ua(c=u[m]).call(c);n[m]&&_&&(n[m].ip6=_)}}return{gatewayAddrs:n,uid:r.uid,cid:r.cid,cert:r.cert,vid:r.detail&&r.detail[8],uni_lbs_ip:r.detail&&r.detail[1],res:r,csIp:r.detail&&r.detail[502]}}function Yo(r){return typeof r=="number"?r:r.exact||r.ideal||r.max||r.min||0}function Bw(r){const e=r._encoderConfig;if(!e)return{};const n={resolution:e.width&&e.height?"".concat(Yo(e.width),"x").concat(Yo(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(n.maxFrameRate=e.frameRate,n.minFrameRate=e.frameRate):e.frameRate&&(n.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,n.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),n}function gg(r){return r>=0&&r<.17?1:r>=.17&&r<.36?2:r>=.36&&r<.59?3:r>=.59&&r<=1?4:r>1?5:0}function hl(r,e){let n,o,c;switch(e){case ts.CHOOSE_SERVER:o=4096,c="choose server";break;case ts.CLOUD_PROXY:o=1048576,c="proxy";break;case ts.CLOUD_PROXY_5:o=4194304,c="proxy5";break;case ts.CLOUD_PROXY_FALLBACK:o=4194310,c="proxy fallback";break;default:throw new Te(Q.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:r.detail&&r.detail[502],retry:!1})}if(r.response_body.forEach(u=>{u.buffer&&u.buffer.flag===o&&(n={code:u.buffer.code,addresses:(u.buffer.edges_services||[]).map(m=>rC(rC({},m),{},{ticket:u.buffer.cert})),server_ts:r.enter_ts,uid:u.buffer.uid,cid:u.buffer.cid,cname:u.buffer.cname,detail:rC(rC({},u.buffer.detail),r.detail),flag:u.buffer.flag,opid:r.opid,cert:u.buffer.cert})}),!n)throw new Te(Q.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(c," from multi unilbs response"),{csIp:r.detail&&r.detail[502]});return n}async function EP(r,e){return await Ee.all(r.addresses.map(async n=>({address:_h(n.ip),tcpport:n.port,udpport:n.port,username:e&&oe("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Mt.username,password:e&&oe("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await dn(e.toString()):Mt.password})))}function zo(r,e){const n=e._videoHeight||e.getMediaStreamTrack(!0).getSettings().height;return n?Math.max(n/Yo(r.height),1):(M.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function du(r){let{candidateType:e,relayProtocol:n,type:o,address:c,port:u,protocol:m}=r;return o==="local-candidate"?{candidateType:e,relayProtocol:n,protocol:m}:{candidateType:e,relayProtocol:n,address:c,port:u,protocol:m}}function Gw(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}(function(r){r[r.CHOOSE_SERVER=11]="CHOOSE_SERVER",r[r.CLOUD_PROXY=18]="CLOUD_PROXY",r[r.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",r[r.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"})(ts||(ts={}));class Ww extends Dt{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;xe(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Qi.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Qi.CONNECTED):this._state==="closed"?this.emit(Qi.CLOSED):this._state==="failed"&&this.emit(Qi.FAILED))}constructor(e,n,o,c){super(),D(this,"connectionID",0),D(this,"currentURLIndex",0),D(this,"reconnectReason",void 0),D(this,"_reconnectMode","tryNext"),D(this,"_name",void 0),D(this,"_state","closed"),D(this,"_retryConfig",void 0),D(this,"_reconnectCount",0),D(this,"_forceCloseTimeout",5e3),D(this,"_onlineReconnectListener",void 0),D(this,"_closeEstablishingTransmitter",()=>{}),D(this,"_store",void 0),D(this,"_joinChannelServiceRecordIndex",void 0),D(this,"_useCompress",void 0),D(this,"_inflateLength",0),D(this,"_deflateLength",0),this._store=c,this._name=e,this._retryConfig=function(u){for(var m=1;m<arguments.length;m++){var _=arguments[m]!=null?arguments[m]:{};m%2?Gw(Object(_),!0).forEach(function(S){D(u,S,_[S])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(_)):Gw(Object(_)).forEach(function(S){Object.defineProperty(u,S,Object.getOwnPropertyDescriptor(_,S))})}return u}({},n),this._useCompress=o}resetReconnectCount(e){M.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const o=this._transmitter;n?setTimeout(()=>o.close(),500):o.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,n){if(!this._transmitter)return void M.warning("[".concat(this._name,"] can not reconnect, no websocket"));var o;e!==void 0&&(this.reconnectMode=e),M.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((o=this._store)===null||o===void 0||o.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const c=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),c&&c.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const e=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:n}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}(function(r){r[r.Default=0]="Default",r[r.Ack=1]="Ack"})(pc||(pc={}));class ZB{constructor(e,n,o){D(this,"version",1),D(this,"initialRTO",void 0),D(this,"maxBatchAckCount",void 0),D(this,"maxRTO",void 0),D(this,"initialRTT",void 0),D(this,"ID",void 0),D(this,"rtt",void 0),D(this,"packetNumber",1),D(this,"rtoRatioMap",new Map),D(this,"timeoutMap",new Map),D(this,"unorderedPacketQueue",[]),D(this,"batchAckPacketQueue",[]),D(this,"lastOrderedPacketNumber",0),D(this,"batchAckTimer",void 0),D(this,"sendImpl",void 0),D(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=n,this.ID=oi(7,"transmitter-"),this.initialRTO=(o==null?void 0:o.initialRTO)!==void 0?o.initialRTO:oe("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(o==null?void 0:o.initialRTT)!==void 0?o.initialRTT:oe("TRANSMITTER_INITIAL_RTT"),this.rtt=(o==null?void 0:o.initialRTT)!==void 0?o.initialRTT:oe("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(o==null?void 0:o.maxBatchAckCount)!==void 0?o.maxBatchAckCount:oe("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(o==null?void 0:o.maxRTO)!==void 0?o.maxRTO:oe("TRANSMITTER_MAX_RTO")}packetize(e,n){return{type:pc.Default,version:this.version,packetNumber:n,payload:e}}serialize(e){switch(e.type){case pc.Default:{let n;typeof e.payload=="string"?n=new TextEncoder().encode(e.payload):n=e.payload;const o=new ArrayBuffer(n.length+15),c=new DataView(o);return c.setUint16(0,e.version),c.setUint8(2,e.type),c.setUint32(3,e.packetNumber),PT(c,7,BigInt(e.sendTs)),new Uint8Array(c.buffer).set(n,15),o}case pc.Ack:{const n=new ArrayBuffer(16),o=new DataView(n);return o.setUint16(0,e.version),o.setUint8(2,e.type),o.setUint32(3,e.maxAckPacketNumber),o.setUint8(7,e.shift),PT(o,8,BigInt(e.ackSendTs)),n}}}deserialize(e){const n=new DataView(e),o=n.getUint16(0),c=n.getUint8(2);switch(c){case pc.Default:{const u=n.getUint32(3),m=RD(n,7),_=e.slice(15),S=new TextDecoder().decode(_);return{version:o,type:c,packetNumber:u,sendTs:Number(m),payload:S}}case pc.Ack:{const u=n.getUint32(3),m=n.getUint8(7),_=RD(n,8);return{version:o,type:c,maxAckPacketNumber:u,shift:m,ackSendTs:Number(_)}}default:throw M.error("[".concat(this.ID,"] Unrecognized packet type ").concat(c)),new Error("Unrecognized packet type ".concat(c))}}sendMessage(e){const n=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const o=this.calculateRTO(n),c=window.setTimeout(()=>{this.resendMessage(n)},o);this.timeoutMap.set(n.packetNumber,c),this.sendPacket(n)}onData(e){const n=this.deserialize(e);n.type===pc.Default?this.ack(n):n.type===pc.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[n,o]=e;window.clearTimeout(o)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const n=this.calculateRTO(e),o=window.setTimeout(()=>{this.resendMessage(e)},n);this.timeoutMap.set(e.packetNumber,o),this.sendPacket(e)}calculateRTO(e){const n=this.rtoRatioMap.get(e.packetNumber);if(n===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const o=9*this.rtt/8*n;return this.rtoRatioMap.set(e.packetNumber,n+1),o>this.maxRTO?this.maxRTO:o}}updateRTT(e,n){const o=e.ackSendTs;this.rtt=this.rtt*(7/8)+(n-o-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:pc.Ack,version:this.version};this.sendPacket(n)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:pc.Ack,version:this.version};this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:pc.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===pc.Default&&(e.sendTs=Math.round(performance.now()));const n=this.serialize(e);this.sendImpl(n)}clearRTO(e){for(let n=e.maxAckPacketNumber-e.shift;n<=e.maxAckPacketNumber;n++){const o=this.timeoutMap.get(n);o!==void 0&&window.clearTimeout(o),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class oC extends Ww{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),D(this,"_initMutex",void 0),D(this,"_reconnectInterrupter",void 0),D(this,"_url",void 0),D(this,"_transmitter",void 0),D(this,"_addresses",void 0),D(this,"_reliableTransmission",void 0),this._initMutex=new Zr("datachannel");const{timeout:o,timeoutFactor:c}=n,u=Math.max(300,Math.floor(3*o/5)),m=Math.max(1.2,Math.floor(8*c)/10);fn.ONLINE&&(this._retryConfig.timeout=u,this._retryConfig.timeoutFactor=m),ki.on(us.NETWORK_STATE_CHANGE,(_,S)=>{_!==S&&(this.resetReconnectCount("network state change: ".concat(S," -> ").concat(_)),_===fn.ONLINE?(this._retryConfig.timeout=u,this._retryConfig.timeoutFactor=m):(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=c))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;const o=(c,u)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(_=>_.fingerprint||oe("FINGERPRINT"));const m=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(m).then(c).catch(u),this.once(Qi.CLOSED,()=>u(new Te(Q.WS_DISCONNECT))),this.once(Qi.CONNECTED,()=>c())};return this._initMutex.lock().then(c=>new Ee((u,m)=>{o(u,m)}).then(()=>{c()}).catch(()=>{c()}))}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new Te(Q.WS_ABORT,"datachannel is not ready");try{n||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(o){throw new Te(Q.WS_ERR,"send datachannel signal message error"+o.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const n=JSON.stringify(e);return{compressed:n,compressedLength:n.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new Ee((n,o)=>{var c;const u=()=>{M.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n()},m=async R=>{var w;if((w=this._closeEstablishingTransmitter)===null||w===void 0||w.call(this),M.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(R.code,", reason: ").concat(R.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=R.reason,this.state="reconnecting");const N=mo(this,Qi.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,L=await this.reconnectWithAction(N);if(this.state==="closed")return void M.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!L)return o(new Te(Q.WS_DISCONNECT,"datachannel reconnect failed: ".concat(R.code))),void this.close(!0);n()}else o(new Te(Q.WS_DISCONNECT,"datachannel close: ".concat(R.code))),this.close()},_=R=>{var w;(w=this._reliableTransmission)===null||w===void 0||w.onData(R.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),M.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const S=(c=this._store)===null||c===void 0?void 0:c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),C=Date.now();Ji(this,Qi.TO_CONNECT_DATACHANNEL,e).then(R=>{var w,N;if(!R)throw new Error("transmissonInfo not exist yet");const{transmitter:L,close:H}=R;this._transmitter=L,(w=this._store)===null||w===void 0||w.signalChannelOpen();const j=Date.now()-C;M.debug("[choose dc] dc open cost ".concat(j,"ms")),this._reliableTransmission=new ZB(W=>{var ee;this._transmitter&&this._transmitter.readyState==="open"&&((ee=this._transmitter)===null||ee===void 0||ee.send(W))},W=>{typeof W=="string"&&this.emit(Qi.ON_MESSAGE,W)}),this._closeEstablishingTransmitter=()=>{var W;(W=this._reliableTransmission)===null||W===void 0||W.close(),this._reliableTransmission=void 0,H()},u&&u(),L.onclose=m,L.onmessage=_,(N=this._store)===null||N===void 0||N.recordJoinChannelService({endTs:Date.now(),status:"success"},S),this._joinChannelServiceRecordIndex=S}).catch(R=>{var w;if((w=this._store)===null||w===void 0||w.recordJoinChannelService({endTs:Date.now(),status:R instanceof Te&&R.code===Q.WS_ABORT?"aborted":"error",errors:[R]},S),this.state!=="closed"){if(R instanceof Te&&R.code===Q.WS_ERR){const N=new Te(Q.WS_ERR,"init datachannel failed! Error: ".concat(R.toString()));return M.error("[".concat(this._name,"]").concat(N)),void o(N)}m&&m(R)}else o(new Te(Q.WS_DISCONNECT,"datachannel is closed: ".concat(R.toString())))})})}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||ki.networkState!==fn.OFFLINE||(this._onlineReconnectListener=ki.onlineWaiter&&ki.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let o=!0;if(this._reconnectInterrupter=()=>{o=!1},n){const _=al(this._reconnectCount,this._retryConfig);M.debug("[".concat(this._name,"] wait ").concat(_,"ms to reconnect datachannel, mode: ").concat(e)),await Ee.race([Br(_),this._onlineReconnectListener||new Ee(()=>{})])}if(this.state==="closed"||!o)return!1;this._reconnectCount+=1;const c=async(_,S)=>{this.emit(Qi.RECONNECT_CREATE_CONNECTION,S),await this.createTransmitterConnection(_)};try{if(e==="retry"){const _=this._addresses[this.currentURLIndex];this.emit(Qi.RECONNECT_WAITTING_FINISH,e),await c(_,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let S=this.currentURLIndex;S<this._addresses.length;S++){if(this._addresses[S].fingerprint||oe("FINGERPRINT")){this.currentURLIndex=S;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return M.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);M.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const _=this._addresses[this.currentURLIndex];this.emit(Qi.RECONNECT_WAITTING_FINISH,e),await c(_,e)}else e==="recover"&&(M.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(Qi.RECONNECT_WAITTING_FINISH,e),this.emit(Qi.FAILBACK));return!0}catch(_){var u,m;return M.error("[".concat(this._name,"] reconnect failed"),_.toString()),_!=null&&(u=_.data)!==null&&u!==void 0&&u.desc&&Array.isArray(_.data.desc)&&_.data.desc.length&&xe(m=_.data.desc).call(m,"dynamic key expired")?(this.emit(Qi.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,n)}}}class qo extends Dt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Jt.CONNECTED?this.emit(pt.WS_CONNECTED):e===Jt.RECONNECTING?this.emit(pt.WS_RECONNECTING,this._websocketReconnectReason):e===Jt.CLOSED&&this.emit(pt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),D(this,"_disconnectedReason",void 0),D(this,"_websocketReconnectReason",void 0),D(this,"_connectionState",Jt.CLOSED),D(this,"reconnectToken",void 0),D(this,"websocket",void 0),D(this,"openConnectionTime",void 0),D(this,"clientId",void 0),D(this,"lastMsgTime",Date.now()),D(this,"uploadCache",[]),D(this,"uploadCacheInterval",void 0),D(this,"rttRolling",new rf(5)),D(this,"pingpongTimer",void 0),D(this,"inflateDataTimer",void 0),D(this,"pingpongTimeoutCount",0),D(this,"joinResponse",void 0),D(this,"multiIpOption",void 0),D(this,"initError",void 0),D(this,"spec",void 0),D(this,"store",void 0),D(this,"onWebsocketMessage",o=>{if(o instanceof ArrayBuffer)return void this.emit(pt.ON_BINARY_DATA,o);const c=JSON.parse(o);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(c,"_id")){const u="res-@".concat(c._id);this.emit(u,c._result,c._message)}else if(Object.prototype.hasOwnProperty.call(c,"_type")&&(this.emit(c._type,c._message),c._type===Qe.ON_NOTIFICATION&&this.handleNotification(c._message),c._type===Qe.ON_USER_BANNED))switch(c._message.error_code){case 14:this.close(un.UID_BANNED);break;case 15:this.close(un.IP_BANNED);break;case 16:this.close(un.CHANNEL_BANNED)}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new oC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Jt.CONNECTED&&this.reconnect("retry",wt.OFFLINE)})}async request(e,n,o,c){const u=oi(6,""),m={_id:u,_type:e,_message:n},_=this.websocket.connectionID,S=()=>new Ee((H,j)=>{if(this.connectionState===Jt.CONNECTED)return H();const W=()=>{this.off(pt.WS_CLOSED,ee),H()},ee=()=>{this.off(pt.WS_CONNECTED,W),j(new Te(Q.WS_ABORT))};this.once(pt.WS_CONNECTED,W),this.once(pt.WS_CLOSED,ee),e!==ft.PUBLISH&&e!==ft.SUBSCRIBE&&e!==ft.UNSUBSCRIBE&&e!==ft.UNPUBLISH&&e!==ft.CONTROL&&e!==ft.RESTART_ICE||this.once(pt.DISCONNECT_P2P,()=>{j(new Te(Q.DISCONNECT_P2P))}),e!==ft.PUBLISH&&e!==ft.RESTART_ICE||this.once(pt.ABORT_P2P_EXECUTION,()=>{j(new Te(Q.DISCONNECT_P2P))})});if(this.connectionState!==Jt.CONNECTING&&this.connectionState!==Jt.RECONNECTING||e===ft.JOIN||e===ft.REJOIN||await S(),e===ft.LEAVE&&(this.websocket.unbindDcCloseEventListener(),c=!0),this.websocket.sendMessage(m,!0,!1),c)return;const C=new Ee((H,j)=>{let W=!1;const ee=(fe,be)=>{W=!0,H({isSuccess:fe==="success",message:be||{}}),this.off(pt.WS_CLOSED,re),this.off(pt.WS_RECONNECTING,re),this.emit(pt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(u),ee);const re=()=>{j(new Te(Q.WS_ABORT,"type: ".concat(e))),this.off(pt.WS_CLOSED,re),this.off(pt.WS_RECONNECTING,re),this.off("res-@".concat(u),ee)};this.once(pt.WS_CLOSED,re),this.once(pt.WS_RECONNECTING,re),Br(oe("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==_||W||(M.warning("dc request timeout, type: ".concat(e)),this.emit(pt.REQUEST_TIMEOUT,e,n))})});let R=null;try{R=await C}catch(H){if(this.connectionState===Jt.CLOSED||e===ft.LEAVE)throw new Te(Q.WS_ABORT);return!this.spec.forceWaitGatewayResponse||o?H.throw():e===ft.JOIN||e===ft.REJOIN?null:(await S(),await this.request(e,n))}if(R.isSuccess)return R.message;const w=Number(R.message.error_code||R.message.code),N=fh(w),L=new Te(Q.UNEXPECTED_RESPONSE,"".concat(N.desc,": ").concat(R.message.error_str),{code:w,data:R.message});return N.action==="success"?R.message:(M.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(w,", message: ").concat(N.desc,", action: ").concat(N.action)),w===Ct.ERR_TOO_MANY_BROADCASTERS?((e===ft.JOIN||e===ft.REJOIN)&&(this.initError=L,this.close()),L.throw()):N.action==="failed"?L.throw():N.action==="quit"?(this.initError=L,this.close(),L.throw()):(w===Ct.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=R.message.option,M.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",wt.MULTI_IP)):this.reconnect(N.action,wt.SERVER_ERROR),e===ft.JOIN||e===ft.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new Ee(o=>{const c=u=>{(!n||n(u))&&(this.off(e,c),o(u))};this.on(e,c)})}uploadWRTCStats(e){if(!this.store.sessionId)return void M.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(fr.WRTC_STATS,n)}upload(e,n){const o={_type:e,_message:n};try{this.websocket.sendMessage(o)}catch{const u=oe("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(o),this.uploadCache.length>u&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Jt.CONNECTED)return;const m=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(m._type,m._message)},oe("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const o={_type:e,_message:n};this.websocket.sendMessage(o)}init(e,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Ee((o,c)=>{this.once(pt.WS_CONNECTED,()=>o(this.joinResponse)),this.once(pt.WS_CLOSED,()=>c(this.initError||new Te(Q.WS_ABORT))),this.connectionState=Jt.CONNECTING,this.websocket.init(e).catch(c),this.websocket.once(Qi.FAILBACK,()=>{this.openConnectionTime===void 0&&c(new Te(Q.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{n&&this.openConnectionTime===void 0&&(M.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),c(new Te(Q.INIT_DATACHANNEL_TIMEOUT)))},oe("DC_JOIN_WITH_FAILBACK"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||un.LEAVE,this.connectionState=Jt.CLOSED,M.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===un.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new oC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(pt.ABORT_P2P_EXECUTION);const e=await Ji(this,pt.DATACHANNEL_CONNECTING),n=await this.request(ft.JOIN,e);if(!n)return this.emit(pt.REPORT_JOIN_GATEWAY,Q.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(pt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Te(Q.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=Gn(this,pt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const n=await this.request(ft.REJOIN,e);return!!n&&(this.connectionState=Jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(o=>{this.emit(Qe.ON_USER_ONLINE,{uid:o.uid}),o.audio&&this.emit(Qe.ON_ADD_AUDIO_STREAM,{uid:o.uid,uint_id:o.uint_id,audio:!0,ssrcId:o.audio_ssrc}),o.video&&this.emit(Qe.ON_ADD_VIDEO_STREAM,{uid:o.uid,uint_id:o.uint_id,video:!0,ssrcId:o.video_ssrc}),o.audio_mute?this.emit(Qe.MUTE_AUDIO,{uid:o.uid}):this.emit(Qe.UNMUTE_AUDIO,{uid:o.uid}),o.video_mute?this.emit(Qe.MUTE_VIDEO,{uid:o.uid}):this.emit(Qe.UNMUTE_VIDEO,{uid:o.uid}),o.audio_enable_local?this.emit(Qe.ENABLE_LOCAL_AUDIO,{uid:o.uid}):this.emit(Qe.DISABLE_LOCAL_AUDIO,{uid:o.uid}),o.video_enable_local?this.emit(Qe.ENABLE_LOCAL_VIDEO,{uid:o.uid}):this.emit(Qe.DISABLE_LOCAL_VIDEO,{uid:o.uid}),o.audio||o.video||this.emit(Qe.ON_REMOVE_STREAM,{uid:o.uid,uint_id:o.uint_id})}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleNotification(e){M.debug("[".concat(this.clientId,"] receive notification: "),e);const n=fh(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(un.UID_BANNED),void this.close()):void this.reconnect(n.action,wt.SERVER_ERROR);M.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=oe("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(M.warning("PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>oe("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",wt.TIMEOUT):this.request(ft.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const o=Date.now()-n;this.rttRolling.add(o),oe("REPORT_STATS")&&this.send(ft.PING_BACK,{pingpongElapse:o})}).catch(o=>{})}handleInflateData(){const{inflateLength:e,deflateLength:n}=this.websocket.getInflateData();e!==0&&n!==0&&this.upload(fr.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Qi.RECONNECT_WAITTING_FINISH,e=>{this.emit(pt.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(Qi.RECONNECT_CREATE_CONNECTION,e=>{this.emit(pt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Qi.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Qi.CLOSED,()=>{this.connectionState=Jt.CLOSED}),this.websocket.on(Qi.FAILED,()=>{this._disconnectedReason=un.NETWORK_ERROR,this.connectionState=Jt.CLOSED}),this.websocket.on(Qi.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Jt.CONNECTED?this.connectionState=Jt.RECONNECTING:this.connectionState=Jt.CONNECTING}),this.websocket.on(Qi.WILL_RECONNECT,(e,n)=>{if(Gn(this,pt.IS_P2P_DISCONNECTED)&&e==="retry")return M.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(pt.NEED_RENEW_SESSION),this.emit(pt.DISCONNECT_P2P),n("tryNext");e!=="retry"&&(M.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(pt.NEED_RENEW_SESSION),this.emit(pt.DISCONNECT_P2P)),n(e)}),this.websocket.on(Qi.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{M.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",wt.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(pt.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof Te&&e.code===Q.UNEXPECTED_RESPONSE&&e.data.code===Ct.ERR_NO_AUTHORIZED)return M.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",wt.SERVER_ERROR);M.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",wt.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Qi.REQUEST_NEW_URLS,(e,n)=>{Ji(this,pt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(Qi.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Qe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(Qi.TO_CONNECT_DATACHANNEL,async(e,n,o)=>Ji(this,pt.DATACHANNEL_PRECONNECT,e).then(n).catch(o)),this.websocket.on(Qi.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(pt.DATACHANNEL_FAILBACK)})}}class Eh extends Dt{constructor(e,n){super(),D(this,"signal",void 0),D(this,"token",void 0),D(this,"tokenTimeout",void 0),D(this,"tokenInterval",void 0),D(this,"_sequence",0),D(this,"userMap",new Map),D(this,"encoder",new TextEncoder),this.signal=e,this.token=n;const o=()=>{this.signal.connectionState===Jt.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(o,1e3):this.tokenInterval=window.setTimeout(o,3*oe("P2P_TOKEN_INTERVAL"))};o()}async send(e,n,o,c,u){var m,_,S;if(this.userMap.size===0)return;const C=Array.from(wd(m=this.userMap).call(m))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),c=(_=c)!==null&&_!==void 0?_:oi(6,""),u=(S=u)!==null&&S!==void 0?S:this._sequence++;const R={_id:c,_type:e,_seq:u,_message:n,token:"".concat(this.token,"_").concat(C)};oe("SHOW_P2P_LOG")&&M.debug("send message",R,"noNeedResponse : ".concat(o)),this.splitMessage(JSON.stringify(R)).forEach(N=>{this.signal.request(ft.DATA_STREAM,{payload:nf(this.encoder.encode(N))})});const w=new Ee((N,L)=>{const H=window.setTimeout(()=>{this.off("res-@".concat(c,"_ack"),j),this.off("res-@".concat(c),ee),this.off(cu.ABORT,W),M.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(c)),this.userMap.size===0?L(new ke(Q.INVALID_REMOTE_USER)):L(new ke(Q.TIMEOUT))},oe("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),j=()=>{H&&window.clearTimeout(H),this.off(cu.ABORT,W),o&&N()},W=()=>{H&&window.clearTimeout(H),this.off("res-@".concat(c,"_ack"),j),this.off("res-@".concat(c),ee),L(new ke(Q.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(c)))};this.once(cu.ABORT,W),this.once("res-@".concat(c,"_ack"),j);const ee=(fe,be)=>{re=!0,H&&window.clearTimeout(H),this.off("res-@".concat(c,"_ack"),j),this.off(cu.ABORT,W),fe==="success"?N(be):L(new ke(Q.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(c)))};let re=!1;o||(this.once("res-@".concat(c),ee),Br(oe("SIGNAL_REQUEST_TIMEOUT")).then(()=>{re||M.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(c,", ").concat(R))}))});try{return await w}catch(N){if(N.code===Q.TIMEOUT)return await this.send(e,n,o,c,u);throw N}}onMessage(e){var n;const{_uid:o}=e;let c,u=this.userMap.get(o);if(u)c=u.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==Qn.CHECK)return;const{token:C}=e;c=new Map,u={uid:o,isStart:!0,token:C,splitMessageMap:c,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(o,u),this.signal.emit(Qe.ON_USER_ONLINE,{uid:o}),this.handleUserOnline()}if("id"in e&&"total"in e){var m;const{id:C,total:R}=e,w=(m=c.get(C))!==null&&m!==void 0?m:[];if(w.push(e),c.has(C)||c.set(C,w),w.length!==R)return;{const N=LE(w).call(w,(L,H)=>L.index-H.index).map(L=>L.payload).join("");c.delete(C),(e=JSON.parse(N))._uid=o}}const{_type:_,token:S}=e;if(xe(n=[Qn.ACK,Qn.CHECK]).call(n,_))return _===Qn.CHECK&&this.handleCheckToken(u,S),void this.receiveMessage(e);S==="".concat(u.token,"_").concat(this.token)?this.handleReceivedMessage(e):M.debug('Receive unexpected message", '.concat(S,", cur_token: ").concat(u.token,"_").concat(this.token),e)}check(){const e={_id:oi(6,""),token:this.token,_type:Qn.CHECK};oe("SHOW_P2P_LOG")&&M.debug("send message",e),this.signal.request(ft.DATA_STREAM,{payload:nf(this.encoder.encode(JSON.stringify(e)))})}ack(e){const n={_id:e,_type:Qn.ACK,token:this.token};oe("SHOW_P2P_LOG")&&M.debug("send message",n),this.signal.request(ft.DATA_STREAM,{payload:nf(this.encoder.encode(JSON.stringify(n)))})}response(e,n,o){this.send(Qn.RESPONSE,JSON.stringify({success:!o,message:n}),!0,e)}handleReceivedMessage(e){const n=()=>{this.userMap.forEach(C=>{const{receivedMessagesMap:R,nextExpectedSequenceNumber:w}=C;for(;R.has(w);){const N=R.get(w);R.delete(w),this.receiveMessage(N),C.nextExpectedSequenceNumber++}})};if(!e)return void n();const{_uid:o,_seq:c}=e,u=this.userMap.get(o),{receivedMessagesMap:m,isStart:_,nextExpectedSequenceNumber:S}=u;if(c<S)return this.ack(e._id),void M.debug("[external-signal] receive old message, seq: ".concat(c,", ").concat(e._message));m.set(c,e),_&&c===S&&(this.receiveMessage(e),m.delete(S),u.nextExpectedSequenceNumber++,n())}receiveMessage(e){const{_id:n,_type:o,_message:c,_uid:u}=e;if(oe("SHOW_P2P_LOG")&&M.debug("receive message",e),n){let m;switch(e._type!==Qn.ACK&&(c&&(m=JSON.parse(c)),this.ack(e._id)),e._type){case Qn.CANDIDATE:case Qn.CONTROL:this.signal.emit(o,m,u);break;case Qn.PUBLISH:case Qn.UNPUBLISH:case Qn.RESTART_ICE:case Qn.CALL:m.uid=u,Ji(this.signal,o,m).then(_=>{this.response(e._id,_)}).catch(()=>{this.response(e._id,void 0,!0)});break;case Qn.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case Qn.RESPONSE:{const{success:_,message:S}=m;this.emit("res-@".concat(n),_?"success":"failed",S);break}}}}splitMessage(e){if(e.length<Eh.MAX_MESSAGE_SIZE)return[e];const n=[],{remoteToken:o}=JSON.parse(e),c=oi(6,"");let u=0,m=800;const _=Math.ceil(e.length/m);for(;e.length>0;){u++;const S={id:c,index:u,total:_,payload:e.slice(0,m),token:"".concat(this.token,"_").concat(o)};JSON.stringify(S).length>Eh.MAX_MESSAGE_SIZE?m-=50:(n.push(S),e=e.slice(m))}return n.map(S=>JSON.stringify(S))}handleCheckToken(e,n){return e.token!==n?(M.debug("token changed, from ".concat(e.token," to ").concat(n)),this.reset(e.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{M.debug("token timeout, ".concat(n)),this.reset(e.uid)},oe("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await Ji(this.signal,Qn.CALL,void 0),n=await this.send(Qn.CALL,e);this.signal.emit(pt.P2P_CONNECTION,n,!0)}async reset(e,n){const o=this.userMap.get(e);o&&(this.emit(cu.ABORT),this.signal.emit(Qe.ON_USER_OFFLINE,{uid:o.uid,reason:ll.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(M.debug("change local token from ".concat(n," to ").concat(n)),this.token=oi(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(cu.ABORT)}}D(Eh,"MAX_SIZE",1),D(Eh,"MAX_MESSAGE_SIZE",1024);class gP extends Dt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Jt.CONNECTED?this.emit(pt.WS_CONNECTED):e===Jt.RECONNECTING?this.emit(pt.WS_RECONNECTING,this._websocketReconnectReason):e===Jt.CLOSED&&this.emit(pt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),D(this,"_disconnectedReason",void 0),D(this,"_websocketReconnectReason",void 0),D(this,"_connectionState",Jt.CLOSED),D(this,"reconnectToken",void 0),D(this,"p2pToken",void 0),D(this,"websocket",void 0),D(this,"openConnectionTime",void 0),D(this,"clientId",void 0),D(this,"lastMsgTime",Date.now()),D(this,"uploadCache",[]),D(this,"uploadCacheInterval",void 0),D(this,"rttRolling",new rf(5)),D(this,"pingpongTimer",void 0),D(this,"pingpongTimeoutCount",0),D(this,"joinResponse",void 0),D(this,"multiIpOption",void 0),D(this,"initError",void 0),D(this,"spec",void 0),D(this,"store",void 0),D(this,"_external_signal",void 0),D(this,"onWebsocketMessage",o=>{if(o.data instanceof ArrayBuffer)return void this.emit(pt.ON_BINARY_DATA,o.data);const c=JSON.parse(o.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(c,"_id")){const u="res-@".concat(c._id);this.emit(u,c._result,c._message)}else if(Object.prototype.hasOwnProperty.call(c,"_type")){switch(c._type){case Qe.ON_DATA_STREAM:return void this.handleDataStream(c._message);case Qe.MUTE_AUDIO:case Qe.MUTE_VIDEO:case Qe.ON_P2P_LOST:case Qe.ON_USER_ONLINE:return;case Qe.ON_USER_OFFLINE:const{uid:u}=c._message;return M.debug("[".concat(this.clientId,"] user-offline uid: ").concat(u)),void this._external_signal.reset(u)}if(this.emit(c._type,c._message),c._type===Qe.ON_NOTIFICATION&&this.handleNotification(c._message),c._type===Qe.ON_USER_BANNED)switch(c._message.error_code){case 14:this.close(un.UID_BANNED);break;case 15:this.close(un.IP_BANNED);break;case 16:this.close(un.CHANNEL_BANNED)}if(c._type===Qe.ON_USER_LICENSE_BANNED)switch(c._message.error_code){case Ct.ERR_LICENSE_MISSING:this.close(un.LICENSE_MISSING);break;case Ct.ERR_LICENSE_EXPIRED:this.close(un.LICENSE_EXPIRED);break;case Ct.ERR_LICENSE_MINUTES_EXCEEDED:this.close(un.LICENSE_MINUTES_EXCEEDED);break;case Ct.ERR_LICENSE_PERIOD_INVALID:this.close(un.LICENSE_PERIOD_INVALID);break;case Ct.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(un.LICENSE_MULTIPLE_SDK_SERVICE);break;case Ct.ERR_LICENSE_ILLEGAL:this.close(un.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new fg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,oe("JOIN_GATEWAY_USE_DUAL_DOMAIN"),oe("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Jt.CONNECTED&&this.reconnect("retry",In.OFFLINE)}),this.p2pToken=oi(6,""),this._external_signal=new Eh(this,this.p2pToken)}async request(e,n,o,c){const u=oi(6,""),m={_id:u,_type:e,_message:n},_=this.websocket.connectionID,S=()=>new Ee((H,j)=>{if(this.connectionState===Jt.CONNECTED)return H();const W=()=>{this.off(pt.WS_CLOSED,ee),H()},ee=()=>{this.off(pt.WS_CONNECTED,W),j(new ke(Q.WS_ABORT))};this.once(pt.WS_CONNECTED,W),this.once(pt.WS_CLOSED,ee)});if(this.connectionState!==Jt.CONNECTING&&this.connectionState!==Jt.RECONNECTING||e===ft.JOIN||e===ft.REJOIN||await S(),this.websocket.sendMessage(m,!0),c)return;const C=new Ee((H,j)=>{let W=!1;const ee=(fe,be)=>{W=!0,H({isSuccess:fe==="success",message:be||{}}),this.off(pt.WS_CLOSED,re),this.off(pt.WS_RECONNECTING,re),this.emit(pt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(u),ee);const re=()=>{j(new ke(Q.WS_ABORT,"type: ".concat(e))),this.off(pt.WS_CLOSED,re),this.off(pt.WS_RECONNECTING,re),this.off("res-@".concat(u),ee)};this.once(pt.WS_CLOSED,re),this.once(pt.WS_RECONNECTING,re),Br(oe("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==_||W||(M.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(pt.REQUEST_TIMEOUT,e,n))})});let R=null;try{R=await C}catch(H){if(this.connectionState===Jt.CLOSED||e===ft.LEAVE)throw new ke(Q.WS_ABORT);return!this.spec.forceWaitGatewayResponse||o?H.throw():e===ft.JOIN||e===ft.REJOIN?null:(await S(),await this.request(e,n))}if(R.isSuccess)return R.message;const w=Number(R.message.error_code||R.message.code),N=fh(w),L=new ke(Q.UNEXPECTED_RESPONSE,"".concat(N.desc,": ").concat(R.message.error_str),{code:w,data:R.message});return N.action==="success"?R.message:(M.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(w,", message: ").concat(N.desc,", action: ").concat(N.action)),w===Ct.ERR_TOO_MANY_BROADCASTERS?((e===ft.JOIN||e===ft.REJOIN)&&(this.initError=L,this.close()),L.throw()):N.action==="failed"?L.throw():N.action==="quit"?(this.initError=L,this.close(),L.throw()):(w===Ct.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=R.message.option,M.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",In.MULTI_IP)):this.reconnect(N.action,In.SERVER_ERROR),e===ft.JOIN||e===ft.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new Ee(o=>{const c=u=>{(!n||n(u))&&(this.off(e,c),o(u))};this.on(e,c)})}uploadWRTCStats(e){if(!this.store.sessionId)return void M.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(fr.WRTC_STATS,n)}upload(e,n){const o={_type:e,_message:n};try{this.websocket.sendMessage(o)}catch{const u=oe("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(o),this.uploadCache.length>u&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Jt.CONNECTED)return;const m=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(m._type,m._message)},oe("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const o={_type:e,_message:n};this.websocket.sendMessage(o)}async sendExtensionMessage(e,n,o){return await this._external_signal.send(e,n,o)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Ee((n,o)=>{this.once(pt.WS_CONNECTED,()=>n(this.joinResponse)),this.once(pt.WS_CLOSED,()=>o(this.initError||new ke(Q.WS_ABORT))),this.connectionState=Jt.CONNECTING,this.websocket.init(e).catch(o)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||un.LEAVE,this.connectionState=Jt.CLOSED,M.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===un.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new fg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,oe("JOIN_GATEWAY_USE_DUAL_DOMAIN"),oe("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=oi(6,""),this._external_signal.clear(),this._external_signal=new Eh(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(pt.ABORT_P2P_EXECUTION);const e=await Ji(this,pt.REQUEST_JOIN_INFO),n=await this.request(ft.JOIN,e);if(!n)return this.emit(pt.REPORT_JOIN_GATEWAY,Q.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(pt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleDataStream(e){try{var n;const o=ca(e.payload),c=new TextDecoder().decode(o),u=JSON.parse(c);"total"in u&&"id"in u||xe(n=Object.values(Qn)).call(n,u._type)?(u._uid=e.uid,this._external_signal.onMessage(u)):this.emit(Qe.ON_DATA_STREAM,e)}catch{this.emit(Qe.ON_DATA_STREAM,e)}}handleNotification(e){M.debug("[".concat(this.clientId,"] receive notification: "),e);const n=fh(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(un.UID_BANNED),void this.close()):void this.reconnect(n.action,In.SERVER_ERROR);M.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=oe("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(M.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>oe("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",In.TIMEOUT):this.request(ft.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const o=Date.now()-n;this.rttRolling.add(o),oe("REPORT_STATS")&&this.send(ft.PING_BACK,{pingpongElapse:o})}).catch(o=>{})}handleWebsocketEvents(){this.websocket.on(qe.RECONNECT_WAITTING_FINISH,e=>{this.emit(pt.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(qe.RECONNECT_CREATE_CONNECTION,e=>{this.emit(pt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(qe.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(qe.CLOSED,()=>{this.connectionState=Jt.CLOSED}),this.websocket.on(qe.FAILED,()=>{this._disconnectedReason=un.NETWORK_ERROR,this.connectionState=Jt.CLOSED}),this.websocket.on(qe.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Jt.CONNECTED?this.connectionState=Jt.RECONNECTING:this.connectionState=Jt.CONNECTING}),this.websocket.on(qe.WILL_RECONNECT,(e,n,o)=>{e!=="retry"?(M.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(pt.NEED_RENEW_SESSION)):M.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),o(e)}),this.websocket.on(qe.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(pt.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof ke&&e.code===Q.UNEXPECTED_RESPONSE&&e.data.code===Ct.ERR_NO_AUTHORIZED)return M.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",In.SERVER_ERROR);M.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",In.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(qe.REQUEST_NEW_URLS,(e,n)=>{Ji(this,pt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(qe.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Qe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function SP(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function mc(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?SP(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):SP(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}const Nd=new Map;class xp extends Dt{get state(){return this._state}set state(e){if(e===this._state)return;const n=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(An.CONNECTION_STATE_CHANGE,e,n,this._disconnectedReason):this.emit(An.CONNECTION_STATE_CHANGE,e,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){M.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,n){super(),D(this,"store",void 0),D(this,"joinInfo",void 0),D(this,"key",void 0),D(this,"ntpOffset",0),D(this,"signal",void 0),D(this,"role",void 0),D(this,"inChannelInfo",{joinAt:null,duration:0}),D(this,"spec",void 0),D(this,"_state","DISCONNECTED"),D(this,"_statsCollector",void 0),D(this,"_disconnectedReason",void 0),D(this,"isSignalRecover",!1),D(this,"hasChangeBGPAddress",!1),D(this,"trafficStatsInterval",void 0),D(this,"networkQualityInterval",void 0),D(this,"_joinGatewayStartTime",0),D(this,"_signalTimeout",!1),D(this,"_clientRoleOptions",void 0),D(this,"_isProactiveJoin",!1),this.store=e,this.spec=n,this.signal=this.store.useP2P?new gP(mc(mc({},n),{},{retryConfig:n.websocketRetryConfig}),e):this.store.useDataChannel?new qo(mc(mc({},n),{},{retryConfig:n.websocketRetryConfig}),e):new lP(mc(mc({},n),{},{retryConfig:n.websocketRetryConfig}),e),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}async join(e,n,o){if(this.signal instanceof qo){let S=!1;e.cloudProxyServer!=="disabled"?(M.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),S=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(M.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),S=!0):e.apResponse.addresses.some(C=>C.fingerprint)||oe("FINGERPRINT")||(M.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),S=!0),S&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const c=Date.now();let u=Nd.get(e.cname);if(u||(u=new Map,Nd.set(e.cname,u)),this._isProactiveJoin=!0,u.has(e.uid)){const S=new Te(Q.UID_CONFLICT);throw vt.joinGateway(e.sid,{lts:c,succ:!1,ec:S.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof qo?"1":"0"}),this._isProactiveJoin=!1,S}u.set(e.uid,!0),this.joinInfo=e,this.key=n;let m=0;this.joinGatewayStartTime=c;const _=e.proxyServer;try{let S;if(M.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof qo?"datachannel":"websocket"," join uid ").concat(m)),this.signal instanceof qo)S=await this.signal.init(e.apResponse.addresses,o);else{const C=e.gatewayAddrs.map(R=>{let{address:w}=R;const[N,L]=w.split(":"),H={host:N,port:L};return e.proxyServer&&(H.proxy=e.proxyServer),H});S=await this.signal.init(C,o)}m=S.uid,M.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof qo?"datachannel":"websocket"," join uid ").concat(m," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(S){throw S&&S.code===Q.INIT_WEBSOCKET_TIMEOUT?(M.warning("[".concat(this.store.clientId,"] User join failed"),S.toString()),S):S&&S.code===Q.INIT_DATACHANNEL_TIMEOUT?(M.warning("[".concat(this.store.clientId,"] User join datachannel failed"),S.toString()),this.resetSignal(),S):(M.error("[".concat(this.store.clientId,"] User join failed"),S.toString()),vt.joinGateway(e.sid,{lts:c,succ:!1,ec:S.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!_,signalChannel:this.signal instanceof qo?"1":"0"}),this._isProactiveJoin=!1,u.delete(e.uid),this.signal.close(),S)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),M.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(S=>{M.warning("[".concat(this.store.clientId,"] get traffic stats error"),S.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(An.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(An.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(An.NETWORK_QUALITY,{uplinkNetworkQuality:gg(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:gg(this._statsCollector.trafficStats.B_dnq)}):this.emit(An.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),m}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==un.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==Jt.CONNECTED||await function(o,c){return c===1/0?o:Ee.race([o,jB(c)])}(this.signal.request(ft.LEAVE,void 0,!0),3e3)}catch(o){M.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),o)}this.signal.close(n),n!==un.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,n,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const c={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:oe("PUB_EXTEND"),twcc:!!oe("PUBLISH_TWCC"),rtx:!!oe("USE_PUB_RTX")};try{return(await this.signal.request(ft.PUBLISH,c,!0))._message}catch(u){if(o&&u.data&&u.data.code===Ct.ERR_PUBLISH_REQUEST_INVALID)return M.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),u.toString()),await this.tryUnpubBeforeRepub(e,n),this.publish(e,n,!1);throw u}}async publishDataChannel(e,n,o){var c;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const u={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(c=n.maxRetransmits)!==null&&c!==void 0?c:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(ft.PUBLISH_DATASTREAM,u,!0)}catch(m){if(o&&m.data&&m.data.code===Ct.ERR_PUBLISH_REQUEST_INVALID)return M.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),m.toString()),await this.tryUnpubDataChannelBeforeRepub(e,n),this.publishDataChannel(e,n,!1);throw m}}async unpublish(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(ft.UNPUBLISH,{stream_id:n,ortc:e},!0)}catch(o){M.warning("[".concat(this.store.clientId,"] unpublish warning: "),o)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Ee.all(e.map(n=>this.signal.request(ft.UNPUBLISH_DATASTREAM,{channel_id:n},!0)))}catch(n){M.warning("unpublish datachannels warning: ",n)}}async presubscribe(e,n,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const c={stream_id:e,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!oe("SUBSCRIBE_TWCC"),rtx:!!oe("USE_SUB_RTX")||void 0,extend:oe("SUB_EXTEND"),svc:Array.isArray(oe("SVC"))&&oe("SVC").length!==0?oe("SVC"):void 0};try{return await this.signal.request(ft.PRE_SUBSCRIBE,c,!0)}catch(u){if(o&&u.data&&u.data.code===Ct.ERR_SUBSCRIBE_REQUEST_INVALID)return M.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),u.toString()),this.presubscribe(e,n,!1);throw u}}async subscribe(e,n,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const c={stream_id:e,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!oe("SUBSCRIBE_TWCC"),rtx:!!oe("USE_SUB_RTX"),extend:oe("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(oe("SVC"))&&oe("SVC").length!==0?oe("SVC"):void 0};try{return(await this.signal.request(ft.SUBSCRIBE,c,!0))._message}catch(u){if(o&&u.data&&u.data.code===Ct.ERR_SUBSCRIBE_REQUEST_INVALID)return M.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),u.toString()),await this.tryUnsubBeforeResub(e,n),await this.subscribe(e,n,!1);throw u}}async subscribeDataChannel(e,n,o){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const c={uid:e,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(ft.SUBSCRIBE_DATASTREAM,c,!0)}catch(u){if(o&&u.data&&u.data.code===Ct.ERR_SUBSCRIBE_REQUEST_INVALID)return M.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),u.toString()),await this.tryUnsubDataChannelBeforeResub(e,n),await this.subscribeDataChannel(e,n,!1);throw u}}async subscribeAll(e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const o={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!oe("USE_SUB_RTX")};try{return await this.signal.request(ft.SUBSCRIBE_STREAMS,o,!0)}catch(c){if(n&&c.data&&c.data.code===Ct.ERR_SUBSCRIBE_REQUEST_INVALID)return M.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),c.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw c}}async setVideoProfile(e){const n=function(o){if(!(o.bitrateMax&&o.bitrateMin&&o.frameRate&&o.height&&o.width))return;let c=o.frameRate,u=o.width,m=o.height,_=!0;return typeof c!="number"&&(c=c.exact||c.ideal||c.max||c.min||0,c||(_=!1)),typeof u!="number"&&(u=u.exact||u.ideal||u.max||u.min||0,u||(_=!1)),typeof m!="number"&&(m=m.exact||m.ideal||m.max||m.min||0,c||(_=!1)),_?{stream_type:0,width:u,height:m,fps:c,start_bps:1e3*o.bitrateMax,min_bps:1e3*o.bitrateMin,target_bps:1e3*o.bitrateMax}:void 0}(e);if(n)return this.signal.request(ft.SET_VIDEO_PROFILE,n);M.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,n){try{await this.signal.request(ft.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:n},!0)}catch(o){M.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),o)}}async unsubscribeDataChannel(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Ee.all(e.map(o=>this.signal.request(ft.UNSUBSCRIBE_DATASTREAM,{stream_id:o,uid:n},!0)))}catch(o){M.warning("unsubscribeDataChannel warning: ",o)}}async massUnsubscribe(e){try{await this.signal.request(ft.UNSUBSCRIBE_STREAMS,e,!0)}catch(n){M.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(e){const{iceParameters:n,dtlsParameters:o,rtpCapabilities:c}=e;return{gatewayEstablishParams:await this.signal.request(ft.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:o,rtpCapabilities:c}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(ft.GATEWAY_INFO)}async renewToken(e){await this.signal.request(ft.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),this.state!=="CONNECTED")return void(this.role=e);let o,c=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(o=this._clientRoleOptions.delay,c=1):c=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:c=0,await this.signal.request(ft.SET_CLIENT_ROLE,{role:e,level:c,delay:o,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,n){await this.signal.request(ft.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:n})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(ft.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,n){await this.signal.request(ft.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:n})}async pickSVCLayer(e,n){await this.signal.request(ft.PICK_SVC_LAYER,{stream_id:e,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(e){await this.signal.request(ft.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,n,o){if(this.signal instanceof gP)return this.signal.sendExtensionMessage(e,n,o)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),mc({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(ft.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=Nd.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(n){let o;return o=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),o?{username:Mt.username,password:Mt.password,turnServerURL:o[2],tcpport:parseInt(o[3])+30,udpport:parseInt(o[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(mc(mc({},Mt),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const e=await this.signal.request(ft.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(n=>{const o=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(c=>c.peer_uid===n.peer_uid);o&&o.B_st!==n.B_st&&Np(()=>{this.emit(An.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new Te(Q.UNEXPECTED_ERROR,"can not generate join message, no join info");const n=Object.assign({},this.joinInfo.apResponse);let o=oe("REPORT_APP_SCENARIO");if(typeof o!="string")try{o=JSON.stringify(o)}catch{o=void 0}o&&o.length>128&&(o=void 0);const c=mc({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:mr,browser:navigator.userAgent,process_id:oe("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:n,extend:oe("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:o,attributes:{userAttributes:{enablePublishedUserList:oe("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:oe("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof oe("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?oe("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof oe("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?oe("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof oe("ENABLE_USER_LICENSE_CHECK")=="boolean"?oe("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:oe("USE_PUB_RTX")===!0||oe("USE_SUB_RTX")===!0||void 0,disableFEC:oe("DISABLE_FEC"),enableNTPReport:!!oe("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!oe("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof oe("ENABLE_DATASTREAM_2")=="boolean"?oe("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!oe("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof oe("USE_XR")=="boolean"?oe("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(c.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(c.aes_mode=this.joinInfo.aesmode,oe("ENCRYPT_AES")?(c.aes_secret=this.joinInfo.aespassword,c.aes_encrypt=!0):c.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(c.aes_salt=this.joinInfo.aessalt)),n.addresses[this.signal.websocket.currentURLIndex]&&(c.ap_response.ticket=n.addresses[this.signal.websocket.currentURLIndex].ticket,delete n.addresses),this.joinInfo.defaultVideoStream!==void 0&&(c.default_video_stream=this.joinInfo.defaultVideoStream),c}getRejoinMessage(){if(!this.joinInfo)throw new Te(Q.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(pt.WS_RECONNECT_WAITTING_FINISH,e=>{var n;xe(n=["tryNext","recover"]).call(n,e)&&this.joinInfo&&vt.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(pt.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(pt.WS_RECONNECTING,e=>{this.joinInfo&&vt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||In.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",vt.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(pt.WS_CLOSED,e=>{let n;switch(e){case un.LEAVE:n=In.LEAVE;break;case un.UID_BANNED:case un.IP_BANNED:case un.CHANNEL_BANNED:case un.SERVER_ERROR:n=In.SERVER_ERROR;break;case un.FALLBACK:n=In.FALLBACK;break;case un.LICENSE_MISSING:case un.LICENSE_EXPIRED:case un.LICENSE_MINUTES_EXCEEDED:case un.LICENSE_PERIOD_INVALID:case un.LICENSE_MULTIPLE_SDK_SERVICE:case un.LICENSE_ILLEGAL:case un.TOKEN_EXPIRE:n=e;break;default:n=In.NETWORK_ERROR}M.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+In.NETWORK_ERROR)),this.joinInfo&&vt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===un.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==un.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(pt.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(M.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),vt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof qo?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void M.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Kn("EVENT_REPORT_DOMAIN",e[1]),Kn("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Kn("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}),this.signal.on(Qe.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(pt.REQUEST_RECOVER,(e,n,o)=>{if(!this.joinInfo)return o(new Te(Q.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Ji(this,An.REQUEST_NEW_GATEWAY_LIST).then(n).catch(o)}),this.signal.on(pt.REQUEST_JOIN_INFO,async e=>{var n;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:o,dtlsParameters:c,rtpCapabilities:u}=await Ji(this,An.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(n=this.joinInfo)===null||n===void 0?void 0:n.turnServer});e(this.getJoinMessage({ortc:{iceParameters:o,dtlsParameters:c,rtpCapabilities:u,version:"2"}}))}),this.signal.on(pt.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(pt.REPORT_JOIN_GATEWAY,(e,n)=>{this.joinInfo&&(vt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof qo?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(pt.IS_P2P_DISCONNECTED,e=>{e(Gn(this,An.IS_P2P_DISCONNECTED))}),this.signal.on(pt.DISCONNECT_P2P,()=>{this.emit(An.DISCONNECT_P2P)}),this.signal.on(pt.NEED_RENEW_SESSION,()=>{this.emit(An.NEED_RENEW_SESSION)}),this.signal.on(pt.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(pt.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(pt.JOIN_RESPONSE,e=>{const n=this.getCurrentGatewayAddress();this.emit(An.JOIN_RESPONSE,e,n)}),this.signal.on(pt.DATACHANNEL_PRECONNECT,async(e,n,o)=>{this.updateTurnConfigFromSignal();const c=this.getCurrentGatewayAddress();return Ji(this,An.DATACHANNEL_PRECONNECT,e,c).then(n).catch(o)}),this.signal.on(pt.DATACHANNEL_CONNECTING,async e=>{const{iceParameters:n,dtlsParameters:o,rtpCapabilities:c}=await Ji(this,An.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:o,rtpCapabilities:c,version:"2"}}))}),this.signal.on(pt.DATACHANNEL_FAILBACK,()=>{M.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(An.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(e,n){try{await this.signal.request(ft.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[n]},!0)}catch(o){throw M.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),o),o}}async tryUnsubDataChannelBeforeResub(e,n){try{await this.signal.request(ft.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(o){throw M.warning("unsubscribe datachannel warning",o),o}}async tryUnpubBeforeRepub(e,n){try{await this.signal.request(ft.UNPUBLISH,{stream_id:e,ortc:n},!0)}catch(o){throw M.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),o),o}}async tryUnpubDataChannelBeforeRepub(e,n){try{await this.signal.request(ft.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(o){throw M.warning("unpublish datastream warning: ",o),o}}async tryMassUnsubBeforeResub(e){const n={users:e.map(o=>({stream_id:o.stream_id,stream_type:o.stream_type}))};try{await this.signal.request(ft.UNSUBSCRIBE_STREAMS,n,!0)}catch(o){throw M.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),o),o}}async muteLocal(e,n){const o={action:e.find(c=>c.stream_type===Nn.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(ft.CONTROL,o,!0,!0)}catch(c){throw M.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),c),c}}async unmuteLocal(e,n){const o={action:e.find(c=>c.stream_type===Nn.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(ft.CONTROL,o,!0,!0)}catch(c){throw M.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),c),c}}async muteRemote(e,n){const o={action:e===gt.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(ft.CONTROL,o,!0,!0)}catch(c){throw M.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),c),c}}async unmuteRemote(e,n){const o={action:e===gt.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(ft.CONTROL,o,!0,!0)}catch(c){throw M.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),c),c}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,n){this.signal.upload(e,n)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(ft.RESTART_ICE,n,!0)}catch(o){throw M.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),o),o}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,In.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!oe("GATEWAY_WSS_ADDRESS"))return(e=this.joinInfo)!==null&&e!==void 0&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(ft.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(un.FALLBACK)),this.store.useDataChannel=!1,this.signal=new lP(mc(mc({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(An.RESET_SIGNAL,bd.websocket)}}let Sg=0,aC=0;function zs(r,e,n,o){return new Ee((c,u)=>{e.timeout=e.timeout||oe("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),Sg+=ol(e.data)):n&&(e.data.size?Sg+=e.data.size:e.data instanceof FormData?Sg+=AD(e.data):Sg+=ol(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=r,no.request(e).then(m=>{typeof m.data=="string"?aC+=ol(m.data):m.data instanceof ArrayBuffer||m.data instanceof Uint8Array?aC+=m.data.byteLength:aC+=ol(JSON.stringify(m.data)),o&&c({data:m.data,headers:m.headers}),c(m.data)}).catch(m=>{no.isCancel(m)?u(new Te(Q.OPERATION_ABORTED,"cancel token canceled")):m.code==="ECONNABORTED"?u(new Te(Q.NETWORK_TIMEOUT,m.message)):m.response?u(new Te(Q.NETWORK_RESPONSE_ERROR,m.response.status)):u(new Te(Q.NETWORK_ERROR,m.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var r;function e(ze){var it=0;return function(){return it<ze.length?{done:!1,value:ze[it++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(ze,it,St){return ze==Array.prototype||ze==Object.prototype||(ze[it]=St.value),ze},o,c=function(ze){ze=[typeof globalThis=="object"&&globalThis,ze,typeof window=="object"&&window,typeof self=="object"&&self,typeof T=="object"&&T];for(var it=0;it<ze.length;++it){var St=ze[it];if(St&&St.Math==Math)return St}throw Error("Cannot find global object")}(this);function u(ze,it){if(it)e:{var St=c;ze=ze.split(".");for(var Kt=0;Kt<ze.length-1;Kt++){var jn=ze[Kt];if(!(jn in St))break e;St=St[jn]}(it=it(Kt=St[ze=ze[ze.length-1]]))!=Kt&&it!=null&&n(St,ze,{configurable:!0,writable:!0,value:it})}}function m(ze){return(ze={next:ze})[Symbol.iterator]=function(){return this},ze}function _(ze){var it=typeof Symbol<"u"&&Symbol.iterator&&ze[Symbol.iterator];return it?it.call(ze):{next:e(ze)}}if(u("Symbol",function(ze){function it(jn,ct){this.A=jn,n(this,"description",{configurable:!0,writable:!0,value:ct})}if(ze)return ze;it.prototype.toString=function(){return this.A};var St="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",Kt=0;return function jn(ct){if(this instanceof jn)throw new TypeError("Symbol is not a constructor");return new it(St+(ct||"")+"_"+Kt++,ct)}}),u("Symbol.iterator",function(ze){if(ze)return ze;ze=Symbol("Symbol.iterator");for(var it="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),St=0;St<it.length;St++){var Kt=c[it[St]];typeof Kt=="function"&&typeof Kt.prototype[ze]!="function"&&n(Kt.prototype,ze,{configurable:!0,writable:!0,value:function(){return m(e(this))}})}return ze}),typeof Object.setPrototypeOf=="function")o=Object.setPrototypeOf;else{var S;e:{var C={};try{C.__proto__={a:!0},S=C.a;break e}catch{}S=!1}o=S?function(ze,it){if(ze.__proto__=it,ze.__proto__!==it)throw new TypeError(ze+" is not extensible");return ze}:null}var R=o;function w(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function N(ze){if(ze.m)throw new TypeError("Generator is already running");ze.m=!0}function L(ze,it){return ze.h=3,{value:it}}function H(ze){this.g=new w,this.G=ze}function j(ze,it,St,Kt){try{var jn=it.call(ze.g.j,St);if(!(jn instanceof Object))throw new TypeError("Iterator result "+jn+" is not an object");if(!jn.done)return ze.g.m=!1,jn;var ct=jn.value}catch(G){return ze.g.j=null,ze.g.s(G),W(ze)}return ze.g.j=null,Kt.call(ze.g,ct),W(ze)}function W(ze){for(;ze.g.h;)try{var it=ze.G(ze.g);if(it)return ze.g.m=!1,{value:it.value,done:!1}}catch(St){ze.g.v=void 0,ze.g.s(St)}if(ze.g.m=!1,ze.g.l){if(it=ze.g.l,ze.g.l=null,it.F)throw it.D;return{value:it.return,done:!0}}return{value:void 0,done:!0}}function ee(ze){this.next=function(it){return ze.o(it)},this.throw=function(it){return ze.s(it)},this.return=function(it){return function(St,Kt){N(St.g);var jn=St.g.j;return jn?j(St,"return"in jn?jn.return:function(ct){return{value:ct,done:!0}},Kt,St.g.return):(St.g.return(Kt),W(St))}(ze,it)},this[Symbol.iterator]=function(){return this}}function re(ze,it){return it=new ee(new H(it)),R&&ze.prototype&&R(it,ze.prototype),it}if(w.prototype.o=function(ze){this.v=ze},w.prototype.s=function(ze){this.l={D:ze,F:!0},this.h=this.C||this.u},w.prototype.return=function(ze){this.l={return:ze},this.h=this.u},H.prototype.o=function(ze){return N(this.g),this.g.j?j(this,this.g.j.next,ze,this.g.o):(this.g.o(ze),W(this))},H.prototype.s=function(ze){return N(this.g),this.g.j?j(this,this.g.j.throw,ze,this.g.o):(this.g.s(ze),W(this))},u("Array.prototype.entries",function(ze){return ze||function(){return function(it,St){it instanceof String&&(it+="");var Kt=0,jn=!1,ct={next:function(){if(!jn&&Kt<it.length){var G=Kt++;return{value:St(G,it[G]),done:!1}}return jn=!0,{done:!0,value:void 0}}};return ct[Symbol.iterator]=function(){return ct},ct}(this,function(it,St){return[it,St]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var fe=function(ze,it){for(var St=0;St<ze.length;St++)it(ze[St])},be=function(ze){return ze.replace(/\r?\n|\r/g,`\r
`)},_e=function(ze,it,St){return it instanceof Blob?(St=St!==void 0?St+"":typeof it.name=="string"?it.name:"blob",it.name===St&&Object.prototype.toString.call(it)!=="[object Blob]"||(it=new File([it],St)),[String(ze),it]):[String(ze),String(it)]},ye=function(ze,it){if(ze.length<it)throw new TypeError(it+" argument required, but only "+ze.length+" present.")},Le=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,Me=Le.FormData,et=Le.XMLHttpRequest&&Le.XMLHttpRequest.prototype.send,at=Le.Request&&Le.fetch,Zt=Le.navigator&&Le.navigator.sendBeacon,Sn=Le.Element&&Le.Element.prototype,gi=Le.Symbol&&Symbol.toStringTag;gi&&(Blob.prototype[gi]||(Blob.prototype[gi]="Blob"),"File"in Le&&!File.prototype[gi]&&(File.prototype[gi]="File"));try{new File([],"")}catch{Le.File=function(it,St,Kt){return it=new Blob(it,Kt||{}),Object.defineProperties(it,{name:{value:St},lastModified:{value:+(Kt&&Kt.lastModified!==void 0?new Date(Kt.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),gi&&Object.defineProperty(it,gi,{value:"File"}),it}}var Yr=function(ze){return ze.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Mi=function(ze){this.i=[];var it=this;ze&&fe(ze.elements,function(St){if(St.name&&!St.disabled&&St.type!=="submit"&&St.type!=="button"&&!St.matches("form fieldset[disabled] *"))if(St.type==="file"){var Kt=St.files&&St.files.length?St.files:[new File([],"",{type:"application/octet-stream"})];fe(Kt,function(jn){it.append(St.name,jn)})}else St.type==="select-multiple"||St.type==="select-one"?fe(St.options,function(jn){!jn.disabled&&jn.selected&&it.append(St.name,jn.value)}):St.type==="checkbox"||St.type==="radio"?St.checked&&it.append(St.name,St.value):(Kt=St.type==="textarea"?be(St.value):St.value,it.append(St.name,Kt))})};if((r=Mi.prototype).append=function(ze,it,St){ye(arguments,2),this.i.push(_e(ze,it,St))},r.delete=function(ze){ye(arguments,1);var it=[];ze=String(ze),fe(this.i,function(St){St[0]!==ze&&it.push(St)}),this.i=it},r.entries=function ze(){var it,St=this;return re(ze,function(Kt){if(Kt.h==1&&(it=0),Kt.h!=3)return it<St.i.length?Kt=L(Kt,St.i[it]):(Kt.h=0,Kt=void 0),Kt;it++,Kt.h=2})},r.forEach=function(ze,it){ye(arguments,1);for(var St=_(this),Kt=St.next();!Kt.done;Kt=St.next()){var jn=_(Kt.value);Kt=jn.next().value,jn=jn.next().value,ze.call(it,jn,Kt,this)}},r.get=function(ze){ye(arguments,1);var it=this.i;ze=String(ze);for(var St=0;St<it.length;St++)if(it[St][0]===ze)return it[St][1];return null},r.getAll=function(ze){ye(arguments,1);var it=[];return ze=String(ze),fe(this.i,function(St){St[0]===ze&&it.push(St[1])}),it},r.has=function(ze){ye(arguments,1),ze=String(ze);for(var it=0;it<this.i.length;it++)if(this.i[it][0]===ze)return!0;return!1},r.keys=function ze(){var it,St,Kt,jn,ct=this;return re(ze,function(G){if(G.h==1&&(it=_(ct),St=it.next()),G.h!=3)return St.done?void(G.h=0):(Kt=St.value,jn=_(Kt),L(G,jn.next().value));St=it.next(),G.h=2})},r.set=function(ze,it,St){ye(arguments,2),ze=String(ze);var Kt=[],jn=_e(ze,it,St),ct=!0;fe(this.i,function(G){G[0]===ze?ct&&(ct=!Kt.push(jn)):Kt.push(G)}),ct&&Kt.push(jn),this.i=Kt},r.values=function ze(){var it,St,Kt,jn,ct=this;return re(ze,function(G){if(G.h==1&&(it=_(ct),St=it.next()),G.h!=3)return St.done?void(G.h=0):(Kt=St.value,(jn=_(Kt)).next(),L(G,jn.next().value));St=it.next(),G.h=2})},Mi.prototype._asNative=function(){for(var ze=new Me,it=_(this),St=it.next();!St.done;St=it.next()){var Kt=_(St.value);St=Kt.next().value,Kt=Kt.next().value,ze.append(St,Kt)}return ze},Mi.prototype._blob=function(){var ze="----formdata-polyfill-"+Math.random(),it=[],St="--"+ze+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(Kt,jn){return typeof Kt=="string"?it.push(St+Yr(be(jn))+`"\r
\r
`+be(Kt)+`\r
`):it.push(St+Yr(be(jn))+'"; filename="'+Yr(Kt.name)+`"\r
Content-Type: `+(Kt.type||"application/octet-stream")+`\r
\r
`,Kt,`\r
`)}),it.push("--"+ze+"--"),new Blob(it,{type:"multipart/form-data; boundary="+ze})},Mi.prototype[Symbol.iterator]=function(){return this.entries()},Mi.prototype.toString=function(){return"[object FormData]"},Sn&&!Sn.matches&&(Sn.matches=Sn.matchesSelector||Sn.mozMatchesSelector||Sn.msMatchesSelector||Sn.oMatchesSelector||Sn.webkitMatchesSelector||function(ze){for(var it=(ze=(this.document||this.ownerDocument).querySelectorAll(ze)).length;0<=--it&&ze.item(it)!==this;);return-1<it}),gi&&(Mi.prototype[gi]="FormData"),et){var wc=Le.XMLHttpRequest.prototype.setRequestHeader;Le.XMLHttpRequest.prototype.setRequestHeader=function(ze,it){wc.call(this,ze,it),ze.toLowerCase()==="content-type"&&(this.B=!0)},Le.XMLHttpRequest.prototype.send=function(ze){ze instanceof Mi?(ze=ze._blob(),this.B||this.setRequestHeader("Content-Type",ze.type),et.call(this,ze)):et.call(this,ze)}}at&&(Le.fetch=function(ze,it){return it&&it.body&&it.body instanceof Mi&&(it.body=it.body._blob()),at.call(this,ze,it)}),Zt&&(Le.navigator.sendBeacon=function(ze,it){return it instanceof Mi&&(it=it._asNative()),Zt.call(this,ze,it)}),Le.FormData=Mi}})();const lf=()=>{const r=oe("AREAS");return r.length===0&&r.push(At.GLOBAL),sl(r).call(r,(e,n,o)=>{const c=TP(n);return c?o===0?c:"".concat(e,",").concat(c):e},"")},TP=r=>r===At.OVERSEA?"".concat(On.ASIA,",").concat(On.EUROPE,",").concat(On.AFRICA,",").concat(On.NORTH_AMERICA,",").concat(On.SOUTH_AMERICA,",").concat(On.OCEANIA):On[r],cC=r=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return r.map(n=>{const o=Lp[n],c=Object.keys(o);c&&c.map(u=>{u!=="CODE"&&(e[u]=e[u].concat(o[u]))})}),e},uf={GLOBAL:{ASIA:[At.CHINA,At.JAPAN,At.INDIA,At.KOREA,At.HKMC],EUROPE:[],NORTH_AMERICA:[At.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Kc=Object.keys(uf[At.GLOBAL]),hf=[At.CHINA,At.NORTH_AMERICA,At.EUROPE,At.ASIA,At.JAPAN,At.INDIA,At.OCEANIA,At.SOUTH_AMERICA,At.AFRICA,At.KOREA,At.HKMC,At.US],CP=function(r,e){let n=[];if(xe(r).call(r,At.GLOBAL)){const u=[At.GLOBAL,At.OVERSEA],m=Object.keys(Lp);if(e===At.GLOBAL)throw new Te(Q.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===At.CHINA)n=[At.OVERSEA];else if(c=e,xe(Kc).call(Kc,c)){const _=(o=e,uf[At.GLOBAL][o]||[]),S=[...u,e,..._];n=m.filter(C=>!xe(S).call(S,C))}else if(function(_){let S=!1;return Kc.forEach(C=>{var R;xe(R=uf[At.GLOBAL][C]).call(R,_)&&(S=!0)}),S}(e)){const _=function(C){let R;return Kc.forEach(w=>{var N;xe(N=uf[At.GLOBAL][w]).call(N,C)&&(R=w)}),R}(e),S=[...u,_,e];n=m.filter(C=>!xe(S).call(S,C))}else n=r;n=function(_){const S=[];return hf.forEach(C=>{xe(_).call(_,C)&&S.push(C)}),S.concat(_.filter(C=>!xe(hf).call(hf,C)))}(n)}else n=r;var o,c;return n};function vP(r){var e,n;if(!r&&xe(e=oe("AREAS")).call(e,At.EXTENSIONS))return M.debug("update area from ap : reset"),void pf(tP,!0);if(!xe(n=oe("AREAS")).call(n,At.GLOBAL)||!r)return;let o=Lp.EXTENSIONS;o&&(o={CODE:TP(At.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(r,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(r,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(r,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(r,".agora.io"),"cds-ap-web-2-".concat(r,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(r,".agora.io"),"sua-ap-web-2-".concat(r,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(r,".agora.io"),"uap-ap-web-2-".concat(r,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(r,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(r,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(r,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(r,".agora.io")]},M.debug("update area from ap success: ".concat(r,",config is "),o),Kn("AREAS",[At.EXTENSIONS],!0),Object.keys(o).map(c=>{c==="LOG_UPLOAD_SERVER"||c==="EVENT_REPORT_DOMAIN"||c==="EVENT_REPORT_BACKUP_DOMAIN"||c==="PROXY_SERVER_TYPE3"?Kn(c,o[c][0]):Kn(c,o[c])}))}function pf(r){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=vt.reportApiInvoke(null,{name:Si.SET_AREA,options:r,tag:wi.TRACER});try{let o=[];if(typeof r=="string"&&(o=[r]),Array.isArray(r)&&(r.forEach(u=>{if(!xe(mh).call(mh,u))throw new Te(Q.INVALID_PARAMS,"invalid area code")}),o=r),Object.prototype.toString.call(r)==="[object Object]"){const{areaCode:u,excludedArea:m}=r;if(!u)throw new Te(Q.INVALID_PARAMS,"area code is needed");let _=u;typeof u=="string"&&(_=[u]),o=m?CP(_,m):_}if(!e){if(uh.AREAS){const u=new Te(Q.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(u),void M.warning("setArea is prohibited because of config-distribute")}if(xe(o).call(o,At.GLOBAL)&&oe("AREAS")===At.EXTENSIONS){const u=new Te(Q.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(u),void M.warning("setArea is prohibited because of ap extensions")}}Kn("AREAS",o,e);const c=cC(o);Object.keys(c).map(u=>{u==="LOG_UPLOAD_SERVER"||u==="EVENT_REPORT_DOMAIN"||u==="EVENT_REPORT_BACKUP_DOMAIN"||u==="PROXY_SERVER_TYPE3"?Kn(u,c[u][0]):Kn(u,c[u])}),M.debug("set area success:",o.join(","))}catch(o){throw n.onError(o),o}n.onSuccess()}function Tg(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Cg(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Tg(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):Tg(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}let Hw=1;function RP(r,e,n,o,c){Hw+=1;const u={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:Hw,requestId:Hw,version:mr,cname:n.cname},m={service_name:e,json_body:JSON.stringify(u)};let _,S,C=r[0];return dc(async()=>{_=Date.now();const R=await zs(C,{data:m,cancelToken:o,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(S=Date.now()-_,R.code!==0){const L=new Te(Q.UNEXPECTED_RESPONSE,"live streaming ap error, code"+R.code,{retry:!0,responseTime:S});throw M.error(L.toString()),L}const w=JSON.parse(R.json_body);if(w.code!==200){const L=new Te(Q.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(w.code,", reason: ").concat(w.reason),{code:w.code,responseTime:S});throw M.error(L.toString()),L}if(!w.servers||w.servers.length===0){const L=new Te(Q.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:w.code,responseTime:S});throw M.error(L.toString()),L}const N=function(L,H){return{addressList:L.servers.map(j=>"wss://".concat(j.address.replace(/\./g,"-"),".").concat(oe("WORKER_DOMAIN"),":").concat(j.wss,"?serviceName=").concat(encodeURIComponent(H))),workerToken:L.workerToken,vid:L.vid}}(w,e);return oe("LIVE_STREAMING_ADDRESS")&&(N.addressList=oe("LIVE_STREAMING_ADDRESS")instanceof Array?oe("LIVE_STREAMING_ADDRESS"):[oe("LIVE_STREAMING_ADDRESS")]),Cg(Cg({},N),{},{responseTime:S})},(R,w)=>(vt.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(R.addressList),firstSuccess:w===0,responseTime:S,serverIp:r[w%r.length]}),!1),(R,w)=>(vt.apworkerEvent(n.sid,{success:!1,sc:R.data&&R.data.code||200,serviceName:e,responseTime:S,serverIp:r[w%r.length]}),!!(R.code!==Q.OPERATION_ABORTED&&R.code!==Q.UNEXPECTED_RESPONSE||R.data&&R.data.retry)&&(C=r[(w+1)%r.length],!0)),c)}let vg=1;function Kw(r,e,n,o){let{url:c,areaCode:u}=r;const m=Date.now();let _;const[S,C]=zw(e,u,[ts.CHOOSE_SERVER]);let R=ki.networkState;return dc(async()=>{R&&ki.networkState===fn.OFFLINE&&ki.onlineWaiter&&await Ee.race([ki.onlineWaiter,Br(o&&o.maxRetryTimeout||or.maxRetryTimeout)]),R=ki.networkState;const{data:w,headers:N}=await zs(c,{data:S,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);_=N.http3==="1"?1:-1,vt.reportResourceTiming(c,e.sid),lC(w,c,e,m,[ts.CHOOSE_SERVER],_);const L=hl(w,ts.CHOOSE_SERVER);return yP(L),sC(L,c)},w=>(w&&vt.joinChooseServer(e.sid,{lts:m,succ:!0,csAddr:c,opid:C,serverList:w.gatewayAddrs.map(N=>N.address),ec:null,cid:w.cid.toString(),uid:w.uid.toString(),csIp:w.csIp,unilbsServerIds:[ts.CHOOSE_SERVER].toString(),isHttp3:_}),!1),w=>w.code!==Q.OPERATION_ABORTED&&(w.code===Q.CAN_NOT_GET_GATEWAY_SERVER?w.data.retry:(vt.joinChooseServer(e.sid,{lts:m,succ:!1,csAddr:c,serverList:null,opid:C,ec:w.code,csIp:w.data&&w.data.csIp,unilbsServerIds:[ts.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:R}),isHttp3:_}),M.warning("[".concat(e.clientId,"] Choose server network error, retry"),w),!0)),o)}function dC(r,e,n,o){let c,{url:u,areaCode:m,serviceIds:_}=r;const S=Date.now(),[C,R]=zw(e,m,_);let w;return dc(async()=>{w&&ki.networkState===fn.OFFLINE&&ki.onlineWaiter&&await Ee.race([ki.onlineWaiter,Br(o&&o.maxRetryTimeout||or.maxRetryTimeout)]),w=ki.networkState;const{data:N,headers:L}=await zs(u,{data:C,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=L.http3==="1"?1:-1,vt.reportResourceTiming(u,e.sid),lC(N,u,e,S,_,c);const H=hl(N,ts.CHOOSE_SERVER),j=hl(N,e.cloudProxyServer==="proxy5"?ts.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?ts.CLOUD_PROXY:ts.CLOUD_PROXY_FALLBACK);return yP(H),{gatewayInfo:sC(H,u),proxyInfo:j,url:u}},N=>(N.gatewayInfo&&vt.joinChooseServer(e.sid,{lts:S,succ:!0,csAddr:u,serverList:N.gatewayInfo.gatewayAddrs.map(L=>L.address),ec:null,opid:R,cid:N.gatewayInfo.cid.toString(),uid:N.gatewayInfo.uid.toString(),csIp:N.gatewayInfo.csIp,unilbsServerIds:_.toString(),isHttp3:c}),N.proxyInfo&&vt.joinWebProxyAP(e.sid,{lts:S,sucess:1,apServerAddr:u,turnServerAddrList:N.proxyInfo.addresses.map(L=>L.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:_.toString()}),!1),N=>N.code!==Q.OPERATION_ABORTED&&(N.code===Q.CAN_NOT_GET_GATEWAY_SERVER?N.data.retry:(vt.joinWebProxyAP(e.sid,{lts:S,sucess:0,apServerAddr:u,turnServerAddrList:null,errorCode:N.code,eventType:e.cloudProxyServer,unilbsServerIds:_.toString(),extend:JSON.stringify({networkState:w})}),M.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),N),!0)),o)}const lC=(r,e,n,o,c,u)=>{const m=[],_=S=>{S.flag===4096?vt.joinChooseServer(n.sid,{lts:o,succ:!1,csAddr:e,opid:r.opid,serverList:null,ec:S.error.message,csIp:S.error.data&&S.error.data.csIp,unilbsServerIds:c.toString(),isHttp3:u}):S.flag!==1048576&&S.flag!==4194304&&S.flag!==4194310||vt.joinWebProxyAP(n.sid,{lts:o,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:S.error.code,eventType:n.cloudProxyServer,unilbsServerIds:c.toString()})};if(r.response_body.forEach(S=>{const C=S.buffer.code;if(S.uri===23&&C===0&&!S.buffer.edges_services)if(S.buffer.flag===4194310)M.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),S.buffer.edges_services=[];else{const R={error:new Te(Q.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:r.detail[502]}),flag:S.buffer.flag};m.push(R),_(R)}if(C!==0){const R=hg(C),w={error:new Te(Q.CAN_NOT_GET_GATEWAY_SERVER,R.desc,{desc:R.desc,retry:R.retry,csIp:r.detail[502]}),flag:S.buffer.flag};S.buffer.flag===4194310?M.warning(w.error.toString()):m.push(w),_(w)}}),m.length)throw M.warning("[".concat(n.clientId,"] multi unilbs ").concat(e," failed, ").concat(m.map(S=>"flag: ".concat(S.flag,", message: ").concat(S.error.message,", retry: ").concat(S.error.data.retry)).join(" | "))),new Te(Q.CAN_NOT_GET_GATEWAY_SERVER,m.map(S=>"flag: ".concat(S.flag,", message: ").concat(S.error.message)).join(" | "),{retry:!!m.find(S=>S.error.data.retry),csIp:r.detail[502],desc:[...new Set(m.map(S=>{var C;return S==null||(C=S.error)===null||C===void 0||(C=C.data)===null||C===void 0?void 0:C.desc}).filter(S=>!!S))]})},yP=r=>{var e,n,o,c;if(r.addresses&&r.addresses.length===0&&r.code===0)throw new Te(Q.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:r.detail&&r.detail[502]});if(oe("AP_AREA")&&((o=r.detail)!==null&&o!==void 0&&o[23]&&typeof((c=r.detail)===null||c===void 0?void 0:c[23])=="string"?vP(r.detail[23].toLowerCase()):vP()),(e=r.detail)!==null&&e!==void 0&&e[19]&&typeof((n=r.detail)===null||n===void 0?void 0:n[19])=="string"){const m=r.detail[19],_=m==null?void 0:m.split(";");for(let S=0;S<_.length;S++){var u;const C=ua(u=_[S]).call(u);r.addresses[S]&&_&&(r.addresses[S].fingerprint=C)}}if(oe("GATEWAY_ADDRESS")&&oe("GATEWAY_ADDRESS").length>0){M.debug("assign gateway address to",oe("GATEWAY_ADDRESS"));const m=oe("GATEWAY_ADDRESS").map(_=>{var S,C;const R=(S=(C=r.addresses.find(w=>w.ip===_.ip&&w.port===_.port))===null||C===void 0?void 0:C.fingerprint)!==null&&S!==void 0?S:"";return{ip:_.ip,port:_.port,ticket:r.addresses[0]&&r.addresses[0].ticket,fingerprint:R}});r.addresses=m}},Yw=(r,e)=>{if(r.response_body&&r.response_body.length){const n=r.response_body[0];if(n.buffer.code!==0){const o=hg(n.buffer.code);throw new Te(Q.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(o.desc),{retry:o.retry})}return n.buffer.ticket}throw M.debug("update ticket request received ap response without response body:",e),new Te(Q.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},zw=(r,e,n)=>{const o=Math.floor(Math.random()*1e12),c={appid:r.appId,client_ts:Date.now(),opid:o,sid:r.sid,request_bodies:[{uri:22,buffer:{cname:r.cname,detail:Cg({6:r.stringUid,11:e,12:oe("USE_NEW_TOKEN")?"1":void 0,22:e},r.apRTM?{26:"RTM2"}:{}),key:r.token,service_ids:n,uid:r.uid||0}}]};c.request_bodies.forEach(m=>{r.multiIP&&r.multiIP.gateway_ip&&(m.buffer.detail[5]=JSON.stringify({vocs_ip:[r.multiIP.uni_lbs_ip],vos_ip:[r.multiIP.gateway_ip]}))});const u=new FormData;return u.append("request",JSON.stringify(c)),[u,o]},IP=(r,e)=>{const n=Math.floor(Math.random()*1e12),o={appid:r.appId,client_ts:Date.now(),opid:n,sid:r.sid,request_bodies:[{uri:28,buffer:{cname:r.cname,detail:{1:"",6:r.stringUid,12:"1"},token:r.token,service_ids:e,uid:r.uid||0,edges_services:r.apResponse.addresses.map(u=>({ip:u.ip,port:u.port}))}}]},c=new FormData;return c.append("request",JSON.stringify(o)),[c,n]};let Vp=0;function Fp(r){return Ee.all(r.map(e=>e.then(n=>{throw n},n=>n))).then(e=>{throw e},e=>e)}const Rg=async r=>{let{fragementLength:e,referenceList:n,asyncMapHandler:o,allFailedhandler:c,promisesCollector:u}=r,m=0;const _=e;let S,C=0;const R=async()=>{const w=(()=>{const N=m*_,L=N+_;return n.slice(N,L).map(o)})();u&&u.push(...w);try{S=await Fp(w)}catch(N){if(C+=_,m++,!(C>=n.length))return void await R();c(N)}w.forEach(N=>N.cancel())};return await R(),S};async function uC(r,e,n,o){return{gatewayInfo:await async function(u,m,_,S){let C=null;const R=[],w=async()=>{const L=oe("WEBCS_DOMAIN").slice(0,oe("AJAX_REQUEST_CONCURRENT")).map(W=>({url:u.proxyServer?"https://".concat(u.proxyServer,"/ap/?url=").concat(W+"/api/v2/transpond/webrtc?v=2"):"https://".concat(W,"/api/v2/transpond/webrtc?v=2"),areaCode:lf()})),H=S.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:L.map(W=>W.url)}),j=await Rg({fragementLength:oe("FRAGEMENT_LENGTH"),referenceList:L,asyncMapHandler:W=>(M.debug("[".concat(u.clientId,"] Connect to choose_server:"),W.url),Kw(W,u,m,_)),allFailedhandler:W=>{throw S.recordJoinChannelService({endTs:Date.now(),status:"error",errors:W},H),W[0]},promisesCollector:R});return S.recordJoinChannelService({endTs:Date.now(),status:"success"},H),j},N=async()=>{if(await Br(1e3),C!==null)return C;const L=oe("WEBCS_DOMAIN_BACKUP_LIST").map(W=>({url:u.proxyServer?"https://".concat(u.proxyServer,"/ap/?url=").concat(W+"/api/v2/transpond/webrtc?v=2"):"https://".concat(W,"/api/v2/transpond/webrtc?v=2"),areaCode:lf()})),H=S.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:L.map(W=>W.url)}),j=await Rg({fragementLength:oe("FRAGEMENT_LENGTH"),referenceList:L,asyncMapHandler:W=>(M.debug("[".concat(u.clientId,"] Connect to backup choose_server:"),W.url),Kw(W,u,m,_)),allFailedhandler:W=>{throw S.recordJoinChannelService({endTs:Date.now(),status:"error",errors:W},H),W[0]},promisesCollector:R});return S.recordJoinChannelService({endTs:Date.now(),status:"success"},H),j};try{return C=await Fp([w(),N()]),R.length&&R.forEach(L=>L.cancel&&typeof L.cancel=="function"&&L.cancel()),C}catch(L){throw L[0]}}(r,e,n,o)}}async function AP(r,e,n,o,c){const u=r.cloudProxyServer;if(u==="disabled"){if(r.useLocalAccessPoint)return await uC(r,e,n,c);if(oe("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:N,proxyInfo:L}=await ff(r,e,n,c);if(r.turnServer&&r.turnServer.mode!=="auto")return{gatewayInfo:N};const H=L.map(j=>({turnServerURL:j.address,tcpport:j.tcpport||Mt.tcpport,udpport:j.udpport||Mt.udpport,username:j.username||Mt.username,password:j.password||Mt.password,forceturn:!1,security:!0}));if(c.useP2P){var m;const j=(m=r.uid)!==null&&m!==void 0?m:N.uid,W="glb:".concat(j.toString()),ee=await dn(W),re=L.map(fe=>({turnServerURL:fe.address,tcpport:fe.tcpport||Mt.tcpport,udpport:fe.udpport||Mt.udpport,username:W,password:ee,forceturn:!1,security:!0}));H.push(...re)}return r.turnServer={mode:"manual",servers:H},{gatewayInfo:N}}return await uC(r,e,n,c)}const{proxyInfo:_,gatewayInfo:S}=await ff(r,e,n,c),C={gatewayInfo:S},R=_.map(N=>({turnServerURL:N.address,tcpport:u==="proxy3"?void 0:N.tcpport?N.tcpport:Mt.tcpport,udpport:u==="proxy4"?void 0:N.udpport?N.udpport:Mt.udpport,username:N.username||Mt.username,password:N.password||Mt.password,forceturn:u!=="proxy4",security:u==="proxy5"}));if(c.useP2P){var w;const N=(w=r.uid)!==null&&w!==void 0?w:S.uid,L="glb:".concat(N.toString()),H=await dn(L),j=_.map(W=>({turnServerURL:W.address,tcpport:u==="proxy3"?void 0:W.tcpport||Mt.tcpport,udpport:u==="proxy4"?void 0:W.udpport||Mt.udpport,username:L,password:H,forceturn:u!=="proxy4",security:u==="proxy5"}));R.push(...j)}return r.turnServer={mode:"manual",servers:R},M.debug("[".concat(r.clientId,"] set proxy server: ").concat(r.proxyServer,", mode: ").concat(u)),C}async function jp(r,e,n,o,c){const u=oe("ACCOUNT_REGISTER").slice(0,oe("AJAX_REQUEST_CONCURRENT"));let m=[];m=e.proxyServer?u.map(S=>"https://".concat(e.proxyServer,"/ap/?url=").concat(S+"/api/v1")):u.map(S=>"https://".concat(S,"/api/v1"));const _=c==null?void 0:c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:m});try{const S=await async function(C,R,w,N,L){const H=Date.now(),j={sid:w.sid,opid:10,appid:w.appId,string_uid:R};let W=C[0];const ee=await dc(()=>zs(W+"".concat(W.indexOf("?")===-1?"?":"&","action=stringuid"),{data:j,cancelToken:N,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(re,fe)=>{if(re.code===0){if(re.uid<=0||re.uid>=Math.pow(2,32))throw M.error("Invalid Uint Uid ".concat(R," => ").concat(re.uid),re),vt.reqUserAccount(j.sid,{lts:H,success:!1,serverAddr:W,stringUid:j.string_uid,uid:re.uid,errorCode:Q.INVALID_UINT_UID_FROM_STRING_UID,extend:j}),new Te(Q.INVALID_UINT_UID_FROM_STRING_UID);return vt.reqUserAccount(j.sid,{lts:H,success:!0,serverAddr:W,stringUid:j.string_uid,uid:re.uid,errorCode:null,extend:j}),!1}const be=hg(re.code);return be.retry&&(W=C[(fe+1)%C.length]),vt.reqUserAccount(j.sid,{lts:H,success:!1,serverAddr:W,stringUid:j.string_uid,uid:re.uid,errorCode:be.desc,extend:j}),be.retry},(re,fe)=>re.code!==Q.OPERATION_ABORTED&&(vt.reqUserAccount(j.sid,{lts:H,success:!1,serverAddr:W,stringUid:j.string_uid,uid:null,errorCode:re.code,extend:j}),W=C[(fe+1)%C.length],!0),L);if(ee.code!==0){const re=hg(ee.code);throw new Te(Q.UNEXPECTED_RESPONSE,re.desc)}return ee}(m,r,e,n,o);return c==null||c.recordJoinChannelService({status:"success",endTs:Date.now()},_),S.uid}catch(S){throw c==null||c.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[S]},_),S}}async function mf(r,e,n){const o=oe("CDS_AP").slice(0,oe("AJAX_REQUEST_CONCURRENT")).map(S=>r.proxyServer?"https://".concat(r.proxyServer,"/ap/?url=").concat(S+"/api/v1"):"https://".concat(S,"/api/v1?action=config")),c=o.map(S=>function(C,R,w,N){const L=qt(),H={flag:64,cipher_method:0,features:{device:L.name,system:L.os,system_general:navigator.userAgent,vendor:R.appId,version:mr,cname:R.cname,sid:R.sid,session_id:R.sid,detail:"",proxyServer:R.proxyServer}};return dc(()=>zs(C,{data:H,timeout:1e3,cancelToken:w,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,j=>j.code!==Q.OPERATION_ABORTED,N)}(S,r,e,n));let u=null,m=null,_={};try{u=await Fp(c)}catch(S){if(S.code===Q.OPERATION_ABORTED)throw S;m=S}if(c.forEach(S=>S.cancel()),vt.reportApiInvoke(r.sid,{name:Si.REQUEST_CONFIG_DISTRIBUTE,options:{error:m,res:u}}).onSuccess(),u&&u.test_tags)try{_=function(S){if(!S.test_tags)return{};const C=S.test_tags,R=Object.keys(C),w={};return R.forEach(N=>{var L;const H=ua(L=N.slice(4)).call(L),j=JSON.parse(C[N])[1];w[H]=j}),w}(u)}catch{}return _}async function ff(r,e,n,o){const c=oe("PROXY_SERVER_TYPE3"),u=(L,H,j)=>{let W=j||c;return Array.isArray(W)&&(W=H%2==0?c[1]:c[0]),"https://".concat(W,"/ap/?url=").concat(L)};let m=null;const _=[],S=async()=>{const L=oe("WEBCS_DOMAIN").slice(0,oe("AJAX_REQUEST_CONCURRENT")).map((W,ee)=>{let re;return re=r.cloudProxyServer==="disabled"&&r.proxyServer?u("".concat(W,"/api/v2/transpond/webrtc?v=2"),ee,r.proxyServer):r.cloudProxyServer==="disabled"||r.cloudProxyServer==="fallback"?"https://".concat(W,"/api/v2/transpond/webrtc?v=2"):u("".concat(W,"/api/v2/transpond/webrtc?v=2"),ee),{url:re,areaCode:lf(),serviceIds:[ts.CHOOSE_SERVER,r.cloudProxyServer==="proxy5"?ts.CLOUD_PROXY_5:r.cloudProxyServer==="proxy3"||r.cloudProxyServer==="proxy4"?ts.CLOUD_PROXY:ts.CLOUD_PROXY_FALLBACK]}}),H=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:L.map(W=>W.url)}),j=await Rg({fragementLength:oe("FRAGEMENT_LENGTH"),referenceList:L,asyncMapHandler:W=>(M.debug("[".concat(r.clientId,"] Connect to choose_server:"),W.url),dC(W,r,e,n)),allFailedhandler:W=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:W},H),W[0]},promisesCollector:_});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},H),j},C=async()=>{if(await Br(1e3),m!==null)return m;const L=oe("WEBCS_DOMAIN_BACKUP_LIST").map((W,ee)=>{let re;return re=r.cloudProxyServer==="disabled"&&r.proxyServer?u("".concat(W,"/api/v2/transpond/webrtc?v=2"),ee,r.proxyServer):r.cloudProxyServer==="disabled"||r.cloudProxyServer==="fallback"?"https://".concat(W,"/api/v2/transpond/webrtc?v=2"):u("".concat(W,"/api/v2/transpond/webrtc?v=2"),ee),{url:re,areaCode:lf(),serviceIds:[ts.CHOOSE_SERVER,r.cloudProxyServer==="proxy5"?ts.CLOUD_PROXY_5:r.cloudProxyServer==="proxy3"||r.cloudProxyServer==="proxy4"?ts.CLOUD_PROXY:ts.CLOUD_PROXY_FALLBACK]}}),H=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:L.map(W=>W.url)}),j=await Rg({fragementLength:oe("FRAGEMENT_LENGTH"),referenceList:L,asyncMapHandler:W=>(M.debug("[".concat(r.clientId,"] Connect to backup choose_server:"),W.url),dC(W,r,e,n)),allFailedhandler:W=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:W},H),W[0]},promisesCollector:_});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},H),j};let R,w,N;try{({gatewayInfo:R,proxyInfo:w,url:N}=await Fp([S(),C()]))}catch(L){throw L[0]}if(_.length&&_.forEach(L=>L.cancel&&typeof L.cancel=="function"&&L.cancel()),!R||!w)throw new Te(Q.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(r.apUrl=N,r.cloudProxyServer!=="disabled"&&Array.isArray(c)&&N){const L=/^https?:\/\/(.+?)(\/.*)?$/.exec(N)[1];xe(c).call(c,L)&&(r.proxyServer=L,M.setProxyServer(L),vt.setProxyServer(L))}return m={gatewayInfo:R,proxyInfo:await EP(w,R.uid)},m}async function hC(r,e,n,o){const c=oe("UAP_AP").slice(0,oe("AJAX_REQUEST_CONCURRENT")).map(u=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(u+"/api/v1?action=uap"):"https://".concat(u,"/api/v1?action=uap"));return await RP(c,r,e,n,o)}async function wP(r,e,n){const o=oe("UAP_AP").slice(0,oe("AJAX_REQUEST_CONCURRENT")).map(u=>r.proxyServer?"https://".concat(r.proxyServer,"/ap/?url=").concat(u+"/api/v1?action=uap"):"https://".concat(u,"/api/v1?action=uap")),c=o.map(u=>function(m,_,S,C){const R={command:"convergeAllocateEdge",sid:_.sid,appId:_.appId,token:_.token,ts:Date.now(),version:mr,cname:_.cname,uid:_.uid.toString(),requestId:vg,seq:vg};vg+=1;const w={service_name:"tele_channel",json_body:JSON.stringify(R)};return dc(async()=>{const N=await zs(m,{data:w,cancelToken:S,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(N.code!==0){const H=new Te(Q.UNEXPECTED_RESPONSE,"cross channel ap error, code"+N.code,{retry:!0});throw M.error(H.toString()),H}const L=JSON.parse(N.json_body);if(L.code!==200){const H=new Te(Q.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(L.code,", reason: ").concat(L.reason));throw M.error(H.toString()),H}if(!L.servers||L.servers.length===0){const H=new Te(Q.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw M.error(H.toString()),H}return{vid:L.vid,workerToken:L.workerToken,addressList:(oe("CHANNEL_MEDIA_RELAY_SERVERS")||L.servers).map(H=>"wss://".concat(H.address.replace(/\./g,"-"),".").concat(oe("WORKER_DOMAIN"),":").concat(H.wss))}},void 0,N=>!!(N.code!==Q.OPERATION_ABORTED&&N.code!==Q.UNEXPECTED_RESPONSE||N.data&&N.data.retry),C)}(u,r,e,n));try{const u=await Fp(c);return c.forEach(m=>m.cancel()),u}catch(u){throw u[0]}}async function bP(r,e,n){let o=null;const c=[],u=async m=>{const _=oe(m?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(S=>r.proxyServer?"https://".concat(r.proxyServer,"/ap/?url=").concat(S+"/api/v2/transpond/webrtc?v=2"):"https://".concat(S,"/api/v2/transpond/webrtc?v=2"));return m&&(await Br(1e3),o!==null)?o:await Rg({fragementLength:oe("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:S=>(M.debug("[".concat(r.clientId,"] update ticket, Connect to ").concat(m?"backup":""," choose_server:"),S),function(C,R,w,N){const[L]=IP(R,[ts.CHOOSE_SERVER]);let H=ki.networkState;return dc(async()=>{H&&ki.networkState===fn.OFFLINE&&ki.onlineWaiter&&await Ee.race([ki.onlineWaiter,Br(N&&N.maxRetryTimeout||or.maxRetryTimeout)]),H=ki.networkState;const j=await zs(C,{data:L,cancelToken:w,headers:{"Content-Type":"multipart/form-data;"}},!0);return Yw(j,C)},()=>!1,j=>j.code!==Q.OPERATION_ABORTED&&(j.code===Q.UPDATE_TICKET_FAILED?j.data.retry:(M.warning("[".concat(R.clientId,"] update ticket network error, retry"),j),!0)),N)}(S,r,e,n)),allFailedhandler:S=>{throw S[0]},promisesCollector:c})};try{return o=await Fp([u(!1),u(!0)]),c.length&&c.forEach(m=>m.cancel&&typeof m.cancel=="function"&&m.cancel()),o}catch(m){throw m[0]}}function OP(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function qw(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?OP(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):OP(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class NP extends Dt{get isSuccess(){return!!this.configs}constructor(){super(),D(this,"configs",void 0),D(this,"joinInfo",void 0),D(this,"cancelToken",void 0),D(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),D(this,"interval",void 0),D(this,"mutex",new Zr("config-distribute")),D(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,n){this.joinInfo=e,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),oe("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},oe("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,vt.reportApiInvoke(null,{options:void 0,name:Si.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:wi.TRACER}).onSuccess(JSON.stringify(uh))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void M.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await mf(this.joinInfo,this.cancelToken,this.retryConfig),M.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(o){const c=new Te(Q.NETWORK_RESPONSE_ERROR,o);M.warning("[config-distribute] ".concat(c.toString()))}finally{n()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var n;(n=e)&&n.uplink&&n.id&&n.uplink.max_bitrate!==void 0&&n.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(Cn.UPDATE_BITRATE_LIMIT,e):this.emit(Cn.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&qw({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var n;const o=LE(n=Object.keys(e).filter(u=>/^webrtc_ng_global_parameter/.test(u))).call(n);for(let u=0;u<o.length;u++)for(let m=o.length-1;m>u;m--){const _=o[m];if(typeof e[_].__priority=="number"){const S=e[_].__priority,C=o[m-1];if(typeof e[C].__priority=="number"){if(!(S>e[C].__priority))continue;{const R=_;o[m]=o[m-1],o[m-1]=R}}else{const R=_;o[m]=o[m-1],o[m-1]=R}}}const c={};o.forEach(u=>{const m=e[u],_=m.__expires;Object.keys(m).forEach(S=>{S==="__priority"||S==="__expires"||Object.prototype.hasOwnProperty.call(c,S)||(c[S]=qw({value:m[S]},_&&{expires:_}))})});try{(function(_){try{const S=Date.now();Object.keys(_).forEach(C=>{switch(C){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(Ss,C)){const{value:R,expires:w}=_[C];if(w&&w<=S)return;uh[C]=R,Ss[C]=R,M.debug("Update global parameters from config distribute",C,R)}}})}catch(S){M.error("Error update config immediately: ".concat(_),S.message)}})(c);const u=JSON.stringify(c),m=window.btoa(u);window.localStorage.setItem("websdk_ng_global_parameter",m),M.debug("Caching global parameters ".concat(u))}catch(u){M.error("Error caching global parameters:",u.message)}}}const qs={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function Dn(){return qs}var Nr;function Bp(r,e,n){return{sampleRate:r,stereo:e,bitrate:n}}function Rn(r,e,n,o,c){return{width:r,height:e,frameRate:n,bitrateMin:o,bitrateMax:c}}function Zi(r,e,n,o,c){return{width:{max:r},height:{max:e},frameRate:n,bitrateMin:o,bitrateMax:c}}function zn(r,e){return{numSpatialLayers:r,numTemporalLayers:e}}(function(r){r.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",r.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",r.IOS_INTERRUPTION_START="ios-interruption-start",r.IOS_INTERRUPTION_END="ios-interruption-end",r.STATE_CHANGE="state-change"})(Nr||(Nr={}));const Wr={"90p":Rn(160,90),"90p_1":Rn(160,90),"120p":Rn(160,120,15,30,65),"120p_1":Rn(160,120,15,30,65),"120p_3":Rn(120,120,15,30,50),"120p_4":Rn(212,120),"180p":Rn(320,180,15,30,140),"180p_1":Rn(320,180,15,30,140),"180p_3":Rn(180,180,15,30,100),"180p_4":Rn(240,180,15,30,120),"240p":Rn(320,240,15,40,200),"240p_1":Rn(320,240,15,40,200),"240p_3":Rn(240,240,15,40,140),"240p_4":Rn(424,240,15,40,220),"360p":Rn(640,360,15,80,400),"360p_1":Rn(640,360,15,80,400),"360p_3":Rn(360,360,15,80,260),"360p_4":Rn(640,360,30,80,600),"360p_6":Rn(360,360,30,80,400),"360p_7":Rn(480,360,15,80,320),"360p_8":Rn(480,360,30,80,490),"360p_9":Rn(640,360,15,80,800),"360p_10":Rn(640,360,24,80,800),"360p_11":Rn(640,360,24,80,1e3),"480p":Rn(640,480,15,100,500),"480p_1":Rn(640,480,15,100,500),"480p_2":Rn(640,480,30,100,1e3),"480p_3":Rn(480,480,15,100,400),"480p_4":Rn(640,480,30,100,750),"480p_6":Rn(480,480,30,100,600),"480p_8":Rn(848,480,15,100,610),"480p_9":Rn(848,480,30,100,930),"480p_10":Rn(640,480,10,100,400),"720p":Rn(1280,720,15,120,1130),"720p_auto":Rn(1280,720,30,900,3e3),"720p_1":Rn(1280,720,15,120,1130),"720p_2":Rn(1280,720,30,120,2e3),"720p_3":Rn(1280,720,30,120,1710),"720p_5":Rn(960,720,15,120,910),"720p_6":Rn(960,720,30,120,1380),"1080p":Rn(1920,1080,15,120,2080),"1080p_1":Rn(1920,1080,15,120,2080),"1080p_2":Rn(1920,1080,30,120,3e3),"1080p_3":Rn(1920,1080,30,120,3150),"1080p_5":Rn(1920,1080,60,120,4780),"1440p":Rn(2560,1440,30,120,4850),"1440p_1":Rn(2560,1440,30,120,4850),"1440p_2":Rn(2560,1440,60,120,7350),"4k":Rn(3840,2160,30,120,8910),"4k_1":Rn(3840,2160,30,120,8910),"4k_3":Rn(3840,2160,60,120,13500)},lu=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],yn={"480p":Zi(640,480,5),"480p_1":Zi(640,480,5),"480p_2":Zi(640,480,30),"480p_3":Zi(640,480,15),"720p":Zi(1280,720,5),"720p_auto":Rn(1280,720,30,900,3e3),"720p_1":Zi(1280,720,5),"720p_2":Zi(1280,720,30),"720p_3":Zi(1280,720,15),"1080p":Zi(1920,1080,5),"1080p_1":Zi(1920,1080,5),"1080p_2":Zi(1920,1080,30),"1080p_3":Zi(1920,1080,15)},Yc={"1SL1TL":zn(1,1),"3SL3TL":zn(3,3),"2SL3TL":zn(2,3)};function zc(r){return r||(r="480p_1"),typeof r=="string"?Object.assign({},Wr[r]):r}function Jw(r){return typeof r=="string"?Object.assign({},yn[r]):r}function Gp(r){return typeof r=="string"?Object.assign({},Yc[r]):r}const $B={speech_low_quality:Bp(16e3,!1),speech_standard:Bp(32e3,!1,18),music_standard:Bp(48e3,!1),standard_stereo:Bp(48e3,!0,56),high_quality:Bp(48e3,!1,128),high_quality_stereo:Bp(48e3,!0,192)};function pC(r){return typeof r=="string"?Object.assign({},$B[r]):r}const ha=[];function mC(r){return Rr(r,"mediaSource",["screen","window","application"]),!0}var ht,hi,Dd,gh,fC,ut,Un,pa,_o,_C;(function(r){r.NEED_RENEGOTIATE="@need_renegotiate",r.NEED_REPLACE_TRACK="@need_replace_track",r.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",r.NEED_CLOSE="@need_close",r.NEED_ENABLE_TRACK="@need_enable_track",r.NEED_DISABLE_TRACK="@need_disable_track",r.NEED_SESSION_ID="@need_sid",r.SET_OPTIMIZATION_MODE="@set_optimization_mode",r.GET_STATS="@get_stats",r.GET_RTC_STATS="@get_rtc_stats",r.GET_LOW_VIDEO_TRACK="@get_low_video_track",r.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",r.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",r.NEED_MUTE_TRACK="@need_mute_track",r.NEED_UNMUTE_TRACK="@need_unmute_track"})(ht||(ht={})),function(r){r.SCREEN_TRACK="screen_track",r.CUSTOM_TRACK="custome_track",r.LOW_STREAM="low_stream"}(hi||(hi={})),function(r){r[r.HIGH_STREAM=0]="HIGH_STREAM",r[r.LOW_STREAM=1]="LOW_STREAM"}(Dd||(Dd={})),function(r){r[r.HIGH_STREAM=0]="HIGH_STREAM",r[r.LOW_STREAM=1]="LOW_STREAM"}(gh||(gh={})),function(r){r[r.DISABLE=0]="DISABLE",r[r.LOW_STREAM=1]="LOW_STREAM",r[r.AUDIO_ONLY=2]="AUDIO_ONLY"}(fC||(fC={})),function(r){r.TRANSCEIVER_UPDATED="transceiver-updated",r.SEI_TO_SEND="sei-to-send",r.SEI_RECEIVED="sei-received"}(ut||(ut={})),function(r){r.SOURCE_STATE_CHANGE="source-state-change",r.TRACK_ENDED="track-ended",r.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",r.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",r.CLOSED="closed"}(Un||(Un={})),function(r){r.FIRST_FRAME_DECODED="first-frame-decoded",r.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",r.VIDEO_STATE_CHANGED="video-state-changed"}(pa||(pa={})),function(r){r.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",r.RECEIVE_TRACK_BUFFER="receive_track_buffer",r.ON_AUDIO_BUFFER="on_audio_buffer",r.UPDATE_SOURCE="update_source"}(_o||(_o={})),function(r){r.UPDATE_TRACK_SOURCE="update-track-source"}(_C||(_C={}));const Sh={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},pl={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},Th={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},Jo={uplinkNetworkQuality:0,downlinkNetworkQuality:0},yg={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var ys,Eo,Ch,uu,ks,$i;(function(r){r.ON_TRACK="on_track",r.ON_NODE="on_node"})(ys||(ys={})),function(r){r.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",r.REQUEST_CONSTRAINTS="request_constraints"}(Eo||(Eo={})),function(r){r.IDLE="IDLE",r.INITING="INITING",r.INITEND="INITEND"}(Ch||(Ch={})),function(r){r.STATE_CHANGE="state_change",r.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",r.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",r.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(uu||(uu={})),function(r){r.NONE="none",r.INIT="init",r.CANPLAY="canplay",r.PLAYING="playing",r.PAUSED="paused",r.SUSPEND="suspend",r.STALLED="stalled",r.WAITING="waiting",r.ERROR="error",r.DESTROYED="destroyed",r.ABORT="abort",r.ENDED="ended",r.EMPTIED="emptied",r.LOADEDDATA="loadeddata"}(ks||(ks={})),function(r){r[r.VideoStateStopped=0]="VideoStateStopped",r[r.VideoStateStarting=1]="VideoStateStarting",r[r.VideoStateDecoding=2]="VideoStateDecoding",r[r.VideoStateFrozen=3]="VideoStateFrozen"}($i||($i={}));const go={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var qc;(function(r){r.OPEN="open",r.MESSAGE="message",r.CLOSE="close",r.CLOSING="closing",r.ERROR="error"})(qc||(qc={}));class ml extends Dt{constructor(e,n){super(),D(this,"_ID",void 0),D(this,"_rtpTransceiver",void 0),D(this,"_lowRtpTransceiver",void 0),D(this,"_hints",[]),D(this,"_isClosed",!1),D(this,"_originMediaStreamTrack",void 0),D(this,"_mediaStreamTrack",void 0),D(this,"_external",{}),this._ID=n||oi(8,"track-"),this._originMediaStreamTrack=e,this._mediaStreamTrack=e,function(o){xe(ha).call(ha,o)||ha.push(o)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){if(!e){const n=vt.reportApiInvoke(null,{name:Si.GET_MEDIA_STREAM_TRACK,options:[],tag:wi.TRACER});this._mediaStreamTrack&&typeof this._mediaStreamTrack.label=="string"?n.onSuccess(this._mediaStreamTrack.label):n.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===Dd.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const n=ha.indexOf(e);n!==-1&&ha.splice(n,1)}(this),this.emit(Un.CLOSED),this.removeAllListeners(ut.SEI_RECEIVED)}_updateRtpTransceiver(e,n){if(n===Dd.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(ut.TRANSCEIVER_UPDATED,e,n)}}class di extends ml{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,n){super(e,n),D(this,"_enabled",!0),D(this,"_muted",!1),D(this,"_isExternalTrack",!1),D(this,"_isClosed",!1),D(this,"_enabledMutex",void 0),D(this,"processor",void 0),D(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Zr("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,n;return(e=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,M.debug("[".concat(this.getTrackId(),"] close")),this.emit(ht.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,n){let o=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=o,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mn(this,ht.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){M.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Un.TRACK_ENDED)}stateCheck(e,n){if(M.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(n,"]")),nl(n,e),this._enabled&&this._muted&&e==="enabled"&&n===!1)throw new ke(Q.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",M);if(!this._enabled&&!this._muted&&e==="muted"&&n===!0)throw new ke(Q.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",M)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Ee.resolve([])}}function EC(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}const Wp=window.AudioContext||window.webkitAudioContext;let ma=null;const tn=new class extends Dt{constructor(){super(...arguments),D(this,"prevState",void 0),D(this,"curState",void 0),D(this,"currentTime",void 0),D(this,"currentTimeStuckAt",void 0),D(this,"interruptDetectorTrack",void 0),D(this,"onLocalAudioTrackMute",()=>{M.info("ios15-interruption-start"),this.emit(Nr.IOS_15_16_INTERRUPTION_START)}),D(this,"onLocalAudioTrackUnmute",async()=>{M.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?M.info("ios15-interruption-end-canceled"):(ma&&await ma.suspend(),this.emit(Nr.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(r){M.debug("webaudio bindInterruptDetectorTrack ".concat(r.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=r,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(r){M.debug("webaudio unbindInterruptDetectorTrack ".concat(r.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===r&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function DP(){if(!Wp)return void M.error("your browser is not support web audio");M.info("create audio context");const r=function(e){for(var n=1;n<arguments.length;n++){var o=arguments[n]!=null?arguments[n]:{};n%2?EC(Object(o),!0).forEach(function(c){D(e,c,o[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):EC(Object(o)).forEach(function(c){Object.defineProperty(e,c,Object.getOwnPropertyDescriptor(o,c))})}return e}({},oe("WEBAUDIO_INIT_OPTIONS"));M.debug("audio context init option:",JSON.stringify(r)),ma=new Wp(r),tn.curState=ma.state,ma.onstatechange=()=>{tn.prevState=tn.curState,tn.curState=ma?ma.state:void 0;const{prevState:e,curState:n}=tn,o=n==="running",c=n==="interrupted",u=e==="running",m=e==="suspended",_=e==="interrupted",S=qt().osVersion;(Ds()||Ve())&&u&&c&&(M.info("ios".concat(S,"-interruption-start")),tn.emit(Nr.IOS_INTERRUPTION_START)),(Ds()||Ve())&&(m||_)&&o&&(M.info("ios".concat(S,"-interruption-end")),tn.emit(Nr.IOS_INTERRUPTION_END)),e!==n&&tn.emit(Nr.STATE_CHANGE,n,e)},setInterval(()=>{var e;const n=(e=ma)===null||e===void 0?void 0:e.currentTime;tn.currentTime!==n?(tn.currentTimeStuckAt&&(M.debug("AudioContext current time resume at ".concat(n)),tn.currentTimeStuckAt=void 0),tn.currentTime=n):(n!==tn.currentTimeStuckAt&&(vt.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:wi.TRACER}).onSuccess(),M.warning("AudioContext current time stuck at ".concat(n))),tn.currentTimeStuckAt=n)},5e3),async function(e){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let o,c=!1,u=!1,m=!1;function _(W){e.state==="running"?S(!1):Ds()||Ve()?e.state==="suspended"&&(S(!0),W&&e.resume().then(R,R)):e.state!=="closed"&&(S(!0),W&&e.resume().then(R,R))}function S(W){if(c!==W){c=W;for(let ee=0,re=n;ee<re.length;ee+=1){const fe=re[ee];W?window.addEventListener(fe,w,{capture:!0,passive:!0}):window.removeEventListener(fe,w,{capture:!0,passive:!0})}}}function C(){_(!0)}function R(){_(!1)}function w(){_(!0)}function N(W){if(!m)if(o.paused)if(W){let ee;L(!1),m=!0;try{ee=o.play(),ee?ee.then(H,H):(o.addEventListener("playing",H),o.addEventListener("abort",H),o.addEventListener("error",H))}catch{H()}}else L(!0);else L(!1)}function L(W){if(u!==W){u=W;for(let ee=0,re=n;ee<re.length;ee++){const fe=re[ee];W?window.addEventListener(fe,j,{capture:!0,passive:!0}):window.removeEventListener(fe,j,{capture:!0,passive:!0})}}}function H(){o.removeEventListener("playing",H),o.removeEventListener("abort",H),o.removeEventListener("error",H),m=!1,N(!1)}function j(){N(!0)}if(Ds()){const W=e.createMediaStreamDestination(),ee=document.createElement("div");ee.innerHTML="<audio x-webkit-airplay='deny'></audio>",o=ee.children.item(0),o.controls=!1,o.disableRemotePlayback=!0,o.preload="auto",o.srcObject=W.stream,N(!0)}tn.on(Nr.STATE_CHANGE,C),_(!1)}(ma)}function Hp(){if(!ma){if(DP(),!ma)throw new ke(Q.NOT_SUPPORTED,"can not create audio context");return ma}return ma}function Js(r){if(function(){if(Wn!==null)return Wn;const o=Hp(),c=o.createBufferSource(),u=o.createGain(),m=o.createGain();c.connect(u),c.connect(m),c.disconnect(u);let _=!1;try{c.disconnect(u)}catch{_=!0}return c.disconnect(),Wn=_,_}())return;const e=r.connect,n=r.disconnect;r.connect=(o,c,u)=>{var m;return r._inputNodes||(r._inputNodes=[]),xe(m=r._inputNodes).call(m,o)||(o instanceof AudioNode?(r._inputNodes.push(o),e.call(r,o,c,u)):e.call(r,o,c)),r},r.disconnect=(o,c,u)=>{n.call(r),o?ef(r._inputNodes,o):r._inputNodes=[];for(const m of r._inputNodes)e.call(r,m)}}let Wn=null;function Xw(r,e){let n=!1;const o=1/e;if(oe("DISABLE_WEBAUDIO")){const c=window.setInterval(()=>{n?window.clearInterval(c):r(performance.now()/1e3)},1e3*o)}else{const c=Hp();let u=c.createGain();u.gain.value=0,u.connect(c.destination);const m=()=>{if(n)return void(u=null);const _=c.createOscillator();_.onended=m,_.connect(u),_.start(0),_.stop(c.currentTime+o),r(c.currentTime)};m()}return()=>{n=!0}}class Kp{constructor(){D(this,"context",void 0),D(this,"analyserNode",void 0),D(this,"sourceNode",void 0),this.context=Hp(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Ds()||Ve()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const o=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(o);for(let c=0;c<e.length;++c)e[c]=o[c]/128-1}const n=sl(e).call(e,(o,c)=>o+c*c,0)/e.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,n;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{M.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class Qw extends Dt{get processSourceNode(){return this.sourceNode}set processedNode(e){var n;if(!this.isDestroyed&&this._processedNode!==e){try{var o;(o=this.sourceNode)===null||o===void 0||o.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),D(this,"outputNode",void 0),D(this,"outputTrack",void 0),D(this,"isPlayed",!1),D(this,"context",void 0),D(this,"audioBufferNode",void 0),D(this,"destNode",void 0),D(this,"audioOutputLevel",0),D(this,"volumeLevelAnalyser",void 0),D(this,"_processedNode",void 0),D(this,"playNode",void 0),D(this,"isDestroyed",!1),D(this,"onNoAudioInput",void 0),D(this,"isNoAudioInput",!1),D(this,"_noAudioInputCount",0),this.context=Hp(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Js(this.outputNode),this.volumeLevelAnalyser=new Kp}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(_o.ON_AUDIO_BUFFER,function(o){for(let c=0;c<o.outputBuffer.numberOfChannels;c+=1){const u=o.outputBuffer.getChannelData(c);for(let m=0;m<u.length;m+=1)u[m]=0}return o.inputBuffer}(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Dn().webAudioMediaStreamDest)throw new ke(Q.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&Np(()=>{tn.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Ds()||Ve()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let o;n.getFloatTimeDomainData?(o=new Float32Array(n.fftSize),n.getFloatTimeDomainData(o)):(o=new Uint8Array(n.fftSize),n.getByteTimeDomainData(o));let c=!1;for(let u=0;u<o.length;u++)o[u]!==0&&(c=!0);return c?(this.isNoAudioInput=!1,!0):(await Br(200),await this.checkHasAudioInput(e?e+1:1)&&c)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,n;(e=this.processedNode)===null||e===void 0||e.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class vh extends Qw{get isFreeze(){return!1}constructor(e,n,o){var c;if(super(),D(this,"sourceNode",void 0),D(this,"track",void 0),D(this,"clonedTrack",void 0),D(this,"audioElement",void 0),D(this,"isCurrentTrackCloned",!1),D(this,"isRemoteTrack",!1),D(this,"originVolumeLevelAnalyser",void 0),D(this,"rebuildWebAudio",async()=>{if(M.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void M.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>M.info("resume success")),M.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const _=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?_.stop():this.isCurrentTrackCloned=!0;const S=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(S),Js(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const C=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(C,this.context.currentTime),Js(this.outputNode),this.emit(_o.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=S,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new ke(Q.UNEXPECTED_ERROR);this.track=e;const u=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(u),Js(this.sourceNode),o){const _=o.clone();_.enabled=!0,this.clonedTrack=_,M.debug("create an unmuted track ".concat(_.id," from the original track ").concat(o.id," to get the volume"));const S=this.context.createMediaStreamSource(new MediaStream([_]));Js(S),this.originVolumeLevelAnalyser=new Kp,this.originVolumeLevelAnalyser.updateSource(S)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=u;const m=qt();n&&m.os===ar.IOS&&Number((c=m.osVersion)===null||c===void 0?void 0:c.split(".")[0])<15&&(tn.on(Nr.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(_=>{_||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const n=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(n),Js(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(_o.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),tn.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const n=e.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),M.debug("create an unmuted track ".concat(n.id," from the original track ").concat(e.id," to get the volume"));const o=this.context.createMediaStreamSource(new MediaStream([n]));Js(o),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(o)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function gC(r,e,n){const o=(u,m)=>u?typeof u!="number"?u.max||u.exact||u.ideal||u.min||m:u:m,c={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxHeight:o(e.height,1080),maxWidth:o(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(c.video.mandatory.maxFrameRate=e.frameRate.max,c.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(c.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(c)}async function Zw(r,e){const n=await $w(r.mediaSource),{sourceId:o,audio:c}=await function(u){let m=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Ee((_,S)=>{const C=document.createElement("div");C.innerText="share screen",C.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const R=document.createElement("div");R.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const w=document.createElement("div");w.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",w.setAttribute("style","height: 12%;");const N=document.createElement("div");N.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const L=document.createElement("div");L.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const H=document.createElement("button");H.innerHTML="cancel",H.setAttribute("style","width: 85px;"),H.onclick=()=>{document.body.removeChild(ee);const re=new Error("NotAllowedError");re.name="NotAllowedError",S(re)};let j=m;const W=document.createElement("div");if(m){const re=document.createElement("input");re.setAttribute("type","checkbox");const fe=document.createElement("span");re.setAttribute("style","margin-right: 6px;"),fe.innerText="Share audio",re.checked=j,re.onchange=()=>{j=re.checked},W.appendChild(re),W.appendChild(fe)}L.appendChild(W),L.appendChild(H),R.appendChild(w),R.appendChild(N),R.appendChild(L);const ee=document.createElement("div");ee.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),ee.appendChild(C),ee.appendChild(R),document.body.appendChild(ee),u.map(re=>{if(re.id){const fe=document.createElement("div");fe.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let be=re.thumbnail;try{const{width:_e}=be.getSize();_e>1920&&(be=be.resize({width:1920}))}catch(_e){throw _e&&_e.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),_e}fe.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+be.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+re.name.replace(/[\u00A0-\u9999<>\&]/g,function(_e){return"&#"+_e.charCodeAt(0)+";"})+"</span>",fe.onclick=()=>{document.body.removeChild(ee),_({sourceId:re.id,audio:j})},N.appendChild(fe)}})})}(n,e);return await gC(o,r,c)}async function $w(r){let e=["window","screen"];r!=="application"&&r!=="window"||(e=["window"]),r==="screen"&&(e=["screen"]);const n=Ws();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new ke(Q.ELECTRON_IS_NULL);let o=null;try{var c;o=((c=n.desktopCapturer)===null||c===void 0?void 0:c.getSources({types:e}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{o=null}o&&o.then||(o=new Ee((u,m)=>{n.desktopCapturer.getSources({types:e},(_,S)=>{_?m(_):u(S)})}));try{return await o}catch(u){throw new ke(Q.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,u.toString())}}function eb(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}const Ig=new Zr("safari");let tb=!1,PP=!1;async function fa(r,e){let n=0,o=null;for(;n<2;)try{o=await kP(r,e,n>0);break}catch(c){if(c instanceof ke)throw M.error("[".concat(e,"] ").concat(c.toString())),c;const u=_f(c.name||c.code||c,c.message);if(u.code===Q.MEDIA_OPTION_INVALID){M.debug("[".concat(e,"] detect media option invalid, retry")),n+=1,await Br(500);continue}throw M.error("[".concat(e,"] ").concat(u.toString())),u}if(!o)throw new ke(Q.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return o}async function kP(r,e,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new ke(Q.NOT_SUPPORTED,"can not find getUserMedia");n&&(r.video&&(delete r.video.width,delete r.video.height),r.screen&&(delete r.screen.width,delete r.screen.height));const o=Dn(),c=new MediaStream;if(r.audioSource&&c.addTrack(r.audioSource),r.videoSource&&c.addTrack(r.videoSource),!r.audio&&!r.video&&!r.screen)return M.debug("Using Video Source/ Audio Source"),c;if(r.screen)if(Ws())r.screen.sourceId?Yp(c,await gC(r.screen.sourceId,r.screen,r.screenAudio)):Yp(c,await Zw(r.screen,r.screenAudio));else if(tl()&&r.screen.extensionId&&r.screen.mandatory){if(!o.getStreamFromExtension)throw new ke(Q.NOT_SUPPORTED,"This browser does not support screen sharing");M.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const N=await(m=r.screen.extensionId,_=e,new Ee((L,H)=>{try{chrome.runtime.sendMessage(m,{getStream:!0},j=>{if(!j||!j.streamId)return M.error("[".concat(_,"] No response from Chrome Plugin. Plugin not installed properly"),j),void H(new ke(Q.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));L(j.streamId)})}catch(j){M.error("[".concat(_,"] AgoraRTC screensharing plugin is not accessible(").concat(m,")"),j.toString()),H(new ke(Q.CHROME_PLUGIN_NOT_INSTALL))}}));r.screen.mandatory.chromeMediaSourceId=N,Yp(c,await navigator.mediaDevices.getUserMedia({video:{mandatory:r.screen.mandatory}}))}else if(o.getDisplayMedia){var u;r.screen.mediaSource&&mC(r.screen.mediaSource);const N={width:r.screen.width,height:r.screen.height,frameRate:r.screen.frameRate,displaySurface:(u=r.screen.displaySurface)!==null&&u!==void 0?u:r.screen.mediaSource==="screen"?"monitor":r.screen.mediaSource},{selfBrowserSurface:L,surfaceSwitching:H,systemAudio:j}=r.screen,W={selfBrowserSurface:L,surfaceSwitching:H,systemAudio:j};!L&&delete W.selfBrowserSurface,!H&&delete W.surfaceSwitching,!j&&delete W.systemAudio,M.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:N,audio:!!r.screenAudio,controls:W}));const ee=await navigator.mediaDevices.getDisplayMedia(function(re){for(var fe=1;fe<arguments.length;fe++){var be=arguments[fe]!=null?arguments[fe]:{};fe%2?eb(Object(be),!0).forEach(function(_e){D(re,_e,be[_e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(re,Object.getOwnPropertyDescriptors(be)):eb(Object(be)).forEach(function(_e){Object.defineProperty(re,_e,Object.getOwnPropertyDescriptor(be,_e))})}return re}({video:N,audio:!!r.screenAudio},W));Yp(c,ee)}else{if(!Ln())throw M.error("[".concat(e,"] This browser does not support screenSharing")),new ke(Q.NOT_SUPPORTED,"This browser does not support screen sharing");{r.screen.mediaSource&&mC(r.screen.mediaSource);const N={video:{mediaSource:r.screen.mediaSource,width:r.screen.width,height:r.screen.height,frameRate:r.screen.frameRate}};M.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(N))),Yp(c,await navigator.mediaDevices.getUserMedia(N))}}var m,_;if(!r.video&&!r.audio)return c;let S={video:r.video,audio:r.audio},C=oe("MEDIA_DEVICE_CONSTRAINTS");if(C)try{typeof C=="string"&&(C=JSON.parse(C)),S=tg(S,C)}catch{}M.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(S)),qt();let R,w=null;(Jr()||Ds()||Xm())&&(w=await Ig.lock());try{R=await navigator.mediaDevices.getUserMedia(S)}catch(N){throw w&&w(),N}return S.audio&&(tb=!0),S.video&&(PP=!0),Yp(c,R),w&&w(),c}function _f(r,e){switch(r){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new ke(Q.MEDIA_OPTION_INVALID,"".concat(r,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new ke(Q.DEVICE_NOT_FOUND,"".concat(r,": ").concat(e));case"NotSupportedError":return new ke(Q.NOT_SUPPORTED,"".concat(r,": ").concat(e));case"NotReadableError":return new ke(Q.NOT_READABLE,"".concat(r,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new ke(Q.PERMISSION_DENIED,"".concat(r,": ").concat(e));case"ConstraintNotSatisfiedError":return new ke(Q.CONSTRAINT_NOT_SATISFIED,"".concat(r,": ").concat(e));default:return M.error("getUserMedia unexpected error",r),new ke(Q.UNEXPECTED_ERROR,"".concat(r,": ").concat(e))}}function Yp(r,e){const n=r.getVideoTracks()[0],o=r.getAudioTracks()[0],c=e.getVideoTracks()[0],u=e.getAudioTracks()[0];u&&(o&&r.removeTrack(o),r.addTrack(u)),c&&(n&&r.removeTrack(n),r.addTrack(c))}const _a=new class extends Dt{get state(){return this._state}set state(r){r!==this._state&&(this.emit(uu.STATE_CHANGE,r),this._state=r)}constructor(){super(),D(this,"_state",Ch.IDLE),D(this,"isAccessMicrophonePermission",!1),D(this,"isAccessCameraPermission",!1),D(this,"lastAccessMicrophonePermission",!1),D(this,"lastAccessCameraPermission",!1),D(this,"checkdeviceMatched",!1),D(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(oe("ENUMERATE_DEVICES_INTERVAL")||(Qm()||Hn()===ar.HARMONY_OS)&&bn())&&this.updateDevicesInfo()},oe("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(r=>M.error(r.toString()))}async enumerateDevices(r,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new ke(Q.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const o=await navigator.mediaDevices.enumerateDevices(),c=this.checkMediaDeviceInfoIsOk(o);let u=!this.isAccessMicrophonePermission&&r,m=!this.isAccessCameraPermission&&e;c.audio&&(u=!1),c.video&&(m=!1);let _=null,S=null,C=null;if(!n&&(u||m)){if(Ig.isLocked&&(M.debug("[device manager] wait GUM lock"),(await Ig.lock())(),M.debug("[device manager] GUM unlock")),tb&&(u=!1,this.isAccessMicrophonePermission=!0),PP&&(m=!1,this.isAccessCameraPermission=!0),M.debug("[device manager] check media device permissions",r,e,u,m),u&&m){try{C=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(R){const w=_f(R.name||R.code||R,R.message);if(w.code===Q.PERMISSION_DENIED)throw w;M.warning("getUserMedia failed in getDevices",w)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(u){try{_=await navigator.mediaDevices.getUserMedia({audio:r})}catch(R){const w=_f(R.name||R.code||R,R.message);if(w.code===Q.PERMISSION_DENIED)throw w;M.warning("getUserMedia failed in getDevices",w)}this.isAccessMicrophonePermission=!0}else if(m){try{S=await navigator.mediaDevices.getUserMedia({video:e})}catch(R){const w=_f(R.name||R.code||R,R.message);if(w.code===Q.PERMISSION_DENIED)throw w;M.warning("getUserMedia failed in getDevices",w)}this.isAccessCameraPermission=!0}M.debug("[device manager] mic permission",r,"cam permission",e)}try{const R=await navigator.mediaDevices.enumerateDevices();return _&&_.getTracks().forEach(w=>w.stop()),S&&S.getTracks().forEach(w=>w.stop()),C&&C.getTracks().forEach(w=>w.stop()),_=null,S=null,C=null,R}catch(R){return _&&_.getTracks().forEach(w=>w.stop()),S&&S.getTracks().forEach(w=>w.stop()),C&&C.getTracks().forEach(w=>w.stop()),_=null,S=null,C=null,new ke(Q.ENUMERATE_DEVICES_FAILED,R.toString()).throw()}}async getRecordingDevices(){let r=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,r)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let r=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,r)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let r=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,r)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(r){let e=null;return this.deviceInfoMap.forEach(n=>{n.device.label===r&&(e=n.device.deviceId)}),e}async getDeviceById(r){const e=(await this.enumerateDevices(!0,!0,!0)).find(n=>n.deviceId===r);if(!e)throw new ke(Q.DEVICE_NOT_FOUND,"deviceId: ".concat(r));return e}async init(){this.state=Ch.INITING;try{await this.updateDevicesInfo(),this.state=Ch.INITEND}catch(r){throw M.warning("Device Detection functionality cannot start properly.",r.toString()),this.state=Ch.IDLE,!(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")&&new ke(Q.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),r}}async updateDevicesInfo(){const r=await this.enumerateDevices(!0,!0,!0),e=Date.now(),n=[];if(r[0]&&r[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const c=r.find(m=>m.kind==="audioinput"&&m.deviceId==="default"),u=r.find(m=>m.kind==="audiooutput"&&m.deviceId==="default");c&&u?u.groupId===c.groupId?M.debug("[device-check] default input ".concat(c.label," and output ").concat(u.label," is the same group")):M.warning("[device-check] default input ".concat(c.label," and output ").concat(u.label," is not the same group")):M.debug("[device-check] default input or output not found")}const o=this.checkMediaDeviceInfoIsOk(r);if(r.forEach(c=>{if(!c.deviceId)return;const u=this.deviceInfoMap.get("".concat(c.kind,"_").concat(c.deviceId));if((u?u.state:"INACTIVE")!=="ACTIVE"){const m={initAt:e,updateAt:e,device:c,state:"ACTIVE"};this.deviceInfoMap.set("".concat(c.kind,"_").concat(c.deviceId),m),n.push(m)}u&&(u.updateAt=e)}),this.deviceInfoMap.forEach((c,u)=>{c.state==="ACTIVE"&&c.updateAt!==e&&(c.state="INACTIVE",n.push(c))}),this.state!==Ch.INITEND)return o.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(o.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach(c=>{switch(c.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(uu.RECORDING_DEVICE_CHANGED,c);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(uu.CAMERA_DEVICE_CHANGED,c);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(uu.PLAYOUT_DEVICE_CHANGED,c)}}),o.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),o.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(r){const e=r.filter(c=>c.kind==="audioinput"),n=r.filter(c=>c.kind==="videoinput"),o={audio:!1,video:!1};for(const c of e)if(c.label&&c.deviceId){o.audio=!0;break}for(const c of n)if(c.label&&c.deviceId){o.video=!0;break}return o}};let Xo=!1;const Va=new class extends Dt{constructor(){super(...arguments),D(this,"onAutoplayFailed",void 0),D(this,"onAudioAutoplayFailed",void 0)}};function Ag(){if(qt(),!Xo){const r=e=>{e.preventDefault(),Xo=!1,jr()?document.body.removeEventListener("click",r,!0):(document.body.removeEventListener("touchstart",r,!0),document.body.removeEventListener("mousedown",r,!0))};Xo=!0,jr()?document.body.addEventListener("click",r,!0):(document.body.addEventListener("touchstart",r,!0),document.body.addEventListener("mousedown",r,!0)),M.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Va.onAutoplayFailed?Va.onAutoplayFailed():Va.onAudioAutoplayFailed?M.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):M.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Va.emit("autoplay-failed")}}function zp(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Ea(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?zp(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):zp(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function SC(r,e,n,o){if(!r)return;const c=vt.getBaseInfoBySessionId(r);if(!c)return;const u=c.info,m=Date.now(),_=Ea(Ea({},u),{},{vid:u.vid===void 0?0:Number(u.vid),lts:m,elapse:m-c.startTime,cbRegistered:Va.onAutoplayFailed||Va.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:e,trackId:o,extend:void 0});vt.send({type:pi.AUTOPLAY_FAILED,data:_},!0)}const Fa=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],So=new class{constructor(){D(this,"onAutoplayFailed",void 0),D(this,"elementMap",new Map),D(this,"elementStateMap",new Map),D(this,"elementsNeedToResume",[]),D(this,"sinkIdMap",new Map),D(this,"autoResumeAfterInterruption",r=>{Array.from(this.elementMap.entries()).forEach(e=>{let[n,o]=e;const c=this.elementStateMap.get(n),u=o.srcObject.getAudioTracks()[0],m=u&&u.readyState;if(M.debug("resume after interrupted, ele: ".concat(c," audio: ").concat(m," ").concat(r)),m==="live"){if(r)return o.pause(),void o.play();if(tn.curState==="running")return Zl()?(o.pause(),void o.play()):void(c&&c==="paused"&&o.play())}})}),D(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(r=>{let[e,n]=r;const o=n.srcObject.getAudioTracks()[0];o&&o.readyState==="live"&&(M.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())})}),this.autoResumeAudioElement(),tn.on(Nr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),tn.on(Nr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),tn.on(Nr.STATE_CHANGE,()=>{Ds()&&tn.prevState==="suspended"&&tn.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(r,e){const n=this.elementMap.get(r);if(this.sinkIdMap.set(r,e),n)try{await n.setSinkId(e)}catch(o){throw new ke(Q.PERMISSION_DENIED,"can not set sink id: "+o.toString())}}play(r,e,n,o){if(this.elementMap.has(e))return;const c=document.createElement("audio");c.autoplay=!0,c.srcObject=new MediaStream([r]),this.bindAudioElementEvents(e,c),this.elementMap.set(e,c),this.elementStateMap.set(e,ks.INIT),this.setVolume(e,n);const u=this.sinkIdMap.get(e);if(u)try{c.setSinkId(u).catch(_=>{M.warning("[".concat(e,"] set sink id failed"),_.toString())})}catch(_){M.warning("[".concat(e,"] set sink id failed"),_.toString())}const m=c.play();m&&m.then&&m.catch(_=>{o&&SC(o,"audio",_.message,e),M.warning("audio element play warning",_.toString()),this.elementMap.has(e)&&_.name==="NotAllowedError"&&(M.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(c),Np(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),Ag()}))})}updateTrack(r,e){const n=this.elementMap.get(r);n&&(n.srcObject=new MediaStream([e]))}isPlaying(r){return this.elementMap.has(r)&&this.elementStateMap.get(r)==="playing"}setVolume(r,e){const n=this.elementMap.get(r);n&&(e=Math.max(0,Math.min(100,e)),n.volume=e/100)}stop(r){const e=this.elementMap.get(r);if(this.sinkIdMap.delete(r),!e)return;const n=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(n,1),e.srcObject=null,e.remove(),this.elementMap.delete(r),this.elementStateMap.delete(r)}bindAudioElementEvents(r,e){Fa.forEach(n=>{e.addEventListener(n,o=>{const c=this.elementStateMap.get(r),u=o.type==="pause"?"paused":o.type;if(M.debug("[".concat(r,"] audio-element-status change ").concat(c," => ").concat(u)),o.type==="error"){const m=e==null?void 0:e.error;m&&M.error("[".concat(r,"] media error, code: ").concat(m.code,", message: ").concat(m.message))}this.elementStateMap.set(r,u)})})}getPlayerState(r){return this.elementStateMap.get(r)||"uninit"}autoResumeAudioElement(){const r=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(n=>{M.debug("Auto resume audio element success")}).catch(n=>{M.warning("Auto resume audio element failed!",n)})}),this.elementsNeedToResume=[]};new Ee(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{jr()?document.body.addEventListener("click",r,!0):(document.body.addEventListener("touchstart",r,!0),document.body.addEventListener("mousedown",r,!0))})}};function er(){return function(r,e,n){const o=n.value;return typeof o=="function"&&(n.value=function(){this._isClosed&&new ke(Q.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",M);for(var c=arguments.length,u=new Array(c),m=0;m<c;m++)u[m]=arguments[m];const _=o.apply(this,u);return _ instanceof Ee?new Ee((S,C)=>{_.then(S).catch(C)}):_}),n}}function nb(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function wg(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?nb(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):nb(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class LP extends Dt{constructor(e){super(),D(this,"name","VideoProcessorDestination"),D(this,"ID","0"),D(this,"_source",void 0),D(this,"videoContext",void 0),D(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new ke(Q.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new ke(Q.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(ys.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(ys.ON_TRACK,void 0)}}class Po extends Dt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n){super(),D(this,"constraintsMap",new Map),D(this,"statsRegistry",[]),D(this,"usageRegistry",[]),D(this,"trackId",void 0),D(this,"direction",void 0),D(this,"_chained",!1),this.trackId=e,this.direction=n}async getConstraints(){return await Ji(this,Eo.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,n){var o;return M.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Mn(this,Eo.REQUEST_UPDATE_CONSTRAINTS,Array.from(wd(o=this.constraintsMap).call(o)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return M.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Mn(this,Eo.REQUEST_UPDATE_CONSTRAINTS,Array.from(wd(n=this.constraintsMap).call(n)))}registerStats(e,n,o){this.statsRegistry.find(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:o})}unregisterStats(e,n){const o=this.statsRegistry.findIndex(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===n);o!==-1&&this.statsRegistry.splice(o,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:o,type:c,cb:u}of this.statsRegistry)try{const m=u();e.push({processorID:n,processorName:o,type:c,stats:m})}catch(m){M.error(new ke(Q.UNEXPECTED_ERROR,m.message))}return e}registerUsage(e,n){this.usageRegistry.find(o=>o.processorID===e.ID&&o.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(o=>o.processorID===e.ID&&o.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let o=n();o instanceof Ee&&(o=await o),e.push(wg(wg({},o),{},{direction:this.direction}))}catch(o){M.error("gather extension usage error",o)}return e}getDirection(){return this.direction}}class tr extends Dt{constructor(e){super(),D(this,"name","AudioProcessorDestination"),D(this,"ID","0"),D(this,"inputTrack",void 0),D(this,"inputNode",void 0),D(this,"audioProcessorContext",void 0),D(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new ke(Q.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new ke(Q.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(ys.ON_TRACK,void 0),this.emit(ys.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(ys.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(ys.ON_NODE,this.inputNode))}}class ib extends Dt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n,o){super(),D(this,"constraintsMap",new Map),D(this,"statsRegistry",[]),D(this,"audioContext",void 0),D(this,"trackId",void 0),D(this,"direction",void 0),D(this,"usageRegistry",[]),D(this,"_chained",!1),this.audioContext=e,this.trackId=n,this.direction=o}async getConstraints(){return Ji(this,Eo.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,n){var o;return M.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Mn(this,Eo.REQUEST_UPDATE_CONSTRAINTS,Array.from(wd(o=this.constraintsMap).call(o)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Mn(this,Eo.REQUEST_UPDATE_CONSTRAINTS,Array.from(wd(n=this.constraintsMap).call(n)))}registerStats(e,n,o){this.statsRegistry.find(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:o})}unregisterStats(e,n){const o=this.statsRegistry.findIndex(c=>c.processorID===e.ID&&c.processorName===e.name&&c.type===n);o!==-1&&this.statsRegistry.splice(o,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:o,type:c,cb:u}of this.statsRegistry)try{const m=u();e.push({processorID:n,processorName:o,type:c,stats:m})}catch(m){M.error(new ke(Q.UNEXPECTED_ERROR,m.message))}return e}registerUsage(e,n){this.usageRegistry.find(o=>o.processorID===e.ID&&o.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(o=>o.processorID===e.ID&&o.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let o=n();o instanceof Ee&&(o=await o),e.push(wg(wg({},o),{},{direction:this.direction}))}catch(o){M.error("gather extension usage error",o)}return e}getDirection(){return this.direction}}class Ef extends Dt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),D(this,"context",void 0),D(this,"processSourceNode",void 0),D(this,"outputTrack",void 0),D(this,"processedNode",void 0),D(this,"clonedTrack",void 0),D(this,"outputNode",void 0),this.outputNode=new MP}setVolume(){}createOutputTrack(){throw new ke(Q.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class MP{disconnect(){}connect(){}}function rb(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function gf(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?rb(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):rb(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class xn extends di{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?So.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,n,o,c){super(e,o),D(this,"trackMediaType","audio"),D(this,"_encoderConfig",void 0),D(this,"_trackSource",void 0),D(this,"_enabled",!0),D(this,"_volume",100),D(this,"_useAudioElement",!0),D(this,"_bypassWebAudio",!1),D(this,"processor",void 0),D(this,"_processorContext",void 0),D(this,"_processorDestination",void 0),D(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=n,this._getOriginVolumeLevel=!!c,this._trackSource=new Ef,oe("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),oe("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Jr()&&!ma?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(e){Jn(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&So.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void M.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const n=this._source.createOutputTrack();this._mediaStreamTrack!==n&&(this._mediaStreamTrack=n,Mn(this,ht.NEED_REPLACE_TRACK,this).then(()=>{M.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(o=>{M.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),o)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!tl()&&oe("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new ke(Q.NOT_SUPPORTED,"your browser does not support setting the audio output device");await So.setSinkID(this.getTrackId(),e)}async setEnabled(e,n,o){return this._setEnabled(e,n,o)}async _setEnabled(e,n,o){if(!o){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(M.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{o||(this._enabled=!0),await Mn(this,ht.NEED_ENABLE_TRACK,this),M.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(c){throw o||(this._enabled=!1),M.error("[".concat(this.getTrackId(),"] setEnabled to true error"),c.toString()),c}}else{this._originMediaStreamTrack.enabled=!1,o||(this._enabled=!1);try{await Mn(this,ht.NEED_DISABLE_TRACK,this)}catch(c){throw o||(this._enabled=!0),M.error("[".concat(this.getTrackId(),"] setEnabled to false error"),c.toString()),c}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,M.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Mn(this,ht.NEED_MUTE_TRACK,this):await Mn(this,ht.NEED_UNMUTE_TRACK,this))}getStats(){return eu(()=>{M.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),mo(this,ht.GET_STATS)||gf({},Sh)}setAudioFrameCallback(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(_o.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(n),this._source.removeAllListeners(_o.ON_AUDIO_BUFFER),this._source.on(_o.ON_AUDIO_BUFFER,o=>e(o))}play(){M.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(M.debug("[".concat(this.getTrackId(),"] start audio playback in element")),So.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){M.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?So.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];M.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&So.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,n){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mn(this,ht.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return Ee.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new ke(Q.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new ke(Q.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const n=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,n.reset()}bindProcessorDestinationEvents(e){e.on(ys.ON_TRACK,async n=>{n?n!==this._mediaStreamTrack&&(this._mediaStreamTrack=n,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(n),await Mn(this,ht.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mn(this,ht.NEED_REPLACE_TRACK,this))}),e.on(ys.ON_NODE,n=>{this._source.processedNode=n})}unbindProcessorDestinationEvents(e){e.removeAllListeners(ys.ON_TRACK),e.removeAllListeners(ys.ON_NODE)}bindProcessorContextEvents(e){e.on(Eo.REQUEST_CONSTRAINTS,async n=>{n(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(e){e.removeAllListeners(Eo.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof Ef&&(this._trackSource=new vh(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new ib(this._source.context,this.getTrackId(),"local"),n=new tr(e);return this._processorContext=e,this._processorDestination=n,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(n),this._source.on(_o.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(So.stop(this.getTrackId()),this._source.play()),Mn(this,ht.NEED_REPLACE_MIXING_TRACK,this).then(()=>{M.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(o=>{M.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),o)})),{processorContext:e,processorDestination:n}}}Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e],throttleTime:300}),z("design:type",Function),z("design:paramtypes",[Number]),z("design:returntype",void 0)],xn.prototype,"setVolume",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],xn.prototype,"setPlaybackDevice",null),Ge([ah("LocalAudioTrack","_enabledMutex"),Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Boolean,Object,Boolean]),z("design:returntype",Ee)],xn.prototype,"setEnabled",null),Ge([ah("LocalAudioTrack","_enabledMutex"),Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Boolean]),z("design:returntype",Ee)],xn.prototype,"setMuted",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Object)],xn.prototype,"getStats",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[Object,Number]),z("design:returntype",void 0)],xn.prototype,"setAudioFrameCallback",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],xn.prototype,"play",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],xn.prototype,"stop",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],xn.prototype,"close",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e.name]}),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Object)],xn.prototype,"pipe",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],xn.prototype,"unpipe",null);class hu extends xn{get __className__(){return"MicrophoneAudioTrack"}constructor(e,n,o,c){super(e,n.encoderConfig?pC(n.encoderConfig):{},c,oe("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),D(this,"_config",void 0),D(this,"_deviceName","default"),D(this,"_constraints",void 0),D(this,"_originalConstraints",void 0),D(this,"_enabled",!0),this._config=n,this._constraints=o,this._originalConstraints=o,this._deviceName=e.label,typeof n.bypassWebAudio=="boolean"&&(this._bypassWebAudio=n.bypassWebAudio),(Zl()||Op())&&tn.bindInterruptDetectorTrack(this)}async setDevice(e){if(M.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const n=await _a.getDeviceById(e),o={};o.audio=gf({},this._constraints),o.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let c=null;try{c=await fa(o,this.getTrackId())}catch(u){throw M.error("[".concat(this.getTrackId(),"] setDevice failed"),u.toString()),c=await fa({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(c.getAudioTracks()[0],!1),u}await this._updateOriginMediaStreamTrack(c.getAudioTracks()[0],!1),this._deviceName=n.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(n){throw M.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await _a.getDeviceById(e);this._deviceName=n.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(n){throw M.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}M.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,n,o){if(n)return M.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!o){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(M.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){var c;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(c=this._source.clonedTrack)===null||c===void 0||c.stop(),o||(this._enabled=!1);try{await Mn(this,ht.NEED_DISABLE_TRACK,this)}catch(_){throw M.error("[".concat(this.getTrackId(),"] setEnabled false failed"),_.toString()),_}return}const u=gf({},this._constraints),m=_a.searchDeviceIdByName(this._deviceName);m&&!u.deviceId&&(u.deviceId=m);try{o||(this._enabled=!0);const _=await fa({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(_.getAudioTracks()[0],!1),await Mn(this,ht.NEED_ENABLE_TRACK,this)}catch(_){throw o||(this._enabled=!1),M.error("[".concat(this.getTrackId(),"] setEnabled true failed"),_.toString()),_}M.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Zl()||Op())&&tn.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Ds()||Ve())&&this._enabled&&!this._isClosed&&tn.duringInterruption){const e=async()=>{tn.off(Nr.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(M.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};tn.on(Nr.IOS_INTERRUPTION_END,e)}else M.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Un.TRACK_ENDED)}async renewMediaStreamTrack(e){const n=e||this._constraints,o=_a.searchDeviceIdByName(this._deviceName);if(o&&!n.deviceId&&(n.deviceId=o),this._constraints=n,this._enabled){this._originMediaStreamTrack.stop();const c=await fa({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(c.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(Eo.REQUEST_UPDATE_CONSTRAINTS,async(n,o,c)=>{try{const u=Object.assign({},this._originalConstraints,...n);await this.renewMediaStreamTrack(u),o()}catch(u){c(u)}})}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(Eo.REQUEST_UPDATE_CONSTRAINTS)}}Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],hu.prototype,"setDevice",null),Ge([ah("MicrophoneAudioTrack","_enabledMutex"),Lt({argsMap:(r,e,n)=>[r.getTrackId(),e,n]}),er(),z("design:type",Function),z("design:paramtypes",[Boolean,Boolean,Boolean]),z("design:returntype",Ee)],hu.prototype,"setEnabled",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],hu.prototype,"close",null);class Rh extends xn{get __className__(){return"BufferSourceAudioTrack"}constructor(e,n,o,c){super(n.createOutputTrack(),o,c),D(this,"source",void 0),D(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=n,this._bufferSource.on(_o.AUDIO_SOURCE_STATE_CHANGE,u=>{this.safeEmit(Un.SOURCE_STATE_CHANGE,u)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){Jn(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e,r.duration]}),er(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",void 0)],Rh.prototype,"startProcessAudioBuffer",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],Rh.prototype,"pauseProcessAudioBuffer",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),er(),z("design:type",Function),z("design:paramtypes",[Number]),z("design:returntype",void 0)],Rh.prototype,"seekAudioBuffer",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],Rh.prototype,"resumeProcessAudioBuffer",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],Rh.prototype,"stopProcessAudioBuffer",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],Rh.prototype,"close",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),er(),z("design:type",Function),z("design:paramtypes",[Number]),z("design:returntype",void 0)],Rh.prototype,"setAudioBufferPlaybackSpeed",null);class Yi extends xn{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Hp().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,oi(8,"track-mix-")),D(this,"trackList",void 0),D(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(M.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):M.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){M.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}ef(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(n=>{n instanceof Yi?n.emit(ut.TRANSCEIVER_UPDATED,e):n._updateRtpTransceiver(e)}))}}function TC(r){const e={};r.facingMode&&(e.facingMode=r.facingMode),r.cameraId&&(e.deviceId={exact:r.cameraId});const n=zc(r.encoderConfig);return n.width!=null&&(e.width=n.width),n.height!=null&&(e.height=n.height),!vr()&&n.frameRate&&(e.frameRate=n.frameRate),qt().name===Pn.EDGE&&typeof e.frameRate=="object"&&(e.frameRate.max=60),Ln()&&(e.frameRate={ideal:30,max:30}),e}function CC(r){const e={};if(vr()||(r.AGC!==void 0&&(e.autoGainControl=r.AGC),r.AEC!==void 0&&(e.echoCancellation=r.AEC),r.ANS!==void 0&&(e.noiseSuppression=r.ANS,tl()&&r.ANS&&(e.googHighpassFilter=r.ANS))),r.encoderConfig){const n=pC(r.encoderConfig);e.channelCount=n.stereo?2:1,e.sampleRate=n.sampleRate,e.sampleSize=n.sampleSize}return r.microphoneId&&(e.deviceId={exact:r.microphoneId}),Qm()&&(e.sampleRate=void 0),e}class UP extends Qw{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(_o.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),D(this,"audioBuffer",void 0),D(this,"sourceNode",void 0),D(this,"startPlayTime",0),D(this,"startPlayOffset",0),D(this,"pausePlayTime",0),D(this,"options",void 0),D(this,"currentLoopCount",0),D(this,"currentPlaybackSpeed",100),D(this,"_currentState","stopped"),this.audioBuffer=e,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):M.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const vC=new Map;async function Vn(r,e){let n=null;if(typeof r=="string"){const c=vC.get(r);if(c)return M.debug("use cached audio resource: ",r),c;try{n=(await dc(()=>no.get(r,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(u){throw new ke(Q.FETCH_AUDIO_FILE_FAILED,u.toString())}}else n=await new Ee((u,m)=>{const _=new FileReader;_.onload=S=>{S.target?u(S.target.result):m(new ke(Q.READ_LOCAL_AUDIO_FILE_ERROR))},_.onerror=()=>{m(new ke(Q.READ_LOCAL_AUDIO_FILE_ERROR))},_.readAsArrayBuffer(r)});const o=await function(c){const u=Hp();return new Ee((m,_)=>{u.decodeAudioData(c,S=>{m(S)},S=>{_(new ke(Q.DECODE_AUDIO_FILE_FAILED,S.toString()))})})}(n);return typeof r=="string"&&e&&vC.set(r,o),o}const pu=r=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new Ee((n,o)=>{e.toBlob(async c=>{if(e.remove(),c){const u=await mu(c);n({buffer:u,width:e.width,height:e.height})}else o(new ke(Q.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},r,1)})},mu=async r=>{const e=await r.arrayBuffer();return new Uint8Array(e)};function lr(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function bg(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?lr(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):lr(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class RC{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(M.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var n;e!==this._videoState&&(M.debug("[".concat(this.trackId,"] video-status change ").concat(this._videoState," => ").concat(e)),this._videoState=e,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(e){D(this,"trackId",void 0),D(this,"config",void 0),D(this,"onFirstVideoFrameDecoded",void 0),D(this,"onVideoStateChanged",void 0),D(this,"freezeTimeCounterList",[]),D(this,"renderFreezeAccTime",0),D(this,"isKeepLastFrame",!1),D(this,"timeUpdatedCount",0),D(this,"freezeTime",0),D(this,"playbackTime",0),D(this,"lastTimeUpdatedTime",0),D(this,"autoplayFailed",!1),D(this,"videoTrack",void 0),D(this,"videoElement",void 0),D(this,"cacheVideoElement",void 0),D(this,"_videoState",$i.VideoStateStopped),D(this,"videoElementCheckInterval",void 0),D(this,"videoElementFreezeTimeout",void 0),D(this,"_videoElementStatus",ks.NONE),D(this,"isGettingVideoDimensions",!1),D(this,"startGetVideoDimensions",()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return M.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()}),D(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&tn.curState==="running"&&(M.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Gs())),Z()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),D(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=ks.PLAYING;break;case"loadeddata":if(this.videoState=$i.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=ks.CANPLAY;break;case"stalled":this.videoElementStatus=ks.STALLED;break;case"suspend":this.videoElementStatus=ks.SUSPEND;break;case"pause":this.videoElementStatus=ks.PAUSED,Ds()||Ve()||Jr()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(M.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=ks.WAITING;break;case"abort":this.videoElementStatus=ks.ABORT;break;case"ended":this.videoElementStatus=ks.ENDED;break;case"emptied":this.videoElementStatus=ks.EMPTIED;break;case"error":{this.videoElementStatus=ks.ERROR;const o=this.videoElement.error;o&&M.error("[".concat(this.trackId,"] media error, code: ").concat(o.code,", message: ").concat(o.message));break}case"timeupdate":{const o=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=o);const c=o-this.lastTimeUpdatedTime,u=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=o,Qo.lastVisibleTime<Qo.lastHiddenTime||u<Qo.lastHiddenTime||u<Qo.lastVisibleTime)return;for(c>oe("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=c),this.playbackTime+=c;this.playbackTime>=6e3;){this.playbackTime-=6e3;const m=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(m),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),D(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(M.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Gs())),Z()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),tn.on(Nr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),tn.on(Nr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const n=this.videoElement.play();n&&n.catch&&n.catch(c=>{e&&SC(e,"video",c.message,this.trackId),c.name==="NotAllowedError"?(M.warning("detected video element autoplay failed",c),this.autoplayFailed=!0,this.handleAutoPlayFailed()):M.warning("[".concat(this.trackId,"] play warning: "),c)});const o=qt();if((o.name==="Safari"&&Number(o.version)===15||Zl())&&n&&n.then){const c=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(c).catch(c)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const n=e.getContext("2d");if(!n)return M.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,e.width,e.height);const o=n.getImageData(0,0,e.width,e.height);return e.remove(),o}async getCurrentFrameToUint8Array(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const o=document.createElement("canvas");o.width=this.videoElement.videoWidth,o.height=this.videoElement.videoHeight;const c=o.getContext("2d");return c?(c.drawImage(this.videoElement,0,0,o.width,o.height),new Ee((u,m)=>{o.toBlob(async _=>{if(o.remove(),_){const S=await mu(_);u({buffer:S,width:o.width,height:o.height})}else m(new ke(Q.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,n<0?.1:n>1?1:n)})):await pu(e)}destroy(){tn.off(Nr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),tn.off(Nr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=$i.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=ks.INIT,!this.videoElementCheckInterval&&(xP.forEach(u=>{this.videoElement.addEventListener(u,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(u){return u!==document.body&&document.body.contains(u)})(this.videoElement)||(this.videoElementStatus=ks.DESTROYED)},1e3),oe("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,n;let u;const m=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",m),this.videoElementFreezeTimeout=window.setTimeout(_,oe("VIDEO_FREEZE_DURATION")))},_=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===$i.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=$i.VideoStateFrozen:document.addEventListener("visibilitychange",m))},S=(C,R)=>{if(this.videoElementStatus===ks.PLAYING){if(u){const L=R.presentationTime-u.presentationTime;this.videoState===$i.VideoStateStarting&&(this.videoState=$i.VideoStateDecoding),this.videoState===$i.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(_,oe("VIDEO_FREEZE_DURATION"))),L<oe("VIDEO_FREEZE_DURATION")&&this.videoState===$i.VideoStateFrozen&&(this.videoState=$i.VideoStateDecoding),L>oe("VIDEO_FREEZE_DURATION")&&Qo.lastVisibleTime>=Qo.lastHiddenTime&&u.timestamp>Qo.lastVisibleTime&&u.timestamp>Qo.lastHiddenTime&&(this.renderFreezeAccTime+=L)}u=bg(bg({},R),{},{timestamp:C})}var w,N;oe("ENABLE_VIDEO_FRAME_CALLBACK")&&((w=(N=this.videoElement).requestVideoFrameCallback)===null||w===void 0||w.call(N,S))};(e=(n=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(n,S)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Qm()&&(this.videoElement.poster="noposter");const o=qt();o.name==="Safari"&&Number(o.version)===15||Zl()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ln()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Ln()&&this.videoElement.load());const c=this.videoElement.play();c!==void 0&&c.catch(u=>{M.debug("[".concat(this.trackId,"] playback interrupted"),u.toString())})}resetVideoElement(){xP.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=ks.NONE}handleAutoPlayFailed(){const e=n=>{n.preventDefault(),this.videoElement.play().then(()=>{M.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(o=>{M.error(o)}),this.autoplayFailed=!1,jr()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};jr()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Ag()}}const xP=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class sb extends RC{constructor(e){super(e),D(this,"container",void 0),D(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const n=e.element;n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var n;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,o):await pu(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",oe("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function VP(r){return new Ee((e,n)=>{let o=!1;const c=document.createElement("video");c.setAttribute("autoplay",""),c.setAttribute("muted",""),c.muted=!0,c.autoplay=!0,c.setAttribute("playsinline",""),c.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(c);const u=Ds()?"canplay":"playing";c.addEventListener(u,()=>{const m=c.videoWidth,_=c.videoHeight;!m&&Ln()||(o=!0,c.srcObject=null,c.remove(),e([m,_]))}),c.srcObject=new MediaStream([r]),c.play().catch(LT),setTimeout(()=>{o||(c.srcObject=null,c.remove(),e([c.videoWidth,c.videoHeight]))},4e3)})}const ob=async(r,e,n)=>{const o=function(m){const _=[];for(let S=0;S<m.length;S+=2)_.push(parseInt(m.slice(S,S+2),16));return Uint8Array.from(_)}(function(m){const _="0123456789abcdef";function S(et){let at,Zt="";for(at=0;at<=3;at++)Zt+=_.charAt(et>>8*at+4&15)+_.charAt(et>>8*at&15);return Zt}function C(et,at){const Zt=(65535&et)+(65535&at);return(et>>16)+(at>>16)+(Zt>>16)<<16|65535&Zt}function R(et,at,Zt,Sn,gi,Yr){return C(function(Mi,wc){return Mi<<wc|Mi>>>32-wc}(C(C(at,et),C(Sn,Yr)),gi),Zt)}function w(et,at,Zt,Sn,gi,Yr,Mi){return R(at&Zt|~at&Sn,et,at,gi,Yr,Mi)}function N(et,at,Zt,Sn,gi,Yr,Mi){return R(at&Sn|Zt&~Sn,et,at,gi,Yr,Mi)}function L(et,at,Zt,Sn,gi,Yr,Mi){return R(at^Zt^Sn,et,at,gi,Yr,Mi)}function H(et,at,Zt,Sn,gi,Yr,Mi){return R(Zt^(at|~Sn),et,at,gi,Yr,Mi)}const j=function(et){let at;const Zt=1+(et.length+8>>6),Sn=new Array(16*Zt);for(at=0;at<16*Zt;at++)Sn[at]=0;for(at=0;at<et.length;at++)Sn[at>>2]|=et.charCodeAt(at)<<at%4*8;return Sn[at>>2]|=128<<at%4*8,Sn[16*Zt-2]=8*et.length,Sn}(m);let W,ee,re,fe,be,_e=1732584193,ye=-271733879,Le=-1732584194,Me=271733878;for(W=0;W<j.length;W+=16)ee=_e,re=ye,fe=Le,be=Me,_e=w(_e,ye,Le,Me,j[W+0],7,-680876936),Me=w(Me,_e,ye,Le,j[W+1],12,-389564586),Le=w(Le,Me,_e,ye,j[W+2],17,606105819),ye=w(ye,Le,Me,_e,j[W+3],22,-1044525330),_e=w(_e,ye,Le,Me,j[W+4],7,-176418897),Me=w(Me,_e,ye,Le,j[W+5],12,1200080426),Le=w(Le,Me,_e,ye,j[W+6],17,-1473231341),ye=w(ye,Le,Me,_e,j[W+7],22,-45705983),_e=w(_e,ye,Le,Me,j[W+8],7,1770035416),Me=w(Me,_e,ye,Le,j[W+9],12,-1958414417),Le=w(Le,Me,_e,ye,j[W+10],17,-42063),ye=w(ye,Le,Me,_e,j[W+11],22,-1990404162),_e=w(_e,ye,Le,Me,j[W+12],7,1804603682),Me=w(Me,_e,ye,Le,j[W+13],12,-40341101),Le=w(Le,Me,_e,ye,j[W+14],17,-1502002290),ye=w(ye,Le,Me,_e,j[W+15],22,1236535329),_e=N(_e,ye,Le,Me,j[W+1],5,-165796510),Me=N(Me,_e,ye,Le,j[W+6],9,-1069501632),Le=N(Le,Me,_e,ye,j[W+11],14,643717713),ye=N(ye,Le,Me,_e,j[W+0],20,-373897302),_e=N(_e,ye,Le,Me,j[W+5],5,-701558691),Me=N(Me,_e,ye,Le,j[W+10],9,38016083),Le=N(Le,Me,_e,ye,j[W+15],14,-660478335),ye=N(ye,Le,Me,_e,j[W+4],20,-405537848),_e=N(_e,ye,Le,Me,j[W+9],5,568446438),Me=N(Me,_e,ye,Le,j[W+14],9,-1019803690),Le=N(Le,Me,_e,ye,j[W+3],14,-187363961),ye=N(ye,Le,Me,_e,j[W+8],20,1163531501),_e=N(_e,ye,Le,Me,j[W+13],5,-1444681467),Me=N(Me,_e,ye,Le,j[W+2],9,-51403784),Le=N(Le,Me,_e,ye,j[W+7],14,1735328473),ye=N(ye,Le,Me,_e,j[W+12],20,-1926607734),_e=L(_e,ye,Le,Me,j[W+5],4,-378558),Me=L(Me,_e,ye,Le,j[W+8],11,-2022574463),Le=L(Le,Me,_e,ye,j[W+11],16,1839030562),ye=L(ye,Le,Me,_e,j[W+14],23,-35309556),_e=L(_e,ye,Le,Me,j[W+1],4,-1530992060),Me=L(Me,_e,ye,Le,j[W+4],11,1272893353),Le=L(Le,Me,_e,ye,j[W+7],16,-155497632),ye=L(ye,Le,Me,_e,j[W+10],23,-1094730640),_e=L(_e,ye,Le,Me,j[W+13],4,681279174),Me=L(Me,_e,ye,Le,j[W+0],11,-358537222),Le=L(Le,Me,_e,ye,j[W+3],16,-722521979),ye=L(ye,Le,Me,_e,j[W+6],23,76029189),_e=L(_e,ye,Le,Me,j[W+9],4,-640364487),Me=L(Me,_e,ye,Le,j[W+12],11,-421815835),Le=L(Le,Me,_e,ye,j[W+15],16,530742520),ye=L(ye,Le,Me,_e,j[W+2],23,-995338651),_e=H(_e,ye,Le,Me,j[W+0],6,-198630844),Me=H(Me,_e,ye,Le,j[W+7],10,1126891415),Le=H(Le,Me,_e,ye,j[W+14],15,-1416354905),ye=H(ye,Le,Me,_e,j[W+5],21,-57434055),_e=H(_e,ye,Le,Me,j[W+12],6,1700485571),Me=H(Me,_e,ye,Le,j[W+3],10,-1894986606),Le=H(Le,Me,_e,ye,j[W+10],15,-1051523),ye=H(ye,Le,Me,_e,j[W+1],21,-2054922799),_e=H(_e,ye,Le,Me,j[W+8],6,1873313359),Me=H(Me,_e,ye,Le,j[W+15],10,-30611744),Le=H(Le,Me,_e,ye,j[W+6],15,-1560198380),ye=H(ye,Le,Me,_e,j[W+13],21,1309151649),_e=H(_e,ye,Le,Me,j[W+4],6,-145523070),Me=H(Me,_e,ye,Le,j[W+11],10,-1120210379),Le=H(Le,Me,_e,ye,j[W+2],15,718787259),ye=H(ye,Le,Me,_e,j[W+9],21,-343485551),_e=C(_e,ee),ye=C(ye,re),Le=C(Le,fe),Me=C(Me,be);return S(_e)+S(ye)+S(Le)+S(Me)}(""+e+n)).slice(0,16),c=o.slice(0,12),u=await window.crypto.subtle.importKey("raw",o,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:c},u,r))},ab=async(r,e,n)=>await ob(r.buffer,e,n);function fl(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function ga(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?fl(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):fl(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class on extends di{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==ks.PLAYING)}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,n,o,c,u,m){if(super(e,u),D(this,"trackMediaType","video"),D(this,"_player",void 0),D(this,"isUseScaleResolutionDownBy",!1),D(this,"_videoVisibleTimer",null),D(this,"_statsTimer",null),D(this,"_previousVideoVisibleStatus",void 0),D(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),D(this,"_encoderConfig",void 0),D(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),D(this,"_optimizationMode",void 0),D(this,"_videoHeight",void 0),D(this,"_videoWidth",void 0),D(this,"_forceBitrateLimit",void 0),D(this,"_enabled",!0),D(this,"processorDestination",void 0),D(this,"_processorContext",void 0),Jr()){const{width:_,height:S}=e.getSettings();this._videoWidth=_,this._videoHeight=S}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=n,this._scalabilityMode=o,this._optimizationMode=c,this._hints=m||[],this._hints.indexOf(hi.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(_,S,C){const R=qt();return!(R.name!==_||!R.osVersion)&&Number(R.version)===S}(Pn.CHROME,115)&&Hn().indexOf("Windows")!==-1){const _=function(S,C){if("VideoFrame"in window&&"TransformStream"in window&&Dn().supportWebRTCInsertableStream){const R=new MediaStreamTrackProcessor(S),w=new MediaStreamTrackGenerator({kind:"video"});let N,L,H=Date.now();const j=()=>{W&&(clearInterval(W),W=void 0),N&&(N.close(),N=void 0),S.stop(),L=void 0,w.removeEventListener("ended",j)};let W=window.setInterval(()=>{if(L&&N&&Date.now()-H>1e3)try{w.readyState==="live"?L.enqueue(N.clone()):j()}catch{j()}},1e3);const ee=new TransformStream({transform:(re,fe)=>{w.readyState==="live"?(L=fe,H=Date.now(),N===void 0?(N=re,fe.enqueue(re.clone())):(fe.enqueue(N),N=re)):re.close()}});return w.addEventListener("ended",j),R.readable.pipeThrough(ee).pipeTo(w.writable),w}}(e);_&&(M.info("local screen video track begin to inject frame"),this._mediaStreamTrack=_)}n&&this._hints.indexOf(hi.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new Po(this.getTrackId(),"local"),this.processorDestination=new LP(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const c=document.getElementById(e);c?e=c:(M.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}M.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const o=ga(ga(ga({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(o):(e instanceof HTMLVideoElement?this._player=new RC(o):this._player=new sb(o),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const c=this.getVideoElementVisibleStatus();this.safeEmit(Un.VIDEO_ELEMENT_VISIBLE_STATUS,c)}catch{}},oe("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,M.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(M.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Mn(this,ht.NEED_DISABLE_TRACK,this)}catch(o){throw M.error("[".concat(this.getTrackId(),"] setEnabled to false error"),o.toString()),o}return n||(this._enabled=!1),void M.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Mn(this,ht.NEED_ENABLE_TRACK,this)}catch(o){throw M.error("[".concat(this.getTrackId(),"] setEnabled to true error"),o.toString()),o}M.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,M.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Mn(this,ht.NEED_MUTE_TRACK,this):await Mn(this,ht.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,n){if(!this._enabled)throw new ke(Q.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=zc(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const o=TC({encoderConfig:e});(Jr()||Ds()||Ve())&&(o.deviceId=void 0),M.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(o));try{await this._originMediaStreamTrack.applyConstraints(o),this.updateMediaStreamTrackResolution()}catch(c){const u=new ke(Q.UNEXPECTED_ERROR,c.toString());throw M.error("[".concat(this.getTrackId(),"] applyConstraints error"),u.toString()),u}}this._encoderConfig=e,this._hints.indexOf(hi.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Mn(this,ht.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(M)}}getStats(){return eu(()=>{M.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),mo(this,ht.GET_STATS)||ga({},pl)}async setBeautyEffect(e){M.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,n):await pu(e)}async setBitrateLimit(e){if(M.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await Mn(this,ht.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(M)}}}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void M.error(Q.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=e,await Mn(this,ht.SET_OPTIMIZATION_MODE,this)}catch(o){throw this._optimizationMode=n,M.error("[".concat(this.getTrackId(),"] set optimization mode failed"),o.toString()),o}M.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return M.error(Q.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,M.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){VP(this._originMediaStreamTrack).then(e=>{let[n,o]=e;this._videoHeight=o,this._videoWidth=n}).catch(LT)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new ke(Q.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");M.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=zc(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(hi.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Mn(this,ht.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(M)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:n,frameRate:o}=this.getMediaStreamTrackSettings();if(!e||!n||!o)return;const{bitrateMax:c,bitrateMin:u}=this._encoderConfig;if(u==null||c==null){const{max:m,min:_}=function(S,C,R,w,N){const L=oe("BITRATE_ADAPTER_TYPE");if(L==="DEFAULT_BITRATE")return{min:w,max:N};if(N===void 0){var H;const W=Math.floor(200*Math.pow(R/15,.6)*Math.pow(S*C/640/360,.75));N=L==="STANDARD_BITRATE"?4*W:2*W,w=(H=w)!==null&&H!==void 0?H:W}else{var j;w=(j=w)!==null&&j!==void 0?j:Math.floor(N/10)}return{min:w,max:N}}(e,n,o,u,c);this._encoderConfig.bitrateMin=_,this._encoderConfig.bitrateMax=m,M.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(o,"] => [brMax: ").concat(m,", brMin: ").concat(_,"]"))}}getVideoElementVisibleStatus(){try{var e,n;const o=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),c={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:o==null?void 0:o.parentElement},{element:u,slot:m}=c;if(this.isPlaying&&u instanceof HTMLVideoElement&&m instanceof HTMLElement){const _=GA.checkOneElementVisible(u),S=Object.assign({},_);if(S.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=S.visible;const C=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});S.visible?C.onSuccess("Video is visible"):C.onSuccess("Invisible because of ".concat(S.reason))}return S}return}catch(o){throw new ke(Q.GET_VIDEO_ELEMENT_VISIBLE_ERROR,o.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new ke(Q.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],o=this._encoderConfig;e&&(o=ga(ga({},o),zc(e))),o=Bc(o);const c=oi(8,"track-video-cloned-"),u=new on(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,o,Bc(this._scalabilityMode),this._optimizationMode,c,Bc(this._hints));return e&&o&&u.setEncoderConfiguration(o),M.debug("clone video track from ".concat(this.getTrackId()," to ").concat(c,", clone ").concat(n)),u}async replaceTrack(e,n){if(!(e instanceof MediaStreamTrack))throw new ke(Q.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new ke(Q.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,n,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!Jr()&&!Ds())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,n=lu[e],o=-1,c=Date.now();const u=m=>{m>2||m<0||(c=Date.now(),n=lu[m],this.setSenderConfiguration(n))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{const m=this.getStats(),_=mo(this,ht.GET_RTC_STATS);if(m.sendPackets>0&&_){o===-1&&(o=Date.now());const S=Date.now();if(S-o<1e3||S-c<oe("PROFILE_SWITCH_INTERVAL"))return;const C=m.sendFrameRate,R=.6*n.frameRate,w=.9*n.frameRate;typeof C=="number"&&C>0&&C<R?e>0&&(e--,u(e),M.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(C,", switchProfile to ").concat(e))):_.OutgoingAvailableBandwidth<n.bitrateMin?e>0&&(e--,u(e),M.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(_.OutgoingAvailableBandwidth,", bitrateMin ").concat(n.bitrateMin,", switchProfile to ").concat(e))):typeof C=="number"&&C>w&&e<lu.length-1&&_.OutgoingAvailableBandwidth>1.2*lu[e+1].bitrateMin&&(e++,u(e),M.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(C,", OutgoingAvailableBandwidth ").concat(_.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)))}},oe("CHECK_LOCAL_STATS_INTERVAL"))}sendSeiData(e){if(eu(()=>{vt.reportApiInvoke(null,{name:Si.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:wi.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!oe("ENABLE_VIDEO_SEI")||!oe("ENABLE_ENCODED_TRANSFORM"))return void M.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(!(e instanceof Uint8Array))return new ke(Q.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void M.warning("Video track is not published, SEI can not be send");const o=n.sender.getParameters();if(o.codecs.length===0)return;const c=o.codecs[0].mimeType.toLocaleLowerCase();c==="video/h264"?this.safeEmit("sei-to-send",e):M.warning("SEI is not supported by ".concat(c))}bindProcessorDestinationEvents(){this.processorDestination.on(ys.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Mn(this,ht.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mn(this,ht.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ys.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Eo.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Eo.REQUEST_CONSTRAINTS)}}Ge([Lt({argsMap:(r,e,n)=>[r.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),er(),z("design:type",Function),z("design:paramtypes",[Object,Object]),z("design:returntype",void 0)],on.prototype,"play",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],on.prototype,"stop",null),Ge([ah("LocalVideoTrack","_enabledMutex"),Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Boolean,Boolean]),z("design:returntype",Ee)],on.prototype,"setEnabled",null),Ge([ah("LocalVideoTrack","_enabledMutex"),Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Boolean]),z("design:returntype",Ee)],on.prototype,"setMuted",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Object,Boolean]),z("design:returntype",Ee)],on.prototype,"setEncoderConfiguration",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Object)],on.prototype,"getStats",null),Ge([Lt({argsMap:(r,e,n)=>[r.getTrackId(),e,n]}),er(),z("design:type",Function),z("design:paramtypes",[Boolean,Object]),z("design:returntype",Ee)],on.prototype,"setBeautyEffect",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",ImageData)],on.prototype,"getCurrentFrameData",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[String,Number]),z("design:returntype",Ee)],on.prototype,"getCurrentFrameImage",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],on.prototype,"setBitrateLimit",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],on.prototype,"setOptimizationMode",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",void 0)],on.prototype,"setScalabiltyMode",null),Ge([er(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],on.prototype,"updateMediaStreamTrackResolution",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e.name]}),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Object)],on.prototype,"pipe",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],on.prototype,"unpipe",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],on.prototype,"close",null),Ge([Lt({argsMap:(r,e,n)=>[r.getTrackId(),e.label,n]}),z("design:type",Function),z("design:paramtypes",[MediaStreamTrack,Boolean]),z("design:returntype",Ee)],on.prototype,"replaceTrack",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],on.prototype,"startMonitorStats",null);class _l extends on{get __className__(){return"CameraVideoTrack"}constructor(e,n,o,c,u,m){super(e,zc(n.encoderConfig),c,u,m),D(this,"_config",void 0),D(this,"_originalConstraints",void 0),D(this,"_constraints",void 0),D(this,"_enabled",!0),D(this,"_deviceName","default"),D(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Zl()||Op())&&!function(){const _=qt();if(_.os!==ar.IOS||!_.osVersion)return!1;const S=_.osVersion.split(".");return Number(S[0])===15&&Number(S[1])>=2}()&&$l()&&this._enabled&&!this._isClosed&&(M.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=n,this._originalConstraints=o,this._constraints=o,this._deviceName=e.label,this._encoderConfig=zc(this._config.encoderConfig),tn.on(Nr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),tn.on(Nr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(M.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const n=await _a.getDeviceById(e),o={};o.video=ga({},this._constraints),o.video.deviceId={exact:e},o.video.facingMode=void 0,this._originMediaStreamTrack.stop();let c=null;try{c=await fa(o,this.getTrackId())}catch(u){throw M.error("[".concat(this.getTrackId(),"] setDevice failed"),u.toString()),c=await fa({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(c.getVideoTracks()[0],!1),u}await this._updateOriginMediaStreamTrack(c.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw M.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await _a.getDeviceById(e);this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw M.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}M.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){M.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const n={video:ga(ga({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let o=null;try{o=await fa(n,this.getTrackId())}catch(c){throw M.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),c.toString()),o=await fa({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),c}await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=ga({},n.video),M.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(M.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const o=await fa({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1)}await Mn(this,ht.NEED_ENABLE_TRACK,this)}catch(o){throw M.error("[".concat(this.getTrackId(),"] setEnabled true error"),o.toString()),o}this.updateMediaStreamTrackResolution(),M.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await Mn(this,ht.NEED_DISABLE_TRACK,this)}catch(o){throw M.error("[".concat(this.getTrackId(),"] setEnabled to false error"),o.toString()),o}M.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new ke(Q.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=zc(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin);const o=sn(this._config);o.encoderConfig=e;const c=TC(o);(Jr()||Ds()||Ve())&&(c.deviceId=void 0),M.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(c));try{await this._originMediaStreamTrack.applyConstraints(c),this.updateMediaStreamTrackResolution()}catch(u){const m=new ke(Q.UNEXPECTED_ERROR,u.toString());throw M.error("[".concat(this.getTrackId(),"] applyConstraints error"),m.toString()),m}this._config=o,this._constraints=c,this._originalConstraints=c,this._encoderConfig=e,this._hints.indexOf(hi.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Mn(this,ht.NEED_UPDATE_VIDEO_ENCODER,this)}catch(u){return u.throw(M)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Ds()||Ve())&&this._enabled&&!this._isClosed&&tn.duringInterruption){const e=async()=>{tn.off(Nr.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(M.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};tn.on(Nr.IOS_INTERRUPTION_END,e)}else M.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Un.TRACK_ENDED)}async renewMediaStreamTrack(e){const n=e||this._constraints,o=_a.searchDeviceIdByName(this._deviceName);if(o&&!n.deviceId&&(n.deviceId={exact:o}),this._enabled){const c=await fa({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(c.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),tn.off(Nr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),tn.off(Nr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],o=this._encoderConfig;e&&(o=ga(ga({},o),zc(e))),o=Bc(o);const c=oi(8,"track-cam-cloned-"),u=new _l(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,Bc(ga(ga({},this._config),{},{encoderConfig:o})),Bc(this._constraints),Bc(this._scalabilityMode),this._optimizationMode,c);return e&&o&&u.setEncoderConfiguration(o),M.debug("clone track from ".concat(this.getTrackId()," to ").concat(c,", clone ").concat(n)),u}bindProcessorContextEvents(){this.processorContext.on(Eo.REQUEST_UPDATE_CONSTRAINTS,async(e,n,o)=>{try{const c=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(c),n()}catch(c){o(c)}}),this.processorContext.on(Eo.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}}function cb(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Og(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?cb(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):cb(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function yC(r,e,n,o){n.optimizationMode&&(o&&o.width&&o.height?(n.encoderConfig=Og(Og({},o),{},{bitrateMin:o.bitrateMin,bitrateMax:o.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(e.contentHint=n.optimizationMode,e.contentHint===n.optimizationMode?M.debug("[".concat(r,"] set content hint to"),n.optimizationMode):M.debug("[".concat(r,"] set content hint failed")))):M.warning("[".concat(r,"] can not apply optimization mode bitrate config, no encoderConfig")))}function FP(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Ng(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?FP(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):FP(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],_l.prototype,"setDevice",null),Ge([ah("CameraVideoTrack","_enabledMutex"),Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Boolean,Boolean]),z("design:returntype",Ee)],_l.prototype,"setEnabled",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),er(),z("design:type",Function),z("design:paramtypes",[Object,Boolean]),z("design:returntype",Ee)],_l.prototype,"setEncoderConfiguration",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],_l.prototype,"close",null);class db extends ml{getUserId(){return this._userId}constructor(e,n,o,c){super(e,"track-".concat(e.kind,"-").concat(n,"-").concat(c.clientId,"_").concat(oi(5,""))),D(this,"_userId",void 0),D(this,"_uintId",void 0),D(this,"_isDestroyed",!1),D(this,"store",void 0),D(this,"processor",void 0),this._userId=n,this._uintId=o,this.store=c}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,M.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class ps extends db{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==ks.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,n,o,c){super(e,n,o,c),D(this,"_videoVisibleTimer",null),D(this,"_previousVideoVisibleStatus",void 0),D(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),D(this,"trackMediaType","video"),D(this,"_videoWidth",void 0),D(this,"_videoHeight",void 0),D(this,"_player",void 0),D(this,"processorDestination",void 0),D(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new Po(this.getTrackId(),"remote"),this.processorDestination=new LP(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return eu(()=>{M.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),mo(this,ht.GET_STATS)||Ng({},yg)}play(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const c=document.getElementById(e);c?e=c:(M.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}M.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const o=Ng(Ng({fit:"cover"},n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(o):(e instanceof HTMLVideoElement?this._player=new RC(o):this._player=new sb(o),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(pa.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=c=>{this.safeEmit(pa.VIDEO_STATE_CHANGED,c)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const c=this.getVideoElementVisibleStatus();this.safeEmit(pa.VIDEO_ELEMENT_VISIBLE_STATUS,c)}catch{}},oe("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,M.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){VP(this._originMediaStreamTrack).then(e=>{let[n,o]=e;this._videoHeight=o,this._videoWidth=n}).catch(LT)}_updatePlayerSource(){M.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,n;const o=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),c={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:o==null?void 0:o.parentElement},{element:u,slot:m}=c;if(this.isPlaying&&u instanceof HTMLVideoElement&&m instanceof HTMLElement){const _=GA.checkOneElementVisible(u),S=Object.assign({},_);if(S.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=S.visible;const C=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});S.visible?C.onSuccess("Video is visible"):C.onSuccess("Invisible because of ".concat(S.reason))}return S}return}catch(o){throw new ke(Q.GET_VIDEO_ELEMENT_VISIBLE_ERROR,o.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new ke(Q.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ys.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ys.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(ut.SEI_RECEIVED,e)}}Ge([Lt({argsMap:(r,e,n)=>[r.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),z("design:type",Function),z("design:paramtypes",[Object,Object]),z("design:returntype",void 0)],ps.prototype,"play",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],ps.prototype,"stop",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e.name]}),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Object)],ps.prototype,"pipe",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],ps.prototype,"unpipe",null);class jt extends db{get isPlaying(){return this._useAudioElement?So.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,n,o,c){super(e,n,o,c),D(this,"trackMediaType","audio"),D(this,"_source",void 0),D(this,"_useAudioElement",!0),D(this,"_volume",100),D(this,"processorContext",void 0),D(this,"processorDestination",void 0),D(this,"_played",!1),D(this,"_bypassWebAudio",!1),oe("DISABLE_WEBAUDIO")?(this._source=new Ef,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new vh(e,!0),oe("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(_o.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(pa.FIRST_FRAME_DECODED)}),this.processorContext=new ib(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new tr(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(_o.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(_o.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(n),this._source.removeAllListeners(_o.ON_AUDIO_BUFFER),this._source.on(_o.ON_AUDIO_BUFFER,o=>e(o))}setVolume(e){this._volume=e,this._useAudioElement?So.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!tl()&&oe("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new ke(Q.NOT_SUPPORTED,"your browser does not support setting the audio output device");await So.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return eu(()=>{M.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),mo(this,ht.GET_STATS)||Ng({},Th)}play(){M.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(M.debug("[".concat(this.getTrackId(),"] use audio element to play")),So.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){M.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?So.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];M.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&So.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new ke(Q.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new ke(Q.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new ke(Q.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const n=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,n.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ys.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(ys.ON_NODE,e=>{this._source.processedNode=e;const n=!e;this._useAudioElement!==n&&(this._played?(this.stop(),this._useAudioElement=n,this.play()):this._useAudioElement=n)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ys.ON_TRACK),this.processorDestination.removeAllListeners(ys.ON_NODE)}}Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e],throttleTime:300}),z("design:type",Function),z("design:paramtypes",[Number]),z("design:returntype",void 0)],jt.prototype,"setVolume",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e]}),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],jt.prototype,"setPlaybackDevice",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],jt.prototype,"play",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],jt.prototype,"stop",null),Ge([Lt({argsMap:(r,e)=>[r.getTrackId(),e.name]}),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Object)],jt.prototype,"pipe",null),Ge([Lt({argsMap:r=>[r.getTrackId()]}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],jt.prototype,"unpipe",null);const Qo=new class extends Dt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),D(this,"_lastHiddenTime",0),D(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),M.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */function qp(r){let e=r.length;for(;--e>=0;)r[e]=0}const Sf=256,IC=286,Tf=30,yh=15,AC=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),fc=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Jc=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Jp=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Pd=new Array(576);qp(Pd);const Cf=new Array(60);qp(Cf);const fu=new Array(512);qp(fu);const _u=new Array(256);qp(_u);const Dg=new Array(29);qp(Dg);const Xp=new Array(Tf);function lb(r,e,n,o,c){this.static_tree=r,this.extra_bits=e,this.extra_base=n,this.elems=o,this.max_length=c,this.has_stree=r&&r.length}let ub,El,vf;function Qp(r,e){this.dyn_tree=r,this.max_code=0,this.stat_desc=e}qp(Xp);const Rf=r=>r<256?fu[r]:fu[256+(r>>>7)],Zp=(r,e)=>{r.pending_buf[r.pending++]=255&e,r.pending_buf[r.pending++]=e>>>8&255},ko=(r,e,n)=>{r.bi_valid>16-n?(r.bi_buf|=e<<r.bi_valid&65535,Zp(r,r.bi_buf),r.bi_buf=e>>16-r.bi_valid,r.bi_valid+=n-16):(r.bi_buf|=e<<r.bi_valid&65535,r.bi_valid+=n)},Xc=(r,e,n)=>{ko(r,n[2*e],n[2*e+1])},hb=(r,e)=>{let n=0;do n|=1&r,r>>>=1,n<<=1;while(--e>0);return n>>>1},pb=(r,e,n)=>{const o=new Array(16);let c,u,m=0;for(c=1;c<=yh;c++)m=m+n[c-1]<<1,o[c]=m;for(u=0;u<=e;u++){let _=r[2*u+1];_!==0&&(r[2*u]=hb(o[_]++,_))}},mb=r=>{let e;for(e=0;e<IC;e++)r.dyn_ltree[2*e]=0;for(e=0;e<Tf;e++)r.dyn_dtree[2*e]=0;for(e=0;e<19;e++)r.bl_tree[2*e]=0;r.dyn_ltree[512]=1,r.opt_len=r.static_len=0,r.sym_next=r.matches=0},wC=r=>{r.bi_valid>8?Zp(r,r.bi_buf):r.bi_valid>0&&(r.pending_buf[r.pending++]=r.bi_buf),r.bi_buf=0,r.bi_valid=0},fb=(r,e,n,o)=>{const c=2*e,u=2*n;return r[c]<r[u]||r[c]===r[u]&&o[e]<=o[n]},$p=(r,e,n)=>{const o=r.heap[n];let c=n<<1;for(;c<=r.heap_len&&(c<r.heap_len&&fb(e,r.heap[c+1],r.heap[c],r.depth)&&c++,!fb(e,o,r.heap[c],r.depth));)r.heap[n]=r.heap[c],n=c,c<<=1;r.heap[n]=o},Sa=(r,e,n)=>{let o,c,u,m,_=0;if(r.sym_next!==0)do o=255&r.pending_buf[r.sym_buf+_++],o+=(255&r.pending_buf[r.sym_buf+_++])<<8,c=r.pending_buf[r.sym_buf+_++],o===0?Xc(r,c,e):(u=_u[c],Xc(r,u+Sf+1,e),m=AC[u],m!==0&&(c-=Dg[u],ko(r,c,m)),o--,u=Rf(o),Xc(r,u,n),m=fc[u],m!==0&&(o-=Xp[u],ko(r,o,m)));while(_<r.sym_next);Xc(r,256,e)},Qc=(r,e)=>{const n=e.dyn_tree,o=e.stat_desc.static_tree,c=e.stat_desc.has_stree,u=e.stat_desc.elems;let m,_,S,C=-1;for(r.heap_len=0,r.heap_max=573,m=0;m<u;m++)n[2*m]!==0?(r.heap[++r.heap_len]=C=m,r.depth[m]=0):n[2*m+1]=0;for(;r.heap_len<2;)S=r.heap[++r.heap_len]=C<2?++C:0,n[2*S]=1,r.depth[S]=0,r.opt_len--,c&&(r.static_len-=o[2*S+1]);for(e.max_code=C,m=r.heap_len>>1;m>=1;m--)$p(r,n,m);S=u;do m=r.heap[1],r.heap[1]=r.heap[r.heap_len--],$p(r,n,1),_=r.heap[1],r.heap[--r.heap_max]=m,r.heap[--r.heap_max]=_,n[2*S]=n[2*m]+n[2*_],r.depth[S]=(r.depth[m]>=r.depth[_]?r.depth[m]:r.depth[_])+1,n[2*m+1]=n[2*_+1]=S,r.heap[1]=S++,$p(r,n,1);while(r.heap_len>=2);r.heap[--r.heap_max]=r.heap[1],((R,w)=>{const N=w.dyn_tree,L=w.max_code,H=w.stat_desc.static_tree,j=w.stat_desc.has_stree,W=w.stat_desc.extra_bits,ee=w.stat_desc.extra_base,re=w.stat_desc.max_length;let fe,be,_e,ye,Le,Me,et=0;for(ye=0;ye<=yh;ye++)R.bl_count[ye]=0;for(N[2*R.heap[R.heap_max]+1]=0,fe=R.heap_max+1;fe<573;fe++)be=R.heap[fe],ye=N[2*N[2*be+1]+1]+1,ye>re&&(ye=re,et++),N[2*be+1]=ye,be>L||(R.bl_count[ye]++,Le=0,be>=ee&&(Le=W[be-ee]),Me=N[2*be],R.opt_len+=Me*(ye+Le),j&&(R.static_len+=Me*(H[2*be+1]+Le)));if(et!==0){do{for(ye=re-1;R.bl_count[ye]===0;)ye--;R.bl_count[ye]--,R.bl_count[ye+1]+=2,R.bl_count[re]--,et-=2}while(et>0);for(ye=re;ye!==0;ye--)for(be=R.bl_count[ye];be!==0;)_e=R.heap[--fe],_e>L||(N[2*_e+1]!==ye&&(R.opt_len+=(ye-N[2*_e+1])*N[2*_e],N[2*_e+1]=ye),be--)}})(r,e),pb(n,C,r.bl_count)},_b=(r,e,n)=>{let o,c,u=-1,m=e[1],_=0,S=7,C=4;for(m===0&&(S=138,C=3),e[2*(n+1)+1]=65535,o=0;o<=n;o++)c=m,m=e[2*(o+1)+1],++_<S&&c===m||(_<C?r.bl_tree[2*c]+=_:c!==0?(c!==u&&r.bl_tree[2*c]++,r.bl_tree[32]++):_<=10?r.bl_tree[34]++:r.bl_tree[36]++,_=0,u=c,m===0?(S=138,C=3):c===m?(S=6,C=3):(S=7,C=4))},Eb=(r,e,n)=>{let o,c,u=-1,m=e[1],_=0,S=7,C=4;for(m===0&&(S=138,C=3),o=0;o<=n;o++)if(c=m,m=e[2*(o+1)+1],!(++_<S&&c===m)){if(_<C)do Xc(r,c,r.bl_tree);while(--_!=0);else c!==0?(c!==u&&(Xc(r,c,r.bl_tree),_--),Xc(r,16,r.bl_tree),ko(r,_-3,2)):_<=10?(Xc(r,17,r.bl_tree),ko(r,_-3,3)):(Xc(r,18,r.bl_tree),ko(r,_-11,7));_=0,u=c,m===0?(S=138,C=3):c===m?(S=6,C=3):(S=7,C=4)}};let gb=!1;const Sb=(r,e,n,o)=>{ko(r,0+(o?1:0),3),wC(r),Zp(r,n),Zp(r,~n),n&&r.pending_buf.set(r.window.subarray(e,e+n),r.pending),r.pending+=n};var jP=r=>{gb||((()=>{let e,n,o,c,u;const m=new Array(16);for(o=0,c=0;c<28;c++)for(Dg[c]=o,e=0;e<1<<AC[c];e++)_u[o++]=c;for(_u[o-1]=c,u=0,c=0;c<16;c++)for(Xp[c]=u,e=0;e<1<<fc[c];e++)fu[u++]=c;for(u>>=7;c<Tf;c++)for(Xp[c]=u<<7,e=0;e<1<<fc[c]-7;e++)fu[256+u++]=c;for(n=0;n<=yh;n++)m[n]=0;for(e=0;e<=143;)Pd[2*e+1]=8,e++,m[8]++;for(;e<=255;)Pd[2*e+1]=9,e++,m[9]++;for(;e<=279;)Pd[2*e+1]=7,e++,m[7]++;for(;e<=287;)Pd[2*e+1]=8,e++,m[8]++;for(pb(Pd,287,m),e=0;e<Tf;e++)Cf[2*e+1]=5,Cf[2*e]=hb(e,5);ub=new lb(Pd,AC,257,IC,yh),El=new lb(Cf,fc,0,Tf,yh),vf=new lb(new Array(0),Jc,0,19,7)})(),gb=!0),r.l_desc=new Qp(r.dyn_ltree,ub),r.d_desc=new Qp(r.dyn_dtree,El),r.bl_desc=new Qp(r.bl_tree,vf),r.bi_buf=0,r.bi_valid=0,mb(r)},Tb=(r,e,n,o)=>{let c,u,m=0;r.level>0?(r.strm.data_type===2&&(r.strm.data_type=(_=>{let S,C=4093624447;for(S=0;S<=31;S++,C>>>=1)if(1&C&&_.dyn_ltree[2*S]!==0)return 0;if(_.dyn_ltree[18]!==0||_.dyn_ltree[20]!==0||_.dyn_ltree[26]!==0)return 1;for(S=32;S<Sf;S++)if(_.dyn_ltree[2*S]!==0)return 1;return 0})(r)),Qc(r,r.l_desc),Qc(r,r.d_desc),m=(_=>{let S;for(_b(_,_.dyn_ltree,_.l_desc.max_code),_b(_,_.dyn_dtree,_.d_desc.max_code),Qc(_,_.bl_desc),S=18;S>=3&&_.bl_tree[2*Jp[S]+1]===0;S--);return _.opt_len+=3*(S+1)+5+5+4,S})(r),c=r.opt_len+3+7>>>3,u=r.static_len+3+7>>>3,u<=c&&(c=u)):c=u=n+5,n+4<=c&&e!==-1?Sb(r,e,n,o):r.strategy===4||u===c?(ko(r,2+(o?1:0),3),Sa(r,Pd,Cf)):(ko(r,4+(o?1:0),3),((_,S,C,R)=>{let w;for(ko(_,S-257,5),ko(_,C-1,5),ko(_,R-4,4),w=0;w<R;w++)ko(_,_.bl_tree[2*Jp[w]+1],3);Eb(_,_.dyn_ltree,S-1),Eb(_,_.dyn_dtree,C-1)})(r,r.l_desc.max_code+1,r.d_desc.max_code+1,m+1),Sa(r,r.dyn_ltree,r.dyn_dtree)),mb(r),o&&wC(r)},BP=(r,e,n)=>(r.pending_buf[r.sym_buf+r.sym_next++]=e,r.pending_buf[r.sym_buf+r.sym_next++]=e>>8,r.pending_buf[r.sym_buf+r.sym_next++]=n,e===0?r.dyn_ltree[2*n]++:(r.matches++,e--,r.dyn_ltree[2*(_u[n]+Sf+1)]++,r.dyn_dtree[2*Rf(e)]++),r.sym_next===r.sym_end),Cb={_tr_init:jP,_tr_stored_block:Sb,_tr_flush_block:Tb,_tr_tally:BP,_tr_align:r=>{ko(r,2,3),Xc(r,256,Pd),(e=>{e.bi_valid===16?(Zp(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(r)}},yf=(r,e,n,o)=>{let c=65535&r|0,u=r>>>16&65535|0,m=0;for(;n!==0;){m=n>2e3?2e3:n,n-=m;do c=c+e[o++]|0,u=u+c|0;while(--m);c%=65521,u%=65521}return c|u<<16|0};const GP=new Uint32Array((()=>{let r,e=[];for(var n=0;n<256;n++){r=n;for(var o=0;o<8;o++)r=1&r?3988292384^r>>>1:r>>>1;e[n]=r}return e})());var ro=(r,e,n,o)=>{const c=GP,u=o+n;r^=-1;for(let m=o;m<u;m++)r=r>>>8^c[255&(r^e[m])];return-1^r},Ih={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},If={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:e3,_tr_stored_block:vb,_tr_flush_block:t3,_tr_tally:Zc,_tr_align:n3}=Cb,{Z_NO_FLUSH:Hr,Z_PARTIAL_FLUSH:em,Z_FULL_FLUSH:Af,Z_FINISH:$c,Z_BLOCK:bC,Z_OK:Lo,Z_STREAM_END:Eu,Z_STREAM_ERROR:gl,Z_DATA_ERROR:Ah,Z_BUF_ERROR:Rb,Z_DEFAULT_COMPRESSION:i3,Z_FILTERED:ed,Z_HUFFMAN_ONLY:Pg,Z_RLE:Mo,Z_FIXED:WP,Z_DEFAULT_STRATEGY:Sl,Z_UNKNOWN:r3,Z_DEFLATED:wf}=If,yb=286,s3=30,OC=19,o3=2*yb+1,a3=15,tm=258,Tl=262,gu=42,Su=113,kg=666,nm=(r,e)=>(r.msg=Ih[e],e),HP=r=>2*r-(r>4?9:0),wh=r=>{let e=r.length;for(;--e>=0;)r[e]=0},im=r=>{let e,n,o,c=r.w_size;e=r.hash_size,o=e;do n=r.head[--o],r.head[o]=n>=c?n-c:0;while(--e);e=c,o=e;do n=r.prev[--o],r.prev[o]=n>=c?n-c:0;while(--e)};let Uo=(r,e,n)=>(e<<r.hash_shift^n)&r.hash_mask;const To=r=>{const e=r.state;let n=e.pending;n>r.avail_out&&(n=r.avail_out),n!==0&&(r.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),r.next_out),r.next_out+=n,e.pending_out+=n,r.total_out+=n,r.avail_out-=n,e.pending-=n,e.pending===0&&(e.pending_out=0))},so=(r,e)=>{t3(r,r.block_start>=0?r.block_start:-1,r.strstart-r.block_start,e),r.block_start=r.strstart,To(r.strm)},Oi=(r,e)=>{r.pending_buf[r.pending++]=e},kd=(r,e)=>{r.pending_buf[r.pending++]=e>>>8&255,r.pending_buf[r.pending++]=255&e},NC=(r,e,n,o)=>{let c=r.avail_in;return c>o&&(c=o),c===0?0:(r.avail_in-=c,e.set(r.input.subarray(r.next_in,r.next_in+c),n),r.state.wrap===1?r.adler=yf(r.adler,e,c,n):r.state.wrap===2&&(r.adler=ro(r.adler,e,c,n)),r.next_in+=c,r.total_in+=c,c)},Tu=(r,e)=>{let n,o,c=r.max_chain_length,u=r.strstart,m=r.prev_length,_=r.nice_match;const S=r.strstart>r.w_size-Tl?r.strstart-(r.w_size-Tl):0,C=r.window,R=r.w_mask,w=r.prev,N=r.strstart+tm;let L=C[u+m-1],H=C[u+m];r.prev_length>=r.good_match&&(c>>=2),_>r.lookahead&&(_=r.lookahead);do if(n=e,C[n+m]===H&&C[n+m-1]===L&&C[n]===C[u]&&C[++n]===C[u+1]){u+=2,n++;do;while(C[++u]===C[++n]&&C[++u]===C[++n]&&C[++u]===C[++n]&&C[++u]===C[++n]&&C[++u]===C[++n]&&C[++u]===C[++n]&&C[++u]===C[++n]&&C[++u]===C[++n]&&u<N);if(o=tm-(N-u),u=N-tm,o>m){if(r.match_start=e,m=o,o>=_)break;L=C[u+m-1],H=C[u+m]}}while((e=w[e&R])>S&&--c!=0);return m<=r.lookahead?m:r.lookahead},bf=r=>{const e=r.w_size;let n,o,c;do{if(o=r.window_size-r.lookahead-r.strstart,r.strstart>=e+(e-Tl)&&(r.window.set(r.window.subarray(e,e+e-o),0),r.match_start-=e,r.strstart-=e,r.block_start-=e,r.insert>r.strstart&&(r.insert=r.strstart),im(r),o+=e),r.strm.avail_in===0)break;if(n=NC(r.strm,r.window,r.strstart+r.lookahead,o),r.lookahead+=n,r.lookahead+r.insert>=3)for(c=r.strstart-r.insert,r.ins_h=r.window[c],r.ins_h=Uo(r,r.ins_h,r.window[c+1]);r.insert&&(r.ins_h=Uo(r,r.ins_h,r.window[c+3-1]),r.prev[c&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=c,c++,r.insert--,!(r.lookahead+r.insert<3)););}while(r.lookahead<Tl&&r.strm.avail_in!==0)},Cu=(r,e)=>{let n,o,c,u=r.pending_buf_size-5>r.w_size?r.w_size:r.pending_buf_size-5,m=0,_=r.strm.avail_in;do{if(n=65535,c=r.bi_valid+42>>3,r.strm.avail_out<c||(c=r.strm.avail_out-c,o=r.strstart-r.block_start,n>o+r.strm.avail_in&&(n=o+r.strm.avail_in),n>c&&(n=c),n<u&&(n===0&&e!==$c||e===Hr||n!==o+r.strm.avail_in)))break;m=e===$c&&n===o+r.strm.avail_in?1:0,vb(r,0,0,m),r.pending_buf[r.pending-4]=n,r.pending_buf[r.pending-3]=n>>8,r.pending_buf[r.pending-2]=~n,r.pending_buf[r.pending-1]=~n>>8,To(r.strm),o&&(o>n&&(o=n),r.strm.output.set(r.window.subarray(r.block_start,r.block_start+o),r.strm.next_out),r.strm.next_out+=o,r.strm.avail_out-=o,r.strm.total_out+=o,r.block_start+=o,n-=o),n&&(NC(r.strm,r.strm.output,r.strm.next_out,n),r.strm.next_out+=n,r.strm.avail_out-=n,r.strm.total_out+=n)}while(m===0);return _-=r.strm.avail_in,_&&(_>=r.w_size?(r.matches=2,r.window.set(r.strm.input.subarray(r.strm.next_in-r.w_size,r.strm.next_in),0),r.strstart=r.w_size,r.insert=r.strstart):(r.window_size-r.strstart<=_&&(r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,r.insert>r.strstart&&(r.insert=r.strstart)),r.window.set(r.strm.input.subarray(r.strm.next_in-_,r.strm.next_in),r.strstart),r.strstart+=_,r.insert+=_>r.w_size-r.insert?r.w_size-r.insert:_),r.block_start=r.strstart),r.high_water<r.strstart&&(r.high_water=r.strstart),m?4:e!==Hr&&e!==$c&&r.strm.avail_in===0&&r.strstart===r.block_start?2:(c=r.window_size-r.strstart,r.strm.avail_in>c&&r.block_start>=r.w_size&&(r.block_start-=r.w_size,r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,c+=r.w_size,r.insert>r.strstart&&(r.insert=r.strstart)),c>r.strm.avail_in&&(c=r.strm.avail_in),c&&(NC(r.strm,r.window,r.strstart,c),r.strstart+=c,r.insert+=c>r.w_size-r.insert?r.w_size-r.insert:c),r.high_water<r.strstart&&(r.high_water=r.strstart),c=r.bi_valid+42>>3,c=r.pending_buf_size-c>65535?65535:r.pending_buf_size-c,u=c>r.w_size?r.w_size:c,o=r.strstart-r.block_start,(o>=u||(o||e===$c)&&e!==Hr&&r.strm.avail_in===0&&o<=c)&&(n=o>c?c:o,m=e===$c&&r.strm.avail_in===0&&n===o?1:0,vb(r,r.block_start,n,m),r.block_start+=n,To(r.strm)),m?3:1)},Ta=(r,e)=>{let n,o;for(;;){if(r.lookahead<Tl){if(bf(r),r.lookahead<Tl&&e===Hr)return 1;if(r.lookahead===0)break}if(n=0,r.lookahead>=3&&(r.ins_h=Uo(r,r.ins_h,r.window[r.strstart+3-1]),n=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),n!==0&&r.strstart-n<=r.w_size-Tl&&(r.match_length=Tu(r,n)),r.match_length>=3)if(o=Zc(r,r.strstart-r.match_start,r.match_length-3),r.lookahead-=r.match_length,r.match_length<=r.max_lazy_match&&r.lookahead>=3){r.match_length--;do r.strstart++,r.ins_h=Uo(r,r.ins_h,r.window[r.strstart+3-1]),n=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart;while(--r.match_length!=0);r.strstart++}else r.strstart+=r.match_length,r.match_length=0,r.ins_h=r.window[r.strstart],r.ins_h=Uo(r,r.ins_h,r.window[r.strstart+1]);else o=Zc(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++;if(o&&(so(r,!1),r.strm.avail_out===0))return 1}return r.insert=r.strstart<2?r.strstart:2,e===$c?(so(r,!0),r.strm.avail_out===0?3:4):r.sym_next&&(so(r,!1),r.strm.avail_out===0)?1:2},Co=(r,e)=>{let n,o,c;for(;;){if(r.lookahead<Tl){if(bf(r),r.lookahead<Tl&&e===Hr)return 1;if(r.lookahead===0)break}if(n=0,r.lookahead>=3&&(r.ins_h=Uo(r,r.ins_h,r.window[r.strstart+3-1]),n=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),r.prev_length=r.match_length,r.prev_match=r.match_start,r.match_length=2,n!==0&&r.prev_length<r.max_lazy_match&&r.strstart-n<=r.w_size-Tl&&(r.match_length=Tu(r,n),r.match_length<=5&&(r.strategy===ed||r.match_length===3&&r.strstart-r.match_start>4096)&&(r.match_length=2)),r.prev_length>=3&&r.match_length<=r.prev_length){c=r.strstart+r.lookahead-3,o=Zc(r,r.strstart-1-r.prev_match,r.prev_length-3),r.lookahead-=r.prev_length-1,r.prev_length-=2;do++r.strstart<=c&&(r.ins_h=Uo(r,r.ins_h,r.window[r.strstart+3-1]),n=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart);while(--r.prev_length!=0);if(r.match_available=0,r.match_length=2,r.strstart++,o&&(so(r,!1),r.strm.avail_out===0))return 1}else if(r.match_available){if(o=Zc(r,0,r.window[r.strstart-1]),o&&so(r,!1),r.strstart++,r.lookahead--,r.strm.avail_out===0)return 1}else r.match_available=1,r.strstart++,r.lookahead--}return r.match_available&&(o=Zc(r,0,r.window[r.strstart-1]),r.match_available=0),r.insert=r.strstart<2?r.strstart:2,e===$c?(so(r,!0),r.strm.avail_out===0?3:4):r.sym_next&&(so(r,!1),r.strm.avail_out===0)?1:2};function li(r,e,n,o,c){this.good_length=r,this.max_lazy=e,this.nice_length=n,this.max_chain=o,this.func=c}const vu=[new li(0,0,0,0,Cu),new li(4,4,8,4,Ta),new li(4,5,16,8,Ta),new li(4,6,32,32,Ta),new li(4,4,16,16,Co),new li(8,16,32,32,Co),new li(8,16,128,128,Co),new li(8,32,128,256,Co),new li(32,128,258,1024,Co),new li(32,258,258,4096,Co)];function Ib(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=wf,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*o3),this.dyn_dtree=new Uint16Array(2*(2*s3+1)),this.bl_tree=new Uint16Array(2*(2*OC+1)),wh(this.dyn_ltree),wh(this.dyn_dtree),wh(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(a3+1),this.heap=new Uint16Array(2*yb+1),wh(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*yb+1),wh(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Of=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.status!==gu&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==Su&&e.status!==kg?1:0},rm=r=>{if(Of(r))return nm(r,gl);r.total_in=r.total_out=0,r.data_type=r3;const e=r.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?gu:Su,r.adler=e.wrap===2?0:1,e.last_flush=-2,e3(e),Lo},Ab=r=>{const e=rm(r);var n;return e===Lo&&((n=r.state).window_size=2*n.w_size,wh(n.head),n.max_lazy_match=vu[n.level].max_lazy,n.good_match=vu[n.level].good_length,n.nice_match=vu[n.level].nice_length,n.max_chain_length=vu[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0),e},DC=(r,e,n,o,c,u)=>{if(!r)return gl;let m=1;if(e===i3&&(e=6),o<0?(m=0,o=-o):o>15&&(m=2,o-=16),c<1||c>9||n!==wf||o<8||o>15||e<0||e>9||u<0||u>WP||o===8&&m!==1)return nm(r,gl);o===8&&(o=9);const _=new Ib;return r.state=_,_.strm=r,_.status=gu,_.wrap=m,_.gzhead=null,_.w_bits=o,_.w_size=1<<_.w_bits,_.w_mask=_.w_size-1,_.hash_bits=c+7,_.hash_size=1<<_.hash_bits,_.hash_mask=_.hash_size-1,_.hash_shift=~~((_.hash_bits+3-1)/3),_.window=new Uint8Array(2*_.w_size),_.head=new Uint16Array(_.hash_size),_.prev=new Uint16Array(_.w_size),_.lit_bufsize=1<<c+6,_.pending_buf_size=4*_.lit_bufsize,_.pending_buf=new Uint8Array(_.pending_buf_size),_.sym_buf=_.lit_bufsize,_.sym_end=3*(_.lit_bufsize-1),_.level=e,_.strategy=u,_.method=n,Ab(r)};var Nf=(r,e)=>{if(Of(r)||e>bC||e<0)return r?nm(r,gl):gl;const n=r.state;if(!r.output||r.avail_in!==0&&!r.input||n.status===kg&&e!==$c)return nm(r,r.avail_out===0?Rb:gl);const o=n.last_flush;if(n.last_flush=e,n.pending!==0){if(To(r),r.avail_out===0)return n.last_flush=-1,Lo}else if(r.avail_in===0&&HP(e)<=HP(o)&&e!==$c)return nm(r,Rb);if(n.status===kg&&r.avail_in!==0)return nm(r,Rb);if(n.status===gu&&n.wrap===0&&(n.status=Su),n.status===gu){let c=wf+(n.w_bits-8<<4)<<8,u=-1;if(u=n.strategy>=Pg||n.level<2?0:n.level<6?1:n.level===6?2:3,c|=u<<6,n.strstart!==0&&(c|=32),c+=31-c%31,kd(n,c),n.strstart!==0&&(kd(n,r.adler>>>16),kd(n,65535&r.adler)),r.adler=1,n.status=Su,To(r),n.pending!==0)return n.last_flush=-1,Lo}if(n.status===57){if(r.adler=0,Oi(n,31),Oi(n,139),Oi(n,8),n.gzhead)Oi(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Oi(n,255&n.gzhead.time),Oi(n,n.gzhead.time>>8&255),Oi(n,n.gzhead.time>>16&255),Oi(n,n.gzhead.time>>24&255),Oi(n,n.level===9?2:n.strategy>=Pg||n.level<2?4:0),Oi(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Oi(n,255&n.gzhead.extra.length),Oi(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(r.adler=ro(r.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(Oi(n,0),Oi(n,0),Oi(n,0),Oi(n,0),Oi(n,0),Oi(n,n.level===9?2:n.strategy>=Pg||n.level<2?4:0),Oi(n,3),n.status=Su,To(r),n.pending!==0)return n.last_flush=-1,Lo}if(n.status===69){if(n.gzhead.extra){let c=n.pending,u=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+u>n.pending_buf_size;){let _=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+_),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>c&&(r.adler=ro(r.adler,n.pending_buf,n.pending-c,c)),n.gzindex+=_,To(r),n.pending!==0)return n.last_flush=-1,Lo;c=0,u-=_}let m=new Uint8Array(n.gzhead.extra);n.pending_buf.set(m.subarray(n.gzindex,n.gzindex+u),n.pending),n.pending+=u,n.gzhead.hcrc&&n.pending>c&&(r.adler=ro(r.adler,n.pending_buf,n.pending-c,c)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let c,u=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>u&&(r.adler=ro(r.adler,n.pending_buf,n.pending-u,u)),To(r),n.pending!==0)return n.last_flush=-1,Lo;u=0}c=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Oi(n,c)}while(c!==0);n.gzhead.hcrc&&n.pending>u&&(r.adler=ro(r.adler,n.pending_buf,n.pending-u,u)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let c,u=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>u&&(r.adler=ro(r.adler,n.pending_buf,n.pending-u,u)),To(r),n.pending!==0)return n.last_flush=-1,Lo;u=0}c=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Oi(n,c)}while(c!==0);n.gzhead.hcrc&&n.pending>u&&(r.adler=ro(r.adler,n.pending_buf,n.pending-u,u))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(To(r),n.pending!==0))return n.last_flush=-1,Lo;Oi(n,255&r.adler),Oi(n,r.adler>>8&255),r.adler=0}if(n.status=Su,To(r),n.pending!==0)return n.last_flush=-1,Lo}if(r.avail_in!==0||n.lookahead!==0||e!==Hr&&n.status!==kg){let c=n.level===0?Cu(n,e):n.strategy===Pg?((u,m)=>{let _;for(;;){if(u.lookahead===0&&(bf(u),u.lookahead===0)){if(m===Hr)return 1;break}if(u.match_length=0,_=Zc(u,0,u.window[u.strstart]),u.lookahead--,u.strstart++,_&&(so(u,!1),u.strm.avail_out===0))return 1}return u.insert=0,m===$c?(so(u,!0),u.strm.avail_out===0?3:4):u.sym_next&&(so(u,!1),u.strm.avail_out===0)?1:2})(n,e):n.strategy===Mo?((u,m)=>{let _,S,C,R;const w=u.window;for(;;){if(u.lookahead<=tm){if(bf(u),u.lookahead<=tm&&m===Hr)return 1;if(u.lookahead===0)break}if(u.match_length=0,u.lookahead>=3&&u.strstart>0&&(C=u.strstart-1,S=w[C],S===w[++C]&&S===w[++C]&&S===w[++C])){R=u.strstart+tm;do;while(S===w[++C]&&S===w[++C]&&S===w[++C]&&S===w[++C]&&S===w[++C]&&S===w[++C]&&S===w[++C]&&S===w[++C]&&C<R);u.match_length=tm-(R-C),u.match_length>u.lookahead&&(u.match_length=u.lookahead)}if(u.match_length>=3?(_=Zc(u,1,u.match_length-3),u.lookahead-=u.match_length,u.strstart+=u.match_length,u.match_length=0):(_=Zc(u,0,u.window[u.strstart]),u.lookahead--,u.strstart++),_&&(so(u,!1),u.strm.avail_out===0))return 1}return u.insert=0,m===$c?(so(u,!0),u.strm.avail_out===0?3:4):u.sym_next&&(so(u,!1),u.strm.avail_out===0)?1:2})(n,e):vu[n.level].func(n,e);if(c!==3&&c!==4||(n.status=kg),c===1||c===3)return r.avail_out===0&&(n.last_flush=-1),Lo;if(c===2&&(e===em?n3(n):e!==bC&&(vb(n,0,0,!1),e===Af&&(wh(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),To(r),r.avail_out===0))return n.last_flush=-1,Lo}return e!==$c?Lo:n.wrap<=0?Eu:(n.wrap===2?(Oi(n,255&r.adler),Oi(n,r.adler>>8&255),Oi(n,r.adler>>16&255),Oi(n,r.adler>>24&255),Oi(n,255&r.total_in),Oi(n,r.total_in>>8&255),Oi(n,r.total_in>>16&255),Oi(n,r.total_in>>24&255)):(kd(n,r.adler>>>16),kd(n,65535&r.adler)),To(r),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?Lo:Eu)},Cl=(r,e)=>{let n=e.length;if(Of(r))return gl;const o=r.state,c=o.wrap;if(c===2||c===1&&o.status!==gu||o.lookahead)return gl;if(c===1&&(r.adler=yf(r.adler,e,n,0)),o.wrap=0,n>=o.w_size){c===0&&(wh(o.head),o.strstart=0,o.block_start=0,o.insert=0);let S=new Uint8Array(o.w_size);S.set(e.subarray(n-o.w_size,n),0),e=S,n=o.w_size}const u=r.avail_in,m=r.next_in,_=r.input;for(r.avail_in=n,r.next_in=0,r.input=e,bf(o);o.lookahead>=3;){let S=o.strstart,C=o.lookahead-2;do o.ins_h=Uo(o,o.ins_h,o.window[S+3-1]),o.prev[S&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=S,S++;while(--C);o.strstart=S,o.lookahead=2,bf(o)}return o.strstart+=o.lookahead,o.block_start=o.strstart,o.insert=o.lookahead,o.lookahead=0,o.match_length=o.prev_length=2,o.match_available=0,r.next_in=m,r.input=_,r.avail_in=u,o.wrap=c,Lo},Ru={deflateInit:(r,e)=>DC(r,e,wf,15,8,Sl),deflateInit2:DC,deflateReset:Ab,deflateResetKeep:rm,deflateSetHeader:(r,e)=>Of(r)||r.state.wrap!==2?gl:(r.state.gzhead=e,Lo),deflate:Nf,deflateEnd:r=>{if(Of(r))return gl;const e=r.state.status;return r.state=null,e===Su?nm(r,Ah):Lo},deflateSetDictionary:Cl,deflateInfo:"pako deflate (from Nodeca project)"};const c3=(r,e)=>Object.prototype.hasOwnProperty.call(r,e);var bh={assign:function(r){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const o in n)c3(n,o)&&(r[o]=n[o])}}return r},flattenChunks:r=>{let e=0;for(let o=0,c=r.length;o<c;o++)e+=r[o].length;const n=new Uint8Array(e);for(let o=0,c=0,u=r.length;o<u;o++){let m=r[o];n.set(m,c),c+=m.length}return n}};let wb=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{wb=!1}const Df=new Uint8Array(256);for(let r=0;r<256;r++)Df[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;Df[254]=Df[254]=1;var Pf={string2buf:r=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(r);let e,n,o,c,u,m=r.length,_=0;for(c=0;c<m;c++)n=r.charCodeAt(c),(64512&n)==55296&&c+1<m&&(o=r.charCodeAt(c+1),(64512&o)==56320&&(n=65536+(n-55296<<10)+(o-56320),c++)),_+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(_),u=0,c=0;u<_;c++)n=r.charCodeAt(c),(64512&n)==55296&&c+1<m&&(o=r.charCodeAt(c+1),(64512&o)==56320&&(n=65536+(n-55296<<10)+(o-56320),c++)),n<128?e[u++]=n:n<2048?(e[u++]=192|n>>>6,e[u++]=128|63&n):n<65536?(e[u++]=224|n>>>12,e[u++]=128|n>>>6&63,e[u++]=128|63&n):(e[u++]=240|n>>>18,e[u++]=128|n>>>12&63,e[u++]=128|n>>>6&63,e[u++]=128|63&n);return e},buf2string:(r,e)=>{const n=e||r.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(r.subarray(0,e));let o,c;const u=new Array(2*n);for(c=0,o=0;o<n;){let m=r[o++];if(m<128){u[c++]=m;continue}let _=Df[m];if(_>4)u[c++]=65533,o+=_-1;else{for(m&=_===2?31:_===3?15:7;_>1&&o<n;)m=m<<6|63&r[o++],_--;_>1?u[c++]=65533:m<65536?u[c++]=m:(m-=65536,u[c++]=55296|m>>10&1023,u[c++]=56320|1023&m)}}return((m,_)=>{if(_<65534&&m.subarray&&wb)return String.fromCharCode.apply(null,m.length===_?m:m.subarray(0,_));let S="";for(let C=0;C<_;C++)S+=String.fromCharCode(m[C]);return S})(u,c)},utf8border:(r,e)=>{(e=e||r.length)>r.length&&(e=r.length);let n=e-1;for(;n>=0&&(192&r[n])==128;)n--;return n<0||n===0?e:n+Df[r[n]]>e?n:e}},KP=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const YP=Object.prototype.toString,{Z_NO_FLUSH:Lg,Z_SYNC_FLUSH:d3,Z_FULL_FLUSH:PC,Z_FINISH:zP,Z_OK:Oh,Z_STREAM_END:Mg,Z_DEFAULT_COMPRESSION:qP,Z_DEFAULT_STRATEGY:JP,Z_DEFLATED:l3}=If;function Ug(r){this.options=bh.assign({level:qP,method:l3,chunkSize:16384,windowBits:15,memLevel:8,strategy:JP},r||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new KP,this.strm.avail_out=0;let n=Ru.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==Oh)throw new Error(Ih[n]);if(e.header&&Ru.deflateSetHeader(this.strm,e.header),e.dictionary){let o;if(o=typeof e.dictionary=="string"?Pf.string2buf(e.dictionary):YP.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,n=Ru.deflateSetDictionary(this.strm,o),n!==Oh)throw new Error(Ih[n]);this._dict_set=!0}}function bb(r,e){const n=new Ug(e);if(n.push(r,!0),n.err)throw n.msg||Ih[n.err];return n.result}Ug.prototype.push=function(r,e){const n=this.strm,o=this.options.chunkSize;let c,u;if(this.ended)return!1;for(u=e===~~e?e:e===!0?zP:Lg,typeof r=="string"?n.input=Pf.string2buf(r):YP.call(r)==="[object ArrayBuffer]"?n.input=new Uint8Array(r):n.input=r,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(o),n.next_out=0,n.avail_out=o),(u===d3||u===PC)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(c=Ru.deflate(n,u),c===Mg)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),c=Ru.deflateEnd(this.strm),this.onEnd(c),this.ended=!0,c===Oh;if(n.avail_out!==0){if(u>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},Ug.prototype.onData=function(r){this.chunks.push(r)},Ug.prototype.onEnd=function(r){r===Oh&&(this.result=bh.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};var u3={Deflate:Ug,deflate:bb,deflateRaw:function(r,e){return(e=e||{}).raw=!0,bb(r,e)},gzip:function(r,e){return(e=e||{}).gzip=!0,bb(r,e)},constants:If};const sm=16209;var h3=function(r,e){let n,o,c,u,m,_,S,C,R,w,N,L,H,j,W,ee,re,fe,be,_e,ye,Le,Me,et;const at=r.state;n=r.next_in,Me=r.input,o=n+(r.avail_in-5),c=r.next_out,et=r.output,u=c-(e-r.avail_out),m=c+(r.avail_out-257),_=at.dmax,S=at.wsize,C=at.whave,R=at.wnext,w=at.window,N=at.hold,L=at.bits,H=at.lencode,j=at.distcode,W=(1<<at.lenbits)-1,ee=(1<<at.distbits)-1;e:do{L<15&&(N+=Me[n++]<<L,L+=8,N+=Me[n++]<<L,L+=8),re=H[N&W];t:for(;;){if(fe=re>>>24,N>>>=fe,L-=fe,fe=re>>>16&255,fe===0)et[c++]=65535&re;else{if(!(16&fe)){if(!(64&fe)){re=H[(65535&re)+(N&(1<<fe)-1)];continue t}if(32&fe){at.mode=16191;break e}r.msg="invalid literal/length code",at.mode=sm;break e}be=65535&re,fe&=15,fe&&(L<fe&&(N+=Me[n++]<<L,L+=8),be+=N&(1<<fe)-1,N>>>=fe,L-=fe),L<15&&(N+=Me[n++]<<L,L+=8,N+=Me[n++]<<L,L+=8),re=j[N&ee];n:for(;;){if(fe=re>>>24,N>>>=fe,L-=fe,fe=re>>>16&255,!(16&fe)){if(!(64&fe)){re=j[(65535&re)+(N&(1<<fe)-1)];continue n}r.msg="invalid distance code",at.mode=sm;break e}if(_e=65535&re,fe&=15,L<fe&&(N+=Me[n++]<<L,L+=8,L<fe&&(N+=Me[n++]<<L,L+=8)),_e+=N&(1<<fe)-1,_e>_){r.msg="invalid distance too far back",at.mode=sm;break e}if(N>>>=fe,L-=fe,fe=c-u,_e>fe){if(fe=_e-fe,fe>C&&at.sane){r.msg="invalid distance too far back",at.mode=sm;break e}if(ye=0,Le=w,R===0){if(ye+=S-fe,fe<be){be-=fe;do et[c++]=w[ye++];while(--fe);ye=c-_e,Le=et}}else if(R<fe){if(ye+=S+R-fe,fe-=R,fe<be){be-=fe;do et[c++]=w[ye++];while(--fe);if(ye=0,R<be){fe=R,be-=fe;do et[c++]=w[ye++];while(--fe);ye=c-_e,Le=et}}}else if(ye+=R-fe,fe<be){be-=fe;do et[c++]=w[ye++];while(--fe);ye=c-_e,Le=et}for(;be>2;)et[c++]=Le[ye++],et[c++]=Le[ye++],et[c++]=Le[ye++],be-=3;be&&(et[c++]=Le[ye++],be>1&&(et[c++]=Le[ye++]))}else{ye=c-_e;do et[c++]=et[ye++],et[c++]=et[ye++],et[c++]=et[ye++],be-=3;while(be>2);be&&(et[c++]=et[ye++],be>1&&(et[c++]=et[ye++]))}break}}break}}while(n<o&&c<m);be=L>>3,n-=be,L-=be<<3,N&=(1<<L)-1,r.next_in=n,r.next_out=c,r.avail_in=n<o?o-n+5:5-(n-o),r.avail_out=c<m?m-c+257:257-(c-m),at.hold=N,at.bits=L};const kC=15,p3=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),m3=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),xg=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Ob=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Vg=(r,e,n,o,c,u,m,_)=>{const S=_.bits;let C,R,w,N,L,H,j=0,W=0,ee=0,re=0,fe=0,be=0,_e=0,ye=0,Le=0,Me=0,et=null;const at=new Uint16Array(16),Zt=new Uint16Array(16);let Sn,gi,Yr,Mi=null;for(j=0;j<=kC;j++)at[j]=0;for(W=0;W<o;W++)at[e[n+W]]++;for(fe=S,re=kC;re>=1&&at[re]===0;re--);if(fe>re&&(fe=re),re===0)return c[u++]=20971520,c[u++]=20971520,_.bits=1,0;for(ee=1;ee<re&&at[ee]===0;ee++);for(fe<ee&&(fe=ee),ye=1,j=1;j<=kC;j++)if(ye<<=1,ye-=at[j],ye<0)return-1;if(ye>0&&(r===0||re!==1))return-1;for(Zt[1]=0,j=1;j<kC;j++)Zt[j+1]=Zt[j]+at[j];for(W=0;W<o;W++)e[n+W]!==0&&(m[Zt[e[n+W]]++]=W);if(r===0?(et=Mi=m,H=20):r===1?(et=p3,Mi=m3,H=257):(et=xg,Mi=Ob,H=0),Me=0,W=0,j=ee,L=u,be=fe,_e=0,w=-1,Le=1<<fe,N=Le-1,r===1&&Le>852||r===2&&Le>592)return 1;for(;;){Sn=j-_e,m[W]+1<H?(gi=0,Yr=m[W]):m[W]>=H?(gi=Mi[m[W]-H],Yr=et[m[W]-H]):(gi=96,Yr=0),C=1<<j-_e,R=1<<be,ee=R;do R-=C,c[L+(Me>>_e)+R]=Sn<<24|gi<<16|Yr|0;while(R!==0);for(C=1<<j-1;Me&C;)C>>=1;if(C!==0?(Me&=C-1,Me+=C):Me=0,W++,--at[j]==0){if(j===re)break;j=e[n+m[W]]}if(j>fe&&(Me&N)!==w){for(_e===0&&(_e=fe),L+=ee,be=j-_e,ye=1<<be;be+_e<re&&(ye-=at[be+_e],!(ye<=0));)be++,ye<<=1;if(Le+=1<<be,r===1&&Le>852||r===2&&Le>592)return 1;w=Me&N,c[w]=fe<<24|be<<16|L-u|0}}return Me!==0&&(c[L+Me]=j-_e<<24|64<<16|0),_.bits=fe,0};const{Z_FINISH:Fg,Z_BLOCK:f3,Z_TREES:om,Z_OK:am,Z_STREAM_END:_3,Z_NEED_DICT:E3,Z_STREAM_ERROR:td,Z_DATA_ERROR:kf,Z_MEM_ERROR:Nb,Z_BUF_ERROR:g3,Z_DEFLATED:jg}=If,vl=16180,LC=16190,yu=16191,ja=16192,MC=16194,Bg=16199,UC=16200,xC=16206,yr=16209,Gg=r=>(r>>>24&255)+(r>>>8&65280)+((65280&r)<<8)+((255&r)<<24);function Iu(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Au=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.mode<vl||e.mode>16211?1:0},VC=r=>{if(Au(r))return td;const e=r.state;return r.total_in=r.total_out=e.total=0,r.msg="",e.wrap&&(r.adler=1&e.wrap),e.mode=vl,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,am},Wg=r=>{if(Au(r))return td;const e=r.state;return e.wsize=0,e.whave=0,e.wnext=0,VC(r)},Hg=(r,e)=>{let n;if(Au(r))return td;const o=r.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?td:(o.window!==null&&o.wbits!==e&&(o.window=null),o.wrap=n,o.wbits=e,Wg(r))},FC=(r,e)=>{if(!r)return td;const n=new Iu;r.state=n,n.strm=r,n.window=null,n.mode=vl;const o=Hg(r,e);return o!==am&&(r.state=null),o};let Dr,jC,XP=!0;const cm=r=>{if(XP){Dr=new Int32Array(512),jC=new Int32Array(32);let e=0;for(;e<144;)r.lens[e++]=8;for(;e<256;)r.lens[e++]=9;for(;e<280;)r.lens[e++]=7;for(;e<288;)r.lens[e++]=8;for(Vg(1,r.lens,0,288,Dr,0,r.work,{bits:9}),e=0;e<32;)r.lens[e++]=5;Vg(2,r.lens,0,32,jC,0,r.work,{bits:5}),XP=!1}r.lencode=Dr,r.lenbits=9,r.distcode=jC,r.distbits=5},Db=(r,e,n,o)=>{let c;const u=r.state;return u.window===null&&(u.wsize=1<<u.wbits,u.wnext=0,u.whave=0,u.window=new Uint8Array(u.wsize)),o>=u.wsize?(u.window.set(e.subarray(n-u.wsize,n),0),u.wnext=0,u.whave=u.wsize):(c=u.wsize-u.wnext,c>o&&(c=o),u.window.set(e.subarray(n-o,n-o+c),u.wnext),(o-=c)?(u.window.set(e.subarray(n-o,n),0),u.wnext=o,u.whave=u.wsize):(u.wnext+=c,u.wnext===u.wsize&&(u.wnext=0),u.whave<u.wsize&&(u.whave+=c))),0};var QP=(r,e)=>{let n,o,c,u,m,_,S,C,R,w,N,L,H,j,W,ee,re,fe,be,_e,ye,Le,Me=0;const et=new Uint8Array(4);let at,Zt;const Sn=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Au(r)||!r.output||!r.input&&r.avail_in!==0)return td;n=r.state,n.mode===yu&&(n.mode=ja),m=r.next_out,c=r.output,S=r.avail_out,u=r.next_in,o=r.input,_=r.avail_in,C=n.hold,R=n.bits,w=_,N=S,Le=am;e:for(;;)switch(n.mode){case vl:if(n.wrap===0){n.mode=ja;break}for(;R<16;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(2&n.wrap&&C===35615){n.wbits===0&&(n.wbits=15),n.check=0,et[0]=255&C,et[1]=C>>>8&255,n.check=ro(n.check,et,2,0),C=0,R=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&C)<<8)+(C>>8))%31){r.msg="incorrect header check",n.mode=yr;break}if((15&C)!==jg){r.msg="unknown compression method",n.mode=yr;break}if(C>>>=4,R-=4,ye=8+(15&C),n.wbits===0&&(n.wbits=ye),ye>15||ye>n.wbits){r.msg="invalid window size",n.mode=yr;break}n.dmax=1<<n.wbits,n.flags=0,r.adler=n.check=1,n.mode=512&C?16189:yu,C=0,R=0;break;case 16181:for(;R<16;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(n.flags=C,(255&n.flags)!==jg){r.msg="unknown compression method",n.mode=yr;break}if(57344&n.flags){r.msg="unknown header flags set",n.mode=yr;break}n.head&&(n.head.text=C>>8&1),512&n.flags&&4&n.wrap&&(et[0]=255&C,et[1]=C>>>8&255,n.check=ro(n.check,et,2,0)),C=0,R=0,n.mode=16182;case 16182:for(;R<32;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}n.head&&(n.head.time=C),512&n.flags&&4&n.wrap&&(et[0]=255&C,et[1]=C>>>8&255,et[2]=C>>>16&255,et[3]=C>>>24&255,n.check=ro(n.check,et,4,0)),C=0,R=0,n.mode=16183;case 16183:for(;R<16;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}n.head&&(n.head.xflags=255&C,n.head.os=C>>8),512&n.flags&&4&n.wrap&&(et[0]=255&C,et[1]=C>>>8&255,n.check=ro(n.check,et,2,0)),C=0,R=0,n.mode=16184;case 16184:if(1024&n.flags){for(;R<16;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}n.length=C,n.head&&(n.head.extra_len=C),512&n.flags&&4&n.wrap&&(et[0]=255&C,et[1]=C>>>8&255,n.check=ro(n.check,et,2,0)),C=0,R=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&n.flags&&(L=n.length,L>_&&(L=_),L&&(n.head&&(ye=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(o.subarray(u,u+L),ye)),512&n.flags&&4&n.wrap&&(n.check=ro(n.check,o,L,u)),_-=L,u+=L,n.length-=L),n.length))break e;n.length=0,n.mode=16186;case 16186:if(2048&n.flags){if(_===0)break e;L=0;do ye=o[u+L++],n.head&&ye&&n.length<65536&&(n.head.name+=String.fromCharCode(ye));while(ye&&L<_);if(512&n.flags&&4&n.wrap&&(n.check=ro(n.check,o,L,u)),_-=L,u+=L,ye)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&n.flags){if(_===0)break e;L=0;do ye=o[u+L++],n.head&&ye&&n.length<65536&&(n.head.comment+=String.fromCharCode(ye));while(ye&&L<_);if(512&n.flags&&4&n.wrap&&(n.check=ro(n.check,o,L,u)),_-=L,u+=L,ye)break e}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&n.flags){for(;R<16;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(4&n.wrap&&C!==(65535&n.check)){r.msg="header crc mismatch",n.mode=yr;break}C=0,R=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),r.adler=n.check=0,n.mode=yu;break;case 16189:for(;R<32;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}r.adler=n.check=Gg(C),C=0,R=0,n.mode=LC;case LC:if(n.havedict===0)return r.next_out=m,r.avail_out=S,r.next_in=u,r.avail_in=_,n.hold=C,n.bits=R,E3;r.adler=n.check=1,n.mode=yu;case yu:if(e===f3||e===om)break e;case ja:if(n.last){C>>>=7&R,R-=7&R,n.mode=xC;break}for(;R<3;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}switch(n.last=1&C,C>>>=1,R-=1,3&C){case 0:n.mode=16193;break;case 1:if(cm(n),n.mode=Bg,e===om){C>>>=2,R-=2;break e}break;case 2:n.mode=16196;break;case 3:r.msg="invalid block type",n.mode=yr}C>>>=2,R-=2;break;case 16193:for(C>>>=7&R,R-=7&R;R<32;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if((65535&C)!=(C>>>16^65535)){r.msg="invalid stored block lengths",n.mode=yr;break}if(n.length=65535&C,C=0,R=0,n.mode=MC,e===om)break e;case MC:n.mode=16195;case 16195:if(L=n.length,L){if(L>_&&(L=_),L>S&&(L=S),L===0)break e;c.set(o.subarray(u,u+L),m),_-=L,u+=L,S-=L,m+=L,n.length-=L;break}n.mode=yu;break;case 16196:for(;R<14;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(n.nlen=257+(31&C),C>>>=5,R-=5,n.ndist=1+(31&C),C>>>=5,R-=5,n.ncode=4+(15&C),C>>>=4,R-=4,n.nlen>286||n.ndist>30){r.msg="too many length or distance symbols",n.mode=yr;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;R<3;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}n.lens[Sn[n.have++]]=7&C,C>>>=3,R-=3}for(;n.have<19;)n.lens[Sn[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,at={bits:n.lenbits},Le=Vg(0,n.lens,0,19,n.lencode,0,n.work,at),n.lenbits=at.bits,Le){r.msg="invalid code lengths set",n.mode=yr;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;Me=n.lencode[C&(1<<n.lenbits)-1],W=Me>>>24,ee=Me>>>16&255,re=65535&Me,!(W<=R);){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(re<16)C>>>=W,R-=W,n.lens[n.have++]=re;else{if(re===16){for(Zt=W+2;R<Zt;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(C>>>=W,R-=W,n.have===0){r.msg="invalid bit length repeat",n.mode=yr;break}ye=n.lens[n.have-1],L=3+(3&C),C>>>=2,R-=2}else if(re===17){for(Zt=W+3;R<Zt;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}C>>>=W,R-=W,ye=0,L=3+(7&C),C>>>=3,R-=3}else{for(Zt=W+7;R<Zt;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}C>>>=W,R-=W,ye=0,L=11+(127&C),C>>>=7,R-=7}if(n.have+L>n.nlen+n.ndist){r.msg="invalid bit length repeat",n.mode=yr;break}for(;L--;)n.lens[n.have++]=ye}}if(n.mode===yr)break;if(n.lens[256]===0){r.msg="invalid code -- missing end-of-block",n.mode=yr;break}if(n.lenbits=9,at={bits:n.lenbits},Le=Vg(1,n.lens,0,n.nlen,n.lencode,0,n.work,at),n.lenbits=at.bits,Le){r.msg="invalid literal/lengths set",n.mode=yr;break}if(n.distbits=6,n.distcode=n.distdyn,at={bits:n.distbits},Le=Vg(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,at),n.distbits=at.bits,Le){r.msg="invalid distances set",n.mode=yr;break}if(n.mode=Bg,e===om)break e;case Bg:n.mode=UC;case UC:if(_>=6&&S>=258){r.next_out=m,r.avail_out=S,r.next_in=u,r.avail_in=_,n.hold=C,n.bits=R,h3(r,N),m=r.next_out,c=r.output,S=r.avail_out,u=r.next_in,o=r.input,_=r.avail_in,C=n.hold,R=n.bits,n.mode===yu&&(n.back=-1);break}for(n.back=0;Me=n.lencode[C&(1<<n.lenbits)-1],W=Me>>>24,ee=Me>>>16&255,re=65535&Me,!(W<=R);){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(ee&&!(240&ee)){for(fe=W,be=ee,_e=re;Me=n.lencode[_e+((C&(1<<fe+be)-1)>>fe)],W=Me>>>24,ee=Me>>>16&255,re=65535&Me,!(fe+W<=R);){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}C>>>=fe,R-=fe,n.back+=fe}if(C>>>=W,R-=W,n.back+=W,n.length=re,ee===0){n.mode=16205;break}if(32&ee){n.back=-1,n.mode=yu;break}if(64&ee){r.msg="invalid literal/length code",n.mode=yr;break}n.extra=15&ee,n.mode=16201;case 16201:if(n.extra){for(Zt=n.extra;R<Zt;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}n.length+=C&(1<<n.extra)-1,C>>>=n.extra,R-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;Me=n.distcode[C&(1<<n.distbits)-1],W=Me>>>24,ee=Me>>>16&255,re=65535&Me,!(W<=R);){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(!(240&ee)){for(fe=W,be=ee,_e=re;Me=n.distcode[_e+((C&(1<<fe+be)-1)>>fe)],W=Me>>>24,ee=Me>>>16&255,re=65535&Me,!(fe+W<=R);){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}C>>>=fe,R-=fe,n.back+=fe}if(C>>>=W,R-=W,n.back+=W,64&ee){r.msg="invalid distance code",n.mode=yr;break}n.offset=re,n.extra=15&ee,n.mode=16203;case 16203:if(n.extra){for(Zt=n.extra;R<Zt;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}n.offset+=C&(1<<n.extra)-1,C>>>=n.extra,R-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){r.msg="invalid distance too far back",n.mode=yr;break}n.mode=16204;case 16204:if(S===0)break e;if(L=N-S,n.offset>L){if(L=n.offset-L,L>n.whave&&n.sane){r.msg="invalid distance too far back",n.mode=yr;break}L>n.wnext?(L-=n.wnext,H=n.wsize-L):H=n.wnext-L,L>n.length&&(L=n.length),j=n.window}else j=c,H=m-n.offset,L=n.length;L>S&&(L=S),S-=L,n.length-=L;do c[m++]=j[H++];while(--L);n.length===0&&(n.mode=UC);break;case 16205:if(S===0)break e;c[m++]=n.length,S--,n.mode=UC;break;case xC:if(n.wrap){for(;R<32;){if(_===0)break e;_--,C|=o[u++]<<R,R+=8}if(N-=S,r.total_out+=N,n.total+=N,4&n.wrap&&N&&(r.adler=n.check=n.flags?ro(n.check,c,N,m-N):yf(n.check,c,N,m-N)),N=S,4&n.wrap&&(n.flags?C:Gg(C))!==n.check){r.msg="incorrect data check",n.mode=yr;break}C=0,R=0}n.mode=16207;case 16207:if(n.wrap&&n.flags){for(;R<32;){if(_===0)break e;_--,C+=o[u++]<<R,R+=8}if(4&n.wrap&&C!==(4294967295&n.total)){r.msg="incorrect length check",n.mode=yr;break}C=0,R=0}n.mode=16208;case 16208:Le=_3;break e;case yr:Le=kf;break e;case 16210:return Nb;default:return td}return r.next_out=m,r.avail_out=S,r.next_in=u,r.avail_in=_,n.hold=C,n.bits=R,(n.wsize||N!==r.avail_out&&n.mode<yr&&(n.mode<xC||e!==Fg))&&Db(r,r.output,r.next_out,N-r.avail_out),w-=r.avail_in,N-=r.avail_out,r.total_in+=w,r.total_out+=N,n.total+=N,4&n.wrap&&N&&(r.adler=n.check=n.flags?ro(n.check,c,N,r.next_out-N):yf(n.check,c,N,r.next_out-N)),r.data_type=n.bits+(n.last?64:0)+(n.mode===yu?128:0)+(n.mode===Bg||n.mode===MC?256:0),(w===0&&N===0||e===Fg)&&Le===am&&(Le=g3),Le},Rl={inflateReset:Wg,inflateReset2:Hg,inflateResetKeep:VC,inflateInit:r=>FC(r,15),inflateInit2:FC,inflate:QP,inflateEnd:r=>{if(Au(r))return td;let e=r.state;return e.window&&(e.window=null),r.state=null,am},inflateGetHeader:(r,e)=>{if(Au(r))return td;const n=r.state;return 2&n.wrap?(n.head=e,e.done=!1,am):td},inflateSetDictionary:(r,e)=>{const n=e.length;let o,c,u;return Au(r)?td:(o=r.state,o.wrap!==0&&o.mode!==LC?td:o.mode===LC&&(c=1,c=yf(c,e,n,0),c!==o.check)?kf:(u=Db(r,e,n,n),u?(o.mode=16210,Nb):(o.havedict=1,am)))},inflateInfo:"pako inflate (from Nodeca project)"},ZP=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const BC=Object.prototype.toString,{Z_NO_FLUSH:Pb,Z_FINISH:$P,Z_OK:Kg,Z_STREAM_END:GC,Z_NEED_DICT:kb,Z_STREAM_ERROR:wu,Z_DATA_ERROR:ek,Z_MEM_ERROR:tk}=If;function Yg(r){this.options=bh.assign({chunkSize:65536,windowBits:15,to:""},r||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||r&&r.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new KP,this.strm.avail_out=0;let n=Rl.inflateInit2(this.strm,e.windowBits);if(n!==Kg)throw new Error(Ih[n]);if(this.header=new ZP,Rl.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=Pf.string2buf(e.dictionary):BC.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=Rl.inflateSetDictionary(this.strm,e.dictionary),n!==Kg)))throw new Error(Ih[n])}function Lb(r,e){const n=new Yg(e);if(n.push(r),n.err)throw n.msg||Ih[n.err];return n.result}Yg.prototype.push=function(r,e){const n=this.strm,o=this.options.chunkSize,c=this.options.dictionary;let u,m,_;if(this.ended)return!1;for(m=e===~~e?e:e===!0?$P:Pb,BC.call(r)==="[object ArrayBuffer]"?n.input=new Uint8Array(r):n.input=r,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(o),n.next_out=0,n.avail_out=o),u=Rl.inflate(n,m),u===kb&&c&&(u=Rl.inflateSetDictionary(n,c),u===Kg?u=Rl.inflate(n,m):u===ek&&(u=kb));n.avail_in>0&&u===GC&&n.state.wrap>0&&r[n.next_in]!==0;)Rl.inflateReset(n),u=Rl.inflate(n,m);switch(u){case wu:case ek:case kb:case tk:return this.onEnd(u),this.ended=!0,!1}if(_=n.avail_out,n.next_out&&(n.avail_out===0||u===GC))if(this.options.to==="string"){let S=Pf.utf8border(n.output,n.next_out),C=n.next_out-S,R=Pf.buf2string(n.output,S);n.next_out=C,n.avail_out=o-C,C&&n.output.set(n.output.subarray(S,S+C),0),this.onData(R)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(u!==Kg||_!==0){if(u===GC)return u=Rl.inflateEnd(this.strm),this.onEnd(u),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},Yg.prototype.onData=function(r){this.chunks.push(r)},Yg.prototype.onEnd=function(r){r===Kg&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=bh.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};var zg={Inflate:Yg,inflate:Lb,inflateRaw:function(r,e){return(e=e||{}).raw=!0,Lb(r,e)},ungzip:Lb,constants:If};const{Deflate:nk,deflate:Mb,deflateRaw:t5,gzip:S3}=u3,{Inflate:n5,inflate:qg,inflateRaw:ik,ungzip:i5}=zg;var rk,T3=Mb,r5=qg;(function(r){r[r.ONE_BYTE=0]="ONE_BYTE",r[r.TWO_BYTE=1]="TWO_BYTE"})(rk||(rk={}));class s5{constructor(){D(this,"_sequence",0),D(this,"_startTime",Date.now()),D(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const _=new Uint8Array(4);_.set([1,0,0,0]);const S={id:0,length:4,data:_.buffer},C={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[S]};n.commonPacketHeader.extension=1,n.extension=C,n.payload=this.compress(e),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;oe("SHOW_DATASTREAM2_LOG")&&M.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const o=new ArrayBuffer(n.commonPacketHeader.length),c=new Uint8Array(o),u=new DataView(o);let m=0;if(u.setUint16(m,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),m+=2,u.setUint32(m,n.commonPacketHeader.sequence,!0),m+=4,u.setUint16(m,n.commonStreamHeader,!0),m+=2,n.extension){const _=this.serializeExtension(n.extension);c.set(new Uint8Array(_),m),m+=_.byteLength}if(c.set(new Uint8Array(n.payload),m),m+=n.payload.byteLength,m!==n.commonPacketHeader.length)throw Error("serialize error!");return o}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const n=new DataView(e);let o=0;const c=n.getUint16(o,!0);o+=2;const u={length:16383&c,reserved:(16384&c)>>14,extension:(32768&c)>>15,sequence:n.getUint16(o+2,!0)<<16|n.getUint16(o,!0)};let m,_;if(o+=4,oe("SHOW_DATASTREAM2_LOG")&&M.debug("receive data header: ".concat(JSON.stringify(u))),n.getUint16(o,!0),o+=2,u.extension){_=this.deserializeExtension(e.slice(o)),o+=2+_.length,m=e.slice(o);let S=!1;if(_.datas.length>0){const C=_.datas.find(R=>R.id===0);C&&(S=(1&new DataView(C.data).getUint32(0,!0))==1)}m=S?this.decompress(m):m}else m=e.slice(8);return m}serializeExtension(e){const{profile:n,length:o,datas:c}=e,u=new ArrayBuffer(o+2),m=new Uint8Array(u),_=new DataView(u);let S=0;if(_.setUint8(S++,n),_.setUint8(S++,o),c.forEach(C=>{n?(_.setUint8(S++,C.id),_.setUint8(S++,C.length),m.set(new Uint8Array(C.data),S),S+=C.data.byteLength):(_.setUint8(S++,C.id|C.length<<4),m.set(new Uint8Array(C.data),S),S+=C.data.byteLength)}),S!==o+2)throw Error("serialize extension error, is ".concat(S,"!==").concat(o+2));return u}deserializeExtension(e){const n=new DataView(e);let o=0;const c=n.getUint8(o);o++;const u=n.getUint8(o);o++;const m=c===rk.TWO_BYTE,_=[],S=new DataView(e,2);let C=0;for(;C<u;){let R=0,w=0,N=new ArrayBuffer(0);m?(R=S.getUint8(C),C++,w=S.getUint8(C),C++):(R=15&S.getUint8(C),w=S.getUint8(C)>>4,C++),w>0&&(N=S.buffer.slice(C+2,C+2+w),C+=N.byteLength),_.push({id:R,length:w,data:N})}if(C!==u)throw Error("parse error");return{profile:c,length:u,datas:_}}decompress(e){return r5(new Uint8Array(e))}compress(e){return T3(new Uint8Array(e))}}class C3 extends Dt{constructor(e,n){super(),D(this,"_version",1),D(this,"_type",3),D(this,"_config",void 0),D(this,"_originDataChannel",void 0),D(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),D(this,"_dataStreamPacketHandler",void 0),D(this,"_datachannelEventMap",new Map),this._config=e,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader(),this._dataStreamPacketHandler=new s5}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return oe("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Ee((e,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();const o=setTimeout(()=>{var c;n(new ke(Q.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((c=this._originDataChannel)===null||c===void 0?void 0:c.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(o),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(o),new ke(Q.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new ke(Q.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[qc.OPEN,qc.CLOSE,qc.ERROR].forEach(n=>{const o=()=>{this.emit(n)};this._datachannelEventMap.set(n,o),e.addEventListener(n,o)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[o,c]=n;e.removeEventListener(o,c)}),this._datachannelEventMap.clear()}}class v3 extends C3{constructor(e){super(e),D(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const o=n.data.slice(0,this._dataStreamPacketHeader.byteLength),c=new DataView(o).getUint8(3);if(c!==this.id)return void(oe("SHOW_DATASTREAM2_LOG")&&M.debug("invalid datachannel id: ".concat(c," !== ").concat(this.id)));let u=n.data.slice(this._dataStreamPacketHeader.byteLength);u=this._dataStreamPacketHandler.deserialize(u),this.emit(qc.MESSAGE,u)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class R3 extends C3{send(e){if(this._originDataChannel){let n=e;n=this._dataStreamPacketHandler.serialize(e);const o=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);o.set(new Uint8Array(this._dataStreamPacketHeader),0),o.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(o.buffer)}}}var o5=O,Ub=wn("iterator"),xb=!o5(function(){var r=new URL("b?a=1&b=2&c=3","http://a"),e=r.searchParams,n=new URLSearchParams("a=1&a=2"),o="";return r.pathname="c%20d",e.forEach(function(c,u){e.delete("b"),o+=u+c}),n.delete("a",2),!r.toJSON||!n.has("a",1)||n.has("a",2)||!e.size&&!0||!e.sort||r.href!=="http://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[Ub]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("http://тест").host!=="xn--e1aybc"||new URL("http://a#б").hash!=="#%D0%B1"||o!=="a1c3"||new URL("http://x",void 0).host!=="x"}),y3=Vc,Vb=Xt,dm=Fe,WC=Nt,Ld=ae,Lf=ii,Fb=xb,Is=Vc,jb=aE,nn=function(r,e,n){for(var o in e)n&&n.unsafe&&r[o]?r[o]=e[o]:y3(r,o,e[o],n);return r},I3=nc,A3=vO,Bb=Bl,sk=hA,Jg=Ft,ok=ji,w3=xc,Xg=Pa,Ca=ls,Gb=qr,va=Bs,b3=Yu,ak=sr,Qg=oA,ck=iT,Mf=jE,O3=nT,N3=wn("iterator"),lm="URLSearchParams",Wb=lm+"Iterator",dk=Bb.set,_c=Bb.getterFor(lm),D3=Bb.getterFor(Wb),P3=Object.getOwnPropertyDescriptor,HC=function(r){if(!Lf)return dm[r];var e=P3(dm,r);return e&&e.value},Ci=HC("fetch"),Ra=HC("Request"),Uf=HC("Headers"),Zg=Ra&&Ra.prototype,Md=Uf&&Uf.prototype,$g=dm.RegExp,lk=dm.TypeError,Hb=dm.decodeURIComponent,uk=dm.encodeURIComponent,hk=Ld("".charAt),Kb=Ld([].join),Nh=Ld([].push),eS=Ld("".replace),pk=Ld([].shift),mk=Ld([].splice),fk=Ld("".split),_k=Ld("".slice),um=/\+/g,Yb=Array(4),k3=function(r){return Yb[r-1]||(Yb[r-1]=$g("((?:%[\\da-f]{2}){"+r+"})","gi"))},KC=function(r){try{return Hb(r)}catch{return r}},zb=function(r){var e=eS(r,um," "),n=4;try{return Hb(e)}catch{for(;n;)e=eS(e,k3(n--),KC);return e}},Ek=/[!'()~]|%20/g,tS={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},Ud=function(r){return tS[r]},YC=function(r){return eS(uk(r),Ek,Ud)},zC=A3(function(r,e){dk(this,{type:Wb,iterator:Qg(_c(r).entries),kind:e})},"Iterator",function(){var r=D3(this),e=r.kind,n=r.iterator.next(),o=n.value;return n.done||(n.value=e==="keys"?o.key:e==="values"?o.value:[o.key,o.value]),n},!0),xo=function(r){this.entries=[],this.url=null,r!==void 0&&(Gb(r)?this.parseObject(r):this.parseQuery(typeof r=="string"?hk(r,0)==="?"?_k(r,1):r:va(r)))};xo.prototype={type:lm,bindURL:function(r){this.url=r,this.update()},parseObject:function(r){var e,n,o,c,u,m,_,S=ck(r);if(S)for(n=(e=Qg(r,S)).next;!(o=WC(n,e)).done;){if(u=(c=Qg(Ca(o.value))).next,(m=WC(u,c)).done||(_=WC(u,c)).done||!WC(u,c).done)throw lk("Expected sequence with length 2");Nh(this.entries,{key:va(m.value),value:va(_.value)})}else for(var C in r)ok(r,C)&&Nh(this.entries,{key:C,value:va(r[C])})},parseQuery:function(r){if(r)for(var e,n,o=fk(r,"&"),c=0;c<o.length;)(e=o[c++]).length&&(n=fk(e,"="),Nh(this.entries,{key:zb(pk(n)),value:zb(Kb(n,"="))}))},serialize:function(){for(var r,e=this.entries,n=[],o=0;o<e.length;)r=e[o++],Nh(n,YC(r.key)+"="+YC(r.value));return Kb(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var xd=function(){sk(this,bu);var r=dk(this,new xo(arguments.length>0?arguments[0]:void 0));Lf||(this.size=r.entries.length)},bu=xd.prototype;if(nn(bu,{append:function(r,e){var n=_c(this);Mf(arguments.length,2),Nh(n.entries,{key:va(r),value:va(e)}),Lf||this.length++,n.updateURL()},delete:function(r){for(var e=_c(this),n=Mf(arguments.length,1),o=e.entries,c=va(r),u=n<2?void 0:arguments[1],m=u===void 0?u:va(u),_=0;_<o.length;){var S=o[_];if(S.key!==c||m!==void 0&&S.value!==m)_++;else if(mk(o,_,1),m!==void 0)break}Lf||(this.size=o.length),e.updateURL()},get:function(r){var e=_c(this).entries;Mf(arguments.length,1);for(var n=va(r),o=0;o<e.length;o++)if(e[o].key===n)return e[o].value;return null},getAll:function(r){var e=_c(this).entries;Mf(arguments.length,1);for(var n=va(r),o=[],c=0;c<e.length;c++)e[c].key===n&&Nh(o,e[c].value);return o},has:function(r){for(var e=_c(this).entries,n=Mf(arguments.length,1),o=va(r),c=n<2?void 0:arguments[1],u=c===void 0?c:va(c),m=0;m<e.length;){var _=e[m++];if(_.key===o&&(u===void 0||_.value===u))return!0}return!1},set:function(r,e){var n=_c(this);Mf(arguments.length,1);for(var o,c=n.entries,u=!1,m=va(r),_=va(e),S=0;S<c.length;S++)(o=c[S]).key===m&&(u?mk(c,S--,1):(u=!0,o.value=_));u||Nh(c,{key:m,value:_}),Lf||(this.size=c.length),n.updateURL()},sort:function(){var r=_c(this);O3(r.entries,function(e,n){return e.key>n.key?1:-1}),r.updateURL()},forEach:function(r){for(var e,n=_c(this).entries,o=w3(r,arguments.length>1?arguments[1]:void 0),c=0;c<n.length;)o((e=n[c++]).value,e.key,this)},keys:function(){return new zC(this,"keys")},values:function(){return new zC(this,"values")},entries:function(){return new zC(this,"entries")}},{enumerable:!0}),Is(bu,N3,bu.entries,{name:"entries"}),Is(bu,"toString",function(){return _c(this).serialize()},{enumerable:!0}),Lf&&jb(bu,"size",{get:function(){return _c(this).entries.length},configurable:!0,enumerable:!0}),I3(xd,lm),Vb({global:!0,constructor:!0,forced:!Fb},{URLSearchParams:xd}),!Fb&&Jg(Uf)){var qC=Ld(Md.has),qb=Ld(Md.set),hm=function(r){if(Gb(r)){var e,n=r.body;if(Xg(n)===lm)return e=r.headers?new Uf(r.headers):new Uf,qC(e,"content-type")||qb(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),b3(r,{body:ak(0,va(n)),headers:ak(0,e)})}return r};if(Jg(Ci)&&Vb({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(r){return Ci(r,arguments.length>1?hm(arguments[1]):{})}}),Jg(Ra)){var nS=function(r){return sk(this,Zg),new Ra(r,arguments.length>1?hm(arguments[1]):{})};Zg.constructor=nS,nS.prototype=Zg,Vb({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:nS})}}var Ba,gk={URLSearchParams:xd,getState:_c},Ec=ii,xf=ae,Vd=Nt,iS=O,Ou=km,Sk=zu,L3=cn,Tk=Oo,Dh=Pm,oo=Object.assign,gc=Object.defineProperty,Jb=xf([].concat),rS=!oo||iS(function(){if(Ec&&oo({b:1},oo(gc({},"a",{enumerable:!0,get:function(){gc(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var r={},e={},n=Symbol(),o="abcdefghijklmnopqrst";return r[n]=7,o.split("").forEach(function(c){e[c]=c}),oo({},r)[n]!=7||Ou(oo({},e)).join("")!=o})?function(r,e){for(var n=Tk(r),o=arguments.length,c=1,u=Sk.f,m=L3.f;o>c;)for(var _,S=Dh(arguments[c++]),C=u?Jb(Ou(S),u(S)):Ou(S),R=C.length,w=0;R>w;)_=C[w++],Ec&&!Vd(m,S,_)||(n[_]=S[_]);return n}:oo,Ck=ls,Kr=bN,Ph=xc,Ls=Nt,Vf=Oo,Xb=function(r,e,n,o){try{return o?e(Ck(n)[0],n[1]):e(n)}catch(c){Kr(r,"throw",c)}},Nu=RN,Sc=KS,Qb=Da,ya=HS,Du=oA,pm=iT,ln=Array,kh=ae,JC=2147483647,ms=/[^\0-\u007E]/,Ga=/[.\u3002\uFF0E\uFF61]/g,vk="Overflow: input needs wider integers to process",Zb=RangeError,XC=kh(Ga.exec),nr=Math.floor,Tc=String.fromCharCode,$b=kh("".charCodeAt),Lh=kh([].join),nd=kh([].push),Rk=kh("".replace),sS=kh("".split),M3=kh("".toLowerCase),e0=function(r){return r+22+75*(r<26)},Vo=function(r,e,n){var o=0;for(r=n?nr(r/700):r>>1,r+=nr(r/e);r>455;)r=nr(r/35),o+=36;return nr(o+36*r/(r+38))},U3=function(r){var e=[];r=function(ee){for(var re=[],fe=0,be=ee.length;fe<be;){var _e=$b(ee,fe++);if(_e>=55296&&_e<=56319&&fe<be){var ye=$b(ee,fe++);(64512&ye)==56320?nd(re,((1023&_e)<<10)+(1023&ye)+65536):(nd(re,_e),fe--)}else nd(re,_e)}return re}(r);var n,o,c=r.length,u=128,m=0,_=72;for(n=0;n<r.length;n++)(o=r[n])<128&&nd(e,Tc(o));var S=e.length,C=S;for(S&&nd(e,"-");C<c;){var R=JC;for(n=0;n<r.length;n++)(o=r[n])>=u&&o<R&&(R=o);var w=C+1;if(R-u>nr((JC-m)/w))throw Zb(vk);for(m+=(R-u)*w,u=R,n=0;n<r.length;n++){if((o=r[n])<u&&++m>JC)throw Zb(vk);if(o==u){for(var N=m,L=36;;){var H=L<=_?1:L>=_+26?26:L-_;if(N<H)break;var j=N-H,W=36-H;nd(e,Tc(e0(H+j%W))),N=nr(j/W),L+=36}nd(e,Tc(e0(N))),_=Vo(m,w,C==S),m=0,C++}}m++,u++}return Lh(e,"")},QC=Xt,ZC=ii,x3=xb,t0=Fe,oS=xc,Cc=ae,aS=Vc,vc=aE,yk=hA,$C=ji,Pr=rS,vo=function(r){var e=Vf(r),n=Sc(this),o=arguments.length,c=o>1?arguments[1]:void 0,u=c!==void 0;u&&(c=Ph(c,o>2?arguments[2]:void 0));var m,_,S,C,R,w,N=pm(e),L=0;if(!N||this===ln&&Nu(N))for(m=Qb(e),_=n?new this(m):ln(m);m>L;L++)w=u?c(e[L],L):e[L],ya(_,L,w);else for(R=(C=Du(e,N)).next,_=n?new this:[];!(S=Ls(R,C)).done;L++)w=u?Xb(C,c,[S.value,L],!0):S.value,ya(_,L,w);return _.length=L,_},id=YS,Mh=zO.codeAt,cS=function(r){var e,n,o=[],c=sS(Rk(M3(r),Ga,"."),".");for(e=0;e<c.length;e++)n=c[e],nd(o,XC(ms,n)?"xn--"+U3(n):n);return Lh(o,".")},yl=Bs,Ik=nc,Ff=jE,zi=gk,Zo=Bl,Ak=Zo.set,dS=Zo.getterFor("URL"),wk=zi.URLSearchParams,ev=zi.getState,mm=t0.URL,lS=t0.TypeError,tv=t0.parseInt,bk=Math.floor,uS=Math.pow,qi=Cc("".charAt),kr=Cc(/./.exec),jf=Cc([].join),nv=Cc(1 .toString),Lr=Cc([].pop),ao=Cc([].push),iv=Cc("".replace),Uh=Cc([].shift),Ok=Cc("".split),xh=Cc("".slice),Ir=Cc("".toLowerCase),Xs=Cc([].unshift),n0="Invalid scheme",fm="Invalid host",Nk="Invalid port",Dk=/[a-z]/i,V3=/[\d+-.a-z]/i,rv=/\d/,F3=/^0x/i,i0=/^[0-7]+$/,$o=/^\d+$/,_m=/^[\da-f]+$/i,Pk=/[\0\t\n\r #%/:<>?@[\\\]^|]/,kk=/[\0\t\n\r #/:<>?@[\\\]^|]/,j3=/^[\u0000-\u0020]+/,r0=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,Lk=/[\t\n\r]/g,Il=function(r){var e,n,o,c;if(typeof r=="number"){for(e=[],n=0;n<4;n++)Xs(e,r%256),r=bk(r/256);return jf(e,".")}if(typeof r=="object"){for(e="",o=function(u){for(var m=null,_=1,S=null,C=0,R=0;R<8;R++)u[R]!==0?(C>_&&(m=S,_=C),S=null,C=0):(S===null&&(S=R),++C);return C>_&&(m=S,_=C),m}(r),n=0;n<8;n++)c&&r[n]===0||(c&&(c=!1),o===n?(e+=n?":":"::",c=!0):(e+=nv(r[n],16),n<7&&(e+=":")));return"["+e+"]"}return r},Bf={},s0=Pr({},Bf,{" ":1,'"':1,"<":1,">":1,"`":1}),Fd=Pr({},s0,{"#":1,"?":1,"{":1,"}":1}),o0=Pr({},Fd,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Pu=function(r,e){var n=Mh(r,0);return n>32&&n<127&&!$C(e,r)?r:encodeURIComponent(r)},hS={ftp:21,file:null,http:80,https:443,ws:80,wss:443},Em=function(r,e){var n;return r.length==2&&kr(Dk,qi(r,0))&&((n=qi(r,1))==":"||!e&&n=="|")},sv=function(r){var e;return r.length>1&&Em(xh(r,0,2))&&(r.length==2||(e=qi(r,2))==="/"||e==="\\"||e==="?"||e==="#")},Al=function(r){return r==="."||Ir(r)==="%2e"},Fn={},ku={},ov={},Mk={},pS={},a0={},Uk={},xk={},Lu={},av={},mS={},c0={},Gf={},cv={},d0={},dv={},Rc={},Ms={},l0={},jd={},fi={},u0=function(r,e,n){var o,c,u,m=yl(r);if(e){if(c=this.parse(m))throw lS(c);this.searchParams=null}else{if(n!==void 0&&(o=new u0(n,!0)),c=this.parse(m,null,o))throw lS(c);(u=ev(new wk)).bindURL(this),this.searchParams=u}};u0.prototype={type:"URL",parse:function(r,e,n){var o,c,u,m,_,S=this,C=e||Fn,R=0,w="",N=!1,L=!1,H=!1;for(r=yl(r),e||(S.scheme="",S.username="",S.password="",S.host=null,S.port=null,S.path=[],S.query=null,S.fragment=null,S.cannotBeABaseURL=!1,r=iv(r,j3,""),r=iv(r,r0,"$1")),r=iv(r,Lk,""),o=vo(r);R<=o.length;){switch(c=o[R],C){case Fn:if(!c||!kr(Dk,c)){if(e)return n0;C=ov;continue}w+=Ir(c),C=ku;break;case ku:if(c&&(kr(V3,c)||c=="+"||c=="-"||c=="."))w+=Ir(c);else{if(c!=":"){if(e)return n0;w="",C=ov,R=0;continue}if(e&&(S.isSpecial()!=$C(hS,w)||w=="file"&&(S.includesCredentials()||S.port!==null)||S.scheme=="file"&&!S.host))return;if(S.scheme=w,e)return void(S.isSpecial()&&hS[S.scheme]==S.port&&(S.port=null));w="",S.scheme=="file"?C=cv:S.isSpecial()&&n&&n.scheme==S.scheme?C=Mk:S.isSpecial()?C=xk:o[R+1]=="/"?(C=pS,R++):(S.cannotBeABaseURL=!0,ao(S.path,""),C=l0)}break;case ov:if(!n||n.cannotBeABaseURL&&c!="#")return n0;if(n.cannotBeABaseURL&&c=="#"){S.scheme=n.scheme,S.path=id(n.path),S.query=n.query,S.fragment="",S.cannotBeABaseURL=!0,C=fi;break}C=n.scheme=="file"?cv:a0;continue;case Mk:if(c!="/"||o[R+1]!="/"){C=a0;continue}C=Lu,R++;break;case pS:if(c=="/"){C=av;break}C=Ms;continue;case a0:if(S.scheme=n.scheme,c==Ba)S.username=n.username,S.password=n.password,S.host=n.host,S.port=n.port,S.path=id(n.path),S.query=n.query;else if(c=="/"||c=="\\"&&S.isSpecial())C=Uk;else if(c=="?")S.username=n.username,S.password=n.password,S.host=n.host,S.port=n.port,S.path=id(n.path),S.query="",C=jd;else{if(c!="#"){S.username=n.username,S.password=n.password,S.host=n.host,S.port=n.port,S.path=id(n.path),S.path.length--,C=Ms;continue}S.username=n.username,S.password=n.password,S.host=n.host,S.port=n.port,S.path=id(n.path),S.query=n.query,S.fragment="",C=fi}break;case Uk:if(!S.isSpecial()||c!="/"&&c!="\\"){if(c!="/"){S.username=n.username,S.password=n.password,S.host=n.host,S.port=n.port,C=Ms;continue}C=av}else C=Lu;break;case xk:if(C=Lu,c!="/"||qi(w,R+1)!="/")continue;R++;break;case Lu:if(c!="/"&&c!="\\"){C=av;continue}break;case av:if(c=="@"){N&&(w="%40"+w),N=!0,u=vo(w);for(var j=0;j<u.length;j++){var W=u[j];if(W!=":"||H){var ee=Pu(W,o0);H?S.password+=ee:S.username+=ee}else H=!0}w=""}else if(c==Ba||c=="/"||c=="?"||c=="#"||c=="\\"&&S.isSpecial()){if(N&&w=="")return"Invalid authority";R-=vo(w).length+1,w="",C=mS}else w+=c;break;case mS:case c0:if(e&&S.scheme=="file"){C=dv;continue}if(c!=":"||L){if(c==Ba||c=="/"||c=="?"||c=="#"||c=="\\"&&S.isSpecial()){if(S.isSpecial()&&w=="")return fm;if(e&&w==""&&(S.includesCredentials()||S.port!==null))return;if(m=S.parseHost(w))return m;if(w="",C=Rc,e)return;continue}c=="["?L=!0:c=="]"&&(L=!1),w+=c}else{if(w=="")return fm;if(m=S.parseHost(w))return m;if(w="",C=Gf,e==c0)return}break;case Gf:if(!kr(rv,c)){if(c==Ba||c=="/"||c=="?"||c=="#"||c=="\\"&&S.isSpecial()||e){if(w!=""){var re=tv(w,10);if(re>65535)return Nk;S.port=S.isSpecial()&&re===hS[S.scheme]?null:re,w=""}if(e)return;C=Rc;continue}return Nk}w+=c;break;case cv:if(S.scheme="file",c=="/"||c=="\\")C=d0;else{if(!n||n.scheme!="file"){C=Ms;continue}if(c==Ba)S.host=n.host,S.path=id(n.path),S.query=n.query;else if(c=="?")S.host=n.host,S.path=id(n.path),S.query="",C=jd;else{if(c!="#"){sv(jf(id(o,R),""))||(S.host=n.host,S.path=id(n.path),S.shortenPath()),C=Ms;continue}S.host=n.host,S.path=id(n.path),S.query=n.query,S.fragment="",C=fi}}break;case d0:if(c=="/"||c=="\\"){C=dv;break}n&&n.scheme=="file"&&!sv(jf(id(o,R),""))&&(Em(n.path[0],!0)?ao(S.path,n.path[0]):S.host=n.host),C=Ms;continue;case dv:if(c==Ba||c=="/"||c=="\\"||c=="?"||c=="#"){if(!e&&Em(w))C=Ms;else if(w==""){if(S.host="",e)return;C=Rc}else{if(m=S.parseHost(w))return m;if(S.host=="localhost"&&(S.host=""),e)return;w="",C=Rc}continue}w+=c;break;case Rc:if(S.isSpecial()){if(C=Ms,c!="/"&&c!="\\")continue}else if(e||c!="?")if(e||c!="#"){if(c!=Ba&&(C=Ms,c!="/"))continue}else S.fragment="",C=fi;else S.query="",C=jd;break;case Ms:if(c==Ba||c=="/"||c=="\\"&&S.isSpecial()||!e&&(c=="?"||c=="#")){if((_=Ir(_=w))===".."||_==="%2e."||_===".%2e"||_==="%2e%2e"?(S.shortenPath(),c=="/"||c=="\\"&&S.isSpecial()||ao(S.path,"")):Al(w)?c=="/"||c=="\\"&&S.isSpecial()||ao(S.path,""):(S.scheme=="file"&&!S.path.length&&Em(w)&&(S.host&&(S.host=""),w=qi(w,0)+":"),ao(S.path,w)),w="",S.scheme=="file"&&(c==Ba||c=="?"||c=="#"))for(;S.path.length>1&&S.path[0]==="";)Uh(S.path);c=="?"?(S.query="",C=jd):c=="#"&&(S.fragment="",C=fi)}else w+=Pu(c,Fd);break;case l0:c=="?"?(S.query="",C=jd):c=="#"?(S.fragment="",C=fi):c!=Ba&&(S.path[0]+=Pu(c,Bf));break;case jd:e||c!="#"?c!=Ba&&(c=="'"&&S.isSpecial()?S.query+="%27":S.query+=c=="#"?"%23":Pu(c,Bf)):(S.fragment="",C=fi);break;case fi:c!=Ba&&(S.fragment+=Pu(c,s0))}R++}},parseHost:function(r){var e,n,o;if(qi(r,0)=="["){if(qi(r,r.length-1)!="]"||(e=function(c){var u,m,_,S,C,R,w,N=[0,0,0,0,0,0,0,0],L=0,H=null,j=0,W=function(){return qi(c,j)};if(W()==":"){if(qi(c,1)!=":")return;j+=2,H=++L}for(;W();){if(L==8)return;if(W()!=":"){for(u=m=0;m<4&&kr(_m,W());)u=16*u+tv(W(),16),j++,m++;if(W()=="."){if(m==0||(j-=m,L>6))return;for(_=0;W();){if(S=null,_>0){if(!(W()=="."&&_<4))return;j++}if(!kr(rv,W()))return;for(;kr(rv,W());){if(C=tv(W(),10),S===null)S=C;else{if(S==0)return;S=10*S+C}if(S>255)return;j++}N[L]=256*N[L]+S,++_!=2&&_!=4||L++}if(_!=4)return;break}if(W()==":"){if(j++,!W())return}else if(W())return;N[L++]=u}else{if(H!==null)return;j++,H=++L}}if(H!==null)for(R=L-H,L=7;L!=0&&R>0;)w=N[L],N[L--]=N[H+R-1],N[H+--R]=w;else if(L!=8)return;return N}(xh(r,1,-1)),!e))return fm;this.host=e}else if(this.isSpecial()){if(r=cS(r),kr(Pk,r)||(e=function(c){var u,m,_,S,C,R,w,N=Ok(c,".");if(N.length&&N[N.length-1]==""&&N.length--,(u=N.length)>4)return c;for(m=[],_=0;_<u;_++){if((S=N[_])=="")return c;if(C=10,S.length>1&&qi(S,0)=="0"&&(C=kr(F3,S)?16:8,S=xh(S,C==8?1:2)),S==="")R=0;else{if(!kr(C==10?$o:C==8?i0:_m,S))return c;R=tv(S,C)}ao(m,R)}for(_=0;_<u;_++)if(R=m[_],_==u-1){if(R>=uS(256,5-u))return null}else if(R>255)return null;for(w=Lr(m),_=0;_<m.length;_++)w+=m[_]*uS(256,3-_);return w}(r),e===null))return fm;this.host=e}else{if(kr(kk,r))return fm;for(e="",n=vo(r),o=0;o<n.length;o++)e+=Pu(n[o],Bf);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme=="file"},includesCredentials:function(){return this.username!=""||this.password!=""},isSpecial:function(){return $C(hS,this.scheme)},shortenPath:function(){var r=this.path,e=r.length;!e||this.scheme=="file"&&e==1&&Em(r[0],!0)||r.length--},serialize:function(){var r=this,e=r.scheme,n=r.username,o=r.password,c=r.host,u=r.port,m=r.path,_=r.query,S=r.fragment,C=e+":";return c!==null?(C+="//",r.includesCredentials()&&(C+=n+(o?":"+o:"")+"@"),C+=Il(c),u!==null&&(C+=":"+u)):e=="file"&&(C+="//"),C+=r.cannotBeABaseURL?m[0]:m.length?"/"+jf(m,"/"):"",_!==null&&(C+="?"+_),S!==null&&(C+="#"+S),C},setHref:function(r){var e=this.parse(r);if(e)throw lS(e);this.searchParams.update()},getOrigin:function(){var r=this.scheme,e=this.port;if(r=="blob")try{return new yc(r.path[0]).origin}catch{return"null"}return r!="file"&&this.isSpecial()?r+"://"+Il(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(r){this.parse(yl(r)+":",Fn)},getUsername:function(){return this.username},setUsername:function(r){var e=vo(yl(r));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=Pu(e[n],o0)}},getPassword:function(){return this.password},setPassword:function(r){var e=vo(yl(r));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=Pu(e[n],o0)}},getHost:function(){var r=this.host,e=this.port;return r===null?"":e===null?Il(r):Il(r)+":"+e},setHost:function(r){this.cannotBeABaseURL||this.parse(r,mS)},getHostname:function(){var r=this.host;return r===null?"":Il(r)},setHostname:function(r){this.cannotBeABaseURL||this.parse(r,c0)},getPort:function(){var r=this.port;return r===null?"":yl(r)},setPort:function(r){this.cannotHaveUsernamePasswordPort()||((r=yl(r))==""?this.port=null:this.parse(r,Gf))},getPathname:function(){var r=this.path;return this.cannotBeABaseURL?r[0]:r.length?"/"+jf(r,"/"):""},setPathname:function(r){this.cannotBeABaseURL||(this.path=[],this.parse(r,Rc))},getSearch:function(){var r=this.query;return r?"?"+r:""},setSearch:function(r){(r=yl(r))==""?this.query=null:(qi(r,0)=="?"&&(r=xh(r,1)),this.query="",this.parse(r,jd)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var r=this.fragment;return r?"#"+r:""},setHash:function(r){(r=yl(r))!=""?(qi(r,0)=="#"&&(r=xh(r,1)),this.fragment="",this.parse(r,fi)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var yc=function(r){var e=yk(this,ea),n=Ff(arguments.length,1)>1?arguments[1]:void 0,o=Ak(e,new u0(r,!1,n));ZC||(e.href=o.serialize(),e.origin=o.getOrigin(),e.protocol=o.getProtocol(),e.username=o.getUsername(),e.password=o.getPassword(),e.host=o.getHost(),e.hostname=o.getHostname(),e.port=o.getPort(),e.pathname=o.getPathname(),e.search=o.getSearch(),e.searchParams=o.getSearchParams(),e.hash=o.getHash())},ea=yc.prototype,Ic=function(r,e){return{get:function(){return dS(this)[r]()},set:e&&function(n){return dS(this)[e](n)},configurable:!0,enumerable:!0}};if(ZC&&(vc(ea,"href",Ic("serialize","setHref")),vc(ea,"origin",Ic("getOrigin")),vc(ea,"protocol",Ic("getProtocol","setProtocol")),vc(ea,"username",Ic("getUsername","setUsername")),vc(ea,"password",Ic("getPassword","setPassword")),vc(ea,"host",Ic("getHost","setHost")),vc(ea,"hostname",Ic("getHostname","setHostname")),vc(ea,"port",Ic("getPort","setPort")),vc(ea,"pathname",Ic("getPathname","setPathname")),vc(ea,"search",Ic("getSearch","setSearch")),vc(ea,"searchParams",Ic("getSearchParams")),vc(ea,"hash",Ic("getHash","setHash"))),aS(ea,"toJSON",function(){return dS(this).serialize()},{enumerable:!0}),aS(ea,"toString",function(){return dS(this).serialize()},{enumerable:!0}),mm){var fS=mm.createObjectURL,Vk=mm.revokeObjectURL;fS&&aS(yc,"createObjectURL",oS(fS,mm)),Vk&&aS(yc,"revokeObjectURL",oS(Vk,mm))}Ik(yc,"URL"),QC({global:!0,constructor:!0,forced:!x3,sham:!ZC},{URL:yc});var Fk=Xt,jk=O,B3=jE,Bk=Bs,Gk=xb,Wf=hr("URL");Fk({target:"URL",stat:!0,forced:!(Gk&&jk(function(){Wf.canParse()}))},{canParse:function(r){var e=B3(arguments.length,1),n=Bk(r),o=e<2||arguments[1]===void 0?void 0:Bk(arguments[1]);try{return!!new Wf(n,o)}catch{return!1}}});var Wk=A(po.URL);function _S(){const r=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>Wk.revokeObjectURL(r),0),new Worker(Wk.createObjectURL(r))}const Hf=new Map,ES=new Map;async function Hk(r){if(!Dn().supportWebRTCEncodedTransform)return void M.warning("browser not support audio encoded transform");if(ES.has(r))return;const e={track:r.track};if(tl()){if(!r.createEncodedStreams)return void M.warning("browser not support createEncodedStreams() API");let o=null;try{o=r.createEncodedStreams()}catch(u){return void M.error("create audio-encoded-streams error",u&&u.message)}const c=new TransformStream({transform(u,m){e.controller||(e.controller=m),r.track&&r.track.id!==e.track.id&&(M.debug("audio track changed: ".concat(e.track.id," => ").concat(r.track.id)),e.track.removeEventListener("ended",n),e.track=r.track,e.track.addEventListener("ended",n)),m.enqueue(u)}});o.readable.pipeThrough(c).pipeTo(o.writable)}else if(Jr()){if(typeof RTCRtpScriptTransform>"u")return void M.warning("browser not support RTCRtpScriptTransform");const o=_S(),c=new MessageChannel;await new Ee(m=>o.onmessage=_=>{_.data==="registered"&&m(void 0)});const u=new RTCRtpScriptTransform(o,{name:"rx",port:c.port2},[c.port2]);r.transform=u,await new Ee(m=>o.onmessage=_=>{_.data==="started"&&m(void 0)}),c.port1.onmessage=m=>{var _;m.data.transformed&&r.track&&((_=r.track)===null||_===void 0?void 0:_.id)!==e.track.id&&(M.debug("audio track changed: ".concat(e.track.id," => ").concat(r.track.id)),e.track.removeEventListener("ended",n),e.track=r.track,e.track.addEventListener("ended",n))},e.worker=o}function n(){r.track.removeEventListener("ended",n),function(o){const c=ES.get(o);if(c){ES.delete(o);try{var u,m;(u=c.controller)===null||u===void 0||u.terminate(),(m=c.worker)===null||m===void 0||m.terminate()}catch(_){M.warning(_&&_.message)}}}(r)}ES.set(r,e),r.track.addEventListener("ended",n)}function G3(r){const e=new DataView(r.data);if(e.getUint8(0)===0&&e.getUint8(1)===0&&e.getUint8(2)===0&&e.getUint8(3)===1&&e.getUint8(4)===6){let n=6,o=0,c=0;for(;(c=e.getUint8(n++))===255;)o+=255;o+=c;const u=function(m,_,S){let C=new Uint8Array(m,_,S),R=[],w=0;for(;w<S;)w+3<S&&C[w]===0&&C[w+1]===0&&C[w+2]===3&&(C[w+3]===0||C[w+3]===1||C[w+3]===2||C[w+3]===3)?(R.push(C[w],C[w+1],C[w+3]),w+=4):(R.push(C[w]),w++);return new Uint8Array(R)}(r.data,n,o);return new Uint8Array(u)}return null}function W3(r,e){const n=function(S){const C=S.length;let R=[],w=0;for(;w<C;)w+2<C&&S[w]===0&&S[w+1]===0&&(S[w+2]===0||S[w+2]===1||S[w+2]===2||S[w+2]===3)?(R.push(S[w],S[w+1],3,S[w+2]),w+=3):(R.push(S[w]),w++);return new Uint8Array(R)}(e),o=n.length,c=Math.floor(o/255),u=o%255,m=new Uint8Array(6+c+1+o+r.byteLength);m[0]=0,m[1]=0,m[2]=0,m[3]=1,m[4]=6,m[5]=101;let _=0;for(;_<c;)m[6+_]=255,_++;return m[6+_]=u,_++,m.set(n,6+_),m.set(new Uint8Array(r),6+_+o),m.buffer}const Kf=new Map,Vh=new Map;async function Kk(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Dn().supportWebRTCEncodedTransform)return void M.warning("browser not support video encoded transform");if(!r.track)return;if(Vh.has(r)){const c=Vh.get(r);return void(c&&(c.onSei=e.onSei))}const n={track:r.track,onSei:e.onSei};if(tl()){if(!r.createEncodedStreams)return void M.warning("browser not support createEncodedStreams() API");let c=null;try{c=r.createEncodedStreams()}catch(m){return void M.error("create video-encoded-streams error",m&&m.message)}const u=new TransformStream({transform(m,_){n.controller||(n.controller=_),r.track&&r.track.id!==n.track.id&&(M.debug("video track changed: ".concat(n.track.id," => ").concat(r.track.id)),n.track.removeEventListener("ended",o),n.track=r.track,n.track.addEventListener("ended",o));const S=G3(m);S&&n.onSei&&n.onSei(S),_.enqueue(m)}});c.readable.pipeThrough(u).pipeTo(c.writable)}else if(Jr()){if(typeof RTCRtpScriptTransform>"u")return void M.warning("browser not support RTCRtpScriptTransform");const c=_S(),u=new MessageChannel;await new Ee(_=>c.onmessage=S=>{S.data==="registered"&&_(void 0)});const m=new RTCRtpScriptTransform(c,{name:"rx",port:u.port2},[u.port2]);r.transform=m,await new Ee(_=>c.onmessage=S=>{S.data==="started"&&_(void 0)}),u.port1.onmessage=_=>{var S;_.data.transformed&&r.track&&((S=r.track)===null||S===void 0?void 0:S.id)!==n.track.id?(M.debug("video track changed: ".concat(n.track.id," => ").concat(r.track.id)),n.track.removeEventListener("ended",o),n.track=r.track,n.track.addEventListener("ended",o)):_.data.sei&&n.onSei&&n.onSei(_.data.sei)},n.worker=c}function o(){if(r.track){if(this.id!==r.track.id)return;r.track.removeEventListener("ended",o)}(function(c){const u=Vh.get(c);if(u){Vh.delete(c);try{var m,_;(m=u.controller)===null||m===void 0||m.terminate(),(_=u.worker)===null||_===void 0||_.terminate()}catch(S){M.warning(S&&S.message)}}})(r)}Vh.set(r,n),r.track.addEventListener("ended",o)}(function(){const r=qt();qs.getDisplayMedia=function(e){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),qs.getStreamFromExtension=r.name===Pn.CHROME&&Number(r.version)>34,qs.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let n=!1;try{e.addTransceiver("audio"),n=!0}catch{}return e.close(),n}(),qs.supportMinBitrate=r.name===Pn.CHROME||r.name===Pn.EDGE,qs.supportSetRtpSenderParameters=function(){const e=qt();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!bn()||!(!Jr()&&!Xm())||e.name===Pn.FIREFOX&&Number(e.version)>=64}(),r.name===Pn.SAFARI&&(Number(r.version)>=14?qs.supportDualStream=!0:qs.supportDualStream=!1),qs.webAudioMediaStreamDest=function(){const e=qt();return!(e.name===Pn.SAFARI&&Number(e.version)<12)}(),qs.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),qs.supportWebGL=typeof WebGLRenderingContext<"u",qs.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,bn()||(qs.webAudioWithAEC=!0),qs.supportShareAudio=function(){const e=qt();return(e.os===ar.WIN_10||e.os===ar.WIN_81||e.os===ar.WIN_7||e.os===ar.LINUX||e.os===ar.MAC_OS||e.os===ar.CHROMIUM_OS)&&e.name===Pn.CHROME&&Number(e.version)>=74}(),qs.supportDataChannel=function(){return!!(DT(76)||function(e){const n=qt();return!(n.name!==Pn.FIREFOX||!n.osVersion)&&Number(n.version)>=e}(68)||function(e){const n=qt();return!(n.name!==Pn.SAFARI||!n.osVersion)&&Number(n.version)>=e}(14))}(),qs.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!Ln()&&!!e&&e.prototype.setConfiguration instanceof Function}(),qs.supportWebRTCEncodedTransform=function(){const e=qt();return e.name==="Chrome"&&Number(e.version)>=86||e.name==="Safari"&&Number(e.version)>=15}(),qs.supportWebRTCInsertableStream=function(){const e=qt();return(e.name===Pn.CHROME||e.name===Pn.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),Np(()=>{qs.supportDualStreamEncoding=function(){const e=qt();return oe("DISABLE_WEBAUDIO")?!0:e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&oe("CHROME_DUAL_STREAM_USE_ENCODING"))}(),M.info("browser compatibility",JSON.stringify(qs),JSON.stringify(r))})})();class Yk extends Dt{constructor(){super(...arguments),D(this,"resultStorage",new Map)}setLocalAudioStats(e,n,o){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(o,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(o,n))}setLocalVideoStats(e,n,o){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(o,n)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(o,n)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(o))}setRemoteAudioStats(e,n){const o=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",o,this.checkAudioOutputLevel(n))}setRemoteVideoStats(e,n){const o=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",o,this.checkVideoDecode(n))}record(e,n,o){if(oe("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const c=this.resultStorage.get(e);if(c&&(c.result.push(o),c.result.length>=5)){var u;const m=xe(u=c.result).call(u,!0);c.isPrevNormal&&!m&&this.emit("exception",zk[e],e,n),!c.isPrevNormal&&m&&this.emit("exception",zk[e]+2e3,e+"_RECOVER",n),c.isPrevNormal=m,c.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,n){return n instanceof Yi&&!n.isActive||!!n.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,n){let o=null;n._encoderConfig&&n._encoderConfig.frameRate&&(o=Yo(n._encoderConfig.frameRate));const c=e.captureFrameRate;return!o||!c||!(o>10&&c<5||o<10&&o>=5&&c<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,n){return!!n.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,n){return n instanceof Yi&&!n.isActive||!!n.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}const zk={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Us=new class{markSubscribeStart(r,e){performance.mark("agora-web-sdk/".concat(r,"/subscribe-").concat(e))}markPublishStart(r,e){performance.mark("agora-web-sdk/".concat(r,"/publish-").concat(e))}measureFromSubscribeStart(r,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(r,"/subscribe-").concat(e));if(n.length>0){const o=n[n.length-1];return Math.round(performance.now()-o.startTime)}return 0}measureFromPublishStart(r,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(r,"/publish-").concat(e));if(n.length>0){const o=n[n.length-1];return Math.round(performance.now()-o.startTime)}return 0}};function h0(r,e){this.v=r,this.k=e}function Qt(r){return new h0(r,0)}var Mu=Cr,Zn=cc;Xt({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var r=Zn.f(this);return{promise:r.promise,resolve:r.resolve,reject:r.reject}}});var gS=cc,H3=jm;Xt({target:"Promise",stat:!0,forced:!0},{try:function(r){var e=gS.f(this),n=H3(r);return(n.error?e.reject:e.resolve)(n.value),e.promise}});var lv=A(Mu),qk=Td.f("asyncIterator"),Jk=A(qk);function Yf(r){var e,n;function o(u,m){try{var _=r[u](m),S=_.value,C=S instanceof h0;lv.resolve(C?S.v:S).then(function(R){if(C){var w=u==="return"?"return":"next";if(!S.k||R.done)return o(w,R);R=r[w](R).value}c(_.done?"return":"normal",R)},function(R){o("throw",R)})}catch(R){c("throw",R)}}function c(u,m){switch(u){case"return":e.resolve({value:m,done:!0});break;case"throw":e.reject(m);break;default:e.resolve({value:m,done:!1})}(e=e.next)?o(e.key,e.arg):n=null}this._invoke=function(u,m){return new lv(function(_,S){var C={key:u,arg:m,resolve:_,reject:S,next:null};n?n=n.next=C:(e=n=C,o(u,m))})},typeof r.return!="function"&&(this.return=void 0)}function Fo(r){return function(){return new Yf(r.apply(this,arguments))}}Yf.prototype[typeof qu=="function"&&Jk||"@@asyncIterator"]=function(){return this},Yf.prototype.next=function(r){return this._invoke("next",r)},Yf.prototype.throw=function(r){return this._invoke("throw",r)},Yf.prototype.return=function(r){return this._invoke("return",r)};var p0=A(po.Object.getOwnPropertySymbols),Xk=Xt,_r=B_.indexOf,s=ZI,t=Ht([].indexOf),i=!!t&&1/t([1],1,-0)<0;Xk({target:"Array",proto:!0,forced:i||!s("indexOf")},{indexOf:function(r){var e=arguments.length>1?arguments[1]:void 0;return i?t(this,r,e)||0:_r(this,r,e)}});var a=sa("Array").indexOf,l=ge,p=a,f=Array.prototype,g=A(function(r){var e=r.indexOf;return r===f||l(f,r)&&e===f.indexOf?p:e}),v=Oo,y=km;Xt({target:"Object",stat:!0,forced:O(function(){y(1)})},{keys:function(r){return y(v(r))}});var I=A(po.Object.keys);function b(r,e){if(r==null)return{};var n,o,c=function(m,_){if(m==null)return{};var S,C,R={},w=I(m);for(C=0;C<w.length;C++)S=w[C],g(_).call(_,S)>=0||(R[S]=m[S]);return R}(r,e);if(p0){var u=p0(r);for(o=0;o<u.length;o++)n=u[o],g(e).call(e,n)>=0||Object.prototype.propertyIsEnumerable.call(r,n)&&(c[n]=r[n])}return c}var k={exports:{}};(function(r,e){r.exports=(()=>{var n={8:(u,m,_)=>{_.r(m),_.d(m,{Parser:()=>Zt,Printer:()=>wc,parse:()=>Kt,print:()=>jn});const S=`
`,C="".concat("\r").concat(S),R=" ";let w;function N(ct){return ct>="0"&&ct<="9"}function L(ct){return ct>="!"&&ct<="~"}function H(ct){return L(ct)||ct>=""&&ct<="ÿ"}function j(ct){return ct==="!"||ct>="#"&&ct<="'"||ct>="*"&&ct<="+"||ct>="-"&&ct<="."||ct>="0"&&ct<="9"||ct>="A"&&ct<="Z"||ct>="^"&&ct<="~"}function W(ct){return ct>="1"&&ct<="9"}function ee(ct){return ct>="A"&&ct<="Z"||ct>="a"&&ct<="z"}function re(ct){return ct==="d"||ct==="h"||ct==="m"||ct==="s"}function fe(ct){return ct>""&&ct<"	"||ct>"\v"&&ct<"\f"||ct>""&&ct<"ÿ"}function be(ct){return ee(ct)||N(ct)||ct==="+"||ct==="/"}function _e(ct){return N(ct)||ee(ct)||ct==="+"||ct==="/"||ct==="-"||ct==="_"}function ye(ct){return ee(ct)||N(ct)||ct==="+"||ct==="/"}function Le(ct,G){var se=Object.keys(ct);if(Object.getOwnPropertySymbols){var me=Object.getOwnPropertySymbols(ct);G&&(me=me.filter(function($e){return Object.getOwnPropertyDescriptor(ct,$e).enumerable})),se.push.apply(se,me)}return se}function Me(ct){for(var G=1;G<arguments.length;G++){var se=arguments[G]!=null?arguments[G]:{};G%2?Le(Object(se),!0).forEach(function(me){et(ct,me,se[me])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ct,Object.getOwnPropertyDescriptors(se)):Le(Object(se)).forEach(function(me){Object.defineProperty(ct,me,Object.getOwnPropertyDescriptor(se,me))})}return ct}function et(ct,G,se){return G in ct?Object.defineProperty(ct,G,{value:se,enumerable:!0,configurable:!0,writable:!0}):ct[G]=se,ct}(function(ct){ct.VERSION="v",ct.ORIGIN="o",ct.SESSION_NAME="s",ct.INFORMATION="i",ct.URI="u",ct.EMAIL="e",ct.PHONE="p",ct.CONNECTION="c",ct.BANDWIDTH="b",ct.TIME="t",ct.REPEAT="r",ct.ZONE_ADJUSTMENTS="z",ct.KEY="k",ct.ATTRIBUTE="a",ct.MEDIA="m"})(w||(w={}));class at{consumeText(G,se){let me=se;for(;me<G.length;){const $e=G[me];if($e==="\0"||$e==="\r"||$e===S)break;me+=1}if(me-se==0)throw new Error("Invalid text, at ".concat(G));return me}consumeUnicastAddress(G,se,me){return this.consumeTill(G,se,R)}consumeOneOrMore(G,se,me){let $e=se;for(;me(G[$e]);)$e++;if($e-se==0)throw new Error("Invalid rule at ".concat(se,"."));return $e}consumeSpace(G,se){if(G[se]===R)return se+1;throw new Error("Invalid space at ".concat(se,"."))}consumeIP4Address(G,se){let me=se;for(let $e=0;$e<4;$e++)if(me=this.consumeDecimalUChar(G,me),$e!==3){if(G[me]!==".")throw new Error("Invalid IP4 address.");me++}return me}consumeDecimalUChar(G,se){let me=se;for(let $t=0;$t<3&&N(G[me]);$t++,me++);if(me-se==0)throw new Error("Invalid decimal uchar.");const $e=parseInt(G.slice(se,me));if($e>=0&&$e<=255)return me;throw new Error("Invalid decimal uchar")}consumeIP6Address(G,se){let me=this.consumeHexpart(G,se);return G[me]===":"&&(me+=1,me=this.consumeIP4Address(G,me)),me}consumeHexpart(G,se){let me=se;if(G[me]===":"&&G[me+1]===":"){me+=2;try{me=this.consumeHexseq(G,me)}catch{}return me}if(me=this.consumeHexseq(G,me),G[me]===":"&&G[me+1]===":"){me+=2;try{me=this.consumeHexseq(G,me)}catch{}return me}return me}consumeHexseq(G,se){let me=se;for(;me=this.consumeHex4(G,me),G[me]===":"&&G[me+1]!==":";)me+=1;return me}consumeHex4(G,se){let me=0;for(;me<4;me++)if(!(($e=G[se+me])>="0"&&$e<="9"||$e>="a"&&$e<="f"||$e>="A"&&$e<="F")){if(me===0)throw new Error("Invalid hex 4");break}var $e;return se+me}consumeFQDN(G,se){let me=se;for(;N(G[me])||ee(G[me])||G[me]==="-"||G[me]===".";)me+=1;if(me-se<4)throw new Error("Invalid FQDN");return me}consumeExtnAddr(G,se){return this.consumeOneOrMore(G,se,H)}consumeMulticastAddress(G,se,me){switch(me){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(G,se);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(G,se);default:try{return this.consumeFQDN(G,se)}catch{return this.consumeExtnAddr(G,se)}}}consumeIP6MulticastAddress(G,se){const me=this.consumeHexpart(G,se);return G[me]==="/"?this.consumeInteger(G,me+1):me}consumeIP4MulticastAddress(G,se){let me=se+3;const $e=G.slice(se,me),$t=parseInt($e);if($t<224||$t>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Ni=0;Ni<3;Ni++){if(G[me]!==".")throw new Error("Invalid IP4 multicast address.");me+=1,me=this.consumeDecimalUChar(G,me)}return G[me]==="/"&&(me+=1),me=this.consumeTTL(G,me),G[me]==="/"&&(me=this.consumeInteger(G,me)),me}consumeInteger(G,se){if(!W(G[se]))throw new Error("Invalid integer.");for(se+=1;N(G[se]);)se+=1;return se}consumeTTL(G,se){if(G[se]==="0")return se+1;if(!W(G[se]))throw new Error("Invalid TTL.");se+=1;for(let me=0;me<2&&N(G[se]);me++)se+=1;return se}consumeToken(G,se){return this.consumeOneOrMore(G,se,j)}consumeTime(G,se){let me=se;if(G[me]==="0")return me+1;for(W(G[me])&&(me+=1);N(G[me]);)me++;if(me-se<10)throw new Error("Invalid time");return me}consumeAddress(G,se){return this.consumeTill(G,se,R)}consumeTypedTime(G,se){let me=se;return me=this.consumeOneOrMore(G,me,N),re(G[me])?me+1:me}consumeRepeatInterval(G,se){if(!W(G[se]))throw new Error("Invalid repeat interval");for(se+=1;N(G[se]);)se+=1;return re(G[se])&&(se+=1),se}consumePort(G,se){return this.consumeOneOrMore(G,se,N)}consume(G,se,me){for(let $e=0;$e<me.length;$e++){if(se+$e>=G.length)throw new Error("consume exceeding value length");if(G[se+$e]!==me[$e])throw new Error("consume ".concat(me," failed at ").concat($e))}return se+me.length}consumeTill(G,se,me){let $e=se;for(;$e<G.length&&(typeof me!="string"||G[$e]!==me)&&(typeof me!="function"||!me(G[$e]));)$e++;return $e}}class Zt extends at{constructor(){super(),et(this,"records",[]),et(this,"currentLine",0)}parse(G){const se=this.probeEOL(G);this.records=G.split(se).filter(zr=>!!zr.trim()).map(this.parseLine),this.currentLine=0;const me=this.parseVersion(),$e=this.parseOrigin(),$t=this.parseSessionName(),Ni=this.parseInformation(),uo=this.parseUri(),bc=this.parseEmail(),Tm=this.parsePhone(),cL=this.parseConnection(),dL=this.parseBandWidth(),Kd=this.parseTimeFields(),$f=this.parseKey(),_v=this.parseSessionAttribute(),gr=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:me,origin:$e,sessionName:$t,information:Ni,uri:uo,emails:bc,phones:Tm,connection:cL,bandwidths:dL,timeFields:Kd,key:$f,attributes:_v,mediaDescriptions:gr}}getCurrentRecord(){const G=this.records[this.currentLine];if(!G)throw new Error("Record doesn't exit.");return G}probeEOL(G){for(let se=0;se<G.length;se++)if(G[se]===S)return G[se-1]==="\r"?C:S;throw new Error("Invalid newline character.")}parseLine(G,se){if(G.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const me=G[0];if(G[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:me,value:G.slice(2),line:se,cur:0}}parseSessionAttribute(){const G=new gi;for(;this.currentLine<this.records.length;){const se=this.getCurrentRecord();if(se.type!==w.ATTRIBUTE)break;const me={attField:this.extractOneOrMore(se,$e=>j($e)&&$e!==":"),_cur:0};se.value[se.cur]===":"&&(se.cur+=1,me.attValue=this.extractOneOrMore(se,fe)),G.parse(me),this.currentLine++}return G.digest()}parseMediaAttributes(G){const se=new Yr(G);for(;this.currentLine<this.records.length;){const me=this.getCurrentRecord();if(me.type!==w.ATTRIBUTE)break;const $e={attField:this.extractOneOrMore(me,$t=>j($t)&&$t!==":"),_cur:0};me.value[me.cur]===":"&&(me.cur+=1,$e.attValue=this.extractOneOrMore(me,fe)),se.parse($e),this.currentLine++}return se.digest()}parseKey(){const G=this.getCurrentRecord();if(G.type===w.KEY){if(G.value==="prompt"||G.value==="clear:"||G.value==="base64:"||G.value==="uri:")return G.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const G=this.getCurrentRecord();if(G.type===w.ZONE_ADJUSTMENTS){const se=[];for(;;)try{const me=this.extract(G,this.consumeTime);this.consumeSpaceForRecord(G);let $e=!1;G.value[G.cur]==="-"&&($e=!0,G.cur+=1);const $t=this.extract(G,this.consumeTypedTime);se.push({time:me,typedTime:$t,back:$e})}catch{break}if(se.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,se}return[]}parseRepeat(){const G=[];for(;;){const se=this.getCurrentRecord();if(se.type!==w.REPEAT)break;{const me=this.extract(se,this.consumeRepeatInterval),$e=this.parseTypedTime(se);G.push({repeatInterval:me,typedTimes:$e}),this.currentLine++}}return G}parseTypedTime(G){const se=[];for(;;)try{this.consumeSpaceForRecord(G),se.push(this.extract(G,this.consumeTypedTime))}catch{break}if(se.length===0)throw new Error("Invalid typed time.");return se}parseTime(){const G=this.getCurrentRecord(),se=this.extract(G,this.consumeTime);this.consumeSpaceForRecord(G);const me=this.extract(G,this.consumeTime);return this.currentLine++,{startTime:se,stopTime:me}}parseBandWidth(){const G=[];for(;this.currentLine<this.records.length;){const se=this.getCurrentRecord();if(se.type!==w.BANDWIDTH)break;{const me=this.extractOneOrMore(se,j);if(se.value[se.cur]!==":")throw new Error("Invalid bandwidth field.");se.cur++;const $e=this.extractOneOrMore(se,N);G.push({bwtype:me,bandwidth:$e}),this.currentLine++}}return G}parseVersion(){const G=this.getCurrentRecord();if(G.type!==w.VERSION)throw new Error("first sdp record must be version");const se=G.value.slice(0,this.consumeOneOrMore(G.value,0,N));if(se.length!==G.value.length)throw new Error('invalid proto version, "v='.concat(G.value,'"'));return this.currentLine++,se}parseOrigin(){const G=this.getCurrentRecord();if(G.type!==w.ORIGIN)throw new Error("second line of sdp must be origin");const se=this.extractOneOrMore(G,H);this.consumeSpaceForRecord(G);const me=this.extractOneOrMore(G,N);this.consumeSpaceForRecord(G);const $e=this.extractOneOrMore(G,N);this.consumeSpaceForRecord(G);const $t=this.extractOneOrMore(G,j);this.consumeSpaceForRecord(G);const Ni=this.extractOneOrMore(G,j);this.consumeSpaceForRecord(G);const uo=this.extract(G,this.consumeUnicastAddress);return this.currentLine++,{username:se,sessId:me,sessVersion:$e,nettype:$t,addrtype:Ni,unicastAddress:uo}}parseSessionName(){const G=this.getCurrentRecord();if(G.type===w.SESSION_NAME){const se=this.extract(G,this.consumeText);return this.currentLine++,se}}parseInformation(){const G=this.getCurrentRecord();if(G.type!==w.INFORMATION)return;const se=this.extract(G,this.consumeText);return this.currentLine++,se}parseUri(){const G=this.getCurrentRecord();if(G.type===w.URI)return this.currentLine++,G.value}parseEmail(){const G=[];for(;;){const se=this.getCurrentRecord();if(se.type!==w.EMAIL)break;G.push(se.value),this.currentLine++}return G}parsePhone(){const G=[];for(;;){const se=this.getCurrentRecord();if(se.type!==w.PHONE)break;G.push(se.value),this.currentLine++}return G}parseConnection(){const G=this.getCurrentRecord();if(G.type===w.CONNECTION){const se=this.extractOneOrMore(G,j);this.consumeSpaceForRecord(G);const me=this.extractOneOrMore(G,j);this.consumeSpaceForRecord(G);const $e=this.extract(G,this.consumeAddress);return this.currentLine++,{nettype:se,addrtype:me,address:$e}}}parseMedia(){const G=this.getCurrentRecord(),se=this.extract(G,this.consumeToken);this.consumeSpaceForRecord(G);let me=this.extract(G,this.consumePort);G.value[G.cur]==="/"&&(G.cur+=1,me+=this.extract(G,this.consumeInteger)),this.consumeSpaceForRecord(G);const $e=[];for($e.push(this.extract(G,this.consumeToken));G.value[G.cur]==="/";)G.cur+=1,$e.push(this.extract(G,this.consumeToken));if($e.length===0)throw new Error("Invalid proto");const $t=this.parseFmt(G);return this.currentLine++,{mediaType:se,port:me,protos:$e,fmts:$t}}parseTimeFields(){const G=[];for(;this.getCurrentRecord().type===w.TIME;){const se=this.parseTime(),me=this.parseRepeat(),$e=this.parseZone();G.push({time:se,repeats:me,zones:$e})}return G}parseMediaDescription(){const G=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===w.MEDIA;){const se=this.parseMedia(),me=this.parseInformation(),$e=this.parseConnections(),$t=this.parseBandWidth(),Ni=this.parseKey(),uo=this.parseMediaAttributes(se);G.push({media:se,information:me,connections:$e,bandwidths:$t,key:Ni,attributes:uo})}return G}parseConnections(){const G=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===w.CONNECTION;)G.push(this.parseConnection());return G}parseFmt(G){const se=[];for(;;)try{this.consumeSpaceForRecord(G),se.push(this.extract(G,this.consumeToken))}catch{break}if(se.length===0)throw new Error("Invalid fmts");return se}extract(G,se,...me){const $e=se.call(this,G.value,G.cur,...me),$t=G.value.slice(G.cur,$e);return G.cur=$e,$t}extractOneOrMore(G,se){const me=this.consumeOneOrMore(G.value,G.cur,se),$e=G.value.slice(G.cur,me);return G.cur=me,$e}consumeSpaceForRecord(G){if(G.value[G.cur]!==R)throw new Error("Invalid space at ".concat(G.cur,"."));G.cur+=1}}class Sn extends at{constructor(...G){super(...G),et(this,"attributes",void 0),et(this,"digested",!1)}extractOneOrMore(G,se,me){const $e=this.consumeOneOrMore(G.attValue,G._cur,se),$t=G.attValue.slice(G._cur,$e),[Ni,uo]=me||[];if(typeof Ni=="number"&&$t.length<Ni)throw new Error("error in length, should be more or equal than ".concat(Ni," characters."));if(typeof uo=="number"&&$t.length>uo)throw new Error("error in length, should be less or equal than ".concat(uo," characters."));return G._cur=$e,$t}consumeAttributeSpace(G){if(G.attValue[G._cur]!==R)throw new Error("Invalid space at ".concat(G._cur,"."));G._cur+=1}extract(G,se,...me){if(!G.attValue)throw new Error("Nothing to extract from attValue.");const $e=se.call(this,G.attValue,G._cur,...me),$t=G.attValue.slice(G._cur,$e);return G._cur=$e,$t}atEnd(G){if(!G.attValue)throw new Error;return G._cur>=G.attValue.length}peekChar(G){if(!G.attValue)throw new Error;return G.attValue[G._cur]}peek(G,se){if(!G.attValue)throw new Error;for(let me=0;me<se.length;me++)if(se[me]!==G.attValue[G._cur+me])return!1;return!0}parseIceUfrag(G){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(G,be,[4,256])}parseIcePwd(G){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(G,be,[22,256])}parseIceOptions(G){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const se=[];for(;!this.atEnd(G);){se.push(this.extractOneOrMore(G,be));try{this.consumeAttributeSpace(G)}catch(me){if(this.atEnd(G))break;throw me}}this.attributes.iceOptions=se}parseFingerprint(G){const se=this.extract(G,this.consumeToken);this.consumeAttributeSpace(G);const me=this.extract(G,this.consumeTill);this.attributes.fingerprints.push({hashFunction:se,fingerprint:me})}parseExtmap(G){const se=this.extractOneOrMore(G,N);let me;this.peekChar(G)==="/"&&(this.extract(G,this.consume,"/"),me=this.extract(G,this.consumeToken)),this.consumeAttributeSpace(G);const $e=this.extract(G,this.consumeTill,R),$t=Me(Me({entry:parseInt(se,10)},me&&{direction:me}),{},{extensionName:$e});this.peekChar(G)===R&&(this.consumeAttributeSpace(G),$t.extensionAttributes=this.extract(G,this.consumeTill)),this.attributes.extmaps.push($t)}parseSetup(G){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const se=this.extract(G,this.consumeTill);if(se!=="active"&&se!=="passive"&&se!=="actpass"&&se!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=se}}class gi extends Sn{constructor(...G){super(...G),et(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(G){if(this.digested)throw new Error("already digested");try{switch(G.attField){case"group":this.parseGroup(G);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(G);break;case"ice-pwd":this.parseIcePwd(G);break;case"ice-options":this.parseIceOptions(G);break;case"fingerprint":this.parseFingerprint(G);break;case"setup":this.parseSetup(G);break;case"tls-id":this.parseTlsId(G);break;case"identity":this.parseIdentity(G);break;case"extmap":this.parseExtmap(G);break;case"msid-semantic":this.parseMsidSemantic(G);break;default:G.ignored=!0,this.attributes.unrecognized.push(G)}}catch(se){throw console.error("parsing session attribute ".concat(G.attField,' error, "a=').concat(G.attField,":").concat(G.attValue,'"')),se}if(!G.ignored&&G.attValue&&!this.atEnd(G))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(G){const se=this.extract(G,this.consumeToken),me=[];for(;!this.atEnd(G)&&this.peekChar(G)===R;)this.consumeAttributeSpace(G),me.push(this.extract(G,this.consumeToken));this.attributes.groups.push({semantic:se,identificationTag:me})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(G){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(G,_e)}parseIdentity(G){const se=this.extractOneOrMore(G,ye),me=[];for(;!this.atEnd(G)&&this.peekChar(G)===R;){this.consumeAttributeSpace(G);const $e=this.extract(G,this.consumeToken);this.extract(G,this.consume,"=");const $t=this.extractOneOrMore(G,Ni=>Ni!==R&&fe(Ni));me.push({name:$e,value:$t})}this.attributes.identities.push({assertionValue:se,extensions:me})}parseMsidSemantic(G){this.peekChar(G)===R&&this.consumeAttributeSpace(G);const se={semantic:this.extract(G,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(G)}catch{break}if(this.peekChar(G)==="*"){this.extract(G,this.consume,"*"),se.applyForAll=!0;break}{const me=this.extract(G,this.consumeTill,R);se.identifierList.push(me)}}this.attributes.msidSemantic=se}}class Yr extends Sn{constructor(G){super(),et(this,"attributes",void 0),G.protos.indexOf("RTP")!==-1||G.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(G){if(this.digested)throw new Error("already digested");try{switch(G.attField){case"extmap":this.parseExtmap(G);break;case"setup":this.parseSetup(G);break;case"ice-ufrag":this.parseIceUfrag(G);break;case"ice-pwd":this.parseIcePwd(G);break;case"ice-options":this.parseIceOptions(G);break;case"candidate":this.parseCandidate(G);break;case"remote-candidate":this.parseRemoteCandidate(G);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(G);break;case"rtpmap":this.parseRtpmap(G);break;case"ptime":this.parsePtime(G);break;case"maxptime":this.parseMaxPtime(G);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(G);break;case"ssrc":this.parseSSRC(G);break;case"fmtp":this.parseFmtp(G);break;case"rtcp-fb":this.parseRtcpFb(G);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(G);break;case"mid":this.parseMid(G);break;case"msid":this.parseMsid(G);break;case"imageattr":this.parseImageAttr(G);break;case"rid":this.parseRid(G);break;case"simulcast":this.parseSimulcast(G);break;case"sctp-port":this.parseSctpPort(G);break;case"max-message-size":this.parseMaxMessageSize(G);break;case"ssrc-group":this.parseSSRCGroup(G);break;default:G.ignored=!0,this.attributes.unrecognized.push(G)}}catch(se){throw console.error("parsing media attribute ".concat(G.attField,' error, "a=').concat(G.attField,":").concat(G.attValue,'"')),se}if(!G.ignored&&G.attValue&&!this.atEnd(G))throw new Error("attribute parsing error")}parseCandidate(G){const se=this.extractOneOrMore(G,be,[1,32]);this.consumeAttributeSpace(G);const me=this.extractOneOrMore(G,N,[1,5]);this.consumeAttributeSpace(G);const $e=this.extract(G,this.consumeToken);this.consumeAttributeSpace(G);const $t=this.extractOneOrMore(G,N,[1,10]);this.consumeAttributeSpace(G);const Ni=this.extract(G,this.consumeAddress);this.consumeAttributeSpace(G);const uo=this.extract(G,this.consumePort);this.consumeAttributeSpace(G),this.extract(G,this.consume,"typ"),this.consumeAttributeSpace(G);const bc={foundation:se,componentId:me,transport:$e,priority:$t,connectionAddress:Ni,port:uo,type:this.extract(G,this.consumeToken),extension:{}};for(this.peek(G," raddr")&&(this.extract(G,this.consume," raddr"),this.consumeAttributeSpace(G),bc.relAddr=this.extract(G,this.consumeAddress)),this.peek(G," rport")&&(this.extract(G,this.consume," rport"),this.consumeAttributeSpace(G),bc.relPort=this.extract(G,this.consumePort));this.peekChar(G)===R;){this.consumeAttributeSpace(G);const Tm=this.extract(G,this.consumeToken);this.consumeAttributeSpace(G),bc.extension[Tm]=this.extractOneOrMore(G,L)}this.attributes.candidates.push(bc)}parseRemoteCandidate(G){const se=[];for(;;){const me=this.extractOneOrMore(G,N,[1,5]);this.consumeAttributeSpace(G);const $e=this.extract(G,this.consumeAddress);this.consumeAttributeSpace(G);const $t=this.extract(G,this.consumePort);se.push({componentId:me,connectionAddress:$e,port:$t});try{this.consumeAttributeSpace(G)}catch{break}}this.attributes.remoteCandidatesList.push(se)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(G){const se=this.extract(G,this.consumeToken);this.consumeAttributeSpace(G);const me=this.extract(G,this.consumeTill,"/");this.extract(G,this.consume,"/");const $e={encodingName:me,clockRate:this.extractOneOrMore(G,N)};this.atEnd(G)||this.peekChar(G)!=="/"||(this.extract(G,this.consume,"/"),$e.encodingParameters=parseInt(this.extract(G,this.consumeTill),10));const $t=this.attributes.payloads.find(Ni=>Ni.payloadType===parseInt(se,10));$t?$t.rtpMap=$e:this.attributes.payloads.push({payloadType:parseInt(se,10),rtpMap:$e,rtcpFeedbacks:[]})}parsePtime(G){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(G,this.consumeTill)}parseMaxPtime(G){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(G,this.consumeTill)}parseDirection(G){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=G.attField}parseSSRC(G){const se=this.extractOneOrMore(G,N);this.consumeAttributeSpace(G);const me=this.extract(G,this.consumeTill,":");let $e;this.peekChar(G)===":"&&(this.extract(G,this.consume,":"),$e=this.extract(G,this.consumeTill));const $t=this.attributes.ssrcs.find(Ni=>Ni.ssrcId===parseInt(se,10));$t?$t.attributes[me]=$e:this.attributes.ssrcs.push({ssrcId:parseInt(se,10),attributes:{[me]:$e}})}parseFmtp(G){const se=this.extract(G,this.consumeTill,R);this.consumeAttributeSpace(G);const me=this.extract(G,this.consumeTill),$e={};me.split(";").forEach(Ni=>{let[uo,bc]=Ni.split("=");uo=uo.trim();const Tm=typeof bc=="string"?bc.trim():null;typeof uo=="string"&&uo.length>0&&($e[uo]=Tm)});const $t=this.attributes.payloads.find(Ni=>Ni.payloadType===parseInt(se,10));$t?$t.fmtp={parameters:$e}:this.attributes.payloads.push({payloadType:parseInt(se,10),rtcpFeedbacks:[],fmtp:{parameters:$e}})}parseFmtParameters(G){const se={},me=this.extract(G,this.consumeTill,"=");G._cur++;const $e=this.extract(G,this.consumeTill,";");for(se[me]=$e;G.attValue[G._cur]===";";){const $t=this.extract(G,this.consumeTill,"=");G._cur++;const Ni=this.extract(G,this.consumeTill,";");se[$t]=Ni}return se}parseRtcpFb(G){let se="";se=this.peekChar(G)==="*"?this.extract(G,this.consume,"*"):this.extract(G,this.consumeTill,R),this.consumeAttributeSpace(G);const me=this.extract(G,this.consumeTill,R);let $e;if(me==="trr-int")$e={type:me,interval:this.extract(G,this.consumeTill)};else{const $t={type:me};this.peekChar(G)===R&&(this.consumeAttributeSpace(G),$t.parameter=this.extract(G,this.consumeToken),this.peekChar(G)===R&&($t.additional=this.extract(G,this.consumeTill))),$e=$t}if(se==="*")this.attributes.rtcpFeedbackWildcards.push($e);else{const $t=this.attributes.payloads.find(Ni=>Ni.payloadType===parseInt(se,10));$t?$t.rtcpFeedbacks.push($e):this.attributes.payloads.push({payloadType:parseInt(se,10),rtcpFeedbacks:[$e]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(G){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const se={port:this.extract(G,this.consumePort)};this.peekChar(G)===R&&(this.consumeAttributeSpace(G),se.netType=this.extractOneOrMore(G,j),this.consumeAttributeSpace(G),se.addressType=this.extractOneOrMore(G,j),this.consumeAttributeSpace(G),se.address=this.extract(G,this.consumeAddress)),this.attributes.rtcp=se}parseMsid(G){const se={id:this.extractOneOrMore(G,j,[1,64])};this.peekChar(G)===R&&(this.consumeAttributeSpace(G),se.appdata=this.extractOneOrMore(G,j,[1,64])),this.attributes.msids.push(se)}parseImageAttr(G){this.attributes.imageattr.push(G.attValue)}parseRid(G){const se=this.extractOneOrMore(G,$e=>ee($e)||N($e)||$e==="_"||$e==="-");this.consumeAttributeSpace(G);const me={id:se,direction:this.extract(G,this.consumeToken),params:[]};if(this.peekChar(G)===R){if(this.consumeAttributeSpace(G),this.peek(G,"pt=")){this.extract(G,this.consume,"pt=");const $e=[];for(;;){const $t=this.extract(G,this.consumeToken);$e.push($t);try{this.extract(G,this.consume,",")}catch{break}}me.payloads=$e,this.peekChar(G)===R&&this.extract(G,this.consume,R)}for(;;){const $e=this.extract(G,this.consumeToken);switch($e){case"depend":{const $t={type:$e,rids:this.extract(G,this.consume,"=").split(",")};me.params.push($t);break}default:{const $t={type:$e};this.peekChar(G)==="="&&(this.extract(G,this.consume,"="),$t.val=this.extract(G,this.consumeTill,";")),me.params.push($t)}}try{this.extract(G,this.consume,";")}catch{break}}}this.attributes.rids.push(me)}parseSimulcast(G){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=G.attValue,this.extract(G,this.consumeTill)}parseSctpPort(G){this.attributes.sctpPort=this.extractOneOrMore(G,N,[1,5])}parseMaxMessageSize(G){this.attributes.maxMessageSize=this.extractOneOrMore(G,N,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(G){this.attributes.mid=this.extract(G,this.consumeToken)}parseSSRCGroup(G){const se=this.extract(G,this.consumeToken),me=[];for(;;)try{this.consumeAttributeSpace(G);const $e=this.extract(G,this.consumeInteger);me.push(parseInt($e,10))}catch{break}this.attributes.ssrcGroups.push({semantic:se,ssrcIds:me})}}function Mi(ct,G,se){return G in ct?Object.defineProperty(ct,G,{value:se,enumerable:!0,configurable:!0,writable:!0}):ct[G]=se,ct}class wc{constructor(){Mi(this,"eol",C)}print(G,se){let me="";return se&&(this.eol=se),me+=this.printVersion(G.version),me+=this.printOrigin(G.origin),me+=this.printSessionName(G.sessionName),me+=this.printInformation(G.information),me+=this.printUri(G.uri),me+=this.printEmail(G.emails),me+=this.printPhone(G.phones),me+=this.printConnection(G.connection),me+=this.printBandwidth(G.bandwidths),me+=this.printTimeFields(G.timeFields),me+=this.printKey(G.key),me+=this.printSessionAttributes(G.attributes),me+=this.printMediaDescription(G.mediaDescriptions),me}printVersion(G){return"v=".concat(G).concat(this.eol)}printOrigin(G){return"o=".concat(G.username," ").concat(G.sessId," ").concat(G.sessVersion," ").concat(G.nettype," ").concat(G.addrtype," ").concat(G.unicastAddress).concat(this.eol)}printSessionName(G){return G?"s=".concat(G).concat(this.eol):""}printInformation(G){return G?"i=".concat(G).concat(this.eol):""}printUri(G){return G?"u=".concat(G).concat(this.eol):""}printEmail(G){let se="";for(const me of G)se+="e=".concat(me).concat(this.eol);return se}printPhone(G){let se="";for(const me of G)se+="e=".concat(me).concat(this.eol);return se}printConnection(G){return G?"c=".concat(G.nettype," ").concat(G.addrtype," ").concat(G.address).concat(this.eol):""}printBandwidth(G){let se="";for(const me of G)se+="b=".concat(me.bwtype,":").concat(me.bandwidth).concat(this.eol);return se}printTimeFields(G){let se="";for(const me of G){se+="t=".concat(me.time.startTime," ").concat(me.time.startTime).concat(this.eol);for(const $e of me.repeats)se+="r=".concat($e.repeatInterval," ").concat($e.typedTimes.join(" ")).concat(this.eol);me.zoneAdjustments&&(se+="z=",se+="z=".concat(me.zoneAdjustments.map($e=>"".concat($e.time," ").concat($e.back?"-":""," ").concat($e.typedTime)).join(" ")).concat(this.eol),se+=this.eol)}return se}printKey(G){return G?"k=".concat(G).concat(this.eol):""}printAttributes(G){let se="";for(const me of G)se+="a=".concat(me.attField).concat(me.attValue?":".concat(me.attValue):"").concat(this.eol);return se}printMediaDescription(G){let se="";for(const me of G)se+=this.printMedia(me.media),se+=this.printInformation(me.information),se+=this.printConnections(me.connections),se+=this.printBandwidth(me.bandwidths),se+=this.printKey(me.key),se+=this.printMediaAttributes(me);return se}printConnections(G){let se="";for(const me of G)se+=this.printConnection(me);return se}printMedia(G){return"m=".concat(G.mediaType," ").concat(G.port," ").concat(G.protos.join("/")," ").concat(G.fmts.join(" ")).concat(this.eol)}printSessionAttributes(G){return new it(this.eol).print(G)}printMediaAttributes(G){return new St(this.eol).print(G)}}class ze{constructor(G){Mi(this,"eol",void 0),this.eol=G}printIceUfrag(G){return G===void 0?"":"a=ice-ufrag:".concat(G).concat(this.eol)}printIcePwd(G){return G===void 0?"":"a=ice-pwd:".concat(G).concat(this.eol)}printIceOptions(G){return G===void 0?"":"a=ice-options:".concat(G.join(R)).concat(this.eol)}printFingerprints(G){return G.length>0?G.map(se=>"a=fingerprint:".concat(se.hashFunction).concat(R).concat(se.fingerprint)).join(this.eol)+this.eol:""}printExtmap(G){return G.map(se=>"a=extmap:".concat(se.entry).concat(se.direction?"/".concat(se.direction):"").concat(R).concat(se.extensionName).concat(se.extensionAttributes?"".concat(R).concat(se.extensionAttributes):"").concat(this.eol)).join("")}printSetup(G){return G===void 0?"":"a=setup:".concat(G).concat(this.eol)}printUnrecognized(G){return G.map(se=>"a=".concat(se.attField).concat(se.attValue?":".concat(se.attValue):"").concat(this.eol)).join("")}}class it extends ze{print(G){let se="";return se+=this.printGroups(G.groups),se+=this.printMsidSemantic(G.msidSemantic),se+=this.printIceLite(G.iceLite),se+=this.printIceUfrag(G.iceUfrag),se+=this.printIcePwd(G.icePwd),se+=this.printIceOptions(G.iceOptions),se+=this.printFingerprints(G.fingerprints),se+=this.printSetup(G.setup),se+=this.printTlsId(G.tlsId),se+=this.printIdentity(G.identities),se+=this.printExtmap(G.extmaps),se+=this.printUnrecognized(G.unrecognized),se}printGroups(G){let se="";return G.length>0&&(se+=G.map(me=>"a=group:".concat(me.semantic).concat(me.identificationTag.map($e=>"".concat(R).concat($e)).join("")).concat(this.eol)).join("")),se}printIceLite(G){return G===void 0?"":"a=ice-lite"+this.eol}printTlsId(G){return G?"a=tls-id:".concat(G).concat(this.eol):""}printIdentity(G){return G.length===0?"":G.map(se=>"a=identity:".concat(se.assertionValue).concat(se.extensions.map(me=>"".concat(R).concat(me.name).concat(me.value?"=".concat(me.value):"")))).join(this.eol)+this.eol}printMsidSemantic(G){if(!G)return"";let se="a=msid-semantic:".concat(G.semantic);return G.applyForAll?se+="".concat(R,"*"):G.identifierList.length>0&&(se+=G.identifierList.map(me=>"".concat(R).concat(me))),se+this.eol}}class St extends ze{print(G){const se=G.attributes;let me="";return me+=this.printRTCP(se.rtcp),me+=this.printIceUfrag(se.iceUfrag),me+=this.printIcePwd(se.icePwd),me+=this.printIceOptions(se.iceOptions),me+=this.printCandidates(se.candidates),me+=this.printRemoteCandidatesList(se.remoteCandidatesList),me+=this.printEndOfCandidates(se.endOfCandidates),me+=this.printFingerprints(se.fingerprints),me+=this.printSetup(se.setup),me+=this.printMid(se.mid),me+=this.printExtmap(se.extmaps),me+=this.printRTPRelated(se),me+=this.printPtime(se.ptime),me+=this.printMaxPtime(se.maxPtime),me+=this.printDirection(se.direction),me+=this.printSSRCGroups(se.ssrcGroups),me+=this.printSSRC(se.ssrcs),me+=this.printRTCPMux(se.rtcpMux),me+=this.printRTCPMuxOnly(se.rtcpMuxOnly),me+=this.printRTCPRsize(se.rtcpRsize),me+=this.printMSId(se.msids),me+=this.printImageattr(se.imageattr),me+=this.printRid(se.rids),me+=this.printSimulcast(se.simulcast),me+=this.printSCTPPort(se.sctpPort),me+=this.printMaxMessageSize(se.maxMessageSize),me+=this.printUnrecognized(se.unrecognized),me}printCandidates(G){return G.map(se=>"a=candidate:".concat(se.foundation).concat(R).concat(se.componentId).concat(R).concat(se.transport).concat(R).concat(se.priority).concat(R).concat(se.connectionAddress).concat(R).concat(se.port).concat(R,"typ").concat(R).concat(se.type).concat(se.relAddr?"".concat(R,"raddr").concat(R).concat(se.relAddr):"").concat(se.relPort?"".concat(R,"rport").concat(R).concat(se.relPort):"").concat(Object.keys(se.extension).map(me=>"".concat(R).concat(me).concat(R).concat(se.extension[me])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(G){return G.map(se=>"a=remote-candidates:".concat(se.join(R)).concat(this.eol)).join("")}printEndOfCandidates(G){return G===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(G){if(!G.payloads)return"";const se=G.payloads;let me="";me+=G.rtcpFeedbackWildcards.map($e=>this.printRTCPFeedback("*",$e)).join("");for(const $e of se)me+=this.printRtpMap($e.payloadType,$e.rtpMap),me+=this.printFmtp($e.payloadType,$e.fmtp),me+=$e.rtcpFeedbacks.map($t=>this.printRTCPFeedback($e.payloadType,$t)).join("");return me}printFmtp(G,se){if(!se)return"";const me=Object.keys(se.parameters);return me.length===1&&se.parameters[me[0]]===null?"a=fmtp:".concat(G).concat(R).concat(me[0]).concat(this.eol):"a=fmtp:".concat(G).concat(R).concat(Object.keys(se.parameters).map($e=>"".concat($e,"=").concat(se.parameters[$e])).join(";")).concat(this.eol)}printRtpMap(G,se){return se?"a=rtpmap:".concat(G).concat(R).concat(se.encodingName,"/").concat(se.clockRate).concat(se.encodingParameters?"/".concat(se.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(G,se){let me="a=rtcp-fb:".concat(G).concat(R),$e=se;return $e.type==="trr-int"?me+="ttr-int".concat(R).concat($e.interval):(me+="".concat($e.type),$e.parameter&&(me+="".concat(R).concat($e.parameter),$e.additional&&(me+="".concat(R).concat($e.additional)))),me+this.eol}printPtime(G){return G===void 0?"":"a=ptime:".concat(G).concat(this.eol)}printMaxPtime(G){return G===void 0?"":"a=maxptime:".concat(G).concat(this.eol)}printDirection(G){return G===void 0?"":"a=".concat(G).concat(this.eol)}printSSRC(G){return G.map(se=>Object.keys(se.attributes).map(me=>"a=ssrc:".concat(se.ssrcId.toString(10)).concat(R).concat(me).concat(se.attributes[me]?":".concat(se.attributes[me]):"").concat(this.eol)).join("")).join("")}printRTCPMux(G){return G===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(G){return G===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(G){return G===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(G){if(G===void 0)return"";let se="a=rtcp:".concat(G.port);return G.netType&&(se+="".concat(R).concat(G.netType)),G.addressType&&(se+="".concat(R).concat(G.addressType)),G.address&&(se+="".concat(R).concat(G.address)),se+this.eol}printMSId(G){return G.map(se=>"a=msid:".concat(se.id).concat(se.appdata?"".concat(R).concat(se.appdata):"").concat(this.eol)).join("")}printImageattr(G){return G.map(se=>"a=imageattr:".concat(se).concat(this.eol)).join("")}printRid(G){return G.map(se=>{let me="a=rid:".concat(se.id).concat(R).concat(se.direction);return se.payloads&&(me+="".concat(R,"pt=").concat(se.payloads.join(","))),se.params.length>0&&(me+="".concat(R).concat(se.params.map($e=>$e.type==="depend"?"depend=".concat($e.rids.join(",")):"".concat($e.type,"=").concat($e.val)).join(";"))),me+this.eol}).join("")}printSimulcast(G){return G===void 0?"":"a=simulcast:".concat(G).concat(this.eol)}printSCTPPort(G){return G===void 0?"":"a=sctp-port:".concat(G).concat(this.eol)}printMaxMessageSize(G){return G===void 0?"":"a=max-message-size:".concat(G).concat(this.eol)}printMid(G){return G===void 0?"":"a=mid:".concat(G).concat(this.eol)}printSSRCGroups(G){return G.map(se=>"a=ssrc-group:".concat(se.semantic).concat(se.ssrcIds.map(me=>"".concat(R).concat(me.toString(10))).join("")).concat(this.eol)).join("")}}function Kt(ct){return new Zt().parse(ct)}function jn(ct,G){return new wc().print(ct,G)}}},o={};function c(u){if(o[u])return o[u].exports;var m=o[u]={exports:{}};return n[u](m,m.exports,c),m.exports}return c.d=(u,m)=>{for(var _ in m)c.o(m,_)&&!c.o(u,_)&&Object.defineProperty(u,_,{enumerable:!0,get:m[_]})},c.o=(u,m)=>Object.prototype.hasOwnProperty.call(u,m),c.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})},c(8)})()})(k);var U=k.exports;function J(r){if(Array.isArray(r))return r.map(n=>n);if(!K(r))return r;const e={};for(const n in r){const o=r[n];K(o)||Array.isArray(o)?e[n]=J(o):e[n]=o}return e}function K(r){return!(typeof r!="object"||Array.isArray(r)||!r)}class q{constructor(e){D(this,"input",[]),D(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const te={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},de={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:te,remoteCandidate:te}},he={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},Ue={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},Re={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},Ie={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function De(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Ne(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?De(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):De(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class Xe{constructor(e,n){D(this,"onFirstVideoReceived",void 0),D(this,"onFirstVideoDecoded",void 0),D(this,"onFirstAudioReceived",void 0),D(this,"onFirstVideoDecodedTimeout",void 0),D(this,"onFirstAudioDecoded",void 0),D(this,"onSelectedLocalCandidateChanged",void 0),D(this,"onSelectedRemoteCandidateChanged",void 0),D(this,"videoIsReady",!1),D(this,"videoIsReady2",{}),D(this,"pc",void 0),D(this,"options",void 0),D(this,"intervalTimer",void 0),D(this,"stats",J(de)),D(this,"isFirstVideoReceived",{}),D(this,"isFirstVideoDecoded",{}),D(this,"isFirstAudioReceived",{}),D(this,"isFirstAudioDecoded",{}),D(this,"isFirstVideoDecodedTimeout",{}),D(this,"lossRateWindowStats",[]),this.pc=e,this.options=n,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Ee(e=>{e({local:Ne({},te),remote:Ne({},te)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,n){this.videoIsReady2[e]=n}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const n=this.lossRateWindowStats.length,o=["videoSend","audioSend","videoRecv","audioRecv"];let c=0,u=0,m=0,_=0;for(const S of o)e[S].forEach((C,R)=>{if(!this.lossRateWindowStats[n-1][S][R]||!this.lossRateWindowStats[0][S][R])return;const w=this.lossRateWindowStats[n-1][S][R].packets-this.lossRateWindowStats[0][S][R].packets,N=this.lossRateWindowStats[n-1][S][R].packetsLost-this.lossRateWindowStats[0][S][R].packetsLost;S==="videoSend"||S==="audioSend"?(c+=w,m+=N):(u+=w,_+=N),Number.isNaN(w)||Number.isNaN(w)?C.packetLostRate=0:C.packetLostRate=w<=0||N<=0?0:N/(w+N)});e.sendPacketLossRate=c<=0||m<=0?0:m/(c+m),e.recvPacketLossRate=u<=0||_<=0?0:_/(u+_)}}function nt(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Vt(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?nt(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):nt(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class rn extends Xe{constructor(){super(...arguments),D(this,"_stats",de),D(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),n=this.statsResponsesToObjects(e);this._stats=J(de);const o=n.filter(u=>u.type==="ssrc");this.processSSRCStats(o);const c=n.find(u=>u.type==="VideoBwe");c&&this.processBandwidthStats(c),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(n=>{var o;const c=xe(o=n.id).call(o,"send");switch("".concat(n.mediaType,"_").concat(c?"send":"recv")){case"video_send":{const u=J(Ue);u.codec=n.googCodecName,u.adaptionChangeReason="none",n.googCpuLimitedResolution&&(u.adaptionChangeReason="cpu"),n.googBandwidthLimitedResolution&&(u.adaptionChangeReason="bandwidth"),u.avgEncodeMs=Number(n.googAvgEncodeMs),u.inputFrame={width:Number(n.googFrameWidthInput)||Number(n.googFrameWidthSent),height:Number(n.googFrameHeightInput)||Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},u.sentFrame={width:Number(n.googFrameWidthSent),height:Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},u.firsCount=Number(n.googFirReceived),u.nacksCount=Number(n.googNacksReceived),u.plisCount=Number(n.googPlisReceived),u.frameCount=Number(n.framesEncoded),u.bytes=Number(n.bytesSent),u.packets=Number(n.packetsSent),u.packetsLost=Number(n.packetsLost),u.ssrc=Number(n.ssrc),u.rttMs=Number(n.googRtt||0),this._stats.videoSend.push(u),this._stats.rtt=u.rttMs;break}case"video_recv":{const u=J(he),m=this.lastDecodeVideoReceiverStats.get(Number(n.ssrc));if(u.codec=n.googCodecName,u.targetDelayMs=Number(n.googTargetDelayMs),u.renderDelayMs=Number(n.googRenderDelayMs),u.currentDelayMs=Number(n.googCurrentDelayMs),u.minPlayoutDelayMs=Number(n.googMinPlayoutDelayMs),u.decodeMs=Number(n.googDecodeMs),u.maxDecodeMs=Number(n.googMaxDecodeMs),u.receivedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateReceived)},u.decodedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateDecoded)},u.decodeFrameRate=Number(n.googFrameRateDecoded),u.outputFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateOutput)},u.jitterBufferMs=Number(n.googJitterBufferMs),u.firsCount=Number(n.googFirsSent),u.nacksCount=Number(n.googNacksSent),u.plisCount=Number(n.googPlisSent),u.framesDecodeCount=Number(n.framesDecoded),u.bytes=Number(n.bytesReceived),u.packets=Number(n.packetsReceived),u.packetsLost=Number(n.packetsLost),u.ssrc=Number(n.ssrc),u.packets>0&&!this.isFirstVideoReceived[u.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(u.ssrc),this.isFirstVideoReceived[u.ssrc]=!0),u.framesDecodeCount>0&&!this.isFirstVideoDecoded[u.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(u.ssrc,u.decodedFrame.width,u.decodedFrame.height),this.isFirstVideoDecoded[u.ssrc]=!0),m){const _=m.stats,S=Date.now()-m.lts;u.framesDecodeFreezeTime=_.framesDecodeFreezeTime,u.framesDecodeInterval=_.framesDecodeInterval,u.framesDecodeCount>_.framesDecodeCount&&this.isFirstVideoDecoded[u.ssrc]?(m.lts=Date.now(),u.framesDecodeInterval=S,u.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(n.ssrc,10))?u.framesDecodeFreezeTime+=u.framesDecodeInterval:this.setVideoIsReady2(parseInt(n.ssrc,10),!0))):u.framesDecodeCount<m.stats.framesDecodeCount&&(u.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(u.ssrc,{stats:Vt({},u),lts:Date.now()}),this._stats.videoRecv.push(u);break}case"audio_recv":{const u=J(Ie);u.codec=n.googCodecName,u.outputLevel=Math.abs(Number(n.audioOutputLevel))/32767,u.decodingCNG=Number(n.googDecodingCNG),u.decodingCTN=Number(n.googDecodingCTN),u.decodingCTSG=Number(n.googDecodingCTSG),u.decodingNormal=Number(n.googDecodingNormal),u.decodingPLC=Number(n.googDecodingPLC),u.decodingPLCCNG=Number(n.googDecodingPLCCNG),u.expandRate=Number(n.googExpandRate),u.accelerateRate=Number(n.googAccelerateRate),u.preemptiveExpandRate=Number(n.googPreemptiveExpandRate),u.secondaryDecodedRate=Number(n.googSecondaryDecodedRate),u.speechExpandRate=Number(n.googSpeechExpandRate),u.preferredJitterBufferMs=Number(n.googPreferredJitterBufferMs),u.jitterBufferMs=Number(n.googJitterBufferMs),u.jitterMs=Number(n.googJitterReceived),u.bytes=Number(n.bytesReceived),u.packets=Number(n.packetsReceived),u.packetsLost=Number(n.packetsLost),u.ssrc=Number(n.ssrc),u.receivedFrames=Number(n.googDecodingCTN)||Number(n.packetsReceived),u.droppedFrames=Number(n.googDecodingPLC)+Number(n.googDecodingPLCCNG)||Number(n.packetsLost),u.receivedFrames>0&&!this.isFirstAudioReceived[u.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(u.ssrc),this.isFirstAudioReceived[u.ssrc]=!0),u.decodingNormal>0&&!this.isFirstAudioDecoded[u.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(u.ssrc),this.isFirstAudioDecoded[u.ssrc]=!0),this._stats.audioRecv.push(u);break}case"audio_send":{const u=J(Re);u.codec=n.googCodecName,u.inputLevel=Math.abs(Number(n.audioInputLevel))/32767,u.aecReturnLoss=Number(n.googEchoCancellationReturnLoss||0),u.aecReturnLossEnhancement=Number(n.googEchoCancellationReturnLossEnhancement||0),u.residualEchoLikelihood=Number(n.googResidualEchoLikelihood||0),u.residualEchoLikelihoodRecentMax=Number(n.googResidualEchoLikelihoodRecentMax||0),u.bytes=Number(n.bytesSent),u.packets=Number(n.packetsSent),u.packetsLost=Number(n.packetsLost),u.ssrc=Number(n.ssrc),u.rttMs=Number(n.googRtt||0),this._stats.rtt=u.rttMs,this._stats.audioSend.push(u);break}}})}_getStats(){return new Ee((e,n)=>{this.pc.getStats(e,n)})}statsResponsesToObjects(e){const n=[];return e.result().forEach(o=>{const c={id:o.id,timestamp:o.timestamp.valueOf().toString(),type:o.type};o.names().forEach(u=>{c[u]=o.stat(u)}),n.push(c)}),n}}function ui(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Ki(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?ui(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):ui(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class _i extends Xe{constructor(){super(...arguments),D(this,"_stats",de),D(this,"report",void 0),D(this,"lastDecodeVideoReceiverStats",new Map),D(this,"lastVideoFramesRecv",new Map),D(this,"lastVideoFramesSent",new Map),D(this,"lastVideoFramesDecode",new Map),D(this,"lastVideoJBDelay",new Map),D(this,"lastAudioJBDelay",new Map),D(this,"mediaBytesSent",new Map),D(this,"mediaBytesRetransmit",new Map),D(this,"mediaBytesTargetEncode",new Map),D(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=J(de),this.report.forEach(e=>{switch(e.type){case Gi.OUTBOUND:case Gi.INBOUND:{const n=e.mediaType||e.kind,o=!n&&"frameWidth"in e,c=!n&&!("frameWidth"in e);e.type===Gi.OUTBOUND?n==="audio"||c?this.processAudioOutboundStats(e):(n==="video"||o)&&this.processVideoOutboundStats(e):e.type===Gi.INBOUND&&(n==="audio"||c?this.processAudioInboundStats(e):(n==="video"||o)&&this.processVideoInboundStats(e));break}case Gi.TRANSPORT:{const n=this.report.get(e.selectedCandidatePairId);n&&this.processCandidatePairStats(n);break}case Gi.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),n={local:Ki({},te),remote:Ki({},te)};return e.forEach(o=>{let c;if(o.type===Gi.TRANSPORT&&(c=e.get(o.selectedCandidatePairId)),o.type===Gi.CANDIDATE_PAIR&&o.selected&&(c=o),c){const u=(m,_)=>{m.type=_.type,m.id=_.id,_.address&&(m.address=_.address),_.candidateType&&(m.candidateType=_.candidateType),_.port&&(m.port=_.port),_.priority&&(m.priority=_.priority),_.protocol&&(m.protocol=_.protocol),_.relayProtocol&&(m.relayProtocol=_.relayProtocol)};if(c.localCandidateId){const m=e.get(c.localCandidateId);m&&u(n.local,m)}if(c.remoteCandidateId){const m=e.get(c.remoteCandidateId);m&&u(n.remote,m)}}}),n}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const n=this.report.get(e.localCandidateId);n&&this.processCandidateStats(n)}if(e.remoteCandidateId){const n=this.report.get(e.remoteCandidateId);n&&this.processCandidateStats(n)}}processCandidateStats(e){let n;e.type===Gi.LOCAL_CANDIDATE&&(n=this._stats.selectedCandidatePair.localCandidate),e.type===Gi.REMOTE_CANDIDATE&&(n=this._stats.selectedCandidatePair.remoteCandidate),n&&(n.type=e.type,n.id=e.id,e.address&&(n.address=e.address),e.candidateType&&(n.candidateType=e.candidateType),e.port&&(n.port=e.port),e.priority&&(n.priority=e.priority),e.protocol&&(n.protocol=e.protocol),e.relayProtocol&&(n.relayProtocol=e.relayProtocol),e.type===Gi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==n.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Ki({},n),Ki({},this.stats.selectedCandidatePair.localCandidate)),e.type===Gi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==n.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Ki({},n),Ki({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let n=this._stats.audioRecv.find(o=>o.ssrc===e.ssrc);n||(n=J(Ie),this._stats.audioRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.bytes=e.bytesReceived,n.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),n.receivedFrames||(n.receivedFrames=e.packetsReceived),n.droppedFrames||(n.droppedFrames=e.packetsLost),n.receivedFrames>0&&!this.isFirstAudioReceived[n.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(n.ssrc),this.isFirstAudioReceived[n.ssrc]=!0),n.outputLevel&&n.outputLevel>0&&!this.isFirstAudioDecoded[n.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(n.ssrc),this.isFirstAudioDecoded[n.ssrc]=!0),typeof e.concealedSamples=="number"&&(n.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let n=this._stats.videoRecv.find(m=>m.ssrc===e.ssrc);n||(n=J(he),this._stats.videoRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.bytes=e.bytesReceived,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.framesDecodeCount=e.framesDecoded,n.totalInterFrameDelay=e.totalInterFrameDelay,n.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const o=this.lastDecodeVideoReceiverStats.get(n.ssrc),c=this.lastVideoFramesDecode.get(n.ssrc),u=Date.now();if(n.framesDecodeCount>0&&!this.isFirstVideoDecoded[n.ssrc]){const m=n.decodedFrame?n.decodedFrame.width:0,_=n.decodedFrame?n.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(n.ssrc,m,_),this.isFirstVideoDecoded[n.ssrc]=!0}if(o){const m=o.stats,_=u-o.lts;n.framesDecodeFreezeTime=m.framesDecodeFreezeTime,n.framesDecodeInterval=m.framesDecodeInterval,!this.isFirstVideoDecoded[n.ssrc]&&_>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[n.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(n.ssrc),this.isFirstVideoDecodedTimeout[n.ssrc]=!0),n.framesDecodeCount>m.framesDecodeCount&&this.isFirstVideoDecoded[n.ssrc]?(o.lts=Date.now(),n.framesDecodeInterval=_,n.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?n.framesDecodeFreezeTime+=n.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):n.framesDecodeCount<m.framesDecodeCount&&(n.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(o.stats.framesDecodeCount>e.framesDecoded?n.qpSumPerFrame=e.qpSum/e.framesDecoded:n.qpSumPerFrame=(e.qpSum-o.qpSum)/(e.framesDecoded-o.stats.framesDecodeCount))}c&&u-c.lts>=800?(n.decodeFrameRate=Math.round((n.framesDecodeCount-c.count)/((u-c.lts)/1e3)),this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:u,rate:n.decodeFrameRate})):c?n.decodeFrameRate=c.rate:this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:u,rate:0}),e.totalDecodeTime&&(n.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(n.framesRateFirefox=e.framerateMean),n.packets>0&&!this.isFirstVideoReceived[n.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(n.ssrc),this.isFirstVideoReceived[n.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(n.ssrc,{stats:Ki({},n),lts:o?o.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let n=this._stats.videoSend.find(c=>c.ssrc===e.ssrc);n||(n=J(Ue),this._stats.videoSend.push(n));const o=this.mediaBytesSent.get(e.ssrc);if(o)o.add(e.bytesSent);else{const c=new q(10);c.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,c)}if(e.retransmittedBytesSent!==void 0){const c=this.mediaBytesRetransmit.get(e.ssrc);if(c)c.add(e.retransmittedBytesSent);else{const u=new q(10);u.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,u)}}if(e.totalEncodedBytesTarget){const c=this.mediaBytesTargetEncode.get(e.ssrc);if(c)c.add(e.totalEncodedBytesTarget);else{const u=new q(10);u.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,u)}}if(n.ssrc=e.ssrc,n.bytes=e.bytesSent,n.packets=e.packetsSent,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.frameCount=e.framesEncoded,n.adaptionChangeReason=e.qualityLimitationReason,n.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const c=this.lastEncoderMs.get(e.ssrc);if(!c||c.lastFrameCount>e.framesEncoded)n.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const u=e.framesEncoded-c.lastFrameCount,m=e.totalEncodeTime-c.lastEncoderTime;n.avgEncodeMs=1e3*m/u}}if(e.framesEncoded&&e.qpSum){const c=this.lastEncoderMs.get(e.ssrc);!c||c.lastFrameCount>e.framesEncoded?n.qpSumPerFrame=e.qpSum/e.framesEncoded:n.qpSumPerFrame=(e.qpSum-c.lastQpSum)/(e.framesEncoded-c.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,n),this.processVideoTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else{const c=this.findRemoteStatsId(e.ssrc,Gi.REMOTE_INBOUND);c&&this.processRemoteInboundStats(c,n)}}processAudioOutboundStats(e){let n=this._stats.audioSend.find(o=>o.ssrc===e.ssrc);if(n||(n=J(Re),this._stats.audioSend.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsSent,n.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else{const o=this.findRemoteStatsId(e.ssrc,Gi.REMOTE_INBOUND);o&&this.processRemoteInboundStats(o,n)}}findRemoteStatsId(e,n){var o;const c=Array.from(wd(o=this.report).call(o)).find(u=>u.type===n&&u.ssrc===e);return c?c.id:null}processVideoMediaSource(e,n){const o=this.report.get(e);o&&o.width&&o.height&&o.framesPerSecond&&(n.inputFrame={width:o.width,height:o.height,frameRate:o.framesPerSecond})}processAudioMediaSource(e,n){const o=this.report.get(e);o&&(n.inputLevel=o.audioLevel)}processVideoTrackSenderStats(e,n,o){var c,u,m,_;const S=n?this.report.get(n):void 0,C=(c=S==null?void 0:S.framesSent)!==null&&c!==void 0?c:e.framesSent;if(typeof C!="number")return;let R=(u=S==null?void 0:S.frameWidth)!==null&&u!==void 0?u:e.frameWidth,w=(m=S==null?void 0:S.frameHeight)!==null&&m!==void 0?m:e.frameHeight,N=(_=S==null?void 0:S.framesPerSecond)!==null&&_!==void 0?_:e.framesPerSecond;if(typeof R=="number"&&typeof w=="number"||(R=0,w=0),N==null){const L=Date.now(),H=this.lastVideoFramesSent.get(o.ssrc);H&&L-H.lts>=800?(N=Math.round((C-H.count)/((L-H.lts)/1e3)),this.lastVideoFramesSent.set(o.ssrc,{count:C,lts:L,rate:N})):H?N=H.rate:this.lastVideoFramesSent.set(o.ssrc,{count:C,lts:L,rate:0})}o.sentFrame={width:R,height:w,frameRate:Math.max(0,N)}}processVideoTrackReceiverStats(e,n,o){var c,u,m,_,S;const C=n?this.report.get(n):void 0,R=(c=C==null?void 0:C.framesReceived)!==null&&c!==void 0?c:e.framesReceived,w=(u=C==null?void 0:C.frameWidth)!==null&&u!==void 0?u:e.frameWidth,N=(m=C==null?void 0:C.frameHeight)!==null&&m!==void 0?m:e.frameHeight,L=(_=C==null?void 0:C.jitterBufferDelay)!==null&&_!==void 0?_:e.jitterBufferDelay,H=(S=C==null?void 0:C.jitterBufferEmittedCount)!==null&&S!==void 0?S:e.jitterBufferEmittedCount;if(typeof R=="number"){const j=this.lastVideoFramesRecv.get(o.ssrc),W=Date.now();o.framesReceivedCount=R;let ee=0;j&&W-j.lts>=800?(ee=Math.round((R-j.count)/((W-j.lts)/1e3)),this.lastVideoFramesRecv.set(o.ssrc,{count:R,lts:W,rate:ee})):j?ee=j.rate:this.lastVideoFramesRecv.set(o.ssrc,{count:R,lts:W,rate:0}),o.receivedFrame={width:w||0,height:N||0,frameRate:ee||0},o.decodedFrame={width:w||0,height:N||0,frameRate:o.decodeFrameRate||0},o.outputFrame={width:w||0,height:N||0,frameRate:o.decodeFrameRate||0}}if(L&&H){const j=this.lastVideoJBDelay.get(o.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let W=j.jitterBufferMs;const ee=H-j.jitterBufferEmittedCount;ee>0&&(W=1e3*(L-j.jitterBufferDelay)/ee),o.jitterBufferMs=W,o.currentDelayMs=Math.round(W),this.lastVideoJBDelay.set(o.ssrc,{jitterBufferDelay:L,jitterBufferEmittedCount:H,jitterBufferMs:o.currentDelayMs})}}processAudioTrackSenderStats(e,n,o){var c,u,m,_;const S=n?this.report.get(n):void 0,C=(c=(u=S==null?void 0:S.echoReturnLoss)!==null&&u!==void 0?u:e.echoReturnLoss)!==null&&c!==void 0?c:0,R=(m=(_=S==null?void 0:S.echoReturnLossEnhancement)!==null&&_!==void 0?_:e.echoReturnLossEnhancement)!==null&&m!==void 0?m:0;o.aecReturnLoss=C,o.aecReturnLossEnhancement=R}processAudioTrackReceiverStats(e,n,o){var c,u,m,_,S,C,R;const w=n?this.report.get(n):void 0,N=(c=w==null?void 0:w.removedSamplesForAcceleration)!==null&&c!==void 0?c:e.removedSamplesForAcceleration,L=(u=w==null?void 0:w.totalSamplesReceived)!==null&&u!==void 0?u:e.totalSamplesReceived,H=(m=w==null?void 0:w.jitterBufferDelay)!==null&&m!==void 0?m:e.jitterBufferDelay,j=(_=w==null?void 0:w.jitterBufferEmittedCount)!==null&&_!==void 0?_:e.jitterBufferEmittedCount,W=(S=w==null?void 0:w.audioLevel)!==null&&S!==void 0?S:e==null?void 0:e.audioLevel,ee=(C=w==null?void 0:w.totalSamplesDuration)!==null&&C!==void 0?C:e==null?void 0:e.totalSamplesDuration,re=(R=w==null?void 0:w.concealedSamples)!==null&&R!==void 0?R:e.concealedSamples;if(N&&L&&(o.accelerateRate=N/L),H&&j){const be=this.lastAudioJBDelay.get(o.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let _e=be.jitterBufferMs;const ye=j-be.jitterBufferEmittedCount;ye>0&&(_e=1e3*(H-be.jitterBufferDelay)/ye),o.jitterBufferMs=Math.round(_e),this.lastAudioJBDelay.set(o.ssrc,{jitterBufferDelay:H,jitterBufferEmittedCount:j,jitterBufferMs:o.jitterBufferMs})}o.outputLevel=W;let fe=1920;ee&&L&&(fe=L/ee/50,o.receivedFrames=Math.round(L/fe)),re&&(o.droppedFrames=Math.round(re/fe))}processRemoteInboundStats(e,n){const o=this.report.get(e);o&&(n.packetsLost=o.packetsLost,o.roundTripTime&&(n.rttMs=1e3*o.roundTripTime),o.jitter&&(n.jitterMs=1e3*o.jitter),o.timestamp&&(n.timestamp=o.timestamp))}getCodecFromCodecStats(e){const n=this.report.get(e);if(!n)return"";const o=n.mimeType.match(/\/(.*)$/);return o&&o[1]?o[1]:""}updateSendBitrate(){let e=0,n=null,o=null;this.mediaBytesSent.forEach(u=>{e+=u.diffMean()}),this.mediaBytesRetransmit.forEach(u=>{n=n===null?u.diffMean():n+u.diffMean()}),this.mediaBytesTargetEncode.forEach(u=>{o=o===null?u.diffMean():o+u.diffMean()});const c=n!==null?e-n:e;this._stats.bitrate={actualEncoded:8*c/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},n!==null&&(this._stats.bitrate.retransmit=8*n/(this.options.updateInterval/1e3)),o!==null&&(this._stats.bitrate.targetEncoded=8*o/(this.options.updateInterval/1e3))}}class Ia extends Xe{updateStats(){return Ee.resolve()}}function He(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,c=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const u=function(){const m=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return m&&m[0]?Number(m[0].split("/")[1]):null}();return u?u<76?new rn(r,{updateInterval:e,lossRateInterval:n,freezeRateLimit:o,firstVideoDecodedTimeout:c}):new _i(r,{updateInterval:e,lossRateInterval:n,freezeRateLimit:o,firstVideoDecodedTimeout:c}):function(m){return!!window.RTCStatsReport&&m.getStats()instanceof Ee}(r)?new _i(r,{updateInterval:e,lossRateInterval:n,freezeRateLimit:o,firstVideoDecodedTimeout:c}):new Ia(r,{updateInterval:e,lossRateInterval:n,freezeRateLimit:o,firstVideoDecodedTimeout:c})}function rt(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function mt(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?rt(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):rt(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function Wt(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=arguments.length>3?arguments[3]:void 0;const{filterRTX:c,filterVideoFec:u,filterAudioFec:m,filterAudioCodec:_,filterVideoCodec:S}=e,{useXR:C}=n;let R=[],w=[],N=[],L=[],H=!1,j=!1;if(U.parse(r).mediaDescriptions.forEach(ee=>{o&&o!==ee.attributes.direction||(ee.media.mediaType!=="video"||H||(w=ee.attributes.payloads,L=ee.attributes.extmaps,H=!0),ee.media.mediaType!=="audio"||j||(R=ee.attributes.payloads,N=ee.attributes.extmaps,j=!0))}),!L||w.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!N||R.length===0)throw new Error("Cannot get audio capabilities from SDP.");w.forEach(ee=>{var re;(re=ee.rtpMap)!==null&&re!==void 0&&re.clockRate&&(ee.rtpMap.clockRate=parseInt(ee.rtpMap.clockRate)),C&&ee.rtcpFeedbacks.push({type:"rrtr"})}),R.forEach(ee=>{var re;(re=ee.rtpMap)!==null&&re!==void 0&&re.clockRate&&(ee.rtpMap.clockRate=parseInt(ee.rtpMap.clockRate)),C&&ee.rtcpFeedbacks.push({type:"rrtr"})}),c&&(R=R.filter(ee=>{var re;return((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName.toLowerCase())!=="rtx"}),w=w.filter(ee=>{var re;return((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName.toLowerCase())!=="rtx"})),u&&(w=w.filter(ee=>{var re;return!/(red)|(ulpfec)|(flexfec)/i.test(((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName)||"")})),m&&(R=R.filter(ee=>{var re;return!/(red)|(ulpfec)|(flexfec)/i.test(((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName)||"")})),_&&(_==null?void 0:_.length)>0&&(R=R.filter(ee=>{var re;return xe(_).call(_,((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName.toLowerCase())||"")})),S&&(S==null?void 0:S.length)>0&&(w=w.filter(ee=>{var re;return xe(S).call(S,((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName.toLowerCase())||"")}));const W=oe("UNSUPPORTED_VIDEO_CODEC");return W&&W.length>0&&(w=w.filter(ee=>!(ee.rtpMap&&xe(W).call(W,ee.rtpMap.encodingName.toLowerCase())))),{audioCodecs:R,videoCodecs:w,audioExtensions:N,videoExtensions:L}}function _n(r){const e=U.parse(r);let n,o;for(const c of e.mediaDescriptions){if(!n){const u=c.attributes.iceUfrag,m=c.attributes.icePwd;if(!u||!m)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:u,icePwd:m}}if(!o){const u=c.attributes.fingerprints;u.length>0&&(o={fingerprints:u})}}if(!o&&e.attributes.fingerprints.length>0&&(o={fingerprints:e.attributes.fingerprints}),!o||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:o}}function ot(r,e){const n=[],o=r.attributes.ssrcGroups.filter(m=>m.semantic==="FID"),c=r.attributes.ssrcGroups.find(m=>m.semantic==="SIM"),u=r.attributes.ssrcs;if(c)c.ssrcIds.forEach(m=>{var _;const S=(_=o.find(C=>C.ssrcIds[0]===m))===null||_===void 0?void 0:_.ssrcIds[1];n.push({ssrcId:m,rtx:e?S:void 0})});else if(o.length>0){const m=o[0].ssrcIds[0],_=o[0].ssrcIds[1];n.push({ssrcId:m,rtx:e?_:void 0})}else{if(u.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:u[0].ssrcId})}return n}function B(r,e){const{cname:n}=r;let o;e&&e.ip&&typeof e.port=="number"?(o=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],M.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(o.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),M.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):o=r.iceParameters.candidates.map(_=>({foundation:_.foundation,componentId:"1",transport:_.protocol,priority:_.priority.toString(),connectionAddress:_.ip,port:_.port.toString(),type:_.type,extension:{}}));const c={fingerprints:r.dtlsParameters.fingerprints.map(_=>({hashFunction:_.algorithm,fingerprint:_.fingerprint}))},u={iceUfrag:r.iceParameters.iceUfrag,icePwd:r.iceParameters.icePwd};let m;switch(r.dtlsParameters.role){case"server":m="passive";break;case"client":m="active";break;case"auto":m="actpass"}return{dtlsParameters:c,iceParameters:u,candidates:o,rtpCapabilities:Ro(r.rtpCapabilities),setup:m,cname:n}}function ie(r,e,n){const o=[],c=[];return r.forEach(u=>{let{ssrcId:m,rtx:_}=u;const S=oi(8,"track-"),C={ssrcId:m,attributes:mt({label:S,mslabel:n=n||oi(10,""),msid:"".concat(n," ").concat(S)},e&&{cname:e})};if(o.push(C),_!==void 0){const R={ssrcId:_,attributes:mt({label:S,mslabel:n,msid:"".concat(n," ").concat(S)},e&&{cname:e})};o.push(R),c.push({semantic:"FID",ssrcIds:[m,_]})}}),r.length>1&&c.push({semantic:"SIM",ssrcIds:r.map(u=>{let{ssrcId:m}=u;return m})}),{ssrcs:o,ssrcGroups:c}}function pe(r,e){e instanceof xn&&r.attributes.payloads.forEach(n=>{var o;const c=(o=n.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase();if(!c||["opus","pcmu","pcma","g722"].indexOf(c)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const u=e._encoderConfig;u&&c!=="pcmu"&&c!=="pcma"&&c!=="g722"&&(u.bitrate&&!Ln()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*u.bitrate))),u.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(u.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(u.sampleRate)),u.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1"))})}function Ze(r){const e=r.attributes.unrecognized.findIndex(n=>n.attField==="x-google-flag"&&n.attValue==="conference");e!==-1&&r.attributes.unrecognized.splice(e,1)}function zt(r,e){var n;if(!(e instanceof on&&e._encoderConfig&&e._hints.indexOf(hi.SCREEN_TRACK)===-1))return;const o=e._encoderConfig;Dn().supportMinBitrate&&o.bitrateMin&&r.attributes.payloads.forEach(c=>{var u,m;xe(u=["h264","h265","vp8","vp9","av1"]).call(u,((m=c.rtpMap)===null||m===void 0?void 0:m.encodingName.toLowerCase())||"")&&(c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["x-google-min-bitrate"]="".concat(o.bitrateMin))}),Dn().supportMinBitrate&&!xe(n=e._hints).call(n,hi.LOW_STREAM)&&o.bitrateMax&&r.attributes.payloads.forEach(c=>{var u,m;xe(u=["h264","h265","vp8","vp9","av1"]).call(u,((m=c.rtpMap)===null||m===void 0?void 0:m.encodingName.toLowerCase())||"")&&(c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["x-google-start-bitrate"]="".concat(oe("X_GOOGLE_START_BITRATE")||Math.floor(o.bitrateMax)))})}function Ei(r){if(r.media.mediaType!=="video")return;const e=qt();if(e.name!==Pn.SAFARI&&e.os!==ar.IOS)return;const n=r.attributes.extmaps.findIndex(o=>/video-orientation/g.test(o.extensionName));n!==-1&&r.attributes.extmaps.splice(n,1)}function Mr(r,e,n){if(!e)return;let o,c;if(r.media.mediaType==="video"?(o=n.videoExtensions,c=n.videoCodecs):(o=n.audioExtensions,c=n.audioCodecs),e.twcc===!0){const u=o.find(m=>m.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");u&&(r.attributes.extmaps.find(_=>_.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||r.attributes.extmaps.push({entry:u.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(_,S){return S.filter(C=>!!_.find(R=>R.payloadType===C.payloadType&&!!R.rtcpFeedbacks.find(w=>w.type==="transport-cc")))}(c,r.attributes.payloads).forEach(_=>{_.rtcpFeedbacks.find(S=>S.type==="transport-cc")||_.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(e.twcc===!1){const u=r.attributes.extmaps.findIndex(m=>m.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");u!==-1&&r.attributes.extmaps.splice(u,1),r.attributes.payloads.forEach(m=>{const _=m.rtcpFeedbacks.findIndex(S=>S.type==="transport-cc");_!==-1&&m.rtcpFeedbacks.splice(_,1)})}if(e.remb===!0){const u=o.find(m=>m.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");u&&(r.attributes.extmaps.find(_=>_.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||r.attributes.extmaps.push({entry:u.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(_,S){return S.filter(C=>!!_.find(R=>R.payloadType===C.payloadType&&!!R.rtcpFeedbacks.find(w=>w.type==="goog-remb")))}(c,r.attributes.payloads).forEach(_=>{_.rtcpFeedbacks.find(S=>S.type==="goog-remb")||_.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(e.remb===!1){const u=r.attributes.extmaps.findIndex(m=>m.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");u!==-1&&r.attributes.extmaps.splice(u,1),r.attributes.payloads.forEach(m=>{const _=m.rtcpFeedbacks.findIndex(S=>S.type==="goog-remb");_!==-1&&m.rtcpFeedbacks.splice(_,1)})}}function jo(r,e,n){if(Ln()||r.media.mediaType!=="video"||!(e instanceof on)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!oe("SIMULCAST")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;const o=n==="vp8"?2:e._scalabilityMode.numSpatialLayers,c=r.attributes.ssrcs[0],u=r.attributes.ssrcGroups.find(_=>_.semantic==="FID"&&_.ssrcIds[0]===c.ssrcId),m={semantic:"SIM",ssrcIds:[c.ssrcId]};for(let _=1;_<o;_++)r.attributes.ssrcs.push({ssrcId:c.ssrcId+_,attributes:sn(c.attributes)}),m.ssrcIds.push(c.ssrcId+_),u&&(r.attributes.ssrcs.push({ssrcId:u.ssrcIds[1]+_,attributes:sn(c.attributes)}),r.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[c.ssrcId+_,u.ssrcIds[1]+_]}));r.attributes.ssrcGroups.unshift(m)}async function Bd(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const o=(await n.createOffer()).sdp,{send:c,recv:u,sendrecv:m}=function(){let _=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},S=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},C=arguments.length>2?arguments[2]:void 0;const R=Wt(C,_,S,"sendonly"),w=Wt(C,_,S,"recvonly"),N={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},L={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},H={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Aa(R,w,"videoExtensions",N,L,H),Aa(R,w,"videoCodecs",N,L,H),Aa(R,w,"audioExtensions",N,L,H),Aa(R,w,"audioCodecs",N,L,H),oe("RAISE_H264_BASELINE_PRIORITY")){const j=H.videoCodecs.findIndex(W=>{var ee,re;return((ee=W.rtpMap)===null||ee===void 0?void 0:ee.encodingName.toLocaleLowerCase())==="h264"&&((re=W.fmtp)===null||re===void 0?void 0:re.parameters["profile-level-id"])==="42001f"});if(j!==-1){const W=H.videoCodecs.findIndex(ee=>{var re;return((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName.toLocaleLowerCase())==="h264"});if(W<j){M.debug("raising H264 baseline profile priority");const ee=H.videoCodecs[j];H.videoCodecs.splice(j,1),H.videoCodecs.splice(W,0,ee)}W!==-1&&(L.videoCodecs=L.videoCodecs.filter(ee=>{var re,fe;return!(((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName.toLocaleLowerCase())==="h264"&&((fe=ee.fmtp)===null||fe===void 0?void 0:fe.parameters["profile-level-id"])!=="42001f")})),W!==-1&&oe("FILTER_SEND_H264_BASELINE")&&(N.videoCodecs=N.videoCodecs.filter(ee=>{var re,fe;return!(((re=ee.rtpMap)===null||re===void 0?void 0:re.encodingName.toLocaleLowerCase())==="h264"&&((fe=ee.fmtp)===null||fe===void 0?void 0:fe.parameters["profile-level-id"])!=="42001f")}))}}return{send:N,recv:L,sendrecv:H}}(r,e,o);try{n.close()}catch{}return{send:c,recv:u,sendrecv:m}}function SS(){const r={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=Wt(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Aa(r,e,"videoExtensions",n,o,c),Aa(r,e,"videoCodecs",n,o,c),Aa(r,e,"audioExtensions",n,o,c),Aa(r,e,"audioCodecs",n,o,c),oe("RAISE_H264_BASELINE_PRIORITY")){const u=c.videoCodecs.findIndex(m=>m.rtpMap&&m.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&m.fmtp&&m.fmtp.parameters["profile-level-id"]==="42001f");if(u!==-1){const m=c.videoCodecs.findIndex(_=>_.rtpMap&&_.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(m<u){M.debug("raising H264 baseline profile priority");const _=c.videoCodecs[u];c.videoCodecs.splice(u,1),c.videoCodecs.splice(m,0,_)}m!==-1&&(o.videoCodecs=o.videoCodecs.filter(_=>!(_.rtpMap&&_.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&_.fmtp&&_.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:n,recv:o,sendrecv:c}}function Aa(r,e,n,o,c,u){if(n==="videoExtensions"||n==="audioExtensions"){const m=[];return r[n].forEach(_=>{e[n].some((S,C)=>{if(_.entry===S.entry&&_.extensionName===S.extensionName)return m.push(C),!0})?u[n].push(_):o[n].push(_)}),void e[n].forEach((_,S)=>{m.indexOf(S)===-1&&c[n].push(_)})}if(n==="videoCodecs"||n==="audioCodecs"){const m=[];return r[n].forEach(_=>{e[n].some((S,C)=>{if(_.payloadType===S.payloadType&&JSON.stringify(_)===JSON.stringify(S))return m.push(C),!0})?u[n].push(_):o[n].push(_)}),void e[n].forEach((_,S)=>{m.indexOf(S)===-1&&c[n].push(_)})}}function Ro(r){const{send:e,recv:n,sendrecv:o}=r;if(!o){if(!e||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:n}}let c,u;return e?(c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c.audioCodecs=[...e.audioCodecs,...o.audioCodecs],c.videoCodecs=[...e.videoCodecs,...o.videoCodecs],c.audioExtensions=[...e.audioExtensions,...o.audioExtensions],c.videoExtensions=[...e.videoExtensions,...o.videoExtensions]):c=o,n?(u={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},u.audioCodecs=[...n.audioCodecs,...o.audioCodecs],u.videoCodecs=[...n.videoCodecs,...o.videoCodecs],u.audioExtensions=[...n.audioExtensions,...o.audioExtensions],u.videoExtensions=[...n.videoExtensions,...o.videoExtensions]):u=o,{send:c,recv:u}}function yo(r){r.media.mediaType==="audio"&&r.attributes.payloads.filter(e=>{var n;return((n=e.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function wl(r){r.mediaDescriptions.forEach(e=>{e.media.mediaType!=="video"&&e.media.mediaType!=="audio"||e.attributes.payloads.forEach(n=>{n.rtcpFeedbacks.findIndex(o=>o.type==="rrtr")===-1&&n.rtcpFeedbacks.push({type:"rrtr"})})})}function vi(r,e,n,o){let c=[];if(r===gt.VIDEO){if(oe("H264_PROFILE_LEVEL_ID")&&o==="h264"&&(c=e.videoCodecs.filter(u=>{var m;return xe(m=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(m,o)&&u&&u.fmtp&&u.fmtp.parameters["profile-level-id"]===oe("H264_PROFILE_LEVEL_ID")})),!Array.isArray(c)||c.length===0){let u=[];const m=[],_=[];n.videoCodecs.forEach(S=>{var C,R,w;xe(C=S.rtpMap&&S.rtpMap.encodingName.toLowerCase()||"").call(C,o)&&u.push(S),xe(R=S.rtpMap&&S.rtpMap.encodingName.toLowerCase()||"").call(R,"vp8")&&m.push(S),xe(w=S.rtpMap&&S.rtpMap.encodingName.toLowerCase()||"").call(w,"h264")&&_.push(S)}),u.length===0&&(m.length!==0?(u=m,M.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: vp8"))):_.length!==0&&(u=_,M.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: h264")))),u.length!==0&&(c=e.videoCodecs.filter(S=>u.some(C=>C.payloadType===S.payloadType)))}if(oe("USE_PUB_RTX")){const u=c.map(_=>_.payloadType.toString()),m=e.videoCodecs.filter(_=>_.rtpMap&&_.rtpMap.encodingName==="rtx"&&xe(u).call(u,_.fmtp&&_.fmtp.parameters.apt||""));c=[...c,...m]}c.length===0&&(M.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),c=e.videoCodecs)}else c=e.audioCodecs.filter(u=>{var m;return xe(m=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(m,o)}),c.length===0&&(M.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),c=e.audioCodecs.filter(u=>{var m;return xe(m=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(m,"opus")}));return c}let Er=class{get localCapabilities(){return sn(this._localCapabilities)}get rtpCapabilities(){return sn(this._rtpCapabilities)}get candidates(){return sn(this._candidates)}get iceParameters(){return sn(this._iceParameters)}get dtlsParameters(){return sn(this._dtlsParameters)}constructor(r){D(this,"sessionDesc",void 0),D(this,"_localCapabilities",void 0),D(this,"_rtpCapabilities",void 0),D(this,"_candidates",void 0),D(this,"_iceParameters",void 0),D(this,"_dtlsParameters",void 0),D(this,"setup",void 0),D(this,"currentMidIndex",void 0),D(this,"cname","o/i14u9pJrxRKAsu"),D(this,"firefoxSsrcMidMap",new Map),r=sn(r);const{remoteIceParameters:e,remoteDtlsParameters:n,candidates:o,remoteRTPCapabilities:c,localCapabilities:u,direction:m,setup:_,videoCodec:S,audioCodec:C}=r;let R;this.setup=_,R=m===st.RECEIVE_ONLY?U.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):U.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=c,this._candidates=o,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=u;const w=m===st.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,N=m===st.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,L=m===st.RECEIVE_ONLY?c.send.videoCodecs:vi(gt.VIDEO,w,N,S),H=m===st.RECEIVE_ONLY?c.send.audioCodecs:vi(gt.AUDIO,w,N,C);for(const j of R.mediaDescriptions){if(j.attributes.iceUfrag=e.iceUfrag,j.attributes.icePwd=e.icePwd,j.attributes.fingerprints=n.fingerprints,j.attributes.candidates=o,j.attributes.setup=this.setup,j.media.mediaType==="application"&&(j.attributes.sctpPort="5000"),j.media.mediaType==="video"&&(j.media.fmts=L.map(W=>W.payloadType.toString(10)),j.attributes.payloads=L,j.attributes.extmaps=w.videoExtensions,oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:W,ssrcGroups:ee}=ie([{ssrcId:4e4,rtx:oe("USE_SUB_RTX")?40001:void 0}],this.cname);j.attributes.ssrcs=W,j.attributes.ssrcGroups=ee}if(j.media.mediaType==="audio"&&(j.media.fmts=H.map(W=>W.payloadType.toString(10)),j.attributes.payloads=H,j.attributes.extmaps=w.audioExtensions,yo(j),oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:W,ssrcGroups:ee}=ie([{ssrcId:2e4}],this.cname);j.attributes.ssrcs=W,j.attributes.ssrcGroups=ee}}this.sessionDesc=R,this.currentMidIndex=R.mediaDescriptions.length-1}toString(){return U.print(this.sessionDesc)}hasMid(r){return Array.isArray(r)?r.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===r)}send(r,e,n,o,c){n=n.replace(/ /g,"-");const{ssrcs:u,ssrcGroups:m}=ie(e,this.cname,oe("SYNC_GROUP")?n:void 0),_=this.findPreloadMediaDesc(u);if(_){if(Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,_.attributes.mid),c&&(c.twcc||c.remb)){const S=this.sessionDesc.mediaDescriptions.indexOf(_);return this.sessionDesc.mediaDescriptions[S]=this.mungSendMediaDesc(_,c),{mid:_.attributes.mid,needExchangeSDP:!0}}return{mid:_.attributes.mid,needExchangeSDP:!1}}{const S=this.findAvailableMediaIndex(r,u,o);let C;return S===-1?(C=this.createOrRecycleSendMedia(r,u,m,"sendonly",o,c),this.updateBundleMids()):(C=sn(this.sessionDesc.mediaDescriptions[S]),C.attributes.direction="sendonly",C.attributes.ssrcs=u,C.attributes.ssrcGroups=m,this.sessionDesc.mediaDescriptions[S]=this.mungSendMediaDesc(C,c)),Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,C.attributes.mid),{needExchangeSDP:!0,mid:C.attributes.mid}}}stopSending(r){const e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&r.indexOf(n.attributes.mid)!==-1);if(e.length!==r.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.ssrcs=[]}),this.updateBundleMids()}receive(r,e,n){const o=[];return r.forEach(c=>{const u=c._mediaStreamTrack.kind,m=this.findAvailableRecvMediaIndex(u);let _,S=!1;m===-1?(S=!0,_=this.createOrRecycleRecvMedia(c,[],"recvonly",e,n),this.updateBundleMids()):(_=sn(this.sessionDesc.mediaDescriptions[m]),_.attributes.direction="recvonly"),o.push({mid:_.attributes.mid,needCreateTransceiver:S})}),o}stopReceiving(r){const e=this.sessionDesc.mediaDescriptions.filter(n=>r.indexOf(n.attributes.mid)!==-1);if(e.length!==r.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(r){const{foundation:e,protocol:n,address:o,port:c,type:u,relatedAddress:m,relatedPort:_,priority:S}=new RTCIceCandidate(r),C={foundation:e??"",componentId:"1",transport:n??"",priority:S?S+"":"",connectionAddress:o??"",port:c?c+"":"",type:u?u+"":"",relAddr:m??"",relPort:_?_+"":"",extension:{}};this.candidates.some(R=>R.priority===C.priority&&R.connectionAddress===C.connectionAddress&&R.port===C.port)||(this._candidates.push(C),this.sessionDesc.mediaDescriptions.forEach(R=>{R.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(r,e,n,o,c){const u=r._mediaStreamTrack.kind,m=this.rtpCapabilities.recv,_=vi(u,m,this.localCapabilities.send,u===gt.AUDIO?c:o),S=u===gt.VIDEO?m.videoExtensions:m.audioExtensions,C="".concat(++this.currentMidIndex);let R={media:{mediaType:u,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:_.map(N=>N.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:S,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:_,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(C)}};R=this.mungRecvMediaDsec(R,r);const w=this.findFirstClosedMedia(u);if(w){const N=this.sessionDesc.mediaDescriptions.indexOf(w);this.sessionDesc.mediaDescriptions[N]=R}else this.sessionDesc.mediaDescriptions.push(R);return R}muteRemote(r){const e=this.sessionDesc.mediaDescriptions.filter(n=>xe(r).call(r,n.attributes.mid||""));if(e.length!==r.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(r){const e=this.sessionDesc.mediaDescriptions.filter(n=>xe(r).call(r,n.attributes.mid||""));if(e.length!==r.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly"})}findAvailableMediaIndex(r,e,n){return this.sessionDesc.mediaDescriptions.findIndex(o=>{const c=o.media.mediaType===r&&o.media.port!=="0"&&(o.attributes.direction==="sendonly"||o.attributes.direction==="sendrecv")&&o.attributes.ssrcs.length===0;if(Ln()){if(c){const u=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(u||o.attributes.mid!=="0"&&o.attributes.mid!=="1")||!(!u||u!==o.attributes.mid)}return!1}return c&&o.attributes.mid===n})}findAvailableRecvMediaIndex(r){return this.sessionDesc.mediaDescriptions.findIndex(e=>{const n=e.media.mediaType===r&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&n})}predictReceivingMids(r){const e=[];for(let n=0;n<r;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}restartICE(r){r=sn(r),this._iceParameters=r,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=r.iceUfrag,e.attributes.icePwd=r.icePwd})}createOrRecycleSendMedia(r,e,n,o,c,u){const m=this.rtpCapabilities.send,_=r===gt.VIDEO?m.videoCodecs:m.audioCodecs,S=r===gt.VIDEO?m.videoExtensions:m.audioExtensions;Ln()&&(c="".concat(++this.currentMidIndex));let C={media:{mediaType:r,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:_.map(w=>w.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:S,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:_,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:o,rtcpMux:!0,rtcpRsize:!0,mid:c}};C=this.mungSendMediaDesc(C,u);const R=this.findFirstClosedMedia(r);if(R){const w=this.sessionDesc.mediaDescriptions.indexOf(R);this.sessionDesc.mediaDescriptions[w]=C}else this.sessionDesc.mediaDescriptions.push(C);return C}mungRecvMediaDsec(r,e,n){const o=sn(r);return Ze(o),pe(o,e),zt(o,e),Ei(o),Mr(o,n,this.localCapabilities.send),o}mungSendMediaDesc(r,e){const n=sn(r);return Mr(n,e,this.localCapabilities.recv),yo(n),n}updateRecvMedia(r,e){const n=this.sessionDesc.mediaDescriptions.findIndex(o=>o.attributes.mid===r);if(n!==-1){const o=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=o}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(r=>r.media.port!=="0").map(r=>r.attributes.mid)}findPreloadMediaDesc(r){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===r[0].ssrcId})}findFirstClosedMedia(r){return this.sessionDesc.mediaDescriptions.find(e=>Ln()?e.media.port==="0"&&e.media.mediaType===r:e.media.port==="0")}};const Ri=["sdp"];function ta(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Bo(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?ta(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):ta(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}let $n=class Sv extends Hi{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,n,o){super(e,n),D(this,"direction",void 0),D(this,"name",void 0),D(this,"store",void 0),D(this,"spec",void 0),D(this,"peerConnection",void 0),D(this,"initialOffer",void 0),D(this,"transport",void 0),D(this,"statsFilter",void 0),D(this,"localCandidateCount",0),D(this,"allCandidatesReceived",!1),D(this,"localCandidateAddress",null),D(this,"useXR",oe("USE_XR")),D(this,"filter",{filterRTX:!oe("USE_PUB_RTX")&&!oe("USE_SUB_RTX"),filterVideoFec:oe("FILTER_VIDEO_FEC"),filterAudioFec:oe("FILTER_AUDIO_FEC")}),D(this,"extension",{useXR:this.useXR}),D(this,"_isInRestartIce",!1),D(this,"mutex",new Zr("P2PConnection-mutex")),D(this,"onLocalCandidate",void 0),D(this,"remoteSDP",void 0),D(this,"pendingCandidates",[]),D(this,"localCapabilities",void 0),D(this,"isReady",!1),D(this,"restartCnt",0),D(this,"curTurnServerIndex",0),this.store=n,this.spec=e,this.peerConnection=new RTCPeerConnection(Sv.resolvePCConfiguration(e,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=o??st.SEND_ONLY,this.name=this.direction===st.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=He(this.peerConnection,oe("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const n=await Bd(this.filter,this.extension);if(this.localCapabilities=Ro(n),e){const{sdp:o}=e,c=b(e,Ri),u=function(){const R={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},w=Wt(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),N={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},L={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},H={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Aa(w,R,"videoExtensions",N,L,H),Aa(w,R,"videoCodecs",N,L,H),Aa(w,R,"audioExtensions",N,L,H),Aa(w,R,"audioCodecs",N,L,H),oe("RAISE_H264_BASELINE_PRIORITY")){const j=H.videoCodecs.findIndex(W=>W.rtpMap&&W.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&W.fmtp&&W.fmtp.parameters["profile-level-id"]==="42001f");if(j!==-1){const W=H.videoCodecs.findIndex(ee=>ee.rtpMap&&ee.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(W<j){M.debug("raising H264 baseline profile priority");const ee=H.videoCodecs[j];H.videoCodecs.splice(j,1),H.videoCodecs.splice(W,0,ee)}W!==-1&&oe("FILTER_SEND_H264_BASELINE")&&(N.videoCodecs=N.videoCodecs.filter(ee=>!(ee.rtpMap&&ee.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&ee.fmtp&&ee.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:N,recv:L,sendrecv:H}}(this.filter,this.extension,o);this.remoteSDP=new Er({remoteIceParameters:c.iceParameters,remoteDtlsParameters:c.dtlsParameters,candidates:[],remoteRTPCapabilities:u,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const m=await this.peerConnection.createAnswer();if(!m.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const _=_n(m.sdp);await this.peerConnection.setLocalDescription(m);const S=await SS(this.filter,this.extension,m.sdp);this.localCapabilities=Ro(S);const C=this.peerConnection.getTransceivers()[0];return C!=null&&C.receiver&&C.receiver.transport&&this.tryBindTransportEvents(C.receiver.transport),Bo(Bo({},_),{},{sdp:m.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const o=await this.peerConnection.createOffer();if(!o.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const c=_n(o.sdp);return this.initialOffer=o,Bo(Bo({},c),{},{sdp:o.sdp})}}catch(n){throw new ke(Q.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:o,dtlsParameters:c}=e,u=await SS(this.filter,this.extension,n);this.remoteSDP=new Er({remoteIceParameters:o,remoteDtlsParameters:c,candidates:[],remoteRTPCapabilities:u,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const m=this.peerConnection.getTransceivers()[0];m!=null&&m.sender&&m.sender.transport&&this.tryBindTransportEvents(m.sender.transport)}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(n=>{this.peerConnection.addIceCandidate(n)}),this.pendingCandidates=[])}catch(n){throw new ke(Q.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(e,n,o){var c=this;return Fo(function*(){const u=yield Qt(c.mutex.lock("From P2PConnection.send"));try{if(!c.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const m=[],_=c.remoteSDP.receive(e,n,o);e.forEach((W,ee)=>{if(_[ee].needCreateTransceiver){const re=c.peerConnection.addTransceiver(W._mediaStreamTrack,{direction:"sendonly"});m.push(re),W._updateRtpTransceiver(re)}else{const re=c.peerConnection.getTransceivers().find(fe=>fe.mid===_[ee].mid);if(!re)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(_[ee].mid));m.push(re),W._updateRtpTransceiver(re)}}),Ln()&&oe("SIMULCAST")===!0&&(yield Qt(c.applySimulcastForFirefox(m,e)));const S=_.map(W=>W.mid),C=yield Qt(c.peerConnection.createOffer()),R=c.mungSendOfferSDP(C.sdp,e,S),w=U.parse(R),N=S.map(W=>{const ee=w.mediaDescriptions.find(re=>re.attributes.mid===W);if(!ee)throw new Error("Cannot extract ssrc from mediaDescription.");return ot(ee,oe("USE_PUB_RTX"))}),L=m.map((W,ee)=>{const re=S[ee];return{localSSRC:N[ee],id:re}});yield Qt(c.peerConnection.setLocalDescription({type:"offer",sdp:R}));try{yield L}catch(W){const ee=c.remoteSDP.toString();throw yield Qt(c.peerConnection.setLocalDescription({type:"offer",sdp:R})),yield Qt(c.peerConnection.setRemoteDescription({type:"answer",sdp:ee})),yield Qt(c.stopSending(S,!0)),W}yield Qt(c.applySimulcastEncodings(m,e)),yield Qt(c.applySendEncodings(m,e));const H=c.remoteSDP.toString(),j=c.logSDPExchange(R,"offer","local","send");return j==null||j(H),yield Qt(c.setRemoteDescription({type:"answer",sdp:H})),m.map((W,ee)=>{const re=S[ee];return{localSSRC:N[ee],id:re}})}catch(m){throw m instanceof ke?m:new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(m.toString()))}finally{u()}})()}async stopSending(e,n){const o=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const c=this.peerConnection.getTransceivers().filter(S=>e.indexOf(S.mid)!==-1);if(c.length!==e.length)throw new Error("Transceivers' length (".concat(c.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));c.map(S=>{var C;S.direction="inactive",(C=S.stop)===null||C===void 0||C.call(S)});const u=await this.peerConnection.createOffer(),m=this.logSDPExchange(u.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(u),this.remoteSDP.stopReceiving(e);const _=this.remoteSDP.toString();m==null||m(_),await this.setRemoteDescription({type:"answer",sdp:_})}catch(c){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(c.toString()))}finally{o&&o()}}async receive(e,n,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:m}=this.remoteSDP.send(e,n,o,c);if(m){const S=this.remoteSDP.toString(),C=this.logSDPExchange(S,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:S});const R=await this.peerConnection.createAnswer(),w=this.mungReceiveAnswerSDP(R.sdp,u,e);C==null||C(w||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:w}),M.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else M.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const _=this.peerConnection.getTransceivers().find(S=>S.mid===u);if(!_||_.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:_.receiver.track,mid:_.mid,transceiver:_}}catch(u){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async mockReceive(e,n,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:m}=this.remoteSDP.send(e,n,o,c);if(m){const _=this.remoteSDP.toString(),S=this.logSDPExchange(_,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:_});const C=await this.peerConnection.createAnswer(),R=this.mungReceiveAnswerSDP(C.sdp,u,e);S==null||S(R||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:R}),M.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else M.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(u){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===dl.Auto&&(this.store.p2pTransport=dl.SdRtn,Dn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Sv.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Dn().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Sv.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:o}=_n(n.sdp);return this.store.descriptionStart(),this.direction===st.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),o}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===st.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:o}=_n(n.sdp);return await this.peerConnection.setLocalDescription(n),o}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const u=this.remoteSDP.toString(),m=this.logSDPExchange(c,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),m==null||m(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new ke(Q.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,n){const o=this.peerConnection.getTransceivers().filter(c=>c.mid===e);o.length===1&&(this.isVP8Simulcast(n)?Ln()||await this.applySimulcastEncodings(o,[n]):await this.applySendEncodings(o,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const o=this.peerConnection.getTransceivers().find(c=>c.mid===n);o&&await o.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:o,remote:c}=n.getSelectedCandidatePair();return{local:Bo(Bo({},te),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port}),remote:Bo(Bo({},te),{},{candidateType:c.type,protocol:c.protocol,address:c.address,port:c.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,n;xe(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var n;e.candidate.candidate&&(this.localCandidateAddress=e.candidate.address,(n=this.onLocalCandidate)===null||n===void 0||n.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else this.allCandidatesReceived=!0,M.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,n){let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const c={iceServers:[]};var u;return e.iceServers?c.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Bi(e.turnServer.servers)?c.iceServers=e.turnServer.servers:(c.iceServers&&c.iceServers.push(...Sv.turnServerConfigToIceServers(e.turnServer.servers,n,o)),oe("USE_TURN_SERVER_OF_GATEWAY")&&c.iceServers&&e.turnServer.serversFromGateway&&c.iceServers.push(...Sv.turnServerConfigToIceServers(e.turnServer.serversFromGateway,n,o)),xe(u=[dl.Relay,dl.SdRtn]).call(u,n)&&(c.iceTransportPolicy="relay"),oe("FORCE_TURN_TCP")?c.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(m=>{m.forceturn&&(c.iceTransportPolicy="relay")}))),oe("ENABLE_ENCODED_TRANSFORM")&&Dn().supportWebRTCEncodedTransform&&(c.encodedInsertableStreams=!0),M.debug("P2PConnection p2pTransport is ".concat(n)),c}static turnServerConfigToIceServers(e,n){let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const c=[],u=e.filter(_=>_.tcpport);M.debug("P2PConnection turnServers is ".concat(u,", current index is ").concat(o));const m=u.length>o?u[o]:u[0];switch(n){case dl.SdRtn:const _=e.filter(C=>{var R;return xe(R=C.username).call(R,"glb:")&&C.turnServerURL==C.turnServerURL}),S=_.length>o?_[o]:_[0];S&&(c.push({username:S.username,credential:S.password,credentialType:"password",urls:"turn:".concat(_h(S.turnServerURL),":").concat(S.tcpport,"?transport=udp")}),c.push({username:S.username,credential:S.password,credentialType:"password",urls:"turns:".concat(_h(S.turnServerURL),":").concat(S.tcpport,"?transport=tcp")}));break;case dl.Relay:m&&(c.push({username:m.username,credential:m.password,credentialType:"password",urls:"turn:".concat(m.turnServerURL,":").concat(m.tcpport,"?transport=udp")}),c.push({username:m.username,credential:m.password,credentialType:"password",urls:"turns:".concat(_h(m.turnServerURL),":").concat(m.tcpport,"?transport=tcp")}));break;default:m&&(c.push({username:m.username,credential:m.password,credentialType:"password",urls:"turn:".concat(m.turnServerURL,":").concat(m.tcpport,"?transport=udp")}),c.push({username:m.username,credential:m.password,credentialType:"password",urls:"turns:".concat(_h(m.turnServerURL),":").concat(m.tcpport,"?transport=tcp")}),c.push({username:m.username,credential:m.password,credentialType:"password",urls:"stun:".concat(m.turnServerURL,":").concat(m.tcpport)}))}return c}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var o;e!=null&&e.state&&((o=this.onDTLSTransportStateChange)===null||o===void 0||o.call(this,e.state))},e.onerror=o=>{var c;(c=this.onDTLSTransportError)===null||c===void 0||c.call(this,"error"in o?o.error:o)};const n=e.iceTransport;n&&(n.onstatechange=()=>{const o=e==null?void 0:e.iceTransport.state;var c;o&&((c=this.onICETransportStateChange)===null||c===void 0||c.call(this,o))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:o,remote:c}=n.getSelectedCandidatePair();M.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol}),", remote ").concat(JSON.stringify({candidateType:c.type,protocol:c.protocol,address:c.address,port:c.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var o;if(n||(n=this.peerConnection.getSenders().find(R=>R.track===e._mediaStreamTrack)),!n)return M.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return M.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Dn().supportSetRtpSenderParameters)return M.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const c={},u={};switch(e._optimizationMode){case"motion":c.degradationPreference="maintain-framerate";break;case"detail":c.degradationPreference="maintain-resolution";break;default:c.degradationPreference="balanced"}if(e._encoderConfig){var m;const{bitrateMax:R,frameRate:w,scaleResolutionDownBy:N}=e._encoderConfig;R&&(u.maxBitrate=1e3*R),xe(m=e._hints).call(m,hi.LOW_STREAM)&&(w&&(u.maxFramerate=Yo(w)),N&&N>=1&&(u.scaleResolutionDownBy=N))}if(oe("DSCP_TYPE")&&bn()){var _;const R=oe("DSCP_TYPE");xe(_=["very-low","low","medium","high"]).call(_,R)&&(u.networkPriority=R)}const S=n.getParameters(),C=(o=S.encodings)===null||o===void 0?void 0:o[0];Ln()&&!C&&(c.encodings=[u]),C&&Object.assign(C,u),Object.assign(S,c),M.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(S.encodings))),await n.setParameters(S)}async applySendEncodings(e,n){try{if(!Dn().supportSetRtpSenderParameters||e.length!==n.length)return;for(let o=0;o<e.length;o++){const c=e[o],u=n[o];u instanceof on&&!this.isVP8Simulcast(u)&&await this.updateRtpSenderEncodings(u,c.sender)}}catch{M.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,o){const c=U.parse(e);return n.forEach((u,m)=>{const _=o[m],S=c.mediaDescriptions.find(C=>C.attributes.mid===_);S&&(pe(S,u),jo(S,u,this.store.codec))}),U.print(c)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,n,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let S=0;S<e.length;S++){var o,c,u,m,_;const C=e[S],R=n[S];if(R instanceof on&&!xe(o=R._hints).call(o,hi.LOW_STREAM)&&(c=R._encoderConfig)!==null&&c!==void 0&&c.bitrateMax&&((u=R._encoderConfig)===null||u===void 0?void 0:u.bitrateMax)>200&&(m=R._scalabilityMode)!==null&&m!==void 0&&m.numSpatialLayers&&((_=R._scalabilityMode)===null||_===void 0?void 0:_.numSpatialLayers)>1&&this.store.codec==="vp8"){const w={},N={high:1e3*(R._encoderConfig.bitrateMax-50),medium:5e4};w.encodings=[{rid:"m",active:!0,maxBitrate:N.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:N.high}];const L=C.sender.getParameters();await C.sender.setParameters(Object.assign(L,w))}}}async applySimulcastEncodings(e,n){if(!Ln()&&e.length===n.length)for(let o=0;o<e.length;o++){const c=n[o];if(c instanceof on&&this.isVP8Simulcast(c)){const u=e[o],m={},_={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:_.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:_.medium,scaleResolutionDownBy:4}];const S=u.sender.getParameters();await u.sender.setParameters(Object.assign(S,m))}}}isVP8Simulcast(e){var n,o,c,u,m;return!!(e instanceof on&&oe("SIMULCAST")&&this.store.codec==="vp8"&&!xe(n=e._hints).call(n,hi.LOW_STREAM)&&(o=e._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((c=e._encoderConfig)===null||c===void 0?void 0:c.bitrateMax)>200&&(u=e._scalabilityMode)!==null&&u!==void 0&&u.numSpatialLayers&&((m=e._scalabilityMode)===null||m===void 0?void 0:m.numSpatialLayers)>1)}logSDPExchange(e,n,o,c){if(oe("SDP_LOGGING"))return M.upload("[".concat(this.store.clientId,"] exchanging ").concat(o," ").concat(n," SDP during P2PConnection.").concat(c,`
`),e),n==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(m=>m.mid&&e.indexOf(m.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(m=>{m.direction="inactive"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.muteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.setRemoteDescription({type:"answer",sdp:u})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(m=>m.mid&&e.indexOf(m.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async m=>{m.direction="sendonly"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.unmuteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.setRemoteDescription({type:"answer",sdp:u})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(e,n){var o,c;if(n=(o=n)!==null&&o!==void 0?o:(c=this.currentRemoteDescription)===null||c===void 0?void 0:c.sdp){var u;const m=(u=U.parse(n).mediaDescriptions.find(_=>_.attributes.mid===e))===null||u===void 0?void 0:u.attributes.ssrcs;return m==null?void 0:m[0].ssrcId}}async setRemoteDescription(e){var n;await this.peerConnection.setRemoteDescription(e),xe(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,n,o){const c=U.parse(e),u=c.mediaDescriptions.find(m=>m.attributes.mid===n);return u&&(o===gt.AUDIO&&u.media.mediaType==="audio"&&yo(u),this.useXR&&wl(c)),U.print(c)}};function mn(r,e,n){const o=r[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const c=this.mutex,u=await c.lock("From P2PConnection.".concat(e));try{for(var m=arguments.length,_=new Array(m),S=0;S<m;S++)_[S]=arguments[S];return await o.apply(this,_)}finally{u()}},n}function Io(r,e){let n=document.createElement("video"),o=document.createElement("canvas");n.setAttribute("style","display:none"),o.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),o.width=Yo(e.width),o.height=Yo(e.height);const c=Yo(e.framerate||15);document.body.append(n),document.body.append(o);let u=r._mediaStreamTrack;n.srcObject=new MediaStream([u]),n.play();const m=o.getContext("2d");if(!m)throw new Te(Q.UNEXPECTED_ERROR,"can not get canvas context");const _=Dn(),S=o.captureStream(_.supportRequestFrame?0:c).getVideoTracks()[0];S.canvas||(S.canvas=o),o.startCapture=()=>{if(!n)return o.stopCapture&&o.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const R=n.videoWidth,w=n.videoHeight/R,N=o.width*w;Math.abs(N-o.height)>=2&&(M.debug("adjust low stream resolution","".concat(o.width,"x").concat(o.height," -> ").concat(o.width,"x").concat(N)),o.height=N)}m.drawImage(n,0,0,o.width,o.height),S.requestFrame&&S.requestFrame(),u!==r._mediaStreamTrack&&(u=r._mediaStreamTrack,n.srcObject=new MediaStream([u]))},o.stopCapture=Xw(()=>o.startCapture&&o.startCapture(),c);const C=S.stop;return S.stop=()=>{C.call(S),n&&(n.remove(),n.srcObject=null,n=null),o&&(o.width=0,o.remove(),o.stopCapture&&o.stopCapture(),o.startCapture=void 0,o.stopCapture=void 0,o=null),M.debug("clean low stream renderer")},S}var rd,sd,Ur,zf,co,uv,K3,gm,Gd,Y3,od;Ge([mn,z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],$n.prototype,"establish",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],$n.prototype,"connect",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[String,Array,String,String]),z("design:returntype",Ee)],$n.prototype,"receive",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[String,Array,String,String]),z("design:returntype",Ee)],$n.prototype,"mockReceive",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],$n.prototype,"stopReceiving",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],$n.prototype,"restartICE",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],$n.prototype,"close",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],$n.prototype,"updateEncoderConfig",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],$n.prototype,"updateSendParameters",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[di,String]),z("design:returntype",Ee)],$n.prototype,"replaceTrack",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],$n.prototype,"muteLocal",null),Ge([mn,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],$n.prototype,"unmuteLocal",null),function(r){r[r.HEIGHT=2033]="HEIGHT",r[r.FRAME_RATE=2034]="FRAME_RATE",r[r.WIDTH=2035]="WIDTH"}(rd||(rd={})),function(r){r[r.HEIGHT=2072]="HEIGHT",r[r.FRAME_RATE=2074]="FRAME_RATE",r[r.WIDTH=2076]="WIDTH"}(sd||(sd={})),function(r){r[r.FRAME_RATE=2002]="FRAME_RATE",r[r.WIDTH=2003]="WIDTH",r[r.HEIGHT=2004]="HEIGHT",r[r.PACKAGE_LOST=2005]="PACKAGE_LOST",r[r.AVG_ENCODE=2007]="AVG_ENCODE",r[r.NACKS=2009]="NACKS",r[r.PLIS=2010]="PLIS",r[r.FIRS=2011]="FIRS",r[r.BITRATE=2012]="BITRATE",r[r.PACKAGE_RATE=2031]="PACKAGE_RATE",r[r.ADAPTATION=2032]="ADAPTATION",r[r.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",r[r.BANDWIDTH=2061]="BANDWIDTH",r[r.RETRANSMIT=2062]="RETRANSMIT",r[r.TARGET_ENCODED=2064]="TARGET_ENCODED",r[r.TRANSMIT=2066]="TRANSMIT",r[r.FREEZE=2082]="FREEZE",r[r.DISABLED=2095]="DISABLED",r[r.PLAYER_STATUS=2128]="PLAYER_STATUS",r[r.QP_SUM=2143]="QP_SUM"}(Ur||(Ur={})),function(r){r[r.BITRATE=2069]="BITRATE",r[r.PACKAGE_LOST=2070]="PACKAGE_LOST",r[r.PACKAGE_RATE=2071]="PACKAGE_RATE",r[r.HEIGHT=2073]="HEIGHT",r[r.FRAME_RATE=2075]="FRAME_RATE",r[r.WIDTH=2077]="WIDTH"}(zf||(zf={})),function(r){r[r.JITTER=-1]="JITTER",r[r.PACKAGE_LOST=2014]="PACKAGE_LOST",r[r.WIDTH=2018]="WIDTH",r[r.HEIGHT=2019]="HEIGHT",r[r.FRAME_RATE=2020]="FRAME_RATE",r[r.JITTER_BUFFER=2023]="JITTER_BUFFER",r[r.CURRENT_DELAY=2024]="CURRENT_DELAY",r[r.NACKS=2026]="NACKS",r[r.PLIS=2027]="PLIS",r[r.FIRS=2028]="FIRS",r[r.BITRATE=2029]="BITRATE",r[r.PACKAGE_RATE=2078]="PACKAGE_RATE",r[r.FREEZE=2084]="FREEZE",r[r.DISABLED=2101]="DISABLED",r[r.PLAYER_STATUS=2129]="PLAYER_STATUS",r[r.QP_SUM=2144]="QP_SUM",r[r.I_FRAME_DELAY=2149]="I_FRAME_DELAY"}(co||(co={})),function(r){r[r.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",r[r.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",r[r.FREEZE_TIME=2109]="FREEZE_TIME",r[r.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER"}(uv||(uv={})),function(r){r[r.PCM_LEVEL=2104]="PCM_LEVEL"}(K3||(K3={})),function(r){r[r.PACKAGE_LOST=-1]="PACKAGE_LOST",r[r.LEVEL=2038]="LEVEL",r[r.BITRATE=2039]="BITRATE",r[r.PACKAGE_RATE=2040]="PACKAGE_RATE",r[r.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",r[r.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",r[r.FREEZE=2081]="FREEZE",r[r.DISABLED=2096]="DISABLED"}(gm||(gm={})),function(r){r[r.BITRATE=2044]="BITRATE",r[r.PACKAGE_LOST=2045]="PACKAGE_LOST",r[r.PACKAGE_RATE=2046]="PACKAGE_RATE",r[r.CURRENT_DELAY=2047]="CURRENT_DELAY",r[r.JITTER_BUFFER=2054]="JITTER_BUFFER",r[r.JITTER=2055]="JITTER",r[r.FREEZE=2083]="FREEZE",r[r.DISABLED=2102]="DISABLED",r[r.PCM_LEVEL=2105]="PCM_LEVEL",r[r.PLAYER_STATUS=2130]="PLAYER_STATUS",r[r.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES"}(Gd||(Gd={})),function(r){r[r.FREEZE_TIME=-1]="FREEZE_TIME",r[r.LEVEL=2043]="LEVEL"}(Y3||(Y3={})),function(r){r[r.RTT=2006]="RTT",r[r.CONN_TYPE=801]="CONN_TYPE"}(od||(od={}));const Sm=1e3,TS=3;function gn(r,e,n){n!=null&&Number.isFinite(n)&&(r[e]=Math.round(Math.max(0,n)))}function a5(r){const e={[od.CONN_TYPE]:0,[od.RTT]:r.rtt};switch(r.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=r.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(e[od.CONN_TYPE]=1),n==="tcp"&&(e[od.CONN_TYPE]=3),n==="tls"&&(e[od.CONN_TYPE]=4);break}case"srflx":e[od.CONN_TYPE]=2}return e}class c5 extends Dt{constructor(e){super(),D(this,"store",void 0),D(this,"uploadWRTCStatsTimer",void 0),D(this,"uploadOutboundDenoiserStatsTimer",void 0),D(this,"uploadExtStatsTimer",void 0),D(this,"uploadExtUsageStatsTimer",void 0),D(this,"uploadInboundExtStatsTimer",void 0),D(this,"requestStats",void 0),D(this,"requestTransportStats",void 0),D(this,"requestLocalMedia",void 0),D(this,"requestRemoteMedia",void 0),D(this,"requestAllTracks",void 0),D(this,"requestVideoIsReady",void 0),D(this,"requestUploadStats",void 0),D(this,"requestUpload",void 0),D(this,"uploadOutboundStarted",!1),D(this,"uploadInboundStarted",!1),D(this,"uploadTransportStarted",!1),D(this,"uploadExtensionUsageStarted",!1),D(this,"lastRecvStats",void 0),D(this,"lastSendStats",void 0),D(this,"lastFullRecvStats",void 0),D(this,"lastFullSendStats",void 0),D(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let n,o;if(this.uploadTransportStarted&&(n=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!n&&this.uploadOutboundStarted&&(n=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),n||o){const c={};if(this.uploadTransportStarted&&n){const u=this.getTransportStats(n,o,e);u&&(c.misc=[u])}if(this.uploadOutboundStarted&&n){const u=this.getOutboundStats(n,e?this.lastSendStats:this.lastFullSendStats,e);u&&(c.outbound=[u])}if(this.uploadInboundStarted&&o){const u=this.getInboundStats(o,e?this.lastRecvStats:this.lastFullRecvStats,e);u&&(c.inbound=u)}this.requestUploadStats(c)}this.lastRecvStats=o,this.lastSendStats=n,e||(this.lastFullRecvStats=o,this.lastFullSendStats=n)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==TS),++e===TS+1&&(e=1)},Sm)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,n,o){if(!this.requestStats)return;if(o)return e.rtt==null?void 0:{addition:{[od.RTT]:e.rtt,[od.CONN_TYPE]:void 0}};const c=a5(e);if(this.store.useP2P){if(n){const u=a5(n);c[od.CONN_TYPE]+=u[od.CONN_TYPE]<<3}c[od.CONN_TYPE]+=110}else c[od.CONN_TYPE]+=100;return{addition:c}}getOutboundStats(e,n,o){if(!this.requestUploadStats||!this.requestLocalMedia)return;const c=this.requestLocalMedia();if(!c||c.length===0)return;let u,m,_;return c.forEach(S=>{let[C,{track:R,ssrcs:w}]=S;switch(C){case Je.LocalVideoLowTrack:case Je.LocalVideoTrack:if(C===Je.LocalVideoTrack){const N=function(j,W,ee,re,fe){const be=W.videoSend.find(et=>et.ssrc===j);if(!be)return;const _e={},{sentFrame:ye,inputFrame:Le}=be;if(Le&&ye){const et=Le.frameRate,at=ye.frameRate;_e[Ur.FREEZE]=function(Zt,Sn){let gi=!0;return gi=!(Zt<=5)&&(Zt<=10?Sn<3:Zt<=20?Sn<4:Sn<5),gi}(et,at)?1:0}if(gn(_e,Ur.QP_SUM,be.qpSumPerFrame),fe)return _e;switch(ye&&(gn(_e,Ur.HEIGHT,ye.height),gn(_e,Ur.WIDTH,ye.width),gn(_e,Ur.FRAME_RATE,ye.frameRate)),_e[Ur.DISABLED]=re._originMediaStreamTrack&&!re._originMediaStreamTrack.enabled||re._mediaStreamTrack&&!re._mediaStreamTrack.enabled?1:0,be.adaptionChangeReason){case"none":_e[Ur.ADAPTATION]=0;break;case"cpu":_e[Ur.ADAPTATION]=1;break;case"bandwidth":_e[Ur.ADAPTATION]=2;break;case"other":_e[Ur.ADAPTATION]=3}_e[Ur.PLAYER_STATUS]=go[re._player?re._player.videoElementStatus:"uninit"],gn(_e,Ur.NACKS,be.nacksCount),gn(_e,Ur.PLIS,be.plisCount),gn(_e,Ur.FIRS,be.firsCount),gn(_e,Ur.AVG_ENCODE,be.avgEncodeMs);const Me=ee&&ee.videoSend.find(et=>et.ssrc===j);if(Me){let et=fe?Sm:Sm*TS;Me.timestamp&&be.timestamp&&(et=be.timestamp-Me.timestamp),Me.packets!=null&&be.packets!=null&&gn(_e,Ur.PACKAGE_RATE,1e3*(be.packets-Me.packets)/et),be.packetsLost!=null&&Me.packetsLost!=null&&gn(_e,Ur.PACKAGE_LOST,be.packetsLost-Me.packetsLost),Me.bytes!=null&&be.bytes!=null&&gn(_e,Ur.BITRATE,8*(be.bytes-Me.bytes)/et)}return _e}(w[0].ssrcId,e,n,R,o),L=o?null:function(j,W,ee){const re=W.videoSend.find(Me=>Me.ssrc===j);if(!re)return null;const fe={},be=re.inputFrame,_e=be&&be.height||ee&&ee._videoHeight||0,ye=be&&be.width||ee&&ee._videoWidth||0,Le=be&&be.frameRate||0;return gn(fe,rd.HEIGHT,_e),gn(fe,rd.WIDTH,ye),gn(fe,rd.FRAME_RATE,Le),fe}(w[0].ssrcId,e,R),H=o?null:function(j){const W={};return gn(W,Ur.RETRANSMIT,j.bitrate.retransmit),gn(W,Ur.TARGET_ENCODED,j.bitrate.targetEncoded),gn(W,Ur.ACTUAL_ENCODED,j.bitrate.actualEncoded),gn(W,Ur.TRANSMIT,j.bitrate.transmit),gn(W,Ur.BANDWIDTH,j.sendBandwidth),W}(e);m=Object.assign({},N,L,H)}else _=o?void 0:function(N,L,H){const j=L.videoSend.find(re=>re.ssrc===N);if(!j)return;const W={},ee=j.sentFrame;if(ee&&(gn(W,zf.HEIGHT,ee.height),gn(W,zf.WIDTH,ee.width),gn(W,zf.FRAME_RATE,ee.frameRate)),H){const re=H.videoSend.find(fe=>fe.ssrc===N);if(re){let fe=Sm*TS;re.timestamp&&j.timestamp&&(fe=j.timestamp-re.timestamp),re.packets!=null&&j.packets!=null&&gn(W,zf.PACKAGE_RATE,1e3*(j.packets-re.packets)/fe),j.packetsLost!=null&&re.packetsLost!=null&&gn(W,zf.PACKAGE_LOST,j.packetsLost-re.packetsLost),re.bytes!=null&&j.bytes!=null&&gn(W,zf.BITRATE,8*(j.bytes-re.bytes)/fe)}}return W}(w[0].ssrcId,e,n);break;case Je.LocalAudioTrack:u=o?void 0:function(N,L,H,j){const W=L.audioSend.find(_e=>_e.ssrc===N);if(!W)return;const ee={};ee[gm.DISABLED]=j._originMediaStreamTrack&&!j._originMediaStreamTrack.enabled||j._mediaStreamTrack&&!j._mediaStreamTrack.enabled?1:0;const re=j._source.getAccurateVolumeLevel(),fe=W.inputLevel;gn(ee,gm.LEVEL,100*(fe??re)),gn(ee,K3.PCM_LEVEL,100*re),gn(ee,gm.AEC_RETURN_LOSS,W.aecReturnLoss),gn(ee,gm.AEC_RETURN_LOSS_ENH,W.aecReturnLossEnhancement),ee[gm.FREEZE]=0;const be=H&&H.audioSend.find(_e=>_e.ssrc===N);if(be){let _e=Sm*TS;be.timestamp&&W.timestamp&&(_e=W.timestamp-be.timestamp),be.bytes!=null&&W.bytes!=null&&gn(ee,gm.BITRATE,8*(W.bytes-be.bytes)/_e),be.packets!=null&&W.packets!=null&&gn(ee,gm.PACKAGE_RATE,1e3*(W.packets-be.packets)/_e)}return ee}(w[0].ssrcId,e,n,R)}}),{high:m,low:_,audio:u}}getInboundStats(e,n,o){if(!this.requestRemoteMedia)return;const c=this.requestRemoteMedia()||[],u=[];return c.forEach(m=>{let[_,S]=m;const C={peer:_.uid};if(S.has(gt.VIDEO)&&_.videoTrack){const R=_._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(_._videoSSRC)||!1,w=_.videoTrack?function(N,L,H,j,W,ee,re){const fe=L.videoRecv.find(et=>et.ssrc===N);if(!fe)return;const be={},{receivedFrame:_e,outputFrame:ye,decodeFrameRate:Le}=fe,Me=H&&H.videoRecv.find(et=>et.ssrc===N);if(be[co.FREEZE]=W&&m0.isRemoteVideoFreeze(j,fe,Me)?1:0,gn(be,uv.FRAME_RATE_DECODE,Le),gn(be,co.QP_SUM,fe.qpSumPerFrame),fe.framesRateFirefox&&gn(be,co.FRAME_RATE,fe.framesRateFirefox),_e&&gn(be,co.FRAME_RATE,_e.frameRate),Me){const et=L.timestamp-H.timestamp||(re?Sm:TS*Sm);fe.packetsLost!=null&&Me.packetsLost!=null&&gn(be,co.PACKAGE_LOST,fe.packetsLost-Me.packetsLost),Me.bytes!=null&&fe.bytes!=null&&gn(be,co.BITRATE,8*(fe.bytes-Me.bytes)/et),Me.packets!=null&&fe.packets!=null&&gn(be,co.PACKAGE_RATE,1e3*(fe.packets-Me.packets)/et)}if(re)return be;if(_e?(gn(be,co.HEIGHT,_e.height),gn(be,co.WIDTH,_e.width)):j&&(gn(be,co.HEIGHT,j._videoHeight||0),gn(be,co.WIDTH,j._videoWidth||0)),ye&&gn(be,uv.FRAME_RATE_RENDER,ye.frameRate),gn(be,co.JITTER_BUFFER,fe.jitterBufferMs),gn(be,co.CURRENT_DELAY,fe.currentDelayMs),gn(be,co.FIRS,fe.firsCount),gn(be,co.NACKS,fe.nacksCount),gn(be,co.PLIS,fe.plisCount),j){be[co.DISABLED]=j._originMediaStreamTrack.enabled&&j._mediaStreamTrack.enabled?0:1;const et=j._player;if(et){const{freezeTimeCounterList:at,renderFreezeAccTime:Zt}=et;if(at&&at.length>0&&gn(be,uv.FREEZE_TIME,at.splice(0,1)[0]),ee&&Qo.visibility==="visible"){const Sn=Math.min(6e3,Zt);et.renderFreezeAccTime=Math.max(0,Zt-Sn),gn(be,uv.FREEZE_TIME_RENDER,Sn)}}}if(be[co.PLAYER_STATUS]=go[j._player?j._player.videoElementStatus:"uninit"],Me&&fe.totalInterFrameDelay!==void 0&&fe.totalSquaredInterFrameDelay!==void 0&&Me.totalInterFrameDelay!==void 0&&Me.totalSquaredInterFrameDelay!==void 0){const et=fe.totalInterFrameDelay-Me.totalInterFrameDelay,at=fe.totalSquaredInterFrameDelay-Me.totalSquaredInterFrameDelay,Zt=fe.framesDecodeCount-Me.framesDecodeCount,Sn=et/Zt*1e3,gi=Math.round(1e3*Math.sqrt((at-Math.pow(et,2)/Zt)/Zt));!isNaN(gi)&&Sn+gi>Math.max(3*Sn,Sn+150)&&(be[co.I_FRAME_DELAY]=gi)}return be}(_._videoSSRC,e,n,_.videoTrack,R===!0,this.needUploadRenderFreezeTime,o):void 0;w&&(C.video=w)}if(S.has(gt.AUDIO)&&_.audioTrack){const R=_.audioTrack?function(w,N,L,H,j){const W=N.audioRecv.find(et=>et.ssrc===w);if(!W)return;const ee={},re=L&&L.audioRecv.find(et=>et.ssrc===w),{receivedFrames:fe,droppedFrames:be}=W;var _e,ye;if(gn(ee,Gd.JITTER,W.jitterMs),fe!=null&&be!=null&&(ee[Gd.FREEZE]=(ye=be,(_e=fe)===0||100*ye/_e>20?1:0)),re){const et=N.timestamp-L.timestamp||(j?Sm:Sm*TS);W.packets!=null&&re.packets!=null&&gn(ee,Gd.PACKAGE_RATE,1e3*(W.packets-re.packets)/et),re.bytes!=null&&W.bytes!=null&&gn(ee,Gd.BITRATE,8*(W.bytes-re.bytes)/et),W.packetsLost!=null&&re.packetsLost!=null&&gn(ee,Gd.PACKAGE_LOST,W.packetsLost-re.packetsLost)}if(j)return ee;const Le=H._source.getAccurateVolumeLevel(),Me=W.outputLevel;if(gn(ee,Y3.LEVEL,100*(Me??Le)),gn(ee,Gd.PCM_LEVEL,100*Le),H&&(ee[Gd.DISABLED]=H._originMediaStreamTrack.enabled&&H._mediaStreamTrack.enabled?0:1),gn(ee,Gd.JITTER_BUFFER,W.jitterBufferMs),gn(ee,Gd.CURRENT_DELAY,W.jitterBufferMs),ee[Gd.PLAYER_STATUS]=go[So.getPlayerState(H.getTrackId())],re){const et=W.concealedSamples-re.concealedSamples;et>0&&gn(ee,Gd.CONCEALED_SAMPLES,et)}return ee}(_._audioSSRC,e,n,_.audioTrack,o):void 0;R&&(C.audio=R)}(C.video||C.audio)&&u.push(C)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,u}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find(n=>n instanceof hu);if(e&&e._external.getDenoiserStats){const n=e._external.getDenoiserStats();n&&this.requestUpload(fr.DENOISER_STATS,n)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[n,o]=e;o.has(gt.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(c=>{this.requestUpload&&this.requestUpload(c.type,c.stats)}),o.has(gt.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(c=>{this.requestUpload&&this.requestUpload(c.type,c.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const n=Date.now(),o={connectionInterval:oe("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let c=[];const u=this.requestAllTracks&&this.requestAllTracks()||[];for(const C of u)!C.muted&&C.enabled&&(c=c.concat(await C.getProcessorUsage()));const m=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[C,R]of m)R.has(gt.VIDEO)&&C.videoTrack&&(c=c.concat(await C.videoTrack.getProcessorUsage())),R.has(gt.AUDIO)&&C.audioTrack&&(c=c.concat(await C.audioTrack.getProcessorUsage()));if(c.length===0)return;o.details=function(C,R){const w={};for(const{id:j,value:W,level:ee,direction:re}of C){var N;const fe=(N=R.get(j))!==null&&N!==void 0?N:0,be=W===2?fe+oe("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:fe;var L,H;R.set(j,be),w[j]?(W===2&&(w[j].value=W),ee>w[j].level&&(w[j].level=ee),re==="remote"&&(w[j].remoteUidCount+=1),w[j].totalTs=(L=R.get(j))!==null&&L!==void 0?L:0):w[j]={value:W,level:ee,remoteUidCount:re==="local"?0:1,totalTs:(H=R.get(j))!==null&&H!==void 0?H:0}}return Object.keys(w).map(j=>{const{level:W,value:ee,totalTs:re}=w[j];return{id:j,level:W,value:ee,totalTs:re}})}(c,e);const _=Date.now(),S=_>n?_:n+1;this.requestUpload&&this.requestUpload(fr.EXTENSION_USAGE_STATS,{usageStats:o,sendTs:S})},oe("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class xs{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,n){D(this,"uid",void 0),D(this,"_uintid",void 0),D(this,"_trust_in_room_",!0),D(this,"_trust_audio_enabled_state_",!0),D(this,"_trust_video_enabled_state_",!0),D(this,"_trust_audio_mute_state_",!0),D(this,"_trust_video_mute_state_",!0),D(this,"_audio_muted_",!1),D(this,"_video_muted_",!1),D(this,"_audio_enabled_",!0),D(this,"_video_enabled_",!0),D(this,"_audio_added_",!1),D(this,"_video_added_",!1),D(this,"_is_pre_created",!1),D(this,"_video_pre_subscribed",!1),D(this,"_audio_pre_subscribed",!1),D(this,"_trust_video_stream_added_state_",!0),D(this,"_trust_audio_stream_added_state_",!0),D(this,"_audioTrack",void 0),D(this,"_videoTrack",void 0),D(this,"_dataChannels",[]),D(this,"_audioSSRC",void 0),D(this,"_videoSSRC",void 0),D(this,"_audioOrtc",void 0),D(this,"_videoOrtc",void 0),D(this,"_cname",void 0),D(this,"_rtxSsrcId",void 0),D(this,"_videoMid",void 0),D(this,"_audioMid",void 0),this.uid=e,this._uintid=n}}var Wd;function XY(r,e){var n;let o;switch(e){case Je.LocalAudioTrack:o=Nn.Audio;break;case Je.LocalVideoTrack:o=xe(n=r._hints).call(n,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalVideoLowTrack:o=Nn.Low}return o}function z3(r){const e=Dn();if(r.some(n=>n._bypassWebAudio))throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function q3(r,e){z3(r);const n=new Yi;return r.forEach(o=>n.addAudioTrack(o)),n}function d5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Qk(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?d5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):d5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}(function(r){r.SEND_ONLY="SEND_ONLY",r.RECEIVE_ONLY="RECEIVE_ONLY"})(Wd||(Wd={}));class ns extends Dt{get state(){return this._state}set state(e){const n=this._state;this._state=e,this.emit(We.StateChange,n,this._state)}constructor(e,n){super(),D(this,"store",void 0),D(this,"statsUploader",void 0),D(this,"sendConnection",void 0),D(this,"recvConnection",void 0),D(this,"localTrackMap",new Map),D(this,"remoteUserMap",new Map),D(this,"localDataChannels",[]),D(this,"pendingLocalTracks",[]),D(this,"pendingRemoteTracks",[]),D(this,"statsCollector",void 0),D(this,"dtlsFailedCount",0),D(this,"sendMutex",new Zr("P2PChannel2-send-mutex")),D(this,"recvMutex",new Zr("P2PChannel2-recv-mutex")),D(this,"_state",kn.Disconnected),D(this,"_restartStates",["disconnected","failed"]),D(this,"reconnectInterval",void 0),D(this,"uploadUnplinkStarted",!1),D(this,"uploadDownlinkStarted",!1),D(this,"uplinkStateUploadInterval",void 0),D(this,"downlinkStatsUploadInterval",void 0),D(this,"handleMuteLocalTrack",async(o,c,u)=>{const m=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==kn.Connected)return void u(new ke(Q.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const C=this.filterTobeMutedTracks(o);if(C.length===0)return void c();const R=C.find(H=>H[0]==="videoLowTrack");R&&R[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(C.map(H=>{let[,{id:j}]=H;return j}));let w=!1;var _,S;o.trackMediaType==="video"?w=!((_=this.localTrackMap.get(Je.LocalAudioTrack))===null||_===void 0||!_.track._muted):w=((S=this.localTrackMap.get(Je.LocalVideoTrack))===null||S===void 0?void 0:S.id)===void 0;const N=this.createMuteMessage(C);await Mn(this,We.RequestMuteLocal,N);const L=o.trackMediaType==="video"?es.MUTE_LOCAL_VIDEO:es.MUTE_LOCAL_AUDIO;await Mn(this,We.RequestP2PMuteLocal,{action:L,message:N,isMuteAll:w}),c()}catch(C){u(C)}finally{m()}}),D(this,"handleUnmuteLocalTrack",async(o,c,u)=>{const m=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==kn.Connected)return void u(new ke(Q.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const _=this.filterTobeUnmutedTracks(o);if(_.length===0)return void c();await this.sendConnection.unmuteLocal(_.map(R=>{let[,{id:w}]=R;return w}));const S=this.createUnmuteMessage(_),C=o.trackMediaType==="video"?es.UNMUTE_LOCAL_VIDEO:es.UNMUTE_LOCAL_AUDIO;await Mn(this,We.RequestP2PMuteLocal,{action:C,message:S}),c()}catch(_){u(_)}finally{m()}}),D(this,"handleUpdateVideoEncoder",async(o,c,u)=>{const m=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const _=this.localTrackMap.get(Je.LocalVideoTrack);if(!this.sendConnection||!_||_.track!==o||this.state!==kn.Connected)return void c();const{id:S,track:C}=_;S&&(await this.sendConnection.updateSendParameters(S,C),await this.sendConnection.updateEncoderConfig(S,C),this.emit(We.UpdateVideoEncoder,C)),c()}catch(_){u(_)}finally{m()}}),D(this,"handleSetOptimizationMode",async(o,c,u)=>{const m=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const _=this.localTrackMap.get(Je.LocalVideoTrack);if(!this.sendConnection||!_||_.track!==o||this.state!==kn.Connected)return;const{id:S,track:C}=_;S&&await this.sendConnection.updateSendParameters(S,C),c()}catch(_){u(_)}finally{m()}}),D(this,"handleReplaceTrack",async(o,c,u,m)=>{let _;M.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(o.getTrackId(),"]")),typeof m=="boolean"&&m||(_=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var S;const R=Array.from(this.localTrackMap.entries()).find(w=>{let[,{track:N}]=w;return o===N});if(!this.sendConnection||!R||R[1].id===void 0||this.state!==kn.Connected)return void c();if(await((S=this.sendConnection)===null||S===void 0?void 0:S.replaceTrack(o,R[1].id)),R[0]===Je.LocalVideoTrack&&Dn().supportDualStreamEncoding){const w=this.localTrackMap.get(Je.LocalVideoLowTrack);if(w){const N=o._mediaStreamTrack.clone();w.track._originMediaStreamTrack.stop(),w.track._mediaStreamTrack=N,w.track._originMediaStreamTrack=N,await new Ee((L,H)=>{this.handleReplaceTrack(w.track,L,H,!0)})}}c()}catch(R){u(R)}finally{var C;(C=_)===null||C===void 0||C()}}),D(this,"handleGetLocalVideoStats",o=>{o(this.statsCollector.getLocalVideoTrackStats())}),D(this,"handleGetLocalAudioStats",o=>{o(this.statsCollector.getLocalAudioTrackStats())}),D(this,"handleGetRemoteVideoStats",o=>this.statsCollector.getRemoteVideoTrackStats(o.uid)[o.uid]),D(this,"handleGetRemoteAudioStats",o=>this.statsCollector.getRemoteAudioTrackStats(o.uid)[o.uid]),this.store=e,this.statsCollector=n,this.statsCollector.addP2PChannel(this),this.statsUploader=new c5(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(o=>{o&&(o.iceConnectionState!=="disconnected"&&o.iceConnectionState!=="failed"||this.handleDisconnect(o.direction))})},oe("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,n){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,n,o,c,u,m){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,n){let o;try{if(n){this.recvConnection&&(M.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),o=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new $n(e,this.store,st.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const c=await this.recvConnection.establish(n);return{iceParameters:c.iceParameters,dtlsParameters:c.dtlsParameters,sdp:c.sdp}}{this.state=kn.New,this.sendConnection&&(M.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),o=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new $n(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const c=await this.sendConnection.establish();return{iceParameters:c.iceParameters,dtlsParameters:c.dtlsParameters,sdp:c.sdp}}}finally{o&&o()}}async p2pConnect(e){if(!this.sendConnection)throw new ke(Q.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kn.Connected}async addRemoteCandidate(e,n){if(n===st.RECEIVE_ONLY){if(!this.sendConnection)throw new ke(Q.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new ke(Q.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,n,o){var c=this;return Fo(function*(){const u=yield Qt(c.sendMutex.lock("From P2PChannel.publish"));try{if(!c.sendConnection||c.state!==kn.Connected){c.throwIfTrackTypeNotMatch(e);const R=e.filter(w=>c.pendingLocalTracks.indexOf(w)===-1);return void(c.pendingLocalTracks=c.pendingLocalTracks.concat(R))}c.store.pubId=c.store.pubId+1,Us.markPublishStart(c.store.clientId,c.store.pubId);const m=c.filterTobePublishedTracks(e,n,o);if(m.length===0)return void(yield Qt(c.tryToUnmuteAudio(e)));m.forEach(R=>{let{track:w,type:N}=R;const L=Date.now();c.store.publish(w.getTrackId(),N===Je.LocalAudioTrack?"audio":"video",L)}),c.bindLocalTrackEvents(m);const _=yield Qt(c.sendConnection.send(m.map(R=>{let{track:w}=R;return w}),c.store.codec,c.store.audioCodec)),S=(yield Qt(_.next())).value,C=c.createGatewayPublishMessage(m,S);try{yield C}catch(R){throw _.throw(R),(R==null?void 0:R.code)===Q.WS_ABORT&&m.forEach(w=>{let{track:N}=w;c.pendingLocalTracks.indexOf(N)===-1&&c.pendingLocalTracks.push(N)}),c.unbindLocalTrackEvents(m),R}yield Qt(_.next()),m.forEach(R=>{let{type:w}=R;c.statsCollector.addLocalStats(w)}),c.statsUploader.startUploadOutboundStats(),c.assignLocalTracks(m,S),m.forEach(R=>{let{track:w,type:N}=R;const L=Date.now();c.store.publish(w.getTrackId(),N===Je.LocalAudioTrack?"audio":"video",void 0,L)}),c.startUploadUplinkState()}finally{u()}})()}async unpublish(e){if(!this.sendConnection||this.state!==kn.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(u=>!xe(e).call(e,u)));const n=this.filterTobeUnpublishedTracks(e);if(n.length===0)return;const o=n.find(u=>u[0]==="videoLowTrack");o&&o[1].track.close();const c=this.createGatewayUnpublishMessage(n);if(await this.sendConnection.stopSending(n.map(u=>{let[,{id:m}]=u;return m})),this.withdrawLocalTracks(n),this.unbindLocalTrackEvents(n.map(u=>{let[m,{track:_}]=u;return{type:m,track:_}})),n.forEach(u=>{let[m]=u;this.statsCollector.removeLocalStats(m)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===kn.Connected)return o&&o[1].track.close(),c;e.forEach(u=>{const m=this.pendingLocalTracks.indexOf(u);m!==-1&&this.pendingLocalTracks.splice(m,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const n=[],o=[];Array.from(this.localTrackMap.entries()).forEach(c=>{let[u,{track:m,ssrcs:_}]=c;const S={stream_type:XY(m,u),ssrcs:_};m._muted||!m._enabled?n.push(S):o.push(S)}),n.length>0&&n.forEach(c=>{Mn(this,We.RequestMuteLocal,[c])}),o.length>0&&o.forEach(c=>{Mn(this,We.RequestUnmuteLocal,[c])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return Fo(function*(){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(M.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Ji(this,We.RequestRePublish,this.pendingLocalTracks),this.emit(We.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,n,o,c){var u;if(!this.recvConnection)throw new ke(Q.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((u=this.remoteUserMap.get(e))!==null&&u!==void 0&&u.has(n))return;const{track:m,mid:_,transceiver:S}=await this.recvConnection.receive(n,[{ssrcId:o}],String(e.uid),c);n===gt.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(m):(e._audioTrack=new jt(m,e.uid,e._uintid,this.store),M.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),S&&e._audioTrack._updateRtpTransceiver(S),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=o,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(m):(e._videoTrack=new ps(m,e.uid,e._uintid,this.store),M.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),S&&e._videoTrack._updateRtpTransceiver(S),this.bindRemoteTrackEvents(e,e._videoTrack));const C=this.remoteUserMap.get(e);C?C.set(n,_):this.remoteUserMap.set(e,new Map([[n,_]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const R=this.pendingRemoteTracks.findIndex(w=>{let{user:N,kind:L}=w;return N.uid===e.uid&&n===L});R!==-1&&(this.pendingRemoteTracks.splice(R,1),this.emit(We.MediaReconnectEnd,e.uid))}async mockSubscribe(e,n,o,c){if(!this.recvConnection)throw new ke(Q.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(n,[{ssrcId:o}],String(e.uid),c)}async unsubscribe(e,n,o){const c=this.pendingRemoteTracks.filter(m=>{let{user:_,kind:S}=m;return n!==void 0?_.uid===e.uid&&n===S:_.uid===e.uid});if(c.forEach(m=>{const _=this.pendingRemoteTracks.indexOf(m);this.pendingRemoteTracks.splice(_,1)}),this.recvConnection||o||c.forEach(m=>{let{kind:_}=m;var S;if(_===gt.AUDIO)(S=e._audioTrack)===null||S===void 0||S._destroy(),e._audioTrack=void 0;else if(_===gt.VIDEO){var C;(C=e._videoTrack)===null||C===void 0||C._destroy(),e._videoTrack=void 0}}),!this.recvConnection)return;const u=this.filterTobeUnSubscribedTracks(e,n);u.length!==0&&(await this.recvConnection.stopReceiving(u.map(m=>{let[,{id:_}]=m;return _})),this.withdrawRemoteTracks(u),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),u.forEach(m=>{let[_,{kind:S}]=m;var C,R;if(S===gt.VIDEO&&_._videoSSRC&&((C=this.recvConnection)===null||C===void 0||C.setStatsRemoteVideoIsReady(_._videoSSRC,!1)),S===gt.VIDEO)this.unbindRemoteTrackEvents(_._videoTrack),o||((R=_._videoTrack)===null||R===void 0||R._destroy(),_._videoTrack=void 0);else if(S===gt.AUDIO){var w;this.unbindRemoteTrackEvents(_._audioTrack),!o&&((w=_._audioTrack)===null||w===void 0||w._destroy(),_._audioTrack=void 0)}}),u.forEach(m=>{let[,{kind:_}]=m;Mn(this,We.RequestP2PMuteRemote,_)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach(n=>{let[,o]=n;[gt.VIDEO,gt.AUDIO].forEach(c=>{o.has(c)?Mn(this,We.RequestP2PUnmuteRemote,c):Mn(this,We.RequestP2PMuteRemote,c)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new ke(Q.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,n){if(!this.recvConnection)return;const o=this.remoteUserMap.get(e);if(!o)return void M.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!o.get(n))return void M.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(n,"."));const c=n===gt.VIDEO?e._videoSSRC:e._audioSSRC;c!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(c,!1)}async unmuteRemote(e,n){return this.unmuteRemoteNoLock(e,n)}async unmuteRemoteNoLock(e,n){if(!this.recvConnection)return;const o=this.remoteUserMap.get(e);if(!o)return void M.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));o.get(n)||M.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(n,"."))}getAllTracks(e){const n=this.localTrackMap.get(Je.LocalAudioTrack);if((n==null?void 0:n.track)instanceof Yi){const o=n.track;return Array.from(this.localTrackMap.entries()).filter(c=>{let[u]=c;return u!==Je.LocalAudioTrack}).filter(c=>{let[u]=c;return!(e&&u===Je.LocalVideoLowTrack)}).map(c=>{let[,{track:u}]=c;return u}).concat(o.trackList)}return Array.from(this.localTrackMap.entries()).filter(o=>{let[c]=o;return!(e&&c===Je.LocalVideoLowTrack)}).map(o=>{let[,{track:c}]=o;return c})}reportPublishEvent(e,n,o,c,u){if(e){const _=this.localTrackMap.get(Je.LocalAudioTrack),S=c?this.localTrackMap.get(Je.LocalVideoLowTrack):this.localTrackMap.get(Je.LocalVideoTrack);vt.publish(this.store.sessionId,{eventElapse:Us.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:n,audioName:_==null?void 0:_.track.getTrackLabel(),videoName:S==null?void 0:S.track.getTrackLabel(),screenshare:(S==null?void 0:S.track._hints.indexOf(hi.SCREEN_TRACK))!==-1,audio:!!_,video:!!S,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}else{var m;o||(o=[]);const _=o.find(C=>C instanceof xn),S=c?(m=this.localTrackMap.get(Je.LocalVideoTrack))===null||m===void 0?void 0:m.track:o.find(C=>C instanceof on);vt.publish(this.store.sessionId,{eventElapse:Us.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:n,audioName:_==null?void 0:_.getTrackLabel(),videoName:S==null?void 0:S.getTrackLabel(),screenshare:(S==null?void 0:S._hints.indexOf(hi.SCREEN_TRACK))!==-1,audio:!!_,video:!!S,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}}reportSubscribeEvent(e,n,o,c){const u=c===gt.VIDEO?o._videoSSRC:o._audioSSRC;u&&vt.subscribe(this.store.sessionId,{succ:e,ec:n,video:c===gt.VIDEO,audio:c===gt.AUDIO,peerid:o.uid,subscribeRequestid:c===gt.VIDEO?o._videoSSRC:o._audioSSRC,p2pid:this.store.p2pId,eventElapse:Us.measureFromSubscribeStart(this.store.clientId,u)})}reset(){M.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Zr("P2PChannel2-send-mutex"),this.sendMutex=new Zr("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(Je.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Yi){if(e.track.trackList.length>0){const n=e.track;e.track.trackList.forEach(o=>{n.removeAudioTrack(o)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=kn.Disconnected}getStats(e){var n,o;return e?(o=this.recvConnection)===null||o===void 0?void 0:o.getStats():(n=this.sendConnection)===null||n===void 0?void 0:n.getStats()}getRemoteVideoIsReady(e){var n;return((n=this.recvConnection)===null||n===void 0?void 0:n.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Je.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Je.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const n=this.localTrackMap.get(e);return n&&n.track instanceof on||n&&n.track instanceof xn?n.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,n){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!n||o.has(n))}async hasRemoteMediaWithLock(e,n){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!n||o.has(n))}getRemoteMedia(e){var n;const o=Array.from(ka(n=this.remoteUserMap).call(n)).find(c=>c.uid===e);return o?{audioTrack:o.audioTrack,audioSSRC:o._audioSSRC,videoTrack:o.videoTrack,videoSSRC:o._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(o=>{let[c]=o;return{uid:c.uid,level:c.audioTrack?100*c.audioTrack._source.getAccurateVolumeLevel():0}});const n=this.localTrackMap.get(Je.LocalAudioTrack);return n&&e.push({level:100*n.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=LE(e).call(e,(o,c)=>o.level-c.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(M.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=kn.Reconnecting,oe("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[n]=e;var o;n._videoTrack&&n._videoTrack._player&&((o=n._videoTrack._player.getVideoElement())===null||o===void 0||o.pause(),n._videoTrack._player.isKeepLastFrame=!0,n._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var n;let[o,{track:c}]=e;switch(o){case Je.LocalVideoTrack:xe(n=c._hints).call(n,hi.LOW_STREAM)?c.close():this.pendingLocalTracks.push(c);break;case Je.LocalAudioTrack:c instanceof Yi?this.pendingLocalTracks=this.pendingLocalTracks.concat(c.trackList):this.pendingLocalTracks.push(c);case Je.LocalVideoLowTrack:}}),this.emit(We.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[n,o]=e;Array.from(ka(o).call(o)).forEach(c=>{this.setPendingRemoteMedia(n,c)}),this.emit(We.MediaReconnectStart,n.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),M.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,n){for(const o of this.pendingRemoteTracks){const{user:c,kind:u}=o;if((e instanceof xs?e.uid:e)===c.uid&&n===u)return!0}return!1}setPendingRemoteMedia(e,n){this.hasPendingRemoteMedia(e,n)||this.pendingRemoteTracks.push({user:e,kind:n})}async restartICE(e,n){let o,c;if(e===st.SEND_ONLY){if(!this.sendConnection)throw new ke(Q.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");o=await this.sendMutex.lock("From P2PChannel.restartICE"),c=this.sendConnection}else{if(!this.recvConnection)throw new ke(Q.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");o=await this.recvMutex.lock("From P2PChannel.restartICE"),c=this.recvConnection}try{if(n){const u=await c.restartICE(n);return c.isInRestartIce=!1,u}{const u=await c.restartICE();if(u){const m=await Ji(this,We.RequestP2PRestartICE,{direction:st.RECEIVE_ONLY,iceParameter:u});await c.restartICE(m),c.isInRestartIce=!1}}}finally{o()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),n=this.localTrackMap.get(Je.LocalVideoTrack),o=this.localTrackMap.get(Je.LocalAudioTrack),c=e.videoSend.find(H=>{var j;return H.ssrc===(n==null||(j=n.ssrcs)===null||j===void 0?void 0:j[0].ssrcId)}),u=e.audioSend.find(H=>{var j;return H.ssrc===(o==null||(j=o.ssrcs)===null||j===void 0?void 0:j[0].ssrcId)});if(!c||!u)return 1;const m=mo(this,We.NeedSignalRTT),_=c?c.rttMs:void 0,S=u?u.rttMs:void 0,C=_&&S?(_+S)/2:_||S,R=(C&&m?(C+m)/2:C||m)||0,w=100*e.sendPacketLossRate*.7/50+.3*R/1500,N=w<.17?1:w<.36?2:w<.59?3:w<.1?4:5,L=n==null?void 0:n.track;if(L&&L._encoderConfig&&L._hints.indexOf(hi.SCREEN_TRACK)===-1){const H=L._encoderConfig.bitrateMax,j=e.bitrate.actualEncoded;if(H&&j){const W=(1e3*H-j)/(1e3*H);return df[W<.15?0:W<.3?1:W<.45?2:W<.6?3:4][N]}}return N}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let n=0;return Array.from(this.remoteUserMap.entries()).forEach(o=>{let[c]=o;const u=c._audioSSRC,m=c._videoSSRC,_=e.audioRecv.find(j=>j.ssrc===u),S=e.videoRecv.find(j=>j.ssrc===m);if(!_&&!S)return void(n+=1);const C=mo(this,We.NeedSignalRTT),R=e.rtt,w=(R&&C?(R+C)/2:R||C)||0,N=_?_.jitterMs:void 0,L=e.recvPacketLossRate;let H=.7*L*100/50+.3*w/1500;N&&(H=.6*L*100/50+.2*w/1500+.2*N/400),n+=H<.1?1:H<.17?2:H<.36?3:H<.59?4:5}),this.remoteUserMap.size>0?Math.round(n/this.remoteUserMap.size):n}async muteLocalTrack(e){return new Ee((n,o)=>{this.handleMuteLocalTrack(e,n,o)})}filterTobePublishedTracks(e,n,o){const c=[],u=Dn(),m=this.getAllTracks();e=tf(e=e.filter(C=>m.indexOf(C)===-1));let _=!1,S=!1;for(const C of e){if(C instanceof on&&(this.localTrackMap.has(Je.LocalVideoTrack)||_?new ke(Q.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(c.push({track:C,type:Je.LocalVideoTrack}),_=!0),n)){const R=this.getLowVideoTrack(C,o);c.push({track:R,type:Je.LocalVideoLowTrack})}if(C instanceof xn){const R=this.localTrackMap.get(Je.LocalAudioTrack);if(R){if(!(R.track instanceof Yi))throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(C._bypassWebAudio)throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");R.track.addAudioTrack(C),this.bindLocalAudioTrackEvents(C,!0)}else if(S){const w=c.find(N=>{let{type:L}=N;return L===Je.LocalAudioTrack});if(!(w.track instanceof Yi))throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(C._bypassWebAudio)throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");w.track.addAudioTrack(C)}else{if(!u.webAudioMediaStreamDest||C instanceof Yi||C._bypassWebAudio)c.push({track:C,type:Je.LocalAudioTrack});else{const w=new Yi;w.addAudioTrack(C),c.push({track:w,type:Je.LocalAudioTrack})}S=!0}}}return c}filterTobeUnpublishedTracks(e){const n=[],o=this.getAllTracks();e=tf(e=e.filter(c=>o.indexOf(c)!==-1));for(const c of e){if(c instanceof xn){const u=this.localTrackMap.get(Je.LocalAudioTrack);if(!u)continue;u.track instanceof Yi?(u.track.removeAudioTrack(c),this.unbindLocalAudioTrackEvents(c),u.track.trackList.length===0&&(n.push([Je.LocalAudioTrack,u]),u.track.close())):n.push([Je.LocalAudioTrack,u])}if(c instanceof on){const u=this.localTrackMap.get(Je.LocalVideoTrack);if(!u)continue;n.push([Je.LocalVideoTrack,u]);const m=this.localTrackMap.get(Je.LocalVideoLowTrack);m&&n.push([Je.LocalVideoLowTrack,m])}}return n}bindLocalTrackEvents(e){e.forEach(n=>{let{track:o,type:c}=n;switch(c){case Je.LocalVideoTrack:o.addListener(ht.GET_STATS,this.handleGetLocalVideoStats),o.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.addListener(ht.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Je.LocalAudioTrack:this.bindLocalAudioTrackEvents(o);case Je.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,n){e instanceof Yi?e.trackList.forEach(o=>{o.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),o.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),n||e.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(n=>{let[o,{track:c}]=n;return{track:c,type:o}})),e.forEach(n=>{let{track:o,type:c}=n;switch(c){case Je.LocalVideoTrack:o.off(ht.GET_STATS,this.handleGetLocalVideoStats),o.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.off(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.off(ht.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Je.LocalAudioTrack:this.unbindLocalAudioTrackEvents(o);case Je.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof Yi?e.trackList.forEach(n=>{n.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(ht.GET_STATS,this.handleGetLocalAudioStats),n.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(ht.GET_STATS,this.handleGetLocalAudioStats),e.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,n){n instanceof ps&&n.addListener(ht.GET_STATS,o=>{o(this.handleGetRemoteVideoStats(e))}),n instanceof jt&&n.addListener(ht.GET_STATS,o=>{o(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ht.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[n,o]=e;o.has(gt.AUDIO)&&this.unbindRemoteTrackEvents(n._audioTrack),o.has(gt.VIDEO)&&this.unbindRemoteTrackEvents(n._videoTrack)})}createGatewayPublishMessage(e,n){return e.map((o,c)=>{var u;let m,{track:_,type:S}=o;switch(S){case Je.LocalAudioTrack:m=Nn.Audio;break;case Je.LocalVideoTrack:m=xe(u=_._hints).call(u,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalVideoLowTrack:m=Nn.Low}return{kind:S===Je.LocalAudioTrack?gt.AUDIO:gt.VIDEO,stream_type:m,mid:n[c].id,ssrcs:n[c].localSSRC,isMuted:_.muted||!_.enabled}})}createGatewayUnpublishMessage(e){return e.map(n=>{var o;let c,[u,{track:m,ssrcs:_,id:S}]=n;switch(u){case Je.LocalVideoTrack:c=xe(o=m._hints).call(o,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalAudioTrack:c=Nn.Audio;break;case Je.LocalVideoLowTrack:c=Nn.Low}return{stream_type:c,ssrcs:_,mid:S}})}assignLocalTracks(e,n){e.forEach((o,c)=>{let{track:u,type:m}=o;this.localTrackMap.set(m,{track:u,id:n[c].id,ssrcs:n[c].localSSRC})})}withdrawLocalTracks(e){e.forEach(n=>{let[o]=n;this.localTrackMap.delete(o)})}bindConnectionEvents(e){e.onConnectionStateChange=async n=>{var o;M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(n,")")),this.emit(We.PeerConnectionStateChange,n),n!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),n==="connected"&&(e.isInRestartIce=!1),xe(o=this._restartStates).call(o,n)&&!e.isInRestartIce&&(n==="disconnected"&&await Br(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=n=>{n!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(n,")")),vt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:n,tag:wi.TRACER}).onSuccess(),this.emit(We.IceConnectionStateChange,n)},e.onICETransportStateChange=n=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(n,")"))},e.onDTLSTransportStateChange=n=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(n,")"))},e.onDTLSTransportError=n=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(n,")"))},e.onFirstAudioDecoded=n=>{var o;const c=Array.from(ka(o=this.remoteUserMap).call(o)).find(m=>m._audioSSRC===n);var u;c&&(this.store.subscribe(c.uid,"audio",void 0,void 0,void 0,Date.now()),(u=c.audioTrack)===null||u===void 0||u.emit(pa.FIRST_FRAME_DECODED),vt.firstRemoteFrame(this.store.sessionId,x.FIRST_AUDIO_DECODE,pi.FIRST_AUDIO_DECODE,{peer:c._uintid,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=n=>{var o;const c=Array.from(ka(o=this.remoteUserMap).call(o)).find(u=>u._audioSSRC===n);c&&vt.firstRemoteFrame(this.store.sessionId,x.FIRST_AUDIO_RECEIVED,pi.FIRST_AUDIO_RECEIVED,{peer:c._uintid,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(n,o,c)=>{this.reportVideoFirstFrameDecoded(n,o,c)},e.onFirstVideoReceived=n=>{var o;const c=Array.from(ka(o=this.remoteUserMap).call(o)).find(u=>u._videoSSRC===n);c&&vt.firstRemoteFrame(this.store.sessionId,x.FIRST_VIDEO_RECEIVED,pi.FIRST_VIDEO_RECEIVED,{peer:c._uintid,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(n,o)=>{const c=n.candidateType==="relay",u=o.candidateType==="relay";o.candidateType!=="unknown"&&c===u||this.emit(We.ConnectionTypeChange,c),M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(du(o))," -> ").concat(JSON.stringify(du(n)),")"))},e.onSelectedRemoteCandidateChanged=(n,o)=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(du(o))," -> ").concat(JSON.stringify(du(n)),")"))},e.onFirstVideoDecodedTimeout=n=>{this.reportVideoFirstFrameDecoded(n,void 0,void 0,!0)},e.onLocalCandidate=n=>{this.emit(We.LocalCandidate,{candidate:n,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const n=e===st.SEND_ONLY?this.sendConnection:this.recvConnection;n&&!n.isInRestartIce&&(n.isInRestartIce=!0,M.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(n.name,"] start use restartICE")),e===st.SEND_ONLY?this.restartICE(e):Ji(this,We.RequestP2PRestartICE,{direction:st.SEND_ONLY}))}filterTobeMutedTracks(e){const n=[];if(this.getAllTracks().indexOf(e)===-1)return n;const o=this.localTrackMap.get(Je.LocalAudioTrack);if(e instanceof xn&&(o==null?void 0:o.track)instanceof Yi)return o.track.isActive||n.push([Je.LocalAudioTrack,o]),n;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:m}]=u;return e===m});if(c&&(n.push(c),c[0]===Je.LocalVideoTrack)){const u=this.localTrackMap.get(Je.LocalVideoLowTrack);u&&n.push([Je.LocalVideoLowTrack,u])}return n}filterTobeUnmutedTracks(e){const n=[],o=this.localTrackMap.get(Je.LocalAudioTrack);if(e instanceof xn&&(o==null?void 0:o.track)instanceof Yi)return o.track.isActive&&n.push([Je.LocalAudioTrack,o]),n;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:m}]=u;return e===m});if(c)if(c[0]===Je.LocalVideoTrack){n.push(c);const u=this.localTrackMap.get(Je.LocalVideoLowTrack);u&&n.push([Je.LocalVideoLowTrack,u])}else n.push(c);return n}createMuteMessage(e){return e.map(n=>{var o;let c,[u,{track:m,ssrcs:_,id:S}]=n;switch(u){case Je.LocalAudioTrack:c=Nn.Audio;break;case Je.LocalVideoTrack:c=xe(o=m._hints).call(o,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalVideoLowTrack:c=Nn.Low}return{stream_type:c,ssrcs:_,mid:S}})}createUnmuteMessage(e){return e.map(n=>{var o;let c,[u,{track:m,ssrcs:_,id:S}]=n;switch(u){case Je.LocalAudioTrack:c=Nn.Audio;break;case Je.LocalVideoTrack:c=xe(o=m._hints).call(o,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalVideoLowTrack:c=Nn.Low}return{stream_type:c,ssrcs:_,mid:S}})}filterTobeUnSubscribedTracks(e,n){const o=[],c=this.remoteUserMap.get(e);if(!c)return o;if(n){const u=c.get(n);if(!u)return o;o.push([e,{kind:n,id:u}])}else Array.from(c.entries()).forEach(u=>{let[m,_]=u;o.push([e,{kind:m,id:_}])});return o}createUnsubscribeMessage(e){const n=[];return e.forEach(o=>{let[c,{kind:u,id:m}]=o;switch(u){case gt.VIDEO:return void(c._videoSSRC&&n.push({stream_type:gt.VIDEO,ssrcId:c._videoSSRC}));case gt.AUDIO:return void(c._audioSSRC&&n.push({stream_type:gt.AUDIO,ssrcId:c._audioSSRC}))}}),n}withdrawRemoteTracks(e){e.forEach(n=>{let[o,{kind:c}]=n;const u=this.remoteUserMap.get(o);u&&(u.delete(c),Array.from(u.entries()).length===0&&this.remoteUserMap.delete(o))})}async updateBitrateLimit(e){const n=this.localTrackMap.get(Je.LocalVideoTrack),o=this.localTrackMap.get(Je.LocalVideoLowTrack);n&&await n.track.setBitrateLimit(e.uplink),o&&e.low_stream_uplink&&await o.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,n=this.recvConnection.peerConnectionState;return e!=="connected"&&n!=="connected"}return!0}async tryToUnmuteAudio(e){for(let n=0;n<e.length;n++)if(e[n]instanceof xn){const o=this.filterTobeUnmutedTracks(e[n]);if(o.length===0)continue;const c=this.createUnmuteMessage(o);return void await Mn(this,We.RequestUnmuteLocal,c)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:n}]=e;return!!n}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var n;return!((n=this.recvConnection)===null||n===void 0||!n.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,n)=>this.emit(We.RequestUpload,e,n),this.statsUploader.requestUploadStats=e=>this.emit(We.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Br(al(this.dtlsFailedCount,or)),this.emit(We.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(Je.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof on)}throwIfTrackTypeNotMatch(e){if(e.filter(n=>n instanceof on).length>1)throw new ke(Q.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(n=>n instanceof xn).length>1&&(e.some(n=>n instanceof xn&&n._bypassWebAudio)||!Dn().webAudioMediaStreamDest))throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const n of e){if(n instanceof on&&this.pendingLocalTracks.some(o=>o instanceof on))throw new ke(Q.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(n instanceof xn&&this.pendingLocalTracks.some(o=>o instanceof xn)&&(!Dn().webAudioMediaStreamDest||n._bypassWebAudio||this.pendingLocalTracks.some(o=>o instanceof xn&&o._bypassWebAudio)))throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,n){const o=!oe("DISABLE_DUAL_STREAM_USE_ENCODING")&&Dn().supportDualStreamEncoding,c=Qk(Qk({},{width:160,height:120,framerate:15,bitrate:50}),n);let u;u=o?e._mediaStreamTrack.clone():Io(e,c);const m=oi(8,"track-low-"),_=new on(u,Qk(Qk({},o&&{scaleResolutionDownBy:zo(c,e)}),{},{frameRate:c.framerate,bitrateMax:c.bitrate,bitrateMin:c.bitrate}),void 0,void 0,m);return _.on(ut.TRANSCEIVER_UPDATED,S=>{e._updateRtpTransceiver(S,Dd.LOW_STREAM)}),_._hints.push(hi.LOW_STREAM),e.addListener(ht.NEED_CLOSE,()=>{_.close()}),_}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,n,o,c){var u;const m=Array.from(ka(u=this.remoteUserMap).call(u)).find(_=>_._videoSSRC===e);if(m){c||this.store.subscribe(m.uid,"video",void 0,void 0,void 0,void 0,Date.now());const _=this.store.keyMetrics,S=_.subscribe.find(C=>C.userId===m.uid&&C.type==="video");vt.firstRemoteVideoDecode(this.store.sessionId,x.FIRST_VIDEO_DECODE,pi.FIRST_VIDEO_DECODE,{peer:m._uintid,videowidth:n,videoheight:o,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:_.requestAPEnd||0,apStart:_.requestAPStart||0,joinGwEnd:_.joinGatewayEnd||0,joinGwStart:_.joinGatewayStart||0,pcEnd:_.peerConnectionEnd||0,pcStart:_.peerConnectionStart||0,subscriberEnd:(S==null?void 0:S.subscribeEnd)||0,subscriberStart:(S==null?void 0:S.subscribeStart)||0,videoAddNotify:(S==null?void 0:S.streamAdded)||0,state:c?1:0})}}async remoteMediaSsrcChanged(e,n,o){if(!this.recvConnection)return!1;const c=this.remoteUserMap.get(e);if(!c)return!1;const u=c.get(n);if(!u)return!1;const m=await this.recvConnection.getRemoteSSRC(u);return m!==void 0&&m!==o}resetConnection(e){M.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===kn.Connected?(M.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new ke(Q.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new ke(Q.NOT_SUPPORTED)}async subscribeDataChannel(e,n){throw new ke(Q.NOT_SUPPORTED)}async unsubscribeDataChannel(e,n){throw new ke(Q.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,n){throw new ke(Q.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,n){throw new ke(Q.NOT_SUPPORTED)}async preConnect(e,n,o,c,u,m){throw new ke(Q.NOT_SUPPORTED)}getEstablishParams(){throw new ke(Q.NOT_SUPPORTED)}async reSubscribe(e){throw new ke(Q.NOT_SUPPORTED)}async updateVideoStreamParameter(e,n){throw new ke(Q.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[n,{track:o}]=e;n===Je.LocalVideoLowTrack?o._updateRtpTransceiver(void 0,Dd.LOW_STREAM):o._updateRtpTransceiver(void 0)})}}function Uu(r){return function(e,n,o){const c=e[n];if(typeof c!="function")throw new Error("Cannot use mutex on object property.");return o.value=async function(){for(var u=arguments.length,m=new Array(u),_=0;_<u;_++)m[_]=arguments[_];switch(r){case Wd.SEND_ONLY:{const S=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await c.apply(this,m)}finally{S()}}case Wd.RECEIVE_ONLY:{const S=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await c.apply(this,m)}finally{S()}}default:{const S=await this.sendMutex.lock("From P2PChannel2.".concat(n)),C=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await c.apply(this,m)}finally{S(),C()}}}},o}}function l5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function CS(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?l5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):l5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}Ge([Uu(Wd.SEND_ONLY),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ns.prototype,"p2pConnect",null),Ge([Uu(Wd.SEND_ONLY),z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ns.prototype,"unpublish",null),Ge([Uu(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ns.prototype,"unpublishLowStream",null),Ge([Uu(Wd.RECEIVE_ONLY),z("design:type",Function),z("design:paramtypes",[xs,String,Number,String]),z("design:returntype",Ee)],ns.prototype,"subscribe",null),Ge([Uu(Wd.RECEIVE_ONLY),z("design:type",Function),z("design:paramtypes",[xs,String,Number,String]),z("design:returntype",Ee)],ns.prototype,"mockSubscribe",null),Ge([Uu(Wd.RECEIVE_ONLY),z("design:type",Function),z("design:paramtypes",[xs,String,Boolean]),z("design:returntype",Ee)],ns.prototype,"unsubscribe",null),Ge([Uu(Wd.RECEIVE_ONLY),z("design:type",Function),z("design:paramtypes",[xs,String]),z("design:returntype",Ee)],ns.prototype,"muteRemote",null),Ge([Uu(Wd.RECEIVE_ONLY),z("design:type",Function),z("design:paramtypes",[xs,String]),z("design:returntype",Ee)],ns.prototype,"unmuteRemote",null),Ge([Uu(Wd.RECEIVE_ONLY),z("design:type",Function),z("design:paramtypes",[xs,String]),z("design:returntype",Ee)],ns.prototype,"hasRemoteMediaWithLock",null),Ge([Uu(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ns.prototype,"disconnectForReconnect",null),Ge([Uu(Wd.RECEIVE_ONLY),z("design:type",Function),z("design:paramtypes",[xs,String,Number]),z("design:returntype",Ee)],ns.prototype,"remoteMediaSsrcChanged",null);class m0{constructor(e){D(this,"store",void 0),D(this,"onStatsException",void 0),D(this,"onUploadPublishDuration",void 0),D(this,"onStatsChanged",void 0),D(this,"localStats",new Map),D(this,"remoteStats",new Map),D(this,"updateStatsInterval",void 0),D(this,"trafficStats",void 0),D(this,"trafficStatsPeerList",[]),D(this,"uplinkStats",void 0),D(this,"exceptionMonitor",void 0),D(this,"p2pChannel",void 0),D(this,"scalabilityMode",ww.L1T1),D(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new Yk,this.exceptionMonitor.on("exception",(n,o,c)=>{this.onStatsException&&this.onStatsException(n,o,c)})}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Je.LocalAudioTrack)||CS({},Sh)}getLocalVideoTrackStats(){return this.localStats.get(Je.LocalVideoTrack)||CS({},pl)}getRemoteAudioTrackStats(e){const n=(u,m)=>{if(!this.trafficStats)return m;const _=this.trafficStats.peer_delay.find(S=>S.peer_uid===u);return _&&(m.publishDuration=_.B_ppad+(Date.now()-this.trafficStats.timestamp)),m},o={};if(e){var c;const u=(c=this.remoteStats.get(e))===null||c===void 0?void 0:c.audioStats;u&&(o[e]=n(e,u))}else Array.from(this.remoteStats.entries()).forEach(u=>{let[m,{audioStats:_}]=u;_&&(o[m]=n(m,_))});return o}getRemoteNetworkQualityStats(e){const n={};if(e){var o;const c=(o=this.remoteStats.get(e))===null||o===void 0?void 0:o.networkStats;c&&(n[e]=c)}else Array.from(this.remoteStats.entries()).forEach(c=>{let[u,{networkStats:m}]=c;m&&(n[u]=m)});return n}getRemoteVideoTrackStats(e){const n=(u,m)=>{if(!this.trafficStats)return m;const _=this.trafficStats.peer_delay.find(S=>S.peer_uid===u);return _&&(m.publishDuration=_.B_ppvd+(Date.now()-this.trafficStats.timestamp)),m},o={};if(e){var c;const u=(c=this.remoteStats.get(e))===null||c===void 0?void 0:c.videoStats;u&&(o[e]=n(e,u))}else Array.from(this.remoteStats.entries()).forEach(u=>{let[m,{videoStats:_}]=u;_&&(o[m]=n(m,_))});return o}getRTCStats(){let e=0,n=0,o=0,c=0;const u=this.localStats.get(Je.LocalAudioTrack);u&&(e+=u.sendBytes,n+=u.sendBitrate);const m=this.localStats.get(Je.LocalVideoTrack);m&&(e+=m.sendBytes,n+=m.sendBitrate);const _=this.localStats.get(Je.LocalVideoLowTrack);_&&(e+=_.sendBytes,n+=_.sendBitrate),this.remoteStats.forEach(C=>{let{audioStats:R,videoStats:w}=C;R&&(o+=R.receiveBytes,c+=R.receiveBitrate),w&&(o+=w.receiveBytes,c+=w.receiveBitrate)});let S=1;return this.trafficStats&&(S+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:S,SendBitrate:n,SendBytes:e,RecvBytes:o,RecvBitrate:c,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(n=>n.B_ppad!==void 0||n.B_ppvd!==void 0),e.peer_delay.filter(n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1).forEach(n=>{var o;const c=(o=this.p2pChannel)===null||o===void 0?void 0:o.getRemoteMedia(n.peer_uid),u=c!=null&&c.videoSSRC?Us.measureFromSubscribeStart(this.store.clientId,c.videoSSRC):0,m=c!=null&&c.audioSSRC?Us.measureFromSubscribeStart(this.store.clientId,c.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,u>m?u:m),this.trafficStatsPeerList.push(n.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&M.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,n,o){if(!e)return!1;const c=!!o&&n.framesDecodeFreezeTime>o.framesDecodeFreezeTime,u=!o||n.framesDecodeCount>o.framesDecodeCount;return c||!u}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(n=>{let[o,c]=n;switch(o){case Je.LocalVideoTrack:case Je.LocalVideoLowTrack:{const m=c,_=CS({},pl),S=e.getStats(),C=e.getLocalMedia(o);if(S){const R=S.videoSend.find(w=>w.ssrc===(C==null?void 0:C.ssrcs[0].ssrcId));if(R){const w=e.getLocalVideoSize(),N=e.getEncoderConfig(Je.LocalVideoTrack);R.codec!=="H264"&&R.codec!=="H265"&&R.codec!=="VP8"&&R.codec!=="VP9"&&R.codec!=="AV1X"&&R.codec!=="AV1"||(_.codecType=R.codec),_.sendBytes=R.bytes,_.sendBitrate=m?8*Math.max(0,_.sendBytes-m.sendBytes):0,R.inputFrame?(_.captureFrameRate=R.inputFrame.frameRate,_.captureResolutionHeight=R.inputFrame.height,_.captureResolutionWidth=R.inputFrame.width):w&&(_.captureResolutionWidth=w.width,_.captureResolutionHeight=w.height),R.sentFrame?(_.sendFrameRate=R.sentFrame.frameRate,_.sendResolutionHeight=R.sentFrame.height,_.sendResolutionWidth=R.sentFrame.width):w&&(_.sendResolutionWidth=w.width,_.sendResolutionHeight=w.height),R.avgEncodeMs&&(_.encodeDelay=R.avgEncodeMs),N&&N.bitrateMax&&(_.targetSendBitrate=1e3*N.bitrateMax),_.sendPackets=R.packets,_.sendPacketsLost=R.packetsLost,_.sendJitterMs=R.jitterMs,_.sendRttMs=R.rttMs,_.totalDuration=m?m.totalDuration+1:1,_.totalFreezeTime=m?m.totalFreezeTime:0,this.isLocalVideoFreeze(R)&&(_.totalFreezeTime+=1),R.scalabilityMode&&this.scalabilityMode!==R.scalabilityMode&&(M.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(R.scalabilityMode)),this.scalabilityMode=R.scalabilityMode)}this.trafficStats&&(_.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var u;this.localStats.set(o,_),((m==null?void 0:m.sendResolutionWidth)!==_.sendResolutionWidth||(m==null?void 0:m.sendResolutionHeight)!==_.sendResolutionHeight)&&((u=this.onStatsChanged)===null||u===void 0||u.call(this,"resolution",{width:_.sendResolutionWidth,height:_.sendResolutionHeight})),_&&C&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,C.track,_);break}case Je.LocalAudioTrack:{const m=c,_=CS({},Sh),S=e.getStats(),C=e.getLocalMedia(o);if(S){const R=S.audioSend.find(w=>w.ssrc===(C==null?void 0:C.ssrcs[0].ssrcId));if(R){if(R.codec!=="opus"&&R.codec!=="aac"&&R.codec!=="PCMU"&&R.codec!=="PCMA"&&R.codec!=="G722"||(_.codecType=R.codec),R.inputLevel)_.sendVolumeLevel=Math.round(32767*R.inputLevel);else{const w=e.getLocalAudioVolume();w&&(_.sendVolumeLevel=Math.round(32767*w))}_.sendBytes=R.bytes,_.sendPackets=R.packets,_.sendPacketsLost=R.packetsLost,_.sendJitterMs=R.jitterMs,_.sendRttMs=R.rttMs,_.sendBitrate=m?8*Math.max(0,_.sendBytes-m.sendBytes):0}}this.trafficStats&&(_.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(Je.LocalAudioTrack,_),_&&C&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,C.track,_);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(n=>{var o,c;let[u,{videoStats:m,audioStats:_,videoPcStats:S}]=n;const C=_,R=m,w=S,N=CS({},Th),L=CS({},yg),H=CS({},Jo),{audioTrack:j,videoTrack:W,audioSSRC:ee,videoSSRC:re}=e.getRemoteMedia(u);let fe;fe=e instanceof ns?e.getStats(!0):e.getStats();const be=(o=fe)===null||o===void 0?void 0:o.audioRecv.find(Le=>Le.ssrc===ee),_e=(c=fe)===null||c===void 0?void 0:c.videoRecv.find(Le=>Le.ssrc===re),ye=this.trafficStats&&this.trafficStats.peer_delay.find(Le=>Le.peer_uid===u);if(be&&(be.codec!=="opus"&&be.codec!=="aac"&&be.codec!=="PCMU"&&be.codec!=="PCMA"&&be.codec!=="G722"||(N.codecType=be.codec),be.outputLevel?N.receiveLevel=Math.round(32767*be.outputLevel):j&&(N.receiveLevel=Math.round(32767*j.getVolumeLevel())),N.receiveBytes=be.bytes,N.receivePackets=be.packets,N.receivePacketsLost=be.packetsLost,N.packetLossRate=N.receivePacketsLost/(N.receivePackets+N.receivePacketsLost),N.receiveBitrate=C?8*Math.max(0,N.receiveBytes-C.receiveBytes):0,N.totalDuration=C?C.totalDuration+1:1,N.totalFreezeTime=C?C.totalFreezeTime:0,N.freezeRate=N.totalFreezeTime/N.totalDuration,N.receiveDelay=be.jitterBufferMs,N.totalDuration>10&&m0.isRemoteAudioFreeze(j)&&(N.totalFreezeTime+=1)),_e){_e.codec!=="H264"&&_e.codec!=="H265"&&_e.codec!=="VP8"&&_e.codec!=="VP9"&&_e.codec!=="AV1X"&&_e.codec!=="AV1"||(L.codecType=_e.codec),L.receiveBytes=_e.bytes,L.receiveBitrate=R?8*Math.max(0,L.receiveBytes-R.receiveBytes):0,L.decodeFrameRate=_e.decodeFrameRate<0?0:_e.decodeFrameRate,L.renderFrameRate=_e.decodeFrameRate<0?0:_e.decodeFrameRate,_e.outputFrame&&(L.renderFrameRate=_e.outputFrame.frameRate),_e.receivedFrame?(L.receiveFrameRate=_e.receivedFrame.frameRate,L.receiveResolutionHeight=_e.receivedFrame.height,L.receiveResolutionWidth=_e.receivedFrame.width):W&&(L.receiveResolutionHeight=W._videoHeight||0,L.receiveResolutionWidth=W._videoWidth||0),_e.framesRateFirefox!==void 0&&(L.receiveFrameRate=Math.round(_e.framesRateFirefox)),L.receivePackets=_e.packets,L.receivePacketsLost=_e.packetsLost,L.packetLossRate=L.receivePacketsLost/(L.receivePackets+L.receivePacketsLost),L.totalDuration=R?R.totalDuration+1:1,L.totalFreezeTime=R?R.totalFreezeTime:0,L.receiveDelay=_e.jitterBufferMs||0;const Le=!!re&&e.getRemoteVideoIsReady(re);W&&Le&&m0.isRemoteVideoFreeze(W,_e,w)&&(L.totalFreezeTime+=1),L.freezeRate=L.totalFreezeTime/L.totalDuration}ye&&(N.end2EndDelay=ye.B_ad,L.end2EndDelay=ye.B_vd,N.transportDelay=ye.B_ed,L.transportDelay=ye.B_ed,N.currentPacketLossRate=ye.B_ealr4/100,L.currentPacketLossRate=ye.B_evlr4/100,H.uplinkNetworkQuality=ye.B_punq?ye.B_punq:0,H.downlinkNetworkQuality=ye.B_pdnq?ye.B_pdnq:0),this.remoteStats.set(u,{audioStats:N,videoStats:L,videoPcStats:_e,networkStats:H}),j&&this.exceptionMonitor.setRemoteAudioStats(j,N),W&&this.exceptionMonitor.setRemoteVideoStats(W,L)})}}function u5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function f0(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?u5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):u5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class QY extends Dt{constructor(e,n,o,c){super(),D(this,"spec",void 0),D(this,"token",void 0),D(this,"websocket",void 0),D(this,"pingpongTimer",void 0),D(this,"reconnectMode","retry"),D(this,"serviceMode",void 0),D(this,"reqId",0),D(this,"commandReqId",0),D(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),D(this,"handleWebSocketMessage",u=>{if(!u.data)return;const m=JSON.parse(u.data);m.requestId?this.emit("@".concat(m.requestId,"-").concat(m.sid),m):this.serviceMode===Li.INJECT?this.emit(Hc.INJECT_STREAM_STATUS,m):(vt.workerEvent(this.spec.sid,{actionType:"status",serverCode:m.code,workerType:this.serviceMode===Li.TRANSCODE?1:2}),this.emit(Hc.PUBLISH_STREAM_STATUS,m))}),this.spec=n,this.token=e,this.serviceMode=c,this.websocket=new _g("live-streaming",o),this.websocket.on(qe.CONNECTED,this.handleWebSocketOpen),this.websocket.on(qe.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(qe.REQUEST_NEW_URLS,(u,m)=>{Ji(this,Hc.REQUEST_NEW_ADDRESS).then(u).catch(m)}),this.websocket.on(qe.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,n,o,c){this.reqId+=1,e==="request"&&(this.commandReqId+=1);const u=this.commandReqId,m=this.reqId;if(!m||!this.websocket)throw new Te(Q.UNEXPECTED_ERROR);const _=f0({command:e,sdkVersion:mr==="4.20.2"?"0.0.1":mr,seq:m,requestId:m,allocate:o,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new Te(Q.WS_DISCONNECT);const S=()=>new Ee((N,L)=>{this.websocket.once(qe.CLOSED,()=>L(new Te(Q.WS_ABORT))),this.websocket.once(qe.CONNECTED,N)});this.websocket.state!=="connected"&&await S(),_.clientRequest&&(_.clientRequest.workerToken=this.token);const C=new Ee((N,L)=>{const H=()=>{L(new Te(Q.WS_ABORT))};this.websocket.once(qe.RECONNECTING,H),this.websocket.once(qe.CLOSED,H),this.once("@".concat(m,"-").concat(this.spec.sid),j=>{N(j)})});c&&vt.workerEvent(this.spec.sid,f0(f0({},c),{},{requestId:u,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const R=Date.now();this.websocket.sendMessage(_);let w=null;try{w=await C}catch(N){if(this.websocket.state==="closed")throw N;return await S(),await this.request(e,n,o)}return c&&vt.workerEvent(this.spec.sid,f0(f0({},c),{},{requestId:u,actionType:"response",payload:JSON.stringify(w.serverResponse),serverCode:w.code,success:w.code===200,responseTime:Date.now()-R})),w.code!==200&&this.handleResponseError(w),w}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e=mr==="4.20.2"?"0.0.1":mr;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Xi.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void M.warning("live stream response already exists stream");case Xi.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Xi.LIVE_STREAM_RESPONSE_BAD_STREAM:case Xi.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Te(Q.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Xi.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Xi.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Te(Q.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Xi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new Te(Q.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Hc.WARNING,n,e.serverResponse.url)}case Xi.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new Te(Q.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Hc.WARNING,n,e.serverResponse.url)}case Xi.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Xi.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Te(Q.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Xi.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new Te(Q.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Hc.WARNING,n,e.serverResponse.url)}case Xi.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Xi.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Xi.LIVE_STREAM_RESPONSE_WORKER_LOST:case Xi.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Xi.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Xi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Xi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Xi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Xi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Te(Q.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(LT)},6e3)}}function h5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function wa(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?h5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):h5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class ZY extends Dt{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:or,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:or;super(),D(this,"onLiveStreamWarning",void 0),D(this,"onLiveStreamError",void 0),D(this,"onInjectStatusChange",void 0),D(this,"spec",void 0),D(this,"retryTimeout",1e4),D(this,"connection",void 0),D(this,"httpRetryConfig",void 0),D(this,"wsRetryConfig",void 0),D(this,"streamingTasks",new Map),D(this,"isStartingStreamingTask",!1),D(this,"taskMutex",new Zr("live-streaming")),D(this,"cancelToken",no.CancelToken.source()),D(this,"transcodingConfig",void 0),D(this,"injectConfig",wa({},Dw)),D(this,"injectLoopTimes",0),D(this,"uapResponse",void 0),D(this,"lastTaskId",1),D(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=o,this.wsRetryConfig=n}async setTranscodingConfig(e){const n=wa(wa({},Nw),e);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(M.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map(m=>wa(wa(wa({},Be),m),{},{zOrder:m.zOrder?m.zOrder+1:1}))),function(m){Ai(m.width)||Jn(m.width,"config.width",0,1e4),Ai(m.height)||Jn(m.height,"config.height",0,1e4),Ai(m.videoBitrate)||Jn(m.videoBitrate,"config.videoBitrate",1,1e6),Ai(m.videoFrameRate)||Jn(m.videoFrameRate,"config.videoFrameRate"),Ai(m.lowLatency)||nl(m.lowLatency,"config.lowLatency"),Ai(m.audioSampleRate)||Rr(m.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Ai(m.audioBitrate)||Jn(m.audioBitrate,"config.audioBitrate",1,128),Ai(m.audioChannels)||Rr(m.audioChannels,"config.audioChannels",[1,2,3,4,5]),Ai(m.videoGop)||Jn(m.videoGop,"config.videoGop"),Ai(m.videoCodecProfile)||Rr(m.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Ai(m.userCount)||Jn(m.userCount,"config.userCount",0,17),Ai(m.backgroundColor)||Jn(m.backgroundColor,"config.backgroundColor",0,16777215),Ai(m.userConfigExtraInfo)||Xr(m.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),m.transcodingUsers&&!Ai(m.transcodingUsers)&&(il(m.transcodingUsers,"config.transcodingUsers"),m.transcodingUsers.forEach((_,S)=>{hc(_.uid),Ai(_.x)||Jn(_.x,"transcodingUser[".concat(S,"].x"),0,1e4),Ai(_.y)||Jn(_.y,"transcodingUser[".concat(S,"].y"),0,1e4),Ai(_.width)||Jn(_.width,"transcodingUser[".concat(S,"].width"),0,1e4),Ai(_.height)||Jn(_.height,"transcodingUser[".concat(S,"].height"),0,1e4),Ai(_.zOrder)||Jn(_.zOrder-1,"transcodingUser[".concat(S,"].zOrder"),0,100),Ai(_.alpha)||Jn(_.alpha,"transcodingUser[".concat(S,"].alpha"),0,1,!1)})),Ai(m.watermark)||Ce(m.watermark,"watermark"),Ai(m.backgroundImage)||Ce(m.backgroundImage,"backgroundImage"),m.images&&!Ai(m.images)&&(il(m.images,"config.images"),m.images.forEach((_,S)=>{Ce(_,"images[".concat(S,"]"))}))}(n);const o=[];n.images&&o.push(...n.images.map(m=>wa(wa(wa({},Y),m),{},{zOrder:255}))),n.backgroundImage&&(o.push(wa(wa(wa({},Y),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(o.push(wa(wa(wa({},Y),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=o,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map(m=>wa({},m)),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const c=(n.userConfigs||[]).map(m=>typeof m.uid=="number"?Ee.resolve(m.uid):jp(m.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Ee.all(c)).forEach((m,_)=>{n.userConfigs&&n.userConfigs[_]&&(n.userConfigs[_].uid=m)}),this.transcodingConfig=n,this.connection)try{var u;const m=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(wd(u=this.streamingTasks).call(u)).map(_=>_.taskId).join("#")});M.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(m.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(m){if(!m.data||!m.data.retry)throw m;m.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(_=>{M.warning("[".concat(this.spec.clientId,"] live streaming receive error"),m.toString(),"try to republish",_.url),this.startLiveStreamingTask(_.url,_.mode,m).then(()=>{M.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(_.url," success"))}).catch(S=>{M.error("[".concat(this.spec.clientId,"] live streaming republish failed"),_.url,S.toString()),this.onLiveStreamError&&this.onLiveStreamError(_.url,S)})})}}setInjectStreamConfig(e,n){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=n}async startLiveStreamingTask(e,n,o){var c;if(Array.from(wd(c=this.streamingTasks).call(c)).find(S=>S.mode===Li.INJECT)&&n===Li.INJECT)return new Te(Q.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&n===Li.TRANSCODE)throw new Te(Q.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let u={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};M.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(n));const m=await this.taskMutex.lock();if(!this.connection&&o)return void m();if(this.streamingTasks.get(e)&&!o)return m(),new Te(Q.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(S){throw m(),S}switch(n){case Li.TRANSCODE:u.transcodingConfig=wa({},this.transcodingConfig);break;case Li.RAW:break;case Li.INJECT:u={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(u.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const _=this.lastTaskId++;try{const S=new Ee((R,w)=>{Br(this.retryTimeout).then(()=>{if(o)return w(o);const N=this.statusError.get(e);return N?(this.statusError.delete(e),w(N)):void 0})}),C=await Ee.race([this.connection.request("request",{clientRequest:u},!0,{url:e,command:"PublishStream",workerType:n===Li.TRANSCODE?1:2,requestByUser:!o,tid:_.toString()}),S]);this.isStartingStreamingTask=!1,M.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(C.code)),this.streamingTasks.set(e,{clientRequest:u,mode:n,url:e,taskId:_}),m()}catch(S){if(m(),this.isStartingStreamingTask=!1,!S.data||!S.data.retry||o)throw S;return S.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,n,S)):await this.startLiveStreamingTask(e,n,S)}}stopLiveStreamingTask(e){return new Ee((n,o)=>{const c=this.streamingTasks.get(e);if(!c||!this.connection)return new Te(Q.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const u=c.mode;c.abortTask=()=>{M.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),n()},this.connection.request("request",{clientRequest:{command:u===Li.INJECT?"UninjectStream":"UnpublishStream",url:c.url}},!1,{url:e,command:"UnPublishStream",workerType:u===Li.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(m=>{M.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(m.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&u!==Li.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),n(),u===Li.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Ut.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)}).catch(o)})}async controlInjectStream(e,n,o,c){const u=this.streamingTasks.get(e);if(!u||!this.connection||u.mode!==Li.INJECT)throw new Te(Q.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:n,audioVolume:o,position:c}})).serverResponse}resetAllTask(){var e;const n=Array.from(wd(e=this.streamingTasks).call(e));this.terminate();for(const o of n)this.startLiveStreamingTask(o.url,o.mode).catch(c=>{this.onLiveStreamError&&this.onLiveStreamError(o.url,c)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=no.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new Te(Q.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await Ji(this,ph.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=n,this.connection=new QY(n.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(Hc.WARNING,(o,c)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(c,o)),this.connection.on(Hc.PUBLISH_STREAM_STATUS,o=>this.handlePublishStreamServer(o)),this.connection.on(Hc.INJECT_STREAM_STATUS,o=>this.handleInjectStreamServerStatus(o)),this.connection.on(Hc.REQUEST_NEW_ADDRESS,(o,c)=>{if(!this.connection)return c(new Te(Q.UNEXPECTED_ERROR,"can not get new live streaming address list"));Ji(this,ph.REQUEST_WORKER_MANAGER_LIST,e).then(u=>{this.uapResponse=u,o(u.addressList)}).catch(c)}),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(e){const n=e.serverStatus&&e.serverStatus.url||"empty_url",o=this.streamingTasks.get(n),c=e.reason;switch(e.code){case Xi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Xi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Xi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Xi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const m=new Te(Q.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(o)return M.error(m.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,m);if(!this.isStartingStreamingTask)return;this.statusError.set(n,m)}case Xi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const m=new Te(Q.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,c);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,m)}case Xi.LIVE_STREAM_RESPONSE_WORKER_LOST:case Xi.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var u;if(!this.connection)return;this.connection.tryNextAddress();const m=Array.from(wd(u=this.streamingTasks).call(u));for(const _ of m)_.abortTask?_.abortTask():(M.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",_.url),this.startLiveStreamingTask(_.url,_.mode,new Te(Q.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{M.debug("[".concat(this.spec.clientId,"] republish live stream success"),_.url)}).catch(S=>{M.error(S.toString()),this.onLiveStreamError&&this.onLiveStreamError(_.url,S)}));return}}}handleInjectStreamServerStatus(e){const n=Number(e.uid),o=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Ut.INJECT_STREAM_STATUS_START_SUCCESS,n,o));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Ut.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,n,o),void this.streamingTasks.delete(o);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Ut.INJECT_STREAM_STATUS_START_UNAUTHORIZED,n,o),void this.streamingTasks.delete(o);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Ut.INJECT_STREAM_STATUS_BROKEN,n,o),void this.streamingTasks.delete(o);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Ut.INJECT_STREAM_STATUS_START_TIMEOUT,n,o),void this.streamingTasks.delete(o);default:return void M.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class Zk{constructor(){D(this,"destChannelMediaInfos",new Map),D(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){Wi(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){Wi(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Ow(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function p5(r){if(!(r instanceof Zk))return new Te(Q.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=r.getSrcChannelMediaInfo(),n=r.getDestChannelMediaInfo();if(!e)return new Te(Q.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new Te(Q.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class $Y extends Dt{constructor(e,n,o){super(),D(this,"ws",void 0),D(this,"requestId",1),D(this,"heartBeatTimer",void 0),D(this,"joinInfo",void 0),D(this,"clientId",void 0),D(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),D(this,"onClose",c=>{this.emit("close"),this.dispose()}),D(this,"onMessage",c=>{const u=JSON.parse(c.data);if(!u||u.command!=="serverResponse"||!u.requestId)return u&&u.command==="serverStatus"&&u.serverStatus&&u.serverStatus.command?(this.emit("status",u.serverStatus),void this.emit(u.serverStatus.command,u.serverStatus)):void 0;this.emit("req_".concat(u.requestId),u)}),this.joinInfo=e,this.clientId=n,this.ws=new _g("cross-channel-".concat(this.clientId),o),this.ws.on(qe.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(qe.CONNECTED,this.onOpen),this.ws.on(qe.ON_MESSAGE,this.onMessage),this.ws.on(qe.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){const n=this.requestId++;return e.requestId=n,e.seq=n,this.ws.sendMessage(e),n}waitStatus(e){return new Ee((n,o)=>{const c=window.setTimeout(()=>{o(new Te(Q.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,u=>{window.clearTimeout(c),u.state&&u.state!==0?o(new Te(Q.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):n(void 0)}),this.once("dispose",()=>{window.clearTimeout(c),o(new Te(Q.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new Te(Q.WS_DISCONNECT);const n=()=>new Ee((m,_)=>{this.ws.once(qe.CLOSED,()=>_(new Te(Q.WS_ABORT))),this.ws.once(qe.CONNECTED,m)});this.ws.state!=="connected"&&await n();const o=this.sendMessage(e),c=new Ee((m,_)=>{const S=()=>{_(new Te(Q.WS_ABORT))};this.ws.once(qe.RECONNECTING,S),this.ws.once(qe.CLOSED,S),this.once("req_".concat(o),m),Br(3e3).then(()=>{this.removeAllListeners("req_".concat(o)),this.ws.off(qe.RECONNECTING,S),this.ws.off(qe.CLOSED,S),_(new Te(Q.TIMEOUT,"cross channel ws request timeout"))})}),u=await c;if(!u||u.code!==200)throw new Te(Q.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(u)));return u}async connect(e){this.ws.removeAllListeners(qe.REQUEST_NEW_URLS),this.ws.on(qe.REQUEST_NEW_URLS,n=>{n(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const n=this.requestId++;return e.requestId=n,this.ws.sendMessage(e),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class ez extends Dt{set state(e){e!==this._state&&(e!==hs.RELAY_STATE_FAILURE&&(this.errorCode=Ti.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,n,o,c,u){super(),D(this,"joinInfo",void 0),D(this,"sid",void 0),D(this,"clientId",void 0),D(this,"cancelToken",no.CancelToken.source()),D(this,"workerToken",void 0),D(this,"requestId",0),D(this,"signal",void 0),D(this,"prevChannelMediaConfig",void 0),D(this,"httpRetryConfig",void 0),D(this,"_resolution",void 0),D(this,"_state",hs.RELAY_STATE_IDLE),D(this,"errorCode",Ti.RELAY_OK),D(this,"onStatus",m=>{M.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(m))),m&&m.command&&(m.command==="onAudioPacketReceived"&&this.emit("event",Cs.PACKET_RECEIVED_AUDIO_FROM_SRC),m.command==="onVideoPacketReceived"&&this.emit("event",Cs.PACKET_RECEIVED_VIDEO_FROM_SRC),m.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Ti.SRC_TOKEN_EXPIRED,this.state=hs.RELAY_STATE_FAILURE),m.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Ti.DEST_TOKEN_EXPIRED,this.state=hs.RELAY_STATE_FAILURE))}),D(this,"onReconnect",async()=>{M.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Cs.NETWORK_DISCONNECTED),this.state=hs.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(m=>{this.state!==hs.RELAY_STATE_IDLE&&(M.error("auto restart channel media relay failed",m.toString()),this.errorCode=Ti.SERVER_CONNECTION_LOST,this.state=hs.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=n,this.sid=qA(),this.signal=new $Y(this.joinInfo,this.clientId,o),this.httpRetryConfig=c,this._resolution=u}async startChannelMediaRelay(e){if(this.state!==hs.RELAY_STATE_IDLE)throw new Te(Q.INVALID_OPERATION);this.state=hs.RELAY_STATE_CONNECTING,await this.connect(),M.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new Te(Q.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new Te(Q.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new Te(Q.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==hs.RELAY_STATE_RUNNING)throw new Te(Q.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==hs.RELAY_STATE_RUNNING)throw new Te(Q.INVALID_OPERATION);const n=this.genMessage(Ys.SetVideoProfile);await this.signal.request(n),M.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),M.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=hs.RELAY_STATE_IDLE,this.dispose()}dispose(){M.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=no.CancelToken.source(),this.state=hs.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await wP(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Cs.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const n=this.genMessage(Ys.StopPacketTransfer);await this.signal.request(n),await this.signal.waitStatus("Normal Quit"),M.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const o=this.genMessage(Ys.SetSdkProfile,e);await this.signal.request(o),M.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const c=this.genMessage(Ys.SetSourceChannel,e);await this.signal.request(c),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Cs.PACKET_JOINED_SRC_CHANNEL),M.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const u=this.genMessage(Ys.SetSourceUserId,e);await this.signal.request(u),M.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const m=this.genMessage(Ys.SetDestChannel,e);await this.signal.request(m),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Cs.PACKET_JOINED_DEST_CHANNEL),M.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const _=this.genMessage(Ys.StartPacketTransfer,e);await this.signal.request(_),this.emit("event",Cs.PACKET_SENT_TO_DEST_CHANNEL),this.state=hs.RELAY_STATE_RUNNING,M.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const n=this.genMessage(Ys.UpdateDestChannel,e);await this.signal.request(n),this.emit("event",Cs.PACKET_UPDATE_DEST_CHANNEL),M.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(Ys.StopPacketTransfer);await this.signal.request(e),M.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,n){const o=[],c=[],u=[];this.requestId+=1;const m={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:mr,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};m.sdkVersion==="4.20.2"&&(m.sdkVersion="0.0.1");let _=null,S=null;switch(e){case Ys.SetSdkProfile:return m.clientRequest={command:"SetSdkProfile",type:"multi_channel"},m;case Ys.SetSourceChannel:if(S=n&&n.getSrcChannelMediaInfo(),!S)throw new Te(Q.UNEXPECTED_ERROR,"can not find source config");return m.clientRequest={command:"SetSourceChannel",uid:"0",channelName:S.channelName,token:S.token||this.joinInfo.appId},m;case Ys.SetSourceUserId:if(S=n&&n.getSrcChannelMediaInfo(),!S)throw new Te(Q.UNEXPECTED_ERROR,"can not find source config");return m.clientRequest={command:"SetSourceUserId",uid:S.uid+""},m;case Ys.SetDestChannel:if(_=n&&n.getDestChannelMediaInfo(),!_)throw new Te(Q.UNEXPECTED_ERROR,"can not find dest config");return _.forEach(C=>{o.push(C.channelName),c.push(C.uid+""),u.push(C.token||this.joinInfo.appId)}),m.clientRequest={command:"SetDestChannel",channelName:o,uid:c,token:u},m;case Ys.StartPacketTransfer:return m.clientRequest={command:"StartPacketTransfer"},m;case Ys.Reconnect:return m.clientRequest={command:"Reconnect"},m;case Ys.StopPacketTransfer:return m.clientRequest={command:"StopPacketTransfer"},m;case Ys.UpdateDestChannel:if(_=n&&n.getDestChannelMediaInfo(),!_)throw new Te(Q.UNEXPECTED_ERROR,"can not find dest config");return _.forEach(C=>{o.push(C.channelName),c.push(C.uid+""),u.push(C.token||this.joinInfo.appId)}),m.clientRequest={command:"UpdateDestChannel",channelName:o,uid:c,token:u},m;case Ys.SetVideoProfile:m.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return m}}function $k(r){var e={},n=!1;function o(c,u){return n=!0,{done:!1,value:new h0(u=new lv(function(m){m(r[c](u))}),1)}}return e[qu!==void 0&&$O||"@@iterator"]=function(){return this},e.next=function(c){return n?(n=!1,c):o("next",c)},typeof r.throw=="function"&&(e.throw=function(c){if(n)throw n=!1,c;return o("throw",c)}),typeof r.return=="function"&&(e.return=function(c){return n?(n=!1,c):o("return",c)}),e}var m5=A(qk);function f5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function _5(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?f5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):f5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function E5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function g5(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?E5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):E5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class As extends Od{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return xe(n=Object.keys(Ko)).call(n,e)}))]}constructor(e,n){super(e,n),D(this,"store",void 0),D(this,"peerConnection",void 0),D(this,"remoteSDP",void 0),D(this,"initialOffer",void 0),D(this,"statsFilter",void 0),D(this,"useRTX",!1),D(this,"localCapabilities",void 0),D(this,"localCandidateCount",0),D(this,"allCandidatesReceived",!1),D(this,"establishPromise",void 0),D(this,"mutex",new Zr("P2PConnection-mutex")),this.store=n,this.peerConnection=new RTCPeerConnection(As.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=He(this.peerConnection,oe("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=_n(e.sdp),o=Wt(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:oe("FILTER_VIDEO_FEC"),filterAudioFec:oe("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=o,this.initialOffer=e,g5(g5({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:o},offerSDP:e.sdp})}catch(e){throw new ke(Q.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,n,o,c,u,m){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(S){D(this,"sessionDesc",void 0),D(this,"localCapabilities",void 0),D(this,"rtpCapabilities",void 0),D(this,"candidates",void 0),D(this,"iceParameters",void 0),D(this,"dtlsParameters",void 0),D(this,"setup",void 0),D(this,"currentMidIndex",void 0),D(this,"cname",void 0),S=sn(S);const{remoteIceParameters:C,remoteDtlsParameters:R,candidates:w,remoteRTPCapabilities:N,remoteSetup:L,localCapabilities:H,sdkCodec:j,cname:W}=S,ee=U.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=N,this.candidates=w,this.iceParameters=C,this.dtlsParameters=R,this.setup=L,this.localCapabilities=H,this.cname=W;for(let re=0;re<ee.mediaDescriptions.length;re++){const fe=ee.mediaDescriptions[re];if(fe.attributes.iceUfrag=C.iceUfrag,fe.attributes.icePwd=C.icePwd,fe.attributes.fingerprints=R.fingerprints,fe.attributes.candidates=w,fe.attributes.setup=L,fe.media.mediaType==="video"){fe.media.fmts=N.videoCodecs.map(_e=>_e.payloadType.toString(10));let be=N.videoCodecs.filter(_e=>{var ye,Le;return(ye=_e.rtpMap)===null||ye===void 0?void 0:xe(Le=ye.encodingName.toLowerCase()).call(Le,j)});be.length===0&&(be=N.videoCodecs),fe.attributes.payloads=be,fe.attributes.extmaps=N.videoExtensions}fe.media.mediaType==="audio"&&(fe.media.fmts=N.audioCodecs.map(be=>be.payloadType.toString(10)),fe.attributes.payloads=N.audioCodecs,fe.attributes.extmaps=N.audioExtensions),ee.mediaDescriptions[re]=this.mungMediaDesc(fe)}this.sessionDesc=ee,this.currentMidIndex=ee.mediaDescriptions.length-1}toString(){return U.print(this.sessionDesc)}send(S,C,R){const{ssrcs:w,ssrcGroups:N}=ie(C,this.cname),L=this.sessionDesc.mediaDescriptions.find(W=>S===gt.VIDEO?W.media.mediaType==="video":W.media.mediaType==="audio"),H=w[0].attributes.label,j=w[0].attributes.mslabel;return L.attributes.ssrcs=L.attributes.ssrcs.concat(w),L.attributes.ssrcGroups=L.attributes.ssrcGroups.concat(N),{id:H,mslabel:j}}batchSend(S){return S.map(C=>{let{kind:R,ssrcMsg:w}=C;return this.send(R,w,void 0)})}stopSending(S){this.sessionDesc.mediaDescriptions.forEach(C=>{const R=[],w=[],N=[];C.attributes.ssrcs.forEach(L=>{xe(S).call(S,L.attributes.label||"")?N.push(L):R.push(L)}),C.attributes.ssrcGroups.forEach(L=>{var H;xe(H=N.map(j=>j.ssrcId)).call(H,L.ssrcIds[0])||w.push(L)}),C.attributes.ssrcs=R,C.attributes.ssrcGroups=w})}mute(S){const C=this.sessionDesc.mediaDescriptions.find(R=>R.attributes.mid===S);if(!C)throw new Error("mediaDescription not found with ".concat(S," in remote SDP when calling RemoteSDP.mute."));C.attributes.direction="inactive"}unmute(S){const C=this.sessionDesc.mediaDescriptions.find(R=>R.attributes.mid===S);if(!C)throw new Error("mediaDescription not found with ".concat(S," in remote SDP when calling RemoteSDP.unmute."));C.attributes.direction="sendonly"}receive(S,C,R){S.forEach((w,N)=>{const L=w._mediaStreamTrack,H=this.sessionDesc.mediaDescriptions.findIndex(W=>W.attributes.mid===L.kind),j=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[H],w);this.sessionDesc.mediaDescriptions[H]=j})}stopReceiving(S){}updateCandidates(S){S===Xn.TCP?this.candidates.forEach(C=>{this.candidates.findIndex(R=>R.transport==="tcp"&&R.connectionAddress===C.connectionAddress&&R.port===C.port)===-1&&this.candidates.push(_5(_5({},C),{},{foundation:"tcpcandidate",priority:Number(C.priority)-1+"",transport:"tcp",port:Number(C.port)+90+""}))}):this.candidates=this.candidates.filter(C=>C.transport!=="tcp");for(const C of this.sessionDesc.mediaDescriptions)C.attributes.candidates=this.candidates}restartICE(S){S=sn(S),this.iceParameters=S,this.sessionDesc.mediaDescriptions.forEach(C=>{C.attributes.iceUfrag=S.iceUfrag,C.attributes.icePwd=S.icePwd})}predictReceivingMids(S){const C=[];for(let R=0;R<S;R++)C.push((this.currentMidIndex+R+1).toString(10));return C}mungRecvMediaDsec(S,C){const R=sn(S);return pe(R,C),zt(R,C),R}updateRecvMedia(S,C){const R=this.sessionDesc.mediaDescriptions.findIndex(w=>w.attributes.mid===S);if(R!==-1){const w=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[R],C);this.sessionDesc.mediaDescriptions[R]=w}}bumpMid(S){this.currentMidIndex+=S}updateTrackLabel(S,C,R){const w=this.sessionDesc.mediaDescriptions.find(L=>S===gt.VIDEO?L.attributes.mid==="video":L.attributes.mid==="audio");if(w){const L=w.attributes.ssrcs.find(H=>H.attributes.label===C);var N;L&&(L.attributes.label=R,(N=L.attributes.msid)===null||N===void 0||N.replace(C,R))}}mungMediaDesc(S){const C=sn(S);return Ze(C),function(R){const w=R.attributes.extmaps.find(N=>N.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");w&&R.attributes.extmaps.splice(R.attributes.extmaps.indexOf(w),1),R.attributes.payloads.forEach(N=>{const L=N.rtcpFeedbacks.findIndex(H=>H.type==="transport-cc");L!==-1&&N.rtcpFeedbacks.splice(L,1)})}(C),C}getSSRC(S){for(const C of this.sessionDesc.mediaDescriptions)for(const R of C.attributes.ssrcs)if(R.attributes.label===S)return[R]}}({remoteIceParameters:e,remoteDtlsParameters:n,candidates:o,remoteRTPCapabilities:c.send,remoteSetup:u,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:m});const _=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(_){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(_.toString()))}}async updateRemoteRTPCapabilities(e,n){throw new ke(Q.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,n){var o=this;return Fo(function*(){const c=yield Qt(o.mutex.lock());try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const u=e.map(N=>o.peerConnection.addTrack(N._mediaStreamTrack)),m=yield Qt(o.peerConnection.createOffer()),_=U.parse(m.sdp),S=e.map(N=>{const L=N._mediaStreamTrack,H=_.mediaDescriptions.find(j=>j.attributes.mid===L.kind);if(!H)throw new Error("Cannot extract ssrc from mediaDescription.");return function(j,W,ee){const re=j.attributes.ssrcs.filter(be=>be.attributes.label===W),fe=j.attributes.ssrcGroups;if(re.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(fe&&re.length>1){const be=fe.find(_e=>_e.ssrcIds.indexOf(re[0].ssrcId)!==-1);return be?[{ssrcId:be.ssrcIds[0],rtx:ee?be.ssrcIds[1]:void 0}]:[{ssrcId:re[0].ssrcId}]}return[{ssrcId:re[0].ssrcId}]}(H,L.id,o.useRTX)});let C;try{C=yield S}catch(N){throw u.forEach(L=>{Jr()&&L.replaceTrack(null),o.peerConnection.removeTrack(L)}),N}const R=o.mungSendOfferSDP(m.sdp,e);o.remoteSDP.receive(e,n,C);const w=o.remoteSDP.toString();return yield Qt(o.peerConnection.setLocalDescription({type:"offer",sdp:R})),yield Qt(o.applySendEncodings(u,e)),yield Qt(o.peerConnection.setRemoteDescription({type:"answer",sdp:w})),e.map((N,L)=>{const H=N._mediaStreamTrack.id;return{localSSRC:S[L],id:H}})}catch(u){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(u.toString()))}finally{c()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter(u=>{var m;return e.indexOf(((m=u.track)===null||m===void 0?void 0:m.id)||"")!==-1});if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(u=>{Jr()&&u.replaceTrack(null),this.peerConnection.removeTrack(u)});const o=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(e,n,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:u,mslabel:m}=this.remoteSDP.send(e,n,c),_=new Ee((R,w)=>{const N=setTimeout(()=>{w(new Error("Cannot receive track, id: ".concat(u)))},1e4),L=H=>{const j=qt();if((j.name==="Safari"&&Number(j.version)===11||Ds())&&H.track.id!==u&&H.streams[0].id===m){var W;const ee=H.streams[0].getTracks()[0];return(W=this.remoteSDP)===null||W===void 0||W.updateTrackLabel(e,u,H.track.id),this.peerConnection.removeEventListener("track",L),clearTimeout(N),void R(ee)}if(H.track.id===u)return this.peerConnection.removeEventListener("track",L),clearTimeout(N),void R(H.track)};this.peerConnection.addEventListener("track",L)}),S=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:S});const C=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(C),{track:await _,id:u}}catch(u){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o)}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(o=>{var c;return e.indexOf(((c=o.track)===null||c===void 0?void 0:c.id)||"")!==-1});if(n.length!==e.length)throw new Error("sender' length doesn't match mids' length.");n.map(o=>{if(Jr()&&o.track)o.track.enabled=!1;else{const c=o.getParameters();c.encodings.forEach(u=>u.active=!1),o.setParameters(c)}})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(u=>{var m;return e.indexOf(((m=u.track)===null||m===void 0?void 0:m.id)||"")!==-1});if(n.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");n.map(async u=>{if(Jr()&&u.track)u.track.enabled=!0;else{const m=u.getParameters();m.encodings.forEach(_=>_.active=!0),await u.setParameters(m)}});const o=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(o);const c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Fo(function*(){const o=yield Qt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Dn().supportPCSetConfiguration){const S=n.peerConnection.getConfiguration(),C=e===Xn.RELAY?"relay":"all";S.iceTransportPolicy!==C&&(M.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(S.iceTransportPolicy,"] to [").concat(C,"]")),S.iceTransportPolicy=C,n.peerConnection.setConfiguration(S))}else if(e===Xn.RELAY)return;e!==Xn.RELAY&&n.remoteSDP.updateCandidates(e);const c=yield Qt(n.peerConnection.createOffer({iceRestart:!0}));if(!c.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const u=_n(c.sdp),{remoteIceParameters:m}=yield u.iceParameters;n.remoteSDP.restartICE(m);const _=n.remoteSDP.toString();yield Qt(n.peerConnection.setLocalDescription(c)),yield Qt(n.peerConnection.setRemoteDescription({type:"answer",sdp:_}))}catch(c){M.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),c)}finally{o()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const u=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new ke(Q.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,n){const o=this.peerConnection.getSenders().filter(c=>{var u;return((u=c.track)===null||u===void 0?void 0:u.id)===e});o.length===1&&await this.applySendEncodings(o,[n])}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const o=this.peerConnection.getSenders().find(c=>{var u;return((u=c.track)===null||u===void 0?void 0:u.id)===n});o&&await o.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,n){throw new ke(Q.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new ke(Q.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,M.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,M.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},oe("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Bi(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...As.turnServerConfigToIceServers(e.turnServer.servers)),oe("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...As.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(o=>{o.security?o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),n}async updateRtpSenderEncodings(e,n){var o;if(n||(n=this.peerConnection.getSenders().find(C=>{var R;return((R=C.track)===null||R===void 0?void 0:R.id)===e._mediaStreamTrack.id})),!n)return M.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!Dn().supportSetRtpSenderParameters)return M.warn("Browser not support set rtp-sender parameters");const c={},u={};if(e instanceof on)switch(e._optimizationMode){case"motion":c.degradationPreference="maintain-framerate";break;case"detail":c.degradationPreference="maintain-resolution";break;default:c.degradationPreference="balanced"}if(oe("DSCP_TYPE")&&bn()){var m;const C=oe("DSCP_TYPE");xe(m=["very-low","low","medium","high"]).call(m,C)&&(u.networkPriority=C)}const _=n.getParameters(),S=(o=_.encodings)===null||o===void 0?void 0:o[0];S&&Object.assign(S,u),Object.assign(_,c),M.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(_.encodings))),await n.setParameters(_)}async applySendEncodings(e,n){try{if(!Dn().supportSetRtpSenderParameters||e.length!==n.length)return;for(let o=0;o<e.length;o++){const c=e[o],u=n[o];c&&u&&await this.updateRtpSenderEncodings(u,c)}}catch{M.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n){const o=U.parse(e);return n.forEach((c,u)=>{const m=c._mediaStreamTrack,_=o.mediaDescriptions.find(S=>S.attributes.mid===m.kind);_&&pe(_,c)}),U.print(o)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,n,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(e).map((u,m)=>{let{id:_,mslabel:S}=u;const{kind:C}=e[m];return new Ee((R,w)=>{const N=setTimeout(()=>{w(new Error("Cannot receive track, id: ".concat(_)))},1e4),L=H=>{const j=qt();if(j.name==="Safari"&&Number(j.version)===11&&H.track.id!==_&&H.streams[0].id===S){var W;const ee=H.streams[0].getTracks()[0];return(W=this.remoteSDP)===null||W===void 0||W.updateTrackLabel(C,_,H.track.id),this.peerConnection.removeEventListener("track",L),clearTimeout(N),void R({track:ee,id:_})}if(H.track.id===_)return this.peerConnection.removeEventListener("track",L),clearTimeout(N),void R({track:H.track,id:_})};this.peerConnection.addEventListener("track",L)})}),o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const c=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(c),await Ee.all(n)}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n==null?void 0:n[0].ssrcId}setConfiguration(e){if(Dn().supportPCSetConfiguration){const n=As.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}}function Hd(r,e,n){const o=r[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const c=this.mutex,u=await c.lock("Locking from P2PConnection.".concat(e));try{for(var m=arguments.length,_=new Array(m),S=0;S<m;S++)_[S]=arguments[S];return await o.apply(this,_)}finally{u()}},n}function S5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function qf(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?S5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):S5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}Ge([Hd,z("design:type",Function),z("design:paramtypes",[Object,Object,Array,Object,String,String]),z("design:returntype",Ee)],As.prototype,"connect",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],As.prototype,"stopSending",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[String,Array,String,Object]),z("design:returntype",Ee)],As.prototype,"receive",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],As.prototype,"stopReceiving",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],As.prototype,"muteRemote",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],As.prototype,"unmuteRemote",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],As.prototype,"muteLocal",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],As.prototype,"unmuteLocal",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],As.prototype,"close",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],As.prototype,"updateEncoderConfig",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],As.prototype,"updateSendParameters",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[di,String]),z("design:returntype",Ee)],As.prototype,"replaceTrack",null),Ge([Hd,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],As.prototype,"getRemoteSSRC",null);const _0="9",T5=4e4;function C5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function hv(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?C5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):C5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class ur extends Od{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return xe(n=Object.keys(Ko)).call(n,e)}))]}constructor(e,n){super(e,n),D(this,"store",void 0),D(this,"peerConnection",void 0),D(this,"remoteSDP",void 0),D(this,"initialOffer",void 0),D(this,"transportEventReceiver",void 0),D(this,"statsFilter",void 0),D(this,"useXR",oe("USE_XR")),D(this,"localCapabilities",void 0),D(this,"remoteCodecs",void 0),D(this,"localCandidateCount",0),D(this,"allCandidatesReceived",!1),D(this,"dataStreamChannelMap",new Map),D(this,"establishPromise",void 0),D(this,"recoveredDataChannelIds",[]),D(this,"currentDataChannelId",1),D(this,"mutex",new Zr("P2PConnection-mutex")),this.store=n,this.peerConnection=new RTCPeerConnection(ur.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=He(this.peerConnection,oe("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void M.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}else M.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=_n(e.sdp),o=await Bd({filterRTX:!oe("USE_PUB_RTX")&&!oe("USE_SUB_RTX"),filterVideoFec:oe("FILTER_VIDEO_FEC"),filterAudioFec:oe("FILTER_AUDIO_FEC"),filterVideoCodec:oe("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=Ro(o),this.initialOffer=e,hv(hv({},n),{},{rtpCapabilities:o,offerSDP:e.sdp})}catch(e){throw new ke(Q.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,n,o,c,u,m){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return sn(this._localCapabilities)}get rtpCapabilities(){return sn(this._rtpCapabilities)}get candidates(){return sn(this._candidates)}get iceParameters(){return sn(this._iceParameters)}get dtlsParameters(){return sn(this._dtlsParameters)}constructor(L){D(this,"sessionDesc",void 0),D(this,"_localCapabilities",void 0),D(this,"_rtpCapabilities",void 0),D(this,"_candidates",void 0),D(this,"_iceParameters",void 0),D(this,"_dtlsParameters",void 0),D(this,"setup",void 0),D(this,"currentMidIndex",void 0),D(this,"cname",void 0),D(this,"firefoxSsrcMidMap",new Map),L=sn(L);const{remoteIceParameters:H,remoteDtlsParameters:j,candidates:W,remoteRTPCapabilities:ee,remoteSetup:re,localCapabilities:fe,cname:be}=L,_e=U.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=ee,this._candidates=W,this._iceParameters=H,this._dtlsParameters=j,this._localCapabilities=fe,this.setup=re,this.cname=be;const ye=this.rtpCapabilities.send;for(const Le of _e.mediaDescriptions){if(Le.attributes.iceUfrag=H.iceUfrag,Le.attributes.icePwd=H.icePwd,Le.attributes.fingerprints=j.fingerprints,Le.attributes.candidates=W,Le.attributes.setup=re,Le.media.mediaType==="video"&&(Le.media.fmts=ye.videoCodecs.map(Me=>Me.payloadType.toString(10)),Le.attributes.payloads=ye.videoCodecs,Le.attributes.extmaps=ye.videoExtensions,oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:Me,ssrcGroups:et}=ie([{ssrcId:T5,rtx:oe("USE_SUB_RTX")?40001:void 0}],this.cname);Le.attributes.ssrcs=Me,Le.attributes.ssrcGroups=et}if(Le.media.mediaType==="audio"&&(Le.media.fmts=ye.audioCodecs.map(Me=>Me.payloadType.toString(10)),Le.attributes.payloads=ye.audioCodecs,Le.attributes.extmaps=ye.audioExtensions,yo(Le),oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:Me,ssrcGroups:et}=ie([{ssrcId:2e4}],this.cname);Le.attributes.ssrcs=Me,Le.attributes.ssrcGroups=et}}this.sessionDesc=_e,this.currentMidIndex=_e.mediaDescriptions.length-1}preloadRemoteMedia(){const L=oe("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const H=this.candidates,j=this.dtlsParameters,W=this.iceParameters,ee=this.rtpCapabilities.send;for(let re=1;re<L;re++){const fe=2*re+2e4,be=2*re+T5,{ssrcs:_e,ssrcGroups:ye}=ie([{ssrcId:fe}],this.cname),{ssrcs:Le,ssrcGroups:Me}=ie([{ssrcId:be,rtx:oe("USE_SUB_RTX")?be+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:_0,protos:["UDP","TLS","RTP","SAVPF"],fmts:ee.videoCodecs.map(et=>et.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:W.iceUfrag,icePwd:W.icePwd,unrecognized:[],candidates:H,extmaps:ee.videoExtensions,fingerprints:j.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:Le,ssrcGroups:Me,rtcpFeedbackWildcards:[],payloads:ee.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*re)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:_0,protos:["UDP","TLS","RTP","SAVPF"],fmts:ee.audioCodecs.map(et=>et.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:W.iceUfrag,icePwd:W.icePwd,unrecognized:[],candidates:H,extmaps:ee.audioExtensions,fingerprints:j.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:_e,ssrcGroups:ye,rtcpFeedbackWildcards:[],payloads:ee.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*re+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return U.print(this.sessionDesc)}send(L,H,j,W){const{ssrcs:ee,ssrcGroups:re}=ie(H,this.cname,oe("SYNC_GROUP")?j:void 0),fe=this.findPreloadMediaDesc(ee);if(fe){if(Ln()&&this.firefoxSsrcMidMap.set(ee[0].ssrcId,fe.attributes.mid),W&&(W.twcc||W.remb)){const be=this.sessionDesc.mediaDescriptions.indexOf(fe);return this.sessionDesc.mediaDescriptions[be]=this.mungSendMediaDesc(fe,W),{mid:fe.attributes.mid,needExchangeSDP:!0}}return{mid:fe.attributes.mid,needExchangeSDP:!1}}{const be=this.findAvailableMediaIndex(L,ee);let _e;return be===-1||be===1&&(Jr()||jA())||be===0&&oe("USE_SUB_RTX")||Ql()?(_e=this.createOrRecycleSendMedia(L,ee,re,"sendonly",W),this.updateBundleMids()):(_e=sn(this.sessionDesc.mediaDescriptions[be]),_e.attributes.direction="sendonly",_e.attributes.ssrcs=ee,_e.attributes.ssrcGroups=re,this.sessionDesc.mediaDescriptions[be]=this.mungSendMediaDesc(_e,W)),Ln()&&this.firefoxSsrcMidMap.set(ee[0].ssrcId,_e.attributes.mid),{mid:_e.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:L,needExchangeSDP:H}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:L.attributes.mid,needExchangeSDP:H}}batchSend(L){const H=L.map(ee=>{let{kind:re,ssrcMsg:fe,mslabel:be}=ee;return this.send(re,fe,be)}),j=[];let W=!1;return H.forEach(ee=>{let{mid:re,needExchangeSDP:fe}=ee;fe&&(W=!0),j.push(re)}),{mids:j,needExchangeSDP:W}}stopSending(L){const H=this.sessionDesc.mediaDescriptions.filter(j=>j.attributes.mid&&L.indexOf(j.attributes.mid)!==-1);if(H.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");H.forEach(j=>{j.attributes.mid==="0"||Ln()||Ql()?j.attributes.ssrcs=[]:(j.attributes.ssrcs=[],j.attributes.direction="inactive",j.media.port="0")}),this.updateBundleMids()}mute(L){const H=this.sessionDesc.mediaDescriptions.find(j=>j.attributes.mid===L);if(!H)throw new Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.mute."));H.attributes.direction="inactive"}unmute(L){const H=this.sessionDesc.mediaDescriptions.find(j=>j.attributes.mid===L);if(!H)throw new Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.unmute."));H.attributes.direction="sendonly"}muteRemote(L){const H=this.sessionDesc.mediaDescriptions.filter(j=>xe(L).call(L,j.attributes.mid||""));if(H.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");H.forEach(j=>{j.attributes.direction="inactive"})}unmuteRemote(L){const H=this.sessionDesc.mediaDescriptions.filter(j=>xe(L).call(L,j.attributes.mid||""));if(H.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");H.forEach(j=>{j.attributes.direction="recvonly"})}receive(L,H,j,W){L.forEach((ee,re)=>{this.createOrRecycleRecvMedia(ee,[],"recvonly",H,j,W[re])}),this.updateBundleMids()}stopReceiving(L){const H=this.sessionDesc.mediaDescriptions.filter(j=>L.indexOf(j.attributes.mid)!==-1);if(H.length!==L.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");H.forEach(j=>{j.media.port="0",j.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(L){const H=this._candidates.filter(j=>j.transport==="udp");if(L===Xn.TCP){if(H.length===0)return;if(oe("TCP_CANDIDATE_ONLY")){const j=this._candidates.filter(W=>W.transport==="tcp");H.forEach(W=>{j.findIndex(ee=>ee.connectionAddress===W.connectionAddress)===-1&&j.push(qf(qf({},W),{},{foundation:"tcpcandidate",priority:Number(W.priority)-1+"",transport:"tcp",port:Number(W.port)+90+""}))}),this._candidates=j}else{const j=[];H.forEach(W=>{j.push(qf(qf({},W),{},{foundation:"tcpcandidate",priority:Number(W.priority)-1+"",transport:"tcp",port:Number(W.port)+90+""}))}),this._candidates=[...H,...j]}}else if(L===Xn.RELAY){if(H.length!==0)return;{const j=this._candidates.filter(W=>W.transport==="tcp");j.forEach(W=>{H.push(qf(qf({},W),{},{foundation:"udpcandidate",priority:Number(W.priority)+1+"",transport:"udp",port:Number(W.port)-90+""}))}),this._candidates=[...H,...j]}}else H.length===0?(this._candidates.filter(j=>j.transport==="tcp").forEach(j=>{H.push(qf(qf({},j),{},{foundation:"udpcandidate",priority:Number(j.priority)+1+"",transport:"udp",port:Number(j.port)-90+""}))}),this._candidates=H):this._candidates=this._candidates.filter(j=>j.transport!=="tcp");for(const j of this.sessionDesc.mediaDescriptions)j.attributes.candidates=this.candidates}restartICE(L){L=sn(L),this._iceParameters=L,this.sessionDesc.mediaDescriptions.forEach(H=>{H.attributes.iceUfrag=L.iceUfrag,H.attributes.icePwd=L.icePwd})}predictReceivingMids(L){const H=[];for(let j=0;j<L;j++)H.push((this.currentMidIndex+j+1).toString(10));return H}findAvailableMediaIndex(L,H){return this.sessionDesc.mediaDescriptions.findIndex(j=>{const W=j.media.mediaType===L&&j.media.port!=="0"&&(j.attributes.direction==="sendonly"||j.attributes.direction==="sendrecv")&&j.attributes.ssrcs.length===0;if(Ln()){if(W){const ee=this.firefoxSsrcMidMap.get(H[0].ssrcId);return!(ee||j.attributes.mid!=="0"&&j.attributes.mid!=="1")||!(!ee||ee!==j.attributes.mid)}return!1}return W})}createOrRecycleDataChannel(){for(const j of this.sessionDesc.mediaDescriptions)if(j.media.mediaType==="application")return{mediaDesc:j,needExchangeSDP:!1};this.currentMidIndex+=1;const L="".concat(this.currentMidIndex),H={media:{mediaType:"application",port:_0,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(L),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(H),{mediaDesc:H,needExchangeSDP:!0}}createOrRecycleRecvMedia(L,H,j,W,ee,re){const fe=L._mediaStreamTrack.kind,be=this.rtpCapabilities.recv,_e=vi(fe,be,this.localCapabilities.send,fe===gt.VIDEO?W:ee),ye=fe===gt.VIDEO?be.videoExtensions:be.audioExtensions;this.currentMidIndex+=1;const Le="".concat(this.currentMidIndex);let Me={media:{mediaType:fe,port:_0,protos:["UDP","TLS","RTP","SAVPF"],fmts:_e.map(at=>at.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:ye,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:H,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:_e,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:j,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(Le)}};Me=this.mungRecvMediaDsec(Me,L,re);const et=this.findFirstClosedMedia(fe);if(et){const at=this.sessionDesc.mediaDescriptions.indexOf(et);this.sessionDesc.mediaDescriptions[at]=Me}else this.sessionDesc.mediaDescriptions.push(Me);return Me}updateRemoteCodec(L,H,j){const W=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(Me=>Me.rtpMap&&Me.rtpMap.encodingName.toLowerCase()||"").filter(Me=>{var et;return xe(et=Object.keys(Ko)).call(et,Me)}))],ee=new Set(H);if(W.every(Me=>ee.has(Me)))return M.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(H)),!1;const re=this._rtpCapabilities.recv.videoCodecs.filter(Me=>H.some(et=>{var at;return xe(at=Me.rtpMap&&Me.rtpMap.encodingName.toLowerCase()||"").call(at,et)}));if(re.length===0)return M.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(W," codecs: ").concat(H)),!1;const fe=[...new Set(re.map(Me=>Me.rtpMap&&Me.rtpMap.encodingName.toLowerCase()||""))];let be;if(M.debug("updateRemoteCodec, from ".concat(W," to ").concat(fe)),L.length===0)be=this.sessionDesc.mediaDescriptions.filter(Me=>Me.media.mediaType==="video"&&Me.attributes.direction==="recvonly");else if(be=this.sessionDesc.mediaDescriptions.filter(Me=>Me.attributes.mid&&xe(L).call(L,Me.attributes.mid)&&Me.attributes.direction==="recvonly"),be.length!==L.length)return M.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(L,", codecs: ").concat(H)),!1;this._rtpCapabilities.recv.videoCodecs=re;const _e=this.localCapabilities.send,ye=this.rtpCapabilities.recv,Le=vi(gt.VIDEO,ye,_e,j);return be.forEach(Me=>{const et=Le.map(at=>at.payloadType.toString(10));M.debug("updateRemoteCodec mid: ".concat(Me.attributes.mid,", from ").concat(Me.attributes.payloads," to ").concat(Le)),Me.attributes.payloads=Le,Me.media.fmts=et}),!0}createOrRecycleSendMedia(L,H,j,W,ee){const re=this.rtpCapabilities.send,fe=L===gt.VIDEO?re.videoCodecs:re.audioCodecs,be=L===gt.VIDEO?re.videoExtensions:re.audioExtensions;this.currentMidIndex+=1;const _e="".concat(this.currentMidIndex);let ye={media:{mediaType:L,port:_0,protos:["UDP","TLS","RTP","SAVPF"],fmts:fe.map(Me=>Me.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:be,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:H,ssrcGroups:j,rtcpFeedbackWildcards:[],payloads:fe,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:W,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(_e)}};ye=this.mungSendMediaDesc(ye,ee);const Le=this.findFirstClosedMedia(L);if(Le){const Me=this.sessionDesc.mediaDescriptions.indexOf(Le);this.sessionDesc.mediaDescriptions[Me]=ye}else this.sessionDesc.mediaDescriptions.push(ye);return ye}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(L=>L.media.port!=="0").map(L=>L.attributes.mid)}mungRecvMediaDsec(L,H,j){const W=sn(L);return Ze(W),pe(W,H),zt(W,H),Ei(W),Mr(W,j,this.localCapabilities.send),W}mungSendMediaDesc(L,H){const j=sn(L);return Mr(j,H,this.localCapabilities.recv),yo(j),j}updateRecvMedia(L,H){const j=this.sessionDesc.mediaDescriptions.findIndex(W=>W.attributes.mid===L);if(j!==-1){const W=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[j],H);this.sessionDesc.mediaDescriptions[j]=W}}bumpMid(L){this.currentMidIndex+=L}findFirstClosedMedia(L){return this.sessionDesc.mediaDescriptions.find(H=>Ln()?H.media.port==="0"&&H.media.mediaType===L:H.media.port==="0")}findPreloadMediaDesc(L){return this.sessionDesc.mediaDescriptions.find(H=>{var j;return((j=H.attributes)===null||j===void 0||(j=j.ssrcs[0])===null||j===void 0?void 0:j.ssrcId)===L[0].ssrcId})}getSSRC(L){var H;return(H=this.sessionDesc.mediaDescriptions.find(j=>j.attributes.mid===L))===null||H===void 0?void 0:H.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:n,candidates:o,remoteRTPCapabilities:c,remoteSetup:u,localCapabilities:this.localCapabilities,cname:m}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const _=this.remoteSDP.toString(),S=U.parse(this.initialOffer.sdp),C=S.mediaDescriptions.find(L=>L.media.mediaType==="audio");C&&yo(C),this.useXR&&wl(S);const R=U.print(S),w=this.logSDPExchange(R||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:R}),w==null||w(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_});const N=this.peerConnection.getTransceivers()[0];if(N!=null&&N.receiver&&this.tryBindTransportEvents(N.receiver),oe("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const L=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:L});const H=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(H)}}catch(_){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(_.toString()))}}send(e,n,o){var c=this;return Fo(function*(){const u=yield Qt(c.mutex.lock("From P2PConnection.send"));try{if(!c.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const m=[];e.forEach(j=>{const W=c.peerConnection.addTransceiver(j._mediaStreamTrack,{direction:"sendonly"});m.push(W),j._updateRtpTransceiver(W)}),Ln()&&oe("SIMULCAST")===!0&&(yield Qt(c.applySimulcastForFirefox(m,e)));const _=yield Qt(c.peerConnection.createOffer()),S=c.remoteSDP.predictReceivingMids(e.length),C=c.mungSendOfferSDP(_.sdp,e,S),R=U.parse(C),w=S.map(j=>{const W=R.mediaDescriptions.find(ee=>ee.attributes.mid===j);if(!W)throw new Error("Cannot extract ssrc from mediaDescription.");return ot(W,oe("USE_PUB_RTX"))});let N;try{N=yield w}catch(j){N=[],c.remoteSDP.receive(e,n,o,N);const W=c.remoteSDP.toString();throw yield Qt(c.peerConnection.setLocalDescription({type:"offer",sdp:C})),yield Qt(c.peerConnection.setRemoteDescription({type:"answer",sdp:W})),yield Qt(c.stopSending(S,!0)),j}c.remoteSDP.receive(e,n,o,N);const L=c.remoteSDP.toString(),H=c.logSDPExchange(C,"offer","local","send");return yield Qt(c.peerConnection.setLocalDescription({type:"offer",sdp:C})),yield Qt(c.applySimulcastEncodings(m,e)),yield Qt(c.applySendEncodings(m,e)),H==null||H(L),yield Qt(c.peerConnection.setRemoteDescription({type:"answer",sdp:L})),m.map((j,W)=>{const ee=S[W];return{localSSRC:w[W],id:ee,transceiver:j}})}catch(m){throw m instanceof ke?m:new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(m.toString()))}finally{u()}})()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let o=this.dataStreamChannelMap.get(e);if(o&&o.readyState==="open")M.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const u=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof u!="number")throw new Error("create DataChannel error, because cannot get dc id");o=this.peerConnection.createDataChannel("datastream-channel",{id:u,negotiated:!0,ordered:!1,maxRetransmits:oe("DATASTREAM_MAX_RETRANSMITS")}),o.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,o)}n.forEach(u=>{u._updateOriginDataChannel(o)});const{needExchangeSDP:c}=this.remoteSDP.sendDataChannel();if(c){const u=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:u});const m=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(m),M.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else M.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(o){throw o instanceof ke?o:new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(o.toString()))}}async stopDataChannels(e){try{const n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof ke?n:new ke(Q.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){const o=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const c=this.peerConnection.getTransceivers().filter(S=>e.indexOf(S.mid)!==-1);if(c.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");c.map(S=>{var C;S.direction="inactive",(C=S.stop)===null||C===void 0||C.call(S)});const u=await this.peerConnection.createOffer(),m=this.logSDPExchange(u.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(u),this.remoteSDP.stopReceiving(e);const _=this.remoteSDP.toString();m==null||m(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(c){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(c.toString()))}finally{o&&o()}}async receive(e,n,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:m}=this.remoteSDP.send(e,n,o,c);if(m){const S=this.remoteSDP.toString(),C=this.logSDPExchange(S,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:S});const R=await this.peerConnection.createAnswer(),w=this.mungReceiveAnswerSDP(R.sdp,u,e);C==null||C(w||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:w}),M.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else M.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const _=this.peerConnection.getTransceivers().find(S=>S.mid===u);if(!_)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:_.receiver.track,id:u,transceiver:_}}catch(u){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(u.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:o}=this.remoteSDP.batchSend(e);if(o){const c=this.remoteSDP.toString(),u=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const m=await this.peerConnection.createAnswer();u==null||u(m.sdp||""),await this.peerConnection.setLocalDescription(m),M.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else M.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return n.map(c=>{const u=this.peerConnection.getTransceivers().find(m=>m.mid===c);if(!u)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:u.receiver.track,id:c,transceiver:u}})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(m=>m.mid&&e.indexOf(m.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(m=>{m.direction="inactive"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.muteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(m=>m.mid&&e.indexOf(m.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(m,_)=>{m.direction="sendonly"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.unmuteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(n){throw new ke(Q.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Fo(function*(){const o=yield Qt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Dn().supportPCSetConfiguration){const C=n.peerConnection.getConfiguration(),R=e===Xn.RELAY?"relay":"all";C.iceTransportPolicy!==R&&(M.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(C.iceTransportPolicy,"] to [").concat(R,"]")),C.iceTransportPolicy=R,n.peerConnection.setConfiguration(C))}else if(e===Xn.RELAY)return;n.remoteSDP.updateCandidates(e);const c=yield Qt(n.peerConnection.createOffer({iceRestart:!0}));if(!c.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const u=_n(c.sdp),{remoteIceParameters:m}=yield u.iceParameters;n.remoteSDP.restartICE(m);const _=n.remoteSDP.toString(),S=n.logSDPExchange(c.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield Qt(n.peerConnection.setLocalDescription(c)),S==null||S(_),yield Qt(n.peerConnection.setRemoteDescription({type:"answer",sdp:_}))}catch(c){M.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),c)}finally{o()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const u=this.remoteSDP.toString(),m=this.logSDPExchange(c,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),m==null||m(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new ke(Q.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,n){const o=this.peerConnection.getTransceivers().filter(c=>c.mid===e);o.length===1&&(this.isVP8Simulcast(n)?Ln()||await this.applySimulcastEncodings(o,[n]):await this.applySendEncodings(o,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const o=this.peerConnection.getTransceivers().find(c=>c.mid===n);o&&await o.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:o,remote:c}=n.getSelectedCandidatePair();return{local:hv(hv({},te),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port}),remote:hv(hv({},te),{},{candidateType:c.type,protocol:c.protocol,address:c.address,port:c.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,M.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,M.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},oe("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Bi(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...ur.turnServerConfigToIceServers(e.turnServer.servers)),oe("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...ur.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),oe("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(n.iceTransportPolicy="relay")}))),oe("ENABLE_ENCODED_TRANSFORM")&&Dn().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(o=>{o.security?o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(_h(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&!oe("FORCE_TURN_TCP")&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),n}tryBindTransportEvents(e){const n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var c;n!=null&&n.state&&((c=this.onDTLSTransportStateChange)===null||c===void 0||c.call(this,n.state))},n.onerror=c=>{var u;(u=this.onDTLSTransportError)===null||u===void 0||u.call(this,"error"in c?c.error:c)};const o=n.iceTransport;o&&(o.onstatechange=()=>{const c=n==null?void 0:n.iceTransport.state;var u;c&&((u=this.onICETransportStateChange)===null||u===void 0||u.call(this,c))},o.getSelectedCandidatePair&&(o.onselectedcandidatepairchange=()=>{if(o.getSelectedCandidatePair()){const{local:c,remote:u}=o.getSelectedCandidatePair();M.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:c.type,protocol:c.protocol}),", remote ").concat(JSON.stringify({candidateType:u.type,protocol:u.protocol,address:u.address,port:u.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var o;if(n||(n=this.peerConnection.getSenders().find(R=>R.track===e._mediaStreamTrack)),!n)return M.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return M.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Dn().supportSetRtpSenderParameters)return M.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const c={},u={};switch(e._optimizationMode){case"motion":c.degradationPreference="maintain-framerate";break;case"detail":c.degradationPreference="maintain-resolution";break;default:c.degradationPreference="balanced"}if(e._encoderConfig){var m;const{bitrateMax:R,frameRate:w,scaleResolutionDownBy:N}=e._encoderConfig;R&&(u.maxBitrate=1e3*R),(xe(m=e._hints).call(m,hi.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(w&&(u.maxFramerate=Yo(w)),N&&N>=1&&(u.scaleResolutionDownBy=N))}if(oe("DSCP_TYPE")&&bn()){var _;const R=oe("DSCP_TYPE");xe(_=["very-low","low","medium","high"]).call(_,R)&&(u.networkPriority=R)}const S=n.getParameters(),C=(o=S.encodings)===null||o===void 0?void 0:o[0];Ln()&&!C&&(c.encodings=[u]),C&&Object.assign(C,u),Object.assign(S,c),M.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(S.encodings))),await n.setParameters(S)}async applySendEncodings(e,n){try{if(!Dn().supportSetRtpSenderParameters||e.length!==n.length)return;for(let o=0;o<e.length;o++){const c=e[o],u=n[o];u instanceof on&&!this.isVP8Simulcast(u)&&await this.updateRtpSenderEncodings(u,c.sender)}}catch{M.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,o){const c=U.parse(e);return n.forEach((u,m)=>{const _=o[m],S=c.mediaDescriptions.find(C=>C.attributes.mid===_);S&&(pe(S,u),jo(S,u,this.store.codec))}),U.print(c)}mungReceiveAnswerSDP(e,n,o){const c=U.parse(e),u=c.mediaDescriptions.find(m=>m.attributes.mid===n);return u&&(o===gt.AUDIO&&u.media.mediaType==="audio"&&yo(u),this.useXR&&wl(c)),U.print(c)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,n,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let S=0;S<e.length;S++){var o,c,u,m,_;const C=e[S],R=n[S];if(R instanceof on&&!xe(o=R._hints).call(o,hi.LOW_STREAM)&&(c=R._encoderConfig)!==null&&c!==void 0&&c.bitrateMax&&((u=R._encoderConfig)===null||u===void 0?void 0:u.bitrateMax)>200&&(m=R._scalabilityMode)!==null&&m!==void 0&&m.numSpatialLayers&&((_=R._scalabilityMode)===null||_===void 0?void 0:_.numSpatialLayers)>1&&this.store.codec==="vp8"){const w={},N={high:1e3*(R._encoderConfig.bitrateMax-50),medium:5e4};w.encodings=[{rid:"m",active:!0,maxBitrate:N.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:N.high}];const L=C.sender.getParameters();await C.sender.setParameters(Object.assign(L,w))}}}async applySimulcastEncodings(e,n){if(!Ln()&&e.length===n.length)for(let o=0;o<e.length;o++){const c=n[o];if(c instanceof on&&this.isVP8Simulcast(c)){const u=e[o],m={},_={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:_.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:_.medium,scaleResolutionDownBy:4}];const S=u.sender.getParameters();await u.sender.setParameters(Object.assign(S,m))}}}isVP8Simulcast(e){var n,o,c,u,m;return!!(e instanceof on&&oe("SIMULCAST")&&this.store.codec==="vp8"&&!xe(n=e._hints).call(n,hi.LOW_STREAM)&&(o=e._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((c=e._encoderConfig)===null||c===void 0?void 0:c.bitrateMax)>200&&(u=e._scalabilityMode)!==null&&u!==void 0&&u.numSpatialLayers&&((m=e._scalabilityMode)===null||m===void 0?void 0:m.numSpatialLayers)>1)}logSDPExchange(e,n,o,c){if(oe("SDP_LOGGING"))return M.upload("[".concat(this.store.clientId,"] exchanging ").concat(o," ").concat(n," SDP during P2PConnection.").concat(c,`
`),e),n==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n==null?void 0:n[0].ssrcId}setConfiguration(e){if(Dn().supportPCSetConfiguration){const n=ur.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}}function Ac(r,e,n){const o=r[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const c=this.mutex,u=await c.lock("From P2PConnection.".concat(e));try{for(var m=arguments.length,_=new Array(m),S=0;S<m;S++)_[S]=arguments[S];return await o.apply(this,_)}finally{u()}},n}function v5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function R5(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?v5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):v5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}Ge([Ac,z("design:type",Function),z("design:paramtypes",[Array,Array]),z("design:returntype",Ee)],ur.prototype,"updateRemoteRTPCapabilities",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[Object,Object,Array,Object,String,String]),z("design:returntype",Ee)],ur.prototype,"connect",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[Object,Array]),z("design:returntype",Ee)],ur.prototype,"createDataChannels",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[String,Array,String,Object]),z("design:returntype",Ee)],ur.prototype,"receive",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ur.prototype,"batchReceive",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ur.prototype,"stopReceiving",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],ur.prototype,"muteRemote",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],ur.prototype,"unmuteRemote",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ur.prototype,"muteLocal",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ur.prototype,"unmuteLocal",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],ur.prototype,"close",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],ur.prototype,"updateEncoderConfig",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],ur.prototype,"updateSendParameters",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[di,String]),z("design:returntype",Ee)],ur.prototype,"replaceTrack",null),Ge([Ac,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],ur.prototype,"getRemoteSSRC",null);const y5=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,eL="9",J3=2e4,X3=4e4;class tz{get localCapabilities(){return sn(this._localCapabilities)}get rtpCapabilities(){return sn(this._rtpCapabilities)}get candidates(){return sn(this._candidates)}get iceParameters(){return sn(this._iceParameters)}get dtlsParameters(){return sn(this._dtlsParameters)}constructor(e){D(this,"sessionDesc",void 0),D(this,"_localCapabilities",void 0),D(this,"_rtpCapabilities",void 0),D(this,"_candidates",void 0),D(this,"_iceParameters",void 0),D(this,"_dtlsParameters",void 0),D(this,"setup",void 0),D(this,"currentMidIndex",void 0),D(this,"cname",void 0),D(this,"firefoxSsrcMidMap",new Map),e=sn(e);const{remoteIceParameters:n,remoteDtlsParameters:o,candidates:c,remoteRTPCapabilities:u,remoteSetup:m,localCapabilities:_,cname:S}=e,C=U.parse(y5);this._rtpCapabilities=u,this._candidates=c,this._iceParameters=n,this._dtlsParameters=o,this._localCapabilities=_,this.setup=m,this.cname=S;const R=this.rtpCapabilities.send;for(const w of C.mediaDescriptions){if(w.attributes.iceUfrag=n.iceUfrag,w.attributes.icePwd=n.icePwd,w.attributes.fingerprints=o.fingerprints,w.attributes.candidates=c,w.attributes.setup=m,w.media.mediaType==="application"&&(w.attributes.sctpPort="5000"),w.media.mediaType==="video"&&(w.media.fmts=R.videoCodecs.map(N=>N.payloadType.toString(10)),w.attributes.payloads=R.videoCodecs,w.attributes.extmaps=R.videoExtensions,oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:N,ssrcGroups:L}=ie([{ssrcId:X3,rtx:oe("USE_SUB_RTX")?40001:void 0}],this.cname);w.attributes.ssrcs=N,w.attributes.ssrcGroups=L}if(w.media.mediaType==="audio"&&(w.media.fmts=R.audioCodecs.map(N=>N.payloadType.toString(10)),w.attributes.payloads=R.audioCodecs,w.attributes.extmaps=R.audioExtensions,yo(w),oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:N,ssrcGroups:L}=ie([{ssrcId:J3}],this.cname);w.attributes.ssrcs=N,w.attributes.ssrcGroups=L}}this.sessionDesc=C,this.currentMidIndex=C.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const n=U.parse(y5);this._rtpCapabilities=e;const o=this.rtpCapabilities.send;for(const c of n.mediaDescriptions){if(c.attributes.iceUfrag=this._iceParameters.iceUfrag,c.attributes.icePwd=this._iceParameters.icePwd,c.attributes.fingerprints=this._dtlsParameters.fingerprints,c.attributes.candidates=this._candidates,c.attributes.setup=this.setup,c.media.mediaType==="application"&&(c.attributes.sctpPort="5000"),c.media.mediaType==="video"&&(c.media.fmts=o.videoCodecs.map(u=>u.payloadType.toString(10)),c.attributes.payloads=o.videoCodecs,c.attributes.extmaps=o.videoExtensions,oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:u,ssrcGroups:m}=ie([{ssrcId:X3,rtx:oe("USE_SUB_RTX")?40001:void 0}],this.cname);c.attributes.ssrcs=u,c.attributes.ssrcGroups=m}if(c.media.mediaType==="audio"&&(c.media.fmts=o.audioCodecs.map(u=>u.payloadType.toString(10)),c.attributes.payloads=o.audioCodecs,c.attributes.extmaps=o.audioExtensions,oe("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:u,ssrcGroups:m}=ie([{ssrcId:J3}],this.cname);c.attributes.ssrcs=u,c.attributes.ssrcGroups=m}}this.sessionDesc=n,this.currentMidIndex=n.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const n=this.candidates,o=this.dtlsParameters,c=this.iceParameters,u=this.rtpCapabilities.send;for(let m=1;m<e;m++){const _=2*m+J3,S=2*m+X3,{ssrcs:C,ssrcGroups:R}=ie([{ssrcId:_}],this.cname),{ssrcs:w,ssrcGroups:N}=ie([{ssrcId:S,rtx:oe("USE_SUB_RTX")?S+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:eL,protos:["UDP","TLS","RTP","SAVPF"],fmts:u.videoCodecs.map(L=>L.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:c.iceUfrag,icePwd:c.icePwd,unrecognized:[],candidates:n,extmaps:u.videoExtensions,fingerprints:o.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:w,ssrcGroups:N,rtcpFeedbackWildcards:[],payloads:u.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*m-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:eL,protos:["UDP","TLS","RTP","SAVPF"],fmts:u.audioCodecs.map(L=>L.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:c.iceUfrag,icePwd:c.icePwd,unrecognized:[],candidates:n,extmaps:u.audioExtensions,fingerprints:o.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:C,ssrcGroups:R,rtcpFeedbackWildcards:[],payloads:u.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*m)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return U.print(this.sessionDesc)}send(e,n,o,c){const{ssrcs:u,ssrcGroups:m}=ie(n,this.cname,oe("SYNC_GROUP")?o:void 0),_=this.findPreloadMediaDesc(u);if(_){if(Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,_.attributes.mid),c&&(c.twcc||c.remb)){const S=this.sessionDesc.mediaDescriptions.indexOf(_);return this.sessionDesc.mediaDescriptions[S]=this.mungSendMediaDesc(_,c),{mid:_.attributes.mid,needExchangeSDP:!0}}return{mid:_.attributes.mid,needExchangeSDP:!1}}{const S=this.findAvailableMediaIndex(e,u);let C;return S===-1||Jr()||Ds()||jA()||S===0&&oe("USE_SUB_RTX")?(C=this.createOrRecycleSendMedia(e,u,m,"sendonly",c),this.updateBundleMids()):(C=sn(this.sessionDesc.mediaDescriptions[S]),C.attributes.direction="sendonly",C.attributes.ssrcs=u,C.attributes.ssrcGroups=m,this.sessionDesc.mediaDescriptions[S]=this.mungSendMediaDesc(C,c)),Ln()&&this.firefoxSsrcMidMap.set(u[0].ssrcId,C.attributes.mid),{mid:C.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const n=e.map(u=>{let{kind:m,ssrcMsg:_,mslabel:S}=u;return this.send(m,_,S)}),o=[];let c=!1;return n.forEach(u=>{let{mid:m,needExchangeSDP:_}=u;_&&(c=!0),o.push(m)}),{mids:o,needExchangeSDP:c}}stopSending(e){const n=this.sessionDesc.mediaDescriptions.filter(o=>o.attributes.mid&&e.indexOf(o.attributes.mid)!==-1);if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");n.forEach(o=>{o.attributes.mid==="0"||Ln()||Jr()||Ds()?o.attributes.ssrcs=[]:(o.attributes.ssrcs=[],o.attributes.direction="inactive",o.media.port="0")}),this.updateBundleMids()}mute(e){const n=this.sessionDesc.mediaDescriptions.find(o=>o.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(e){const n=this.sessionDesc.mediaDescriptions.find(o=>o.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}muteRemote(e){const n=this.sessionDesc.mediaDescriptions.filter(o=>xe(e).call(e,o.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(o=>{o.attributes.direction="inactive"})}unmuteRemote(e){const n=this.sessionDesc.mediaDescriptions.filter(o=>xe(e).call(e,o.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(o=>{o.attributes.direction="recvonly"})}receive(e,n,o,c){e.forEach((u,m)=>{this.createOrRecycleRecvMedia(u,[],"recvonly",n,o,c[m])}),this.updateBundleMids()}stopReceiving(e){const n=this.sessionDesc.mediaDescriptions.filter(o=>e.indexOf(o.attributes.mid)!==-1);if(n.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");n.forEach(o=>{o.media.port="0",o.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(e){e===Xn.TCP?this._candidates.forEach(n=>{this._candidates.findIndex(o=>o.transport==="tcp"&&o.connectionAddress===n.connectionAddress&&o.port===n.port)===-1&&this._candidates.push(R5(R5({},n),{},{foundation:"tcpcandidate",priority:Number(n.priority)-1+"",transport:"tcp",port:Number(n.port)+90+""}))}):this._candidates=this._candidates.filter(n=>n.transport!=="tcp");for(const n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates}restartICE(e){e=sn(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=e.iceUfrag,n.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const n=[];for(let o=0;o<e;o++)n.push((this.currentMidIndex+o+1).toString(10));return n}findAvailableMediaIndex(e,n){return this.sessionDesc.mediaDescriptions.findIndex(o=>{const c=o.media.mediaType===e&&o.media.port!=="0"&&(o.attributes.direction==="sendonly"||o.attributes.direction==="sendrecv")&&o.attributes.ssrcs.length===0;if(Ln()){if(c){const u=this.firefoxSsrcMidMap.get(n[0].ssrcId);return!(u||o.attributes.mid!=="0"&&o.attributes.mid!=="1")||!(!u||u!==o.attributes.mid)}return!1}return c})}createOrRecycleRecvMedia(e,n,o,c,u,m){const _=e._mediaStreamTrack.kind,S=this.rtpCapabilities.recv,C=vi(_,S,this.localCapabilities.send,_===gt.VIDEO?c:u),R=_===gt.VIDEO?S.videoExtensions:S.audioExtensions;this.currentMidIndex+=1;const w="".concat(this.currentMidIndex);let N={media:{mediaType:_,port:eL,protos:["UDP","TLS","RTP","SAVPF"],fmts:C.map(H=>H.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:R,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:C,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:o,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(w)}};N=this.mungRecvMediaDsec(N,e,m);const L=this.findFirstClosedMedia(_);if(L){const H=this.sessionDesc.mediaDescriptions.indexOf(L);this.sessionDesc.mediaDescriptions[H]=N}else this.sessionDesc.mediaDescriptions.push(N);return N}updateRemoteCodec(e,n,o){const c=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(N=>N.rtpMap&&N.rtpMap.encodingName.toLowerCase()||"").filter(N=>{var L;return xe(L=Object.keys(Ko)).call(L,N)}))],u=new Set(n);if(c.every(N=>u.has(N)))return M.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(n)),!1;const m=this._rtpCapabilities.recv.videoCodecs.filter(N=>n.some(L=>{var H;return xe(H=N.rtpMap&&N.rtpMap.encodingName.toLowerCase()||"").call(H,L)}));if(m.length===0)return M.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(c," codecs: ").concat(n)),!1;const _=[...new Set(m.map(N=>N.rtpMap&&N.rtpMap.encodingName.toLowerCase()||""))];let S;if(M.debug("updateRemoteCodec, from ".concat(c," to ").concat(_)),e.length===0)S=this.sessionDesc.mediaDescriptions.filter(N=>N.media.mediaType==="video"&&N.attributes.direction==="recvonly");else if(S=this.sessionDesc.mediaDescriptions.filter(N=>N.attributes.mid&&xe(e).call(e,N.attributes.mid)&&N.attributes.direction==="recvonly"),S.length!==e.length)return M.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(n)),!1;this._rtpCapabilities.recv.videoCodecs=m;const C=this.localCapabilities.send,R=this.rtpCapabilities.recv,w=vi(gt.VIDEO,R,C,o);return S.forEach(N=>{const L=w.map(H=>H.payloadType.toString(10));M.debug("updateRemoteCodec mid: ".concat(N.attributes.mid,", from ").concat(N.attributes.payloads," to ").concat(w)),N.attributes.payloads=w,N.media.fmts=L}),!0}createOrRecycleSendMedia(e,n,o,c,u){const m=this.rtpCapabilities.send,_=e===gt.VIDEO?m.videoCodecs:m.audioCodecs,S=e===gt.VIDEO?m.videoExtensions:m.audioExtensions;this.currentMidIndex+=1;const C="".concat(this.currentMidIndex);let R={media:{mediaType:e,port:eL,protos:["UDP","TLS","RTP","SAVPF"],fmts:_.map(N=>N.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:S,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:o,rtcpFeedbackWildcards:[],payloads:_,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:c,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(C)}};R=this.mungSendMediaDesc(R,u);const w=this.findFirstClosedMedia(e);if(w){const N=this.sessionDesc.mediaDescriptions.indexOf(w);this.sessionDesc.mediaDescriptions[N]=R}else this.sessionDesc.mediaDescriptions.push(R);return R}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,n,o){const c=sn(e);return Ze(c),pe(c,n),zt(c,n),Ei(c),Mr(c,o,this.localCapabilities.send),c}mungSendMediaDesc(e,n){const o=sn(e);return Mr(o,n,this.localCapabilities.recv),yo(o),o}updateRecvMedia(e,n){const o=this.sessionDesc.mediaDescriptions.findIndex(c=>c.attributes.mid===e);if(o!==-1){const c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[o],n);this.sessionDesc.mediaDescriptions[o]=c}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(n=>Ln()?n.media.port==="0"&&n.media.mediaType===e:n.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(n=>{var o;return((o=n.attributes)===null||o===void 0||(o=o.ssrcs[0])===null||o===void 0?void 0:o.ssrcId)===e[0].ssrcId})}getSSRC(e){var n;return(n=this.sessionDesc.mediaDescriptions.find(o=>o.attributes.mid===e))===null||n===void 0?void 0:n.attributes.ssrcs}}function I5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function tL(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?I5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):I5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}class lo extends Od{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=Ro(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map(n=>n.rtpMap&&n.rtpMap.encodingName.toLowerCase()||"").filter(n=>{var o;return xe(o=Object.keys(Ko)).call(o,n)}))]}constructor(e,n,o){super(e,n),D(this,"store",void 0),D(this,"peerConnection",void 0),D(this,"remoteSDP",void 0),D(this,"initialOffer",void 0),D(this,"transportEventReceiver",void 0),D(this,"statsFilter",void 0),D(this,"useXR",oe("USE_XR")),D(this,"localCapabilities",void 0),D(this,"localCandidateCount",0),D(this,"allCandidatesReceived",!1),D(this,"remoteCodecs",void 0),D(this,"dataStreamChannelMap",new Map),D(this,"establishPromise",void 0),D(this,"mutex",new Zr("NVExtentionsConnection-mutex")),D(this,"rtcMedia",void 0),this.store=n,this.peerConnection=o,this.statsFilter=He(this.peerConnection,oe("STATS_UPDATE_INTERVAL"),void 0,Ln()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const o=_n(n.sdp),c=await Bd({filterRTX:!oe("USE_PUB_RTX")&&!oe("USE_SUB_RTX"),filterVideoFec:oe("FILTER_VIDEO_FEC"),filterAudioFec:oe("FILTER_AUDIO_FEC"),filterVideoCodec:oe("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=c,this.initialOffer=n,tL(tL({},o),{},{rtpCapabilities:c,offerSDP:n.sdp})}catch(n){throw new Te(Q.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e,n,o,c,u,m){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new tz({remoteIceParameters:e,remoteDtlsParameters:n,candidates:o,remoteRTPCapabilities:c,remoteSetup:u,localCapabilities:Ro(this.localCapabilities),cname:m});const _=this.remoteSDP.toString(),S=U.parse(this.initialOffer.sdp),C=S.mediaDescriptions.find(N=>N.media.mediaType==="audio");C&&yo(C),this.useXR&&wl(S);const R=U.print(S),w=this.logSDPExchange(R||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:R}),w==null||w(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(_){throw new Te(Q.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(_.toString()))}}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void M.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}else M.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(e){var n,o,c,u;(n=this.remoteSDP)===null||n===void 0||n.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((u=this.remoteSDP)===null||u===void 0||u.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(o=this.remoteSDP)===null||o===void 0||o.preloadRemoteMedia(2);const m=(c=this.remoteSDP)===null||c===void 0?void 0:c.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:m});const _=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(_),M.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,n,o){var c=this;return Fo(function*(){const u=yield Qt(c.mutex.lock("From NVExtentionsConnection.send"));try{if(!c.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const m=[];e.forEach(j=>{const W=c.peerConnection.addTransceiver(j._mediaStreamTrack,{direction:"sendonly"});m.push(W)}),Ln()&&oe("SIMULCAST")===!0&&(yield Qt(c.applySimulcastForFirefox(m,e)));const _=yield Qt(c.peerConnection.createOffer()),S=c.remoteSDP.predictReceivingMids(e.length),C=c.mungSendOfferSDP(_.sdp,e,S),R=U.parse(C),w=S.map(j=>{const W=R.mediaDescriptions.find(ee=>ee.attributes.mid===j);if(!W)throw new Error("Cannot extract ssrc from mediaDescription.");return ot(W,oe("USE_PUB_RTX"))});let N;try{N=yield w}catch(j){N=[],c.remoteSDP.receive(e,n,o,N);const W=c.remoteSDP.toString();throw yield Qt(c.peerConnection.setLocalDescription({type:"offer",sdp:C})),yield Qt(c.peerConnection.setRemoteDescription({type:"answer",sdp:W})),yield Qt(c.stopSending(S,!0)),j}c.remoteSDP.receive(e,n,o,N);const L=c.remoteSDP.toString(),H=c.logSDPExchange(C,"offer","local","send");return yield Qt(c.peerConnection.setLocalDescription({type:"offer",sdp:C})),yield Qt(c.applySimulcastEncodings(m,e)),yield Qt(c.applySendEncodings(m,e)),H==null||H(L),yield Qt(c.peerConnection.setRemoteDescription({type:"answer",sdp:L})),m.map((j,W)=>{const ee=S[W];return{localSSRC:w[W],id:ee,transceiver:j}})}catch(m){throw m instanceof Te?m:new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(m.toString()))}finally{u()}})()}async stopSending(e,n){const o=n?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const c=this.peerConnection.getTransceivers().filter(S=>e.indexOf(S.mid)!==-1);if(c.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");c.map(S=>{var C;S.direction="inactive",(C=S.stop)===null||C===void 0||C.call(S)});const u=await this.peerConnection.createOffer(),m=this.logSDPExchange(u.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(u),this.remoteSDP.stopReceiving(e);const _=this.remoteSDP.toString();m==null||m(_),await this.peerConnection.setRemoteDescription({type:"answer",sdp:_})}catch(c){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(c.toString()))}finally{o&&o()}}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let o=this.dataStreamChannelMap.get(e);return o&&o.readyState==="open"?M.debug("[P2PConnection] Channels are already available and can be reused directly."):(o=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:oe("DATASTREAM_MAX_RETRANSMITS")}),o.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,o)),void n.forEach(c=>{c._updateOriginDataChannel(o)})}catch(o){throw o instanceof Te?o:new Te(Q.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(o.toString()))}}async stopDataChannels(e){try{const n=this.dataStreamChannelMap.get(e);return n==null||n.close(),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof Te?n:new Te(Q.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(n.toString()))}}async receive(e,n,o,c){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:u,needExchangeSDP:m}=this.remoteSDP.send(e,n,o,c);if(m){const S=this.remoteSDP.toString(),C=this.logSDPExchange(S,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:S});const R=await this.peerConnection.createAnswer(),w=this.mungReceiveAnswerSDP(R.sdp,u,e);C==null||C(w||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:w}),M.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else M.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const _=this.peerConnection.getTransceivers().find(S=>S.mid===u);if(!_)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:_.receiver.track,id:u}}catch(u){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(u.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:o}=this.remoteSDP.batchSend(e);if(o){const c=this.remoteSDP.toString(),u=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const m=await this.peerConnection.createAnswer();u==null||u(m.sdp||""),await this.peerConnection.setLocalDescription(m),M.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else M.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return n.map(c=>{const u=this.peerConnection.getTransceivers().find(m=>m.mid===c);if(!u)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:u.receiver.track,id:c}})}catch(n){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(n){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(n){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const c=await this.peerConnection.createAnswer();o==null||o(c.sdp||""),await this.peerConnection.setLocalDescription(c)}catch(n){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(m=>m.mid&&e.indexOf(m.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(m=>{m.direction="inactive"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.muteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(n){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(m=>m.mid&&e.indexOf(m.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(m,_)=>{m.direction="sendonly"});const o=await this.peerConnection.createOffer(),c=this.logSDPExchange(o.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(o),this.remoteSDP.unmuteRemote(e);const u=this.remoteSDP.toString();c==null||c(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(n){throw new Te(Q.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Fo(function*(){const o=yield Qt(n.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Dn().supportPCSetConfiguration){const C=n.peerConnection.getConfiguration(),R=e===Xn.RELAY?"relay":"all";C.iceTransportPolicy!==R&&(M.debug("restartICE change iceTransportPolicy from [".concat(C.iceTransportPolicy,"] to [").concat(R,"]")),C.iceTransportPolicy=R,n.peerConnection.setConfiguration(C))}else if(e===Xn.RELAY)return;e!==Xn.RELAY&&n.remoteSDP.updateCandidates(e);const c=yield Qt(n.peerConnection.createOffer({iceRestart:!0}));if(!c.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const u=_n(c.sdp),{remoteIceParameters:m}=yield u.iceParameters;n.remoteSDP.restartICE(m);const _=n.remoteSDP.toString(),S=n.logSDPExchange(c.sdp||"","offer","local","restartICE");yield Qt(n.peerConnection.setLocalDescription(c)),S==null||S(_),yield Qt(n.peerConnection.setRemoteDescription({type:"answer",sdp:_}))}catch(c){M.warning("restart ICE failed, abort operation",c)}finally{o()}})()}close(){var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const o=await this.peerConnection.createOffer(),c=this.mungSendOfferSDP(o.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const u=this.remoteSDP.toString(),m=this.logSDPExchange(c,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:c}),m==null||m(u),await this.peerConnection.setRemoteDescription({type:"answer",sdp:u})}catch(o){throw new Te(Q.EXCHANGE_SDP_FAILED,o.toString())}}async updateSendParameters(e,n){const o=this.peerConnection.getTransceivers().filter(c=>c.mid===e);o.length===1&&(this.isVP8Simulcast(n)?Ln()||await this.applySimulcastEncodings(o,[n]):await this.applySendEncodings(o,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const o=this.peerConnection.getTransceivers().find(c=>c.mid===n);o&&await o.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if((e=this.peerConnection.currentLocalDescription)===null||e===void 0||!e.sdp||!this.localCapabilities)throw new Error;return tL(tL({},_n(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,M.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,M.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},oe("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Bi(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...lo.turnServerConfigToIceServers(e.turnServer.servers)),oe("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...lo.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),oe("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(o=>{o.security?o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(_h(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&!oe("FORCE_TURN_TCP")&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),n}async applySendEncodings(e,n){try{if(!Dn().supportSetRtpSenderParameters||e.length!==n.length)return;for(let w=0;w<e.length;w++){const N=e[w],L=n[w];if(L&&L instanceof on){var o,c,u;if(this.isVP8Simulcast(L))continue;const H={},j={};switch(L._optimizationMode){case"motion":H.degradationPreference="maintain-framerate";break;case"detail":H.degradationPreference="maintain-resolution";break;default:H.degradationPreference="balanced"}var m,_,S,C;if((o=L._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&(j.maxBitrate=1e3*((m=L._encoderConfig)===null||m===void 0?void 0:m.bitrateMax)),xe(c=L._hints).call(c,hi.LOW_STREAM)&&((_=L._encoderConfig)!==null&&_!==void 0&&_.frameRate&&(j.maxFramerate=Yo(L._encoderConfig.frameRate)),(S=L._encoderConfig)!==null&&S!==void 0&&S.scaleResolutionDownBy&&((C=L._encoderConfig)===null||C===void 0?void 0:C.scaleResolutionDownBy)>1&&(j.scaleResolutionDownBy=L._encoderConfig.scaleResolutionDownBy)),oe("DSCP_TYPE")&&bn()){var R;const re=oe("DSCP_TYPE");xe(R=["very-low","low","medium","high"]).call(R,re)&&(j.networkPriority=re)}const W=N.sender.getParameters(),ee=(u=W.encodings)===null||u===void 0?void 0:u[0];Ln()&&!ee&&(H.encodings=[j]),ee&&Object.assign(ee,j),Object.assign(W,H),await N.sender.setParameters(W)}}}catch{M.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,n,o){const c=U.parse(e);return n.forEach((u,m)=>{const _=o[m],S=c.mediaDescriptions.find(C=>C.attributes.mid===_);S&&(pe(S,u),jo(S,u,this.store.codec))}),U.print(c)}mungReceiveAnswerSDP(e,n,o){const c=U.parse(e),u=c.mediaDescriptions.find(m=>m.attributes.mid===n);return u&&o===gt.AUDIO&&u.media.mediaType==="audio"&&yo(u),this.useXR&&wl(c),U.print(c)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,o)=>{var c;(c=this.onFirstVideoDecoded)===null||c===void 0||c.call(this,e,n,o)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var o;(o=this.onSelectedLocalCandidateChanged)===null||o===void 0||o.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var o;(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0||o.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let S=0;S<e.length;S++){var o,c,u,m,_;const C=e[S],R=n[S];if(R instanceof on&&!xe(o=R._hints).call(o,hi.LOW_STREAM)&&(c=R._encoderConfig)!==null&&c!==void 0&&c.bitrateMax&&((u=R._encoderConfig)===null||u===void 0?void 0:u.bitrateMax)>200&&(m=R._scalabilityMode)!==null&&m!==void 0&&m.numSpatialLayers&&((_=R._scalabilityMode)===null||_===void 0?void 0:_.numSpatialLayers)>1&&this.store.codec==="vp8"){const w={},N={high:1e3*(R._encoderConfig.bitrateMax-50),medium:5e4};w.encodings=[{rid:"m",active:!0,maxBitrate:N.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:N.high}];const L=C.sender.getParameters();await C.sender.setParameters(Object.assign(L,w))}}}async applySimulcastEncodings(e,n){if(!Ln()&&e.length===n.length)for(let o=0;o<e.length;o++){const c=n[o];if(c instanceof on&&this.isVP8Simulcast(c)){const u=e[o],m={},_={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:_.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:_.medium,scaleResolutionDownBy:4}];const S=u.sender.getParameters();await u.sender.setParameters(Object.assign(S,m))}}}isVP8Simulcast(e){var n,o,c,u,m;return!!(e instanceof on&&oe("SIMULCAST")&&this.store.codec==="vp8"&&!xe(n=e._hints).call(n,hi.LOW_STREAM)&&(o=e._encoderConfig)!==null&&o!==void 0&&o.bitrateMax&&((c=e._encoderConfig)===null||c===void 0?void 0:c.bitrateMax)>200&&(u=e._scalabilityMode)!==null&&u!==void 0&&u.numSpatialLayers&&((m=e._scalabilityMode)===null||m===void 0?void 0:m.numSpatialLayers)>1)}logSDPExchange(e,n,o,c){if(oe("SDP_LOGGING"))return M.upload("exchanging ".concat(o," ").concat(n," SDP during NVExtentionsConnection.").concat(c,`
`),e),n==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n==null?void 0:n[0].ssrcId}setConfiguration(e){if(Dn().supportPCSetConfiguration){const n=lo.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}}function Wa(r,e,n){const o=r[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const c=this.mutex,u=await c.lock("From NVExtentionsConnection.".concat(e));try{for(var m=arguments.length,_=new Array(m),S=0;S<m;S++)_[S]=arguments[S];return await o.apply(this,_)}finally{u()}},n}function A5(r){var e,n,o,c=2;for(typeof Symbol<"u"&&(n=m5,o=Symbol.iterator);c--;){if(n&&(e=r[n])!=null)return e.call(r);if(o&&(e=r[o])!=null)return new nL(e.call(r));n="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function nL(r){function e(n){if(Object(n)!==n)return Ee.reject(new TypeError(n+" is not an object."));var o=n.done;return Ee.resolve(n.value).then(function(c){return{value:c,done:o}})}return nL=function(n){this.s=n,this.n=n.next},nL.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var o=this.s.return;return o===void 0?Ee.resolve({value:n,done:!0}):e(o.apply(this.s,arguments))},throw:function(n){var o=this.s.return;return o===void 0?Ee.reject(n):e(o.apply(this.s,arguments))}},new nL(r)}Ge([Wa,z("design:type",Function),z("design:paramtypes",[Object,Object,Array,Object,String,String]),z("design:returntype",Ee)],lo.prototype,"connect",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[Array,Array]),z("design:returntype",Ee)],lo.prototype,"updateRemoteRTPCapabilities",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],lo.prototype,"updateRemoteConnect",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[Object,Array]),z("design:returntype",Ee)],lo.prototype,"createDataChannels",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[String,Array,String,Object]),z("design:returntype",Ee)],lo.prototype,"receive",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],lo.prototype,"batchReceive",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],lo.prototype,"stopReceiving",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],lo.prototype,"muteRemote",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],lo.prototype,"unmuteRemote",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],lo.prototype,"muteLocal",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],lo.prototype,"unmuteLocal",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],lo.prototype,"close",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],lo.prototype,"updateEncoderConfig",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],lo.prototype,"updateSendParameters",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[di,String]),z("design:returntype",Ee)],lo.prototype,"replaceTrack",null),Ge([Wa,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],lo.prototype,"getRemoteSSRC",null);class is extends Od{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,n){super(e,n),D(this,"store",void 0),D(this,"peerConnection",void 0),D(this,"cname",void 0),D(this,"mutex",new Zr("DataChannelConnection-mutex")),D(this,"dataChannel",void 0),D(this,"_p2pConnection",void 0),D(this,"establishPromise",void 0),D(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(is.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new lo(e,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const n=(e=this._nvMedia)===null||e===void 0?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(n)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,n,o,c,u,m){return this.cname=m,await this._p2pConnection.connect(e,n,o,c,u,m),await new Ee((_,S)=>{const C=setTimeout(()=>{this.closeSignal(),S(new Te(Q.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(o))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(C),void _()},this.dataChannel.onerror=R=>{this.closeSignal(),S(R)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,n){return this._p2pConnection.updateRemoteRTPCapabilities(e,n)}send(e,n,o){var c=this;return Fo(function*(){const u=yield Qt(c.mutex.lock("From DataChannelConnection.send"));try{return yield*$k(A5(c._p2pConnection.send(e,n,o)))}finally{u()}})()}async stopSending(e,n){return this._p2pConnection.stopSending(e,n)}async createDataChannels(e,n){return this._p2pConnection.createDataChannels(e,n)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,n,o,c){return this._nvMedia?(M.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,n,this.cname)):(M.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,n,o,c))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var n=this;return Fo(function*(){return yield*$k(A5(n._p2pConnection.restartICE(e)))})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var n;(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,n){return await this._p2pConnection.updateEncoderConfig(e,n)}async updateSendParameters(e,n){return await this._p2pConnection.updateSendParameters(e,n)}setStatsRemoteVideoIsReady(e,n){this._p2pConnection.setStatsRemoteVideoIsReady(e,n)}async replaceTrack(e,n){return await this._p2pConnection.replaceTrack(e,n)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,n,o,c){if(oe("SDP_LOGGING"))return M.upload("exchanging ".concat(o," ").concat(n," SDP during DataChannelConnection.").concat(c,`
`),e),n==="offer"?u=>{this.logSDPExchange(u,"answer",o==="local"?"remote":"local",c)}:void 0}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Bi(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...is.turnServerConfigToIceServers(e.turnServer.servers)),oe("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...is.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),oe("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(o=>{o.security?o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(_h(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}):(o.udpport&&!oe("FORCE_TURN_TCP")&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.udpport,"?transport=udp")}),o.tcpport&&n.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=tcp")}))}),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,n,o)=>{var c;return(c=this.onFirstVideoDecoded)===null||c===void 0?void 0:c.call(this,e,n,o)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,n)=>{var o;return(o=this.onSelectedLocalCandidateChanged)===null||o===void 0?void 0:o.call(this,e,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,n)=>{var o;return(o=this.onSelectedRemoteCandidateChanged)===null||o===void 0?void 0:o.call(this,e,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}function ad(r,e,n){const o=r[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const c=this.mutex,u=await c.lock("From DataChannelConnection.".concat(e));try{for(var m=arguments.length,_=new Array(m),S=0;S<m;S++)_[S]=arguments[S];return await o.apply(this,_)}finally{u()}},n}function w5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function Jf(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?w5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):w5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}function b5(r){var e,n,o,c=2;for(typeof Symbol<"u"&&(n=m5,o=Symbol.iterator);c--;){if(n&&(e=r[n])!=null)return e.call(r);if(o&&(e=r[o])!=null)return new iL(e.call(r));n="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function iL(r){function e(n){if(Object(n)!==n)return Ee.reject(new TypeError(n+" is not an object."));var o=n.done;return Ee.resolve(n.value).then(function(c){return{value:c,done:o}})}return iL=function(n){this.s=n,this.n=n.next},iL.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var o=this.s.return;return o===void 0?Ee.resolve({value:n,done:!0}):e(o.apply(this.s,arguments))},throw:function(n){var o=this.s.return;return o===void 0?Ee.reject(n):e(o.apply(this.s,arguments))}},new iL(r)}Ge([ad,z("design:type",Function),z("design:paramtypes",[Object,Object,Array,Object,String,String]),z("design:returntype",Ee)],is.prototype,"connect",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[Array,Array]),z("design:returntype",Ee)],is.prototype,"updateRemoteRTPCapabilities",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[Object,Array]),z("design:returntype",Ee)],is.prototype,"createDataChannels",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[String,Array,String,Object]),z("design:returntype",Ee)],is.prototype,"receive",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],is.prototype,"stopReceiving",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],is.prototype,"muteRemote",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],is.prototype,"unmuteRemote",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],is.prototype,"muteLocal",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],is.prototype,"unmuteLocal",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],is.prototype,"close",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],is.prototype,"updateEncoderConfig",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[String,di]),z("design:returntype",Ee)],is.prototype,"updateSendParameters",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[di,String]),z("design:returntype",Ee)],is.prototype,"replaceTrack",null),Ge([ad,z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],is.prototype,"getRemoteSSRC",null);class ws extends Dt{get state(){return this._state}set state(e){const n=this._state;this._state=e,this.emit(We.StateChange,n,this._state)}constructor(e,n){super(),D(this,"store",void 0),D(this,"statsUploader",void 0),D(this,"connection",void 0),D(this,"localTrackMap",new Map),D(this,"remoteUserMap",new Map),D(this,"localDataChannels",[]),D(this,"remoteDataChannelMap",new Map),D(this,"pendingLocalTracks",[]),D(this,"pendingRemoteTracks",[]),D(this,"pendingLocalDataChannels",[]),D(this,"pendingRemoteDataChannels",[]),D(this,"statsCollector",void 0),D(this,"isPlanB",!1),D(this,"shouldForwardP2PCreation",void 0),D(this,"iceFailedCount",0),D(this,"dtlsFailedCount",0),D(this,"mutex",new Zr("P2PChannel-mutex")),D(this,"_state",kn.Disconnected),D(this,"_pcStatsUploadType",oe("NEW_ICE_RESTART")?Ua.FIRST_CONNECTION:Ua.OLD_FIRST_CONNECTION),D(this,"_isInRestartIce",!1),D(this,"_isStartRestartIce",!1),D(this,"_restartStates",["disconnected","failed"]),D(this,"_restartTimer",void 0),D(this,"_isFirstConnected",!0),D(this,"handleMuteLocalTrack",async(o,c,u)=>{const m=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==kn.Connected)return void u(new ke(Q.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const _=this.filterTobeMutedTracks(o);if(_.length===0)return void c();const S=_.find(R=>R[0]==="videoLowTrack");S&&S[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(_.map(R=>{let[,{id:w}]=R;return w}));const C=this.createMuteMessage(_);await Mn(this,We.RequestMuteLocal,C),c()}catch(_){u(_)}finally{m()}}),D(this,"handleUnmuteLocalTrack",async(o,c,u)=>{const m=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==kn.Connected)return void u(new ke(Q.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const _=this.filterTobeUnmutedTracks(o);if(_.length===0)return void c();const S=_.find(R=>R[0]==="videoLowTrack");if(S){const R=S[1];if(R.track._originMediaStreamTrack.stop(),!oe("DISABLE_DUAL_STREAM_USE_ENCODING")&&Dn().supportDualStreamEncoding){const w=o._mediaStreamTrack.clone();R.track._mediaStreamTrack=w,R.track._originMediaStreamTrack=w}else{const w=Io(o,Gn(this,We.RequestLowStreamParameter));R.track._mediaStreamTrack=w,R.track._originMediaStreamTrack=w}await new Ee((w,N)=>{this.handleReplaceTrack(R.track,w,N,!0)})}await this.connection.unmuteLocal(_.map(R=>{let[,{id:w}]=R;return w}));const C=this.createUnmuteMessage(_);await Mn(this,We.RequestUnmuteLocal,C),c()}catch(_){u(_)}finally{m()}}),D(this,"handleUpdateVideoEncoder",async(o,c,u)=>{const m=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const _=this.localTrackMap.get(Je.LocalVideoTrack);if(!this.connection||!_||_.track!==o||this.state!==kn.Connected)return void c();const{id:S,track:C}=_;await this.connection.updateSendParameters(S,C),await this.connection.updateEncoderConfig(S,C),this.emit(We.UpdateVideoEncoder,C),c()}catch(_){u(_)}finally{m()}}),D(this,"handleSetOptimizationMode",async(o,c,u)=>{const m=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const _=this.localTrackMap.get(Je.LocalVideoTrack);if(!this.connection||!_||_.track!==o||this.state!==kn.Connected)return;const{id:S,track:C}=_;await this.connection.updateSendParameters(S,C),c()}catch(_){u(_)}finally{m()}}),D(this,"handleReplaceMixingTrack",async(o,c,u,m)=>{if(!this.connection||this.state!==kn.Connected)return void c();const _=q3([o]);let S;M.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(_.getTrackId(),"]")),typeof m=="boolean"&&m||(S=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(o,_),c()}catch(R){u(R)}finally{var C;(C=S)===null||C===void 0||C()}}),D(this,"handleReplaceTrack",async(o,c,u,m)=>{let _;M.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(o.getTrackId(),"]")),typeof m=="boolean"&&m||(_=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var S;const R=Array.from(this.localTrackMap.entries()).find(w=>{let[,{track:N}]=w;return o===N});if(!this.connection||!R||this.state!==kn.Connected)return void c();if(await((S=this.connection)===null||S===void 0?void 0:S.replaceTrack(o,R[1].id)),this.isPlanB){const w=R[1];w.id=o._mediaStreamTrack.id,this.localTrackMap.set(R[0],w)}if(R[0]===Je.LocalVideoTrack&&!oe("DISABLE_DUAL_STREAM_USE_ENCODING")&&Dn().supportDualStreamEncoding){const w=this.localTrackMap.get(Je.LocalVideoLowTrack);if(w){const N=o._mediaStreamTrack.clone();w.track._originMediaStreamTrack.stop(),w.track._mediaStreamTrack=N,w.track._originMediaStreamTrack=N,await new Ee((L,H)=>{this.handleReplaceTrack(w.track,L,H,!0)})}}c()}catch(R){u(R)}finally{var C;(C=_)===null||C===void 0||C()}}),D(this,"handleGetRTCStats",o=>{o(this.statsCollector.getRTCStats())}),D(this,"handleGetLocalVideoStats",o=>{o(this.statsCollector.getLocalVideoTrackStats())}),D(this,"handleGetLocalAudioStats",o=>{o(this.statsCollector.getLocalAudioTrackStats())}),D(this,"handleGetRemoteVideoStats",o=>this.statsCollector.getRemoteVideoTrackStats(o.uid)[o.uid]),D(this,"handleGetRemoteAudioStats",o=>this.statsCollector.getRemoteAudioTrackStats(o.uid)[o.uid]),this.store=e,this.statsCollector=n,this.statsCollector.addP2PChannel(this),this.statsUploader=new c5(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!Dn().supportUnifiedPlan||oe("CHROME_FORCE_PLAN_B")&&bn(),this.shouldForwardP2PCreation=oe("FORWARD_P2P_CREATION")&&Dn().supportPCSetConfiguration&&function(){const o=Hn();return o===ar.ANDROID||o===ar.IOS||o===ar.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new is({},this.store):this.isPlanB?new As({},this.store):new ur({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,n){var o;this.state=kn.New;const c=this.shouldForwardP2PCreation&&((o=this.connection)===null||o===void 0?void 0:o.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!c||(c&&this.connection&&(M.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new is(e,this.store):this.isPlanB?new As(e,this.store):new ur(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new ke(Q.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=oe("NEW_ICE_RESTART")?Ua.FIRST_CONNECTION:Ua.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,n,o,c,u,m){if(!this.connection)throw new ke(Q.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof is?this.connection.updateRemoteConnect(c):(this.store.peerConnectionStart(),await this.connection.connect(e,n,o,c,u,m),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kn.Connected)}updateRemoteRTPCapabilities(e){const n=Array.from(this.localTrackMap.entries()).filter(u=>{var m;let[_]=u;return xe(m=[Je.LocalVideoLowTrack,Je.LocalVideoTrack]).call(m,_)}),o=n.map(u=>{let[,{id:m}]=u;return m}),c=n.map(u=>{let[m]=u;return m});if(this.connection instanceof ur){if(vt.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(c),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!xe(e).call(e,this.store.codec)){const u=["vp8","h264"].find(m=>xe(e).call(e,m));u&&(this.store.codec=u,M.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(u,".")))}this.connection.updateRemoteRTPCapabilities(o,e)}}async preConnect(e,n,o,c,u,m){if(!this.connection)throw new ke(Q.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const _=await this.connection.connect(e,n,o,c,u,m);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kn.Connected,_}getEstablishParams(){if(this.connection instanceof is)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection||this.state!==kn.Connected){if(this.state===kn.Disconnected)throw new ke(Q.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void e.forEach(o=>{var c;xe(c=this.pendingLocalDataChannels).call(c,o)||this.pendingLocalDataChannels.push(o)})}const n=this.filterTobePublishedDataChannels(e);n.length!==0&&(n.forEach(o=>{const c=Date.now();this.store.publish(o.id.toString(),"datachannel",c)}),await this.connection.createDataChannels(this.store.uid,n),n.forEach(o=>{this.localDataChannels.push(o);const c=Date.now();this.store.publish(o.id+"","datachannel",void 0,c)}))}publish(e,n,o){var c=this;return Fo(function*(){const u=yield Qt(c.mutex.lock("From P2PChannel.publish"));try{if(!c.connection||c.state!==kn.Connected){if(c.state===kn.Disconnected)throw new ke(Q.UNEXPECTED_ERROR,"PeerConnection already disconnected.");c.throwIfTrackTypeNotMatch(e);const _=e.filter(S=>c.pendingLocalTracks.indexOf(S)===-1);return void(c.pendingLocalTracks=c.pendingLocalTracks.concat(_))}c.store.pubId=c.store.pubId+1,Us.markPublishStart(c.store.clientId,c.store.pubId);const m=c.filterTobePublishedTracks(e,n,o);if(m.length===0)return void(yield Qt(c.tryToUnmuteAudio(e)));yield*$k(b5(c.doPublish(c.connection,m)))}finally{u()}})()}doPublish(e,n){var o=this;return Fo(function*(){n.forEach(N=>{let{track:L,type:H}=N;const j=Date.now();o.store.publish(L.getTrackId(),H===Je.LocalAudioTrack?"audio":"video",j)}),o.bindLocalTrackEvents(n);const c=n.map(N=>{let{track:L}=N;return L}),u=yield Qt(e.send(n.map(N=>{let{track:L}=N;return L}),o.store.codec,o.store.audioCodec)),m=(yield Qt(u.next())).value,_=o.createGatewayPublishMessage(n,m);let S;try{S=yield _}catch(N){throw u.throw(N),(N==null?void 0:N.code)===Q.WS_ABORT&&n.forEach(L=>{let{track:H}=L;o.pendingLocalTracks.indexOf(H)===-1&&o.pendingLocalTracks.push(H)}),o.unbindLocalTrackEvents(n),N}const C=o.mapPubResToRemoteConfig(_,S),R=(yield Qt(u.next(C))).value,w=oe("ENABLE_VIDEO_SEI");c.forEach(async N=>{const L=N.getRTCRtpTransceiver();L&&w&&(N.trackMediaType===gt.VIDEO?await async function(H,j){if(!Dn().supportWebRTCEncodedTransform)return void M.warning("browser not support video encoded transform");if(Kf.has(H)||!H.track)return;const W={track:H.track};if(tl()){if(!H.createEncodedStreams)return void M.warning("browser not support createEncodedStreams() API");let re=null;try{re=H.createEncodedStreams()}catch(_e){return void M.error("create video-encoded-streams error",_e&&_e.message)}let fe=[];j.on("sei-to-send",_e=>{fe.push(_e)});const be=new TransformStream({transform(_e,ye){W.controller||(W.controller=ye),H.track&&H.track.id!==W.track.id&&(M.debug("video track changed: ".concat(W.track.id," => ").concat(H.track.id)),W.track.removeEventListener("ended",ee),W.track=H.track,W.track.addEventListener("ended",ee));const Le=fe.shift();Le&&(_e.data=W3(_e.data,Le)),ye.enqueue(_e)}});re.readable.pipeThrough(be).pipeTo(re.writable)}else{if(!Jr())return;{if(typeof RTCRtpScriptTransform>"u")return void M.warning("browser not support RTCRtpScriptTransform");const re=_S(),fe=new MessageChannel;await new Ee(_e=>re.onmessage=ye=>{ye.data==="registered"&&_e(void 0)});const be=new RTCRtpScriptTransform(re,{name:"tx",port:fe.port2},[fe.port2]);H.transform=be,await new Ee(_e=>re.onmessage=ye=>{ye.data==="started"&&_e(void 0)}),j.on("sei-to-send",_e=>{fe.port1.postMessage({sei:_e})}),fe.port1.onmessage=_e=>{var ye;_e.data.transformed&&H.track&&((ye=H.track)===null||ye===void 0?void 0:ye.id)!==W.track.id&&(M.debug("video track changed: ".concat(W.track.id," => ").concat(H.track.id)),W.track.removeEventListener("ended",ee),W.track=H.track,W.track.addEventListener("ended",ee))},W.worker=re}}function ee(){if(H.track){if(this.id!==H.track.id)return;H.track.removeEventListener("ended",ee)}const re=Kf.get(H);if(re){Kf.delete(H);try{var fe,be;(fe=re.controller)===null||fe===void 0||fe.terminate(),(be=re.worker)===null||be===void 0||be.terminate()}catch(_e){M.warning(_e&&_e.message)}}}Kf.set(H,W),H.track.addEventListener("ended",ee)}(L.sender,N):N.trackMediaType===gt.AUDIO&&await async function(H){if(!Dn().supportWebRTCEncodedTransform)return void M.warning("browser not support audio encoded transform");if(Hf.has(H)||!H.track)return;const j={track:H.track};if(tl()){if(!H.createEncodedStreams)return void M.warning("browser not support createEncodedStreams() API");let ee=null;try{ee=H.createEncodedStreams()}catch(fe){return void M.error("create audio-encoded-streams error",fe&&fe.message)}const re=new TransformStream({transform(fe,be){j.controller||(j.controller=be),H.track&&H.track.id!==j.track.id&&(M.debug("audio track changed: ".concat(j.track.id," => ").concat(H.track.id)),j.track.removeEventListener("ended",W),j.track=H.track,j.track.addEventListener("ended",W)),be.enqueue(fe)}});ee.readable.pipeThrough(re).pipeTo(ee.writable)}else if(Jr()){if(typeof RTCRtpScriptTransform>"u")return void M.warning("browser not support RTCRtpScriptTransform");const ee=_S(),re=new MessageChannel;await new Ee(be=>ee.onmessage=_e=>{_e.data==="registered"&&be(void 0)});const fe=new RTCRtpScriptTransform(ee,{name:"tx",port:re.port2},[re.port2]);H.transform=fe,await new Ee(be=>ee.onmessage=_e=>{_e.data==="started"&&be(void 0)}),re.port1.onmessage=be=>{var _e;be.data.transformed&&H.track&&((_e=H.track)===null||_e===void 0?void 0:_e.id)!==j.track.id&&(M.debug("audio track changed: ".concat(j.track.id," => ").concat(H.track.id)),j.track.removeEventListener("ended",W),j.track=H.track,j.track.addEventListener("ended",W))},j.worker=ee}function W(){if(H.track){if(this.id!==H.track.id)return;H.track.removeEventListener("ended",W)}const ee=Hf.get(H);if(ee){Hf.delete(H);try{var re,fe;(re=ee.controller)===null||re===void 0||re.terminate(),(fe=ee.worker)===null||fe===void 0||fe.terminate()}catch(be){M.warning(be&&be.message)}}}Hf.set(H,j),H.track.addEventListener("ended",W)}(L.sender))}),n.forEach(N=>{let{type:L}=N;o.statsCollector.addLocalStats(L)}),o.assignLocalTracks(n,R),o.statsUploader.startUploadOutboundStats(),n.forEach(N=>{let{track:L,type:H}=N;const j=Date.now();o.store.publish(L.getTrackId(),H===Je.LocalAudioTrack?"audio":"video",void 0,j)})})()}async updateVideoStreamParameter(e,n){const o=this.localTrackMap.get(n);if(!o)return;if(!(o.track instanceof on))return M.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof ur||this.connection instanceof As))return M.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:c}=o,u=function(m,_){const S={};return m.height&&m.width&&(S.scaleResolutionDownBy=zo(m,_)),S.maxFramerate=m.framerate?Yo(m.framerate):void 0,S.maxBitrate=m.bitrate?1e3*m.bitrate:void 0,S}(e,c);if(c._encoderConfig||(c._encoderConfig={}),n!==Je.LocalVideoLowTrack||!oe("DISABLE_DUAL_STREAM_USE_ENCODING")&&Dn().supportDualStreamEncoding)u.scaleResolutionDownBy!=null&&(c._encoderConfig.scaleResolutionDownBy=u.scaleResolutionDownBy);else{const m=c._originMediaStreamTrack;if(!m.canvas)return M.warn("[".concat(c.getTrackId(),"] no canvas on track"));(function(_,S){const C=_.canvas;S.width&&(C.width=Yo(S.width)),S.height&&(C.height=Yo(S.height)),S.framerate&&(C.stopCapture&&C.stopCapture(),C.stopCapture=Xw(()=>{!C.startCapture&&C.stopCapture&&C.stopCapture(),C.startCapture&&C.startCapture()},Yo(S.framerate)))})(m,e)}u.maxBitrate!=null&&(c._encoderConfig.bitrateMax=u.maxBitrate/1e3),u.maxFramerate!=null&&(c._encoderConfig.frameRate&&typeof c._encoderConfig.frameRate=="object"?c._encoderConfig.frameRate.max=u.maxFramerate:c._encoderConfig.frameRate={max:u.maxFramerate}),M.debug("[".concat(c.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(c._encoderConfig))),await this.connection.updateRtpSenderEncodings(c)}publishLowStream(e){var n=this;return Fo(function*(){if(!n.connection||n.state!==kn.Connected)return;const o=yield Qt(n.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const u=n.localTrackMap.get(Je.LocalVideoTrack);if(!u)throw new ke(Q.UNEXPECTED_ERROR,"Could not find high stream");if(n.localTrackMap.has(Je.LocalVideoLowTrack))throw new ke(Q.UNEXPECTED_ERROR,"[".concat(n.store.clientId,"] Can't publish low stream when stream already publish"));const m=[{track:n.getLowVideoTrack(u.track,e),type:Je.LocalVideoLowTrack}];if(yield*$k(b5(n.doPublish(n.connection,m))),u.track.muted||!u.track.enabled){var c;const _=(c=n.localTrackMap.get(Je.LocalVideoLowTrack))===null||c===void 0?void 0:c.id;_!==void 0&&(yield Qt(n.connection.muteLocal([_])))}}finally{o()}})()}async republish(){this.pendingLocalTracks.length>0&&(M.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Ji(this,We.RequestRePublish,this.pendingLocalTracks),this.emit(We.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(M.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Ji(this,We.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let n=this.pendingRemoteTracks.length-1;n>=0;n--){const{user:o,kind:c}=this.pendingRemoteTracks[n];(c!==gt.AUDIO||o._audio_added_&&o._audioSSRC)&&(c!==gt.VIDEO||o._video_added_&&o._videoSSRC)||this.pendingRemoteTracks.splice(n,1)}if(e)await Ji(this,We.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:n,kind:o}of this.pendingRemoteTracks)await this.subscribe(n,o,o===gt.VIDEO?n._videoSSRC:n._audioSSRC);this.pendingRemoteTracks.forEach(n=>{let{user:o}=n;this.emit(We.MediaReconnectEnd,o.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==kn.Connected)return void e.forEach(c=>{const u=this.pendingLocalTracks.indexOf(c);u!==-1&&this.pendingLocalTracks.splice(u,1)});const n=this.filterTobeUnpublishedTracks(e);if(n.length===0)return;const o=n.find(c=>c[0]==="videoLowTrack");return o&&o[1].track.close(),this.doUnpublish(this.connection,n)}async unpublishDataChannel(e){if(!this.connection||this.state!==kn.Connected)return void e.forEach(o=>{const c=this.pendingLocalDataChannels.indexOf(o);c!==-1&&this.pendingLocalDataChannels.splice(c,1)});const n=this.filterTobeUnpublishedDataChannels(e);return n.length!==0?(n.forEach(o=>{const c=this.localDataChannels.indexOf(o);c!==-1&&this.localDataChannels.splice(c,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),n.map(o=>o.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==kn.Connected)return;const e=this.localTrackMap.get(Je.LocalVideoLowTrack);if(!e)return;e.track.close();const n=[[Je.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,n)}async doUnpublish(e,n){const o=this.createGatewayUnpublishMessage(n);return await e.stopSending(n.map(c=>{let[,{id:u}]=c;return u})),this.withdrawLocalTracks(n),this.unbindLocalTrackEvents(n.map(c=>{let[u,{track:m}]=c;return{type:u,track:m}})),n.forEach(c=>{let[u]=c;this.statsCollector.removeLocalStats(u)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),o}async subscribeDataChannel(e,n){if(!this.connection||this.state!==kn.Connected)throw new ke(Q.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const o=n.filter(c=>{var u;return!((u=this.remoteDataChannelMap.get(e))!==null&&u!==void 0&&u.get(c.id))});if(o.length!==0)return await this.connection.createDataChannels(e.uid,o),o.forEach(c=>{var u;this.remoteDataChannelMap.has(e)?(u=this.remoteDataChannelMap.get(e))===null||u===void 0||u.set(c.id,c):this.remoteDataChannelMap.set(e,new Map([[c.id,c]]));const m=this.pendingRemoteDataChannels.findIndex(_=>{let{user:S,id:C}=_;return S.uid===e.uid&&C===c.id});m!==-1&&this.pendingRemoteDataChannels.splice(m,1)}),o.map(c=>c.id)}async subscribe(e,n,o,c,u){var m;if(!this.connection||this.state!==kn.Connected)throw new ke(Q.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((m=this.remoteUserMap.get(e))!==null&&m!==void 0&&m.has(n))return;let _,S,C;if(u){const N=u.find(H=>{let{stream_type:j}=H;return j===n});if(!N)throw new ke(Q.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(n," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(n,"."));const L=await this.connection.receive(n,N.ssrcs,String(e._uintid),N.attributes);this.connection instanceof ur&&(C=L.transceiver),_=L.track,S=L.id}else{const N=await this.connection.receive(n,[{ssrcId:o,rtx:c}],String(e._uintid),void 0);this.connection instanceof ur&&(C=N.transceiver),_=N.track,S=N.id}n===gt.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(_):(e._audioTrack=new jt(_,e.uid,e._uintid,this.store),M.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),C&&e._audioTrack._updateRtpTransceiver(C),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(_):(e._videoTrack=new ps(_,e.uid,e._uintid,this.store),M.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),C&&e._videoTrack._updateRtpTransceiver(C),this.bindRemoteTrackEvents(e,e._videoTrack)),oe("ENABLE_VIDEO_SEI")&&C&&(n==gt.VIDEO?await Kk(C.receiver,{onSei:N=>{var L;(L=e._videoTrack)===null||L===void 0||L._onSei(N)}}):n==gt.AUDIO&&await Hk(C.receiver));const R=this.remoteUserMap.get(e);R?R.set(n,S):this.remoteUserMap.set(e,new Map([[n,S]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const w=this.pendingRemoteTracks.findIndex(N=>{let{user:L,kind:H}=N;return L.uid===e.uid&&n===H});w!==-1&&(this.pendingRemoteTracks.splice(w,1),this.emit(We.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==kn.Connected)throw new ke(Q.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(o=>{var c;let{user:u,mediaType:m}=o;return!((c=this.remoteUserMap.get(u))!==null&&c!==void 0&&c.has(m))});const n=await this.connection.batchReceive(e.map(o=>{let{user:c,mediaType:u,ssrcId:m,rtxSsrcId:_}=o;return{kind:u,ssrcMsg:[{ssrcId:m,rtx:_}],mslabel:String(c._uintid)}}));e.forEach((o,c)=>{let{user:u,mediaType:m}=o;const{track:_,id:S,transceiver:C}=n[c];m===gt.AUDIO?(u._audioTrack?u._audioTrack._updateOriginMediaStreamTrack(_):(u._audioTrack=new jt(_,u.uid,u._uintid,this.store),M.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(u._audioTrack.getTrackId()))),C&&u._audioTrack._updateRtpTransceiver(C),this.bindRemoteTrackEvents(u,u._audioTrack)):(u._videoTrack?u._videoTrack._updateOriginMediaStreamTrack(_):(u._videoTrack=new ps(_,u.uid,u._uintid,this.store),M.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(u._videoTrack.getTrackId()))),C&&u._videoTrack._updateRtpTransceiver(C),this.bindRemoteTrackEvents(u,u._videoTrack));const R=this.remoteUserMap.get(u);R?R.set(m,S):this.remoteUserMap.set(u,new Map([[m,S]])),this.statsCollector.addRemoteStats(u.uid),this.statsUploader.startUploadInboundStats();const w=this.pendingRemoteTracks.findIndex(N=>{let{user:L,kind:H}=N;return L.uid===u.uid&&m===H});w!==-1&&(this.pendingRemoteTracks.splice(w,1),this.emit(We.MediaReconnectEnd,u.uid))})}async unsubscribe(e,n,o){const c=this.pendingRemoteTracks.filter(_=>{let{user:S,kind:C}=_;return n!==void 0?S.uid===e.uid&&n===C:S.uid===e.uid});if(c.forEach(_=>{const S=this.pendingRemoteTracks.indexOf(_);this.pendingRemoteTracks.splice(S,1)}),this.connection&&this.state===kn.Connected||o||c.forEach(_=>{let{kind:S}=_;var C;if(S===gt.AUDIO)(C=e._audioTrack)===null||C===void 0||C._destroy(),e._audioTrack=void 0;else if(S===gt.VIDEO){var R;(R=e._videoTrack)===null||R===void 0||R._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==kn.Connected)return;const u=this.filterTobeUnSubscribedTracks(e,n);if(u.length===0)return;await this.connection.stopReceiving(u.map(_=>{let[,{id:S}]=_;return S}));const m=this.createUnsubscribeMessage(u);return this.withdrawRemoteTracks(u),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),u.forEach(_=>{let[S,{kind:C}]=_;var R,w;if(C===gt.VIDEO&&S._videoSSRC&&((R=this.connection)===null||R===void 0||R.setStatsRemoteVideoIsReady(S._videoSSRC,!1)),C===gt.VIDEO)this.unbindRemoteTrackEvents(S._videoTrack),o||((w=S._videoTrack)===null||w===void 0||w._destroy(),S._videoTrack=void 0);else if(C===gt.AUDIO){var N;this.unbindRemoteTrackEvents(S._audioTrack),!o&&((N=S._audioTrack)===null||N===void 0||N._destroy(),S._audioTrack=void 0)}}),m}async unsubscribeDataChannel(e,n){if(n.forEach(u=>{const m=this.pendingRemoteDataChannels.findIndex(_=>_.id===u.id);m!==-1&&this.pendingRemoteDataChannels.splice(m,1)}),!this.connection)return;const o=this.filterTobeUnSubscribedDataChannels(e,n);if(o.length===0)return;n.forEach(u=>{u._close()});const c=this.remoteDataChannelMap.get(e);return o.forEach(u=>{c&&c.delete(u.id)}),c&&c.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),o.map(u=>u.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let n=[];for(const{user:u,mediaType:m}of e){const _=this.pendingRemoteTracks.filter(S=>{let{user:C,kind:R}=S;return m!==void 0?C.uid===u.uid&&m===R:C.uid===u.uid});_.forEach(S=>{const C=this.pendingRemoteTracks.indexOf(S);this.pendingRemoteTracks.splice(C,1)}),n=n.concat(_)}if(!this.connection||this.state!==kn.Connected)return void n.forEach(u=>{let{user:m,kind:_}=u;var S;if(_===gt.AUDIO)(S=m._audioTrack)===null||S===void 0||S._destroy(),m._audioTrack=void 0;else if(_===gt.VIDEO){var C;(C=m._videoTrack)===null||C===void 0||C._destroy(),m._videoTrack=void 0}});const o=sl(e).call(e,(u,m)=>{let{user:_,mediaType:S}=m;const C=this.filterTobeUnSubscribedTracks(_,S);return u.concat(C)},[]);if(o.length===0)return;await this.connection.stopReceiving(o.map(u=>{let[,{id:m}]=u;return m}));const c=this.createUnsubscribeAllMessage(o);return this.withdrawRemoteTracks(o),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),o.forEach(u=>{let[m,{kind:_}]=u;var S,C;if(_===gt.VIDEO&&m._videoSSRC&&((S=this.connection)===null||S===void 0||S.setStatsRemoteVideoIsReady(m._videoSSRC,!1)),_===gt.VIDEO)this.unbindRemoteTrackEvents(m._videoTrack),(C=m._videoTrack)===null||C===void 0||C._destroy(),m._videoTrack=void 0;else if(_===gt.AUDIO){var R;this.unbindRemoteTrackEvents(m._audioTrack),(R=m._audioTrack)===null||R===void 0||R._destroy(),m._audioTrack=void 0}}),c}async muteRemote(e,n){if(!this.connection)return;const o=this.remoteUserMap.get(e);if(!o)return void M.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!o.get(n))return void M.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(n,"."));const c=n===gt.VIDEO?e._videoSSRC:e._audioSSRC;c!==void 0&&this.connection.setStatsRemoteVideoIsReady(c,!1)}async unmuteRemote(e,n){return this.unmuteRemoteNoLock(e,n)}async unmuteRemoteNoLock(e,n){if(!this.connection)return;const o=this.remoteUserMap.get(e);if(!o)return void M.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));o.get(n)||M.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(n,"."))}getAllTracks(e){const n=this.localTrackMap.get(Je.LocalAudioTrack);if((n==null?void 0:n.track)instanceof Yi){const o=n.track;return Array.from(this.localTrackMap.entries()).filter(c=>{let[u]=c;return u!==Je.LocalAudioTrack}).filter(c=>{let[u]=c;return!(e&&u===Je.LocalVideoLowTrack)}).map(c=>{let[,{track:u}]=c;return u}).concat(o.trackList)}return Array.from(this.localTrackMap.entries()).filter(o=>{let[c]=o;return!(e&&c===Je.LocalVideoLowTrack)}).map(o=>{let[,{track:c}]=o;return c})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,n,o,c,u){if(e){const _=this.localTrackMap.get(Je.LocalAudioTrack),S=c?this.localTrackMap.get(Je.LocalVideoLowTrack):this.localTrackMap.get(Je.LocalVideoTrack);vt.publish(this.store.sessionId,{eventElapse:Us.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:n,audioName:_==null?void 0:_.track.getTrackLabel(),videoName:S==null?void 0:S.track.getTrackLabel(),screenshare:(S==null?void 0:S.track._hints.indexOf(hi.SCREEN_TRACK))!==-1,audio:!!_,video:!!S,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}else{var m;o||(o=[]);const _=o.find(C=>C instanceof xn),S=c?(m=this.localTrackMap.get(Je.LocalVideoTrack))===null||m===void 0?void 0:m.track:o.find(C=>C instanceof on);vt.publish(this.store.sessionId,{eventElapse:Us.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:n,audioName:_==null?void 0:_.getTrackLabel(),videoName:S==null?void 0:S.getTrackLabel(),screenshare:(S==null?void 0:S._hints.indexOf(hi.SCREEN_TRACK))!==-1,audio:!!_,video:!!S,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:u})}}reportSubscribeEvent(e,n,o,c){const u=c===gt.VIDEO?o._videoSSRC:o._audioSSRC;u&&vt.subscribe(this.store.sessionId,{succ:e,ec:n,video:c===gt.VIDEO,audio:c===gt.AUDIO,peerid:o.uid,subscribeRequestid:c===gt.VIDEO?o._videoSSRC:o._audioSSRC,p2pid:this.store.p2pId,eventElapse:Us.measureFromSubscribeStart(this.store.clientId,u)})}reset(){M.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Zr("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new is({},this.store):this.isPlanB?new As({},this.store):new ur({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(Je.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Yi){if(e.track.trackList.length>0){const n=e.track;e.track.trackList.forEach(o=>{n.removeAudioTrack(o)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=kn.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var n;return((n=this.connection)===null||n===void 0?void 0:n.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Je.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Je.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const n=this.localTrackMap.get(e);return n&&n.track instanceof on||n&&n.track instanceof xn?n.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,n){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!n||o.has(n))}async hasRemoteMediaWithLock(e,n){if(!e)return this.remoteUserMap.size>0;const o=this.remoteUserMap.get(e);return!!o&&(!n||o.has(n))}getRemoteMedia(e){var n;const o=Array.from(ka(n=this.remoteUserMap).call(n)).find(c=>c.uid===e);return o?{audioTrack:o.audioTrack,audioSSRC:o._audioSSRC,videoTrack:o.videoTrack,videoSSRC:o._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(o=>{let[c]=o;return{uid:c.uid,level:c.audioTrack?100*c.audioTrack._source.getAccurateVolumeLevel():0}});const n=this.localTrackMap.get(Je.LocalAudioTrack);return n&&e.push({level:100*n.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=LE(e).call(e,(o,c)=>o.level-c.level),e}async disconnectForReconnect(){this.connection&&(M.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=kn.Reconnecting,oe("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[n]=e;var o;n._videoTrack&&n._videoTrack._player&&((o=n._videoTrack._player.getVideoElement())===null||o===void 0||o.pause(),n._videoTrack._player.isKeepLastFrame=!0,n._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new is({},this.store):this.isPlanB?new As({},this.store):new ur({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var n;let[o,{track:c}]=e;switch(o){case Je.LocalVideoTrack:xe(n=c._hints).call(n,hi.LOW_STREAM)?c.close():this.pendingLocalTracks.push(c);break;case Je.LocalAudioTrack:c instanceof Yi?this.pendingLocalTracks=this.pendingLocalTracks.concat(c.trackList):this.pendingLocalTracks.push(c);case Je.LocalVideoLowTrack:}}),this.emit(We.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[n,o]=e;Array.from(ka(o).call(o)).forEach(c=>{this.setPendingRemoteMedia(n,c)}),this.emit(We.MediaReconnectStart,n.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[n,o]=e;Array.from(ka(o).call(o)).forEach(c=>{this.setPendingRemoteDataChannel(n,c)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),M.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,n){for(const o of this.pendingRemoteDataChannels){const{user:c,id:u}=o;if((e instanceof xs?e.uid:e)===c.uid&&u===n)return!0}return!1}setPendingRemoteDataChannel(e,n){this.hasPendingRemoteDataChannel(e,n)||this.pendingRemoteDataChannels.push({user:e,id:n})}hasPendingRemoteMedia(e,n){for(const o of this.pendingRemoteTracks){const{user:c,kind:u}=o;if((e instanceof xs?e.uid:e)===c.uid&&n===u)return!0}return!1}setPendingRemoteMedia(e,n){this.hasPendingRemoteMedia(e,n)||this.pendingRemoteTracks.push({user:e,kind:n})}restartICE(e){var n=this;return Fo(function*(){if(!n.connection||n.state!==kn.Connected||n.connection instanceof is)return;const o=yield Qt(n.mutex.lock("From P2PChannel.restartICE"));let c;try{c=yield Qt(n.connection.restartICE(e));const m=yield Qt(c.next());if(m.done)return;const _=m.value,S=yield _;switch(n.reportPCDisconnectedOrFailed(e),e){case Xn.TCP:n._pcStatsUploadType=Ua.TCP_RESTART;break;case Xn.RELAY:n._pcStatsUploadType=Ua.RELAY_RESTART;break;default:n._pcStatsUploadType=Ua.OLD_RESTART}n._isInRestartIce=!0,c.next(S)}catch(m){var u;(u=c)===null||u===void 0||u.throw(m)}finally{o()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),n=this.localTrackMap.get(Je.LocalVideoTrack),o=this.localTrackMap.get(Je.LocalAudioTrack),c=e.videoSend.find(H=>H.ssrc===(n==null?void 0:n.ssrcs[0].ssrcId)),u=e.audioSend.find(H=>H.ssrc===(o==null?void 0:o.ssrcs[0].ssrcId));if(!c||!u)return 1;const m=mo(this,We.NeedSignalRTT),_=c?c.rttMs:void 0,S=u?u.rttMs:void 0,C=_&&S?(_+S)/2:_||S,R=(C&&m?(C+m)/2:C||m)||0,w=100*e.sendPacketLossRate*.7/50+.3*R/1500,N=w<.17?1:w<.36?2:w<.59?3:w<.1?4:5,L=n==null?void 0:n.track;if(L&&L._encoderConfig&&L._hints.indexOf(hi.SCREEN_TRACK)===-1){const H=L._encoderConfig.bitrateMax,j=e.bitrate.actualEncoded;if(H&&j){const W=(1e3*H-j)/(1e3*H);return df[W<.15?0:W<.3?1:W<.45?2:W<.6?3:4][N]}}return N}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let n=0;return Array.from(this.remoteUserMap.entries()).forEach(o=>{let[c]=o;const u=c._audioSSRC,m=c._videoSSRC,_=e.audioRecv.find(j=>j.ssrc===u),S=e.videoRecv.find(j=>j.ssrc===m);if(!_&&!S)return void(n+=1);const C=mo(this,We.NeedSignalRTT),R=e.rtt,w=(R&&C?(R+C)/2:R||C)||0,N=_?_.jitterMs:void 0,L=e.recvPacketLossRate;let H=.7*L*100/50+.3*w/1500;N&&(H=.6*L*100/50+.2*w/1500+.2*N/400),n+=H<.1?1:H<.17?2:H<.36?3:H<.59?4:5}),this.remoteUserMap.size>0?Math.round(n/this.remoteUserMap.size):n}async muteLocalTrack(e){return new Ee((n,o)=>{this.handleMuteLocalTrack(e,n,o)})}async replaceTrack(e,n){var o;if(M.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(n.getTrackId(),"]")),!this.connection||this.state!==kn.Connected)return;const c=Array.from(this.localTrackMap.entries()).find(m=>{let[,{track:_}]=m;return e===_});if(!c)return;const u=c[0];if(e!==n&&(this.unbindLocalTrackEvents([{track:e,type:u}]),this.bindLocalTrackEvents([{track:n,type:u}]),c[1].track=n),await((o=this.connection)===null||o===void 0?void 0:o.replaceTrack(n,c[1].id)),this.isPlanB){const m=c[1];m.id=n._mediaStreamTrack.id,this.localTrackMap.set(u,m)}if(u===Je.LocalVideoTrack&&!oe("DISABLE_DUAL_STREAM_USE_ENCODING")&&Dn().supportDualStreamEncoding){const m=this.localTrackMap.get(Je.LocalVideoLowTrack);if(m){const _=e._mediaStreamTrack.clone();m.track._originMediaStreamTrack.stop(),m.track._mediaStreamTrack=_,m.track._originMediaStreamTrack=_,await new Ee((S,C)=>{this.handleReplaceTrack(m.track,S,C,!0)})}}}filterTobePublishedTracks(e,n,o){const c=[],u=this.getAllTracks();e=tf(e=e.filter(C=>u.indexOf(C)===-1));let m,_=!1;const S=this.localTrackMap.get(Je.LocalAudioTrack);for(const C of e){if(C instanceof on&&(this.localTrackMap.has(Je.LocalVideoTrack)||_?new ke(Q.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(c.push({track:C,type:Je.LocalVideoTrack}),_=!0),n)){const R=this.getLowVideoTrack(C,o);c.push({track:R,type:Je.LocalVideoLowTrack})}if(C instanceof xn)if(S){const R=S.track;if(R instanceof Yi)z3([C]),R.addAudioTrack(C),this.bindLocalAudioTrackEvents(C,!0);else{const w=q3([R,C]);M.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(w.getTrackId(),"]")),this.replaceTrack(R,w)}}else m instanceof Yi?(z3([C]),m.addAudioTrack(C)):m||!C._useAudioElement&&Dn().webAudioMediaStreamDest&&!C._bypassWebAudio?m=q3(m?[C,m]:[C]):m=C}return m&&(M.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(m.getTrackId(),"]")),c.push({track:m,type:Je.LocalAudioTrack})),c}filterTobeUnpublishedTracks(e){const n=[],o=this.getAllTracks();e=tf(e=e.filter(c=>o.indexOf(c)!==-1));for(const c of e){if(c instanceof xn){const u=this.localTrackMap.get(Je.LocalAudioTrack);if(!u)continue;u.track instanceof Yi?(u.track.removeAudioTrack(c),this.unbindLocalAudioTrackEvents(c),u.track.trackList.length===0&&(n.push([Je.LocalAudioTrack,u]),u.track.close())):n.push([Je.LocalAudioTrack,u])}if(c instanceof on){const u=this.localTrackMap.get(Je.LocalVideoTrack);if(!u)continue;n.push([Je.LocalVideoTrack,u]);const m=this.localTrackMap.get(Je.LocalVideoLowTrack);m&&n.push([Je.LocalVideoLowTrack,m])}}return n}filterTobePublishedDataChannels(e){return e=(e=tf(e)).filter(n=>this.localDataChannels.findIndex(o=>o.id===n.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=tf(e)).filter(n=>this.localDataChannels.indexOf(n)!==-1)).filter(n=>n._originDataChannel)}bindLocalTrackEvents(e){e.forEach(n=>{let{track:o,type:c}=n;switch(c){case Je.LocalVideoTrack:o.addListener(ht.GET_STATS,this.handleGetLocalVideoStats),o.addListener(ht.GET_RTC_STATS,this.handleGetRTCStats),o.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.addListener(ht.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Je.LocalAudioTrack:this.bindLocalAudioTrackEvents(o);case Je.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,n){e instanceof Yi?e.trackList.forEach(o=>{o.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),o.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),n||(e.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(ht.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(n=>{let[o,{track:c}]=n;return{track:c,type:o}})),e.forEach(n=>{let{track:o,type:c}=n;switch(c){case Je.LocalVideoTrack:o.off(ht.GET_STATS,this.handleGetLocalVideoStats),o.off(ht.GET_RTC_STATS,this.handleGetRTCStats),o.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),o.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),o.off(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),o.off(ht.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),o.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),o.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),o.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Je.LocalAudioTrack:this.unbindLocalAudioTrackEvents(o);case Je.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof Yi?e.trackList.forEach(n=>{n.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(ht.GET_STATS,this.handleGetLocalAudioStats),n.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(ht.GET_STATS,this.handleGetLocalAudioStats),e.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ht.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,n){n instanceof ps&&n.addListener(ht.GET_STATS,o=>{o(this.handleGetRemoteVideoStats(e))}),n instanceof jt&&n.addListener(ht.GET_STATS,o=>{o(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ht.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[n,o]=e;o.has(gt.AUDIO)&&this.unbindRemoteTrackEvents(n._audioTrack),o.has(gt.VIDEO)&&this.unbindRemoteTrackEvents(n._videoTrack)})}createGatewayPublishMessage(e,n){return e.map((o,c)=>{var u;let m,_,{track:S,type:C}=o;switch(C){case Je.LocalAudioTrack:m=Nn.Audio,_={dtx:S instanceof hu&&S._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Je.LocalVideoTrack:m=xe(u=S._hints).call(u,hi.SCREEN_TRACK)?Nn.Screen:Nn.High,_=Jf(Jf({},Bw(S)),{},{codec:this.store.codec});break;case Je.LocalVideoLowTrack:m=Nn.Low,_=Jf(Jf({},Bw(S)),{},{codec:this.store.codec})}return{stream_type:m,attributes:_,ssrcs:n[c]}})}createGatewayUnpublishMessage(e){return e.map(n=>{var o;let c,[u,{track:m,ssrcs:_,id:S}]=n;switch(u){case Je.LocalVideoTrack:c=xe(o=m._hints).call(o,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalAudioTrack:c=Nn.Audio;break;case Je.LocalVideoLowTrack:c=Nn.Low}return{stream_type:c,ssrcs:_,mid:S}})}assignLocalTracks(e,n){e.forEach((o,c)=>{let{track:u,type:m}=o;this.localTrackMap.set(m,{track:u,id:n[c].id,ssrcs:n[c].localSSRC})})}withdrawLocalTracks(e){e.forEach(n=>{let[o]=n;this.localTrackMap.delete(o)})}bindConnectionEvents(e){e.onConnectionStateChange=async n=>{if(M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(n,")")),this.emit(We.PeerConnectionStateChange,n),n!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),n==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),oe("NEW_ICE_RESTART")){var o;if(xe(o=this._restartStates).call(o,n)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const c=_=>{(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")&&(M.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(_)),mo(this,We.QueryClientConnectionState)==="CONNECTED"&&this.emit(We.RequestRestartICE,_))},u=()=>{e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="checking"&&e.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),M.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(We.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},m=oe("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(oe("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Dn().supportPCSetConfiguration)c(Xn.RELAY),this._restartTimer=window.setTimeout(u,m);else if(Ln())c(Xn.UDP),this._restartTimer=window.setTimeout(u,4e3);else{if(c(Xn.TCP),Dn().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{c(Xn.RELAY),this._restartTimer=window.setTimeout(u,m)},m));this._restartTimer=window.setTimeout(u,m)}},800))}}else{if(n==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&oe("ICE_RESTART")&&mo(this,We.QueryClientConnectionState)==="CONNECTED"&&this.emit(We.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(M.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(We.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);n==="failed"&&(M.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(We.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=n=>{n!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(n,")")),vt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:n,tag:wi.TRACER}).onSuccess(),this.emit(We.IceConnectionStateChange,n)},e.onICETransportStateChange=n=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(n,")"))},e.onDTLSTransportStateChange=n=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(n,")"))},e.onDTLSTransportError=n=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(n,")"))},e.onFirstAudioDecoded=n=>{var o;const c=Array.from(ka(o=this.remoteUserMap).call(o)).find(m=>m._audioSSRC===n);var u;c&&(this.store.subscribe(c.uid,"audio",void 0,void 0,void 0,Date.now()),(u=c.audioTrack)===null||u===void 0||u.emit(pa.FIRST_FRAME_DECODED),vt.firstRemoteFrame(this.store.sessionId,x.FIRST_AUDIO_DECODE,pi.FIRST_AUDIO_DECODE,{peer:c._uintid,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=n=>{var o;const c=Array.from(ka(o=this.remoteUserMap).call(o)).find(u=>u._audioSSRC===n);c&&vt.firstRemoteFrame(this.store.sessionId,x.FIRST_AUDIO_RECEIVED,pi.FIRST_AUDIO_RECEIVED,{peer:c._uintid,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(n,o,c)=>{this.reportVideoFirstFrameDecoded(n,o,c)},e.onFirstVideoReceived=n=>{var o;const c=Array.from(ka(o=this.remoteUserMap).call(o)).find(u=>u._videoSSRC===n);c&&vt.firstRemoteFrame(this.store.sessionId,x.FIRST_VIDEO_RECEIVED,pi.FIRST_VIDEO_RECEIVED,{peer:c._uintid,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(n,o)=>{const c=n.candidateType==="relay",u=o.candidateType==="relay";o.candidateType!=="unknown"&&c===u||this.emit(We.ConnectionTypeChange,c),M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(du(o))," -> ").concat(JSON.stringify(du(n)),")"))},e.onSelectedRemoteCandidateChanged=(n,o)=>{M.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(du(o))," -> ").concat(JSON.stringify(du(n)),")"))},e.onFirstVideoDecodedTimeout=n=>{this.reportVideoFirstFrameDecoded(n,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const n=[];if(this.getAllTracks().indexOf(e)===-1)return n;const o=this.localTrackMap.get(Je.LocalAudioTrack);if(e instanceof xn&&(o==null?void 0:o.track)instanceof Yi)return o.track.isActive||n.push([Je.LocalAudioTrack,o]),n;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:m}]=u;return e===m});if(c&&(n.push(c),c[0]===Je.LocalVideoTrack)){const u=this.localTrackMap.get(Je.LocalVideoLowTrack);u&&n.push([Je.LocalVideoLowTrack,u])}return n}filterTobeUnmutedTracks(e){const n=[],o=this.localTrackMap.get(Je.LocalAudioTrack);if(e instanceof xn&&(o==null?void 0:o.track)instanceof Yi)return o.track.isActive&&n.push([Je.LocalAudioTrack,o]),n;const c=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:m}]=u;return e===m});if(c)if(c[0]===Je.LocalVideoTrack){n.push(c);const u=this.localTrackMap.get(Je.LocalVideoLowTrack);u&&n.push([Je.LocalVideoLowTrack,u])}else n.push(c);return n}createMuteMessage(e){return e.map(n=>{var o;let c,[u,{track:m,ssrcs:_,id:S}]=n;switch(u){case Je.LocalAudioTrack:c=Nn.Audio;break;case Je.LocalVideoTrack:c=xe(o=m._hints).call(o,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalVideoLowTrack:c=Nn.Low}return{stream_type:c,ssrcs:_,mid:S}})}createUnmuteMessage(e){return e.map(n=>{var o;let c,[u,{track:m,ssrcs:_,id:S}]=n;switch(u){case Je.LocalAudioTrack:c=Nn.Audio;break;case Je.LocalVideoTrack:c=xe(o=m._hints).call(o,hi.SCREEN_TRACK)?Nn.Screen:Nn.High;break;case Je.LocalVideoLowTrack:c=Nn.Low}return{stream_type:c,ssrcs:_,mid:S}})}filterTobeUnSubscribedTracks(e,n){const o=[],c=this.remoteUserMap.get(e);if(!c)return o;if(n){const u=c.get(n);if(!u)return o;o.push([e,{kind:n,id:u}])}else Array.from(c.entries()).forEach(u=>{let[m,_]=u;o.push([e,{kind:m,id:_}])});return o}filterTobeUnSubscribedDataChannels(e,n){const o=[];return n.forEach(c=>{var u;(u=this.remoteDataChannelMap.get(e))!==null&&u!==void 0&&u.has(c.id)&&o.push(c)}),o}createUnsubscribeMessage(e){const n=[];return e.forEach(o=>{let[c,{kind:u,id:m}]=o;switch(u){case gt.VIDEO:return void(c._videoSSRC&&n.push({stream_type:gt.VIDEO,ssrcId:c._videoSSRC}));case gt.AUDIO:return void(c._audioSSRC&&n.push({stream_type:gt.AUDIO,ssrcId:c._audioSSRC}))}}),n}createUnsubscribeAllMessage(e){const n=new Map;return e.forEach(o=>{let[c,{kind:u}]=o;if(n.has(c)){let m=n.get(c);u===gt.VIDEO?m|=Yn.Video:m|=Yn.Audio,n.set(c,m)}else u===gt.VIDEO?n.set(c,Yn.Video):n.set(c,Yn.Audio)}),{users:Array.from(n.entries()).map(o=>{let[c,u]=o;return{stream_id:c.uid,stream_type:u}})}}withdrawRemoteTracks(e){e.forEach(n=>{let[o,{kind:c}]=n;const u=this.remoteUserMap.get(o);u&&(u.delete(c),Array.from(u.entries()).length===0&&this.remoteUserMap.delete(o))})}async updateBitrateLimit(e){const n=this.localTrackMap.get(Je.LocalVideoTrack),o=this.localTrackMap.get(Je.LocalVideoLowTrack);n&&await n.track.setBitrateLimit(e.uplink),o&&e.low_stream_uplink&&await o.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(e,n){return e.map((o,c)=>{var u;let{stream_type:m}=o;return(u=n.find(_=>{let{stream_type:S}=_;return m===S}))===null||u===void 0?void 0:u.attributes})}async tryToUnmuteAudio(e){for(let o=0;o<e.length;o++)if(e[o]instanceof xn){var n;const c=this.filterTobeUnmutedTracks(e[o]);if(c.length===0)continue;await((n=this.connection)===null||n===void 0?void 0:n.unmuteLocal(c.map(m=>{let[,{id:_}]=m;return _})));const u=this.createUnmuteMessage(c);return void await Mn(this,We.RequestUnmuteLocal,u)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var n;return!((n=this.connection)===null||n===void 0||!n.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,n)=>this.emit(We.RequestUpload,e,n),this.statsUploader.requestUploadStats=e=>this.emit(We.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Br(al(this.dtlsFailedCount,or)),this.emit(We.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),n=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),n.length>0&&await Ji(this,We.RequestUnpublishForReconnectPC,n),this.disconnectForReconnect(),this.emit(We.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Je.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof on)}throwIfTrackTypeNotMatch(e){if(e.filter(n=>n instanceof on).length>1)throw new ke(Q.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(n=>n instanceof xn).length>1&&(e.some(n=>n instanceof xn&&n._bypassWebAudio)||!Dn().webAudioMediaStreamDest))throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const n of e){if(n instanceof on&&this.pendingLocalTracks.some(o=>o instanceof on))throw new ke(Q.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(n instanceof xn&&this.pendingLocalTracks.some(o=>o instanceof xn)&&(!Dn().webAudioMediaStreamDest||n._bypassWebAudio||this.pendingLocalTracks.some(o=>o instanceof xn&&o._bypassWebAudio)))throw new ke(Q.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,n){const o=!oe("DISABLE_DUAL_STREAM_USE_ENCODING")&&Dn().supportDualStreamEncoding,c=Jf(Jf({},{width:160,height:120,framerate:15,bitrate:50}),n);let u;u=o?e._mediaStreamTrack.clone():Io(e,c);const m=oi(8,"track-low-"),_=new on(u,Jf(Jf({},o&&{scaleResolutionDownBy:zo(c,e)}),{},{frameRate:c.framerate,bitrateMax:c.bitrate,bitrateMin:c.bitrate}),void 0,void 0,m);return _.on(ut.TRANSCEIVER_UPDATED,S=>{e._updateRtpTransceiver(S,Dd.LOW_STREAM)}),_._hints.push(hi.LOW_STREAM),e.on("sei-to-send",S=>{_.emit("sei-to-send",S)}),e.addListener(ht.NEED_CLOSE,()=>{_.close()}),_}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,n,o){let c=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof ur){var u,m,_,S;const C=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:R,dtlsTransportState:w,peerConnectionState:N}=this.connection,{local:L,remote:H}=await this.connection.getSelectedCandidatePair();vt.pcStats(this.store.sessionId,{startTime:C,eventElapse:e-C||0,iceconnectionsate:R,dtlsstate:w,connectionstate:N,intSucc:n?1:2,error:c,selectedLocalCandidateProtocol:(u=L==null?void 0:L.protocol)!==null&&u!==void 0?u:"",selectedLocalCandidateType:(m=L.candidateType)!==null&&m!==void 0?m:"",selectedLocalCandidateAddress:"".concat(L.address,":").concat(L.port),selectedRemoteCandidateProtocol:(_=H.protocol)!==null&&_!==void 0?_:"",selectedRemoteCandidateType:(S=H.candidateType)!==null&&S!==void 0?S:"",selectedRemoteCandidateAddress:"".concat(H.address,":").concat(H.port),restartCnt:o})}}reportVideoFirstFrameDecoded(e,n,o,c){var u;const m=Array.from(ka(u=this.remoteUserMap).call(u)).find(_=>_._videoSSRC===e);if(m){c||this.store.subscribe(m.uid,"video",void 0,void 0,void 0,void 0,Date.now());const _=this.store.keyMetrics,S=_.subscribe.find(C=>C.userId===m.uid&&C.type==="video");vt.firstRemoteVideoDecode(this.store.sessionId,x.FIRST_VIDEO_DECODE,pi.FIRST_VIDEO_DECODE,{peer:m._uintid,videowidth:n,videoheight:o,subscribeElapse:Us.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:_.requestAPEnd||0,apStart:_.requestAPStart||0,joinGwEnd:_.joinGatewayEnd||0,joinGwStart:_.joinGatewayStart||0,pcEnd:_.peerConnectionEnd||0,pcStart:_.peerConnectionStart||0,subscriberEnd:(S==null?void 0:S.subscribeEnd)||0,subscriberStart:(S==null?void 0:S.subscribeStart)||0,videoAddNotify:(S==null?void 0:S.streamAdded)||0,state:c?1:0})}}async remoteMediaSsrcChanged(e,n,o){if(!this.connection)return!1;const c=this.remoteUserMap.get(e);if(!c)return!1;const u=c.get(n);if(!u)return!1;const m=await this.connection.getRemoteSSRC(u);return m!==void 0&&m!==o}resetConnection(e){M.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===kn.Connected?(M.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===bd.datachannel?new is({},this.store):this.isPlanB?new As({},this.store):new ur({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[n,{track:o}]=e;n===Je.LocalVideoLowTrack?o._updateRtpTransceiver(void 0,Dd.LOW_STREAM):o._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof ur&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===Ua.TCP_RESTART&&e===Xn.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,Ua.DISCONNECTED_OR_FAILED)))}}function Ao(r,e,n){const o=r[e];if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const c=this.mutex,u=await c.lock("From P2PChannel.".concat(e));try{for(var m=arguments.length,_=new Array(m),S=0;S<m;S++)_[S]=arguments[S];return await o.apply(this,_)}finally{u()}},n}function nz(r){let e=D5();return function(n,o){let c=n.appId;c!==void 0&&(ti(o,10),Fh(o,c));let u=n.cid;u!==void 0&&(ti(o,16),ti(o,u));let m=n.cname;m!==void 0&&(ti(o,26),Fh(o,m));let _=n.deviceId;_!==void 0&&(ti(o,34),Fh(o,_));let S=n.elapse;S!==void 0&&(ti(o,40),Xf(o,S));let C=n.fileSize;C!==void 0&&(ti(o,48),Xf(o,pv(C)));let R=n.height;R!==void 0&&(ti(o,56),Xf(o,pv(R)));let w=n.jpg;w!==void 0&&(ti(o,66),ti(o,w.length),function(wc,ze){let it=mv(wc,ze.length);wc.bytes.set(ze,it)}(o,w));let N=n.networkType;N!==void 0&&(ti(o,72),Xf(o,pv(N)));let L=n.osType;L!==void 0&&(ti(o,80),Xf(o,pv(L)));let H=n.requestId;H!==void 0&&(ti(o,90),Fh(o,H));let j=n.sdkVersion;j!==void 0&&(ti(o,98),Fh(o,j));let W=n.sequence;W!==void 0&&(ti(o,104),Xf(o,pv(W)));let ee=n.sid;ee!==void 0&&(ti(o,114),Fh(o,ee));let re=n.timestamp;re!==void 0&&(ti(o,120),Xf(o,re));let fe=n.uid;fe!==void 0&&(ti(o,128),ti(o,fe));let be=n.vid;be!==void 0&&(ti(o,136),ti(o,be));let _e=n.width;_e!==void 0&&(ti(o,144),Xf(o,pv(_e)));let ye=n.service;ye!==void 0&&(ti(o,152),ti(o,ye));let Le=n.callbackData;Le!==void 0&&(ti(o,162),Fh(o,Le));let Me=n.jpgEncryption;Me!==void 0&&(ti(o,168),ti(o,Me));let et=n.requestType;et!==void 0&&(ti(o,176),ti(o,et));let at=n.scorePorn;at!==void 0&&(ti(o,185),tG(o,at));let Zt=n.scoreSexy;Zt!==void 0&&(ti(o,193),tG(o,Zt));let Sn=n.scoreNeutral;Sn!==void 0&&(ti(o,201),tG(o,Sn));let gi=n.scene;gi!==void 0&&(ti(o,208),ti(o,gi));let Yr=n.ossFilePrefix;Yr!==void 0&&(ti(o,218),Fh(o,Yr));let Mi=n.serviceVendor;if(Mi!==void 0)for(let wc of Mi){ti(o,226);let ze=D5();sz(wc,ze),ti(o,ze.limit),dz(o,ze),cz(ze)}}(r,e),function(n){let o=n.bytes,c=n.limit;return o.length===c?o:o.subarray(0,c)}(e)}function iz(r){return function(n){let o={};e:for(;!P5(n);){let c=jh(n);switch(c>>>3){case 0:break e;case 1:o.code=jh(n);break;case 2:o.msg=k5(n,jh(n));break;case 3:{let u=oz(n);o.data=rz(n),n.limit=u;break}default:O5(n,7&c)}}return o}({bytes:e=r,offset:0,limit:e.length});var e}function rz(r){let e={};e:for(;!P5(r);){let n=jh(r);switch(n>>>3){case 0:break e;case 1:e.requestId=k5(r,jh(r));break;case 2:e.requestType=jh(r)>>>0;break;case 3:e.scorePorn=eG(r);break;case 4:e.scoreSexy=eG(r);break;case 5:e.scoreNeutral=eG(r);break;case 6:e.requestScene=jh(r)>>>0;break;case 7:e.scene=jh(r)>>>0;break;default:O5(r,7&n)}}return e}function sz(r,e){let n=r.service;n!==void 0&&(ti(e,8),ti(e,n));let o=r.vendor;o!==void 0&&(ti(e,16),ti(e,o));let c=r.token;c!==void 0&&(ti(e,26),Fh(e,c));let u=r.callbackUrl;u!==void 0&&(ti(e,34),Fh(e,u))}function oz(r){let e=jh(r),n=r.limit;return r.limit=r.offset+e,n}function O5(r,e){switch(e){case 0:for(;128&L5(r););break;case 2:Z3(r,jh(r));break;case 5:Z3(r,4);break;case 1:Z3(r,8);break;default:throw new Error("Unimplemented type: "+e)}}Ge([Ao,z("design:type",Function),z("design:paramtypes",[Object,Boolean]),z("design:returntype",Ee)],ws.prototype,"startP2PConnection",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Object,Object,Array,Object,String,String]),z("design:returntype",Ee)],ws.prototype,"connect",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",void 0)],ws.prototype,"updateRemoteRTPCapabilities",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Object,Object,Array,Object,String,String]),z("design:returntype",Ee)],ws.prototype,"preConnect",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ws.prototype,"publishDataChannel",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ws.prototype,"unpublish",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ws.prototype,"unpublishDataChannel",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ws.prototype,"unpublishLowStream",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,Array]),z("design:returntype",Ee)],ws.prototype,"subscribeDataChannel",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,String,Number,Number,Array]),z("design:returntype",Ee)],ws.prototype,"subscribe",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ws.prototype,"massSubscribe",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,String,Boolean]),z("design:returntype",Ee)],ws.prototype,"unsubscribe",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,Array]),z("design:returntype",Ee)],ws.prototype,"unsubscribeDataChannel",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ws.prototype,"massUnsubscribe",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,String]),z("design:returntype",Ee)],ws.prototype,"muteRemote",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,String]),z("design:returntype",Ee)],ws.prototype,"unmuteRemote",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,String]),z("design:returntype",Ee)],ws.prototype,"hasRemoteMediaWithLock",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ws.prototype,"disconnectForReconnect",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ws.prototype,"updateBitrateLimit",null),Ge([Ao,z("design:type",Function),z("design:paramtypes",[xs,String,Number]),z("design:returntype",Ee)],ws.prototype,"remoteMediaSsrcChanged",null);let az=new Float32Array(1);new Uint8Array(az.buffer);let Q3=new Float64Array(1),Ha=new Uint8Array(Q3.buffer);function pv(r){return{low:r|=0,high:r>>31,unsigned:r>=0}}let N5=[];function D5(){const r=N5.pop();return r?(r.offset=r.limit=0,r):{bytes:new Uint8Array(64),offset:0,limit:0}}function cz(r){N5.push(r)}function Z3(r,e){if(r.offset+e>r.limit)throw new Error("Skip past limit");r.offset+=e}function P5(r){return r.offset>=r.limit}function mv(r,e){let n=r.bytes,o=r.offset,c=r.limit,u=o+e;if(u>n.length){let m=new Uint8Array(2*u);m.set(n),r.bytes=m}return r.offset=u,u>c&&(r.limit=u),o}function $3(r,e){let n=r.offset;if(n+e>r.limit)throw new Error("Read past limit");return r.offset+=e,n}function k5(r,e){let n=$3(r,e),o=String.fromCharCode,c=r.bytes,u="�",m="";for(let _=0;_<e;_++){let S,C,R,w,N=c[_+n];128&N?(224&N)==192?_+1>=e?m+=u:(S=c[_+n+1],(192&S)!=128?m+=u:(w=(31&N)<<6|63&S,w<128?m+=u:(m+=o(w),_++))):(240&N)==224?_+2>=e?m+=u:(S=c[_+n+1],C=c[_+n+2],(49344&(S|C<<8))!=32896?m+=u:(w=(15&N)<<12|(63&S)<<6|63&C,w<2048||w>=55296&&w<=57343?m+=u:(m+=o(w),_+=2))):(248&N)==240?_+3>=e?m+=u:(S=c[_+n+1],C=c[_+n+2],R=c[_+n+3],(12632256&(S|C<<8|R<<16))!=8421504?m+=u:(w=(7&N)<<18|(63&S)<<12|(63&C)<<6|63&R,w<65536||w>1114111?m+=u:(w-=65536,m+=o(55296+(w>>10),56320+(1023&w)),_+=3))):m+=u:m+=o(N)}return m}function Fh(r,e){let n=e.length,o=0;for(let m=0;m<n;m++){let _=e.charCodeAt(m);_>=55296&&_<=56319&&m+1<n&&(_=(_<<10)+e.charCodeAt(++m)-56613888),o+=_<128?1:_<2048?2:_<65536?3:4}ti(r,o);let c=mv(r,o),u=r.bytes;for(let m=0;m<n;m++){let _=e.charCodeAt(m);_>=55296&&_<=56319&&m+1<n&&(_=(_<<10)+e.charCodeAt(++m)-56613888),_<128?u[c++]=_:(_<2048?u[c++]=_>>6&31|192:(_<65536?u[c++]=_>>12&15|224:(u[c++]=_>>18&7|240,u[c++]=_>>12&63|128),u[c++]=_>>6&63|128),u[c++]=63&_|128)}}function dz(r,e){let n=mv(r,e.limit),o=r.bytes,c=e.bytes;for(let u=0,m=e.limit;u<m;u++)o[u+n]=c[u]}function L5(r){return r.bytes[$3(r,1)]}function M5(r,e){let n=mv(r,1);r.bytes[n]=e}function eG(r){let e=$3(r,8),n=r.bytes;return Ha[0]=n[e++],Ha[1]=n[e++],Ha[2]=n[e++],Ha[3]=n[e++],Ha[4]=n[e++],Ha[5]=n[e++],Ha[6]=n[e++],Ha[7]=n[e++],Q3[0]}function tG(r,e){let n=mv(r,8),o=r.bytes;Q3[0]=e,o[n++]=Ha[0],o[n++]=Ha[1],o[n++]=Ha[2],o[n++]=Ha[3],o[n++]=Ha[4],o[n++]=Ha[5],o[n++]=Ha[6],o[n++]=Ha[7]}function jh(r){let e,n=0,o=0;do e=L5(r),n<32&&(o|=(127&e)<<n),n+=7;while(128&e);return o}function ti(r,e){for(e>>>=0;e>=128;)M5(r,127&e|128),e>>>=7;M5(r,e)}function Xf(r,e){let n=e.low>>>0,o=(e.low>>>28|e.high<<4)>>>0,c=e.high>>>24,u=c===0?o===0?n<16384?n<128?1:2:n<1<<21?3:4:o<16384?o<128?5:6:o<1<<21?7:8:c<128?9:10,m=mv(r,u),_=r.bytes;switch(u){case 10:_[m+9]=c>>>7&1;case 9:_[m+8]=u!==9?128|c:127&c;case 8:_[m+7]=u!==8?o>>>21|128:o>>>21&127;case 7:_[m+6]=u!==7?o>>>14|128:o>>>14&127;case 6:_[m+5]=u!==6?o>>>7|128:o>>>7&127;case 5:_[m+4]=u!==5?128|o:127&o;case 4:_[m+3]=u!==4?n>>>21|128:n>>>21&127;case 3:_[m+2]=u!==3?n>>>14|128:n>>>14&127;case 2:_[m+1]=u!==2?n>>>7|128:n>>>7&127;case 1:_[m]=u!==1?128|n:127&n}}function U5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}const lz=new Map([["moderation",1],["supervise",2]]);class rL extends Dt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(Yt.CONNECTION_STATE_CHANGE,n,e)}get inspectType(){return this._inspectType}set inspectType(e){var n;this._inspectMode=sl(n=e.map(o=>lz.get(o)||0)).call(n,(o,c)=>o+c),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),D(this,"name","AgoraRTCVideoContentInspect"),D(this,"_connectionState",$r.CONNECTING),D(this,"_innerConnectionState",void 0),D(this,"sequence",0),D(this,"inspectStartTime",void 0),D(this,"workerManagerConnection",void 0),D(this,"workerConnection",void 0),D(this,"workerMessageLengthLimit",void 0),D(this,"inspectIntervalMinimum",void 0),D(this,"qualityRatio",void 0),D(this,"_connectInfo",void 0),D(this,"_cancelTokenSource",no.CancelToken.source()),D(this,"_retryConfig",void 0),D(this,"wmSequence",0),D(this,"inspectInterval",void 0),D(this,"inspectTimer",null),D(this,"ossFilePrefix",void 0),D(this,"extraInfo",void 0),D(this,"_inspectType",void 0),D(this,"_inspectMode",void 0),D(this,"_quality",1),D(this,"qualityTimer",null),D(this,"_inspectId",void 0),D(this,"_needWorkUrlOnly",!1),D(this,"inspectImage",()=>{if(this.connectionState!==$r.CONNECTED)throw new Te(Q.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===$r.CONNECTED?this.requestToInspectImage():M.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=oi(5,"inspect-"),this.workerMessageLengthLimit=oe("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=oe("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=oe("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new _g("worker-manager-"+this._inspectId,or),this.on(Yt.STATE_CHANGE,(n,o)=>{this._innerConnectionState=n,M.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Ke[n]," ").concat(o||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new _g("worker-"+this._inspectId,or),this.handleWorkerEvents()}async init(e,n){this.emit(Yt.STATE_CHANGE,Ke.CONNECT_AP),this._connectInfo=e;const o=this._cancelTokenSource.token;return this._retryConfig=n,new Ee((c,u)=>{this.on(Yt.CONNECTION_STATE_CHANGE,(m,_)=>{_===$r.CONNECTED&&c()}),this.requestAP(e,o,n).then(m=>{this.connectWorkerManager(m)}).catch(m=>{u(m)})})}async requestAP(e,n,o){const c=oe("WEBCS_DOMAIN").map(_=>"https://".concat(_,"/api/v1")),u=await function(_,S,C,R){let{appId:w,areaCode:N,cname:L,sid:H,token:j,uid:W}=S;Vp++;const ee="image_moderation_api",re={service_name:ee,json_body:JSON.stringify({appId:w,areaCode:N,cname:L,command:"allocateEdge",requestId:Vp,seq:Vp,sid:H,token:j,ts:Date.now(),uid:W+""})};let fe,be,_e=_[0];return dc(async()=>{fe=Date.now();const ye=await zs(_e,{data:re,cancelToken:C,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(be=Date.now()-fe,ye.code!==0){const at=new Te(Q.UNEXPECTED_RESPONSE,"image inspect ap error, code"+ye.code,{retry:!0,responseTime:be});throw M.error(at.toString()),at}const Le=JSON.parse(ye.json_body);if(Le.code!==200){const at=new Te(Q.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(Le.code,", reason: ").concat(Le.reason),{code:Le.code,responseTime:be});throw M.error(at.toString()),at}if(!Le.servers||!Array.isArray(Le.servers)||Le.servers.length===0){const at=new Te(Q.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:Le.code,responseTime:be});throw M.error(at.toString()),at}const Me=oe("VIDEO_INSPECT_WORKER_MANAGER_HOST"),et=oe("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:Le.servers.map(at=>{let{address:Zt,wss:Sn}=at;if(Zt&&Sn)return"wss://".concat(Zt.replace(/\./g,"-"),".").concat(Me,":").concat(et||Sn)}).filter(at=>!!at),workerToken:Le.workerToken,vid:Le.vid,responseTime:be}},(ye,Le)=>(vt.apworkerEvent(H,{success:!0,sc:200,serviceName:ee,responseDetail:JSON.stringify(ye.addressList),firstSuccess:Le===0,responseTime:be,serverIp:_[Le%_.length]}),!1),(ye,Le)=>(vt.apworkerEvent(H,{success:!1,sc:ye.data&&ye.data.code||200,serviceName:ee,responseTime:be,serverIp:_[Le%_.length]}),!!(ye.code!==Q.OPERATION_ABORTED&&ye.code!==Q.UNEXPECTED_RESPONSE||ye.data&&ye.data.retry)&&(_e=_[(Le+1)%_.length],!0)),R)}(c,e,n,o);this.emit(Yt.STATE_CHANGE,Ke.AP_CONNECTED);const{addressList:m}=u;return this.wmSequence++,m}async connectWorkerManager(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(Yt.STATE_CHANGE,Ke.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(qe.CONNECTED,async()=>{this.emit(Yt.STATE_CHANGE,Ke.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(qe.CLOSED,()=>{this._innerConnectionState<Ke.GET_WORKER_MANAGER_RESPONSE&&M.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(qe.FAILED,()=>{this._innerConnectionState<Ke.GET_WORKER_MANAGER_RESPONSE&&M.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(qe.RECONNECTING,()=>{this._innerConnectionState<Ke.GET_WORKER_MANAGER_RESPONSE&&M.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(qe.ON_MESSAGE,async e=>{this.emit(Yt.STATE_CHANGE,Ke.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const o=JSON.parse(e.data);if(o.code!==200)throw M.error("[".concat(this._inspectId,"] Unexpected code ").concat(o.code," from worker manager")),new Te(Q.UNEXPECTED_RESPONSE,"response code of worker is unexpected",o);if(!(o.serverResponse&&o.serverResponse.portWss&&n))throw M.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(o))),new Te(Q.UNEXPECTED_RESPONSE,"response content of worker is unexpected",o);{const c=oe("VIDEO_INSPECT_WORKER_PORT")||o.serverResponse.portWss,u=n.replace(/:\d+\/?$/,":".concat(c));this.emit(Yt.STATE_CHANGE,Ke.CONNECT_WORKER,u),this._needWorkUrlOnly?this.emit(Yt.REQUEST_NEW_WORKER_URL,u):await this.connectWorker(u)}}),this.workerManagerConnection.on(qe.WILL_RECONNECT,(e,n,o)=>{o(e)}),this.workerManagerConnection.on(qe.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}handleWorkerEvents(){this.workerConnection.on(qe.CONNECTED,async()=>{this.emit(Yt.STATE_CHANGE,Ke.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=$r.CONNECTED}),this.workerConnection.on(qe.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const o=iz(new Uint8Array(e.data));if(oe("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&M.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(o)),o.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Yt.INSPECT_RESULT,void 0,void 0);if(o.data&&o.data.scorePorn&&o.data.scoreSexy&&o.data.scoreNeutral){var n;const c={porn:o.data.scorePorn,sexy:o.data.scoreSexy,neutral:o.data.scoreNeutral},u=sl(n=Object.keys(c)).call(n,(_,S)=>c[_]>c[S]?_:S,"porn"),m=Object.keys(c).find(_=>_===u);this.emit(Yt.INSPECT_RESULT,m)}else this.emit(Yt.INSPECT_RESULT,void 0,new Te(Q.UNEXPECTED_RESPONSE,o.code+"","There is an unexpected data on message"))}else this.emit(Yt.INSPECT_RESULT,void 0,new Te(Q.UNEXPECTED_RESPONSE,o.code+"",o.msg))}else M.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Yt.INSPECT_RESULT,void 0,new Te(Q.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(qe.CLOSED,()=>{this.connectionState=$r.CLOSED}),this.workerConnection.on(qe.FAILED,()=>{this.connectionState=$r.CLOSED}),this.workerConnection.on(qe.RECONNECTING,()=>{this.connectionState=this.connectionState===$r.CONNECTED?$r.RECONNECTING:$r.CONNECTING}),this.workerConnection.on(qe.WILL_RECONNECT,(e,n,o)=>{e==="recover"&&o(e),o("tryNext")}),this.workerConnection.on(qe.REQUEST_NEW_URLS,(e,n)=>{this.workerManagerConnection.close(),this.once(Yt.REQUEST_NEW_WORKER_URL,o=>{e([o])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(o=>{this.connectWorkerManager(o,!0)}).catch(o=>{n(o)})})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=mo(this,Yt.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Yt.INSPECT_RESULT,void 0,new Te(Q.INVALID_OPERATION,"Only the track being played can be inspected"));const o=await this.generateRequestData(e,n);this.workerConnection.sendMessage(o,!0,!0)}else this.emit(Yt.INSPECT_RESULT,void 0,new Te(Q.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,n){let{appId:o,cname:c,cid:u,vid:m,sid:_,uid:S}=n;const C=Date.now(),R=await e.getCurrentFrameImage("image/jpeg",this.quality),w=await ab(R,o,c),N=this.sequence+"-"+u+"-"+S+"-"+C+"-"+oi(12,""),L={appId:o,cid:u,cname:c,deviceId:"",elapse:rL.intToLong(Number(C-this.inspectStartTime)),fileSize:w.byteLength,jpgEncryption:2,height:R.height,width:R.width,jpg:w,networkType:6,osType:7,requestId:N,sdkVersion:"4.20.2",sequence:this.sequence,sid:_,timestamp:rL.intToLong(C),uid:S,vid:m,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete L.callbackData,this.ossFilePrefix===void 0&&delete L.ossFilePrefix;const H=nz(L);if(H.byteLength<this.workerMessageLengthLimit){if(oe("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const j=function(W){for(var ee=1;ee<arguments.length;ee++){var re=arguments[ee]!=null?arguments[ee]:{};ee%2?U5(Object(re),!0).forEach(function(fe){D(W,fe,re[fe])}):Object.getOwnPropertyDescriptors?Object.defineProperties(W,Object.getOwnPropertyDescriptors(re)):U5(Object(re)).forEach(function(fe){Object.defineProperty(W,fe,Object.getOwnPropertyDescriptor(re,fe))})}return W}({},L);delete j.jpg,M.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(j))}return H}{const j=this.quality*this.qualityRatio;return this.quality=j,await this.generateRequestData(e,{appId:o,cname:c,cid:u,vid:m,sid:_,uid:S})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=no.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=$r.CLOSED,this.emit(Yt.STATE_CHANGE,Ke.CLOSED)}}function uz(r){let e=function(){const n=mz.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,o){let c=n.appId;c!==void 0&&(Ar(o,10),Qf(o,c));let u=n.cid;u!==void 0&&(Ar(o,16),Ar(o,u));let m=n.cname;m!==void 0&&(Ar(o,26),Qf(o,m));let _=n.deviceId;_!==void 0&&(Ar(o,34),Qf(o,_));let S=n.elapse;S!==void 0&&(Ar(o,40),Zf(o,S));let C=n.fileSize;C!==void 0&&(Ar(o,48),Zf(o,fv(C)));let R=n.height;R!==void 0&&(Ar(o,56),Zf(o,fv(R)));let w=n.jpg;w!==void 0&&(Ar(o,66),Ar(o,w.length),V5(o,w));let N=n.networkType;N!==void 0&&(Ar(o,72),Zf(o,fv(N)));let L=n.osType;L!==void 0&&(Ar(o,80),Zf(o,fv(L)));let H=n.requestId;H!==void 0&&(Ar(o,90),Qf(o,H));let j=n.sdkVersion;j!==void 0&&(Ar(o,98),Qf(o,j));let W=n.sequence;W!==void 0&&(Ar(o,104),Zf(o,fv(W)));let ee=n.sid;ee!==void 0&&(Ar(o,114),Qf(o,ee));let re=n.timestamp;re!==void 0&&(Ar(o,120),Zf(o,re));let fe=n.uid;fe!==void 0&&(Ar(o,128),Ar(o,fe));let be=n.vid;be!==void 0&&(Ar(o,136),Ar(o,be));let _e=n.width;_e!==void 0&&(Ar(o,144),Zf(o,fv(_e)));let ye=n.service;ye!==void 0&&(Ar(o,152),Ar(o,ye));let Le=n.callbackData;Le!==void 0&&(Ar(o,162),Ar(o,Le.length),V5(o,Le));let Me=n.ticket;Me!==void 0&&(Ar(o,170),Qf(o,Me));let et=n.vendorConfigs;et!==void 0&&(Ar(o,178),Qf(o,et))}(r,e),function(n){let o=n.bytes,c=n.limit;return o.length===c?o:o.subarray(0,c)}(e)}function hz(r){return function(n){let o={};e:for(;!fz(n);){let c=E0(n);switch(c>>>3){case 0:break e;case 1:o.code=E0(n);break;case 2:o.msg=F5(n,E0(n));break;case 3:o.requestId=F5(n,E0(n));break;case 4:o.timestamp=_z(n,!1);break;default:pz(n,7&c)}}return o}({bytes:e=r,offset:0,limit:e.length});var e}function pz(r,e){switch(e){case 0:for(;128&bl(r););break;case 2:nG(r,E0(r));break;case 5:nG(r,4);break;case 1:nG(r,8);break;default:throw new Error("Unimplemented type: "+e)}}function fv(r){return{low:r|=0,high:r>>31,unsigned:r>=0}}let mz=[];function nG(r,e){if(r.offset+e>r.limit)throw new Error("Skip past limit");r.offset+=e}function fz(r){return r.offset>=r.limit}function sL(r,e){let n=r.bytes,o=r.offset,c=r.limit,u=o+e;if(u>n.length){let m=new Uint8Array(2*u);m.set(n),r.bytes=m}return r.offset=u,u>c&&(r.limit=u),o}function x5(r,e){let n=r.offset;if(n+e>r.limit)throw new Error("Read past limit");return r.offset+=e,n}function V5(r,e){let n=sL(r,e.length);r.bytes.set(e,n)}function F5(r,e){let n=x5(r,e),o=String.fromCharCode,c=r.bytes,u="�",m="";for(let _=0;_<e;_++){let S,C,R,w,N=c[_+n];128&N?(224&N)==192?_+1>=e?m+=u:(S=c[_+n+1],(192&S)!=128?m+=u:(w=(31&N)<<6|63&S,w<128?m+=u:(m+=o(w),_++))):(240&N)==224?_+2>=e?m+=u:(S=c[_+n+1],C=c[_+n+2],(49344&(S|C<<8))!=32896?m+=u:(w=(15&N)<<12|(63&S)<<6|63&C,w<2048||w>=55296&&w<=57343?m+=u:(m+=o(w),_+=2))):(248&N)==240?_+3>=e?m+=u:(S=c[_+n+1],C=c[_+n+2],R=c[_+n+3],(12632256&(S|C<<8|R<<16))!=8421504?m+=u:(w=(7&N)<<18|(63&S)<<12|(63&C)<<6|63&R,w<65536||w>1114111?m+=u:(w-=65536,m+=o(55296+(w>>10),56320+(1023&w)),_+=3))):m+=u:m+=o(N)}return m}function Qf(r,e){let n=e.length,o=0;for(let m=0;m<n;m++){let _=e.charCodeAt(m);_>=55296&&_<=56319&&m+1<n&&(_=(_<<10)+e.charCodeAt(++m)-56613888),o+=_<128?1:_<2048?2:_<65536?3:4}Ar(r,o);let c=sL(r,o),u=r.bytes;for(let m=0;m<n;m++){let _=e.charCodeAt(m);_>=55296&&_<=56319&&m+1<n&&(_=(_<<10)+e.charCodeAt(++m)-56613888),_<128?u[c++]=_:(_<2048?u[c++]=_>>6&31|192:(_<65536?u[c++]=_>>12&15|224:(u[c++]=_>>18&7|240,u[c++]=_>>12&63|128),u[c++]=_>>6&63|128),u[c++]=63&_|128)}}function bl(r){return r.bytes[x5(r,1)]}function j5(r,e){let n=sL(r,1);r.bytes[n]=e}function E0(r){let e,n=0,o=0;do e=bl(r),n<32&&(o|=(127&e)<<n),n+=7;while(128&e);return o}function Ar(r,e){for(e>>>=0;e>=128;)j5(r,127&e|128),e>>>=7;j5(r,e)}function _z(r,e){let n,o=0,c=0,u=0;return n=bl(r),o=127&n,128&n&&(n=bl(r),o|=(127&n)<<7,128&n&&(n=bl(r),o|=(127&n)<<14,128&n&&(n=bl(r),o|=(127&n)<<21,128&n&&(n=bl(r),c=127&n,128&n&&(n=bl(r),c|=(127&n)<<7,128&n&&(n=bl(r),c|=(127&n)<<14,128&n&&(n=bl(r),c|=(127&n)<<21,128&n&&(n=bl(r),u=127&n,128&n&&(n=bl(r),u|=(127&n)<<7))))))))),{low:o|c<<28,high:c>>>4|u<<24,unsigned:e}}function Zf(r,e){let n=e.low>>>0,o=(e.low>>>28|e.high<<4)>>>0,c=e.high>>>24,u=c===0?o===0?n<16384?n<128?1:2:n<1<<21?3:4:o<16384?o<128?5:6:o<1<<21?7:8:c<128?9:10,m=sL(r,u),_=r.bytes;switch(u){case 10:_[m+9]=c>>>7&1;case 9:_[m+8]=u!==9?128|c:127&c;case 8:_[m+7]=u!==8?o>>>21|128:o>>>21&127;case 7:_[m+6]=u!==7?o>>>14|128:o>>>14&127;case 6:_[m+5]=u!==6?o>>>7|128:o>>>7&127;case 5:_[m+4]=u!==5?128|o:127&o;case 4:_[m+3]=u!==4?n>>>21|128:n>>>21&127;case 3:_[m+2]=u!==3?n>>>14|128:n>>>14&127;case 2:_[m+1]=u!==2?n>>>7|128:n>>>7&127;case 1:_[m]=u!==1?128|n:127&n}}const B5={},G5={},oL=4294967296,Ez=oL*oL,W5=Ez/2;K5(0,!0);const H5=K5(0),gz=g0(0,-2147483648,!1),Sz=g0(-1,2147483647,!1);function K5(r,e){let n,o,c;return e?(c=0<=(r>>>=0)&&r<256)&&(o=G5[r],o)?o:(n=g0(r,0,!0),c&&(G5[r]=n),n):(c=-128<=(r|=0)&&r<128)&&(o=B5[r],o)?o:(n=g0(r,r<0?-1:0,!1),c&&(B5[r]=n),n)}function g0(r,e,n){return{low:0|r,high:0|e,unsigned:!!n}}function Tz(r,e){if(isNaN(r))return H5;{if(r<=-W5)return gz;if(r+1>=W5)return Sz}return r<0?H5:g0(r%oL|0,r/oL|0,e)}function Y5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}class iG extends Dt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(Rs.CONNECTION_STATE_CHANGE,e,n)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var n;super(),D(this,"name","AgoraRTCImageModeration"),D(this,"_connectionState",ci.CONNECTING),D(this,"_sequence",0),D(this,"_moderationStartTime",void 0),D(this,"_workerConnection",void 0),D(this,"_workerMessageLengthLimit",void 0),D(this,"_qualityRatio",void 0),D(this,"_connectInfo",void 0),D(this,"_cancelTokenSource",no.CancelToken.source()),D(this,"_retryConfig",void 0),D(this,"_moderationInterval",void 0),D(this,"_moderationTimer",null),D(this,"_moderationMode",1),D(this,"_quality",1),D(this,"_qualityTimer",null),D(this,"_ticket",void 0),D(this,"_moderationIntervalMinimum",void 0),D(this,"_uploadFailedNum",0),D(this,"_uploadNum",0),D(this,"_uploadTimer",null),D(this,"_extraInfo",void 0),D(this,"_vendor",""),D(this,"_encoder",new TextEncoder),D(this,"_moderationId",void 0),D(this,"inspectImage",()=>{if(this.connectionState!==ci.CONNECTED)throw new Te(Q.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===ci.CONNECTED?this.requestToInspectImage():M.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=oi(5,"image-moderation-"),this._workerMessageLengthLimit=oe("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=oe("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=oe("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new _g("worker-"+this._moderationId,or),this.on(Rs.STATE_CHANGE,(o,c)=>{M.debug("[".concat(this._moderationId,"] Moderation operation :").concat(mi[o]," ").concat(c||""))}),this.handleWorkerEvents()}async init(e,n){this.emit(Rs.STATE_CHANGE,mi.CONNECT_AP),this._connectInfo=e;const o=this._cancelTokenSource.token;return this._retryConfig=n,new Ee((c,u)=>{this.on(Rs.CONNECTION_STATE_CHANGE,(m,_)=>{m===ci.CONNECTED&&c()}),this.requestAP(e,o,n).then(m=>{this.connectWorker(m)}).catch(m=>{u(m)})})}updateConfig(e){var n;this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),M.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===ci.CONNECTED&&this.inspectImage()}async requestAP(e,n,o){const c=oe("WEBCS_DOMAIN").map(S=>"https://".concat(S,"/api/v1")),u=await function(S,C,R,w){let{appId:N,areaCode:L,cname:H,sid:j,token:W,uid:ee}=C;Vp++;const re="moderation_plugin",fe={service_name:re,json_body:JSON.stringify({appId:N,areaCode:L,cname:H,command:"allocateEdge",requestId:Vp,seq:Vp,sid:j,appToken:W,ts:Date.now(),uid:ee+""})};let be,_e,ye=S[0];return dc(async()=>{be=Date.now();const Le=await zs(ye,{data:fe,cancelToken:R,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(_e=Date.now()-be,Le.code!==0){const at=new Te(Q.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+Le.code,{retry:!0,responseTime:_e});throw M.error(at.toString()),at}const Me=JSON.parse(Le.json_body);if(Me.code!==200){const at=new Te(Q.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(Me.code,", reason: ").concat(Me.reason),{code:Me.code,responseTime:_e});throw M.error(at.toString()),at}if(!Me.servers||!Array.isArray(Me.servers)||Me.servers.length===0){const at=new Te(Q.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:Me.code,responseTime:_e});throw M.error(at.toString()),at}if(!Me.servers.some(at=>!!at.wss)){const at=new Te(Q.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:Me.code,responseTime:_e});throw M.error(at.toString()),at}const et=oe("IMAGE_MODERATION_WORKER_HOST");return{addressList:Me.servers.map(at=>{let{address:Zt,wss:Sn}=at;if(Zt&&Sn)return"wss://".concat(Zt.replace(/\./g,"-"),".").concat(et,":").concat(Sn,"/moderation")}).filter(at=>!!at),workerToken:Me.workerToken,vid:Me.vid,ticket:Me.appTicket,responseTime:_e}},(Le,Me)=>(vt.apworkerEvent(j,{success:!0,sc:200,serviceName:re,responseDetail:JSON.stringify(Le.addressList),firstSuccess:Me===0,responseTime:_e,serverIp:S[Me%S.length]}),!1),(Le,Me)=>(vt.apworkerEvent(j,{success:!1,sc:Le.data&&Le.data.code||200,serviceName:re,responseTime:_e,serverIp:S[Me%S.length]}),!!(Le.code!==Q.OPERATION_ABORTED&&Le.code!==Q.UNEXPECTED_RESPONSE||Le.data&&Le.data.retry)&&(ye=S[(Me+1)%S.length],!0)),w)}(c,e,n,o);this.emit(Rs.STATE_CHANGE,mi.AP_CONNECTED);const{addressList:m,ticket:_}=u;return this._ticket=_,m}async connectWorker(e){this.emit(Rs.STATE_CHANGE,mi.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(qe.CONNECTED,async()=>{this.emit(Rs.STATE_CHANGE,mi.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=ci.CONNECTED}),this._workerConnection.on(qe.CLOSED,()=>{this.connectionState=ci.CLOSED}),this._workerConnection.on(qe.FAILED,()=>{this.connectionState=ci.CLOSED}),this._workerConnection.on(qe.RECONNECTING,()=>{this.connectionState=this.connectionState===ci.CONNECTED?ci.RECONNECTING:ci.CONNECTING}),this._workerConnection.on(qe.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const n=hz(new Uint8Array(e.data));oe("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&M.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,M.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{vt.reportApiInvoke(this._connectInfo.sid||null,{name:Si.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:wi.TRACER}).onError(new Te(Q.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null},oe("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else M.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(qe.WILL_RECONNECT,(e,n,o)=>{e==="recover"&&o(e),o("tryNext")}),this._workerConnection.on(qe.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=mo(this,Rs.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(oe("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&M.debug("Only the track being played can be inspected"));this._sequence++;const o=await this.generateRequestData(e,n);this._workerConnection.sendMessage(o,!0,!0)}else oe("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&M.debug("Only the track being published can be inspected")}async generateRequestData(e,n){let{appId:o,cname:c,cid:u,vid:m,sid:_,uid:S}=n;const C=Date.now(),R=await e.getCurrentFrameImage("image/jpeg",this.quality),w=await ab(R,o,c),N=this._sequence+"-"+u+"-"+S+"-"+C+"-"+oi(12,""),L={appId:o,cid:u,cname:c,deviceId:"",elapse:iG.intToLong(Number(C-this._moderationStartTime)),fileSize:R.buffer.byteLength,height:R.height,width:R.width,jpg:w,networkType:6,osType:7,requestId:N,sdkVersion:"4.20.2",sequence:this._sequence,sid:_,timestamp:Tz(C),uid:S,vid:m,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete L.callbackData;const H=uz(L);if(H.byteLength<this._workerMessageLengthLimit){if(oe("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const j=function(W){for(var ee=1;ee<arguments.length;ee++){var re=arguments[ee]!=null?arguments[ee]:{};ee%2?Y5(Object(re),!0).forEach(function(fe){D(W,fe,re[fe])}):Object.getOwnPropertyDescriptors?Object.defineProperties(W,Object.getOwnPropertyDescriptors(re)):Y5(Object(re)).forEach(function(fe){Object.defineProperty(W,fe,Object.getOwnPropertyDescriptor(re,fe))})}return W}({},L);delete j.jpg,M.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(j))}return H}{const j=this.quality*this._qualityRatio;return this.quality=j,await this.generateRequestData(e,{appId:o,cname:c,cid:u,vid:m,sid:_,uid:S})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=no.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=ci.CLOSED,this.emit(Rs.STATE_CHANGE,mi.CLOSED)}}function z5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function q5(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?z5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):z5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}const Cz=Date.now(),vz=20,rG=new Map,aL=new Map;async function J5(r){const e=rG.get(r),n=Array.isArray(e)&&e[e.length-1],o=aL.get(r);if(!n)return void(o.isSyncing=!1);const c={uid:n.uid,payload:n.payload};o.firstRecvTs===0&&(o.firstRecvTs=n.recvTs,o.firstSendTs=n.sendTs);const u=n.sendTs-o.firstSendTs,m=u-(Date.now()-o.firstRecvTs);m>0&&(o.firstRecvTs=Date.now()-u);let _=n.mediaDelay+m;_<=0?(e.pop(),X5(n.context,c),_=0):_=Math.min(_,vz),setTimeout(()=>e.length&&J5(r),_)}function X5(r,e){r.safeEmit(hn.STREAM_MESSAGE,e.uid,e.payload),r.onStreamMessage&&r.onStreamMessage(e)}function Rz(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!r.syncWithAudio)return X5(n,{uid:r.uid,payload:r.payload});const o="".concat(n.id,"-").concat(r.uid),c=rG.get(o)||[],u=c.findIndex(C=>r.sendTs>=C.sendTs),m=q5(q5({},r),{},{context:n,mediaDelay:e,recvTs:Date.now()});u===-1?c.push(m):c.splice(u,0,m),rG.set(o,c);let _=!1;var S;aL.has(o)?_=!((S=aL.get(o))===null||S===void 0||!S.isSyncing):aL.set(o,{isSyncing:_,firstRecvTs:0,firstSendTs:0}),_||J5(o)}const yz=qt().name;function Iz(){return!function(r,e,n){const o=qt();if(o.os!==ar.IOS||!o.osVersion)return!1;const c=o.osVersion.split(".");return Number(c[0])<r}(16)&&!function(r,e,n){const o=qt();if(o.name!==Pn.SAFARI||!o.osVersion)return!1;const c=o.version.split(".");return Number(c[0])<r}(16)}function Q5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function xu(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Q5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):Q5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}Zr.setLogger(M);class ni extends Dt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let n;if(super(),D(this,"store",void 0),D(this,"_uid",void 0),D(this,"_channelName",void 0),D(this,"_uintUid",void 0),D(this,"_users",[]),D(this,"_config",void 0),D(this,"_clientId",void 0),D(this,"_appId",void 0),D(this,"_sessionId",null),D(this,"_key",void 0),D(this,"_rtmConfig",{}),D(this,"_joinInfo",void 0),D(this,"_gateway",void 0),D(this,"_statsCollector",void 0),D(this,"_configDistribute",void 0),D(this,"_leaveMutex",new Zr("client-leave")),D(this,"_publishMutex",new Zr("client-publish")),D(this,"_renewTokenMutex",new Zr("client-renewtoken")),D(this,"_subscribeMutex",new Zr("client-subscribe")),D(this,"_encryptionMode","none"),D(this,"_encryptionSecret",null),D(this,"_encryptionSalt",null),D(this,"_encryptDataStream",!1),D(this,"_encryptDataStreamKey",null),D(this,"_encryptDataStreamIv",null),D(this,"_proxyServer",void 0),D(this,"_turnServer",{servers:[],mode:"auto"}),D(this,"_cloudProxyServerMode","disabled"),D(this,"_isDualStreamEnabled",!1),D(this,"_defaultStreamFallbackType",void 0),D(this,"_lowStreamParameter",void 0),D(this,"_streamFallbackTypeCacheMap",new Map),D(this,"_remoteStreamTypeCacheMap",new Map),D(this,"_axiosCancelSource",no.CancelToken.source()),D(this,"_audioVolumeIndicationInterval",void 0),D(this,"_networkQualityInterval",void 0),D(this,"_userOfflineTimeout",void 0),D(this,"_streamRemovedTimeout",void 0),D(this,"_injectStreamingClient",void 0),D(this,"_liveTranscodeStreamingClient",void 0),D(this,"_liveRawStreamingClient",void 0),D(this,"_channelMediaRelayClient",void 0),D(this,"_networkQualitySensitivity","normal"),D(this,"_p2pChannel",void 0),D(this,"_useLocalAccessPoint",!1),D(this,"_setLocalAPVersion",void 0),D(this,"_joinAndNotLeaveYet",!1),D(this,"_numberOfJoinCount",0),D(this,"_remoteDefaultVideoStreamType",void 0),D(this,"_inspect",void 0),D(this,"_moderation",void 0),D(this,"_license",void 0),D(this,"_pendingPublishedUsers",[]),D(this,"ntpAlignErrorCount",0),D(this,"remoteInboundOffset",0),D(this,"_handleLocalTrackEnable",(o,c,u)=>{this.publish(o,!1).then(c).catch(u)}),D(this,"_handleLocalTrackDisable",(o,c,u)=>{this.unpublish(o).then(c).catch(u)}),D(this,"_handleUserOnline",o=>{if(oe("BLOCK_LOCAL_CLIENT")&&Tt(o.uid,this.channelName))return void M.debug("[".concat(o.uid,"] will be ignored in local"));this.isStringUID&&typeof o.uid!="string"&&M.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const c=this._users.find(u=>u.uid===o.uid);if(c)c._trust_in_room_=!0,c._is_pre_created&&(c._is_pre_created=!1,this.safeEmit(hn.USER_JOINED,c));else{const u=new xs(o.uid,o.uint_id||o.uid);this._users.push(u),M.debug("[".concat(this._clientId,"] user online"),o.uid),this.safeEmit(hn.USER_JOINED,u)}}),D(this,"_handleUserOffline",o=>{if(oe("BLOCK_LOCAL_CLIENT")&&Tt(o.uid,this.channelName))return;const c=this._users.find(u=>u.uid===o.uid);c&&(this._handleRemoveStream(o),this._handleRemoveDataChannels(o),c._audio_pre_subscribed||c._video_pre_subscribed?c._is_pre_created=!0:ef(this._users,c),this._remoteStreamTypeCacheMap.delete(c.uid),this._streamFallbackTypeCacheMap.delete(c.uid),M.debug("[".concat(this._clientId,"] user offline"),o.uid,"reason:",o.reason),this.safeEmit(hn.USER_LEAVED,c,o.reason))}),D(this,"_handleAddAudioOrVideoStream",(o,c,u,m,_,S,C)=>{if(oe("BLOCK_LOCAL_CLIENT")&&Tt(c,this.channelName))return;const R=this._users.find(N=>N.uid===c);if(!R)return void M.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));M.debug("[".concat(this._clientId,"] stream added with uid ").concat(c,", type ").concat(o)),this.store.subscribe(R.uid,o,void 0,void 0,void 0,Date.now());const w=o==="audio"?R.hasAudio:R.hasVideo;R._uintid||(R._uintid=_||c),o==="audio"?R._trust_audio_stream_added_state_=!0:R._trust_video_stream_added_state_=!0,o==="audio"?(R._audio_added_=!0,u!==void 0&&(R._audioSSRC=u),m!==void 0&&(R._cname=m),S&&(R._audioOrtc=S)):(R._video_added_=!0,u!==void 0&&(R._videoSSRC=u),m!==void 0&&(R._cname=m),C!==void 0&&(R._rtxSsrcId=C),S&&(R._videoOrtc=S)),(o==="audio"?R.hasAudio:R.hasVideo)&&!w&&(M.info("[".concat(this._clientId,"] remote user ").concat(R.uid," published ").concat(o)),this.safeEmit(hn.USER_PUBLISHED,R,o)),o==="video"?vt.onGatewayStream(this._sessionId,x.ON_ADD_VIDEO_STREAM,pi.ON_ADD_VIDEO_STREAM,{peer:_||c,ssrc:R._videoSSRC}):vt.onGatewayStream(this._sessionId,x.ON_ADD_AUDIO_STREAM,pi.ON_ADD_AUDIO_STREAM,{peer:_||c,ssrc:R._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(R,o,u).then(N=>{if(N&&(M.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(R.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof ws))return this._p2pChannel.unsubscribe(R,o,!0).then(()=>this._subscribe(R,o,!0).catch(L=>{M.error("[".concat(this._clientId,"] resubscribe error"),L.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(R,o)&&(M.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(R.uid," after reconnect.")),this._subscribe(R,o,!0).catch(N=>{M.error("[".concat(this._clientId,"] resubscribe error"),N.toString())}))}),D(this,"_handleRemoveStream",o=>{if(oe("BLOCK_LOCAL_CLIENT")&&Tt(o.uid,this.channelName))return;const c=this._users.find(m=>m.uid===o.uid);if(!c)return void M.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));M.debug("[".concat(this._clientId,"] stream removed with uid ").concat(o.uid));let u=()=>{};c.hasAudio&&c.hasVideo?u=()=>{M.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished audio track")),this.safeEmit(hn.USER_UNPUBLISHED,c,"audio"),M.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished video track")),this.safeEmit(hn.USER_UNPUBLISHED,c,"video")}:c.hasVideo?u=()=>{M.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished video track")),this.safeEmit(hn.USER_UNPUBLISHED,c,"video")}:c.hasAudio&&(u=()=>{M.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished audio track")),this.safeEmit(hn.USER_UNPUBLISHED,c,"audio")}),c._video_pre_subscribed||c._audio_pre_subscribed||(c._trust_audio_stream_added_state_=!0,c._trust_video_stream_added_state_=!0,c._audio_added_=!1,c._video_added_=!1,this._p2pChannel instanceof ws&&this._p2pChannel.unsubscribe(c).then(m=>{if(m)return this._gateway.unsubscribe(m,c.uid)}),c._audioSSRC=void 0,c._videoSSRC=void 0,c._audioOrtc=void 0,c._videoOrtc=void 0,c._rtxSsrcId=void 0),vt.onGatewayStream(this._sessionId,x.ON_REMOVE_STREAM,pi.ON_REMOVE_STREAM,{peer:o.uint_id||o.uid}),u()}),D(this,"_handleSetStreamLocalEnable",(o,c,u)=>{if(oe("BLOCK_LOCAL_CLIENT")&&Tt(c,this.channelName))return;const m=this._users.find(C=>C.uid===c);if(!m)return void M.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));M.debug("[".concat(this._clientId,"] local ").concat(o," ").concat(u?"enabled":"disabled"," with uid ").concat(c));const _=o==="audio"?m.hasAudio:m.hasVideo;if(o==="audio"){m._trust_audio_enabled_state_=!0;const C=m._audio_enabled_;if(m._audio_enabled_=u,m._audio_enabled_===C)return;{const R=m._audio_enabled_?"enable-local-audio":"disable-local-audio";M.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(c,", msg: ").concat(R)),this.safeEmit(hn.USER_INFO_UPDATED,c,R)}}else{m._trust_video_enabled_state_=!0;const C=m._video_enabled_;if(m._video_enabled_=u,m._video_enabled_===C)return;{const R=m._video_enabled_?"enable-local-video":"disable-local-video";M.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(c,", msg: ").concat(R)),this.safeEmit(hn.USER_INFO_UPDATED,c,R)}}const S=o==="audio"?m.hasAudio:m.hasVideo;return _!==S?!_&&S?(M.info("[".concat(this._clientId,"] remote user ").concat(c," published ").concat(o)),void this.safeEmit(hn.USER_PUBLISHED,m,o)):(o==="video"&&m._videoTrack&&m._videoTrack._destroy(),o==="audio"&&m._audioTrack,this._p2pChannel.muteRemote(m,o),M.info("[".concat(this._clientId,"] remote user ").concat(c," unpublished ").concat(o)),void this.safeEmit(hn.USER_UNPUBLISHED,m,o)):void 0}),D(this,"_handleMuteStream",(o,c,u)=>{if(oe("BLOCK_LOCAL_CLIENT")&&Tt(o,this.channelName))return;M.debug("[".concat(this._clientId,"] receive mute message"),o,c,u);const m=this._users.find(C=>C.uid===o);if(!m)return void M.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o));const _=c==="audio"?m.hasAudio:m.hasVideo;if(c==="audio"){m._trust_audio_mute_state_=!0;const C=m._audio_muted_;if(m._audio_muted_=u,m._audio_muted_===C)return;{const R=m._audio_muted_?"mute-audio":"unmute-audio";M.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(R)),this.safeEmit(hn.USER_INFO_UPDATED,o,R)}}else{m._trust_video_mute_state_=!0;const C=m._video_muted_;if(m._video_muted_=u,m._video_muted_===C)return;{const R=m._video_muted_?"mute-video":"unmute-video";M.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(R)),this.safeEmit(hn.USER_INFO_UPDATED,o,R)}}const S=c==="audio"?m.hasAudio:m.hasVideo;if(_!==S){if(!_&&S)return(c==="audio"?m._audioSSRC:m._videoSSRC)?(M.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(c)),void this.safeEmit(hn.USER_PUBLISHED,m,c)):void M.warning("[".concat(this._clientId,"] remote user ").concat(o," receive ").concat(c," unmute message  before add stream message, ").concat(c," SSRC doesn't exist yet."));c==="video"&&m._videoTrack&&!m._video_pre_subscribed&&m._videoTrack._destroy(),c==="audio"&&m._audioTrack,this._p2pChannel.muteRemote(m,c),M.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(c)),this.safeEmit(hn.USER_UNPUBLISHED,m,c)}}),D(this,"_handleP2PLost",async o=>{M.debug("[".concat(this._clientId,"] receive p2p lost"),o),parseInt(o.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():M.warning("[".concat(this._clientId,"] P2PLost stream not found"),o)}),D(this,"_handleTokenWillExpire",()=>{M.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(hn.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),D(this,"_handleBeforeUnload",o=>{o.type==="beforeunload"&&o.returnValue!==void 0&&o.returnValue!==""||(this.leave(),M.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),D(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(hn.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const o={downlinkNetworkQuality:0,uplinkNetworkQuality:0};o.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),o.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(hn.NETWORK_QUALITY,o)}),D(this,"_handleP2PAddAudioOrVideoStream",(o,c,u,m)=>{const _=this._users.find(C=>C.uid===c);if(!_)return void M.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));M.debug("[".concat(this._clientId,"] stream added with uid ").concat(c,", type ").concat(o)),this.store.subscribe(_.uid,o,void 0,void 0,void 0,Date.now());const S=o==="audio"?_.hasAudio:_.hasVideo;o==="audio"?_._trust_audio_stream_added_state_=!0:_._trust_video_stream_added_state_=!0,o==="audio"?(_._audio_added_=!0,u!==void 0&&(_._audioSSRC=u),m!==void 0&&(_._audioMid=m)):(_._video_added_=!0,u!==void 0&&(_._videoSSRC=u),m!==void 0&&(_._videoMid=m)),(o==="audio"?_.hasAudio:_.hasVideo)&&!S&&(M.info("[".concat(this._clientId,"] remote user ").concat(_.uid," published ").concat(o)),this.safeEmit(hn.USER_PUBLISHED,_,o)),this._p2pChannel.hasPendingRemoteMedia(_,o)&&(M.debug("[".concat(this._clientId,"] resubscribe ").concat(o," for user ").concat(_.uid," after reconnect.")),this._subscribe(_,o,!0).catch(C=>{M.error("[".concat(this._clientId,"] resubscribe error"),C.toString())}))}),this._config=e,this._clientId=oi(5,"client-"),this.store=new Rw(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),M.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(mr," build: ").concat(cf,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{rh(e.clientRoleOptions),n=Object.assign({},e.clientRoleOptions)}catch(o){M.warning("[".concat(this._clientId,"] ").concat(o.toString()))}this._statsCollector=new m0(this.store),this._statsCollector.onStatsException=(o,c,u)=>{M.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(o,", msg: ").concat(c,", uid: ").concat(u)),this.safeEmit(hn.EXCEPTION,{code:o,msg:c,uid:u})},this._statsCollector.onUploadPublishDuration=(o,c,u,m)=>{const _=this._users.find(S=>S.uid===o);_&&vt.peerPublishStatus(this._sessionId,{subscribeElapse:m,audioPublishDuration:c,videoPublishDuration:u,peer:_._uintid})},this.store.useDataChannel=Dn().supportDataChannel&&oe("SIGNAL_CHANNEL"),this.store.useP2P=e.mode==="p2p",this._gateway=new xp(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||or,httpRetryConfig:e.httpRetryConfig||or,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:n}),this._configDistribute=new NP,this.store.useP2P?(this._p2pChannel=new ns(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new ws(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,n,o,c,u){let m=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],_=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Kn("JOIN_GATEWAY_USE_443PORT_ONLY",m),Kn("JOIN_GATEWAY_USE_DUAL_DOMAIN",_);const S=this._gateway.signal.websocket;return S instanceof fg&&(S.use443PortOnly=m,S.tryDoubleDomain=_),async function(C,R,w){jc.get(C)||jc.set(C,[]),qm.get(C)||qm.set(C,R),En.get(C)||En.set(C,0);const N=jc.get(C),L=qm.get(C);if(!N||!L)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(En.get(C)===L){const re=zm();N.push(re),await re.promise}En.set(C,En.get(C)+1);for(var H=arguments.length,j=new Array(H>3?H-3:0),W=3;W<H;W++)j[W-3]=arguments[W];const ee=await w(...j);return En.set(C,En.get(C)-1),En.get(C)===L-1&&N.length>0&&(N[0].resolve(),N.shift()),En.get(C)===0&&(jc.set(C,[]),qm.set(C,0),En.set(C,0)),ee}("client.join",oe("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,n,o,c,u)}async join(e,n,o,c,u){const m=++this._numberOfJoinCount;this.store.joinStart(),c&&(this.store.uid=c);const _=KB(),S=da()?window.isSecureContext:"Browser Not Support";(!da()&&!_||!window.isSecureContext)&&M.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");const C=qA();this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),M.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const R=vt.reportApiInvoke(C,{name:Si.JOIN,options:[e,n,o,c],states:{isHttps:_,isSecureContext:S},tag:wi.TRACER});vt.setAppId(e);try{if(!o&&o!==null)throw new Te(Q.INVALID_PARAMS,"Invalid token: ".concat(o,". If you don not use token, set it to null"));o&&Xr(o,"token",1,2047),Xr(e,"appid",1,2047),Ow(n),c&&hc(c),u&&Xr(u,"optionalInfo",1,2047)}catch(j){throw R.onError(j),j}if(M.info("[".concat(this._clientId,"] start join channel ").concat(n,", join number: ").concat(m)),this._leaveMutex.isLocked&&(M.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),M.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const j=new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw R.onError(j),j}this._sessionId||(this._sessionId=C,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const w=xu(xu({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:n,uid:typeof c!="string"?c:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:o||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:u,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(w.setLocalAPVersion=this._setLocalAPVersion),typeof c=="string"&&(w.stringUid=c,this._uintUid?(w.uid=this._uintUid,this._uintUid=void 0):w.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(w.aesmode=this._encryptionMode,w.aespassword=await WA(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(w.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const j=new TextEncoder,W=oe("USE_PURE_ENCRYPTION_MASTER_KEY")?j.encode(w.appId+this._encryptionSecret+this._encryptionSecret):j.encode(w.appId+w.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(ee,re,fe){const be=await window.crypto.subtle.importKey("raw",re,"PBKDF2",!1,["deriveBits","deriveKey"]),_e=ee==="aes-128-gcm2"?128:256,ye=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:ce,hash:"SHA-256",salt:fe},be,_e+ei);return new Uint8Array(ye).subarray(_e/8)}(this._encryptionMode,W,ca(this._encryptionSalt)),this._encryptDataStreamKey=await async function(ee,re,fe){const be=await window.crypto.subtle.importKey("raw",re,"PBKDF2",!1,["deriveBits","deriveKey"]),_e=ee==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:ce,hash:"SHA-256",salt:fe},be,{name:"AES-GCM",length:_e},!0,["encrypt","decrypt"])}(this._encryptionMode,W,ca(this._encryptionSalt))}else S?M.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):M.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,M.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:n,appId:e,stringUid:w.stringUid});const N=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&N===this._sessionId&&vt.joinChannelTimeout(this._sessionId,5)},5e3);try{var L;let j;const W=w.cloudProxyServer;if(xe(L=["proxy3","proxy4","proxy5"]).call(L,W)){const _e=oe("PROXY_SERVER_TYPE3");Array.isArray(_e)?w.proxyServer=_e[0]:w.proxyServer=_e}if(vt.setProxyServer(w.proxyServer),M.setProxyServer(w.proxyServer),this.store.requestAPStart(),w.stringUid&&!w.uid){let _e;[_e,j]=await Ee.all([jp(w.stringUid,w,this._axiosCancelSource.token,this._config.httpRetryConfig||or,this.store),AP(w,this._axiosCancelSource.token,this._config.httpRetryConfig||or,!0,this.store)]),M.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(w.stringUid," => ").concat(_e)),w.uid=_e,j.gatewayInfo.uid=_e,j.gatewayInfo.res.uid=_e}else j=await AP(w,this._axiosCancelSource.token,this._config.httpRetryConfig||or,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(w,this._axiosCancelSource.token),this._configDistribute.on(Cn.UPDATE_BITRATE_LIMIT,_e=>{this._p2pChannel.updateBitrateLimit(_e)})},0),this._key=o||e;const ee=j.gatewayInfo,re=w.uid?w.uid:ee.uid;this._joinInfo=xu(xu({},w),{},{cid:ee.cid,uid:re,vid:ee.vid,apResponse:ee.res,uni_lbs_ip:ee.uni_lbs_ip,gatewayAddrs:ee.gatewayAddrs}),this.store.intUid=re;const fe=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));R.onSuccess(fe),this._appId=e,this._channelName=w.cname,this._uid=fe,this.store.uid=fe,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Jr()?"beforeunload":"pagehide",this._handleBeforeUnload)},0);const be=w.stringUid?"string uid: ".concat(w.stringUid,",uid: ").concat(w.uid):"uid: ".concat(this._uid);return M.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(n,",").concat(be)),setTimeout(()=>{M.startUpload()},5e3),this.store.joinEnd(),H=this,xe(bt).call(bt,H)||bt.push(H),fe}catch(j){const W=Array.isArray(j)?j[0]:j;throw W&&W.code===Q.OPERATION_ABORTED?M.warning("[".concat(this._clientId,"] join number: ").concat(m,", Joining channel failed, rollback"),W):M.error("[".concat(this._clientId,"] join number: ").concat(m,", Joining channel failed, rollback"),W),W.code!==Q.OPERATION_ABORTED&&this._numberOfJoinCount===m&&(this._gateway.state="DISCONNECTED",this._reset()),R.onError(W),W}var H}_joinGateway(){if(!this._joinInfo||!this._key)throw new Te(Q.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!oe("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(e=>e).catch(e=>{if(e.code===Q.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,un.FALLBACK),e;if(e.code===Q.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,un.FALLBACK),e;throw e}).then(e=>{if(e instanceof Te){if(e.code===Q.INIT_WEBSOCKET_TIMEOUT){if(M.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new Te(Q.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const n=oe("PROXY_SERVER_TYPE3");if(Array.isArray(n))if(this._joinInfo.apUrl){const c=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),u=c.slice(c.length-2).join(".");n.forEach(m=>{this._joinInfo&&xe(m).call(m,u)&&(this._joinInfo.proxyServer=m)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=n[0])}else this._joinInfo.proxyServer=n[0];else this._joinInfo.proxyServer=n;const o=oe("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return o&&o[1]&&o[1]!=="443"&&M.setProxyServer(this._joinInfo.proxyServer),oe("STATS_COLLECTOR_PORT").toString()!=="443"&&vt.setProxyServer(this._joinInfo.proxyServer),vt.reportApiInvoke(this._sessionId,{name:Si.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:wi.TRACER}).onSuccess(),this.safeEmit(hn.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),oe("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(c=>{"forceturn"in c&&(c.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(M.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new Te(Q.INVALID_OPERATION);return vt.reportApiInvoke(this._sessionId,{name:Si.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:wi.TRACER}).onSuccess(),this._joinGateway()}return e}).then(e=>e)}async leave(){M.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Jr()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(n){const o=bt.indexOf(n);o!==-1&&bt.splice(o,1)}(this);const e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return M.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED"),M.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof di))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new Te(Q.INVALID_PARAMS,"param list is empty");const o=e;if(this._gateway.role==="audience")throw new Te(Q.INVALID_OPERATION,"audience can not publish stream");for(const u of o){if(!(u instanceof di))throw new Te(Q.INVALID_PARAMS,"parameter is not local track");if(!u._enabled&&n)throw new Te(Q.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(u.getTrackId()))}M.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(o.map(u=>"".concat(u.getTrackId()," "))));const c=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),n&&o.forEach(u=>{const m=this._configDistribute.getBitrateLimit();u instanceof on&&m&&u.setBitrateLimit(m.uplink)});try{await this._publishHighStream(o),M.info("[".concat(this._clientId,"] Publish success, id ").concat(o.map(u=>"".concat(u.getTrackId()," "))))}catch(u){throw M.error("[".concat(this._clientId,"] publish error"),u.toString()),u}finally{c()}}async _publishDataChannel(e){Jn(e.id,"id",0,65535,!0),nl(e.ordered,"ordered"),Xr(e.metadata,"metadata",0,512),M.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const n=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(c=>c.id===e.id)!==-1)throw new Te(Q.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new Te(Q.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&oe("FORCE_TURN")&&!oe("TURN_ENABLE_TCP")&&!oe("TURN_ENABLE_UDP"))throw new Te(Q.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const o=new R3(e);if(await this._p2pChannel.publishDataChannel([o]),!this._p2pChannel.isP2PDisconnected()){if(typeof o._originDataChannelId!="number")throw M.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new Te(Q.CREATE_DATACHANNEL_ERROR);try{const c={streamId:e.id,ordered:e.ordered,maxRetransmits:oe("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:o._originDataChannelId};await this._gateway.publishDataChannel(this._uid,c,!0),await o._waitTillOpen()}catch(c){if(c.code!==Q.DISCONNECT_P2P)throw c}}return M.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(o.id)),o}catch(o){throw M.error("[".concat(this._clientId,"] publish datachannels error"),o.toString()),o}finally{n()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new Te(Q.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let n=[];if(e)if(Array.isArray(e))n=e;else{if(!(e instanceof di))return this._unpublishDataChannel([e]);n=[e]}else this.store.useP2P||await this._unpublishDataChannel(),n=this._p2pChannel.getAllTracks(!0);M.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(n.map(c=>"".concat(c.getTrackId()," "))," "));const o=await this._publishMutex.lock();try{if(this._p2pChannel instanceof ns){const c=await this._p2pChannel.unpublish(n);c&&await this._gateway.sendExtensionMessage(Qn.UNPUBLISH,{unpubMsg:c},!0)}else{const c=await this._p2pChannel.unpublish(n);c&&await this._gateway.unpublish(c,this._uid),M.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(n.map(u=>"".concat(u.getTrackId()))))}}catch(c){throw M.error("[".concat(this._clientId,"] unpublish error"),c.toString()),c}finally{o&&o()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),M.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(o=>"".concat(o.id," "))," "));const n=await this._publishMutex.lock();try{const o=await this._p2pChannel.unpublishDataChannel(e);o&&await this._gateway.unpublishDataChannel(o),M.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(c=>"".concat(c.id))))}catch(o){throw M.error("[".concat(this._clientId,"] unpublish dataChannel error"),o.toString()),o}finally{n&&n()}}async subscribe(e,n,o){return n==="datachannel"?this._subscribeDataChannel(e,o):this._subscribe(e,n)}async presubscribe(e,n){if(Rr(n,"mediaType",["audio","video"]),this._p2pChannel instanceof ns)throw new Te(Q.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const o=n===gt.AUDIO,c=n===gt.VIDEO,u=await this._subscribeMutex.lock();try{const{ssrcId:m,ortc:_,rtxSsrcId:S,cname:C,uint_id:R}=await this._gateway.presubscribe(e,n,!0);if(m==null)throw new Te(Q.UNEXPECTED_RESPONSE,"no ssrc id");let w=this._users.find(L=>L.uid===e);w||(w=new xs(e,R||e),w._is_pre_created=!0,this._users.push(w)),C&&(w._cname=C),w._uintid||(w._uintid=R||e),o&&(w._audioSSRC=m,w._audio_pre_subscribed=!0,_&&(w._audioOrtc=_)),c&&(w._videoSSRC=m,w._video_pre_subscribed=!0,_&&(w._videoOrtc=_),S!=null&&(w._rtxSsrcId=S)),M.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(m)),await this._p2pChannel.subscribe(w,n,m,S,_);const N=o?w._audioTrack:w._videoTrack;if(!N)throw new Te(Q.UNEXPECTED_ERROR,"can not find remote track in user");return o&&(w._trust_audio_stream_added_state_=!0,w._audio_added_=!0),c&&(w._trust_video_stream_added_state_=!0,w._video_added_=!0),N}catch(m){throw M.error("[".concat(this._clientId,"] presub user ").concat(e," error"),m),m}finally{u()}}async _subscribeDataChannel(e,n){var o;if(Jn(n,"channelId",0,65535,!0),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(_=>_===e))throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new Te(Q.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new Te(Q.INVALID_REMOTE_USER,"user is not published");const c=(o=e._dataChannels)===null||o===void 0?void 0:o.find(_=>_.id===n);if(!c)throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new Te(Q.REMOTE_USER_IS_NOT_PUBLISHED);const u=await this._subscribeMutex.lock();M.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const _=await this._p2pChannel.subscribeDataChannel(e,[c]);if(_&&xe(_).call(_,c.id))try{var m;if(typeof c._originDataChannelId!="number")throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new Te(Q.CREATE_DATACHANNEL_ERROR);const S={id:c.id,datachannelId:c._originDataChannelId,ordered:c.ordered,maxRetransmits:c.maxRetransmits,metadata:(m=c.metadata)!==null&&m!==void 0?m:""};await this._gateway.subscribeDataChannel(e.uid,S,!0),await c._waitTillOpen()}catch(S){if((S==null?void 0:S.code)!==Q.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[c]),S;await this._p2pChannel.unsubscribeDataChannel(e,[c]),this._p2pChannel.setPendingRemoteDataChannel(e,c.id)}return M.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),c}finally{u()}}async _p2pSubscribe(e,n,o){if(Rr(n,"mediaType",["audio","video"]),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(u=>u===e)){const u=new Te(Q.INVALID_REMOTE_USER,"user is not in the channel");throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),u}if(!e.hasAudio&&!e.hasVideo){const u=new Te(Q.INVALID_REMOTE_USER,"user is not published");throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),u}if(!o&&(n==="audio"&&!e.hasAudio||n==="video"&&!e.hasVideo)){const u=new Te(Q.REMOTE_USER_IS_NOT_PUBLISHED);throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(n,", remote track is not published")),u}const c=await this._subscribeMutex.lock();M.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(n));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,n))await this._p2pChannel.unmuteRemote(e,n);else try{const m=n==="audio"?e._audioSSRC:e._videoSSRC,_=n==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,n,Date.now()),this._p2pChannel instanceof ns&&await this._p2pChannel.subscribe(e,n,m,_)}catch(m){throw m}M.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(n)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(m=>{M.warning("[".concat(this._clientId,"] auto set fallback failed"),m)});const u=n==="audio"?e._audioTrack:e._videoTrack;if(!u)throw new Te(Q.UNEXPECTED_ERROR,"can not find remote track in user object");return u}catch(u){throw M.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),u),u}finally{c()}}async _subscribe(e,n,o){if(this._p2pChannel instanceof ns)return this._p2pSubscribe(e,n);if(Rr(n,"mediaType",["audio","video"]),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(C=>C===e)){const C=new Te(Q.INVALID_REMOTE_USER,"user is not in the channel");throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),C}if(!e.hasAudio&&!e.hasVideo){const C=new Te(Q.INVALID_REMOTE_USER,"user is not published");throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),C}if(!(o||(n!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(n!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const C=new Te(Q.REMOTE_USER_IS_NOT_PUBLISHED);throw M.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(n,", remote track is not published")),C}let c=n==="audio"?e._audioSSRC:e._videoSSRC,u=n==="audio"?e._audioOrtc:e._videoOrtc,m=n==="video"?e._rtxSsrcId:void 0,_={stream_type:n==="audio"?gt.AUDIO:gt.VIDEO,ssrcId:c};const S=await this._subscribeMutex.lock();M.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(n));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,n))await this._p2pChannel.unmuteRemote(e,n);else try{const R=n==="audio"?e._audioSSRC:e._videoSSRC;R!==void 0&&R!==c&&(c=R,u=n==="audio"?e._audioOrtc:e._videoOrtc,m=n==="video"?e._rtxSsrcId:void 0,_={stream_type:n==="audio"?gt.AUDIO:gt.VIDEO,ssrcId:c}),Us.markSubscribeStart(this.store.clientId,c),this.store.subscribe(e.uid,n,Date.now()),await this._p2pChannel.subscribe(e,n,c,m,u);try{await this._gateway.subscribe(e.uid,_,!0)}catch(w){if((w==null?void 0:w.code)!==Q.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,n),w;await this._p2pChannel.unsubscribe(e,n,!0),this._p2pChannel.setPendingRemoteMedia(e,n)}this.store.subscribe(e.uid,n,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,n)}catch(R){throw this._p2pChannel.reportSubscribeEvent(!1,R==null?void 0:R.code,e,n),R}M.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(n)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(R=>{M.warning("[".concat(this._clientId,"] auto set fallback failed"),R)});const C=n==="audio"?e._audioTrack:e._videoTrack;if(!C)throw new Te(Q.UNEXPECTED_ERROR,"can not find remote track in user object");return C}catch(C){throw M.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),C),C}finally{S()}}async massSubscribe(e){if(il(e,"subscribeList"),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const n=Date.now(),o=new Map,c=await this._subscribeMutex.lock();M.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(S=>{let{user:C,mediaType:R}=S;return"user: ".concat(C==null?void 0:C.uid,", mediaType: ").concat(R)}).join("; ")));const u=(e=[...e]).map(S=>{let{user:C,mediaType:R}=S;return{user:C,mediaType:R}}),m=await this._p2pChannel.globalLock();try{var _;for(let C=e.length-1;C>=0;C--){const R=e[C],{user:w,mediaType:N}=R;if(Rr(N,"mediaType",["audio","video"]),!w){const j=new Te(Q.INVALID_PARAMS,"user property does not exist in subscribeList item");throw M.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),j}if(!this._users.find(j=>j===w)){const j=new Te(Q.INVALID_REMOTE_USER,"user is not in the channel");M.error("[".concat(this._clientId,"] can not massSubscribe ").concat(w.uid,", this user is not in the channel")),u[C].error=j,e.splice(C,1);continue}if(N==="audio"&&(!w.hasAudio||w._audioSSRC===void 0)||N==="video"&&(!w.hasVideo||w._videoSSRC===void 0)){const j=new Te(Q.REMOTE_USER_IS_NOT_PUBLISHED);M.error("[".concat(this._clientId,"] can not subscribe ").concat(w.uid," with mediaType ").concat(N,", remote user is not published")),u[C].error=j,e.splice(C,1);continue}const L=Yn.Video|Yn.LwoVideo,H=o.get(w);if(H){if(N==="video"?H&L:H&Yn.Audio){e.splice(C,1),M.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(w.uid,", mediaType:").concat(N," twice"));continue}o.set(w,H|(N==="video"?L:Yn.Audio))}else o.set(w,N==="video"?L:Yn.Audio)}for(let C=e.length-1;C>=0;C--){const R=e[C],{user:w,mediaType:N}=R,L=Yn.Video|Yn.LwoVideo;if(this._p2pChannel.hasRemoteMedia(w,N)){await this._p2pChannel.unmuteRemoteNoLock(w,N);const H=o.get(w);o.set(w,N==="video"?H^L:H^Yn.Audio),e.splice(C,1)}}this.store.massSubscribe(e.map(C=>({userId:C.user.uid,type:C.mediaType})),n);const S=sl(_=Array.from(o.entries())).call(_,(C,R)=>{let[w,N]=R;if(N===0)return C;const L={stream_id:w.uid,stream_type:N};return N&Yn.Audio&&(L.audio_ssrc=w._audioSSRC),N&Yn.Video&&(L.video_ssrc=w._videoSSRC),C.push(L),C},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(R=>{let{user:w,mediaType:N}=R;return{user:w,mediaType:N,ssrcId:N===gt.VIDEO?w._videoSSRC:w._audioSSRC,rtxSsrcId:N===gt.VIDEO?w._rtxSsrcId:void 0}}));const C=new Map;if(S.length>0){const R=await this._gateway.subscribeAll(S,!0);((R==null?void 0:R.users)||[]).forEach(w=>{let{stream_id:N,video_error_code:L,audio_error_code:H,error_code:j}=w;(L||H||j)&&C.set(N,{video_error_code:L,audio_error_code:H,error_code:j})})}if(Array.from(C.entries()).length>0){const R=[];Array.from(C.entries()).forEach(w=>{let[N,L]=w;const H=this.remoteUsers.find(j=>j.uid===N);if(H){let j;L.error_code||L.video_error_code&&L.audio_error_code?j=void 0:L.video_error_code?j=gt.VIDEO:L.audio_error_code&&(j=gt.AUDIO),R.push({user:H,mediaType:j})}}),R.length>0&&await this._p2pChannel.massUnsubscribeNoLock(R)}for(const R of u){const w=C.get(R.user.uid);if(w){const N=w.error_code||R.mediaType==="audio"&&w.audio_error_code||R.mediaType==="video"&&w.video_error_code;if(N){const L=fh(N);M.error("user:".concat(R.user.uid," mediaType:").concat(R.mediaType," has massSubscribe error ").concat(L.desc)),R.error=new Te(Q.SUBSCRIBE_FAILED,"code ".concat(N,": ").concat(L.desc))}}R.error||(R.mediaType==="video"?R.track=R.user.videoTrack:R.track=R.user.audioTrack)}return this.store.massSubscribe(u.filter(R=>!R.error).map(R=>({userId:R.user.uid,type:R.mediaType})),void 0,Date.now()),u.forEach(R=>{var w;vt.subscribe(this.store.sessionId,{succ:!!R.error,ec:((w=R.error)===null||w===void 0?void 0:w.code)||null,video:R.mediaType===gt.VIDEO,audio:R.mediaType===gt.AUDIO,peerid:R.user.uid,subscribeRequestid:R.mediaType===gt.VIDEO?R.user._videoSSRC:R.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-n)},!0)}),M.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(R=>{let{user:w,mediaType:N}=R;return"user: ".concat(w==null?void 0:w.uid,", mediaType: ").concat(N)}).join("; "))),u}catch(C){throw await this._p2pChannel.massUnsubscribeNoLock(e),C}}finally{m(),c()}}async unsubscribe(e,n,o){if(n||this.store.useP2P){if(n==="datachannel")return this._unsubscribeDataChannel(e,o)}else await this._unsubscribeDataChannel(e,o);if(n&&Rr(n,"mediaType",["audio","video"]),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(u=>u===e)){const u=new Te(Q.INVALID_REMOTE_USER,"user is not in the channel");throw M.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),u}M.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(n));const c=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof ns)await this._p2pChannel.unsubscribe(e,n);else{const u=await this._p2pChannel.unsubscribe(e,n);u&&await this._gateway.unsubscribe(u,e.uid),n&&n!=="audio"||(e._audio_pre_subscribed=!1),n&&n!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&ef(this._users,e),M.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(n))}}catch(u){if(u.code===Q.DISCONNECT_P2P)return void M.warning("disconnecting p2p, abort unsubscribe request.");throw M.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),u.toString()),u}finally{c()}}async _unsubscribeDataChannel(e,n){if(n&&Jn(n,"id",0,65535,!0),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(c=>c===e)){const c=new Te(Q.INVALID_REMOTE_USER,"user is not in the channel");throw M.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),c}let o;if(typeof n=="number"){const c=e._dataChannels.find(u=>u.id===n);c&&(o=[c])}else o=e._dataChannels;if(o===void 0){const c=new Te(Q.REMOTE_USER_IS_NOT_PUBLISHED);throw M.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(n,", remote datachannel is not published")),c}M.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(o.map(c=>c.id)));try{const c=await this._p2pChannel.unsubscribeDataChannel(e,o);c&&await this._gateway.unsubscribeDataChannel(c,e.uid),M.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(c))}catch(c){if(c.code===Q.DISCONNECT_P2P)return void M.warning("disconnecting p2p, abort unsubscribe request.");throw M.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),c.toString()),c}}async massUnsubscribe(e){if(il(e,"unsubscribeList"),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");M.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(o=>{let{user:c,mediaType:u}=o;return"user: ".concat(c==null?void 0:c.uid,", mediaType: ").concat(u,";")}).join())),e=[...e];const n=new Map;for(let o=e.length-1;o>=0;o--){const{user:c,mediaType:u}=e[o];if(!c){const _=new Te(Q.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw M.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),_}if(Rr(u,"mediaType",["video","audio",void 0]),!this._users.find(_=>_===c)){M.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(c.uid,", user is not in the channel")),e.splice(o,1);continue}const m=Yn.Video|Yn.LwoVideo;if(n.has(c)){const _=n.get(c);let S;switch(u){case"video":S=_&m;break;case"audio":S=_&Yn.Audio;break;default:S=_&(Yn.Audio|m)}if(S){M.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(c.uid,",mediaType:").concat(u," twice.")),e.splice(o,1);continue}u?u==="audio"?n.set(c,_|Yn.Audio):u==="video"&&n.set(c,_|m):n.set(c,_|Yn.Audio|m)}else u?u==="audio"?n.set(c,Yn.Audio):u==="video"&&n.set(c,m):n.set(c,Yn.Audio|m)}try{const o=await this._p2pChannel.massUnsubscribe(e);o&&await this._gateway.massUnsubscribe(o),M.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(c=>{let{user:u,mediaType:m}=c;return"user: ".concat(u==null?void 0:u.uid,", mediaType: ").concat(m,";")}).join()))}catch(o){if(o.code===Q.DISCONNECT_P2P)return void M.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw M.error("[".concat(this._clientId,"] massUnsubscribe error"),o.toString()),o}}async setLowStreamParameter(e){(function(o){if(!o)throw new ke(Q.INVALID_PARAMS);Ai(o.width)||eh(o.width,"streamParameter.width"),Ai(o.height)||eh(o.height,"streamParameter.height"),Ai(o.framerate)||eh(o.framerate,"streamParameter.framerate"),Ai(o.bitrate)||Jn(o.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&M.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),M.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const n=this._configDistribute.getLowStreamConfigDistribute();if(n&&n.bitrate&&e.bitrate&&n.bitrate<e.bitrate&&(e.bitrate=n.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,Je.LocalVideoLowTrack)}async enableDualStream(){if(!Dn().supportDualStream)throw vt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Te(Q.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Te(Q.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw vt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,vt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),M.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Je.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw vt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,vt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),M.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,n){if(function(o){Rr(o,"role",["audience","host"])}(e),n&&rh(n),this.mode==="rtc"||this.mode==="p2p")throw M.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new Te(Q.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(n&&n.level&&e==="host")throw new Te(Q.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new Te(Q.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,n),this._config.role=e,M.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(n&&n.level))}getRemoteInboundOffset(){var e;const n=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!n||!n.timestamp)return 0;const o=n.timestamp-Date.now();return Math.abs(o)>1e3+n.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?o:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,n){if(Xr(e,"proxyServer"),!n){if(this.connectionState!=="DISCONNECTED")throw new Te(Q.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new Te(Q.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,vt.setProxyServer(this._proxyServer),M.setProxyServer(this._proxyServer),M.info("[".concat(this._clientId,"] Set proxy server ").concat(n?"by initialize call":""," success."))}setTurnServer(e,n){if(Array.isArray(e)||(e=[e]),!n){if(this.connectionState!=="DISCONNECTED")throw new Te(Q.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new Te(Q.INVALID_OPERATION,"You have already set the proxy")}if(Bi(e))return this._turnServer={servers:e,mode:"original-manual"},void M.info("[".concat(this._clientId,"] Set original turnserver ").concat(n?"by initialize call":""," success: ").concat(e.map(o=>o.urls).join(","),"."));e.forEach(o=>HA(o)),this._turnServer={servers:e,mode:"manual"},M.info("[".concat(this._clientId,"] Set turnserver ").concat(n?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new Te(Q.INVALID_OPERATION,"you should set license before join channel");if(Xr(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new Te(Q.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,M.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new Te(Q.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new Te(Q.INVALID_OPERATION,"You have already set the proxy");const n=[3,4,5];let o;switch(e===void 0&&(e=3),e){case 1:case 2:throw new Te(Q.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:o="proxy3";break;case 4:o="proxy4";break;case 5:o="proxy5";break;default:throw new Te(Q.INVALID_PARAMS,"proxy server mode must be ".concat(n.join("|")))}this._cloudProxyServerMode=o,this.store.cloudProxyServerMode=o,M.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new Te(Q.INVALID_OPERATION,"Stop proxy server after leave channel");vt.setProxyServer(),M.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",M.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new Te(Q.INVALID_PARAMS,"accessPoints is required.");il(e.accessPoints.serverList,"accessPoints.serverList"),Xr(e.accessPoints.domain,"accessPoints.domain");const n=(L,H)=>{Jn(L,H,0,65535,!0)};let o=443;if(e.accessPoints.port&&(n(e.accessPoints.port,"accessPoints.port"),o=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new Te(Q.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");oe("CLOSE_AFB_FOR_LOCAL_AP")&&(Kn("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Kn("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const c=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,u=e.accessPoints.domain,m=e.accessPoints.serverList.map(L=>c.test(L)?"".concat(L.replace(/\./g,"-"),".").concat(u):L),_=m.map(L=>"".concat(L,":").concat(o));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Kn("WEBCS_DOMAIN",_),Kn("WEBCS_DOMAIN_BACKUP_LIST",_),Kn("GATEWAY_DOMAINS",[u]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(il(e.report.hostname,"report.hostname"),Kn("EVENT_REPORT_DOMAIN",e.report.hostname[0]),Kn("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(Kn("EVENT_REPORT_DOMAIN",m[0]),Kn("EVENT_REPORT_BACKUP_DOMAIN",m[1]||m[0]));let S=6443;e.report&&e.report.port&&(n(e.report.port,"report.port"),S=e.report.port),Kn("STATS_COLLECTOR_PORT",S),e.report?Kn("ENABLE_EVENT_REPORT",!0):Kn("ENABLE_EVENT_REPORT",!1);let C="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(il(e.log.hostname,"log.hostname"),C=e.log.hostname[0]):C=m[0];let R=6444;e.log&&e.log.port&&(n(e.log.port,"log.port"),R=e.log.port),Kn("LOG_UPLOAD_SERVER","".concat(C,":").concat(R));let w=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(il(e.cds.hostname,"cds.hostname"),w=e.cds.hostname):w=m;let N=443;e.cds&&e.cds.port&&(n(e.cds.port,"cds.port"),N=e.cds.port),Kn("CDS_AP",w.map(L=>"".concat(L,":").concat(N))),e.cds?Kn("ENABLE_CONFIG_DISTRIBUTE",!0):Kn("ENABLE_CONFIG_DISTRIBUTE",!1),M.info("set local access point v2 success")}setLocalAccessPoints(e,n){if(il(e,"serverList"),Xr(n,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new Te(Q.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const o=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(c=>o.test(c)?"".concat(c.replace(/\./g,"-"),".").concat(n):c),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Kn("WEBCS_DOMAIN",e),Kn("WEBCS_DOMAIN_BACKUP_LIST",e),Kn("GATEWAY_DOMAINS",[n]),Kn("EVENT_REPORT_DOMAIN",e[0]),Kn("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),Kn("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),M.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(Rr(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(n){throw M.error("[".concat(this._clientId,"] set default remote video stream type error"),n.toString()),n}else M.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,n){Rr(n,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,n),setTimeout(()=>{const o=this._users.find(c=>c.uid===e);o&&o.videoTrack&&o.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(o){throw M.error("[".concat(this._clientId,"] set remote video stream type error"),o.toString()),o}M.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(n)),this._remoteStreamTypeCacheMap.set(e,n)}async setStreamFallbackOption(e,n){Rr(n,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,n)}catch(o){throw M.error("[".concat(this._clientId,"] set stream fallback option"),o.toString()),o}M.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(n)),this._streamFallbackTypeCacheMap.set(e,n)}setEncryptionConfig(e,n,o,c){(function(m){Rr(m,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),Xr(n,"secret");const u=["aes-128-gcm2","aes-256-gcm2"];if(xe(u).call(u,e)){if(!o||!(o instanceof Uint8Array&&o.length===32))throw new Te(Q.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(o)throw new Te(Q.INVALID_PARAMS,"current encrypt mode does not need salt");if(c){if(nl(c,"encryptDataStream"),!xe(u).call(u,e))throw new Te(Q.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(n)||M.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=n,o&&(this._encryptionSalt=nf(o))}async renewToken(e){if(Xr(e,"token",1,2047),!this._key||!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"renewToken should not be called before user join");const n=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const o=await this._renewTokenMutex.lock();try{if(oe("USE_NEW_TOKEN")){M.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const c=await bP(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||or);M.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:c})}else M.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});M.debug("[".concat(this._clientId,"] renewToken success"))}catch(c){throw this._key=n,this._joinInfo.token=n,M.error("[".concat(this._clientId,"] renewToken failed"),c.toString()),c}finally{o()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?M.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(hn.VOLUME_INDICATOR,e)},oe("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),n=this._gateway.getInChannelInfo();return e.Duration=Math.round(n.duration/1e3),e}async startLiveStreaming(e,n){if(!n){if(this.codec!=="h264")throw new Te(Q.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Te(Q.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new Te(Q.LIVE_STREAMING_TASK_CONFLICT);const o=n?Li.TRANSCODE:Li.RAW;return this._createLiveStreamingClient(o).startLiveStreamingTask(e,o)}setLiveTranscoding(e){return this._createLiveStreamingClient(Li.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const n=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(o=>o&&o.hasUrl(e));if(!n.length)throw new Te(Q.INVALID_PARAMS,"can not find live streaming url to stop");await Ee.all(n.map(o=>o&&o.stopLiveStreamingTask(e)))}async addInjectStreamUrl(e,n){if(!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const o=this._createLiveStreamingClient(Li.INJECT);o.setInjectStreamConfig(n,0),await o.startLiveStreamingTask(e,Li.INJECT)}async removeInjectStreamUrl(){var e;const n=this._createLiveStreamingClient(Li.INJECT),o=Array.from(wd(e=n.streamingTasks).call(e)).find(c=>c.mode===Li.INJECT);if(!this._joinInfo||!o)throw new Te(Q.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await n.stopLiveStreamingTask(o.url)}async startChannelMediaRelay(e){p5(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){p5(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){var n;let o=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const u=new TextEncoder;e.payload=u.encode(e.payload)}let c=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&xe(n=["aes-128-gcm2","aes-256-gcm2"]).call(n,this._encryptionMode)&&(c=!0,e.payload=await async function(u,m,_){var S;const C=sl(S=Array.from(_)).call(S,(W,ee)=>W+ee,0),R={serverTs:0,seq:ZD++,length:_.length,checkSum:C},w=new Uint8Array(UT(C,2)),N=new ArrayBuffer(uc),L=new DataView(N);L.setUint32(0,R.serverTs),L.setUint16(4,R.seq),L.setUint16(6,R.length),L.setUint16(8,R.checkSum);const H=16-_.length%16;_=ID(_,new Uint8Array(H));const j=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:u,tagLength:io,additionalData:w},m,_);return ID(new Uint8Array(N),new Uint8Array(j))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new Te(Q.INVALID_PARAMS,c?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(ft.DATA_STREAM,{payload:nf(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-Cz},!o)}sendMetadata(e){if(!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new Te(Q.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(ft.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:nf(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(iC),!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"can not send custom report, not joined");await vt.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,n){Rr(n.spatialLayer,"spatialLayer",[0,1,2,3]),Rr(n.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,n)}catch(o){throw M.error("[".concat(this._clientId,"] pick SVC layer failed"),o.toString()),o}}async setRTMConfig(e){const{apRTM:n=!1,rtmFlag:o}=e;if(nl(n,"apRTM"),Jn(o,"rtmFlag",0),this._rtmConfig.apRTM=n,this._rtmConfig.rtmFlag=o,M.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=n,this._joinInfo.rtmFlag=o,this._gateway.setRTM2Flag(o)}_reset(){if(M.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=no.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(n=>n._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Zr("client-publish"),this._subscribeMutex=new Zr("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,n){var o;const c=e||qA();e?M.debug("[".concat(this._clientId,"] new Session ").concat(c)):M.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(c));const u=e?"":this._sessionId||"";this._sessionId=c,this.store.sessionId=c;const m={lts:new Date().getTime(),mode:this.mode,stringUid:(n==null?void 0:n.stringUid)||((o=this._joinInfo)===null||o===void 0?void 0:o.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:u,clientRole:this.role==="audience"?2:1};n?vt.sessionInit(this._sessionId,xu({cname:n.channel,appid:n.appId},m)):this._joinInfo?vt.sessionInit(this._sessionId,xu({cname:this._joinInfo.cname,appid:this._joinInfo.appId},m)):this._gateway.joinInfo&&vt.sessionInit(this._sessionId,xu({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},m)),this._joinInfo&&(this._joinInfo.sid=c),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=c)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new Te(Q.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&oe("FORCE_TURN")&&!oe("TURN_ENABLE_TCP")&&!oe("TURN_ENABLE_UDP"))throw new Te(Q.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");M.debug("[".concat(this._clientId,"] publish high stream"));try{const o=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof ns){const c=(await o.next()).value;if(c){try{await this._gateway.sendExtensionMessage(Qn.PUBLISH,c,!0)}catch(u){throw o.throw(u),u}await o.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const c=(await o.next()).value;if(c){var n;let u;try{u=await this._gateway.publish(this._uid,c,!0)}catch(m){if(m.code!==Q.DISCONNECT_P2P)throw o.throw(m),m}await o.next(((n=u)===null||n===void 0?void 0:n.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const u of e)u instanceof on&&u._encoderConfig&&this._gateway.setVideoProfile(u._encoderConfig),!u.muted&&u.enabled||await this._p2pChannel.muteLocalTrack(u)}}catch(o){if(this._p2pChannel.reportPublishEvent(!1,o==null?void 0:o.code,e),(o==null?void 0:o.code)===Q.WS_ABORT)return;throw o}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new Te(Q.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Te(Q.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));M.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const o=await this._p2pChannel.publishLowStream(this._lowStreamParameter),c=(await o.next()).value;if(c){var n;let u;try{u=await this._gateway.publish(this._uid,c,!0)}catch(m){if(m.code!==Q.DISCONNECT_P2P)throw o.throw(m),m}o.next(((n=u)===null||n===void 0?void 0:n.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(o){if(this._p2pChannel.reportPublishEvent(!1,o==null?void 0:o.code,void 0,!0),(o==null?void 0:o.code)===Q.WS_ABORT)return;throw o}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new Te(Q.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const n=()=>new ZY(this._joinInfo,this._config.websocketRetryConfig||or,this._config.httpRetryConfig||or),o=c=>{c.onLiveStreamError=(u,m)=>{vt.reportApiInvoke(this._sessionId,{name:Si.ON_LIVE_STREAM_ERROR,options:[u,m],tag:wi.TRACER}).onSuccess(),this.safeEmit(hn.LIVE_STREAMING_ERROR,u,m)},c.onLiveStreamWarning=(u,m)=>{vt.reportApiInvoke(this._sessionId,{name:Si.ON_LIVE_STREAM_WARNING,options:[u,m],tag:wi.TRACER}).onSuccess(),this.safeEmit(hn.LIVE_STREAMING_WARNING,u,m)},c.on(ph.REQUEST_WORKER_MANAGER_LIST,(u,m,_)=>{if(!this._joinInfo)return _(new Te(Q.INVALID_OPERATION,"can not find join info to get worker manager"));hC(u,this._joinInfo,this._axiosCancelSource.token,or).then(m).catch(_)})};switch(e){case Li.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=n(),o(this._liveRawStreamingClient)),this._liveRawStreamingClient;case Li.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=n(),o(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case Li.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=n(),this._injectStreamingClient.on(ph.REQUEST_WORKER_MANAGER_LIST,(c,u,m)=>{if(!this._joinInfo)return m(new Te(Q.INVALID_OPERATION,"can not find join info to get worker manager"));hC(c,this._joinInfo,this._axiosCancelSource.token,or).then(u).catch(m)}),this._injectStreamingClient.onInjectStatusChange=(c,u,m)=>{this.safeEmit(hn.INJECT_STREAM_STATUS,c,u,m)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new Te(Q.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:n}=this.getLocalVideoStats(),o={width:e,height:n};this._channelMediaRelayClient=new ez(this._joinInfo,this._clientId,this._config.websocketRetryConfig||or,this._config.httpRetryConfig||or,o),this._channelMediaRelayClient.on("state",c=>{c===hs.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(hn.CHANNEL_MEDIA_RELAY_STATE,c)}),this._channelMediaRelayClient.on("event",c=>{this.safeEmit(hn.CHANNEL_MEDIA_RELAY_EVENT,c)}),this._statsCollector.onStatsChanged=(c,u)=>{var m;c==="resolution"&&((m=this._channelMediaRelayClient)===null||m===void 0||m.setVideoProfile(u))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,n){const{added:o,deleted:c}=e,u=[];Array.isArray(o)&&o.length>0&&o.forEach(m=>{const{uid:_,stream_id:S,ordered:C,max_retrans_times:R,metadata:w}=m,N=this._users.find(L=>L._uintid===_);if(!N)return void M.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(M.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(_)),xe(u).call(u,N)||u.push(N),N._uintid||(N._uintid=_),N._dataChannels.findIndex(L=>L.id===m.stream_id)===-1){const L={id:S,ordered:!!C,maxRetransmits:R,metadata:w},H=new v3(L);N._dataChannels.push(H),M.info("[".concat(this._clientId,"] remote user ").concat(N.uid," published datachannel")),n||this.safeEmit(hn.USER_PUBLISHED,N,"datachannel",L)}this._p2pChannel.hasPendingRemoteDataChannel(N,m.stream_id)&&(M.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(N.uid," after reconnect.")),this._subscribeDataChannel(N,m.stream_id).catch(L=>{M.error("[".concat(this._clientId,"] resubscribe datachannel error"),L.toString())}))}),n&&(this.safeEmit(hn.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(c)&&c.length>0&&c.forEach(m=>{const{uid:_,stream_id:S}=m,C=this._users.find(w=>w._uintid===_);if(!C)return void M.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const R=C._dataChannels.find(w=>w.id===m.stream_id);R&&(M.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(_)),this._p2pChannel.unsubscribeDataChannel(C,[R]).then(w=>{if(C._dataChannels=C._dataChannels.filter(N=>N!==R),w)return this._gateway.unsubscribeDataChannel(w,C.uid)}),M.info("[".concat(this._clientId,"] remote user ").concat(_," unpublished datachannel ,id:").concat(R.id)),this.safeEmit(hn.USER_UNPUBLISHED,C,"datachannel",R._config))})}_handleRemoveDataChannels(e){const n=this._users.find(o=>o.uid===e.uid);if(n){if(n._dataChannels!==void 0&&n._dataChannels.length>0){M.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const o=()=>{M.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished datachannel")),n._dataChannels.forEach(c=>{this.safeEmit(hn.USER_UNPUBLISHED,n,"datachannel",c._config)})};this._p2pChannel.unsubscribeDataChannel(n,n._dataChannels).then(c=>{if(c)return this._gateway.unsubscribeDataChannel(c,n.uid)}),o()}}else M.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(An.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(An.CONNECTION_STATE_CHANGE,(e,n,o)=>{var c;if(o===un.FALLBACK)return;const u=()=>{this.safeEmit(hn.CONNECTION_STATE_CHANGE,e,n,o)};if(vt.reportApiInvoke(this._sessionId||((c=this._gateway.joinInfo)===null||c===void 0?void 0:c.sid)||null,{name:Si.CONNECTION_STATE_CHANGE,options:[e,n,o],tag:wi.TRACER}).onSuccess(JSON.stringify({cur:e,prev:n,reason:o})),M.info("[".concat(this._clientId,"] connection state change: ").concat(n," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void u();if(e==="RECONNECTING")this._users.forEach(_=>{_._trust_in_room_=!1,_._trust_audio_enabled_state_=!1,_._trust_video_enabled_state_=!1,_._trust_audio_mute_state_=!1,_._trust_video_mute_state_=!1,_._trust_audio_stream_added_state_=!1,_._trust_video_stream_added_state_=!1,_._is_pre_created||(_._audio_pre_subscribed||(_._audioSSRC=void 0,_._audioOrtc=void 0),_._video_pre_subscribed||(_._videoSSRC=void 0,_._videoOrtc=void 0,_._rtxSsrcId=void 0),_._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var m;this._streamFallbackTypeCacheMap.forEach((_,S)=>{this._gateway.setStreamFallbackOption(S,_).catch(C=>{M.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),C)})}),this._remoteStreamTypeCacheMap.forEach((_,S)=>{this._gateway.setRemoteVideoStreamType(S,_).catch(C=>{M.warning("[".concat(this._clientId,"] auto set remote stream type failed"),C)})}),this._remoteDefaultVideoStreamType!==void 0&&((m=this._joinInfo)===null||m===void 0?void 0:m.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{M.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(_=>{M.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(_))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(_=>!_._trust_in_room_).forEach(_=>{M.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(_.uid)),this._handleUserOffline({uid:_.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(_=>{_._trust_audio_mute_state_||(M.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(_.uid)),this._handleMuteStream(_.uid,gt.AUDIO,!1)),_._trust_video_mute_state_||(M.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(_.uid)),this._handleMuteStream(_.uid,gt.VIDEO,!1)),_._trust_audio_enabled_state_||(M.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(_.uid)),this._handleSetStreamLocalEnable("audio",_.uid,!0)),_._trust_video_enabled_state_||(M.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(_.uid)),this._handleSetStreamLocalEnable("video",_.uid,!0)),_._trust_video_stream_added_state_||(M.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(_.uid)),this._handleResetAddStream(_,"video")),_._trust_audio_stream_added_state_||(M.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(_.uid)),this._handleResetAddStream(_,"audio")),_._video_added_||_._audio_added_||(M.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(_.uid)),this._handleRemoveStream({uid:_.uid,uint_id:_._uintid}))}))},1e3))}u()}),this._gateway.on(An.REQUEST_NEW_GATEWAY_LIST,(e,n)=>{if(!this._joinInfo)return n(new Te(Q.UNEXPECTED_ERROR,"can not recover, no join info"));uC(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||or,this.store).then(o=>{this._joinInfo&&(this._joinInfo.apResponse=o.gatewayInfo.res,this._joinInfo.gatewayAddrs=o.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=o.gatewayInfo.uni_lbs_ip);const c=[];o.gatewayInfo.gatewayAddrs.forEach(u=>{let{address:m}=u;const[_,S]=m.split(":");this._joinInfo&&this._joinInfo.proxyServer?c.push({proxy:this._joinInfo.proxyServer,host:_,port:S}):c.push({host:_,port:S})}),e(c)}).catch(n)}),this._gateway.on(An.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(hn.NETWORK_QUALITY,e)}),this._gateway.on(An.STREAM_TYPE_CHANGE,(e,n)=>{this.safeEmit(hn.STREAM_TYPE_CHANGED,e,n),vt.reportApiInvoke(this._sessionId,{name:Si.STREAM_TYPE_CHANGE,options:[e,n],tag:wi.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:n}))}),this._gateway.on(An.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(An.NEED_RENEW_SESSION,()=>{this._startSession()}),this._gateway.on(An.REQUEST_P2P_CONNECTION_PARAMS,async(e,n,o)=>{try{n(await this._p2pChannel.startP2PConnection(e))}catch(c){o(c)}}),this._gateway.on(An.JOIN_RESPONSE,(e,n)=>{if(this.store.useP2P)return;const{dtlsParameters:o,iceParameters:c,candidates:u,rtpCapabilities:m,setup:_,cname:S}=B(e.ortc,n);this._p2pChannel.connect(c,o,u,m,_,S)}),this._gateway.on(An.REQUEST_DC_CONNECTION_PARAMS,e=>{e(this._p2pChannel.getEstablishParams())}),this._gateway.on(An.RESET_SIGNAL,e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()}),this._gateway.on(An.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(An.DATACHANNEL_PRECONNECT,async(e,n,o,c)=>{var u,m,_,S,C,R;await this._p2pChannel.startP2PConnection({turnServer:(u=this._joinInfo)===null||u===void 0?void 0:u.turnServer},!0);const w=function(N,L){let H;return L&&L.ip&&typeof L.port=="number"?(H=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:L.ip,port:L.port.toString(),type:"host",extension:{}}],M.debug("Using remote candidate from AP ".concat(L.ip,":").concat(L.port)),L.ip6&&(H.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:L.ip6,port:L.port.toString(),type:"host",extension:{}}),M.debug("Using IPV6 remote candidate from AP ".concat(L.ip6,":").concat(L.port)))):H=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:N.ip,port:N.port.toString(),type:"host",extension:{}}],H}(e,n);return this._p2pChannel.preConnect({iceUfrag:"".concat((m=this._joinInfo)===null||m===void 0?void 0:m.apResponse.cid,"_").concat((_=this._joinInfo)===null||_===void 0?void 0:_.apResponse.cert),icePwd:"".concat((S=this._joinInfo)===null||S===void 0?void 0:S.apResponse.cid,"_").concat((C=this._joinInfo)===null||C===void 0?void 0:C.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(R=oe("FINGERPRINT"))!==null&&R!==void 0?R:e.fingerprint}]},w,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(o).catch(c)})}_handleGatewaySignalEvents(){this._gateway.signal.on(Qe.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Qe.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Qe.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc)),this._gateway.signal.on(Qe.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(Qe.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(Qe.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)}),this._gateway.signal.on(Qe.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Qe.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Qe.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,gt.AUDIO,!0)),this._gateway.signal.on(Qe.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,gt.AUDIO,!1)),this._gateway.signal.on(Qe.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,gt.VIDEO,!0)),this._gateway.signal.on(Qe.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,gt.VIDEO,!1)),this._gateway.signal.on(Qe.RECEIVE_METADATA,e=>{const n=ca(e.metadata);this.safeEmit(hn.RECEIVE_METADATA,e.uid,n)}),this._gateway.signal.on(Qe.ON_DATA_STREAM,async e=>{var n;if(!e)return;let o=ca(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&xe(n=["aes-128-gcm2","aes-256-gcm2"]).call(n,this._encryptionMode)){if(e.payload.length<uc)throw new Te(Q.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(uc));o=await async function(m,_,S){const C=S.subarray(0,uc),R=C.slice(8,uc),w=(R[0]<<8)+R[1],N=(C[6]<<8)+C[7],L=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:m,tagLength:io,additionalData:new Uint8Array(UT(w,2))},_,S.subarray(uc));return new Uint8Array(L).subarray(0,N)}(this._encryptDataStreamIv,this._encryptDataStreamKey,o)}let c=0;if(e.ordered||e.syncWithAudio){const u=this._p2pChannel.getStats(),m=this.remoteUsers.find(S=>S.uid===e.uid),_=u==null?void 0:u.audioRecv.find(S=>S.ssrc===(m==null?void 0:m._audioSSRC));c=_==null?void 0:_.jitterBufferMs}c==null&&(c=0),Rz(xu(xu({},e),{},{payload:o}),c,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Qe.ON_CRYPT_ERROR,()=>{eu(()=>{M.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(hn.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Qe.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Qe.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{M.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,un.TOKEN_EXPIRE),this.safeEmit(hn.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Qe.ON_STREAM_FALLBACK_UPDATE,e=>{M.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(hn.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Qe.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),M.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(Qe.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(Qe.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(pt.REQUEST_TIMEOUT,(e,n)=>{if(this._joinInfo)switch(e){case ft.PUBLISH:{if(!n)return;const u=n.ortc;if(u){var o,c;const m=u.some(C=>{let{stream_type:R}=C;return R===Nn.Audio}),_=u.some(C=>{let{stream_type:R}=C;return R!==Nn.Audio}),S=u.some(C=>{let{stream_type:R}=C;return R===Nn.Screen||R===Nn.ScreenLow});n.state==="offer"&&vt.publish(this._joinInfo.sid,{eventElapse:Us.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:Q.TIMEOUT,audio:m,video:_,p2pid:n.p2p_id,publishRequestid:this.store.pubId,screenshare:S,audioName:m?(o=u.find(C=>{let{stream_type:R}=C;return R===Nn.Audio}))===null||o===void 0||(o=o.ssrcs[0])===null||o===void 0?void 0:o.ssrcId.toString():void 0,videoName:_?(c=u.find(C=>{let{stream_type:R}=C;return R!==Nn.Audio}))===null||c===void 0||(c=c.ssrcs[0])===null||c===void 0?void 0:c.ssrcId.toString():void 0})}break}case ft.SUBSCRIBE:n&&vt.subscribe(this._joinInfo.sid,{succ:!1,ec:Q.TIMEOUT,audio:n.stream_type===gt.AUDIO,video:n.stream_type===gt.VIDEO,peerid:n.stream_id,subscribeRequestid:n.ssrcId,p2pid:this.store.p2pId,eventElapse:Us.measureFromSubscribeStart(this.store.clientId,n.ssrcId)})}}),this._gateway.signal.on(Qe.ON_P2P_OK,e=>{this.uid,this._uid}),this._gateway.signal.on(Qe.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;oe("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(c=>!Tt(c.string_id||c.stream_id,this.channelName)));const n=[],o=[];for(const c of e.users){let u=this._users.find(w=>w._uintid===c.stream_id);u?u._trust_in_room_=!0:(u=new xs(c.string_id||c.stream_id,c.stream_id),this._users.push(u),this.getListeners(hn.PUBLISHED_USER_LIST).length===0&&(M.debug("[".concat(this._clientId,"] user online"),c.stream_id),this.safeEmit(hn.USER_JOINED,u)));const m=Yn.Audio&c.stream_type,_=(Yn.Video|Yn.LwoVideo)&c.stream_type,S=(65280&c.stream_type)!=0,C=m&&u.hasAudio,R=_&&u.hasVideo;_&&(u._trust_video_stream_added_state_=!0,u._video_added_=!0,u._videoSSRC=c.video_ssrc,u._rtxSsrcId=c.video_rtx),m&&(u._trust_audio_stream_added_state_=!0,u._audio_added_=!0,u._audioSSRC=c.audio_ssrc),m&&!C&&this.getListeners(hn.PUBLISHED_USER_LIST).length===0&&(M.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published audio")),this.safeEmit(hn.USER_PUBLISHED,u,"audio")),_&&!R&&this.getListeners(hn.PUBLISHED_USER_LIST).length===0&&(M.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published video")),this.safeEmit(hn.USER_PUBLISHED,u,"video")),(m&&!C||_&&!R||S)&&n.push(u),_&&this._p2pChannel.hasPendingRemoteMedia(u,"video")&&o.push({user:u,mediaType:"video"}),m&&this._p2pChannel.hasPendingRemoteMedia(u,"audio")&&o.push({user:u,mediaType:"audio"})}o.length>0&&(M.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(o.map(c=>"user: ".concat(c.user.uid,", mediaType: ").concat(c.mediaType)).join("; ")," ")),this.massSubscribe(o).catch(c=>{M.error("[".concat(this._clientId,"] mass resubscribe error"),c.toString())})),this.getListeners(hn.PUBLISHED_USER_LIST).length>0?oe("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=n:(M.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(n.map(c=>c.uid).join(", "))),this.safeEmit(hn.PUBLISHED_USER_LIST,n)):M.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(n.map(c=>c.uid).join(", ")))}),this._gateway.signal.on(Qe.ON_RTP_CAPABILITY_CHANGE,e=>{const{video_codec:n}=e;this._p2pChannel instanceof ws&&this._p2pChannel.updateRemoteRTPCapabilities(n.map(o=>o.toLowerCase()).filter(o=>{var c;return xe(c=Object.keys(Ko)).call(c,o)}))})}_handleP2PEvents(){this._gateway.signal.on(Qe.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Qn.PUBLISH,(e,n,o)=>{const{uid:c}=e;e.forEach(u=>{const{kind:m,ssrcs:_,mid:S,isMuted:C}=u;this._handleP2PAddAudioOrVideoStream(m,c,_[0].ssrcId,S);const R=this._users.find(w=>w.uid===c);return R&&this._p2pChannel instanceof ns?this._p2pChannel.mockSubscribe(R,m,_[0].ssrcId,S).then(()=>{n()}).catch(o):n(),this._handleMuteStream(c,m,!!C)})}),this._gateway.signal.on(Qn.CALL,async(e,n,o)=>{if(this._p2pChannel instanceof ns)try{var c;n(await this._p2pChannel.startP2P({turnServer:(c=this._joinInfo)===null||c===void 0?void 0:c.turnServer},e))}catch(u){o(u)}}),this._gateway.signal.on(pt.P2P_CONNECTION,async e=>{this._p2pChannel instanceof ns&&await this._p2pChannel.p2pConnect(e)}),this._gateway.signal.on(Qn.UNPUBLISH,async(e,n,o)=>{if(this._p2pChannel instanceof ns){const{unpubMsg:c,uid:u}=e,m=this._users.find(_=>_.uid===u);if(!m)return M.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(u)),void n();try{c.forEach(async _=>{let{stream_type:S}=_;const C=S===Nn.Audio?gt.AUDIO:gt.VIDEO;await this._p2pChannel.unsubscribe(m,C),this._handleMuteStream(u,C,!0)}),n()}catch(_){o(_)}}}),this._gateway.signal.on(Qn.CONTROL,async(e,n)=>{const{action:o}=e;switch(o){case es.MUTE_LOCAL_VIDEO:this._handleMuteStream(n,gt.VIDEO,!0);break;case es.MUTE_LOCAL_AUDIO:this._handleMuteStream(n,gt.AUDIO,!0);break;case es.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",n),this._handleMuteStream(n,gt.VIDEO,!1);break;case es.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",n),this._handleMuteStream(n,gt.AUDIO,!1)}}),this._gateway.signal.on(Qn.RESTART_ICE,async(e,n,o)=>{if(this._p2pChannel instanceof ns)try{const{direction:c,iceParameter:u}=e;c!==st.SEND_ONLY||u?n(await this._p2pChannel.restartICE(c,u)):(this._p2pChannel.handleDisconnect(c),n())}catch(c){o(c)}}),this._gateway.signal.on(Qn.CANDIDATE,e=>{if(this._p2pChannel instanceof ns){const{candidate:n,direction:o}=e;this._p2pChannel.addRemoteCandidate(n,o)}}),this._p2pChannel.on(We.RequestP2PRestartICE,async(e,n,o)=>{try{const{direction:c}=e;n(await this._gateway.sendExtensionMessage(Qn.RESTART_ICE,e,c===st.SEND_ONLY))}catch(c){o(c)}}),this._p2pChannel.on(We.LocalCandidate,e=>{this._gateway.sendExtensionMessage(Qn.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(We.RequestP2PMuteLocal,async(e,n,o)=>{try{await this._gateway.sendExtensionMessage(Qn.CONTROL,e,!0),n()}catch(c){o(c)}}),this._p2pChannel.on(We.RequestP2PUnmuteRemote,async(e,n,o)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(c){c.code===Q.DISCONNECT_P2P?n():o(c)}else n()}),this._p2pChannel.on(We.RequestP2PMuteRemote,async(e,n,o)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(c){c.code===Q.DISCONNECT_P2P?n():o(c)}else n()}),this._p2pChannel.on(We.StateChange,(e,n)=>{n===kn.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(We.RequestMuteLocal,async(e,n,o)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(c){c.code===Q.DISCONNECT_P2P?n():o(c)}else n()}),this._p2pChannel.on(We.RequestUnmuteLocal,async(e,n,o)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),n()}catch(c){c.code===Q.DISCONNECT_P2P?n():o(c)}else n()}),this._p2pChannel.on(We.RequestRePublish,(e,n,o)=>{this.publish(e,!1).then(n).catch(o)}),this._p2pChannel.on(We.RequestRePublishDataChannel,(e,n,o)=>{Ee.all(e.map(async c=>{await this._p2pChannel.publishDataChannel([c]);const u={streamId:c.id,ordered:c.ordered,maxRetransmits:c.maxRetransmits,metadata:c.metadata,channelId:c._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,u,!0)}catch(m){if(m.code!==Q.DISCONNECT_P2P)throw m}})).then(n).catch(o)}),this._p2pChannel.on(We.RequestReSubscribe,async(e,n,o)=>{try{for(const{user:c,kind:u}of e)u===gt.VIDEO?await this.subscribe(c,"video"):await this.subscribe(c,"audio");n()}catch(c){o(c)}}),this._p2pChannel.on(We.RequestUpload,(e,n)=>{this._gateway.upload(e,n)}),this._p2pChannel.on(We.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(We.MediaReconnectStart,e=>{this.safeEmit(hn.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(We.MediaReconnectEnd,e=>{this.safeEmit(hn.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(We.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(We.RequestRestartICE,async e=>{if(this._p2pChannel instanceof ns)return;const n=await this._p2pChannel.restartICE(e),o=await n.next();if(o.done)return;const c=o.value;let u;try{u=await this._gateway.restartICE({iceParameters:c})}catch(_){return void n.throw(_)}const{iceParameters:m}=function(_){const S=_.iceParameters;return{iceParameters:{iceUfrag:S.iceUfrag,icePwd:S.icePwd}}}(u);await n.next({remoteIceParameters:m})}),this._p2pChannel.on(We.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(We.RequestReconnectPC,async()=>{var e;const{iceParameters:n,dtlsParameters:o,rtpCapabilities:c}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:u,gatewayAddress:m}=await this._gateway.reconnectPC({iceParameters:n,dtlsParameters:o,rtpCapabilities:c}),{dtlsParameters:_,iceParameters:S,candidates:C,rtpCapabilities:R,setup:w,cname:N}=B(u,m);await this._p2pChannel.connect(S,_,C,R,w,N),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(We.RequestUnpublishForReconnectPC,async(e,n,o)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),n()):o()}),this._p2pChannel.on(We.P2PLost,()=>{this.safeEmit(hn.P2P_LOST,this.store.uid)}),this._p2pChannel.on(We.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(We.ConnectionTypeChange,e=>{this.safeEmit(hn.IS_USING_CLOUD_PROXY,e)}),this._p2pChannel.on(We.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(We.QueryClientConnectionState,e=>{e(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new Te(Q.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new Te(Q.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const n=[...new Set(e.inspectType)];n.forEach(o=>{var c;if(!xe(c=["supervise","moderation"]).call(c,o))throw new Te(Q.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(o," is not a valid inspect type."))}),e.inspectType=n}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new Te(Q.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const n=new rL(e);this._inspect=n,this.handleVideoInspectEvents(this._inspect),await n.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},or)}catch(n){throw Array.isArray(n)?n[0]:n}}async disableContentInspect(){if(!this._inspect)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,n){if(nl(e,"enabled"),e){if(!n)throw new Te(Q.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(Jn(n.interval,"interval",1e3,1/0),n&&n.extraInfo&&n.extraInfo.length>1024)throw new Te(Q.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(n&&n.vendor&&n.vendor.length>1024)throw new Te(Q.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(n);const o=new iG(n);this._moderation=o,this.handleImageModerationEvents(this._moderation),await o.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},or)}catch(o){throw Array.isArray(o)?o[0]:o}}else{if(!this._moderation)throw new Te(Q.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(o){throw Array.isArray(o)?o[0]:o}}}setP2PTransport(e){if(function(n){Rr(n,"transport",["default","auto","relay","sd-rtn"])}(e),this.mode!=="p2p")throw new Te(Q.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,M.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(Rs.CONNECTION_STATE_CHANGE,(n,o)=>{if(this.safeEmit(hn.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,n,o),n===ci.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new Te(Q.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(Rs.CLIENT_LOCAL_VIDEO_TRACK,n=>{n(this.localTracks.filter(o=>o.trackMediaType==="video")[0])})}handleVideoInspectEvents(e){e.on(Yt.CONNECTION_STATE_CHANGE,(n,o)=>{if(this.safeEmit(hn.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,n,o),o===$r.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(hn.CONTENT_INSPECT_ERROR,new Te(Q.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(Yt.INSPECT_RESULT,(n,o)=>{var c;if((o==null?void 0:o.code)===Q.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return M.debug("Stop inspect content because that has left channel"),this==null||(c=this._inspect)===null||c===void 0||c.close(),void(this._inspect=void 0);this.safeEmit(hn.CONTENT_INSPECT_RESULT,n,o)}),e.on(Yt.CLIENT_LOCAL_VIDEO_TRACK,n=>{n(this.localTracks.filter(o=>o.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return M.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){nl(e,"enabled"),Kn("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,n){switch(n){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ni.prototype,"leave",null),Ge([Lt({argsMap:(r,e)=>{if(!Array.isArray(e)){if(!(e instanceof di))return[e];e=[e]}return e.map(n=>n?Object(n).toString():"null")}}),z("design:type",Function),z("design:paramtypes",[Object,Boolean]),z("design:returntype",Ee)],ni.prototype,"publish",null),Ge([Lt({argsMap:(r,e)=>(e||(e=[]),e instanceof R3?[e.getChannelId()]:(Array.isArray(e)||(e=[e]),e.map(n=>n.getTrackId())))}),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ni.prototype,"unpublish",null),Ge([Lt({argsMap:(r,e,n,o)=>[e.uid,n,o]}),z("design:type",Function),z("design:paramtypes",[xs,String,Number]),z("design:returntype",Ee)],ni.prototype,"subscribe",null),Ge([Lt({argsMap:(r,e,n)=>[e,n]}),z("design:type",Function),z("design:paramtypes",[Object,String]),z("design:returntype",Ee)],ni.prototype,"presubscribe",null),Ge([Lt({argsMap:(r,e)=>e.map(n=>{let{user:o,mediaType:c}=n;return[o==null?void 0:o.uid,c]})}),z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ni.prototype,"massSubscribe",null),Ge([Lt({argsMap:(r,e,n,o)=>[e.uid,n,o]}),z("design:type",Function),z("design:paramtypes",[xs,String,Number]),z("design:returntype",Ee)],ni.prototype,"unsubscribe",null),Ge([Lt({argsMap:(r,e)=>e.map(n=>{let{user:o,mediaType:c}=n;return{uid:o==null?void 0:o.uid,mediaType:c}})}),z("design:type",Function),z("design:paramtypes",[Array]),z("design:returntype",Ee)],ni.prototype,"massUnsubscribe",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ni.prototype,"setLowStreamParameter",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ni.prototype,"enableDualStream",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ni.prototype,"disableDualStream",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String,Object]),z("design:returntype",Ee)],ni.prototype,"setClientRole",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String,Boolean]),z("design:returntype",void 0)],ni.prototype,"setProxyServer",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object,Boolean]),z("design:returntype",void 0)],ni.prototype,"setTurnServer",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",void 0)],ni.prototype,"setLicense",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Number]),z("design:returntype",void 0)],ni.prototype,"startProxyServer",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],ni.prototype,"stopProxyServer",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",void 0)],ni.prototype,"setLocalAccessPointsV2",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Array,String]),z("design:returntype",void 0)],ni.prototype,"setLocalAccessPoints",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Number]),z("design:returntype",Ee)],ni.prototype,"setRemoteDefaultVideoStreamType",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object,Number]),z("design:returntype",Ee)],ni.prototype,"setRemoteVideoStreamType",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object,Number]),z("design:returntype",Ee)],ni.prototype,"setStreamFallbackOption",null),Ge([Lt({argsMap:(r,e)=>[e]}),z("design:type",Function),z("design:paramtypes",[String,String,Uint8Array,Boolean]),z("design:returntype",void 0)],ni.prototype,"setEncryptionConfig",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],ni.prototype,"renewToken",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",void 0)],ni.prototype,"enableAudioVolumeIndicator",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String,Boolean]),z("design:returntype",Ee)],ni.prototype,"startLiveStreaming",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ni.prototype,"setLiveTranscoding",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",Ee)],ni.prototype,"stopLiveStreaming",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String,Object]),z("design:returntype",Ee)],ni.prototype,"addInjectStreamUrl",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ni.prototype,"removeInjectStreamUrl",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Zk]),z("design:returntype",Ee)],ni.prototype,"startChannelMediaRelay",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Zk]),z("design:returntype",Ee)],ni.prototype,"updateChannelMediaRelay",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ni.prototype,"stopChannelMediaRelay",null),Ge([Lt({argsMap:(r,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ni.prototype,"sendCustomReportMessage",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object,Object]),z("design:returntype",Ee)],ni.prototype,"pickSVCLayer",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ni.prototype,"setRTMConfig",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Object]),z("design:returntype",Ee)],ni.prototype,"enableContentInspect",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Ee)],ni.prototype,"disableContentInspect",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Boolean,Object]),z("design:returntype",Ee)],ni.prototype,"setImageModeration",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[String]),z("design:returntype",void 0)],ni.prototype,"setP2PTransport",null),Ge([Lt({reportResult:!0}),z("design:type",Function),z("design:paramtypes",[]),z("design:returntype",Array)],ni.prototype,"getJoinChannelServiceRecords",null),Ge([Lt(),z("design:type",Function),z("design:paramtypes",[Boolean]),z("design:returntype",Ee)],ni.prototype,"setPublishAudioFilterEnabled",null);class S0{constructor(e,n){D(this,"id",0),D(this,"element",void 0),D(this,"peerPair",void 0),D(this,"context",void 0),D(this,"audioPlayerElement",void 0),D(this,"audioTrack",void 0),S0.count+=1,this.id=S0.count,this.element=e,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const n=document.createElement("audio");n.srcObject=new MediaStream([e.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const e=async(o,c)=>{const u=c==="offer"?await o.createOffer():await o.createAnswer();return await o.setLocalDescription(u),o.iceGatheringState==="complete"?o.localDescription:new Ee(m=>{o.onicegatheringstatechange=()=>{o.iceGatheringState==="complete"&&m(o.localDescription)}})},n=async(o,c)=>await o.setRemoteDescription(c);try{const o=await e(this.peerPair[0],"offer");await n(this.peerPair[1],o);const c=await e(this.peerPair[1],"answer");await n(this.peerPair[0],c)}catch(o){throw new Te(Q.LOCAL_AEC_ERROR,o.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let n;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(n)}catch(c){throw new Te(Q.LOCAL_AEC_ERROR,c.toString()).print()}if(!n)throw new Te(Q.LOCAL_AEC_ERROR,"no dest node when local aec").print();const o=n.stream.getAudioTracks()[0];return this.audioTrack=o,o}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,n=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){M.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}D(S0,"count",0);const Az=window.AudioContext||window.webkitAudioContext;class Z5{constructor(){D(this,"units",[]),D(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return M.debug("the system does not need to process local aec"),-1;this.context||(this.context=new Az);let n=this.units.find(o=>o&&o.getElement()===e);return n||(n=new S0(e,this.context),this.units.push(n)),n.startEchoCancellation(),M.debug("start processing local audio echo cancellation, id is",n.id),n.id}_doesEnvironmentNeedAEC(){return qt().name!==Pn.SAFARI}}Ge([Lt({report:vt}),z("design:type",Function),z("design:paramtypes",[HTMLAudioElement]),z("design:returntype",Number)],Z5.prototype,"processExternalMediaAEC",null);const wz=new Z5;function $5(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(c){return Object.getOwnPropertyDescriptor(r,c).enumerable})),n.push.apply(n,o)}return n}function eH(r){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?$5(Object(n),!0).forEach(function(o){D(r,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):$5(Object(n)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(n,o))})}return r}const sG=window||document;function tH(r){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!sG)return;const n=xr._cspEventHandlerPointer;if(n&&e)return void console.error(n,e);const o=c=>{if(!(c&&c.blockedURI&&(xr.onSecurityPolicyViolation||xr.getListeners(Gr.SECURITY_POLICY_VIOLATION).length>0)))return;const u=c.blockedURI;oe("CSP_DETECTED_HOSTNAME_LIST").some(m=>xe(u).call(u,m))&&(xr.onSecurityPolicyViolation&&typeof xr.onSecurityPolicyViolation=="function"&&xr.onSecurityPolicyViolation(c),xr.getListeners(Gr.SECURITY_POLICY_VIOLATION).length>0&&xr.safeEmit(Gr.SECURITY_POLICY_VIOLATION,c))};n&&sG.removeEventListener("securitypolicyviolation",n),(e||r&&typeof r=="function"||xr.getListeners(Gr.SECURITY_POLICY_VIOLATION).length>0)&&sG.addEventListener("securitypolicyviolation",o),xr._cspEventHandlerPointer=o}Kn("PROCESS_ID","process-".concat(oi(8,""),"-").concat(oi(4,""),"-").concat(oi(4,""),"-").concat(oi(4,""),"-").concat(oi(12,""))),function(){let r;try{r=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void M.error("Error loading sdk config",e.message)}if(r)try{const e=JSON.parse(window.atob(r)),n=Date.now();M.debug("Loading global parameters from cache",e),Object.keys(e).forEach(o=>{if(Object.prototype.hasOwnProperty.call(Ss,o)){const{value:c,expires:u}=e[o];if(u&&u<=n)return;uh[o]=c,Ss[o]=c}})}catch(e){M.error("Error loading mutableParamsCache: ".concat(r),e.message)}}(),Array.isArray(uh.AREAS)&&uh.AREAS.length>0&&pf(uh.AREAS,!0);const nH=(r,e,n)=>{M.debug("setParameter key:".concat(r,", value:").concat(JSON.stringify(e))),Kn(r,e,n)},xr=function(r){const e=new Dt,n=r,o={getListeners:e.getListeners.bind(e),on:(c,u)=>(function(m,_){m===Gr.SECURITY_POLICY_VIOLATION&&tH(_,!0)}(c,u),e.on.bind(e)(c,u)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return eH(eH({},n),o)}({__TRACK_LIST__:ha,VERSION:mr,BUILD:cf,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:nH,getParameter:oe,getSupportedCodec:async function(){let r={audio:[],video:[]};try{let e=new RTCPeerConnection;e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});const n=(await e.createOffer()).sdp;if(!n)return r;e.close(),e=null,r=function(o){const c={video:[],audio:[]};return o.match(/ VP8/i)&&c.video.push("VP8"),o.match(/ VP9/i)&&c.video.push("VP9"),o.match(/ AV1/i)&&c.video.push("AV1"),o.match(/ H264/i)&&c.video.push("H264"),o.match(/ H265/i)&&c.video.push("H265"),o.match(/ opus/i)&&c.audio.push("OPUS"),o.match(/ PCMU/i)&&c.audio.push("PCMU"),o.match(/ PCMA/i)&&c.audio.push("PCMA"),o.match(/ G722/i)&&c.audio.push("G722"),c}(n)}catch(e){throw new Te(Q.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return r},checkSystemRequirements:function(){const r=vt.reportApiInvoke(null,{name:Si.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:wi.TRACER});let e=!1;try{const u=window.RTCPeerConnection,m=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,_=window.WebSocket;e=!!(u&&m&&_)}catch(u){return M.error("check system requirement failed: ",u),!1}let n=!1;const o=qt();o.name===Pn.CHROME&&Number(o.version)>=58&&(!vD()||CD())&&(n=!0),o.name===Pn.FIREFOX&&Number(o.version)>=56&&(n=!0),o.name===Pn.OPERA&&Number(o.version)>=45&&(n=!0),o.name===Pn.SAFARI&&Number(o.version)>=11&&(n=!0),($l()||qt().name===Pn.QQ)&&(n=!0),M.debug("checkSystemRequirements, api:",e,"browser",n);const c=e&&n;return r.onSuccess(c),c},getDevices:function(r){return _a.enumerateDevices(!0,!0,r)},getMicrophones:function(r){return _a.getRecordingDevices(r)},getCameras:function(r){return _a.getCamerasDevices(r)},getElectronScreenSources:$w,getPlaybackDevices:function(r){return _a.getSpeakers(r)},createClient:function(){var r;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=vt.reportApiInvoke(null,{name:Si.CREATE_CLIENT,options:[e],tag:wi.TRACER});try{(function(o){Rr(o.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Rr(o.mode,"config.mode",["rtc","live","p2p"]),o.audioCodec!==void 0&&Rr(o.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),o.proxyServer!==void 0&&Xr(o.proxyServer,"config.proxyServer",1,1e4),o.turnServer!==void 0&&HA(o.turnServer),o.httpRetryConfig!==void 0&&ih(o.httpRetryConfig),o.websocketRetryConfig!==void 0&&ih(o.websocketRetryConfig)})(e)}catch(o){throw n.onError(o),o}return Iz()||(e.codec==="vp9"&&(e.codec="vp8",M.debug("browser not support vp9, force use vp8")),Kn("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),n.onSuccess(),new ni(xu(xu({forceWaitGatewayResponse:!0},e),{},{role:xe(r=["rtc","p2p"]).call(r,e.mode)?"host":e.role||"audience"}))},createCameraVideoTrack:async function(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CREATE_CAM_VIDEO_TRACK,options:[Og({},r)]}),n=TC(r),o=oi(8,"track-cam-");let c=null;const u=r.encoderConfig==="720p_auto";M.info("start create camera video track with config",JSON.stringify(r),"trackId",o);try{c=(await fa({video:n},o)).getVideoTracks()[0]||null}catch(_){throw e.onError(_),_}if(!c){const _=new ke(Q.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(_),_.throw(M)}r.optimizationMode&&yC(o,c,r,zc(r.encoderConfig));const m=new _l(c,r,n,r.scalabiltyMode?Gp(r.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},r.optimizationMode,o);return u&&m.startMonitorStats(),e.onSuccess(m.getTrackId()),M.info("create camera video success, trackId:",o),m},createCustomVideoTrack:function(r){const e=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CREATE_CUSTOM_VIDEO_TRACK,options:[r]}),n=new on(r.mediaStreamTrack,{width:r.width,height:r.height,frameRate:r.frameRate,bitrateMax:r.bitrateMax,bitrateMin:r.bitrateMin},r.scalabiltyMode?Gp(r.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},r.optimizationMode,oi(8,"track-cus-"),[hi.CUSTOM_TRACK]);return e.onSuccess(n.getTrackId()),M.info("create custom video track success with config",r,"trackId",n.getTrackId()),n},createScreenVideoTrack:async function(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const n=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CREATE_SCREEN_VIDEO_TRACK,options:[Og({},r),e]}),o=r.encoderConfig==="720p_auto";r.encoderConfig?typeof r.encoderConfig=="string"||r.encoderConfig.width&&r.encoderConfig.height||(r.encoderConfig.width={max:1920},r.encoderConfig.height={max:1080}):r.encoderConfig="1080p_2";const c=function(w){const N={};w.screenSourceType&&(N.mediaSource=w.screenSourceType),w.extensionId&&tl()&&(N.extensionId=w.extensionId);const{displaySurface:L,selfBrowserSurface:H,surfaceSwitching:j,systemAudio:W}=w;(DT(107)||Id(107)||FA(93))&&(L&&(Rr(L,"displaySurface",["browser","window","monitor"]),N.displaySurface=L),H?(Rr(H,"selfBrowserSurface",["exclude","include"]),N.selfBrowserSurface=H):N.selfBrowserSurface="include",j&&(Rr(j,"surfaceSwitching",["exclude","include"]),N.surfaceSwitching=j)),(DT(105)||Id(105)||FA(91))&&W&&(Rr(W,"systemAudio",["exclude","include"]),N.systemAudio=W),w.electronScreenSourceId&&(N.sourceId=w.electronScreenSourceId);const ee=w.encoderConfig?Jw(w.encoderConfig):null;return N.mandatory={chromeMediaSource:"desktop",maxWidth:ee?ee.width:void 0,maxHeight:ee?ee.height:void 0},ee&&(ee.frameRate&&(typeof ee.frameRate=="number"?(N.mandatory.maxFrameRate=ee.frameRate,N.mandatory.minFrameRate=ee.frameRate):(N.mandatory.maxFrameRate=ee.frameRate.max||ee.frameRate.ideal||ee.frameRate.exact||void 0,N.mandatory.minFrameRate=ee.frameRate.min||ee.frameRate.ideal||ee.frameRate.exact||void 0),N.frameRate=ee.frameRate),ee.width&&(N.width=ee.width),ee.height&&(N.height=ee.height)),N}(r),u=oi(8,"track-scr-v-");let m=null,_=null;const S=Dn();if(!S.supportShareAudio&&e==="enable"){const w=new ke(Q.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return n.onError(w),w.throw(M)}M.info("start create screen video track with config",r,"withAudio",e,"trackId",u);try{const w=await fa({screen:c,screenAudio:e==="auto"?S.supportShareAudio:e==="enable"},u);m=w.getVideoTracks()[0]||null,_=w.getAudioTracks()[0]||null}catch(w){throw n.onError(w),w}if(!m){const w=new ke(Q.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(w),w.throw(M)}if(!_&&e==="enable"){m&&m.stop();const w=new ke(Q.SHARE_AUDIO_NOT_ALLOWED);return n.onError(w),w.throw(M)}r.optimizationMode||(r.optimizationMode="detail"),r.optimizationMode&&(yC(u,m,r,r.encoderConfig&&Jw(r.encoderConfig)||void 0),r.encoderConfig&&typeof r.encoderConfig!="string"&&(r.encoderConfig.bitrateMin=r.encoderConfig.bitrateMax));const C=new on(m,r.encoderConfig?Jw(r.encoderConfig):{},r.scalabiltyMode?Gp(r.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},r.optimizationMode,u,[hi.SCREEN_TRACK]);if(o&&C.startMonitorStats(),!_)return n.onSuccess(C.getTrackId()),M.info("create screen video track success","video:",C.getTrackId()),C;const R=new xn(_,void 0,oi(8,"track-scr-a-"),!1);return n.onSuccess([C.getTrackId(),R.getTrackId()]),M.info("create screen video track success","video:",C.getTrackId(),"audio:",R.getTrackId()),[C,R]},createMicrophoneAndCameraTracks:async function(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CREATE_MIC_AND_CAM_TRACKS,options:[r,e]}),o=e.encoderConfig==="720p_auto",c=TC(e),u=CC(r),m=oi(8,"track-mic-"),_=oi(8,"track-cam-");let S=null,C=null;M.info("start create camera video track(".concat(_,") and microphone audio track(").concat(m,") with config, audio: ").concat(JSON.stringify(r),", video: ").concat(JSON.stringify(e)));try{const N=await fa({audio:u,video:c},"".concat(m,"-").concat(_));S=N.getAudioTracks()[0],C=N.getVideoTracks()[0]}catch(N){throw n.onError(N),N}if(!S||!C){const N=new ke(Q.UNEXPECTED_ERROR,"can not find tracks in media stream");return n.onError(N),N.throw(M)}e.optimizationMode&&yC(_,C,e,zc(e.encoderConfig));const R=new hu(S,r,u,m),w=new _l(C,e,c,e.scalabiltyMode?Gp(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,_);return o&&w.startMonitorStats(),n.onSuccess([R.getTrackId(),w.getTrackId()]),M.info("create camera video track(".concat(_,") and microphone audio track(").concat(m,") success")),[R,w]},createMicrophoneAudioTrack:async function(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CREATE_MIC_AUDIO_TRACK,options:[r]}),n=CC(r),o=oi(8,"track-mic-");let c=null;M.info("start create microphone audio track with config",JSON.stringify(r),"trackId",o);try{c=(await fa({audio:n},o)).getAudioTracks()[0]||null}catch(m){throw e.onError(m),m}if(!c){const m=new ke(Q.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(m),m.throw(M)}const u=new hu(c,r,n,o);return e.onSuccess(u.getTrackId()),M.info("create microphone audio track success, trackId:",o),u},createCustomAudioTrack:function(r){const e=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CREATE_CUSTOM_AUDIO_TRACK,options:[r]}),n=new xn(r.mediaStreamTrack,r.encoderConfig?pC(r.encoderConfig):{},oi(8,"track-cus-"),!1);return M.info("create custom audio track success with config",r,"trackId",n.getTrackId()),e.onSuccess(n.getTrackId()),n},createBufferSourceAudioTrack:async function(r){var e;const{cacheOnlineFile:n,encoderConfig:o}=r;let{source:c}=r;const u={source:c instanceof AudioBuffer?"AudioBuffer":c instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":c,cacheOnlineFile:n,encoderConfig:o},m=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CREATE_BUFFER_AUDIO_TRACK,options:[u]});if(oe("DISABLE_WEBAUDIO"))throw new ke(Q.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const _=oi(8,"track-buf-");M.info("start create buffer source audio track with config",JSON.stringify(u),"trackId",_);const S=c;if(!(c instanceof AudioBuffer))try{c=await Vn(c,n)}catch(w){return m.onError(w),w.throw(M)}const C=new UP(c),R=new Rh(S,C,o?pC(o):{},_);return M.info("create buffer source audio track success, trackId:",_),m.onSuccess(R.getTrackId()),R},setAppType:function(r){if(M.debug("setAppType: ".concat(r)),!(Number.isInteger(r)&&r>=0))throw M.debug("Invalid appType"),new Te(Q.INVALID_PARAMS,"invalid app type",r);Kn("APP_TYPE",Math.floor(r))},setLogLevel:function(r){M.setLogLevel(r)},enableLogUpload:function(){oe("USE_NEW_LOG")?Kn("UPLOAD_LOG",!0):M.enableLogUpload()},disableLogUpload:function(){oe("USE_NEW_LOG")?Kn("UPLOAD_LOG",!1):M.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new Zk},checkAudioTrackIsActive:async function(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(r instanceof xn||r instanceof jt)){const S=new Te(Q.INVALID_TRACK,"the parameter is not a audio track");return n.onError(S),S.throw()}e&&e<1e3&&(e=1e3);const o=r instanceof xn?r.getTrackLabel():"remote_track",c=r.getVolumeLevel();let u=c,m=c;const _=Date.now();return new Ee(S=>{const C=setInterval(()=>{const R=r.getVolumeLevel();u=R>u?R:u,m=R<m?R:m;const w=u-m>1e-4,N=Date.now()-_;if(w||N>e){clearInterval(C);const L=w,H={duration:N,deviceLabel:o,maxVolumeLevel:u,result:L};M.info("[track-".concat(r.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(H))),n.onSuccess(H),S(L)}},200)})},checkVideoTrackIsActive:async function(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=vt.reportApiInvoke(null,{tag:wi.TRACER,name:Si.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(r instanceof on||r instanceof ps)){const w=new Te(Q.INVALID_TRACK,"the parameter is not a video track");return n.onError(w),w.throw()}e&&e<1e3&&(e=1e3);const o=r instanceof on?r.getTrackLabel():"remote_track",c=r.getMediaStreamTrack(!0),u=document.createElement("video");u.style.width="1px",u.style.height="1px",u.setAttribute("muted",""),u.muted=!0,u.setAttribute("playsinline",""),u.controls=!1,(Jr()||Xm())&&(u.style.opacity="0.01",u.style.position="fixed",u.style.left="0",u.style.top="0",document.body.appendChild(u)),u.srcObject=new MediaStream([c]),u.play();const m=document.createElement("canvas");m.width=160,m.height=120;let _=0,S=0;try{const w=Date.now();_=await function(N,L,H,j){let W,ee=0,re=null;return new Ee((fe,be)=>{function _e(){ee>j&&W&&(W(),fe(ee));const ye=H.getContext("2d");if(!ye){const et=new Te(Q.UNEXPECTED_ERROR,"can not get canvas 2d context.");return M.error(et.toString()),void be(et)}ye.drawImage(N,0,0,160,120);const Le=ye.getImageData(0,0,H.width,H.height),Me=Math.floor(Le.data.length/3);if(re){for(let et=0;et<Me;et+=3)if(Le.data[et]!==re[et])return ee+=1,void(re=Le.data);re=Le.data}else re=Le.data}setTimeout(()=>{W&&(W(),fe(ee))},L),W=Xw(()=>{_e()},30)})}(u,e,m,4),S=Date.now()-w}catch(w){throw n.onError(w),w}yz===Pn.SAFARI&&(u.pause(),u.remove()),u.srcObject=null;const C=_>4,R={duration:S,changedPicNum:_,deviceLabel:o,result:C};return M.info("[track-".concat(r.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(R))),n.onSuccess(R),C},setArea:pf,audioElementPlayCenter:So,resumeAudioContext:function(){So.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(r){wz.processExternalMediaAEC(r)},registerExtensions:function(r){const e=oe("PLUGIN_INFO")||[];r.forEach(n=>{"name"in n&&!xe(e).call(e,n.name)&&e.push(n.name);const o=n;o.__registered__=!0,o.logger.hookLog=M.extLog,o.reporter.hookApiInvoke=vt.extApiInvoke,o.parameters&&Object.keys(o.parameters).forEach(c=>{o.parameters[c]=oe(c)})}),nH("PLUGIN_INFO",e)},ChannelMediaRelayError:Ti,ChannelMediaRelayEvent:Cs,ChannelMediaRelayState:hs,RemoteStreamFallbackType:fC,RemoteStreamType:gh,ConnectionDisconnectedReason:un,AudienceLatencyLevelType:nh,AREAS:At});return Object.defineProperties(xr,{onAudioAutoplayFailed:{get:()=>Va.onAudioAutoplayFailed,set:r=>{Va.onAudioAutoplayFailed=r}},onAutoplayFailed:{get:()=>Va.onAutoplayFailed,set:r=>{Va.onAutoplayFailed=r}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>xr._onSecurityPolicyViolation,set(r){xr._onSecurityPolicyViolation=r,tH(r)}},__CLIENT_LIST__:{get:()=>oe("SHOW_GLOBAL_CLIENT_LIST")?bt:[]}}),_a.on(uu.CAMERA_DEVICE_CHANGED,r=>{M.info("camera device changed",JSON.stringify(r)),xr.onCameraChanged&&xr.onCameraChanged(r),xr.safeEmit(Gr.CAMERA_CHANGED,r)}),_a.on(uu.RECORDING_DEVICE_CHANGED,r=>{M.info("microphone device changed",JSON.stringify(r)),xr.onMicrophoneChanged&&xr.onMicrophoneChanged(r),xr.safeEmit(Gr.MICROPHONE_CHANGED,r)}),_a.on(uu.PLAYOUT_DEVICE_CHANGED,r=>{M.debug("playout device changed",JSON.stringify(r)),xr.onPlaybackDeviceChanged&&xr.onPlaybackDeviceChanged(r),xr.safeEmit(Gr.PLAYBACK_DEVICE_CHANGED,r)}),So.onAutoplayFailed=()=>{M.info("detect audio element autoplay failed"),Va.onAudioAutoplayFailed&&Va.onAudioAutoplayFailed()},tn.on("autoplay-failed",()=>{M.info("detect webaudio autoplay failed"),Va.onAudioAutoplayFailed&&Va.onAudioAutoplayFailed(),xr.safeEmit(Gr.AUTOPLAY_FAILED)}),tn.on(Nr.STATE_CHANGE,(r,e)=>{M.info("audio context state changed: ".concat(e," => ").concat(r)),xr.onAudioContextStateChanged&&xr.onAudioContextStateChanged(r,e),xr.safeEmit(Gr.AUDIO_CONTEXT_STATE_CHANGED,r,e)}),ki.on(us.NETWORK_STATE_CHANGE,(r,e)=>{M.info("[network-indicator] network state changed, ".concat(e," => ").concat(r))}),window&&(window.__ARTC__=xr),xr})})(qY);var TZ=qY.exports;const CZ=WW(TZ);function vZ(d={channelName,AppID,token}){const{AppID:h,channelName:E,token:T}=d,{isLoading:A,localMicrophoneTrack:O}=xY(!0),{isLoading:V,localCameraTrack:X}=VY(!0),$=jY();console.log(O,X),UY([O,X]),MY({appid:h,channel:E,token:T===""?null:T});const{audioTracks:ne}=FY($);return ne.map(ae=>ae.play()),A||V?F.jsx("div",{style:PL.grid,children:"Loading devices..."}):F.jsxs("div",{style:{...PL.grid,...RZ($)},children:[F.jsx(e5,{track:X,play:!0,style:PL.gridCell}),$.map(ae=>F.jsx(zY,{user:ae,style:PL.gridCell}))]})}const RZ=d=>({gridTemplateColumns:d.length>8?DL.repeat(4):d.length>3?DL.repeat(3):d.length>0?DL.repeat(2):DL}),DL="minmax(0, 1fr) ",PL={grid:{width:"1000px",height:"500px",display:"grid",borderStyle:"solid",borderWidth:"1px"},gridCell:{height:"100%",width:"100%"},container:{display:"flex",flexDirection:"column",flex:1,justifyContent:"center"}};function yZ(d){const{AppID:h,setAppID:E,channelName:T,setChannelName:A,token:O,setToken:V,setInCall:X}=d;return F.jsxs("div",{children:[F.jsxs("p",{children:["Please enter your Agora AppID and Channel Name ",h]}),F.jsx("label",{htmlFor:"appid",children:"Agora App ID: "}),F.jsx("input",{id:"appid",type:"text",value:h,onChange:$=>E($.target.value),placeholder:"required"}),F.jsx("br",{}),F.jsx("br",{}),F.jsx("label",{htmlFor:"channel",children:"Channel Name: "}),F.jsx("input",{id:"channel",type:"text",value:T,onChange:$=>A($.target.value),placeholder:"required"}),F.jsx("br",{}),F.jsx("br",{}),F.jsx("label",{htmlFor:"token",children:"Channel Token: "}),F.jsx("input",{id:"token",type:"text",value:O,onChange:$=>V($.target.value),placeholder:"optional"}),F.jsx("br",{}),F.jsx("br",{}),F.jsx("button",{onClick:()=>h&&T?X(!0):alert("Please enter Agora App ID and Channel Name"),children:"Join"})]})}function IZ(){const[d,h]=sY(),E=d.get("token"),T=d.get("name"),A=Ml(CZ.createClient({codec:"vp8",mode:"rtc"})),[O,V]=Oe.useState(T),[X,$]=Oe.useState("7a26c47116cf4606a08da84ce7d9cb47"),[ne,le]=Oe.useState(E),[ae,ge]=Oe.useState(!1),je=()=>(ge(!1),F.jsx("div",{children:"Rate the session:"}));return F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Exchange Session"}),ae?F.jsxs(kY,{client:A,children:[F.jsx(vZ,{channelName:O,AppID:X,token:ne}),F.jsx("br",{}),F.jsx("br",{}),F.jsx("button",{style:{margin:"auto",alignContent:"center"},onClick:()=>je(),children:"End Call"})]}):F.jsx(yZ,{AppID:X,setAppID:$,channelName:O,setChannelName:V,token:ne,setToken:le,setInCall:ge})]})}function AZ(){return F.jsx(F.Fragment,{children:F.jsx("h1",{children:"404"})})}function wZ(){let d=Zs();const[h,E]=sY(),T=h.get("skill"),[A,O]=Oe.useState(T||""),[V,X]=Oe.useState([]),[$,ne]=Oe.useState("username"),[le,ae]=Oe.useState("user"),ge=localStorage.getItem("token"),je=async ue=>{if(ge){const tt=await(await fetch("https://experienceexchange.onrender.com/user/search-skill",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({skill:ue.toLowerCase().trim()})}).catch(Rt=>{console.log(Rt)})).json();console.log(tt),X(tt)}else Tn.error("Log in to use Search",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},Fe=async()=>{if(ge){const ve=await(await fetch("https://experienceexchange.onrender.com/user/search-username",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({username:A.toLowerCase().trim()})}).catch(tt=>{console.log(tt)})).json();console.log(V),X(ve)}else Tn.error("Log in to use Search",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},we=async()=>{if(ge){const ve=await(await fetch("https://experienceexchange.onrender.com/post/search-username",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:A.toLowerCase().trim()})}).catch(tt=>{console.log(tt)})).json();console.log(ve),X(ve)}else Tn.error("Log in to use Search",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},Ye=async()=>{if(ge){const ve=await(await fetch("https://experienceexchange.onrender.com/post/search-skill",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({skill:A.toLowerCase().trim()})}).catch(tt=>{console.log(tt)})).json();console.log(ve),X(ve)}else Tn.error("Log in to use Search",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},Se=()=>{le==="user"?$==="skill"?je(A):Fe():$==="skill"?Ye():we()};return Oe.useEffect(()=>{T&&je(T)},[]),F.jsxs(F.Fragment,{children:[F.jsxs("div",{className:Ae.checkBoxContainer,style:{width:"480px",height:"200px"},children:[F.jsxs("div",{className:Ae.searchContainer,children:[F.jsx(ss,{icon:"icon-park-solid:voice",className:Ae.voiceSearchIcon}),F.jsx("input",{className:Ae.searchBar,type:"text",placeholder:"Search for a skill to start learning...",value:A,onChange:ue=>O(ue.target.value)}),F.jsx(ss,{className:Ae.searchIcon,icon:"material-symbols:search",onClick:Se})]}),F.jsx("span",{children:"Search for: "}),F.jsxs("div",{children:[F.jsx("input",{type:"radio",id:"user",name:"userOrPost",value:"user",defaultChecked:"true",onChange:ue=>{ae(ue.target.value),X([])}}),F.jsx("label",{htmlFor:"userOrPost",children:"Users "}),F.jsx("input",{type:"radio",id:"post",name:"userOrPost",value:"post",onChange:ue=>{ae(ue.target.value),X([])}}),F.jsx("label",{htmlFor:"text",children:"Posts "})]}),F.jsx("span",{children:"Search by: "}),F.jsxs("div",{children:[F.jsx("input",{type:"radio",id:"username",name:"userOrSkill",value:"username",defaultChecked:"true",onChange:ue=>{ne(ue.target.value),X([])}}),F.jsx("label",{htmlFor:"userOrSkill",children:"Username "}),F.jsx("input",{type:"radio",id:"skill",name:"userOrSkill",value:"skill",onChange:ue=>{ne(ue.target.value),X([])}}),F.jsx("label",{htmlFor:"text",children:"Skill/Tag "})]})]}),F.jsx("div",{className:Ae.postsPageMainContainer,children:V.map((ue,ve)=>le==="user"?F.jsx("div",{children:F.jsx(F.Fragment,{children:F.jsxs("div",{onClick:()=>d(`/user/${ue.username}`),style:{cursor:"pointer"},className:Ae.postContainer,children:[F.jsx("div",{style:{justifyContent:"center"},className:Ae.postTop,children:F.jsx("div",{children:F.jsx("img",{style:{width:"70px",height:"70px",borderStyle:"solid",borderWidth:"1px"},className:Ae.postImg,src:`./public/profile/${ue.profileImage}`,alt:"profile pic"})})}),F.jsx("div",{children:F.jsxs("p",{style:{textAlign:"center"},children:["@",ue.username]})}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("div",{className:Ae.postFooter,style:{justifyContent:"center"},children:F.jsx("p",{children:ue.skills?ue.skills.join(", "):null})})]})})},ve):F.jsx("div",{children:F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.postContainer,children:[F.jsxs("div",{className:Ae.postTop,children:[F.jsx("div",{}),F.jsxs("div",{style:{textAlign:"center"},className:Ae.postUsername,children:["@",ue.creator]})]}),F.jsx("div",{children:F.jsx("p",{style:{textAlign:"center"},children:ue.content})}),F.jsxs("div",{className:Ae.postFooter,children:[F.jsx("span",{className:Ae.postFooterShowComments,children:"Comments"}),F.jsx("div",{className:Ae.postFooterTag,children:ue.tags})]})]})})},ve))})]})}function bZ(){Zs();const d=j4();localStorage.getItem("token");const[h,E]=Oe.useState(""),[T,A]=Oe.useState(""),[O,V]=Oe.useState(""),[X,$]=Oe.useState(""),[ne,le]=Oe.useState([""]),ae=d.userId,ge=async()=>{const Ye=await(await fetch("https://experienceexchange.onrender.com/user/get-user",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({username:ae})}).catch(Se=>{console.log(Se)})).json();console.log(Ye),le(Ye),console.log(ne)},je=async we=>{we.preventDefault();const Se=await(await fetch("https://experienceexchange.onrender.com/user/new-messages",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({toUser:ae,fromUser:userTokenData.username,content:T})}).catch(ue=>{console.log(ue),Tn.success(ue,{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})})).json();Se.status>=400?Tn.error(Se.message,{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}):Tn.success("Message Sent!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),console.log(Se),A("")},Fe=async we=>{we.preventDefault();const Se=await(await fetch("https://experienceexchange.onrender.com/user/new-request",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({toUser:ae,fromUser:userTokenData.username,channel:O,content:X})}).catch(ue=>{console.log(ue)})).json();Se.status>=400?Tn.error(Se.message,{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}):Tn.success("Exchange Request Sent!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),console.log(Se),$(""),V("")};return Oe.useEffect(()=>{const we=localStorage.getItem("token");if(we){const Ye=Qa(we);E(Ye.username),console.log(Ye)}ge()},[]),console.log(h),F.jsxs(F.Fragment,{children:[F.jsxs("h1",{style:{textAlign:"center"},children:["This is the profile of user: ",d.userId]}),F.jsxs("div",{style:{flexDirection:"row"},className:Ae.postsPageMainContainer,children:[F.jsxs("div",{style:{height:"580px",width:"900px"},className:Ae.detailedPostContainer,children:[F.jsxs("div",{style:{marginTop:"15px"},className:Ae.detailedPostTop,children:[F.jsx("img",{style:{width:"110px",height:"110px"},className:Ae.detailedPostImg,src:`../public/profile/${ne[0].profileImage}`,alt:"profile pic"}),F.jsxs("div",{style:{fontSize:"larger",margin:"15px"},className:Ae.detailedPostUsername,children:["@",ne[0].username]}),F.jsxs("div",{style:{fontSize:"larger",margin:"15px",fontSize:"larger",textAlign:"center"},children:["Rating: ",ne[0].rating,"/10"]})]}),F.jsx("hr",{style:{width:"95%"}}),F.jsxs("div",{style:{flexDirection:"column"},className:Ae.detailedPostMid,children:[F.jsx("p",{style:{fontSize:"larger",textAlign:"center"},children:"Biography:"}),F.jsx("p",{style:{fontSize:"larger",textAlign:"center"},children:ne[0].bio})]}),F.jsx("hr",{style:{width:"95%"}}),F.jsxs("div",{style:{flexDirection:"column"},className:Ae.detailedPostFooter,children:[F.jsx("p",{style:{fontSize:"larger",textAlign:"center"},children:"Skills:"}),F.jsx("p",{style:{fontSize:"larger",textAlign:"center"},children:ne[0].skills?ne[0].skills.join(", "):ne[0].skills})]})]}),h==ae?F.jsx(F.Fragment,{}):F.jsxs("div",{style:{width:"100%"},className:Ae.registerContainer,children:[F.jsx("div",{style:{margin:"20px"},children:F.jsxs("form",{onSubmit:je,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Type your message: "}),F.jsx("textarea",{className:Ae.contactMessage,name:"message",id:"message",cols:"40",rows:"10",required:!0,value:T,onChange:we=>{A(we.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsxs("button",{style:{width:"60%"},className:Ae.loginButton,children:["Send Message to ",ne[0].username]})]})}),F.jsx("div",{style:{margin:"20px"},children:F.jsxs("form",{onSubmit:Fe,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Channel name: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,value:O,onChange:we=>{V(we.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Additonal Information: "}),F.jsx("textarea",{className:Ae.contactMessage,name:"message",id:"message",cols:"40",rows:"10",required:!0,value:X,onChange:we=>{$(we.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{style:{width:"60%"},className:Ae.loginButton,children:"Send Exchange Session"})]})})]})]})]})}const OZ=["ahole","anus","ash0le","ash0les","asholes","ass","Ass Monkey","Assface","assh0le","assh0lez","asshole","assholes","assholz","asswipe","azzhole","bassterds","bastard","bastards","bastardz","basterds","basterdz","Biatch","bitch","bitches","Blow Job","boffing","butthole","buttwipe","c0ck","c0cks","c0k","Carpet Muncher","cawk","cawks","Clit","cnts","cntz","cock","cockhead","cock-head","cocks","CockSucker","cock-sucker","crap","cum","cunt","cunts","cuntz","dick","dild0","dild0s","dildo","dildos","dilld0","dilld0s","dominatricks","dominatrics","dominatrix","dyke","enema","f u c k","f u c k e r","fag","fag1t","faget","fagg1t","faggit","faggot","fagg0t","fagit","fags","fagz","faig","faigs","fart","flipping the bird","fuck","fucker","fuckin","fucking","fucks","Fudge Packer","fuk","Fukah","Fuken","fuker","Fukin","Fukk","Fukkah","Fukken","Fukker","Fukkin","g00k","God-damned","h00r","h0ar","h0re","hells","hoar","hoor","hoore","jackoff","jap","japs","jerk-off","jisim","jiss","jizm","jizz","knob","knobs","knobz","kunt","kunts","kuntz","Lezzian","Lipshits","Lipshitz","masochist","masokist","massterbait","masstrbait","masstrbate","masterbaiter","masterbate","masterbates","Motha Fucker","Motha Fuker","Motha Fukkah","Motha Fukker","Mother Fucker","Mother Fukah","Mother Fuker","Mother Fukkah","Mother Fukker","mother-fucker","Mutha Fucker","Mutha Fukah","Mutha Fuker","Mutha Fukkah","Mutha Fukker","n1gr","nastt","nigger;","nigur;","niiger;","niigr;","orafis","orgasim;","orgasm","orgasum","oriface","orifice","orifiss","packi","packie","packy","paki","pakie","paky","pecker","peeenus","peeenusss","peenus","peinus","pen1s","penas","penis","penis-breath","penus","penuus","Phuc","Phuck","Phuk","Phuker","Phukker","polac","polack","polak","Poonani","pr1c","pr1ck","pr1k","pusse","pussee","pussy","puuke","puuker","qweir","recktum","rectum","retard","sadist","scank","schlong","screwing","semen","sex","sexy","Sh!t","sh1t","sh1ter","sh1ts","sh1tter","sh1tz","shit","shits","shitter","Shitty","Shity","shitz","Shyt","Shyte","Shytty","Shyty","skanck","skank","skankee","skankey","skanks","Skanky","slag","slut","sluts","Slutty","slutz","son-of-a-bitch","tit","turd","va1jina","vag1na","vagiina","vagina","vaj1na","vajina","vullva","vulva","w0p","wh00r","wh0re","whore","xrated","xxx","b!+ch","bitch","blowjob","clit","arschloch","fuck","shit","ass","asshole","b!tch","b17ch","b1tch","bastard","bi+ch","boiolas","buceta","c0ck","cawk","chink","cipa","clits","cock","cum","cunt","dildo","dirsa","ejakulate","fatass","fcuk","fuk","fux0r","hoer","hore","jism","kawk","l3itch","l3i+ch","masturbate","masterbat*","masterbat3","motherfucker","s.o.b.","mofo","nazi","nigga","nigger","nutsack","phuck","pimpis","pusse","pussy","scrotum","sh!t","shemale","shi+","sh!+","slut","smut","teets","tits","boobs","b00bs","teez","testical","testicle","titt","w00se","jackoff","wank","whoar","whore","*damn","*dyke","*fuck*","*shit*","@$$","amcik","andskota","arse*","assrammer","ayir","bi7ch","bitch*","bollock*","breasts","butt-pirate","cabron","cazzo","chraa","chuj","Cock*","cunt*","d4mn","daygo","dego","dick*","dike*","dupa","dziwka","ejackulate","Ekrem*","Ekto","enculer","faen","fag*","fanculo","fanny","feces","feg","Felcher","ficken","fitt*","Flikker","foreskin","Fotze","Fu(*","fuk*","futkretzn","gook","guiena","h0r","h4x0r","hell","helvete","hoer*","honkey","Huevon","hui","injun","jizz","kanker*","kike","klootzak","kraut","knulle","kuk","kuksuger","Kurac","kurwa","kusi*","kyrpa*","lesbo","mamhoon","masturbat*","merd*","mibun","monkleigh","mouliewop","muie","mulkku","muschi","nazis","nepesaurio","nigger*","orospu","paska*","perse","picka","pierdol*","pillu*","pimmel","piss*","pizda","poontsee","poop","porn","p0rn","pr0n","preteen","pula","pule","puta","puto","qahbeh","queef*","rautenberg","schaffer","scheiss*","schlampe","schmuck","screw","sh!t*","sharmuta","sharmute","shipal","shiz","skribz","skurwysyn","sphencter","spic","spierdalaj","splooge","suka","b00b*","testicle*","titt*","twat","vittu","wank*","wetback*","wichser","wop*","yed","zabourah"],NZ={words:OZ};var DZ={"4r5e":1,"5h1t":1,"5hit":1,a55:1,anal:1,anus:1,ar5e:1,arrse:1,arse:1,ass:1,"ass-fucker":1,asses:1,assfucker:1,assfukka:1,asshole:1,assholes:1,asswhole:1,a_s_s:1,"b!tch":1,b00bs:1,b17ch:1,b1tch:1,ballbag:1,balls:1,ballsack:1,bastard:1,beastial:1,beastiality:1,bellend:1,bestial:1,bestiality:1,"bi+ch":1,biatch:1,bitch:1,bitcher:1,bitchers:1,bitches:1,bitchin:1,bitching:1,bloody:1,"blow job":1,blowjob:1,blowjobs:1,boiolas:1,bollock:1,bollok:1,boner:1,boob:1,boobs:1,booobs:1,boooobs:1,booooobs:1,booooooobs:1,breasts:1,buceta:1,bugger:1,bum:1,"bunny fucker":1,butt:1,butthole:1,buttmuch:1,buttplug:1,c0ck:1,c0cksucker:1,"carpet muncher":1,cawk:1,chink:1,cipa:1,cl1t:1,clit:1,clitoris:1,clits:1,cnut:1,cock:1,"cock-sucker":1,cockface:1,cockhead:1,cockmunch:1,cockmuncher:1,cocks:1,cocksuck:1,cocksucked:1,cocksucker:1,cocksucking:1,cocksucks:1,cocksuka:1,cocksukka:1,cok:1,cokmuncher:1,coksucka:1,coon:1,cox:1,crap:1,cum:1,cummer:1,cumming:1,cums:1,cumshot:1,cunilingus:1,cunillingus:1,cunnilingus:1,cunt:1,cuntlick:1,cuntlicker:1,cuntlicking:1,cunts:1,cyalis:1,cyberfuc:1,cyberfuck:1,cyberfucked:1,cyberfucker:1,cyberfuckers:1,cyberfucking:1,d1ck:1,damn:1,dick:1,dickhead:1,dildo:1,dildos:1,dink:1,dinks:1,dirsa:1,dlck:1,"dog-fucker":1,doggin:1,dogging:1,donkeyribber:1,doosh:1,duche:1,dyke:1,ejaculate:1,ejaculated:1,ejaculates:1,ejaculating:1,ejaculatings:1,ejaculation:1,ejakulate:1,"f u c k":1,"f u c k e r":1,f4nny:1,fag:1,fagging:1,faggitt:1,faggot:1,faggs:1,fagot:1,fagots:1,fags:1,fanny:1,fannyflaps:1,fannyfucker:1,fanyy:1,fatass:1,fcuk:1,fcuker:1,fcuking:1,feck:1,fecker:1,felching:1,fellate:1,fellatio:1,fingerfuck:1,fingerfucked:1,fingerfucker:1,fingerfuckers:1,fingerfucking:1,fingerfucks:1,fistfuck:1,fistfucked:1,fistfucker:1,fistfuckers:1,fistfucking:1,fistfuckings:1,fistfucks:1,flange:1,fook:1,fooker:1,fuck:1,fucka:1,fucked:1,fucker:1,fuckers:1,fuckhead:1,fuckheads:1,fuckin:1,fucking:1,fuckings:1,fuckingshitmotherfucker:1,fuckme:1,fucks:1,fuckwhit:1,fuckwit:1,"fudge packer":1,fudgepacker:1,fuk:1,fuker:1,fukker:1,fukkin:1,fuks:1,fukwhit:1,fukwit:1,fux:1,fux0r:1,f_u_c_k:1,gangbang:1,gangbanged:1,gangbangs:1,gaylord:1,gaysex:1,goatse:1,God:1,"god-dam":1,"god-damned":1,goddamn:1,goddamned:1,hardcoresex:1,hell:1,heshe:1,hoar:1,hoare:1,hoer:1,homo:1,hore:1,horniest:1,horny:1,hotsex:1,"jack-off":1,jackoff:1,jap:1,"jerk-off":1,jism:1,jiz:1,jizm:1,jizz:1,kawk:1,knob:1,knobead:1,knobed:1,knobend:1,knobhead:1,knobjocky:1,knobjokey:1,kock:1,kondum:1,kondums:1,kum:1,kummer:1,kumming:1,kums:1,kunilingus:1,"l3i+ch":1,l3itch:1,labia:1,lust:1,lusting:1,m0f0:1,m0fo:1,m45terbate:1,ma5terb8:1,ma5terbate:1,masochist:1,"master-bate":1,masterb8:1,"masterbat*":1,masterbat3:1,masterbate:1,masterbation:1,masterbations:1,masturbate:1,"mo-fo":1,mof0:1,mofo:1,mothafuck:1,mothafucka:1,mothafuckas:1,mothafuckaz:1,mothafucked:1,mothafucker:1,mothafuckers:1,mothafuckin:1,mothafucking:1,mothafuckings:1,mothafucks:1,"mother fucker":1,motherfuck:1,motherfucked:1,motherfucker:1,motherfuckers:1,motherfuckin:1,motherfucking:1,motherfuckings:1,motherfuckka:1,motherfucks:1,muff:1,mutha:1,muthafecker:1,muthafuckker:1,muther:1,mutherfucker:1,n1gga:1,n1gger:1,nazi:1,nigg3r:1,nigg4h:1,nigga:1,niggah:1,niggas:1,niggaz:1,nigger:1,niggers:1,nob:1,"nob jokey":1,nobhead:1,nobjocky:1,nobjokey:1,numbnuts:1,nutsack:1,orgasim:1,orgasims:1,orgasm:1,orgasms:1,p0rn:1,pawn:1,pecker:1,penis:1,penisfucker:1,phonesex:1,phuck:1,phuk:1,phuked:1,phuking:1,phukked:1,phukking:1,phuks:1,phuq:1,pigfucker:1,pimpis:1,piss:1,pissed:1,pisser:1,pissers:1,pisses:1,pissflaps:1,pissin:1,pissing:1,pissoff:1,poop:1,porn:1,porno:1,pornography:1,pornos:1,prick:1,pricks:1,pron:1,pube:1,pusse:1,pussi:1,pussies:1,pussy:1,pussys:1,rectum:1,retard:1,rimjaw:1,rimming:1,"s hit":1,"s.o.b.":1,sadist:1,schlong:1,screwing:1,scroat:1,scrote:1,scrotum:1,semen:1,sex:1,"sh!+":1,"sh!t":1,sh1t:1,shag:1,shagger:1,shaggin:1,shagging:1,shemale:1,"shi+":1,shit:1,shitdick:1,shite:1,shited:1,shitey:1,shitfuck:1,shitfull:1,shithead:1,shiting:1,shitings:1,shits:1,shitted:1,shitter:1,shitters:1,shitting:1,shittings:1,shitty:1,skank:1,slut:1,sluts:1,smegma:1,smut:1,snatch:1,"son-of-a-bitch":1,spac:1,spunk:1,s_h_i_t:1,t1tt1e5:1,t1tties:1,teets:1,teez:1,testical:1,testicle:1,tit:1,titfuck:1,tits:1,titt:1,tittie5:1,tittiefucker:1,titties:1,tittyfuck:1,tittywank:1,titwank:1,tosser:1,turd:1,tw4t:1,twat:1,twathead:1,twatty:1,twunt:1,twunter:1,v14gra:1,v1gra:1,vagina:1,viagra:1,vulva:1,w00se:1,wang:1,wank:1,wanker:1,wanky:1,whoar:1,whore:1,willies:1,willy:1,xrated:1,xxx:1},PZ=["4r5e","5h1t","5hit","a55","anal","anus","ar5e","arrse","arse","ass","ass-fucker","asses","assfucker","assfukka","asshole","assholes","asswhole","a_s_s","b!tch","b00bs","b17ch","b1tch","ballbag","balls","ballsack","bastard","beastial","beastiality","bellend","bestial","bestiality","bi+ch","biatch","bitch","bitcher","bitchers","bitches","bitchin","bitching","bloody","blow job","blowjob","blowjobs","boiolas","bollock","bollok","boner","boob","boobs","booobs","boooobs","booooobs","booooooobs","breasts","buceta","bugger","bum","bunny fucker","butt","butthole","buttmuch","buttplug","c0ck","c0cksucker","carpet muncher","cawk","chink","cipa","cl1t","clit","clitoris","clits","cnut","cock","cock-sucker","cockface","cockhead","cockmunch","cockmuncher","cocks","cocksuck","cocksucked","cocksucker","cocksucking","cocksucks","cocksuka","cocksukka","cok","cokmuncher","coksucka","coon","cox","crap","cum","cummer","cumming","cums","cumshot","cunilingus","cunillingus","cunnilingus","cunt","cuntlick","cuntlicker","cuntlicking","cunts","cyalis","cyberfuc","cyberfuck","cyberfucked","cyberfucker","cyberfuckers","cyberfucking","d1ck","damn","dick","dickhead","dildo","dildos","dink","dinks","dirsa","dlck","dog-fucker","doggin","dogging","donkeyribber","doosh","duche","dyke","ejaculate","ejaculated","ejaculates","ejaculating","ejaculatings","ejaculation","ejakulate","f u c k","f u c k e r","f4nny","fag","fagging","faggitt","faggot","faggs","fagot","fagots","fags","fanny","fannyflaps","fannyfucker","fanyy","fatass","fcuk","fcuker","fcuking","feck","fecker","felching","fellate","fellatio","fingerfuck","fingerfucked","fingerfucker","fingerfuckers","fingerfucking","fingerfucks","fistfuck","fistfucked","fistfucker","fistfuckers","fistfucking","fistfuckings","fistfucks","flange","fook","fooker","fuck","fucka","fucked","fucker","fuckers","fuckhead","fuckheads","fuckin","fucking","fuckings","fuckingshitmotherfucker","fuckme","fucks","fuckwhit","fuckwit","fudge packer","fudgepacker","fuk","fuker","fukker","fukkin","fuks","fukwhit","fukwit","fux","fux0r","f_u_c_k","gangbang","gangbanged","gangbangs","gaylord","gaysex","goatse","God","god-dam","god-damned","goddamn","goddamned","hardcoresex","hell","heshe","hoar","hoare","hoer","homo","hore","horniest","horny","hotsex","jack-off","jackoff","jap","jerk-off","jism","jiz","jizm","jizz","kawk","knob","knobead","knobed","knobend","knobhead","knobjocky","knobjokey","kock","kondum","kondums","kum","kummer","kumming","kums","kunilingus","l3i+ch","l3itch","labia","lust","lusting","m0f0","m0fo","m45terbate","ma5terb8","ma5terbate","masochist","master-bate","masterb8","masterbat*","masterbat3","masterbate","masterbation","masterbations","masturbate","mo-fo","mof0","mofo","mothafuck","mothafucka","mothafuckas","mothafuckaz","mothafucked","mothafucker","mothafuckers","mothafuckin","mothafucking","mothafuckings","mothafucks","mother fucker","motherfuck","motherfucked","motherfucker","motherfuckers","motherfuckin","motherfucking","motherfuckings","motherfuckka","motherfucks","muff","mutha","muthafecker","muthafuckker","muther","mutherfucker","n1gga","n1gger","nazi","nigg3r","nigg4h","nigga","niggah","niggas","niggaz","nigger","niggers","nob","nob jokey","nobhead","nobjocky","nobjokey","numbnuts","nutsack","orgasim","orgasims","orgasm","orgasms","p0rn","pawn","pecker","penis","penisfucker","phonesex","phuck","phuk","phuked","phuking","phukked","phukking","phuks","phuq","pigfucker","pimpis","piss","pissed","pisser","pissers","pisses","pissflaps","pissin","pissing","pissoff","poop","porn","porno","pornography","pornos","prick","pricks","pron","pube","pusse","pussi","pussies","pussy","pussys","rectum","retard","rimjaw","rimming","s hit","s.o.b.","sadist","schlong","screwing","scroat","scrote","scrotum","semen","sex","sh!+","sh!t","sh1t","shag","shagger","shaggin","shagging","shemale","shi+","shit","shitdick","shite","shited","shitey","shitfuck","shitfull","shithead","shiting","shitings","shits","shitted","shitter","shitters","shitting","shittings","shitty","skank","slut","sluts","smegma","smut","snatch","son-of-a-bitch","spac","spunk","s_h_i_t","t1tt1e5","t1tties","teets","teez","testical","testicle","tit","titfuck","tits","titt","tittie5","tittiefucker","titties","tittyfuck","tittywank","titwank","tosser","turd","tw4t","twat","twathead","twatty","twunt","twunter","v14gra","v1gra","vagina","viagra","vulva","w00se","wang","wank","wanker","wanky","whoar","whore","willies","willy","xrated","xxx"],kZ=/\b(4r5e|5h1t|5hit|a55|anal|anus|ar5e|arrse|arse|ass|ass-fucker|asses|assfucker|assfukka|asshole|assholes|asswhole|a_s_s|b!tch|b00bs|b17ch|b1tch|ballbag|balls|ballsack|bastard|beastial|beastiality|bellend|bestial|bestiality|bi\+ch|biatch|bitch|bitcher|bitchers|bitches|bitchin|bitching|bloody|blow job|blowjob|blowjobs|boiolas|bollock|bollok|boner|boob|boobs|booobs|boooobs|booooobs|booooooobs|breasts|buceta|bugger|bum|bunny fucker|butt|butthole|buttmuch|buttplug|c0ck|c0cksucker|carpet muncher|cawk|chink|cipa|cl1t|clit|clitoris|clits|cnut|cock|cock-sucker|cockface|cockhead|cockmunch|cockmuncher|cocks|cocksuck|cocksucked|cocksucker|cocksucking|cocksucks|cocksuka|cocksukka|cok|cokmuncher|coksucka|coon|cox|crap|cum|cummer|cumming|cums|cumshot|cunilingus|cunillingus|cunnilingus|cunt|cuntlick|cuntlicker|cuntlicking|cunts|cyalis|cyberfuc|cyberfuck|cyberfucked|cyberfucker|cyberfuckers|cyberfucking|d1ck|damn|dick|dickhead|dildo|dildos|dink|dinks|dirsa|dlck|dog-fucker|doggin|dogging|donkeyribber|doosh|duche|dyke|ejaculate|ejaculated|ejaculates|ejaculating|ejaculatings|ejaculation|ejakulate|f u c k|f u c k e r|f4nny|fag|fagging|faggitt|faggot|faggs|fagot|fagots|fags|fanny|fannyflaps|fannyfucker|fanyy|fatass|fcuk|fcuker|fcuking|feck|fecker|felching|fellate|fellatio|fingerfuck|fingerfucked|fingerfucker|fingerfuckers|fingerfucking|fingerfucks|fistfuck|fistfucked|fistfucker|fistfuckers|fistfucking|fistfuckings|fistfucks|flange|fook|fooker|fuck|fucka|fucked|fucker|fuckers|fuckhead|fuckheads|fuckin|fucking|fuckings|fuckingshitmotherfucker|fuckme|fucks|fuckwhit|fuckwit|fudge packer|fudgepacker|fuk|fuker|fukker|fukkin|fuks|fukwhit|fukwit|fux|fux0r|f_u_c_k|gangbang|gangbanged|gangbangs|gaylord|gaysex|goatse|God|god-dam|god-damned|goddamn|goddamned|hardcoresex|hell|heshe|hoar|hoare|hoer|homo|hore|horniest|horny|hotsex|jack-off|jackoff|jap|jerk-off|jism|jiz|jizm|jizz|kawk|knob|knobead|knobed|knobend|knobhead|knobjocky|knobjokey|kock|kondum|kondums|kum|kummer|kumming|kums|kunilingus|l3i\+ch|l3itch|labia|lust|lusting|m0f0|m0fo|m45terbate|ma5terb8|ma5terbate|masochist|master-bate|masterb8|masterbat*|masterbat3|masterbate|masterbation|masterbations|masturbate|mo-fo|mof0|mofo|mothafuck|mothafucka|mothafuckas|mothafuckaz|mothafucked|mothafucker|mothafuckers|mothafuckin|mothafucking|mothafuckings|mothafucks|mother fucker|motherfuck|motherfucked|motherfucker|motherfuckers|motherfuckin|motherfucking|motherfuckings|motherfuckka|motherfucks|muff|mutha|muthafecker|muthafuckker|muther|mutherfucker|n1gga|n1gger|nazi|nigg3r|nigg4h|nigga|niggah|niggas|niggaz|nigger|niggers|nob|nob jokey|nobhead|nobjocky|nobjokey|numbnuts|nutsack|orgasim|orgasims|orgasm|orgasms|p0rn|pawn|pecker|penis|penisfucker|phonesex|phuck|phuk|phuked|phuking|phukked|phukking|phuks|phuq|pigfucker|pimpis|piss|pissed|pisser|pissers|pisses|pissflaps|pissin|pissing|pissoff|poop|porn|porno|pornography|pornos|prick|pricks|pron|pube|pusse|pussi|pussies|pussy|pussys|rectum|retard|rimjaw|rimming|s hit|s.o.b.|sadist|schlong|screwing|scroat|scrote|scrotum|semen|sex|sh!\+|sh!t|sh1t|shag|shagger|shaggin|shagging|shemale|shi\+|shit|shitdick|shite|shited|shitey|shitfuck|shitfull|shithead|shiting|shitings|shits|shitted|shitter|shitters|shitting|shittings|shitty|skank|slut|sluts|smegma|smut|snatch|son-of-a-bitch|spac|spunk|s_h_i_t|t1tt1e5|t1tties|teets|teez|testical|testicle|tit|titfuck|tits|titt|tittie5|tittiefucker|titties|tittyfuck|tittywank|titwank|tosser|turd|tw4t|twat|twathead|twatty|twunt|twunter|v14gra|v1gra|vagina|viagra|vulva|w00se|wang|wank|wanker|wanky|whoar|whore|willies|willy|xrated|xxx)\b/gi,LZ={object:DZ,array:PZ,regex:kZ};const MZ=NZ.words,UZ=LZ.array;class xZ{constructor(h={}){Object.assign(this,{list:h.emptyList&&[]||Array.prototype.concat.apply(MZ,[UZ,h.list||[]]),exclude:h.exclude||[],splitRegex:h.splitRegex||/\b/,placeHolder:h.placeHolder||"*",regex:h.regex||/[^a-zA-Z0-9|\$|\@]|\^/g,replaceRegex:h.replaceRegex||/\w/g})}isProfane(h){return this.list.filter(E=>{const T=new RegExp(`\\b${E.replace(/(\W)/g,"\\$1")}\\b`,"gi");return!this.exclude.includes(E.toLowerCase())&&T.test(h)}).length>0||!1}replaceWord(h){return h.replace(this.regex,"").replace(this.replaceRegex,this.placeHolder)}clean(h){return h.split(this.splitRegex).map(E=>this.isProfane(E)?this.replaceWord(E):E).join(this.splitRegex.exec(h)[0])}addWords(){let h=Array.from(arguments);this.list.push(...h),h.map(E=>E.toLowerCase()).forEach(E=>{this.exclude.includes(E)&&this.exclude.splice(this.exclude.indexOf(E),1)})}removeWords(){this.exclude.push(...Array.from(arguments).map(h=>h.toLowerCase()))}}var VZ=xZ;const JY=WW(VZ);function FZ(){let d=Zs();const h=j4();var E=new JY;const[T,A]=Oe.useState(""),[O,V]=Oe.useState(null),[X,$]=Oe.useState([]),[ne,le]=Oe.useState([]),[ae,ge]=Oe.useState(""),[je,Fe]=Oe.useState(""),we=h.postId;console.log(we),Oe.useEffect(()=>{const lt=localStorage.getItem("token");if(lt){const dt=Qa(lt);A(dt.username),V(dt.role),console.log(dt)}Se(),Ye(),ue()},[]);const Ye=async()=>{const dt=await(await fetch("https://experienceexchange.onrender.com/post/post",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({postID:we})}).catch(Et=>{console.log(Et)})).json();console.log(dt),ge(dt)},Se=async()=>{const dt=await(await fetch("https://experienceexchange.onrender.com/post/all",{method:"GET"}).catch(Et=>{console.log(Et)})).json();console.log(dt),le(dt)},ue=async()=>{const dt=await(await fetch("https://experienceexchange.onrender.com/comment/all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({postID:we})}).catch(Et=>{console.log(Et)})).json();console.log(dt),$(dt)},ve=async()=>{if(E.isProfane(je))Tn.error("Comment Contains Profanity!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),Fe("");else{const dt=await(await fetch("https://experienceexchange.onrender.com/comment/new",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({postID:we,content:je,creator:T})}).catch(Et=>{console.log(Et)})).json();console.log(dt),Tn.success("Comment Published Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),Fe("")}},tt=async()=>{const dt=await(await fetch("https://experienceexchange.onrender.com/post/delete",{method:"DELETE",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({postId:ae._id})}).catch(Et=>{console.log(Et)})).json();console.log(dt),d("/no-post")},Rt=async lt=>{const Et=await(await fetch("https://experienceexchange.onrender.com/comment/delete",{method:"DELETE",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({postId:lt})}).catch(Bt=>{console.log(Bt)})).json();console.log(Et)};if(O!=="admin")return F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"This is the Post Page"}),F.jsx("div",{className:Ae.postsPageMainContainer,children:F.jsxs("div",{className:Ae.detailedPostContainer,children:[F.jsxs("div",{className:Ae.detailedPostTop,children:[F.jsx("img",{className:Ae.detailedPostImg,src:"../public/profile/DefaultProfile.svg",alt:"profile pic"}),F.jsxs("div",{onClick:()=>{d(`/user/${ae.creator}`)},style:{fontSize:"larger",margin:"15px"},className:Ae.detailedPostUsername,children:["@",ae.creator]})]}),F.jsx("hr",{style:{width:"95%"}}),F.jsx("div",{className:Ae.detailedPostMid,children:F.jsx("p",{style:{fontSize:"larger",margin:"15px",textAlign:"center"},children:ae.content})}),F.jsx("hr",{style:{width:"95%"}}),F.jsx("div",{className:Ae.detailedPostFooter,children:F.jsx("div",{style:{fontSize:"larger",textAlign:"center"},children:ae.tags?ae.tags.join(", "):null})})]})}),F.jsx("h1",{style:{textAlign:"center"},children:"Similar Posts "}),F.jsx("div",{className:Ae.postsPageMainContainer,children:ne.map((lt,dt)=>F.jsx("div",{children:F.jsx(F.Fragment,{children:F.jsxs("div",{onClick:()=>d(`/posts/${lt._id}`),className:Ae.postContainer,children:[F.jsx("div",{style:{display:"flex",margin:"auto",justifyItems:"center"},className:Ae.postTop,children:F.jsxs("div",{style:{textAlign:"center"},className:Ae.postUsername,children:["@",lt.creator]})}),F.jsx("div",{children:F.jsx("p",{style:{textAlign:"center",height:"130px",overflow:"auto"},children:lt.content})}),F.jsx("hr",{style:{width:"370px"}}),F.jsxs("div",{className:Ae.postFooter,children:[F.jsx("span",{className:Ae.postFooterShowComments,children:"Comments(2)"}),F.jsx("div",{className:Ae.postFooterTag,children:lt.tags?lt.tags.join(", "):null})]})]})})},dt))}),F.jsxs("div",{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Comments Section:"}),F.jsx("div",{className:Ae.postsPageMainContainer,children:F.jsxs("div",{className:Ae.commentContainer,children:[F.jsx("label",{style:{textAlign:"center",marginTop:"5px"},children:"Add a new comment:"}),F.jsx("textarea",{style:{margin:"10px"},className:Ae.contactMessage,name:"message",id:"message",cols:"100",rows:"5",required:!0,value:je,onChange:lt=>{Fe(lt.target.value)}}),F.jsx("button",{onClick:()=>{ve()},className:Ae.loginButton,children:"Publish Comment"})]})}),X.map((lt,dt)=>F.jsx("div",{className:Ae.postsPageMainContainer,children:F.jsxs("div",{className:Ae.commentContainer,children:[F.jsxs("div",{className:Ae.commentTop,children:[F.jsxs("div",{style:{fontSize:"larger",margin:"15px"},className:Ae.commentUsername,children:["@",lt.creator]}),F.jsx("div",{style:{fontSize:"smaller",textAlign:"end"},children:lt.createdAt})]}),F.jsx("div",{className:Ae.commentMid,children:F.jsx("p",{style:{fontSize:"larger",margin:"15px",textAlign:"center"},children:lt.content})})]})},dt))]})]});if(O==="admin")return F.jsxs(F.Fragment,{children:[F.jsxs("h1",{children:["This is a post page ",h.postId]}),F.jsx("div",{className:Ae.postsPageMainContainer,children:F.jsxs("div",{className:Ae.detailedPostContainer,children:[F.jsxs("div",{className:Ae.detailedPostTop,children:[F.jsx("img",{className:Ae.detailedPostImg,src:`../public/profile/${ae.image}`,alt:"profile pic"}),F.jsxs("div",{onClick:()=>{d(`/user/${ae.creator}`)},style:{fontSize:"larger",margin:"15px"},className:Ae.detailedPostUsername,children:["@",ae.creator]})]}),F.jsx("hr",{style:{width:"95%"}}),F.jsx("div",{className:Ae.detailedPostMid,children:F.jsx("p",{style:{fontSize:"larger",margin:"15px",textAlign:"center"},children:ae.content})}),F.jsx("hr",{style:{width:"95%"}}),F.jsx("div",{className:Ae.detailedPostFooter,children:F.jsx("div",{style:{fontSize:"larger",textAlign:"center"},children:ae.tags?ae.tags.join(", "):null})})]})}),F.jsx("div",{style:{display:"flex",flexDirection:"row",width:"100%",justifyContent:"center"},children:F.jsxs("div",{style:{display:"flex",flexDirection:"row",margin:"auto",justifyContent:"center",borderWidth:"1px",borderStyle:"solid",borderRadius:"10px"},children:[F.jsx("span",{style:{margin:"5px",fontSize:"smaller",alignSelf:"center"},children:"Admin Control"}),F.jsx("div",{className:Ae.adminControlIcon,onClick:()=>{tt()},style:{margin:"5px",cursor:"pointer",display:"flex",borderRadius:"10px"},children:F.jsx(ss,{icon:"material-symbols:delete",style:{color:"red",width:"40px",height:"40px"}})})]})}),F.jsxs("div",{children:[F.jsx("h1",{children:"Comments Section:"}),F.jsx("div",{className:Ae.postsPageMainContainer,children:F.jsxs("div",{className:Ae.commentContainer,children:[F.jsx("label",{style:{textAlign:"center",marginTop:"5px"},children:"Add a new comment:"}),F.jsx("textarea",{style:{margin:"10px"},className:Ae.contactMessage,name:"message",id:"message",cols:"100",rows:"5",required:!0,value:je,onChange:lt=>{Fe(lt.target.value)}}),F.jsx("button",{onClick:()=>{ve()},className:Ae.loginButton,children:"Publish Comment"})]})}),X.map((lt,dt)=>F.jsxs("div",{className:Ae.postsPageMainContainer,children:[F.jsxs("div",{className:Ae.commentContainer,children:[F.jsxs("div",{className:Ae.commentTop,children:[F.jsxs("div",{onClick:()=>{d(`/user/${lt.creator}`)},style:{fontSize:"larger",margin:"15px"},className:Ae.commentUsername,children:["@",lt.creator]}),F.jsx("div",{style:{fontSize:"smaller",textAlign:"end"},children:lt.createdAt})]}),F.jsx("div",{className:Ae.commentMid,children:F.jsx("p",{style:{fontSize:"larger",margin:"15px",textAlign:"center"},children:lt.content})})]}),F.jsx("div",{style:{display:"flex",flexDirection:"row",width:"100%",justifyContent:"center"},children:F.jsxs("div",{style:{display:"flex",flexDirection:"row",margin:"auto",justifyContent:"center",borderWidth:"1px",borderStyle:"solid",borderRadius:"10px"},children:[F.jsx("span",{style:{margin:"5px",fontSize:"smaller",alignSelf:"center"},children:"Admin Control"}),F.jsx("div",{className:Ae.adminControlIcon,onClick:()=>{Rt(lt._id)},style:{margin:"5px",cursor:"pointer",display:"flex",borderRadius:"10px"},children:F.jsx(ss,{icon:"material-symbols:delete",style:{color:"red",width:"40px",height:"40px"}})})]})})]},dt))]})]})}function jZ(){let d=Zs();const h=localStorage.getItem("token"),E=Qa(h),[T,A]=Oe.useState(E.username),[O,V]=Oe.useState(null),[X,$]=Oe.useState(null),[ne,le]=Oe.useState(null),[ae,ge]=Oe.useState(null),[je,Fe]=Oe.useState(null),[we,Ye]=Oe.useState([]),[Se,ue]=Oe.useState([]),[ve,tt]=Oe.useState([]),[Rt,lt]=Oe.useState("");Oe.useState(!1);const[dt,Et]=Oe.useState(!1),Bt=Oe.useRef([""]);Oe.useEffect(()=>{const vn=localStorage.getItem("token");if(vn){const Ot=Qa(vn);A(Ot.username),V(Ot.role),$(Ot.image),ge(Ot.email),le(Ot.skill),Fe(Ot.rating),Ot?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login");const Ft=async()=>{const Nt=await(await fetch("https://experienceexchange.onrender.com/user/get-user",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({username:T})}).catch(cn=>{console.log(cn)})).json();Bt.current=Nt},as=async()=>{const Nt=await(await fetch("https://experienceexchange.onrender.com/user/get-messages",{method:"GET",headers:{"x-access-token":localStorage.getItem("token")}}).catch(cn=>{console.log(cn)})).json();Ye(Nt),console.log(we)},ii=async()=>{const Nt=await(await fetch("https://experienceexchange.onrender.com/user/get-requests",{method:"GET",headers:{"x-access-token":localStorage.getItem("token")}}).catch(cn=>{console.log(cn)})).json();ue(Nt),console.log(Se)},Os=async()=>{const Nt=await(await fetch("https://experienceexchange.onrender.com/user/available-sessions",{method:"GET",headers:{"x-access-token":localStorage.getItem("token")}}).catch(cn=>{console.log(cn)})).json();tt(Nt),console.log(Nt)};Ft(),ii(),as(),Os()},[dt]),console.log(E),console.log(Bt.current[0]);const Ht=async(vn,Ft)=>{console.log(Ft);const ii=await(await fetch("https://experienceexchange.onrender.com/user/modify-request",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({id:vn,status:Ft})}).catch(Os=>{console.log(Os)})).json();console.log(ii),lt(ii),Et(Os=>!Os)},rr=async vn=>{const as=await(await fetch("https://experienceexchange.onrender.com/user/delete-request",{method:"DELETE",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({id:vn})}).catch(ii=>{console.log(ii)})).json();console.log(as),Et(ii=>!ii)},Fr=(vn,Ft)=>{d(`/session?token=${vn}&name=${Ft}`)};if(O!="admin")return F.jsxs(F.Fragment,{children:[F.jsxs("h1",{style:{textAlign:"center"},children:["This is Your User Dashboard"," ",F.jsx("span",{style:{color:"#2C5F8D"},children:T})]}),F.jsxs("div",{style:{display:"flex",margin:"auto",justifyContent:"center",flexWrap:"wrap",padding:"20px",boxShadow:"2px 3px 5px #273e6e"},className:Ae.generalContainer,children:[F.jsxs("div",{style:{margin:"auto",justifyContent:"center"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"User Card:"}),F.jsx("div",{className:Ae.generalContainer,style:{padding:"30px",marginBottom:"10px"},children:F.jsxs("ul",{children:[F.jsx("img",{style:{width:"70px",height:"70px",borderRadius:"50px"},src:`./public/profile/${Bt.current[0].profileImage}`,alt:"user profile picture"}),F.jsxs("li",{children:["Username: ",T]}),F.jsxs("li",{children:["Email: ",ae]}),F.jsxs("li",{children:['Biography: "',Bt.current[0].bio,'"']}),F.jsxs("li",{children:["Skills:"," ",Bt.current[0].skills?Bt.current[0].skills.join(", "):Bt.current[0].skills]}),F.jsxs("li",{children:["Rating: ",je]}),F.jsxs("li",{children:["Role: ",O]}),F.jsxs("li",{children:["User ID: ",Bt.current[0]._id]})]})})]}),F.jsxs("div",{style:{margin:"auto",textAlign:"center"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"Messages:"}),F.jsx("div",{style:{display:"flex",flexDirection:"column",margin:"auto",maxWidth:"460px",width:"100%",height:"360px",minWidth:"260px",overflowWrap:"break-word",overflowY:"scroll"},className:Ae.generalContainer,children:we.length>0?we.map((vn,Ft)=>F.jsxs("div",{style:{display:"flex",flexDirection:"column",marginRight:"15px"},children:[F.jsxs("div",{children:[F.jsxs("span",{style:{cursor:"pointer"},onClick:()=>{d(`/user/${vn.fromUser}`)},children:["@",vn.fromUser,":"," "]}),F.jsx("span",{style:{fontSize:"smaller"},children:vn.content})]}),F.jsx("hr",{style:{minWidth:"260px",width:"100%"}})]},Ft)):"No Messages"})]}),F.jsxs("div",{style:{margin:"auto",textAlign:"center"},children:[F.jsxs("div",{style:{margin:"10px"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"Exchange Requests:"}),F.jsx("div",{style:{display:"flex",flexDirection:"column",margin:"auto",maxWidth:"460px",width:"100%",minWidth:"260px",minHeight:"100px",maxHeight:"200px",overflowWrap:"break-word",overflowY:"scroll"},className:Ae.generalContainer,children:Se.length>0?Se.map((vn,Ft)=>F.jsxs("div",{style:{display:"flex",flexDirection:"column",padding:"10px",marginRight:"15px"},children:[F.jsxs("div",{style:{display:"flex",flexDirection:"row",padding:"10px"},children:[F.jsxs("span",{children:["@",vn.fromUser," sent you an exchange request"]}),F.jsx("button",{onClick:()=>{Ht(vn._id,"accept")},style:{margin:"auto",marginLeft:"5px",marginRight:"5px",borderRadius:"10px"},children:"Accept"}),F.jsx("button",{onClick:()=>{Ht(vn._id,"deny")},style:{margin:"auto",borderRadius:"10px"},children:"Deny"})]}),F.jsx("hr",{style:{minWidth:"260px"}})]},Ft)):"No requests yet"})]}),F.jsxs("div",{style:{margin:"10px"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"Sessions Available:"}),F.jsx("div",{style:{display:"flex",flexDirection:"column",margin:"auto",maxWidth:"460px",width:"100%",minWidth:"260px",maxHeight:"200px",overflowWrap:"break-word",overflowY:"scroll"},className:Ae.generalContainer,children:ve.length>0?ve.map((vn,Ft)=>F.jsxs("div",{style:{display:"flex",flexDirection:"column",padding:"10px",marginRight:"15px"},children:[F.jsxs("div",{style:{display:"flex",flexDirection:"row"},children:[F.jsxs("span",{children:["You can join a session with @",vn.fromUser==T?vn.toUser:vn.fromUser]}),F.jsx("button",{onClick:()=>{Fr(vn.channelToken,vn.channel)},style:{margin:"auto",marginLeft:"5px",borderRadius:"10px"},children:"Join"}),F.jsx("button",{onClick:()=>{rr(vn._id)},style:{margin:"auto",marginLeft:"5px",borderRadius:"10px"},children:"Close"})]}),F.jsx("hr",{style:{minWidth:"260px"}})]},Ft)):"No Sessions available"})]})]})]}),F.jsx("h1",{style:{textAlign:"center"},children:"Actions:"}),F.jsxs("div",{className:Ae.dashboardMainContainer,children:[F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/skill",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"icons8:plus",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Add New Skill"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/newpost",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"material-symbols:post-add",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Create New Post"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/bio",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"fluent:text-description-16-filled",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Biography"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/upload",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"iconamoon:profile-circle-duotone",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Profile Picture"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"mdi:email-edit-outline",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Email"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"carbon:password",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Password"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/posts-history",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"solar:posts-carousel-vertical-outline",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"My Posts History"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/verify",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"bitcoin-icons:verify-filled",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Verify Skill"})]})]})]});if(O==="admin")return F.jsxs(F.Fragment,{children:[F.jsxs("h1",{style:{textAlign:"center"},children:["Welcome to Your Admin Dashboard"," ",F.jsx("span",{style:{color:"#2C5F8D"},children:T})]}),F.jsxs("div",{style:{display:"flex",margin:"auto",justifyContent:"center",flexWrap:"wrap",padding:"20px",boxShadow:"2px 3px 5px #273e6e"},className:Ae.generalContainer,children:[F.jsxs("div",{style:{margin:"auto",justifyContent:"center"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"User Card:"}),F.jsx("div",{className:Ae.generalContainer,style:{padding:"30px",marginBottom:"10px"},children:F.jsxs("ul",{children:[F.jsx("img",{style:{width:"70px",height:"70px",borderRadius:"50px"},src:`./public/profile/${Bt.current[0].profileImage}`,alt:"user profile picture"}),F.jsxs("li",{children:["Username: ",T]}),F.jsxs("li",{children:["Email: ",ae]}),F.jsxs("li",{children:['Biography: "',Bt.current[0].bio,'"']}),F.jsxs("li",{children:["Skills:"," ",Bt.current[0].skills?Bt.current[0].skills.join(", "):Bt.current[0].skills]}),F.jsxs("li",{children:["Rating: ",je]}),F.jsxs("li",{children:["Role: ",O]}),F.jsxs("li",{children:["User ID: ",Bt.current[0]._id]})]})})]}),F.jsxs("div",{style:{margin:"auto",textAlign:"center"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"Messages:"}),F.jsx("div",{style:{display:"flex",flexDirection:"column",margin:"auto",maxWidth:"460px",width:"100%",height:"360px",minWidth:"260px",overflowWrap:"break-word",overflowY:"scroll"},className:Ae.generalContainer,children:we.length>0?we.map((vn,Ft)=>F.jsxs("div",{style:{display:"flex",flexDirection:"column",marginRight:"15px"},children:[F.jsxs("div",{children:[F.jsxs("span",{style:{cursor:"pointer"},onClick:()=>{d(`/user/${vn.fromUser}`)},children:["@",vn.fromUser,":"," "]}),F.jsx("span",{style:{fontSize:"smaller"},children:vn.content})]}),F.jsx("hr",{style:{minWidth:"260px",width:"100%"}})]},Ft)):"No Messages"})]}),F.jsxs("div",{style:{margin:"auto",textAlign:"center"},children:[F.jsxs("div",{style:{margin:"10px"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"Exchange Requests:"}),F.jsx("div",{style:{display:"flex",flexDirection:"column",margin:"auto",maxWidth:"460px",width:"100%",minWidth:"260px",minHeight:"100px",maxHeight:"200px",overflowWrap:"break-word",overflowY:"scroll"},className:Ae.generalContainer,children:Se.length>0?Se.map((vn,Ft)=>F.jsxs("div",{style:{display:"flex",flexDirection:"column",padding:"10px",marginRight:"15px"},children:[F.jsxs("div",{style:{display:"flex",flexDirection:"row",padding:"10px"},children:[F.jsxs("span",{children:["@",vn.fromUser," sent you an exchange request"]}),F.jsx("button",{onClick:()=>{Ht(vn._id,"accept")},style:{margin:"auto",marginLeft:"5px",marginRight:"5px",borderRadius:"10px"},children:"Accept"}),F.jsx("button",{onClick:()=>{Ht(vn._id,"deny")},style:{margin:"auto",borderRadius:"10px"},children:"Deny"})]}),F.jsx("hr",{style:{minWidth:"260px"}})]},Ft)):"No requests yet"})]}),F.jsxs("div",{style:{margin:"10px"},children:[F.jsx("span",{style:{color:"#273e6e",fontSize:"larger"},children:"Sessions Available:"}),F.jsx("div",{style:{display:"flex",flexDirection:"column",margin:"auto",maxWidth:"460px",width:"100%",minWidth:"260px",maxHeight:"200px",overflowWrap:"break-word",overflowY:"scroll"},className:Ae.generalContainer,children:ve.length>0?ve.map((vn,Ft)=>F.jsxs("div",{style:{display:"flex",flexDirection:"column",padding:"10px",marginRight:"15px"},children:[F.jsxs("div",{style:{display:"flex",flexDirection:"row"},children:[F.jsxs("span",{children:["You can join a session with @",vn.fromUser==T?vn.toUser:vn.fromUser]}),F.jsx("button",{onClick:()=>{Fr(vn.channelToken,vn.channel)},style:{margin:"auto",marginLeft:"5px",borderRadius:"10px"},children:"Join"}),F.jsx("button",{onClick:()=>{rr(vn._id)},style:{margin:"auto",marginLeft:"5px",borderRadius:"10px"},children:"Close"})]}),F.jsx("hr",{style:{minWidth:"260px"}})]},Ft)):"No Sessions available"})]})]})]}),F.jsx("h1",{style:{textAlign:"center"},children:"Actions:"}),F.jsxs("div",{className:Ae.dashboardMainContainer,children:[F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/check-verify",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"bitcoin-icons:verify-filled",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Verify User Skills"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/suspend",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"mdi:person-block",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Suspend a User"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/announcement",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"grommet-icons:announce",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Publish Announcement"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/newpost",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"material-symbols:post-add",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Create New Posts"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/bio",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"fluent:text-description-16-filled",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Biography"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/upload",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"iconamoon:profile-circle-duotone",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Profile Picture"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"mdi:email-edit-outline",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Email"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"carbon:password",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"Change Password"})]}),F.jsxs(Vr,{className:Ae.dashboardContainer,to:"/userdashboard/posts-history",children:[F.jsx("div",{children:F.jsx(ss,{className:Ae.dashboardIcon,icon:"solar:posts-carousel-vertical-outline",style:{color:"#2C5F8D"}})}),F.jsx("div",{className:Ae.dashboardText,children:"My Posts History"})]})]})]})}function BZ(){let d=Zs();var h=new JY;const[E,T]=Oe.useState(""),[A,O]=Oe.useState(""),[V,X]=Oe.useState(""),[$,ne]=Oe.useState(!1),le=[];Oe.useEffect(()=>{const je=localStorage.getItem("token");if(je){const Fe=Qa(je);T(Fe.username),console.log(Fe),Fe?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login")});const ae=async je=>{if(je.preventDefault(),ne(!0),h.isProfane(V))Tn.error("Post Contains Profanity!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),O(""),X("");else if(h.isProfane(A))Tn.error("Post Contains Profanity!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),O(""),X("");else{const we=await(await fetch("https://experienceexchange.onrender.com/post/new",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({content:V,creator:E,tags:le})}).catch(Ye=>{console.log(Ye)})).json();console.log(we),Tn.success("Post is Created!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{d("/posts")},2e3)}},ge=je=>{le.includes(je)?le.includes(je)&&(document.getElementById(je).style.backgroundColor="white",document.getElementById(je).style.color="black",le.pop(je),console.log(le)):(le.push(je.toLowerCase().trim()),console.log(le),document.getElementById(je).style.backgroundColor="rgb(39, 62, 110)",document.getElementById(je).style.color="white")};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Share a New Post with the Community"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{onSubmit:ae,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Title: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,value:A,onChange:je=>{O(je.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Post: "}),F.jsx("textarea",{className:Ae.contactMessage,name:"message",id:"message",cols:"40",rows:"10",required:!0,value:V,onChange:je=>{X(je.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Pick relevant tags: "}),F.jsxs("div",{className:Ae.tagsContainer,children:[F.jsx("div",{id:"programming",className:Ae.tagButton,onClick:function(je){ge("programming")},children:"Programming"}),F.jsx("div",{id:"network",className:Ae.tagButton,onClick:function(je){ge("network")},children:"Network"}),F.jsx("div",{id:"cybersecurity",className:Ae.tagButton,onClick:function(je){ge("cybersecurity")},children:"Cybersecurity"}),F.jsx("div",{id:"ai",className:Ae.tagButton,onClick:function(je){ge("ai")},children:"AI"}),F.jsx("div",{id:"business management",className:Ae.tagButton,onClick:function(je){ge("business management")},children:"Business Management"}),F.jsx("div",{id:"marketing",className:Ae.tagButton,onClick:function(je){ge("marketing")},children:"Marketing"}),F.jsx("div",{id:"accounting",className:Ae.tagButton,onClick:function(je){ge("accounting")},children:"Accounting"}),F.jsx("div",{id:"sales",className:Ae.tagButton,onClick:function(je){ge("sales")},children:"Sales"}),F.jsx("div",{id:"architecture",className:Ae.tagButton,onClick:function(je){ge("architecture")},children:"Architecture"}),F.jsx("div",{id:"mechanics",className:Ae.tagButton,onClick:function(je){ge("mechanics")},children:"Mechanics"}),F.jsx("div",{id:"chemistry",className:Ae.tagButton,onClick:function(je){ge("chemistry")},children:"Chemistry"}),F.jsx("div",{id:"physics",className:Ae.tagButton,onClick:function(je){ge("physics")},children:"Physics"}),F.jsx("div",{id:"language",className:Ae.tagButton,onClick:function(je){ge("language")},children:"Language"}),F.jsx("div",{id:"writing",className:Ae.tagButton,onClick:function(je){ge("writing")},children:"Writing"}),F.jsx("div",{id:"medicine",className:Ae.tagButton,onClick:function(je){ge("medicine")},children:"Medicine"}),F.jsx("div",{id:"mathematics",className:Ae.tagButton,onClick:function(je){ge("mathematics")},children:"Mathematics"}),F.jsx("div",{id:"law",className:Ae.tagButton,onClick:function(je){ge("law")},children:"Law"})]}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,disabled:$,children:"Share Post"})]})})]})})}function GZ(){const[d,h]=Oe.useState(""),E=async T=>{T.preventDefault();const O=await(await fetch("https://experienceexchange.onrender.com/user/reset-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:d})}).catch(V=>{console.log(V)})).json();console.log(O),Tn.warning(O.message,{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})};return F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Resetting Your Password"}),F.jsx("div",{className:Ae.loginContainer,children:F.jsxs("form",{onSubmit:E,className:Ae.loginFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Enter Your Email: "}),F.jsx("input",{className:Ae.loginInput,type:"email",required:!0,value:d,onChange:T=>{h(T.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,children:"Reset"}),F.jsx("a",{className:Ae.loginForgot,href:"/register",children:"Don't have an account?"})]})})]})}function WZ(){const[d,h]=Oe.useState(""),{id:E,token:T}=j4();let A=Zs();const O=async V=>{V.preventDefault();const $=await(await fetch(`https://experienceexchange.onrender.com/user/new-password/${E}/${T}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:d})}).catch(ne=>{console.log(ne)})).json();console.log($),$&&(A("/login"),Tn.success($.data,{position:"top-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}))};return F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"New Password"}),F.jsx("div",{className:Ae.loginContainer,children:F.jsxs("form",{onSubmit:O,className:Ae.loginFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Enter a new password: "}),F.jsx("input",{className:Ae.loginInput,type:"password",pattern:"(?=.*\\d)(?=.*[a-z])(?=.*[A-Z]).{8,}",title:"Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters",required:!0,value:d,onChange:V=>{h(V.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,children:"Reset"})]})})]})}function HZ(){let d=Zs();const[h,E]=Oe.useState(null),[T,A]=Oe.useState(""),[O,V]=Oe.useState(!1);Oe.useEffect(()=>{const $=localStorage.getItem("token");if($){const ne=Qa($);E(ne.username),console.log(ne),ne?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login")});const X=async $=>{$.preventDefault(),V(!0),console.log(T);const ne=new FormData;ne.append("file",T),console.log(ne);const ae=await(await fetch("https://experienceexchange.onrender.com/user/upload",{method:"POST",headers:{"x-access-token":localStorage.getItem("token")},body:ne}).catch(ge=>{console.log(ge)})).json();console.log(ae),Tn.success("Changed Profile Picture Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{d("/userdashboard")},2e3)};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Change your profile picture"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{onSubmit:X,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Uplaod Here: "}),F.jsx("input",{className:Ae.loginInput,name:"file",type:"file",required:!0,onChange:$=>{A($.target.files[0])}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,disabled:O,children:"Upload New Picture"})]})})]})})}function KZ(){let d=Zs();const[h,E]=Oe.useState(""),[T,A]=Oe.useState("");Oe.useState("");const[O,V]=Oe.useState(!1),X=[];Oe.useEffect(()=>{const ne=localStorage.getItem("token");if(ne){const ae=Qa(ne);E(ae.username),console.log(ae),ae?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login");(async()=>{const ge=await(await fetch("https://experienceexchange.onrender.com/user/get-user",{method:"POST",headers:{"x-access-token":localStorage.getItem("token")}}).catch(je=>{console.log(je)})).json();console.log(ge)})()});const $=async ne=>{V(!0),ne.preventDefault(),X.push(T.toLowerCase().trim());const ae=await(await fetch("https://experienceexchange.onrender.com/user/skill",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({skills:X})}).catch(ge=>{console.log(ge)})).json();console.log(ae),Tn.success("Skill Added!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{d("/userdashboard")},2e3)};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Add a new skill to your collection"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{onSubmit:$,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Type your skill: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,value:T,onChange:ne=>{A(ne.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,disabled:O,children:"Confirm & Add Skill"})]})})]})})}function YZ(){let d=Zs();const[h,E]=Oe.useState(""),[T,A]=Oe.useState(""),[O,V]=Oe.useState(!1);Oe.useEffect(()=>{const $=localStorage.getItem("token");if($){const le=Qa($);E(le.username),console.log(le),le?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login");(async()=>{const ae=await(await fetch("https://experienceexchange.onrender.com/user/get-user",{method:"POST",headers:{"x-access-token":localStorage.getItem("token")}}).catch(ge=>{console.log(ge)})).json();console.log(ae)})()});const X=async $=>{$.preventDefault(),V(!0);const le=await(await fetch("https://experienceexchange.onrender.com/user/bio",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({bio:T})}).catch(ae=>{console.log(ae)})).json();console.log(le),Tn.success("Changed Biography Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{d("/userdashboard")},2e3)};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Change your biography"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{onSubmit:X,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Type your new bio: "}),F.jsx("textarea",{className:Ae.contactMessage,type:"text",required:!0,value:T,onChange:$=>{A($.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,disabled:O,children:"Confirm & Change Biography"})]})})]})})}function zZ(){let d=Zs();const[h,E]=Oe.useState(null),[T,A]=Oe.useState(null),[O,V]=Oe.useState(null),[X,$]=Oe.useState("");Oe.useEffect(()=>{const le=localStorage.getItem("token");if(le){const ae=Qa(le);E(ae.username),console.log(ae),ae?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login")});const ne=async le=>{le.preventDefault(),console.log(X);const ae=new FormData;ae.append("file",X),console.log(ae);const je=await(await fetch("https://experienceexchange.onrender.com/certificate/new",{method:"POST",headers:{"x-access-token":localStorage.getItem("token")},body:ae}).catch(Fe=>{console.log(Fe)})).json();console.log(je),Tn.success("Verification Request Sent!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{d("/userdashboard")},2e3)};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Upload a certificate relevant to your skill"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{onSubmit:ne,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Upload Here: "}),F.jsx("input",{className:Ae.loginInput,name:"file",type:"file",required:!0,onChange:le=>{$(le.target.files[0])}}),F.jsx("label",{htmlFor:"text",children:"Enter the Skill: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,value:T,onChange:le=>{A(le.target.value)}}),F.jsx("label",{htmlFor:"text",children:"Additional Information: "}),F.jsx("textarea",{style:{width:"300px"},className:Ae.contactMessage,type:"text",required:!0,value:O,onChange:le=>{V(le.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{className:Ae.loginButton,children:"Submit for verification"})]})})]})})}function qZ(){let d=Zs();const[h,E]=Oe.useState(null),[T,A]=Oe.useState([]);Oe.useState(!1);const O=Oe.useRef("");Oe.useState(""),Oe.useEffect(()=>{const ne=localStorage.getItem("token");if(ne){const ae=Qa(ne);E(ae.username),console.log(ae),ae?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login");(async()=>{const ge=await(await fetch("https://experienceexchange.onrender.com/certificate/all",{method:"GET",headers:{"x-access-token":localStorage.getItem("token")}}).catch(je=>{console.log(je)})).json();O.current=ge,console.log(ge),A(ge)})()},[]);const V=async(ne,le)=>{ne.preventDefault(),console.log(le);const ge=await(await fetch("https://experienceexchange.onrender.com/certificate/modify",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({status:"deny",id:le})}).catch(je=>{console.log(je)})).json();console.log(ge),Tn.success("Denied Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},X=async(ne,le)=>{ne.preventDefault(),console.log(le);const ge=await(await fetch("https://experienceexchange.onrender.com/certificate/modify",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({status:"accept",id:le})}).catch(je=>{console.log(je)})).json();console.log(ge),Tn.success("Accepted Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},$=async(ne,le)=>{ne.preventDefault(),console.log(le),Tn.success("AI Verification is Running!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Verify Certificates Manually or Automate it using AI"}),F.jsx("button",{style:{width:"180px",backgroundColor:"rgb(39, 62, 110)",fontSize:"large",color:"white"},className:Ae.loginButton,onClick:ne=>$(ne,T),children:"Auto Verification"}),T.map((ne,le)=>F.jsx("div",{className:Ae.registerContainer,style:{marginTop:"30px"},children:F.jsxs("form",{style:{width:"600px"},className:Ae.contactFormContainer,children:[F.jsxs("label",{htmlFor:"text",children:["Uploaded by User: @",ne.creator]}),F.jsx("img",{style:{margin:"20px",alignSelf:"center",width:"600px"},src:`../public/certs/${ne.certificate}`}),F.jsx("hr",{style:{width:"350px"}}),F.jsxs("div",{children:[F.jsx("button",{style:{width:"120px",backgroundColor:"green",color:"white"},className:Ae.loginButton,onClick:ae=>X(ae,ne._id),children:"Accept"}),F.jsx("button",{style:{width:"120px",margin:"5px",backgroundColor:"red",color:"white"},className:Ae.loginButton,onClick:ae=>V(ae,ne._id),children:"Deny"})]})]})},le))]})})}function JZ(){let d=Zs();const[h,E]=Oe.useState("");Oe.useState(""),Oe.useEffect(()=>{const O=localStorage.getItem("token");if(O){const X=Qa(O);E(X.username),console.log(X),X?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login");(async()=>{const $=await(await fetch("https://experienceexchange.onrender.com/user/get-user",{method:"GET",headers:{"x-access-token":localStorage.getItem("token")}}).catch(ne=>{console.log(ne)})).json();console.log($)})()},[]);const T=async O=>{O.preventDefault();const X=await(await fetch("https://experienceexchange.onrender.com/admin/suspend",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({username:h})}).catch($=>{console.log($)})).json();console.log(X),Tn.success("User Suspended Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})},A=async O=>{O.preventDefault();const X=await(await fetch("https://experienceexchange.onrender.com/admin/reinstate",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({username:h})}).catch($=>{console.log($)})).json();console.log(X),Tn.success("User Reinstated Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"})};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Suspend any user"}),F.jsxs("div",{className:Ae.registerContainer,children:[F.jsxs("form",{onSubmit:T,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Enter a username to suspend: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,onChange:O=>{E(O.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{style:{backgroundColor:"red",color:"white"},className:Ae.loginButton,children:"Confirm Suspension"})]}),F.jsx("h1",{style:{marginTop:"50px",textAlign:"center"},children:"Reinstate any user"}),F.jsxs("form",{style:{marginTop:"10px"},onSubmit:A,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Enter username to remove suspension: "}),F.jsx("input",{className:Ae.loginInput,type:"text",required:!0,onChange:O=>{E(O.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{style:{backgroundColor:"green",color:"white"},className:Ae.loginButton,children:"Confirm Reinitialization"})]})]})]})})}function XZ(){let d=Zs();const[h,E]=Oe.useState(""),[T,A]=Oe.useState("");Oe.useEffect(()=>{const V=localStorage.getItem("token");if(V){const $=Qa(V);A($.username),console.log($),$?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login");(async()=>{const ne=await(await fetch("https://experienceexchange.onrender.com/admin/get-announcement",{method:"GET",headers:{"x-access-token":localStorage.getItem("token")}}).catch(le=>{console.log(le)})).json();console.log(ne)})()});const O=async V=>{V.preventDefault();const $=await(await fetch("https://experienceexchange.onrender.com/admin/announcement",{method:"POST",headers:{"Content-Type":"application/json","x-access-token":localStorage.getItem("token")},body:JSON.stringify({content:h,creator:T})}).catch(ne=>{console.log(ne)})).json();console.log($),Tn.success("Announcement is Created Successfully!",{position:"bottom-right",autoClose:2e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored"}),setTimeout(()=>{d("/userdashboard"),window.location.reload()},2e3)};return F.jsx(F.Fragment,{children:F.jsxs("div",{className:Ae.mainContainer,children:[F.jsx("h1",{children:"Publish an Announcement"}),F.jsx("div",{className:Ae.registerContainer,children:F.jsxs("form",{onSubmit:O,className:Ae.contactFormContainer,children:[F.jsx("label",{htmlFor:"text",children:"Enter a message: "}),F.jsx("textarea",{style:{width:"300px",height:"100px"},className:Ae.loginInput,type:"text",required:!0,onChange:V=>{E(V.target.value)}}),F.jsx("hr",{style:{width:"350px"}}),F.jsx("button",{style:{backgroundColor:"green",color:"white"},className:Ae.loginButton,children:"Confirm Announcement"})]})})]})})}function QZ(){let d=Zs();const h=localStorage.getItem("token"),E=Qa(h),[T,A]=Oe.useState([]),[O,V]=Oe.useState(E.username);return Oe.useEffect(()=>{const X=localStorage.getItem("token");if(X){const ne=Qa(X);V(ne.username),ne?console.log("User Authenticated"):(console.log("Unauthorized User"),localStorage.removeItem("token"),d("/login"))}else d("/login");(async()=>{const le=await(await fetch("https://experienceexchange.onrender.com/post/history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:O})}).catch(ae=>{console.log(ae)})).json();console.log(le),A(le)})()},[]),F.jsxs(F.Fragment,{children:[F.jsx("h1",{style:{textAlign:"center"},children:"Posts History"}),F.jsx("div",{className:Ae.postsPageMainContainer,children:T.map((X,$)=>F.jsx("div",{children:F.jsx(F.Fragment,{children:F.jsxs("div",{onClick:()=>d(`/posts/${X._id}`),style:{cursor:"pointer"},className:Ae.postContainer,children:[F.jsxs("div",{className:Ae.postTop,children:[F.jsx("div",{children:F.jsx("img",{className:Ae.postImg,src:`../public/${X.image}`,alt:"profile pic"})}),F.jsxs("div",{className:Ae.postUsername,children:["@",X.creator]})]}),F.jsx("div",{children:F.jsx("p",{style:{margin:"10px",textAlign:"center",overflowY:"hidden"},children:X.content})}),F.jsxs("div",{style:{flexDirection:"column"},className:Ae.postFooter,children:[F.jsx("hr",{style:{width:"350px"}}),F.jsx("div",{style:{textAlign:"center"},className:Ae.postFooterTag,children:X.tags.join(", ")})]})]})})},$))})]})}function ZZ(){return F.jsxs(F.Fragment,{children:[F.jsx("div",{children:F.jsxs($7,{children:[F.jsx(P9,{}),F.jsx(k9,{}),F.jsxs(K7,{children:[F.jsx(_s,{index:!0,element:F.jsx(L6,{})}),F.jsx(_s,{path:"/home",element:F.jsx(L6,{})}),F.jsx(_s,{path:"/posts",element:F.jsx(DQ,{})}),F.jsx(_s,{path:"/contact",element:F.jsx(PQ,{})}),F.jsx(_s,{path:"/ranking",element:F.jsx(kQ,{})}),F.jsx(_s,{path:"/register",element:F.jsx(LQ,{})}),F.jsx(_s,{path:"/login",element:F.jsx(MQ,{})}),F.jsx(_s,{path:"/session",element:F.jsx(IZ,{})}),F.jsx(_s,{path:"/search",element:F.jsx(wZ,{})}),F.jsx(_s,{path:"/user/:userId",element:F.jsx(bZ,{})}),F.jsx(_s,{path:"/posts/:postId",element:F.jsx(FZ,{})}),F.jsx(_s,{path:"/reset",element:F.jsx(GZ,{})}),F.jsx(_s,{path:"/reset/:id/:token",element:F.jsx(WZ,{})}),F.jsx(_s,{path:"/userdashboard",element:F.jsx(jZ,{})}),F.jsx(_s,{path:"/userdashboard/newpost",element:F.jsx(BZ,{})}),F.jsx(_s,{path:"/userdashboard/upload",element:F.jsx(HZ,{})}),F.jsx(_s,{path:"/userdashboard/skill",element:F.jsx(KZ,{})}),F.jsx(_s,{path:"/userdashboard/bio",element:F.jsx(YZ,{})}),F.jsx(_s,{path:"/userdashboard/verify",element:F.jsx(zZ,{})}),F.jsx(_s,{path:"/userdashboard/check-verify",element:F.jsx(qZ,{})}),F.jsx(_s,{path:"/userdashboard/suspend",element:F.jsx(JZ,{})}),F.jsx(_s,{path:"/userdashboard/announcement",element:F.jsx(XZ,{})}),F.jsx(_s,{path:"/userdashboard/posts-history",element:F.jsx(QZ,{})}),F.jsx(_s,{path:"*",element:F.jsx(AZ,{})})]})]})}),F.jsx(D9,{theme:"colored",position:"bottom-right",autoClose:5e3,hideProgressBar:!1,newestOnTop:!1,closeOnClick:!0,rtl:!1,draggable:!0,pauseOnHover:!0})]})}UG.createRoot(document.getElementById("root")).render(F.jsx(ZZ,{}));
